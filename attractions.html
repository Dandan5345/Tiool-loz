<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>מסע חלומות 🗽 אטרקציות ומסעדות</title>
  <link rel="manifest" href="manifest.json" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body { font-family: 'Assistant', sans-serif; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .form-input, .form-select, .form-textarea { transition: all 0.2s ease-in-out; border-radius: 0.5rem; border: 1px solid #cbd5e1; }
    .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #38bdf8; box-shadow: 0 0 0 2px #38bdf840; outline: none; }
    .modal-step { display: none; }
    .modal-step.active { display: block; animation: fadeIn 0.5s; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    #map-preview, #details-map { height: 220px; border-radius: 0.75rem; background-color: #e2e8f0; }
    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
    .chevron-icon { transition: transform 0.3s ease-out; }
    details[open] > summary .chevron-icon { transform: rotate(180deg); }
    .step-indicator { transition: all 0.4s ease-in-out; }
    .item-card { cursor: pointer; }

    .switch { position: relative; display: inline-block; width: 50px; height: 28px; }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 28px; }
    .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .slider { background-color: #2563eb; }
    input:checked + .slider:before { transform: translateX(22px); }

    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }

    .section-loader { position: absolute; inset: 0; background-color: rgba(241,245,249,0.8); z-index: 20; display: flex; align-items: center; justify-content: center; border-radius: 1rem; }

    /* Autocomplete dropdown (OSM/Nominatim) */
    .ac-wrapper { position: relative; }
    .ac-list {
      position: absolute; top: 100%; right: 0; left: 0; z-index: 60;
      background: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem;
      margin-top: 0.25rem; max-height: 260px; overflow: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.08);
    }
    .ac-item { padding: 0.5rem 0.75rem; cursor: pointer; }
    .ac-item:hover { background: #f1f5f9; }
    .rating-stars { color: #f59e0b; }
    .leaflet-container { z-index: 1; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="initial-loader">
    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>
    <div class="text-white text-center relative z-10">
      <i class="fas fa-plane-departure fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">מתחברים למסע...</p>
    </div>
  </div>

  <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
  <div class="fixed inset-0 z-0 bg-black/50"></div>

  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">תפריט המסע 🧭</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <button id="back-btn" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה">
              <i class="fas fa-arrow-right fa-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-slate-800">אטרקציות ומסעדות</h1>
          </div>
          <div class="flex items-center gap-4">
            <div id="auth-container" class="flex items-center"></div>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <div id="trip-banner" class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <p id="trip-title-line" class="py-3 text-center text-slate-700 font-bold">
          אטרקציות ומסעדות לטיול - טוען...
        </p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-7xl mx-auto">
        <div class="text-center mb-12">
          <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">תחנות במסע ✨</h2>
          <p class="mt-4 text-lg text-slate-200 max-w-2xl mx-auto">הבנק המרכזי שלנו להמלצות, תגליות ומקומות שאסור לפספס.</p>
          <div class="mt-8 flex justify-center items-center gap-4 flex-wrap">
            <button id="open-modal-btn" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
              <i class="fas fa-plus mr-2"></i> הוספת מקום
            </button>
            <button id="get-location-btn" class="bg-white/20 backdrop-blur-sm text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-white/40 transition-all transform hover:scale-105">
              <i class="fas fa-location-arrow mr-2"></i> הפעל שירותי מיקום
            </button>
          </div>
        </div>

        <div id="items-container" class="space-y-8">
          <p id="loading-message" class="text-center text-white bg-black/20 p-4 rounded-lg">טוען המלצות...</p>
        </div>
      </div>
    </main>
  </div>

  <div id="item-modal" class="fixed inset-0 bg-black/60 z-40 hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col">
      <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
        <h3 id="modal-title" class="text-2xl font-bold text-slate-800">הוספת מקום חדש</h3>
        <button id="modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
      </div>
      <div class="w-full bg-slate-200 h-2.5">
        <div id="step-progress-bar" class="bg-blue-500 h-2.5 rounded-r-full transition-all duration-500" style="width:0%;"></div>
      </div>
      <form id="item-form" class="flex-grow overflow-y-auto p-6 space-y-6">
        <div id="step-1" class="modal-step"></div>
        <div id="step-2" class="modal-step"></div>
        <div id="step-3" class="modal-step"></div>
        <div id="step-4" class="modal-step"></div>
        <div id="step-5" class="modal-step"></div>
        <div id="step-6" class="modal-step"></div>
        <div id="step-7" class="modal-step"></div>
        <div id="step-8" class="modal-step"></div>
        <div id="step-9" class="modal-step"></div>
      </form>
      <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
        <button type="button" id="modal-back-btn" class="py-2 px-5 rounded-lg hover:bg-slate-200 transition hidden font-semibold">אחורה</button>
        <div class="flex-grow text-center"><div id="modal-error-message" class="text-red-500 text-sm font-bold h-5"></div></div>
        <div id="modal-steps-indicator" class="text-sm text-slate-500 font-semibold mx-4"></div>
        <button type="button" id="modal-next-btn" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">הבא</button>
        <button type="submit" form="item-form" id="modal-finish-btn" class="py-2 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition hidden">הוסף לדף</button>
      </div>
    </div>
  </div>

  <div id="details-modal" class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4">
    <div id="details-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col relative"></div>
  </div>

  <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center">
    <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full">
      <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
      <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">האם למחוק?</h3>
      <p id="delete-modal-text" class="text-slate-600 mb-6">פעולה זו היא בלתי הפיכה.</p>
      <div class="flex justify-center gap-4">
        <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">ביטול</button>
        <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">מחק</button>
      </div>
    </div>
  </div>

  <div id="navigation-choice-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center p-4">
    <div class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full relative">
      <button id="navigation-modal-close" class="absolute top-3 right-3 w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 transition-colors"><i class="fas fa-times"></i></button>
      <h3 class="text-xl font-bold text-slate-800 mb-6">באיזו אפליקציה לנווט?</h3>
      <div class="space-y-3">
        <a id="nav-link-google" href="#" target="_blank" class="block w-full text-center bg-blue-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-600 transition"><i class="fa-brands fa-google mr-2"></i>Google Maps</a>
        <a id="nav-link-waze" href="#" target="_blank" class="block w-full text-center bg-cyan-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-cyan-600 transition"><i class="fa-brands fa-waze mr-2"></i>Waze</a>
        <a id="nav-link-osm" href="#" target="_blank" class="block w-full text-center bg-orange-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-orange-600 transition"><i class="fa-solid fa-map-location-dot mr-2"></i>OpenStreetMap</a>
      </div>
    </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, updateDoc, setDoc, arrayUnion, orderBy, enableIndexedDbPersistence, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    
    // --- הוספת יכולות אופליין ---
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.warn("Persistence נכשל – יש יותר מדי טאבים פתוחים.");
      } else if (err.code === 'unimplemented') {
        console.warn("הדפדפן לא תומך ב־Persistence.");
      }
    });

    // ---------- State ----------
    let currentUser = null;
    let tripId = null;
    let tripData = null;
    let tripHotels = []; // <-- חדש: מערך לאחסון המלונות בטיול

    // UI refs
    const initialLoader = document.getElementById('initial-loader');
    const mainContent = document.getElementById('main-content');
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');
    const mainMenu = document.getElementById('main-menu');
    const backBtn = document.getElementById('back-btn');

    const modal = document.getElementById('item-modal');
    const form = document.getElementById('item-form');
    const openModalBtn = document.getElementById('open-modal-btn');
    const closeModalBtn = document.getElementById('modal-close-btn');
    const nextBtn = document.getElementById('modal-next-btn');
    const backStepBtn = document.getElementById('modal-back-btn');
    const finishBtn = document.getElementById('modal-finish-btn');
    const stepsIndicator = document.getElementById('modal-steps-indicator');
    const progressBar = document.getElementById('step-progress-bar');
    const modalError = document.getElementById('modal-error-message');

    const itemsContainer = document.getElementById('items-container');
    const loadingMessage = document.getElementById('loading-message');
    const getLocationBtn = document.getElementById('get-location-btn');
    const detailsModal = document.getElementById('details-modal');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const authContainer = document.getElementById('auth-container');
    const tripTitleLine = document.getElementById('trip-title-line');
    const navigationModal = document.getElementById('navigation-choice-modal');
    const closeNavigationModalBtn = document.getElementById('navigation-modal-close');


    // נתוני אתר (סוגים בסיסיים) + סוגים מותאמים מ־Firestore
    const settingsDocRef = doc(db, 'app_settings', 'custom_types');
    const siteData = {
      destinations: [],
      destinationEmojis: {},
      basePlaceTypes: ["מסעדה/אוכל","סופר","מוזיאון","קניון/מרכז קניות","אטרקציה","חוף","סיור"],
      customPlaceTypes: [],
      get placeTypes() { return [...this.basePlaceTypes, ...this.customPlaceTypes]; },
      baseFoodTypes: { "איטלקי":"🍝","חלבי":"🧀","בשרי":"🥩","צמחוני":"🥗","אסייתי":"🍜","שווארמה":"🥙","פיצה":"🍕","המבורגר":"🍔","בית קפה":"☕" },
      customFoodTypes: {},
      get foodTypes() { return {...this.baseFoodTypes, ...this.customFoodTypes, "אחר":"🍴"}; },
      placeTypeEmojis: { "מסעדה/אוכל":"🍔","סופר":"🛒","מוזיאון":"🏛️","קניון/מרכז קניות":"🛍️","אטרקציה":"🎢","חוף":"🏖️","סיור":"🚶‍♂️" }
    };

    let allItems = [];
    let activeFilters = {};
    let isInitialLoad = true;

    // מודאל צעדים
    let currentModalStep = 1;
    let totalModalSteps = 1;
    let editingItemId = null;
    let isRestaurant = false;

    // מיקום משתמש
    let userLocation = null;

    // Leaflet maps
    let addEditMap = null, addEditMarker = null;
    let detailsMap = null, detailsMarker = null;

    // פרטי מקום שנבחר מה־OSM
    let selectedOSMPlaceDetails = null;

    // ---------- Utils ----------
    function toggleSidebar() {
      sidebar.classList.toggle('translate-x-full');
      overlay.classList.toggle('hidden');
    }

    function calculateDistanceInMeters(loc1, loc2) {
      if (!loc1 || !loc2) return Infinity;
      const R = 6371e3;
      const phi1 = loc1.lat * Math.PI / 180;
      const phi2 = loc2.lat * Math.PI / 180;
      const dPhi = (loc2.lat - loc1.lat) * Math.PI / 180;
      const dLam = (loc2.lng - loc1.lng) * Math.PI / 180;
      const a = Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLam/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function handleGetLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) { alert("דפדפן זה אינו תומך בשירותי מיקום."); return reject(); }
        getLocationBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> מאתר מיקום...`;
        getLocationBtn.disabled = true;
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            getLocationBtn.innerHTML = `<i class="fas fa-check-circle mr-2"></i> מיקום עודכן`;
            getLocationBtn.disabled = false;
            resolve(userLocation);
          },
          (err) => {
            console.error(err);
            getLocationBtn.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> הפעלת מיקום נכשלה`;
            getLocationBtn.disabled = false;
            alert("לא ניתן היה לקבל את מיקומך. בדוק הרשאות.");
            reject(err);
          },
          { enableHighAccuracy: true }
        );
      });
    }
    
    // ---------- OSM (Nominatim) autocomplete ----------
    const NOM_BASE = 'https://nominatim.openstreetmap.org';

    function initGenericOSMAutocomplete(inputElement, onSelectCallback) {
        if (!inputElement) return;
        
        let wrapper = inputElement.closest('.ac-wrapper');
        if (!wrapper) {
            console.error("Autocomplete input must be inside a .ac-wrapper element");
            return;
        }
        
        let list = wrapper.querySelector('.ac-list');
        if (!list) {
            list = document.createElement('div');
            list.className = 'ac-list hidden';
            wrapper.appendChild(list);
        }

        const renderResults = (results) => {
            if (!results || results.length === 0) {
                list.innerHTML = `<div class="ac-item text-slate-400">לא נמצאו תוצאות</div>`;
                list.classList.remove('hidden');
                return;
            }
            list.innerHTML = '';
            results.forEach(r => {
                const el = document.createElement('div');
                el.className = 'ac-item';
                el.innerHTML = `<div class="font-semibold">${r.display_name.split(',')[0]}</div><div class="text-sm text-slate-500 truncate">${r.display_name}</div>`;
                el.addEventListener('click', async () => {
                    list.classList.add('hidden');
                    inputElement.value = r.display_name || '';
                    const lat = parseFloat(r.lat);
                    const lon = parseFloat(r.lon);
                    const prettyName = r.name || (r.display_name?.split(',')[0] || '');

                    let extendedDetails = {};
                    try {
                        const osmPrefix = r.osm_type === 'node' ? 'N' : r.osm_type === 'way' ? 'W' : 'R';
                        const lookupUrl = `${NOM_BASE}/lookup?format=jsonv2&osm_ids=${osmPrefix}${r.osm_id}&extratags=1&addressdetails=1&accept-language=he`;
                        const detRes = await fetch(lookupUrl, { headers: { 'Accept': 'application/json' }});
                        const det = await detRes.json();
                        const d0 = det && det[0] ? det[0] : null;
                        if(d0) {
                          extendedDetails = {
                              hours: d0.extratags?.opening_hours || '',
                              website: d0.extratags?.website || d0.extratags?.contact_website || '',
                              image: d0.extratags?.image || '',
                              osm: { osm_id: r.osm_id, osm_type: r.osm_type }
                          };
                        }
                    } catch (e) { console.warn('OSM lookup failed', e); }

                    if (onSelectCallback) {
                        onSelectCallback({
                            name: prettyName,
                            location: r.display_name,
                            coords: { lat, lng: lon },
                            ...extendedDetails
                        });
                    }
                });
                list.appendChild(el);
            });
            list.classList.remove('hidden');
        };

        let acTimer = null;
        inputElement.addEventListener('input', () => {
            const q = inputElement.value.trim();
            if (acTimer) clearTimeout(acTimer);
            if (q.length < 2) { list.classList.add('hidden'); return; }
            acTimer = setTimeout(async () => {
                try {
                    const url = `${NOM_BASE}/search?format=jsonv2&accept-language=he&addressdetails=1&extratags=1&limit=8&q=${encodeURIComponent(q)}`;
                    const res = await fetch(url, { headers: { 'Accept': 'application/json' }});
                    const data = await res.json();
                    renderResults(data);
                } catch (e) {
                    console.error('Autocomplete error', e);
                    list.innerHTML = `<div class="ac-item text-red-500">שגיאה בחיפוש</div>`;
                    list.classList.remove('hidden');
                }
            }, 300);
        });

        document.addEventListener('click', (e) => {
            if (!wrapper.contains(e.target)) list.classList.add('hidden');
        });
    }

    // ---------- Leaflet maps ----------
    function initAddEditMap(location = { lat: 40.7128, lng: -74.0060 }) {
      const mapDiv = document.getElementById('map-preview');
      if (!mapDiv) return;
      if (!addEditMap) {
        addEditMap = L.map(mapDiv, { zoomControl: false, attributionControl: true }).setView([location.lat, location.lng], 13);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(addEditMap);
        addEditMarker = L.marker([location.lat, location.lng], { draggable: true }).addTo(addEditMap);
        addEditMarker.on('dragend', () => {
          const { lat, lng } = addEditMarker.getLatLng();
          if (!selectedOSMPlaceDetails) selectedOSMPlaceDetails = {};
          selectedOSMPlaceDetails.coords = { lat, lng };
          // It's better to reverse geocode here to update the address, but for simplicity we'll skip it.
        });
      } else {
        addEditMap.setView([location.lat, location.lng], 15);
        if (!addEditMarker) addEditMarker = L.marker([location.lat, location.lng], { draggable: true }).addTo(addEditMap);
        addEditMarker.setLatLng([location.lat, location.lng]);
      }
    }

    function initDetailsMap(coords) {
      const mapDiv = document.getElementById('details-map');
      if (!mapDiv) return;
      if (!detailsMap) {
        detailsMap = L.map(mapDiv, { zoomControl: false }).setView([coords.lat, coords.lng], 15);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
          attribution: '&copy; OpenStreetMap contributors &copy; CARTO'
        }).addTo(detailsMap);
        detailsMarker = L.marker([coords.lat, coords.lng]).addTo(detailsMap);
      } else {
        detailsMap.setView([coords.lat, coords.lng], 15);
        if (!detailsMarker) detailsMarker = L.marker([coords.lat, coords.lng]).addTo(detailsMap);
        detailsMarker.setLatLng([coords.lat, coords.lng]);
      }
    }

    // ---------- סוגים מותאמים ----------
    async function loadCustomSettings() {
      try {
        const snap = await getDoc(settingsDocRef);
        if (snap.exists()) {
          const data = snap.data();
          siteData.customPlaceTypes = data.placeTypes || [];
          if (data.foodTypes) data.foodTypes.forEach(t => { siteData.customFoodTypes[t] = '🍴'; });
        } else {
          await setDoc(settingsDocRef, { placeTypes: [], foodTypes: [] });
        }
      } catch (e) { console.error('loadCustomSettings', e); }
    }

    // ---------- תפריט צד מהטיול ----------
    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations || !Array.isArray(tripData.destinations)) return;
      siteData.destinations = tripData.destinations.map(d => d.nameHe || d.name || 'יעד');
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down chevron-icon"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        if (dest.dates) {
          generateDatesFromRange(dest.dates).forEach(dateStr => {
            const link = document.createElement('a');
            link.href = `daily-schedule.html?id=${tripId}&date=${encodeURIComponent(dateStr)}`;
            link.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
            link.textContent = `לו"ז ליום ${dateStr}`;
            submenu.appendChild(link);
          });
        }
        btn.onclick = () => { submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); };
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const [sd, sm, sy] = startStr.split('/').map(Number);
      const [ed, em, ey] = endStr.split('/').map(Number);
      const start = new Date(sy, sm-1, sd);
      const end = new Date(ey, em-1, ed);
      const out = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        out.push(d.toLocaleDateString('he-IL', { day:'2-digit', month:'2-digit', year:'numeric' }));
      }
      return out;
    }

    // ---------- UI helpers ----------
    function showModalError(message) {
      modalError.textContent = message || '';
      if (message) setTimeout(() => { modalError.textContent = ''; }, 4000);
    }

    function openModalHandler(itemId = null) {
      editingItemId = itemId;
      selectedOSMPlaceDetails = null; // Reset this on every open
      form.reset();
      for (let i = 1; i <= 9; i++) {
        const c = document.getElementById(`step-${i}`);
        if (c) c.innerHTML = '';
      }
      const modalTitle = document.getElementById('modal-title');
      const finishButton = document.getElementById('modal-finish-btn');
      
      if (editingItemId) {
        modalTitle.textContent = 'עריכת מקום';
        finishButton.textContent = 'שמור שינויים';
        
        // Find the item to pre-populate common fields
        const item = allItems.find(i => i.id === editingItemId);
        if (item) {
          isRestaurant = item.type === 'מסעדה/אוכל';
        }
      } else {
        modalTitle.textContent = 'הוספת מקום חדש';
        finishButton.textContent = 'הוסף לדף';
        isRestaurant = false;
      }
      
      currentModalStep = 1;
      updateModalView(); // This will generate step 1 and populate its fields
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeModalHandler() {
      editingItemId = null;
      modal.classList.add('hidden'); modal.classList.remove('flex');
      showModalError('');
      // ניקוי המפה בסגירת המודאל כדי למנוע בעיות בפתיחה הבאה
      if (addEditMap) {
        addEditMap.remove();
        addEditMap = null;
        addEditMarker = null;
      }
    }
    
    function updateModalView() {
      // Determine if it's a restaurant based on current selection or saved item data
      const itemTypeEl = document.getElementById('item-type');
      let currentType = '';
      if(itemTypeEl) {
          currentType = itemTypeEl.value;
      } else if (editingItemId) {
          const item = allItems.find(i => i.id === editingItemId);
          if (item) currentType = item.type;
      }
      isRestaurant = currentType === 'מסעדה/אוכל';

      const baseSteps = [1, 2, 3, 4, 5, 6, 7];
      const restaurantSteps = [8, 9];
      let steps = [...baseSteps];
      if (isRestaurant) steps.push(...restaurantSteps);
      steps.sort((a, b) => a - b);
      totalModalSteps = steps.length;

      document.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
      const actualStep = steps[currentModalStep - 1];
      const stepEl = document.getElementById(`step-${actualStep}`);
      if (stepEl) {
        if (!stepEl.innerHTML.trim()) {
            generateStepContent(actualStep);
        }
        stepEl.classList.add('active');
        
        // ======================= 📍 תיקון #3: ריענון המפה האפורה 📍 =======================
        // הלוגיקה הזו מוודאת שהמפה מתרעננת אחרי שהיא הופכת לנראית, ומונעת את בעיית האריחים האפורים.
        if (actualStep === 4 && addEditMap) {
          setTimeout(() => {
            addEditMap.invalidateSize();
            if (addEditMarker) {
              addEditMap.panTo(addEditMarker.getLatLng());
            }
          }, 100);
        }
      }

      backStepBtn.classList.toggle('hidden', currentModalStep === 1);
      nextBtn.classList.toggle('hidden', currentModalStep === totalModalSteps);
      finishBtn.classList.toggle('hidden', currentModalStep !== totalModalSteps);
      stepsIndicator.textContent = `שלב ${currentModalStep} מתוך ${totalModalSteps}`;
      progressBar.style.width = `${(currentModalStep / totalModalSteps) * 100}%`;
    }

    function handleTypeChange(e) {
      const other = document.getElementById('item-type-other');
      if (other) other.classList.toggle('hidden', e.target.value !== 'אחר');
      // Clear subsequent steps to rebuild them with new logic if type changes
      document.querySelectorAll('.modal-step').forEach((el, idx) => {
        const stepNum = parseInt(el.id.split('-')[1]);
        if (stepNum > currentModalStep) el.innerHTML = '';
      });
      updateModalView();
    }

    function handleFoodTypeChange(e) {
      const other = document.getElementById('item-food-type-other');
      if (other) other.classList.toggle('hidden', e.target.value !== 'אחר');
    }

    function createLocationHtml() {
      return `
        <label class="flex items-center gap-3 text-lg font-bold text-slate-700 mb-3">
          <i class="fa-solid fa-magnifying-glass-location text-slate-400"></i> חיפוש מקום (OpenStreetMap) <span class="text-red-500">*</span>
        </label>
        <div class="ac-wrapper">
          <input type="text" id="item-location-search" class="form-input w-full p-3" placeholder="הקלד שם מקום או כתובת..." required>
        </div>
        <div id="map-preview" class="mt-3"></div>
        <div id="google-place-filled-msg" class="text-sm text-green-600 bg-green-50 p-3 rounded-md mt-3 hidden">
          <i class="fa-solid fa-check-circle mr-2"></i> פרטי המקום מולאו מה־OpenStreetMap. ניתן לערוך ולהמשיך.
        </div>
        <div class="mt-4 space-y-3 text-sm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="font-semibold text-slate-600">כתובת</label>
              <input type="text" id="item-location" class="form-input w-full p-2 mt-1 bg-slate-100" readonly>
            </div>
            <div>
              <label class="font-semibold text-slate-600">שעות פתיחה</label>
              <input type="text" id="item-hours" class="form-input w-full p-2 mt-1" placeholder="למשל: Mo-Fr 10:00-18:00">
            </div>
            <div>
              <label class="font-semibold text-slate-600">אתר אינטרנט</label>
              <input type="url" id="item-link" class="form-input w-full p-2 mt-1" placeholder="https://...">
            </div>
          </div>
        </div>
      `;
    }
    
    function generateStepContent(step) {
        const c = document.getElementById(`step-${step}`);
        if (!c) return;
    
        const item = editingItemId ? allItems.find(i => i.id === editingItemId) : null;
        const label = "flex items-center gap-3 text-lg font-bold text-slate-700 mb-3";
    
        switch(step) {
            case 1:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-signature text-slate-400"></i>שם המקום <span class="text-red-500">*</span></label><input type="text" id="item-name" required class="form-input w-full p-3" placeholder="לדוגמה: Top of the Rock">`;
                if(item) document.getElementById('item-name').value = item.name || '';
                break;
            case 2:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-map-pin text-slate-400"></i>לאיזה יעד? <span class="text-red-500">*</span></label><select id="item-destination" required class="form-select w-full p-3">${siteData.destinations.map(d=>`<option value="${d}">📍 ${d}</option>`).join('')}</select>`;
                if(item) document.getElementById('item-destination').value = item.destination || '';
                break;
            case 3:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-shapes text-slate-400"></i>סוג המקום <span class="text-red-500">*</span></label><select id="item-type" required class="form-select w-full p-3">${[...siteData.placeTypes,"אחר"].map(o=>`<option value="${o}">${siteData.placeTypeEmojis[o]||'📌'} ${o}</option>`).join('')}</select><input type="text" id="item-type-other" class="form-input w-full p-3 mt-3 hidden" placeholder="הגדר סוג חדש">`;
                if(item) document.getElementById('item-type').value = item.type || '';
                document.getElementById('item-type').addEventListener('change', handleTypeChange);
                handleTypeChange({target: document.getElementById('item-type')}); // Trigger to show/hide "other"
                break;
            case 4:
                c.innerHTML = createLocationHtml();
                const searchInput = c.querySelector('#item-location-search');
                initGenericOSMAutocomplete(searchInput, (placeDetails) => {
                    document.getElementById('item-location').value = placeDetails.location || '';
                    document.getElementById('item-hours').value = placeDetails.hours || '';
                    document.getElementById('item-link').value = placeDetails.website || '';
                    const nameField = document.getElementById('item-name');
                    if (nameField && (!nameField.value || nameField.value.trim()==='')) {
                        nameField.value = placeDetails.name;
                    }

                    initAddEditMap(placeDetails.coords);
                    selectedOSMPlaceDetails = placeDetails;
                    
                    const msg = document.getElementById('google-place-filled-msg');
                    if (msg) { msg.classList.remove('hidden'); msg.innerHTML = `<i class="fa-solid fa-check-circle mr-2"></i> פרטי המקום מולאו מה־OpenStreetMap. ניתן לערוך ולהמשיך.`; }
                });
                
                // מאכלסים את שדות הכתובת רק לאחר שהם נוצרו, ורק במצב עריכה.
                if (item) {
                    document.getElementById('item-location-search').value = item.location || '';
                    document.getElementById('item-location').value = item.location || '';
                    document.getElementById('item-hours').value = item.hours || '';
                    document.getElementById('item-link').value = item.link || '';
                    if (item.coords) {
                        selectedOSMPlaceDetails = { coords: item.coords, location: item.location };
                        initAddEditMap(item.coords);
                    }
                }
                
                if (!item || !item.coords) {
                    // Fallback logic to center map on destination for new items
                    const destName = document.getElementById('item-destination')?.value;
                    if (destName) {
                        const geocodeAndInit = async (name) => {
                            try {
                                const url = `${NOM_BASE}/search?format=jsonv2&limit=1&q=${encodeURIComponent(name)}`;
                                const res = await fetch(url);
                                const data = await res.json();
                                if (data && data.length > 0) {
                                    initAddEditMap({ lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) });
                                } else { initAddEditMap(); }
                            } catch (e) {
                                console.error("Geocoding failed:", e);
                                initAddEditMap();
                            }
                        };
                        geocodeAndInit(destName);
                    } else { initAddEditMap(); }
                }
                break;
            case 5:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-calendar-check text-slate-400"></i>צריך להזמין מקום?</label><select id="item-reservation" class="form-select w-full p-3"><option value="לא">לא</option><option value="כן">כן</option><option value="מומלץ">מומלץ</option></select>`;
                if(item) document.getElementById('item-reservation').value = item.reservation || 'לא';
                break;
            case 6:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-quote-left text-slate-400"></i>פירוט קצר (אופציונלי)</label><textarea id="item-short-description" class="form-textarea w-full p-3" rows="2" placeholder="משפט או שניים..."></textarea>`;
                if(item) document.getElementById('item-short-description').value = item.shortDescription || '';
                break;
            case 7:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-pen-to-square text-slate-400"></i>תיאור מלא (אופציונלי)</label><textarea id="item-description" class="form-textarea w-full p-3" rows="4" placeholder="פרטים נוספים, המלצות..."></textarea>`;
                if(item) document.getElementById('item-description').value = item.description || '';
                break;
            case 8:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-star-of-david text-slate-400"></i>האם המסעדה כשרה?</label><select id="item-kosher" class="form-select w-full p-3"><option value="לא">לא</option><option value="כן">כן</option></select>`;
                if(item) document.getElementById('item-kosher').value = item.isKosher || 'לא';
                break;
            case 9:
                c.innerHTML = `<label class="${label}"><i class="fa-solid fa-utensils text-slate-400"></i>סוג אוכל</label><select id="item-food-type" class="form-select w-full p-3">${Object.entries(siteData.foodTypes).map(([n,e])=>`<option value="${n}">${e} ${n}</option>`).join('')}</select><input type="text" id="item-food-type-other" class="form-input w-full p-3 mt-3 hidden" placeholder="הגדר סוג אוכל">`;
                if(item) {
                    const foodSel = document.getElementById('item-food-type');
                    const foodOther = document.getElementById('item-food-type-other');
                    if (siteData.foodTypes[item.foodType]) {
                        foodSel.value = item.foodType;
                    } else if (item.foodType) {
                        foodSel.value = 'אחר';
                        foodOther.value = item.foodType;
                        foodOther.classList.remove('hidden');
                    }
                }
                document.getElementById('item-food-type').addEventListener('change', handleFoodTypeChange);
                break;
        }
    }


    // ---------- רנדר פריטים ----------
    function renderAllItems() {
      if (!itemsContainer) return;
      if (allItems.length === 0 && !isInitialLoad) {
        itemsContainer.innerHTML = `<div class="text-center p-16 bg-white/70 backdrop-blur-md rounded-2xl shadow-sm"><i class="fas fa-map-signs fa-4x text-slate-400 mb-6"></i><h3 class="text-2xl font-bold text-slate-700">עדיין אין המלצות...</h3><p class="text-slate-500 mt-2">לחץ על "הוספת מקום" כדי ליצור את הראשון.</p></div>`;
        loadingMessage.style.display = 'none';
        return;
      }
      const preserved = {};
      document.querySelectorAll('#items-container details').forEach(d => { if (d.dataset.key) preserved[d.dataset.key]=d.open; });

      itemsContainer.innerHTML = ''; loadingMessage.style.display='none';

      const groupedByDest = allItems.reduce((acc, item) => {
        const dest = item.destination || 'כללי';
        (acc[dest] ||= []).push(item);
        return acc;
      }, {});

      siteData.destinations.forEach(dest => {
        if (!groupedByDest[dest]) return;
        
        const destSection = document.createElement('details');
        destSection.className = "bg-white/70 backdrop-blur-md rounded-2xl shadow-lg overflow-hidden relative";
        destSection.open = preserved[dest] || false;
        destSection.dataset.key = dest;
        destSection.innerHTML = `<summary class="text-2xl md:text-3xl font-bold text-slate-800 flex justify-between items-center p-5 hover:bg-white/30 transition"><span class="flex items-center gap-4">📍 ${dest}</span><i class="fa-solid fa-chevron-down chevron-icon"></i></summary>`;
        const contentDiv = document.createElement('div');
        contentDiv.className = 'p-4 space-y-6 bg-slate-50/70';

        const byType = groupedByDest[dest].reduce((acc, item)=>{ (acc[item.type||'כללי'] ||= []).push(item); return acc; }, {});
        Object.keys(byType).sort().forEach(type => {
          if (!activeFilters[dest]) activeFilters[dest] = {};
          if (!activeFilters[dest][type]) {
              activeFilters[dest][type] = { 
                  kosher: false, 
                  foodType: '', 
                  sortBy: 'default', 
                  sortPoint: null, 
                  sortMeta: {} 
              };
          }
          const filterState = activeFilters[dest][type];
          
          const typeSection = document.createElement('details');
          typeSection.className = "bg-white/80 p-4 rounded-xl shadow-md";
          typeSection.open = preserved[`${dest}-${type}`] || false;
          typeSection.dataset.key = `${dest}-${type}`;
          const typeIcon = siteData.placeTypeEmojis[type] || '📌';
          typeSection.innerHTML = `<summary class="text-lg md:text-xl font-semibold text-slate-700 flex justify-between items-center"><span>${typeIcon} ${type}</span><i class="fa-solid fa-chevron-down chevron-icon"></i></summary>`;

          const typeContent = document.createElement('div');
          typeContent.className = "mt-4 pt-4 border-t space-y-4";

          let itemsForType = [...byType[type]];

          // --- בניית HTML עבור פילטרים ומיון ---
          const toolsId = `${dest.replace(/\s/g,'')}-${type.replace(/[\s/]/g,'')}`;
          let filterHtml = `<div class="local-filters bg-slate-100 p-3 rounded-lg space-y-3">`;
          
          if (type === 'מסעדה/אוכל') {
              const allFood = [...new Set(groupedByDest[dest].filter(i=>i.type==='מסעדה/אוכל').map(i=>i.foodType).filter(Boolean))];
              filterHtml += `
                <div class="flex items-center gap-4">
                  <span class="font-bold text-slate-600 text-sm">סינון:</span>
                  <div class="flex items-center gap-2">
                    <input type="checkbox" id="kosher-filter-${toolsId}" data-destination="${dest}" data-type="${type}" class="local-filter-kosher h-4 w-4 rounded" ${filterState.kosher?'checked':''}>
                    <label for="kosher-filter-${toolsId}" class="text-sm font-medium text-slate-600">כשר בלבד</label>
                  </div>
                  <select data-destination="${dest}" data-type="${type}" class="local-filter-food-type form-select rounded-md text-sm py-1">
                    <option value="">כל סוגי האוכל</option>
                    ${allFood.sort().map(ft=>`<option value="${ft}" ${filterState.foodType===ft?'selected':''}>${siteData.foodTypes[ft]||'🍴'} ${ft||''}</option>`).join('')}
                  </select>
                </div>`;
          }

          const hotelOptions = tripHotels.filter(h => h.coords).map(h => `<option value="${h.id}" ${filterState.sortMeta?.hotelId === h.id ? 'selected' : ''}>${h.name}</option>`).join('');
          filterHtml += `
            <div class="sort-controls pt-3 border-t border-slate-200">
              <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
                  <label class="font-bold text-slate-600 text-sm whitespace-nowrap">מיון לפי מרחק:</label>
                  <select class="sort-by-select form-select rounded-md text-sm py-1 flex-grow" data-destination="${dest}" data-type="${type}">
                      <option value="default" ${filterState.sortBy === 'default' ? 'selected' : ''}>ברירת מחדל</option>
                      <option value="distance_user" ${filterState.sortBy === 'distance_user' ? 'selected' : ''}>מהמיקום שלי</option>
                      ${tripHotels.length > 0 ? `<option value="distance_hotel" ${filterState.sortBy === 'distance_hotel' ? 'selected' : ''}>ממלון</option>` : ''}
                      <option value="distance_custom" ${filterState.sortBy === 'distance_custom' ? 'selected' : ''}>מכתובת</option>
                  </select>
                  
                  <select class="hotel-sort-select form-select rounded-md text-sm py-1 flex-grow ${filterState.sortBy === 'distance_hotel' ? '' : 'hidden'}" data-destination="${dest}" data-type="${type}">
                      <option value="">בחר מלון...</option>
                      ${hotelOptions}
                  </select>

                  <div class="custom-address-sort-wrapper ac-wrapper flex-grow ${filterState.sortBy === 'distance_custom' ? '' : 'hidden'}" data-destination="${dest}" data-type="${type}">
                      <input type="text" class="custom-address-sort-input form-input w-full text-sm py-1" placeholder="הקלד כתובת..." value="${filterState.sortMeta?.address || ''}">
                  </div>
              </div>
              ${ (filterState.sortBy.startsWith('distance_') && filterState.sortPoint) ? `
              <div class="text-xs text-slate-500 mt-2 text-center bg-slate-200/70 p-1 rounded">
                  ממיין מ: <b>${filterState.sortMeta?.hotelName || filterState.sortMeta?.address || 'המיקום שלי'}</b>
              </div>` : '' }
            </div>
          `;
          filterHtml += `</div>`;
          typeContent.insertAdjacentHTML('afterbegin', filterHtml);

          // הפעלת השלמה אוטומטית לשדה הכתובת המותאמת
          const customAddressInput = typeContent.querySelector('.custom-address-sort-input');
          if (customAddressInput) {
              initGenericOSMAutocomplete(customAddressInput, (placeDetails) => {
                  filterState.sortPoint = placeDetails.coords;
                  filterState.sortMeta = { address: placeDetails.location };
                  renderAllItems();
              });
          }

          // לוגיקת פילטור ומיון
          if (type === 'מסעדה/אוכל') {
            if (filterState.kosher) itemsForType = itemsForType.filter(i=>i.isKosher==='כן');
            if (filterState.foodType) itemsForType = itemsForType.filter(i=>i.foodType===filterState.foodType);
          }
          if (filterState.sortBy.startsWith('distance_') && filterState.sortPoint) {
            itemsForType.forEach(item => {
                item.airDistanceKm = calculateDistanceInMeters(filterState.sortPoint, item.coords) / 1000;
            });
            itemsForType.sort((a,b)=> (a.airDistanceKm??Infinity) - (b.airDistanceKm??Infinity));
          } else {
             itemsForType.forEach(item => delete item.airDistanceKm);
          }

          const grid = document.createElement('div');
          grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
          if (itemsForType.length === 0) {
            grid.innerHTML = `<p class="text-slate-500 col-span-full text-center">אין מקומות התואמים לסינון.</p>`;
          } else {
            itemsForType.forEach(item => {
              const card = document.createElement('div');
              card.className = 'item-card bg-white/90 p-4 rounded-xl shadow-lg flex flex-col justify-between transition-transform hover:scale-105 hover:shadow-2xl';
              card.dataset.id = item.id;

              let tags = '';
              if (item.isKosher==='כן') tags += `<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">כשר</span>`;
              if (item.foodType) tags += `<span class="text-xs font-bold text-sky-600 bg-sky-100 px-2 py-1 rounded-full">${siteData.foodTypes[item.foodType]||''} ${item.foodType}</span>`;
              if (item.reservation && item.reservation!=='לא') tags += `<span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded-full">הזמנה: ${item.reservation}</span>`;

              const distanceHtml = (filterState.sortBy.startsWith('distance_') && item.airDistanceKm!==undefined && item.airDistanceKm!==Infinity)
                ? `<div class="air-distance-info flex items-center justify-center text-xs text-slate-600 mt-2 border-t pt-2 gap-2">
                    <i class="fa-solid fa-plane-up fa-fw text-blue-500"></i>
                    <span>מרחק אווירי: <b>${item.airDistanceKm.toFixed(1)} ק"מ</b></span>
                  </div>` : '';

              const hasCoords = !!item.coords;
              const navigateButton = `
                <button data-id="${item.id}" class="navigate-btn action-btn bg-blue-100 text-blue-600 w-9 h-9 flex items-center justify-center rounded-full hover:bg-blue-200 transition ${!hasCoords ? 'opacity-50 cursor-not-allowed' : ''}" title="נווט למקום" ${!hasCoords ? 'disabled' : ''}>
                    <i class="fa-solid fa-diamond-turn-right"></i>
                </button>`;

              card.innerHTML = `
                <div class="flex-grow">
                  <div class="flex justify-between items-start mb-2">
                    <h5 class="text-base md:text-lg font-bold text-slate-800 flex-1">${item.name}</h5>
                  </div>
                  <div class="flex flex-wrap gap-2 min-h-[26px] mb-3">${tags}</div>
                  ${item.shortDescription ? `<p class="text-sm text-slate-600 mb-4">${item.shortDescription}</p>` : ''}
                  ${distanceHtml}
                </div>
                <div class="mt-auto pt-3 border-t flex items-center justify-between gap-2">
                  <div class="flex gap-2">
                    ${navigateButton}
                    ${item.link ? `<a href="${item.link}" target="_blank" class="action-btn bg-green-100 text-green-600 w-9 h-9 flex items-center justify-center rounded-full hover:bg-green-200 transition" title="אתר"><i class="fa-solid fa-link"></i></a>` : ''}
                  </div>
                  <div class="flex gap-2">
                    <button class="edit-btn action-btn bg-slate-200 text-slate-600 w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-300 transition" title="עריכה"><i class="fas fa-pencil"></i></button>
                    <button class="delete-btn action-btn bg-slate-200 text-slate-600 w-9 h-9 flex items-center justify-center rounded-full hover:text-red-500 hover:bg-red-100 transition" title="מחיקה"><i class="fas fa-trash"></i></button>
                  </div>
                </div>`;
              grid.appendChild(card);
            });
          }
          typeContent.appendChild(grid);
          typeSection.appendChild(typeContent);
          contentDiv.appendChild(typeSection);
        });

        destSection.appendChild(contentDiv);
        const loader = document.createElement('div');
        loader.className = 'section-loader hidden';
        loader.innerHTML = `<i class="fas fa-sync-alt fa-2x fa-spin text-blue-500"></i>`;
        destSection.appendChild(loader);
        itemsContainer.appendChild(destSection);
      });
    }

    // ---------- Details Modal ----------
    function openDetailsModal(itemId) {
      const item = allItems.find(i=>i.id===itemId);
      if (!item) return;
      const wrap = document.getElementById('details-modal-content');

      let tags = '';
      if (item.isKosher==='כן') tags += `<span class="text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full">כשר</span>`;
      if (item.foodType) tags += `<span class="text-sm font-bold text-sky-700 bg-sky-100 px-3 py-1 rounded-full">${siteData.foodTypes[item.foodType]||''} ${item.foodType}</span>`;
      if (item.reservation && item.reservation!=='לא') tags += `<span class="text-sm font-bold text-amber-700 bg-amber-100 px-3 py-1 rounded-full">הזמנה: ${item.reservation}</span>`;

      let photosHtml = '';
      if (item.photos && item.photos.length) {
        photosHtml = `<div class="grid grid-cols-3 gap-2">
          ${item.photos.map(u=>`<a href="${u}" target="_blank"><img src="${u}" class="w-full h-24 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity"></a>`).join('')}
        </div>`;
      }
      
      const navigateButtonInModal = item.coords ? `<button data-id="${item.id}" class="navigate-btn flex-1 text-center bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition"><i class="fa-solid fa-diamond-turn-right mr-2"></i>נווט</button>` : '';

      wrap.innerHTML = `
        <button id="details-modal-close" class="absolute top-3 left-3 w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 z-10 transition-colors"><i class="fas fa-times"></i></button>
        <div class="p-6 border-b">
          <h3 class="text-3xl font-bold text-slate-800">${item.name}</h3>
          <p class="text-slate-500 mt-1">${siteData.placeTypeEmojis[item.type]||'📌'} ${item.type}</p>
        </div>
        <div class="p-6 flex-grow overflow-y-auto space-y-5 bg-slate-50">
          ${tags ? `<div class="flex flex-wrap gap-3 items-center">${tags}</div>` : ''}
          ${photosHtml}
          ${item.shortDescription ? `<div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded"><p class="text-slate-700 font-semibold">${item.shortDescription}</p></div>` : ''}
          ${item.description ? `<div class="bg-white p-4 rounded-lg shadow-inner"><p class="text-slate-700 whitespace-pre-wrap">${item.description}</p></div>` : ''}
          ${item.location ? `<div class="flex items-start gap-4"><i class="fa-solid fa-location-dot fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 font-semibold">${item.location}</p></div>` : ''}
          ${item.hours ? `<div class="flex items-start gap-4"><i class="fa-regular fa-clock fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 whitespace-pre-wrap">${item.hours}</p></div>` : ''}
          ${item.coords ? `<div id="details-map" class="w-full h-48 rounded-lg shadow-md"></div>` : ''}
        </div>
        <div class="p-4 bg-slate-100 border-t flex flex-wrap justify-center gap-3">
          ${navigateButtonInModal}
          ${item.link ? `<a href="${item.link}" target="_blank" class="flex-1 text-center bg-green-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-600 transition"><i class="fa-solid fa-link mr-2"></i>אתר</a>` : ''}
          <button data-id="${item.id}" class="edit-btn-modal flex-1 text-center bg-slate-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-pencil mr-2"></i>ערוך</button>
        </div>
      `;
      detailsModal.classList.remove('hidden'); detailsModal.classList.add('flex');
      document.getElementById('details-modal-close').addEventListener('click', closeDetailsModal);
      document.querySelector('.edit-btn-modal').addEventListener('click', (e)=>{ closeDetailsModal(); openModalHandler(e.currentTarget.dataset.id); });
      const navBtn = document.querySelector('#details-modal-content .navigate-btn');
      if (navBtn) {
        navBtn.addEventListener('click', (e) => {
            const id = e.currentTarget.dataset.id;
            const itemToNav = allItems.find(i => i.id === id);
            if(itemToNav) openNavigationChoiceModal(itemToNav);
        });
      }

      if (item.coords) initDetailsMap(item.coords);
    }

    function closeDetailsModal() {
      detailsModal.classList.add('hidden'); detailsModal.classList.remove('flex');
      detailsMap = null; detailsMarker = null;
    }

    // --- Navigation Modal Logic ---
    function openNavigationChoiceModal(item) {
        if (!item.coords) return;
        const { lat, lng } = item.coords;
        document.getElementById('nav-link-google').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        document.getElementById('nav-link-waze').href = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
        document.getElementById('nav-link-osm').href = `https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=17/${lat}/${lng}`;
        navigationModal.classList.remove('hidden');
        navigationModal.classList.add('flex');
    }
    function closeNavigationModal() {
        navigationModal.classList.add('hidden');
        navigationModal.classList.remove('flex');
    }

    // ---------- אירועים ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);

      if (backBtn) {
        backBtn.addEventListener('click', () => {
          if (tripId) window.location.href = `trip.html?id=${tripId}`;
          else window.location.href = 'index.html';
        });
      }

      openModalBtn.addEventListener('click', () => openModalHandler());
      closeModalBtn.addEventListener('click', closeModalHandler);

      nextBtn.addEventListener('click', () => { if (currentModalStep < totalModalSteps) { currentModalStep++; updateModalView(); } });
      backStepBtn.addEventListener('click', () => { if (currentModalStep > 1) { currentModalStep--; updateModalView(); } });

      getLocationBtn.addEventListener('click', handleGetLocation);
      detailsModal.addEventListener('click', (e)=>{ if (e.target.id==='details-modal') closeDetailsModal(); });
      
      // אירועים למודאל ניווט
      closeNavigationModalBtn.addEventListener('click', closeNavigationModal);
      navigationModal.addEventListener('click', (e) => { if (e.target.id === 'navigation-choice-modal') closeNavigationModal(); });


      form.addEventListener('keydown', e => {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          if (!nextBtn.classList.contains('hidden')) nextBtn.click();
          else if (!finishBtn.classList.contains('hidden')) finishBtn.click();
        }
      });

      itemsContainer.addEventListener('click', (e) => {
        const card = e.target.closest('.item-card'); if (!card) return;
        const actionBtn = e.target.closest('.action-btn');
        const id = card.dataset.id;
        const item = allItems.find(i=>i.id===id);
        if (actionBtn) {
          e.stopPropagation();
          if (actionBtn.matches('.delete-btn')) {
            const confirmBtn = document.getElementById('delete-modal-confirm');
            const title = document.getElementById('delete-modal-title');
            title.textContent = `האם למחוק את "${item?.name||''}"?`;
            const closeDelete = () => { deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); };
            const handler = async () => {
              try { await deleteDoc(doc(db, 'trips', tripId, 'places', id)); } catch(e){ console.error(e); } finally { closeDelete(); }
            };
            confirmBtn.addEventListener('click', handler, { once:true });
            document.getElementById('delete-modal-cancel').addEventListener('click', closeDelete, { once:true });
            deleteModal.classList.remove('hidden'); deleteModal.classList.add('flex');
          } else if (actionBtn.matches('.edit-btn')) {
            openModalHandler(id);
          } else if (actionBtn.matches('.navigate-btn')) {
            if (item) openNavigationChoiceModal(item);
          }
          return;
        }
        openDetailsModal(id);
      });

      itemsContainer.addEventListener('change', async e => {
          const t = e.target;
          const dest = t.dataset.destination;
          const type = t.dataset.type;
          if (!dest || !type) return;
          const filter = activeFilters[dest][type];

          if (t.matches('.local-filter-kosher')) {
              filter.kosher = t.checked;
              renderAllItems();
          }
          if (t.matches('.local-filter-food-type')) {
              filter.foodType = t.value;
              renderAllItems();
          }
          
          if (t.matches('.sort-by-select')) {
              const newSortBy = t.value;
              filter.sortBy = newSortBy;
              
              if (newSortBy === 'default') {
                  filter.sortPoint = null;
                  filter.sortMeta = {};
                  renderAllItems();
              } else if (newSortBy === 'distance_user') {
                  try {
                      const location = await handleGetLocation();
                      filter.sortPoint = location;
                      filter.sortMeta = { address: 'המיקום שלי' };
                  } catch {
                      filter.sortBy = 'default';
                      filter.sortPoint = null;
                      filter.sortMeta = {};
                  }
                  renderAllItems();
              } else if (newSortBy === 'distance_hotel' || newSortBy === 'distance_custom') {
                  if (filter.sortMeta?.hotelId) {
                       const selectedHotel = tripHotels.find(h => h.id === filter.sortMeta.hotelId);
                       if (selectedHotel) filter.sortPoint = selectedHotel.coords;
                       else filter.sortPoint = null;
                  } else {
                     filter.sortPoint = null; // Wait for user selection
                  }
                  renderAllItems();
              }
          }

          if (t.matches('.hotel-sort-select')) {
              const hotelId = t.value;
              if (!hotelId) {
                  filter.sortPoint = null;
                  filter.sortMeta = {};
              } else {
                  const selectedHotel = tripHotels.find(h => h.id === hotelId);
                  if (selectedHotel && selectedHotel.coords) {
                      filter.sortPoint = selectedHotel.coords;
                      filter.sortMeta = { hotelId: hotelId, hotelName: selectedHotel.name };
                  }
              }
              renderAllItems();
          }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (currentModalStep !== totalModalSteps) return;
        const gv = id => document.getElementById(id) ? document.getElementById(id).value : null;

        const name = gv('item-name');
        if (!name || name.trim()==='') { showModalError('שם המקום הוא שדה חובה.'); return; }
        
        const locationText = gv('item-location');
        if (!locationText || locationText.trim() === '') {
          showModalError('בחירת כתובת ומיקום על המפה היא שדה חובה.');
          return;
        }

        let finalType = gv('item-type');
        if (finalType === 'אחר') {
          finalType = (gv('item-type-other')||'').trim() || 'כללי';
          if (finalType !== 'כללי' && !siteData.placeTypes.includes(finalType)) {
            await setDoc(settingsDocRef, { placeTypes: arrayUnion(finalType) }, { merge:true });
            siteData.customPlaceTypes.push(finalType);
          }
        }

        let finalFoodType = isRestaurant ? gv('item-food-type') : null;
        if (isRestaurant && finalFoodType === 'אחר') {
          finalFoodType = (gv('item-food-type-other')||'').trim() || null;
          if (finalFoodType && !siteData.foodTypes[finalFoodType]) {
            await setDoc(settingsDocRef, { foodTypes: arrayUnion(finalFoodType) }, { merge:true });
            siteData.customFoodTypes[finalFoodType] = '🍴';
          }
        }

        const existing = editingItemId ? allItems.find(i=>i.id===editingItemId) : null;
        let coords = existing?.coords || null;
        let photos = existing?.photos || [];
        if (selectedOSMPlaceDetails) {
          coords = selectedOSMPlaceDetails.coords || coords;
          photos = selectedOSMPlaceDetails.photos?.length ? selectedOSMPlaceDetails.photos : photos;
        }

        if (!coords) {
            showModalError('יש למקם נעץ על המפה או לבחור מקום מהחיפוש.');
            return;
        }

        const data = {
          name: name,
          destination: gv('item-destination'),
          type: finalType,
          shortDescription: gv('item-short-description'),
          description: gv('item-description'),
          isKosher: isRestaurant ? gv('item-kosher') : null,
          foodType: finalFoodType,
          location: locationText,
          hours: gv('item-hours'),
          link: gv('item-link'),
          reservation: gv('item-reservation'),
          author: currentUser.uid,
          coords: coords,
          photos: photos
        };

        try {
          if (editingItemId) {
            await updateDoc(doc(db, 'trips', tripId, 'places', editingItemId), { ...data, updatedAt: serverTimestamp() });
          } else {
            await addDoc(collection(db, 'trips', tripId, 'places'), { ...data, createdAt: serverTimestamp() });
          }
          closeModalHandler();
        } catch (err) {
          console.error('save err', err);
          showModalError('שגיאה בשמירת הפריט.');
        }
      });
    }

    // ---------- האזנה לפריטים ----------
    function listenPlaces() {
      const qRef = query(collection(db, 'trips', tripId, 'places'), orderBy('createdAt','desc'));
      onSnapshot(qRef, (snap) => {
        const newItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        newItems.forEach(n => {
          const old = allItems.find(i=>i.id===n.id);
          if (old?.airDistanceKm) n.airDistanceKm = old.airDistanceKm;
        });
        allItems = newItems;
        renderAllItems();
        if (isInitialLoad) {
          isInitialLoad = false;
          initialLoader.style.opacity = '0';
          mainContent.style.opacity = '1';
          setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
        }
      }, (err)=> {
        console.error('places snapshot', err);
        loadingMessage.textContent = "שגיאה בטעינת המידע.";
      });
    }
    
    // --- חדש: טעינת מלונות מהלוגיסטיקה ---
    async function loadTripHotels() {
        if (!tripId) return;
        try {
            const logisticsRef = collection(db, 'trips', tripId, 'logistics');
            const q = query(logisticsRef, where("type", "==", "hotel"));
            const snapshot = await getDocs(q);
            tripHotels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        } catch (e) {
            console.error("Error loading hotels:", e);
            tripHotels = []; // Ensure it's an empty array on error
        }
    }

    // ---------- Init ----------
    async function initPage() {
      const urlParams = new URLSearchParams(window.location.search);
      tripId = urlParams.get('id') || urlParams.get('tripId');
      if (!tripId) {
        alert("שגיאה: לא נמצא מזהה טיול.");
        location.href = 'index.html';
        return;
      }
      attachEvents();
      
      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">שלום, ${displayName} 👋</span><button id="sign-out-btn" title="התנתק" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);

        if (tripSnap.exists()) {
            const loadedTripData = tripSnap.data();
            const canAccess = loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid);

            if (canAccess) {
                tripData = loadedTripData;

                if (tripTitleLine && tripData?.name) {
                  tripTitleLine.textContent = `אטרקציות ומסעדות לטיול - ${tripData.name}`;
                }
                
                // --- טעינת נתונים נוספים ---
                await loadTripHotels();
                await loadCustomSettings();
                buildMenuFromTrip();
                listenPlaces();
            } else {
                alert('אין לך הרשאה לצפות בטיול זה.');
                location.href='index.html';
            }
        } else {
            alert('הטיול לא נמצא.');
            location.href='index.html';
        }
      });
    }

    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
      });
    }

    initPage();
  </script>
</body>
</html>
