<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>××¡×¢ ×—×œ×•××•×ª ğŸ—½ ××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</title>
  <link rel="manifest" href="manifest.json" />
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- FontAwesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Assistant', 'sans-serif'],
            heading: ['Rubik', 'sans-serif'],
          },
          colors: {
            primary: '#0ea5e9', // Sky 500
            secondary: '#6366f1', // Indigo 500
            vacation: {
              light: '#f0f9ff',
              card: 'rgba(255, 255, 255, 0.95)',
              glass: 'rgba(255, 255, 255, 0.75)',
            }
          },
          animation: {
            'fade-in-up': 'fadeInUp 0.6s ease-out forwards',
            'bounce-slow': 'bounce 3s infinite',
          }
        }
      }
    }
  </script>

  <style>
    /* Global Resets & Base */
    html, body {
      overscroll-behavior-y: none; /* Prevent pull-to-refresh on mobile */
      -webkit-tap-highlight-color: transparent;
      background-color: #0f172a;
    }
    
    body {
      font-family: 'Assistant', sans-serif;
    }

    h1, h2, h3, h4, .font-heading {
      font-family: 'Rubik', sans-serif;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* Glassmorphism Classes */
    .glass-panel {
      background: var(--tw-vacation-glass);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.3);
    }
    
    .glass-header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(255,255,255,0.5);
    }

    /* Sidebar Transitions */
    #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    
    /* Submenu Transitions */
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
    .submenu.open { max-height: 500px; }

    /* Form Elements */
    .form-input, .form-select, .form-textarea {
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
      border-radius: 0.75rem; /* Rounded lg */
      font-size: 16px; /* Prevent zoom on iOS */
    }
    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.2);
      outline: none;
    }

    /* Animations */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .modal-step { display: none; }
    .modal-step.active { display: block; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(10px); }
      to { opacity: 1; transform: translateX(0); }
    }

    /* Map Containers */
    #map-preview, #details-map {
      height: 200px;
      width: 100%;
      border-radius: 1rem;
      overflow: hidden;
      background-color: #e2e8f0;
      box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.06);
    }

    /* Accordion Details */
    details > summary { list-style: none; cursor: pointer; user-select: none; }
    details > summary::-webkit-details-marker { display: none; }
    .chevron-icon { transition: transform 0.3s; }
    details[open] > summary .chevron-icon { transform: rotate(180deg); }

    /* Autocomplete */
    .ac-list {
      position: absolute; top: 100%; right: 0; left: 0;
      z-index: 50; background: white;
      border: 1px solid #e2e8f0; border-radius: 0.75rem;
      margin-top: 4px; max-height: 250px; overflow-y: auto;
      box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1);
    }
    .ac-item { padding: 12px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid #f1f5f9; cursor: pointer; }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:active { background: #f8fafc; }

    /* Utility */
    .safe-pb { padding-bottom: env(safe-area-inset-bottom); }
    body.modal-locked { overflow: hidden; height: 100vh; position: fixed; width: 100%; }
    
    /* Loading Spinner */
    .loader-spinner {
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top: 3px solid #ffffff;
      width: 24px;
      height: 24px;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>
<body class="text-slate-800 antialiased selection:bg-sky-200 selection:text-sky-900">

  <!-- Background Layer -->
  <div class="fixed inset-0 z-0">
    <!-- Travel Background Image -->
    <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop');"></div>
    <!-- Gradient Overlay -->
    <div class="absolute inset-0 bg-gradient-to-b from-slate-900/60 via-slate-900/40 to-slate-900/70"></div>
  </div>

  <!-- Initial Full Screen Loader -->
  <div id="initial-loader" class="fixed inset-0 z-[100] flex flex-col items-center justify-center bg-slate-900 text-white transition-opacity duration-500">
    <div class="relative mb-6">
      <div class="absolute inset-0 bg-blue-500 blur-xl opacity-20 rounded-full animate-pulse"></div>
      <i class="fas fa-plane-departure fa-4x text-sky-400 relative z-10 animate-bounce-slow"></i>
    </div>
    <h1 class="text-3xl font-heading font-bold tracking-wide">×˜×•×¢×Ÿ ××ª ×”××¡×¢...</h1>
    <p class="text-slate-400 mt-2 text-sm">××›×™×Ÿ ××ª ×”×”××œ×¦×•×ª ×”×›×™ ×©×•×•×ª</p>
  </div>

  <!-- Sidebar (Menu) -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-[85%] max-w-sm bg-white/95 backdrop-blur-xl shadow-2xl z-[70] transform translate-x-full overflow-y-auto safe-pb">
    <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-white/50 sticky top-0 z-10">
      <h2 class="text-2xl font-heading font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ <span class="text-sky-500">.</span></h2>
      <button id="close-sidebar-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition-colors">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    <nav id="main-menu" class="p-4 space-y-3"></nav>
    <div class="p-6 mt-4 bg-slate-50 mx-4 rounded-xl text-center">
        <p class="text-xs text-slate-400 mb-2">××—×•×‘×¨ ×›:</p>
        <div id="auth-display-sidebar" class="font-bold text-slate-700 truncate"></div>
        <button id="sign-out-btn-sidebar" class="mt-3 text-sm text-red-500 font-semibold hover:underline">×”×ª× ×ª×§</button>
    </div>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[60] hidden transition-opacity duration-300"></div>

  <!-- Main App Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-700 min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="glass-header sticky top-0 z-30 shadow-sm transition-all duration-300">
      <div class="container mx-auto px-4 max-w-5xl">
        <div class="flex items-center justify-between h-16">
          
          <div class="flex items-center gap-3">
            <button id="back-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-100/50 hover:bg-white text-slate-700 shadow-sm transition-all" title="×—×–×¨×”">
              <i class="fas fa-arrow-right"></i>
            </button>
            <div>
                <h1 class="text-lg font-heading font-bold text-slate-800 leading-tight">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</h1>
                <p id="trip-header-sub" class="text-xs text-slate-500 font-medium truncate max-w-[150px] sm:max-w-none">×˜×•×¢×Ÿ ×¤×¨×˜×™×...</p>
            </div>
          </div>

          <div class="flex items-center gap-3">
            <div id="auth-container" class="hidden md:flex items-center text-sm font-medium bg-white/60 px-3 py-1.5 rounded-full shadow-sm border border-white/50"></div>
            <button id="hamburger-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-white text-slate-700 shadow-sm hover:text-sky-600 transition-colors">
              <i class="fas fa-bars fa-lg"></i>
            </button>
          </div>

        </div>
      </div>
    </header>

    <!-- Main Body -->
    <main class="flex-grow container mx-auto px-4 sm:px-6 py-6 max-w-5xl safe-pb">
      
      <!-- Hero Section -->
      <div class="text-center mb-10 mt-4">
        <h2 class="text-4xl md:text-5xl font-heading font-extrabold text-white drop-shadow-lg mb-3">
          ×ª×—× ×•×ª ×‘××¡×¢ <span class="text-sky-300">âœ¨</span>
        </h2>
        <p class="text-lg text-slate-100/90 font-light max-w-xl mx-auto drop-shadow-md leading-relaxed">
          ×›×œ ×”×”××œ×¦×•×ª, ×”××¡×¢×“×•×ª ×•×”××§×•××•×ª ×”×©×•×•×™× ×‘××§×•× ××—×“.
        </p>

        <!-- Action Buttons -->
        <div class="mt-8 flex flex-wrap justify-center items-center gap-3">
          <button id="open-modal-btn" class="flex-1 min-w-[160px] max-w-xs bg-gradient-to-r from-sky-500 to-blue-600 hover:from-sky-400 hover:to-blue-500 text-white font-bold py-3.5 px-6 rounded-2xl shadow-lg hover:shadow-sky-500/30 transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2">
            <i class="fas fa-plus bg-white/20 p-1 rounded-full text-xs"></i> <span>×”×•×¡×¤×ª ××§×•×</span>
          </button>
          
          <a id="smart-route-btn" href="#" class="flex-1 min-w-[160px] max-w-xs bg-white text-slate-700 hover:text-purple-600 font-bold py-3.5 px-6 rounded-2xl shadow-lg hover:shadow-xl transform hover:-translate-y-1 transition-all duration-200 flex items-center justify-center gap-2">
            <i class="fas fa-magic-wand-sparkles text-purple-500"></i> <span>××¡×œ×•×œ ×—×›×</span>
          </a>
        </div>
        
        <button id="get-location-btn" class="mt-4 text-sm text-white/80 hover:text-white bg-black/20 hover:bg-black/30 backdrop-blur-sm py-2 px-4 rounded-full transition-all inline-flex items-center gap-2">
          <i class="fas fa-location-arrow text-xs"></i> ××¤×©×¨ ××™×§×•× ×œ××¨×—×§×™×
        </button>
      </div>

      <!-- Items List -->
      <div id="items-container" class="space-y-6 pb-12 min-h-[300px]">
        <p id="loading-message" class="text-center text-white bg-white/10 backdrop-blur-md p-6 rounded-2xl animate-pulse">
            <i class="fas fa-circle-notch fa-spin mr-2"></i> ××—×¤×© ×”××œ×¦×•×ª...
        </p>
      </div>
    </main>
  </div>

  <!-- Modals -->

  <!-- Add/Edit Item Modal -->
  <div id="item-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[90] hidden items-end sm:items-center justify-center sm:p-4 transition-all duration-300">
    <div class="bg-white w-full sm:max-w-2xl h-[90vh] sm:h-auto sm:max-h-[85vh] rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col overflow-hidden animate-fade-in-up">
      
      <!-- Modal Header -->
      <div class="px-6 py-4 border-b border-slate-100 flex justify-between items-center bg-white sticky top-0 z-10">
        <div>
            <h3 id="modal-title" class="text-xl font-heading font-bold text-slate-800">××§×•× ×—×“×©</h3>
            <div class="text-xs text-slate-400 font-medium mt-0.5" id="modal-steps-indicator">×©×œ×‘ 1</div>
        </div>
        <button id="modal-close-btn" class="w-8 h-8 rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-600 transition-colors flex items-center justify-center">
            <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Progress Bar -->
      <div class="w-full bg-slate-100 h-1.5">
        <div id="step-progress-bar" class="bg-gradient-to-r from-sky-400 to-blue-500 h-1.5 rounded-r-full transition-all duration-500 ease-out" style="width:0%;"></div>
      </div>

      <!-- Modal Body (Form) -->
      <form id="item-form" class="flex-grow overflow-y-auto p-6 space-y-6 scroll-smooth">
        <div id="step-1" class="modal-step"></div> <!-- Name -->
        <div id="step-2" class="modal-step"></div> <!-- Destination -->
        <div id="step-3" class="modal-step"></div> <!-- Type -->
        <div id="step-4" class="modal-step"></div> <!-- Location + Map -->
        <div id="step-5" class="modal-step"></div> <!-- Reservation -->
        <div id="step-6" class="modal-step"></div> <!-- Short Desc -->
        <div id="step-7" class="modal-step"></div> <!-- Long Desc -->
        <div id="step-8" class="modal-step"></div> <!-- Kosher (Restaurant only) -->
        <div id="step-9" class="modal-step"></div> <!-- Food Type (Restaurant only) -->
      </form>

      <!-- Modal Footer -->
      <div class="p-4 border-t border-slate-100 bg-slate-50 flex justify-between items-center gap-3 safe-pb">
        <button type="button" id="modal-back-btn" class="py-3 px-5 rounded-xl text-slate-500 font-bold hover:bg-slate-200 transition-colors hidden">
            ×—×–×¨×”
        </button>
        
        <div class="flex-grow text-center px-2">
            <div id="modal-error-message" class="text-red-500 text-xs font-bold transition-opacity opacity-0"></div>
        </div>
        
        <button type="button" id="modal-next-btn" class="py-3 px-8 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 shadow-lg shadow-slate-300 transition-all transform active:scale-95">
            ×”××©×š <i class="fas fa-chevron-left text-xs mr-2"></i>
        </button>
        <button type="submit" form="item-form" id="modal-finish-btn" class="py-3 px-8 bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold rounded-xl hover:shadow-green-500/30 shadow-lg transition-all hidden transform active:scale-95">
            <i class="fas fa-check ml-2"></i> ×¡×™×•×
        </button>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="details-modal" class="fixed inset-0 bg-slate-900/80 backdrop-blur-sm z-[95] hidden items-end sm:items-center justify-center sm:p-4 transition-opacity duration-300">
    <div id="details-modal-content" class="bg-white w-full sm:max-w-2xl h-[85vh] sm:h-auto sm:max-h-[90vh] rounded-t-3xl sm:rounded-3xl shadow-2xl flex flex-col relative overflow-hidden animate-fade-in-up">
        <!-- Content injected via JS -->
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div id="delete-confirm-modal" class="fixed inset-0 bg-black/70 z-[100] hidden items-center justify-center p-6 backdrop-blur-sm">
    <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-100 transition-transform">
      <div class="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
        <i class="fas fa-trash-alt fa-2x"></i>
      </div>
      <h3 id="delete-modal-title" class="text-xl font-heading font-bold text-slate-800 mb-2">××—×™×§×ª ×¤×¨×™×˜</h3>
      <p id="delete-modal-text" class="text-slate-500 mb-6 text-sm">×”×× ××ª×” ×‘×˜×•×—? ×”×¤×¢×•×œ×” ×”×–×• ×œ× × ×™×ª× ×ª ×œ×‘×™×˜×•×œ.</p>
      <div class="flex gap-3">
        <button id="delete-modal-cancel" class="flex-1 py-3 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition">×‘×™×˜×•×œ</button>
        <button id="delete-modal-confirm" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 shadow-lg shadow-red-200 transition">×›×Ÿ, ××—×§</button>
      </div>
    </div>
  </div>

  <!-- Navigation Choice Modal -->
  <div id="navigation-choice-modal" class="fixed inset-0 bg-black/70 z-[110] hidden items-end sm:items-center justify-center p-4 backdrop-blur-sm">
    <div class="bg-white rounded-3xl shadow-2xl p-6 w-full max-w-sm relative animate-fade-in-up">
      <button id="navigation-modal-close" class="absolute top-4 left-4 w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:text-slate-800 transition-colors flex items-center justify-center"><i class="fas fa-times"></i></button>
      <h3 class="text-xl font-heading font-bold text-slate-800 mb-6 text-center">× ×•×•×˜ ×‘×××¦×¢×•×ª...</h3>
      <div class="space-y-3">
        <a id="nav-link-waze" href="#" target="_blank" class="flex items-center justify-center gap-3 w-full bg-[#33ccff]/10 text-[#00a3cc] border-2 border-[#33ccff]/20 font-bold py-4 px-5 rounded-2xl hover:bg-[#33ccff] hover:text-white transition-all group">
            <i class="fab fa-waze fa-2x group-hover:scale-110 transition-transform"></i>
            <span class="text-lg">Waze</span>
        </a>
        <a id="nav-link-google" href="#" target="_blank" class="flex items-center justify-center gap-3 w-full bg-blue-50 text-blue-600 border-2 border-blue-100 font-bold py-4 px-5 rounded-2xl hover:bg-blue-600 hover:text-white hover:border-blue-600 transition-all group">
            <i class="fab fa-google fa-lg group-hover:scale-110 transition-transform"></i>
            <span class="text-lg">Google Maps</span>
        </a>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alert-modal" class="fixed inset-0 bg-black/70 z-[120] hidden items-center justify-center p-8 backdrop-blur-sm">
    <div class="bg-white rounded-3xl shadow-2xl p-6 text-center max-w-xs w-full">
      <h3 id="alert-modal-title" class="text-lg font-heading font-bold text-slate-800 mb-2">×”×•×“×¢×”</h3>
      <p id="alert-modal-text" class="text-slate-600 mb-6 text-sm"></p>
      <button id="alert-modal-ok" class="py-2.5 px-8 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-700 w-full">××™×©×•×¨</button>
    </div>
  </div>

  <!-- Scripts -->
  <script type="module">
    // --- Firebase Imports (Using standardized URLs for stability) ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, addDoc, query,
      onSnapshot, serverTimestamp, deleteDoc, updateDoc, setDoc,
      arrayUnion, orderBy, enableIndexedDbPersistence, where, getDocs
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

    // --- Configuration ---
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };

    const GOOGLE_MAPS_API_KEY = "AIzaSyAz7QZ2CBpCK_aOVbkqQLjfMRG5taaFs8c";

    // --- App Initialization ---
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // Try persistence
    try {
        enableIndexedDbPersistence(db).catch(err => {
            if (err.code == 'failed-precondition') console.log('Multiple tabs open, persistence disabled');
            else if (err.code == 'unimplemented') console.log('Browser lacks persistence support');
        });
    } catch(e) {}

    // --- State Variables ---
    let currentUser = null;
    let tripId = null;
    let tripData = null;
    let tripHotels = [];
    let allItems = [];
    let activeFilters = {};
    let isInitialLoad = true;
    let currentModalStep = 1;
    let totalModalSteps = 1;
    let editingItemId = null;
    let isRestaurant = false;
    let userLocation = null;
    
    // Maps State
    let gmapsApiLoaded = false;
    let gmaps_addEditMap = null, gmaps_addEditMarker = null;
    let gmaps_detailsMap = null, gmaps_detailsMarker = null;
    let gmaps_autocompleteService = null, gmaps_placesService = null;
    let selectedGooglePlaceDetails = null;

    // --- Data Definitions ---
    const settingsDocRef = doc(db, 'app_settings', 'custom_types');
    const siteData = {
      destinations: [],
      basePlaceTypes: ["××¡×¢×“×”/××•×›×œ","×¡×•×¤×¨","××•×–×™××•×Ÿ","×§× ×™×•×Ÿ/××¨×›×– ×§× ×™×•×ª","××˜×¨×§×¦×™×”","×—×•×£","×¡×™×•×¨","×¤××¨×§","×ª×¦×¤×™×ª"],
      customPlaceTypes: [],
      get placeTypes() { return [...new Set([...this.basePlaceTypes, ...this.customPlaceTypes])]; },
      baseFoodTypes: {
        "××™×˜×œ×§×™":"ğŸ","×—×œ×‘×™":"ğŸ§€","×‘×©×¨×™":"ğŸ¥©","×¦××—×•× ×™":"ğŸ¥—","××¡×™×™×ª×™":"ğŸœ",
        "×©×•×•××¨××”":"ğŸ¥™","×¤×™×¦×”":"ğŸ•","×”××‘×•×¨×’×¨":"ğŸ”","×‘×™×ª ×§×¤×”":"â˜•","×“×’×™×":"ğŸŸ","×§×™× ×•×—×™×":"ğŸ°"
      },
      customFoodTypes: {},
      get foodTypes() { return {...this.baseFoodTypes, ...this.customFoodTypes, "××—×¨":"ğŸ´"}; },
      placeTypeEmojis: {
        "××¡×¢×“×”/××•×›×œ":"ğŸ”","×¡×•×¤×¨":"ğŸ›’","××•×–×™××•×Ÿ":"ğŸ›ï¸","×§× ×™×•×Ÿ/××¨×›×– ×§× ×™×•×ª":"ğŸ›ï¸",
        "××˜×¨×§×¦×™×”":"ğŸ¢","×—×•×£":"ğŸ–ï¸","×¡×™×•×¨":"ğŸš¶â€â™‚ï¸","×¤××¨×§":"ğŸŒ³","×ª×¦×¤×™×ª":"ğŸ”­"
      }
    };

    // --- UI Helpers ---
    const els = {
        loader: document.getElementById('initial-loader'),
        mainContent: document.getElementById('main-content'),
        sidebar: document.getElementById('sidebar'),
        overlay: document.getElementById('overlay'),
        modal: document.getElementById('item-modal'),
        detailsModal: document.getElementById('details-modal'),
        itemsContainer: document.getElementById('items-container'),
        tripTitle: document.getElementById('trip-header-sub')
    };

    // Scroll Lock
    function toggleBodyScroll(lock) {
        if (lock) document.body.classList.add('modal-locked');
        else document.body.classList.remove('modal-locked');
    }

    // Notifications
    function showAlert(msg, title='×”×•×“×¢×”') {
        const m = document.getElementById('alert-modal');
        document.getElementById('alert-modal-title').textContent = title;
        document.getElementById('alert-modal-text').innerHTML = msg;
        m.classList.remove('hidden');
        m.classList.add('flex');
        document.getElementById('alert-modal-ok').onclick = () => {
            m.classList.add('hidden');
            m.classList.remove('flex');
        };
    }

    function showModalError(msg) {
        const el = document.getElementById('modal-error-message');
        el.textContent = msg;
        el.style.opacity = '1';
        if(msg) setTimeout(() => { el.style.opacity = '0'; }, 3000);
    }

    // --- Logic: Google Maps ---
    function loadGoogleMaps() {
        if (window.google?.maps) { gmapsApiLoaded = true; return Promise.resolve(); }
        return new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,marker&language=iw&loading=async`;
            s.onload = () => { gmapsApiLoaded = true; resolve(); };
            s.onerror = () => reject('Gmaps load failed');
            document.head.appendChild(s);
        });
    }

    function initAutocomplete(input, callback) {
        if (!gmapsApiLoaded || !input) return;
        const wrapper = input.parentElement;
        // Simple generic debouncer
        let timeout;
        
        input.addEventListener('input', () => {
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                const val = input.value;
                if(val.length < 2) return;
                
                if(!gmaps_autocompleteService) gmaps_autocompleteService = new google.maps.places.AutocompleteService();
                gmaps_autocompleteService.getPlacePredictions({ input: val }, (predictions, status) => {
                    let list = wrapper.querySelector('.ac-list');
                    if(!list) {
                        list = document.createElement('div');
                        list.className = 'ac-list';
                        wrapper.appendChild(list);
                    }
                    list.innerHTML = '';
                    
                    if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
                        list.remove(); return;
                    }

                    predictions.forEach(p => {
                        const div = document.createElement('div');
                        div.className = 'ac-item';
                        div.innerHTML = `<i class="fas fa-map-marker-alt text-slate-400"></i><div><div class="font-bold text-sm">${p.structured_formatting.main_text}</div><div class="text-xs text-slate-500">${p.structured_formatting.secondary_text}</div></div>`;
                        div.onclick = () => {
                            input.value = p.description;
                            list.remove();
                            fetchPlaceDetails(p.place_id, callback);
                        };
                        list.appendChild(div);
                    });
                });
            }, 400);
        });
        
        // Close on click outside
        document.addEventListener('click', e => {
            if(!wrapper.contains(e.target)) {
                const l = wrapper.querySelector('.ac-list');
                if(l) l.remove();
            }
        });
    }

    function fetchPlaceDetails(placeId, callback) {
        if(!gmaps_placesService) {
            const d = document.createElement('div');
            gmaps_placesService = new google.maps.places.PlacesService(d);
        }
        const req = {
            placeId: placeId,
            fields: ["place_id","name","formatted_address","geometry","website","opening_hours","photos","types","rating"]
        };
        gmaps_placesService.getDetails(req, (place, status) => {
            if(status === google.maps.places.PlacesServiceStatus.OK && place) {
                const res = {
                    placeId: place.place_id,
                    name: place.name,
                    location: place.formatted_address,
                    coords: { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() },
                    website: place.website || '',
                    hours: place.opening_hours?.weekday_text?.join('\n') || '',
                    photos: place.photos ? place.photos.slice(0,3).map(p=>p.getUrl({maxWidth:800})) : [],
                    types: place.types||[],
                    rating: place.rating
                };
                callback(res);
            }
        });
    }

    function initMapPreview(latLng) {
        const el = document.getElementById('map-preview');
        if(!el || !gmapsApiLoaded) return;
        
        if(!gmaps_addEditMap) {
            gmaps_addEditMap = new google.maps.Map(el, { center: latLng, zoom: 15, disableDefaultUI: true });
            gmaps_addEditMarker = new google.maps.Marker({ position: latLng, map: gmaps_addEditMap, draggable: true });
            
            gmaps_addEditMarker.addListener('dragend', () => {
                const p = gmaps_addEditMarker.getPosition();
                if(selectedGooglePlaceDetails) selectedGooglePlaceDetails.coords = { lat: p.lat(), lng: p.lng() };
            });
        } else {
            gmaps_addEditMap.setCenter(latLng);
            gmaps_addEditMarker.setPosition(latLng);
        }
        
        // Fix for map resizing in hidden modal
        setTimeout(() => google.maps.event.trigger(gmaps_addEditMap, "resize"), 300);
    }

    // --- Logic: Modal Steps ---
    function renderStep(step) {
        const container = document.getElementById(`step-${step}`);
        if(!container) return;
        
        // Reset contents if moving forward to ensure cleanliness, or keep if backward? 
        // For simplicity and performance, we'll just check if empty or update values.
        
        const item = editingItemId ? allItems.find(i => i.id === editingItemId) : null;
        let html = '';
        const labelClass = "block text-lg font-bold text-slate-700 mb-2";
        const iconClass = "text-sky-500 ml-2";

        switch(step) {
            case 1: // Name
                html = `
                    <label class="${labelClass}"><i class="fas fa-heading ${iconClass}"></i> ×©× ×”××§×•×</label>
                    <input type="text" id="inp-name" class="form-input w-full p-4 bg-slate-50 focus:bg-white" placeholder="×œ××©×œ: ××•×–×™××•×Ÿ ×”×œ×•×‘×¨" value="${item?.name || ''}">
                    <p class="text-xs text-slate-400 mt-2">×¨×©×•× ×©× ×‘×¨×•×¨ ×›×“×™ ×œ×–×”×•×ª ××ª ×”××§×•× ×‘×§×œ×•×ª.</p>
                `;
                break;
            case 2: // Destination
                html = `
                    <label class="${labelClass}"><i class="fas fa-map-marked-alt ${iconClass}"></i> ×™×¢×“ ×‘×˜×™×•×œ</label>
                    <select id="inp-dest" class="form-select w-full p-4 bg-slate-50">
                        ${siteData.destinations.map(d => `<option value="${d}" ${item?.destination===d?'selected':''}>ğŸ“ ${d}</option>`).join('')}
                    </select>
                `;
                break;
            case 3: // Type
                html = `
                    <label class="${labelClass}"><i class="fas fa-shapes ${iconClass}"></i> ×¡×•×’ ×”××§×•×</label>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        ${siteData.placeTypes.map(t => {
                            const icon = siteData.placeTypeEmojis[t] || 'ğŸ“Œ';
                            const isSel = item?.type === t;
                            return `<div class="type-opt cursor-pointer border rounded-xl p-3 flex items-center gap-2 ${isSel ? 'border-sky-500 bg-sky-50 text-sky-700' : 'border-slate-200 hover:bg-slate-50'}" onclick="selectType(this, '${t}')">
                                <span class="text-xl">${icon}</span> <span class="text-sm font-bold">${t}</span>
                            </div>`;
                        }).join('')}
                        <div class="type-opt cursor-pointer border rounded-xl p-3 flex items-center gap-2 ${item?.type==='××—×¨'?'border-sky-500 bg-sky-50':''}" onclick="selectType(this, '××—×¨')">
                            <span>âœï¸</span> <span class="text-sm font-bold">××—×¨</span>
                        </div>
                    </div>
                    <input type="hidden" id="inp-type" value="${item?.type || ''}">
                    <input type="text" id="inp-type-other" class="form-input w-full p-3 mt-2 ${item?.type==='××—×¨'?'':'hidden'}" placeholder="×”×§×œ×“ ×¡×•×’...">
                `;
                break;
            case 4: // Location
                html = `
                    <label class="${labelClass}"><i class="fas fa-search-location ${iconClass}"></i> ×—×™×¤×•×© ×‘-Google</label>
                    <div class="relative ac-wrapper">
                        <input type="text" id="inp-loc-search" class="form-input w-full p-4 pl-10 bg-white shadow-sm border-sky-100 focus:border-sky-400" placeholder="×”×ª×—×œ ×œ×”×§×œ×™×“ ×©× ××• ×›×ª×•×‘×ª...">
                        <i class="fas fa-search absolute left-4 top-4 text-slate-300"></i>
                    </div>
                    
                    <div id="map-preview" class="mt-4 border-4 border-white shadow-lg"></div>
                    
                    <div class="mt-4 space-y-3 bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <div>
                            <span class="text-xs font-bold text-slate-400 uppercase">×›×ª×•×‘×ª</span>
                            <input id="inp-address" class="w-full bg-transparent border-b border-slate-200 focus:border-sky-400 outline-none py-1 text-slate-700 text-sm" readonly value="${item?.location || ''}">
                        </div>
                        <div class="flex gap-4">
                            <div class="flex-1">
                                <span class="text-xs font-bold text-slate-400 uppercase">××ª×¨</span>
                                <input id="inp-link" type="url" class="w-full bg-transparent border-b border-slate-200 focus:border-sky-400 outline-none py-1 text-slate-700 text-sm" placeholder="https://..." value="${item?.link || ''}">
                            </div>
                        </div>
                         <div>
                            <span class="text-xs font-bold text-slate-400 uppercase">×©×¢×•×ª ×¤×ª×™×—×”</span>
                            <textarea id="inp-hours" rows="2" class="w-full bg-transparent border-b border-slate-200 focus:border-sky-400 outline-none py-1 text-slate-700 text-sm">${item?.hours || ''}</textarea>
                        </div>
                    </div>
                `;
                break;
            case 5: // Reservation
                html = `
                    <label class="${labelClass}"><i class="fas fa-calendar-check ${iconClass}"></i> ×”×–×× ×ª ××§×•×</label>
                    <div class="flex flex-col gap-3">
                        <label class="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="res" value="×œ×" ${(!item || item.reservation==='×œ×')?'checked':''}>
                            <span class="font-medium">××™×Ÿ ×¦×•×¨×š</span>
                        </label>
                         <label class="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="res" value="××•××œ×¥" ${item?.reservation==='××•××œ×¥'?'checked':''}>
                            <span class="font-medium">××•××œ×¥ ×œ×”×–××™×Ÿ</span>
                        </label>
                        <label class="flex items-center gap-3 p-4 border rounded-xl cursor-pointer hover:bg-slate-50">
                            <input type="radio" name="res" value="×›×Ÿ" ${item?.reservation==='×›×Ÿ'?'checked':''}>
                            <span class="font-medium">×—×•×‘×” ×œ×”×–××™×Ÿ ××¨××©</span>
                        </label>
                    </div>
                `;
                break;
            case 6: // Short Desc
                html = `
                    <label class="${labelClass}"><i class="fas fa-tag ${iconClass}"></i> ×ª×™××•×¨ ×§×¦×¨</label>
                    <textarea id="inp-short" class="form-textarea w-full p-4" rows="3" placeholder="××©×¤×˜ ××—×“ ×©××ª××¨ ××ª ×”××§×•× (×™×•×¤×™×¢ ×‘×›×¨×˜×™×¡ ×”×¨××©×™)">${item?.shortDescription || ''}</textarea>
                `;
                break;
            case 7: // Full Desc
                html = `
                    <label class="${labelClass}"><i class="fas fa-align-right ${iconClass}"></i> ×¤×™×¨×•×˜ ××œ×</label>
                    <textarea id="inp-full" class="form-textarea w-full p-4" rows="6" placeholder="×›×œ ×”××™×“×¢ ×”× ×•×¡×£, ×˜×™×¤×™×, ×”××œ×¦×•×ª ×œ×× ×•×ª ×•×›×•'">${item?.description || ''}</textarea>
                `;
                break;
            case 8: // Kosher
                html = `
                     <label class="${labelClass}"><i class="fas fa-star-of-david ${iconClass}"></i> ×”×× ×”××§×•× ×›×©×¨?</label>
                     <div class="flex gap-4">
                        <button type="button" class="flex-1 py-4 border-2 rounded-xl font-bold ${item?.isKosher==='×›×Ÿ'?'border-sky-500 bg-sky-50 text-sky-700':'border-slate-200 text-slate-500'}" onclick="setKosher(this, '×›×Ÿ')">×›×Ÿ</button>
                        <button type="button" class="flex-1 py-4 border-2 rounded-xl font-bold ${item?.isKosher!=='×›×Ÿ'?'border-slate-200 text-slate-500':'border-sky-500'}" onclick="setKosher(this, '×œ×')">×œ×</button>
                     </div>
                     <input type="hidden" id="inp-kosher" value="${item?.isKosher || '×œ×'}">
                `;
                break;
             case 9: // Food Type
                html = `
                    <label class="${labelClass}"><i class="fas fa-utensils ${iconClass}"></i> ×¡×’× ×•×Ÿ ××˜×‘×—</label>
                    <div class="flex flex-wrap gap-2">
                        ${Object.keys(siteData.foodTypes).map(f => {
                             const isSel = item?.foodType === f;
                             return `<button type="button" class="px-4 py-2 rounded-full border text-sm font-medium transition ${isSel?'bg-sky-500 text-white border-sky-500':'bg-white text-slate-600 border-slate-200 hover:border-sky-300'}" onclick="selectFood(this, '${f}')">${siteData.foodTypes[f]} ${f}</button>`;
                        }).join('')}
                    </div>
                    <input type="hidden" id="inp-food" value="${item?.foodType || ''}">
                `;
                break;
        }

        container.innerHTML = html;
        
        // Post-render init
        if(step === 3) window.selectType = (el, val) => {
            document.querySelectorAll('.type-opt').forEach(d => {
                d.classList.remove('border-sky-500','bg-sky-50','text-sky-700');
                d.classList.add('border-slate-200');
            });
            el.classList.remove('border-slate-200');
            el.classList.add('border-sky-500','bg-sky-50','text-sky-700');
            document.getElementById('inp-type').value = val;
            document.getElementById('inp-type-other').classList.toggle('hidden', val !== '××—×¨');
            
            // Recalculate steps immediately
            isRestaurant = (val === '××¡×¢×“×”/××•×›×œ');
            calcSteps();
        };

        if(step === 4) {
             const input = document.getElementById('inp-loc-search');
             initAutocomplete(input, (details) => {
                 document.getElementById('inp-address').value = details.location;
                 document.getElementById('inp-link').value = details.website;
                 document.getElementById('inp-hours').value = details.hours;
                 if(!document.getElementById('inp-name').value) document.getElementById('inp-name').value = details.name;
                 
                 selectedGooglePlaceDetails = details;
                 initMapPreview(details.coords);
             });
             if(item?.coords) initMapPreview(item.coords);
             else if(selectedGooglePlaceDetails?.coords) initMapPreview(selectedGooglePlaceDetails.coords);
             else initMapPreview({lat:32.0853, lng:34.7818}); // Default TLV
        }
        
        if(step === 8) window.setKosher = (btn, val) => {
            document.getElementById('inp-kosher').value = val;
            const btns = btn.parentElement.querySelectorAll('button');
            btns.forEach(b => b.className = `flex-1 py-4 border-2 rounded-xl font-bold border-slate-200 text-slate-500`);
            btn.className = `flex-1 py-4 border-2 rounded-xl font-bold border-sky-500 bg-sky-50 text-sky-700`;
        }

        if(step === 9) window.selectFood = (btn, val) => {
             document.getElementById('inp-food').value = val;
             const p = btn.parentElement;
             p.querySelectorAll('button').forEach(b => b.className="px-4 py-2 rounded-full border text-sm font-medium transition bg-white text-slate-600 border-slate-200 hover:border-sky-300");
             btn.className = "px-4 py-2 rounded-full border text-sm font-medium transition bg-sky-500 text-white border-sky-500";
        }
    }

    function calcSteps() {
        // Dynamic steps
        const steps = [1,2,3,4,5,6,7];
        if(isRestaurant) steps.push(8,9);
        return steps;
    }

    function updateModalNav() {
        const steps = calcSteps();
        totalModalSteps = steps.length;
        
        document.querySelectorAll('.modal-step').forEach(el => el.classList.remove('active'));
        const currentRealStep = steps[currentModalStep - 1];
        
        // Render current step
        const stepDiv = document.getElementById(`step-${currentRealStep}`);
        if(stepDiv) {
            stepDiv.innerHTML = ''; // clear old
            renderStep(currentRealStep);
            stepDiv.classList.add('active');
        }

        // Progress
        const pct = (currentModalStep / totalModalSteps) * 100;
        document.getElementById('step-progress-bar').style.width = `${pct}%`;
        document.getElementById('modal-steps-indicator').textContent = `×©×œ×‘ ${currentModalStep} ××ª×•×š ${totalModalSteps}`;
        
        // Buttons
        const backBtn = document.getElementById('modal-back-btn');
        const nextBtn = document.getElementById('modal-next-btn');
        const finishBtn = document.getElementById('modal-finish-btn');
        
        backBtn.classList.toggle('hidden', currentModalStep === 1);
        nextBtn.classList.toggle('hidden', currentModalStep === totalModalSteps);
        finishBtn.classList.toggle('hidden', currentModalStep !== totalModalSteps);
    }

    // --- Modal Management ---
    function openModal(id=null) {
        editingItemId = id;
        selectedGooglePlaceDetails = null;
        currentModalStep = 1;
        document.getElementById('modal-title').textContent = id ? '×¢×¨×™×›×ª ××§×•×' : '××§×•× ×—×“×©';
        
        const item = id ? allItems.find(i=>i.id===id) : null;
        if(item) isRestaurant = (item.type === '××¡×¢×“×”/××•×›×œ');
        else isRestaurant = false;

        updateModalNav();
        els.modal.classList.remove('hidden');
        els.modal.classList.add('flex');
        toggleBodyScroll(true);
    }

    function closeModal() {
        els.modal.classList.add('hidden');
        els.modal.classList.remove('flex');
        toggleBodyScroll(false);
    }

    // --- Core: Render Items ---
    function renderItems() {
        const container = els.itemsContainer;
        if(allItems.length === 0) {
            container.innerHTML = `
                <div class="text-center py-20">
                    <div class="bg-white/10 inline-block p-6 rounded-full mb-4 backdrop-blur-sm shadow-inner">
                        <i class="fas fa-map-signs fa-3x text-white/60"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-2">×˜×¨× × ×•×¡×¤×• ××§×•××•×ª</h3>
                    <p class="text-white/80">×œ×—×¦×• ×¢×œ ×›×¤×ª×•×¨ ×”×•×¡×¤×ª ××§×•× ×›×“×™ ×œ×”×ª×—×™×œ</p>
                </div>`;
            return;
        }

        container.innerHTML = '';
        
        // Group by Dest
        const grouped = allItems.reduce((acc, item) => {
            const d = item.destination || '×›×œ×œ×™';
            (acc[d] ||= []).push(item);
            return acc;
        }, {});

        siteData.destinations.forEach(dest => {
            if(!grouped[dest]) return;
            
            const section = document.createElement('details');
            section.className = "bg-white/95 backdrop-blur-md rounded-3xl shadow-xl overflow-hidden mb-6 border border-white/50";
            section.open = true; // Default open
            
            const itemsInDest = grouped[dest];
            const count = itemsInDest.length;

            section.innerHTML = `
                <summary class="p-6 cursor-pointer hover:bg-slate-50 transition-colors list-none flex justify-between items-center group sticky top-0 bg-white/95 z-10 backdrop-blur-sm border-b border-slate-100">
                    <div class="flex items-center gap-4">
                         <div class="w-10 h-10 rounded-full bg-sky-100 text-sky-600 flex items-center justify-center font-bold text-lg shadow-sm">
                            ${dest.substring(0,1)}
                         </div>
                         <div>
                             <h3 class="text-xl font-bold text-slate-800">${dest}</h3>
                             <span class="text-xs text-slate-500 font-medium">${count} ××§×•××•×ª</span>
                         </div>
                    </div>
                    <i class="fas fa-chevron-down text-slate-300 group-hover:text-sky-500 transition-transform duration-300 chevron-icon"></i>
                </summary>
                <div class="p-4 sm:p-6 bg-slate-50/50">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        ${renderCards(itemsInDest)}
                    </div>
                </div>
            `;
            container.appendChild(section);
        });
    }

    function renderCards(items) {
        return items.map(item => {
            const icon = siteData.placeTypeEmojis[item.type] || 'ğŸ“Œ';
            const img = (item.photos && item.photos.length) ? item.photos[0] : null;
            const stars = renderStars(item.rating);
            const foodBadge = item.foodType ? `<span class="bg-orange-100 text-orange-700 text-[10px] px-2 py-1 rounded-full font-bold">${siteData.foodTypes[item.foodType]||'ğŸ´'} ${item.foodType}</span>` : '';
            const kosherBadge = item.isKosher==='×›×Ÿ' ? `<span class="bg-green-100 text-green-700 text-[10px] px-2 py-1 rounded-full font-bold">×›×©×¨</span>` : '';
            
            // Generate fallback gradient based on name length
            const fallbackBg = `linear-gradient(135deg, hsl(${item.name.length * 15}, 70%, 90%), hsl(${item.name.length * 15 + 40}, 70%, 95%))`;

            return `
            <div class="bg-white rounded-2xl shadow-md hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 overflow-hidden flex flex-col h-full group border border-slate-100 cursor-pointer item-card" onclick="openDetails('${item.id}')">
                <div class="relative h-40 overflow-hidden">
                    ${img 
                        ? `<img src="${img}" class="w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" loading="lazy">` 
                        : `<div class="w-full h-full flex items-center justify-center" style="background: ${fallbackBg}"><i class="fas fa-camera text-slate-300 text-4xl"></i></div>`
                    }
                    <div class="absolute top-3 right-3 bg-white/90 backdrop-blur-sm px-3 py-1 rounded-full text-xs font-bold text-slate-700 shadow-sm flex items-center gap-1">
                        <span>${icon}</span> ${item.type}
                    </div>
                </div>
                
                <div class="p-5 flex-grow flex flex-col">
                    <div class="flex justify-between items-start mb-2">
                         <h4 class="font-heading font-bold text-lg text-slate-800 leading-tight line-clamp-2">${item.name}</h4>
                         ${stars ? `<div class="flex items-center gap-1 text-amber-400 text-xs bg-amber-50 px-1.5 py-0.5 rounded border border-amber-100 font-bold">${item.rating.toFixed(1)} <i class="fas fa-star"></i></div>` : ''}
                    </div>
                    
                    <div class="flex flex-wrap gap-2 mb-3">
                        ${foodBadge} ${kosherBadge}
                        ${item.reservation && item.reservation !=='×œ×' ? `<span class="bg-purple-100 text-purple-700 text-[10px] px-2 py-1 rounded-full font-bold">×”×–×× ×”: ${item.reservation}</span>` : ''}
                    </div>
                    
                    <p class="text-sm text-slate-500 line-clamp-2 mb-4 flex-grow">${item.shortDescription || '×œ×œ× ×ª×™××•×¨'}</p>
                    
                    <div class="pt-4 border-t border-slate-100 flex items-center justify-between mt-auto">
                        <button class="w-10 h-10 rounded-full bg-slate-50 text-slate-400 hover:bg-sky-500 hover:text-white transition-colors flex items-center justify-center nav-btn" data-id="${item.id}" title="× ×™×•×•×˜" onclick="event.stopPropagation(); showNavModal('${item.id}')">
                            <i class="fas fa-location-arrow"></i>
                        </button>
                        
                        <div class="flex gap-2">
                            <button class="text-slate-400 hover:text-sky-600 px-2 py-1 transition-colors" onclick="event.stopPropagation(); openModal('${item.id}')"><i class="fas fa-pencil-alt"></i></button>
                            <button class="text-slate-400 hover:text-red-500 px-2 py-1 transition-colors" onclick="event.stopPropagation(); confirmDelete('${item.id}')"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            </div>`;
        }).join('');
    }

    function renderStars(rating) {
        if(!rating) return null;
        return true; // Simple boolean check for cleaner UI logic above
    }

    // --- Details Modal ---
    window.openDetails = (id) => {
        const item = allItems.find(i=>i.id===id);
        if(!item) return;
        
        const container = document.getElementById('details-modal-content');
        const icon = siteData.placeTypeEmojis[item.type] || 'ğŸ“Œ';
        
        let gallery = '';
        if(item.photos && item.photos.length) {
            gallery = `
            <div class="flex gap-2 overflow-x-auto pb-4 snap-x hide-scroll">
                ${item.photos.map(src => `<img src="${src}" class="h-48 w-auto rounded-xl shadow-md snap-center flex-shrink-0 object-cover">`).join('')}
            </div>`;
        }

        container.innerHTML = `
            <div class="relative h-full flex flex-col bg-white">
                <!-- Header Image/Gallery -->
                <div class="relative bg-slate-100 p-0">
                    <button onclick="document.getElementById('details-modal').classList.add('hidden'); document.getElementById('details-modal').classList.remove('flex'); toggleBodyScroll(false);" 
                        class="absolute top-4 left-4 z-20 w-10 h-10 bg-white/80 backdrop-blur rounded-full shadow-lg flex items-center justify-center text-slate-700 hover:text-red-500 transition">
                        <i class="fas fa-times"></i>
                    </button>
                    ${gallery ? `<div class="p-4 bg-slate-900/5">${gallery}</div>` : 
                    `<div class="h-32 bg-gradient-to-r from-sky-100 to-blue-50 flex items-center justify-center"><i class="fas fa-image text-slate-300 fa-3x"></i></div>`}
                </div>

                <!-- Content -->
                <div class="p-6 overflow-y-auto flex-grow">
                    <div class="flex justify-between items-start">
                        <h2 class="text-3xl font-heading font-bold text-slate-800 mb-2">${item.name}</h2>
                        ${item.rating ? `<div class="bg-amber-100 text-amber-600 px-3 py-1 rounded-xl font-bold flex items-center gap-1"><i class="fas fa-star"></i> ${item.rating}</div>` : ''}
                    </div>
                    
                    <div class="inline-flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg text-sm font-medium text-slate-600 mb-6">
                        <span>${icon}</span> ${item.type}
                    </div>

                    ${item.description ? `<div class="prose prose-slate max-w-none mb-8 text-slate-600 whitespace-pre-line leading-relaxed">${item.description}</div>` : ''}

                    <div class="bg-slate-50 rounded-2xl p-5 space-y-4 border border-slate-100">
                        ${item.location ? `<div class="flex items-start gap-4"><i class="fas fa-map-marker-alt text-red-400 mt-1 w-5"></i><span class="text-slate-700 font-medium">${item.location}</span></div>` : ''}
                        ${item.hours ? `<div class="flex items-start gap-4"><i class="fas fa-clock text-sky-400 mt-1 w-5"></i><span class="text-slate-700 whitespace-pre-line text-sm">${item.hours}</span></div>` : ''}
                        ${item.link ? `<div class="flex items-start gap-4"><i class="fas fa-globe text-blue-400 mt-1 w-5"></i><a href="${item.link}" target="_blank" class="text-blue-600 hover:underline font-medium truncate block max-w-[200px]">×œ××ª×¨ ×”××™× ×˜×¨× ×˜</a></div>` : ''}
                    </div>

                    ${item.coords ? `<div id="details-map" class="mt-6 shadow-inner border border-slate-200"></div>` : ''}
                </div>

                <!-- Footer Actions -->
                <div class="p-4 bg-white border-t border-slate-100 flex gap-3 shadow-[0_-5px_15px_rgba(0,0,0,0.05)] z-10">
                    <button class="flex-1 bg-sky-600 text-white font-bold py-3.5 rounded-xl shadow-lg hover:bg-sky-700 transition flex items-center justify-center gap-2" onclick="showNavModal('${item.id}')">
                        <i class="fas fa-location-arrow"></i> × ×•×•×˜
                    </button>
                    <button class="flex-1 bg-slate-100 text-slate-700 font-bold py-3.5 rounded-xl hover:bg-slate-200 transition flex items-center justify-center gap-2" onclick="closeDetails(); openModal('${item.id}')">
                        <i class="fas fa-pencil-alt"></i> ×¢×¨×™×›×”
                    </button>
                </div>
            </div>
        `;

        els.detailsModal.classList.remove('hidden');
        els.detailsModal.classList.add('flex');
        toggleBodyScroll(true);

        window.closeDetails = () => {
             els.detailsModal.classList.add('hidden');
             els.detailsModal.classList.remove('flex');
             toggleBodyScroll(false);
        };

        if(item.coords) {
            setTimeout(() => {
                const el = document.getElementById('details-map');
                if(!el) return;
                const map = new google.maps.Map(el, { center: item.coords, zoom: 15, disableDefaultUI: true });
                new google.maps.Marker({ position: item.coords, map: map });
            }, 300);
        }
    };

    window.showNavModal = (id) => {
        const item = allItems.find(i=>i.id===id);
        if(!item || !item.coords) return;
        
        const {lat, lng} = item.coords;
        document.getElementById('nav-link-waze').href = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
        document.getElementById('nav-link-google').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
        
        const m = document.getElementById('navigation-choice-modal');
        m.classList.remove('hidden');
        m.classList.add('flex');
    };

    window.confirmDelete = (id) => {
         const m = document.getElementById('delete-confirm-modal');
         const item = allItems.find(i=>i.id===id);
         document.getElementById('delete-modal-text').textContent = `×”×× ×œ××—×•×§ ××ª "${item?.name}"?`;
         m.classList.remove('hidden');
         m.classList.add('flex');
         
         document.getElementById('delete-modal-confirm').onclick = async () => {
             try {
                await deleteDoc(doc(db, 'trips', tripId, 'places', id));
                m.classList.add('hidden');
                m.classList.remove('flex');
             } catch(e) { console.error(e); showAlert('×©×’×™××” ×‘××—×™×§×”'); }
         };
         document.getElementById('delete-modal-cancel').onclick = () => {
             m.classList.add('hidden');
             m.classList.remove('flex');
         };
    };

    // --- Events Setup ---
    function setupEvents() {
        // Modal Nav
        document.getElementById('modal-next-btn').onclick = () => {
            // Validation
            if(currentModalStep === 1 && !document.getElementById('inp-name').value) { showModalError('×—×•×‘×” ×œ××œ× ×©× ××§×•×'); return; }
            if(currentModalStep === 4 && !document.getElementById('inp-address').value) { showModalError('×—×•×‘×” ×œ×‘×—×•×¨ ×›×ª×•×‘×ª'); return; }
            
            if(currentModalStep < totalModalSteps) {
                currentModalStep++;
                updateModalNav();
            }
        };
        document.getElementById('modal-back-btn').onclick = () => {
             if(currentModalStep > 1) {
                currentModalStep--;
                updateModalNav();
            }
        };

        // Form Submit
        document.getElementById('item-form').onsubmit = async (e) => {
            e.preventDefault();
            const gv = id => document.getElementById(id).value;
            
            // Build Data
            const type = gv('inp-type') === '××—×¨' ? (gv('inp-type-other') || '×›×œ×œ×™') : gv('inp-type');
            
            let coords = null;
            let photos = [];
            let rating = null;
            let googlePlaceId = null;

            // Logic to preserve existing data or use Google Data
            const existing = editingItemId ? allItems.find(i => i.id === editingItemId) : null;
            
            if(existing) {
                coords = existing.coords;
                photos = existing.photos || [];
                rating = existing.rating;
                googlePlaceId = existing.googlePlaceId;
            }

            if(selectedGooglePlaceDetails) {
                 coords = selectedGooglePlaceDetails.coords; // Priority to new selection
                 if(selectedGooglePlaceDetails.photos?.length) photos = selectedGooglePlaceDetails.photos;
                 if(selectedGooglePlaceDetails.rating) rating = selectedGooglePlaceDetails.rating;
                 googlePlaceId = selectedGooglePlaceDetails.placeId;
            } else if (gmaps_addEditMarker) {
                const p = gmaps_addEditMarker.getPosition();
                coords = { lat: p.lat(), lng: p.lng() };
            }

            if(!coords) { showModalError('×—×¡×¨ ××™×§×•× ×‘××¤×”'); return; }

            // If custom type, save it
            if(gv('inp-type') === '××—×¨' && !siteData.placeTypes.includes(type)) {
                await updateDoc(settingsDocRef, { placeTypes: arrayUnion(type) }).catch(()=>{ setDoc(settingsDocRef, { placeTypes:[type] }); });
                siteData.customPlaceTypes.push(type);
            }

            const payload = {
                name: gv('inp-name'),
                destination: gv('inp-dest'),
                type: type,
                location: gv('inp-address'),
                link: gv('inp-link'),
                hours: gv('inp-hours'),
                reservation: document.querySelector('input[name="res"]:checked')?.value || '×œ×',
                shortDescription: gv('inp-short'),
                description: gv('inp-full'),
                isKosher: gv('inp-kosher'),
                foodType: gv('inp-food'),
                coords, photos, rating, googlePlaceId,
                author: currentUser.uid
            };

            const btn = document.getElementById('modal-finish-btn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ×©×•××¨...';
            btn.disabled = true;

            try {
                if(editingItemId) {
                    await updateDoc(doc(db, 'trips', tripId, 'places', editingItemId), { ...payload, updatedAt: serverTimestamp() });
                } else {
                    await addDoc(collection(db, 'trips', tripId, 'places'), { ...payload, createdAt: serverTimestamp() });
                }
                closeModal();
            } catch(err) {
                console.error(err);
                showModalError('×©×’×™××” ×‘×©××™×¨×”, × ×¡×” ×©×•×‘');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // General UI
        document.getElementById('open-modal-btn').onclick = () => openModal();
        document.getElementById('modal-close-btn').onclick = closeModal;
        document.getElementById('navigation-modal-close').onclick = () => {
            const m = document.getElementById('navigation-choice-modal');
            m.classList.add('hidden'); m.classList.remove('flex');
        };
        
        // Sidebar
        const toggleSidebar = () => {
            els.sidebar.classList.toggle('translate-x-full');
            els.overlay.classList.toggle('hidden');
        };
        document.getElementById('hamburger-btn').onclick = toggleSidebar;
        document.getElementById('close-sidebar-btn').onclick = toggleSidebar;
        els.overlay.onclick = toggleSidebar;
    }

    // --- Init Page ---
    (async function init() {
        const p = new URLSearchParams(window.location.search);
        tripId = p.get('id') || p.get('tripId');
        
        if(!tripId) {
             els.loader.innerHTML = '<h1 class="text-2xl text-red-500">×©×’×™××”: ×œ× ×–×•×”×” ×˜×™×•×œ</h1>';
             setTimeout(() => window.location.href='index.html', 2000);
             return;
        }

        // Links Update
        const smartBtn = document.getElementById('smart-route-btn');
        if(smartBtn) smartBtn.href = `edit-trip.html?id=${tripId}`;
        document.getElementById('back-btn').onclick = () => window.location.href = `trip.html?id=${tripId}`;

        // Load Maps async
        loadGoogleMaps().catch(e => console.warn('Maps API load issue', e));

        setupEvents();

        // Auth Listener
        onAuthStateChanged(auth, async (user) => {
            if(!user) { window.location.href = 'login.html'; return; }
            currentUser = user;
            
            const name = user.displayName || user.email.split('@')[0];
            document.getElementById('auth-container').innerHTML = `<span class="text-slate-700">×”×™×™, ${name}</span>`;
            document.getElementById('auth-display-sidebar').textContent = user.email;
            
            document.getElementById('sign-out-btn-sidebar').onclick = () => signOut(auth);

            // Fetch Data
            try {
                // Trip Info
                const tripSnap = await getDoc(doc(db, 'trips', tripId));
                if(!tripSnap.exists()) throw new Error('Trip not found');
                tripData = tripSnap.data();
                
                // Permission Check
                if(!tripData.editors?.includes(user.uid) && tripData.owner !== user.uid) {
                    throw new Error('No permission');
                }

                els.tripTitle.textContent = tripData.name;
                siteData.destinations = tripData.destinations?.map(d => d.nameHe || d.name) || [];

                // Custom Settings
                const settingsSnap = await getDoc(settingsDocRef);
                if(settingsSnap.exists()) {
                    const d = settingsSnap.data();
                    if(d.placeTypes) siteData.customPlaceTypes = d.placeTypes;
                }

                // Render Sidebar Menu
                const menu = document.getElementById('main-menu');
                tripData.destinations.forEach(d => {
                    const div = document.createElement('div');
                    const dates = d.dates ? `<div class="text-xs text-slate-400 mt-1">${d.dates}</div>` : '';
                    div.innerHTML = `
                        <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 hover:bg-white hover:shadow-md transition cursor-pointer" onclick="location.href='daily-schedule.html?id=${tripId}'">
                            <div class="font-bold text-slate-700">${d.nameHe || d.name}</div>
                            ${dates}
                        </div>`;
                    menu.appendChild(div);
                });

                // Listen to items
                onSnapshot(query(collection(db, 'trips', tripId, 'places'), orderBy('createdAt', 'desc')), (snap) => {
                    allItems = snap.docs.map(d => ({id: d.id, ...d.data()}));
                    renderItems();
                    
                    if(isInitialLoad) {
                        isInitialLoad = false;
                        els.loader.style.opacity = '0';
                        els.mainContent.style.opacity = '1';
                        setTimeout(() => els.loader.remove(), 600);
                    }
                });

            } catch(e) {
                console.error(e);
                showAlert(e.message === 'No permission' ? '××™×Ÿ ×œ×š ×”×¨×©××” ×œ×˜×™×•×œ ×–×”' : '×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×');
            }
        });
    })();
  </script>
</body>
</html>