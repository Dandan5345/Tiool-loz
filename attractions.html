<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
Â  <meta charset="UTF-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
Â  <title>××¡×¢ ×—×œ×•××•×ª ğŸ—½ ××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</title>
Â  <link rel="manifest" href="manifest.json" />
Â  <script src="https://cdn.tailwindcss.com"></script>
Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
Â  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet" />

Â  <style>
Â  Â  body { font-family: 'Assistant', sans-serif; }
Â  Â  #sidebar { transition: transform 0.3s ease-in-out; }
Â  Â  .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
Â  Â  .submenu.open { max-height: 1200px; }
Â  Â  .form-input, .form-select, .form-textarea { transition: all 0.2s ease-in-out; border-radius: 0.5rem; border: 1px solid #cbd5e1; }
Â  Â  .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: #38bdf8; box-shadow: 0 0 0 2px #38bdf840; outline: none; }
Â  Â Â 
Â  Â  /* Animations */
Â  Â  .modal-step { display: none; }
Â  Â  .modal-step.active { display: block; animation: fadeIn 0.5s; }
Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }

Â  Â  #map-preview, #details-map { height: 220px; border-radius: 0.75rem; background-color: #e2e8f0; }
Â  Â  details > summary { list-style: none; cursor: pointer; }
Â  Â  details > summary::-webkit-details-marker { display: none; }
Â  Â  .chevron-icon { transition: transform 0.3s ease-out; }
Â  Â  details[open] > summary .chevron-icon { transform: rotate(180deg); }
Â  Â  .step-indicator { transition: all 0.4s ease-in-out; }

Â  Â  /* Item Card Styling */
Â  Â  .item-card {Â 
Â  Â  Â  cursor: pointer;Â 
Â  Â  Â  transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
Â  Â  }
Â  Â  .item-card-anim {
Â  Â  Â  animation: fadeInUp 0.5s both;
Â  Â  }

Â  Â  /* Initial Loader */
Â  Â  #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity 0.5s ease-out; }
Â  Â  .plane-spinner { animation: spin 2s linear infinite; }

Â  Â  /* Section Loader */
Â  Â  .section-loader { position: absolute; inset: 0; background-color: rgba(241,245,249,0.8); z-index: 20; display: flex; align-items: center; justify-content: center; border-radius: 1rem; }

Â  Â  /* Custom Autocomplete dropdown styling */
Â  Â  .ac-wrapper { position: relative; }
Â  Â  .ac-list {
Â  Â  Â  position: absolute; top: 100%; right: 0; left: 0; z-index: 1050;
Â  Â  Â  background: #fff; border: 1px solid #e5e7eb; border-radius: 0.5rem;
Â  Â  Â  margin-top: 0.25rem; max-height: 260px; overflow-y: auto; box-shadow: 0 10px 20px rgba(0,0,0,0.08);
Â  Â  }
Â  Â  .ac-item { padding: 0.75rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; }
Â  Â  .ac-item:hover { background: #f1f5f9; }
Â  Â  .ac-item-icon { color: #94a3b8; }
Â  Â  .ac-item-main { font-weight: 600; }
Â  Â  .ac-item-secondary { font-size: 0.875rem; color: #64748b; }
Â  Â Â 
Â  Â  .rating-stars { color: #f59e0b; }
Â  </style>
</head>
<body class="bg-slate-100">
Â  <div id="initial-loader">
Â  Â  <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
Â  Â  <div class="fixed inset-0 z-0 bg-black/50"></div>
Â  Â  <div class="text-white text-center relative z-10">
Â  Â  Â  <i class="fas fa-plane-departure fa-4x plane-spinner mb-4"></i>
Â  Â  Â  <p class="text-2xl font-bold">××ª×—×‘×¨×™× ×œ××¡×¢...</p>
Â  Â  </div>
Â  </div>

Â  <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
Â  <div class="fixed inset-0 z-0 bg-black/50"></div>

Â  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
Â  Â  <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
Â  Â  Â  <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
Â  Â  Â  <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
Â  Â  </div>
Â  Â  <nav id="main-menu" class="p-4 space-y-2"></nav>
Â  </aside>
Â  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

Â  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
Â  Â  <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
Â  Â  Â  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
Â  Â  Â  Â  <div class="flex items-center justify-between h-16">
Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  <button id="back-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×”">
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-arrow-right fa-lg"></i>
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <h1 class="text-xl font-bold text-slate-800">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</h1>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  <div id="auth-container" class="flex items-center"></div>
Â  Â  Â  Â  Â  Â  <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </header>

Â  Â  <div id="trip-banner" class="bg-white/70 backdrop-blur-md border-b">
Â  Â  Â  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
Â  Â  Â  Â  <p id="trip-title-line" class="py-3 text-center text-slate-700 font-bold">
Â  Â  Â  Â  Â  ××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª ×œ×˜×™×•×œ - ×˜×•×¢×Ÿ...
Â  Â  Â  Â  </p>
Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <main class="p-4 sm:p-6 lg:p-8">
Â  Â  Â  <div class="max-w-7xl mx-auto">
Â  Â  Â  Â  <div class="text-center mb-12">
Â  Â  Â  Â  Â  <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">×ª×—× ×•×ª ×‘××¡×¢ âœ¨</h2>
Â  Â  Â  Â  Â  <p class="mt-4 text-lg text-slate-200 max-w-2xl mx-auto">×”×‘× ×§ ×”××¨×›×–×™ ×©×œ× ×• ×œ×”××œ×¦×•×ª, ×ª×’×œ×™×•×ª ×•××§×•××•×ª ×©××¡×•×¨ ×œ×¤×¡×¤×¡.</p>
Â  Â  Â  Â  Â  <div class="mt-8 flex justify-center items-center gap-4 flex-wrap">
Â  Â  Â  Â  Â  Â  <a id="smart-route-btn" href="#" class="bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-magic-wand-sparkles mr-2"></i> ×‘× ×™×™×ª ××¡×œ×•×œ ×—×›×
Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  <button id="open-modal-btn" class="bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-plus mr-2"></i> ×”×•×¡×¤×ª ××§×•×
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  <button id="get-location-btn" class="bg-white/20 backdrop-blur-sm text-white font-semibold py-3 px-6 rounded-full shadow-md hover:bg-white/40 transition-all transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-location-arrow mr-2"></i> ×”×¤×¢×œ ×©×™×¨×•×ª×™ ××™×§×•×
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div id="items-container" class="space-y-8">
Â  Â  Â  Â  Â  <p id="loading-message" class="text-center text-white bg-black/20 p-4 rounded-lg">×˜×•×¢×Ÿ ×”××œ×¦×•×ª...</p>
Â  Â  Â  Â  </div>
Â  Â  Â  </div>
Â  Â  </main>
Â  </div>
Â Â 
Â  <!-- Modals -->
Â  <div id="item-modal" class="fixed inset-0 bg-black/60 z-40 hidden items-center justify-center p-4">
Â  Â  <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[95vh] flex flex-col">
Â  Â  Â  <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
Â  Â  Â  Â  <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ××§×•× ×—×“×©</h3>
Â  Â  Â  Â  <button id="modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
Â  Â  Â  </div>
Â  Â  Â  <div class="w-full bg-slate-200 h-2.5">
Â  Â  Â  Â  <div id="step-progress-bar" class="bg-blue-500 h-2.5 rounded-r-full transition-all duration-500" style="width:0%;"></div>
Â  Â  Â  </div>
Â  Â  Â  <form id="item-form" class="flex-grow overflow-y-auto p-6 space-y-6">
Â  Â  Â  Â  <div id="step-1" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-2" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-3" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-4" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-5" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-6" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-7" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-8" class="modal-step"></div>
Â  Â  Â  Â  <div id="step-9" class="modal-step"></div>
Â  Â  Â  </form>
Â  Â  Â  <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
Â  Â  Â  Â  <button type="button" id="modal-back-btn" class="py-2 px-5 rounded-lg hover:bg-slate-200 transition hidden font-semibold">××—×•×¨×”</button>
Â  Â  Â  Â  <div class="flex-grow text-center"><div id="modal-error-message" class="text-red-500 text-sm font-bold h-5"></div></div>
Â  Â  Â  Â  <div id="modal-steps-indicator" class="text-sm text-slate-500 font-semibold mx-4"></div>
Â  Â  Â  Â  <button type="button" id="modal-next-btn" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
Â  Â  Â  Â  <button type="submit" form="item-form" id="modal-finish-btn" class="py-2 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition hidden">×”×•×¡×£ ×œ×“×£</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="details-modal" class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4">
Â  Â  <div id="details-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col relative"></div>
Â  </div>

Â  <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center">
Â  Â  <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full">
Â  Â  Â  <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
Â  Â  Â  <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§?</h3>
Â  Â  Â  <p id="delete-modal-text" class="text-slate-600 mb-6">×¤×¢×•×œ×” ×–×• ×”×™× ×‘×œ×ª×™ ×”×¤×™×›×”.</p>
Â  Â  Â  <div class="flex justify-center gap-4">
Â  Â  Â  Â  <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
Â  Â  Â  Â  <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>
Â Â 
Â  <div id="alert-modal" class="fixed inset-0 bg-black/60 z-[90] hidden items-center justify-center p-4">
Â  Â  <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full animate-fadeIn">
Â  Â  Â  <h3 id="alert-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×•×“×¢×”</h3>
Â  Â  Â  <p id="alert-modal-text" class="text-slate-600 mb-6"></p>
Â  Â  Â  <button id="alert-modal-ok" class="py-2 px-8 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 w-full">××™×©×•×¨</button>
Â  Â  </div>
Â  </div>

Â  <div id="navigation-choice-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center p-4">
Â  Â  <div class="bg-white rounded-2xl shadow-2xl p-6 text-center max-w-sm w-full relative">
Â  Â  Â  <button id="navigation-modal-close" class="absolute top-3 right-3 w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 transition-colors"><i class="fas fa-times"></i></button>
Â  Â  Â  <h3 class="text-xl font-bold text-slate-800 mb-6">×‘××™×–×• ××¤×œ×™×§×¦×™×” ×œ× ×•×•×˜?</h3>
Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  <a id="nav-link-google" href="#" target="_blank" class="block w-full text-center bg-blue-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-600 transition"><i class="fa-brands fa-google mr-2"></i>Google Maps</a>
Â  Â  Â  Â  <a id="nav-link-waze" href="#" target="_blank" class="block w-full text-center bg-cyan-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-cyan-600 transition"><i class="fa-brands fa-waze mr-2"></i>Waze</a>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>


Â  <script type="module">
Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
Â  Â  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
Â  Â  import { getFirestore, doc, getDoc, collection, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, updateDoc, setDoc, arrayUnion, orderBy, enableIndexedDbPersistence, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

Â  Â  // ---------- Firebase Configuration ----------
Â  Â  // For security, replace these with your actual Firebase project configuration.
Â  Â  // It's recommended to manage these keys using environment variables in a real application.
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
Â  Â  Â  authDomain: "tiool-loz.firebaseapp.com",
Â  Â  Â  projectId: "tiool-loz",
Â  Â  Â  storageBucket: "tiool-loz.appspot.com",
Â  Â  Â  messagingSenderId: "226069823505",
Â  Â  Â  appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
Â  Â  };
Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  const auth = getAuth(app);
Â  Â  const db = getFirestore(app);
Â  Â Â 
Â  Â  enableIndexedDbPersistence(db).catch((err) => {
Â  Â  Â  if (err.code === 'failed-precondition') console.warn("Persistence × ×›×©×œ â€“ ×™×© ×™×•×ª×¨ ××“×™ ×˜××‘×™× ×¤×ª×•×—×™×.");
Â  Â  Â  else if (err.code === 'unimplemented') console.warn("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘Ö¾Persistence.");
Â  Â  });

Â  Â  // ---------- Global State ----------
Â  Â  let currentUser = null;
Â  Â  let tripId = null;
Â  Â  let tripData = null;
Â  Â  let tripHotels = [];
Â  Â  let allItems = [];
Â  Â  let activeFilters = {};
Â  Â  let isInitialLoad = true;
Â  Â  let currentModalStep = 1;
Â  Â  let totalModalSteps = 1;
Â  Â  let editingItemId = null;
Â  Â  let isRestaurant = false;
Â  Â  let userLocation = null;

Â  Â  // ---------- Google Maps State & API Key ----------
Â  Â  // For security, it's recommended to manage API keys using environment variables.
Â  Â  const GOOGLE_MAPS_API_KEY = "AIzaSyAz7QZ2CBpCK_aOVbkqQLjfMRG5taaFs8c";
Â  Â  let gmapsApiLoaded = false;
Â  Â  let gmaps_addEditMap = null, gmaps_addEditMarker = null;
Â  Â  let gmaps_detailsMap = null, gmaps_detailsMarker = null;
Â  Â  let gmaps_autocompleteService = null, gmaps_placesService = null;
Â  Â  let selectedGooglePlaceDetails = null;

Â  Â  // ---------- Site Data (Static & Dynamic) ----------
Â  Â  const settingsDocRef = doc(db, 'app_settings', 'custom_types');
Â  Â  const siteData = {
Â  Â  Â  destinations: [],
Â  Â  Â  destinationEmojis: {},
Â  Â  Â  basePlaceTypes: ["××¡×¢×“×”/××•×›×œ","×¡×•×¤×¨","××•×–×™××•×Ÿ","×§× ×™×•×Ÿ/××¨×›×– ×§× ×™×•×ª","××˜×¨×§×¦×™×”","×—×•×£","×¡×™×•×¨"],
Â  Â  Â  customPlaceTypes: [],
Â  Â  Â  get placeTypes() { return [...this.basePlaceTypes, ...this.customPlaceTypes]; },
Â  Â  Â  baseFoodTypes: { "××™×˜×œ×§×™":"ğŸ","×—×œ×‘×™":"ğŸ§€","×‘×©×¨×™":"ğŸ¥©","×¦××—×•× ×™":"ğŸ¥—","××¡×™×™×ª×™":"ğŸœ","×©×•×•××¨××”":"ğŸ¥™","×¤×™×¦×”":"ğŸ•","×”××‘×•×¨×’×¨":"ğŸ”","×‘×™×ª ×§×¤×”":"â˜•" },
Â  Â  Â  customFoodTypes: {},
Â  Â  Â  get foodTypes() { return {...this.baseFoodTypes, ...this.customFoodTypes, "××—×¨":"ğŸ´"}; },
Â  Â  Â  placeTypeEmojis: { "××¡×¢×“×”/××•×›×œ":"ğŸ”","×¡×•×¤×¨":"ğŸ›’","××•×–×™××•×Ÿ":"ğŸ›ï¸","×§× ×™×•×Ÿ/××¨×›×– ×§× ×™×•×ª":"ğŸ›ï¸","××˜×¨×§×¦×™×”":"ğŸ¢","×—×•×£":"ğŸ–ï¸","×¡×™×•×¨":"ğŸš¶â€â™‚ï¸" }
Â  Â  };

Â  Â  // ---------- UI Element References ----------
Â  Â  const initialLoader = document.getElementById('initial-loader');
Â  Â  const mainContent = document.getElementById('main-content');
Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  const hamburgerBtn = document.getElementById('hamburger-btn');
Â  Â  const closeSidebarBtn = document.getElementById('close-sidebar-btn');
Â  Â  const overlay = document.getElementById('overlay');
Â  Â  const mainMenu = document.getElementById('main-menu');
Â  Â  const backBtn = document.getElementById('back-btn');

Â  Â  const modal = document.getElementById('item-modal');
Â  Â  const form = document.getElementById('item-form');
Â  Â  const openModalBtn = document.getElementById('open-modal-btn');
Â  Â  const closeModalBtn = document.getElementById('modal-close-btn');
Â  Â  const nextBtn = document.getElementById('modal-next-btn');
Â  Â  const backStepBtn = document.getElementById('modal-back-btn');
Â  Â  const finishBtn = document.getElementById('modal-finish-btn');
Â  Â  const stepsIndicator = document.getElementById('modal-steps-indicator');
Â  Â  const progressBar = document.getElementById('step-progress-bar');
Â  Â  const modalError = document.getElementById('modal-error-message');

Â  Â  const itemsContainer = document.getElementById('items-container');
Â  Â  const loadingMessage = document.getElementById('loading-message');
Â  Â  const getLocationBtn = document.getElementById('get-location-btn');
Â  Â  const detailsModal = document.getElementById('details-modal');
Â  Â  const deleteModal = document.getElementById('delete-confirm-modal');
Â  Â  const authContainer = document.getElementById('auth-container');
Â  Â  const tripTitleLine = document.getElementById('trip-title-line');
Â  Â  const navigationModal = document.getElementById('navigation-choice-modal');
Â  Â  const closeNavigationModalBtn = document.getElementById('navigation-modal-close');

Â  Â  // ---------- Utility Functions ----------
Â  Â  function debounce(func, delay) {
Â  Â  Â  let timeout;
Â  Â  Â  return function(...args) {
Â  Â  Â  Â  const context = this;
Â  Â  Â  Â  clearTimeout(timeout);
Â  Â  Â  Â  timeout = setTimeout(() => func.apply(context, args), delay);
Â  Â  Â  };
Â  Â  }

Â  Â  function toggleSidebar() {
Â  Â  Â  sidebar.classList.toggle('translate-x-full');
Â  Â  Â  overlay.classList.toggle('hidden');
Â  Â  }
Â  Â Â 
Â  Â  function showAlert(message, title = '×”×•×“×¢×”') {
Â  Â  Â  Â  const alertModal = document.getElementById('alert-modal');
Â  Â  Â  Â  document.getElementById('alert-modal-title').textContent = title;
Â  Â  Â  Â  document.getElementById('alert-modal-text').innerHTML = message;
Â  Â  Â  Â  alertModal.classList.remove('hidden');
Â  Â  Â  Â  alertModal.classList.add('flex');

Â  Â  Â  Â  const okBtn = document.getElementById('alert-modal-ok');
Â  Â  Â  Â  const closeFn = () => {
Â  Â  Â  Â  Â  Â  alertModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  alertModal.classList.remove('flex');
Â  Â  Â  Â  };
Â  Â  Â  Â  okBtn.addEventListener('click', closeFn, { once: true });
Â  Â  Â  }

Â  Â  function calculateDistanceInMeters(loc1, loc2) {
Â  Â  Â  if (!loc1 || !loc2) return Infinity;
Â  Â  Â  const R = 6371e3;
Â  Â  Â  const phi1 = loc1.lat * Math.PI / 180;
Â  Â  Â  const phi2 = loc2.lat * Math.PI / 180;
Â  Â  Â  const dPhi = (loc2.lat - loc1.lat) * Math.PI / 180;
Â  Â  Â  const dLam = (loc2.lng - loc1.lng) * Math.PI / 180;
Â  Â  Â  const a = Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLam/2)**2;
Â  Â  Â  return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
Â  Â  }

Â  Â  async function handleGetLocation() {
Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  if (!navigator.geolocation) {Â 
Â  Â  Â  Â  Â  showAlert("×“×¤×“×¤×Ÿ ×–×” ××™× ×• ×ª×•××š ×‘×©×™×¨×•×ª×™ ××™×§×•×.");Â 
Â  Â  Â  Â  Â  return reject();Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  getLocationBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ×××ª×¨ ××™×§×•×...`;
Â  Â  Â  Â  getLocationBtn.disabled = true;
Â  Â  Â  Â  navigator.geolocation.getCurrentPosition(
Â  Â  Â  Â  Â  (pos) => {
Â  Â  Â  Â  Â  Â  userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
Â  Â  Â  Â  Â  Â  getLocationBtn.innerHTML = `<i class="fas fa-check-circle mr-2"></i> ××™×§×•× ×¢×•×“×›×Ÿ`;
Â  Â  Â  Â  Â  Â  getLocationBtn.disabled = false;
Â  Â  Â  Â  Â  Â  resolve(userLocation);
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  (err) => {
Â  Â  Â  Â  Â  Â  console.error(err);
Â  Â  Â  Â  Â  Â  getLocationBtn.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ×”×¤×¢×œ×ª ××™×§×•× × ×›×©×œ×”`;
Â  Â  Â  Â  Â  Â  getLocationBtn.disabled = false;
Â  Â  Â  Â  Â  Â  showAlert("×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×™×© ×œ×•×•×“× ×©×”×¨×©××•×ª ×”××™×§×•× ×¤×¢×™×œ×•×ª ×¢×‘×•×¨ ×”××ª×¨.");
Â  Â  Â  Â  Â  Â  reject(err);
Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  { enableHighAccuracy: true }
Â  Â  Â  Â  );
Â  Â  Â  });
Â  Â  }

Â  Â  function renderStars(rating) {
Â  Â  Â  if (!rating || typeof rating !== 'number' || rating <= 0) return '';
Â  Â  Â  let starsHtml = `<div class="rating-stars flex items-center gap-1" title="×“×™×¨×•×’: ${rating.toFixed(1)} ××ª×•×š 5">`;
Â  Â  Â  const fullStars = Math.floor(rating);
Â  Â  Â  const halfStar = rating % 1 >= 0.4;
Â  Â  Â  const emptyStars = 5 - fullStars - (halfStar ? 1 : 0);

Â  Â  Â  for(let i = 0; i < fullStars; i++) starsHtml += '<i class="fas fa-star"></i>';
Â  Â  Â  if(halfStar) starsHtml += '<i class="fas fa-star-half-alt"></i>';
Â  Â  Â  for(let i = 0; i < emptyStars; i++) starsHtml += '<i class="far fa-star"></i>';
Â  Â  Â Â 
Â  Â  Â  starsHtml += `<span class="text-xs text-slate-500 font-semibold ml-1">(${rating.toFixed(1)})</span></div>`;
Â  Â  Â  return starsHtml;
Â  Â  }

Â  Â  // ---------- Google Maps API Functions ----------
Â  Â  function loadGoogleMapsApi() {
Â  Â  Â  if (window.google && window.google.maps) {
Â  Â  Â  Â  gmapsApiLoaded = true;
Â  Â  Â  Â  return Promise.resolve();
Â  Â  Â  }
Â  Â  Â  return new Promise((resolve, reject) => {
Â  Â  Â  Â  const script = document.createElement('script');
Â  Â  Â  Â  script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,marker&language=iw&loading=async`;
Â  Â  Â  Â  script.onload = () => { gmapsApiLoaded = true; resolve(); };
Â  Â  Â  Â  script.onerror = () => reject(new Error('Google Maps script failed to load.'));
Â  Â  Â  Â  document.head.appendChild(script);
Â  Â  Â  });
Â  Â  }

Â  Â  function gmaps_initAddEditMap(location = { lat: 40.7128, lng: -74.0060 }) {
Â  Â  Â  const mapDiv = document.getElementById('map-preview');
Â  Â  Â  if (!mapDiv || !gmapsApiLoaded) return;
Â  Â  Â  if (!gmaps_addEditMap) {
Â  Â  Â  Â  gmaps_addEditMap = new google.maps.Map(mapDiv, {
Â  Â  Â  Â  Â  center: location, zoom: 15, mapTypeControl: false, streetViewControl: false,
Â  Â  Â  Â  });
Â  Â  Â  Â  gmaps_addEditMarker = new google.maps.Marker({
Â  Â  Â  Â  Â  position: location, map: gmaps_addEditMap, draggable: true,
Â  Â  Â  Â  });
Â  Â  Â  Â  gmaps_addEditMarker.addListener('dragend', () => {
Â  Â  Â  Â  Â  const pos = gmaps_addEditMarker.getPosition();
Â  Â  Â  Â  Â  if (!selectedGooglePlaceDetails) selectedGooglePlaceDetails = {};
Â  Â  Â  Â  Â  selectedGooglePlaceDetails.coords = { lat: pos.lat(), lng: pos.lng() };
Â  Â  Â  Â  });
Â  Â  Â  Â  // ×©×™×¨×•×ª×™ ×’×•×’×œ ×××•×ª×—×œ×™× ×›×¢×ª ×‘-initPage
Â  Â  Â  } else {
Â  Â  Â  Â  gmaps_addEditMap.setCenter(location);
Â  Â  Â  Â  gmaps_addEditMap.setZoom(15);
Â  Â  Â  Â  gmaps_addEditMarker.setPosition(location);
Â  Â  Â  }
Â  Â  }

Â  Â  function gmaps_initDetailsMap(coords) {
Â  Â  Â  const mapDiv = document.getElementById('details-map');
Â  Â  Â  if (!mapDiv || !gmapsApiLoaded) return;
Â  Â  Â  if (!gmaps_detailsMap) {
Â  Â  Â  Â  gmaps_detailsMap = new google.maps.Map(mapDiv, { center: coords, zoom: 15, mapTypeControl: false });
Â  Â  Â  Â  gmaps_detailsMarker = new google.maps.Marker({ position: coords, map: gmaps_detailsMap });
Â  Â  Â  } else {
Â  Â  Â  Â  gmaps_detailsMap.setCenter(coords);
Â  Â  Â  Â  gmaps_detailsMarker.setPosition(coords);
Â  Â  Â  }
Â  Â  }
Â  Â Â 
Â  Â  function initGooglePlacesCustomAutocomplete(inputElement, onSelectCallback) {
Â  Â  Â  if (!gmapsApiLoaded || !inputElement || !gmaps_autocompleteService || !gmaps_placesService) {
Â  Â  Â  Â  Â  console.warn('Autocomplete init failed. Services not ready.');
Â  Â  Â  Â  Â  return;
Â  Â  Â  }

Â  Â  Â  const wrapper = inputElement.closest('.ac-wrapper');
Â  Â  Â  if (!wrapper) return;

Â  Â  Â  let list = wrapper.querySelector('.ac-list');
Â  Â  Â  if (!list) {
Â  Â  Â  Â  list = document.createElement('div');
Â  Â  Â  Â  list.className = 'ac-list hidden';
Â  Â  Â  Â  wrapper.appendChild(list);
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const handleSearch = debounce(async (query) => {
Â  Â  Â  Â  if (query.length < 2) {
Â  Â  Â  Â  Â  list.innerHTML = '';
Â  Â  Â  Â  Â  list.classList.add('hidden');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  gmaps_autocompleteService.getPlacePredictions({ input: query }, (predictions, status) => {
Â  Â  Â  Â  Â  list.innerHTML = '';
Â  Â  Â  Â  Â  if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) {
Â  Â  Â  Â  Â  Â  list.classList.add('hidden');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  predictions.forEach(prediction => {
Â  Â  Â  Â  Â  Â  const item = document.createElement('div');
Â  Â  Â  Â  Â  Â  item.className = 'ac-item';
Â  Â  Â  Â  Â  Â  item.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-map-marker-alt ac-item-icon"></i>
Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ac-item-main">${prediction.structured_formatting.main_text}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="ac-item-secondary">${prediction.structured_formatting.secondary_text}</div>
Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  item.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  list.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  inputElement.value = prediction.description;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  const request = {
Â  Â  Â  Â  Â  Â  Â  Â  placeId: prediction.place_id,
Â  Â  Â  Â  Â  Â  Â  Â  fields: ["name", "formatted_address", "geometry", "website", "opening_hours", "photos", "types", "rating"]
Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  gmaps_placesService.getDetails(request, (place, status) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (status === google.maps.places.PlacesServiceStatus.OK && place) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  const details = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // *** FIX: ×©×•××¨×™× placeId ***
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeId: prediction.place_id,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  name: place.name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location: place.formatted_address,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  coords: { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  website: place.website || '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hours: place.opening_hours ? place.opening_hours.weekday_text.join('\n') : '',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // *** FIX: ×©×•××¨×™× photo_reference ×‘××§×•× URL ×–×× ×™ ***
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  photos: place.photos ? place.photos.slice(0, 3).map(p => p.photo_reference) : [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  types: place.types || [],
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  rating: place.rating || null
Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  if (onSelectCallback) onSelectCallback(details);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  list.appendChild(item);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  list.classList.remove('hidden');
Â  Â  Â  Â  });
Â  Â  Â  }, 500);

Â  Â  Â  inputElement.addEventListener('input', () => {
Â  Â  Â  Â  handleSearch(inputElement.value);
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  document.addEventListener('click', (e) => {
Â  Â  Â  Â  if (!wrapper.contains(e.target)) list.classList.add('hidden');
Â  Â  Â  });
Â  Â  }

Â  Â  // ---------- Custom Types & Settings ----------
Â  Â  async function loadCustomSettings() {
Â  Â  Â  try {
Â  Â  Â  Â  const snap = await getDoc(settingsDocRef);
Â  Â  Â  Â  if (snap.exists()) {
Â  Â  Â  Â  Â  const data = snap.data();
Â  Â  Â  Â  Â  siteData.customPlaceTypes = data.placeTypes || [];
Â  Â  Â  Â  Â  if (data.foodTypes) data.foodTypes.forEach(t => { siteData.customFoodTypes[t] = 'ğŸ´'; });
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  await setDoc(settingsDocRef, { placeTypes: [], foodTypes: [] });
Â  Â  Â  Â  }
Â  Â  Â  } catch (e) { console.error('loadCustomSettings', e); }
Â  Â  }

Â  Â  // ---------- Sidebar Menu Generation ----------
Â  Â  function buildMenuFromTrip() {
Â  Â  Â  mainMenu.innerHTML = '';
Â  Â  Â  if (!tripData?.destinations || !Array.isArray(tripData.destinations)) return;
Â  Â  Â  siteData.destinations = tripData.destinations.map(d => d.nameHe || d.name || '×™×¢×“');
Â  Â  Â  tripData.destinations.forEach(dest => {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
Â  Â  Â  Â  btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down chevron-icon"></i>`;
Â  Â  Â  Â  const submenu = document.createElement('div');
Â  Â  Â  Â  submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
Â  Â  Â  Â  if (dest.dates) {
Â  Â  Â  Â  Â  generateDatesFromRange(dest.dates).forEach(dateStr => {
Â  Â  Â  Â  Â  Â  const link = document.createElement('a');
Â  Â  Â  Â  Â  Â  link.href = `daily-schedule.html?id=${tripId}&date=${encodeURIComponent(dateStr)}`;
Â  Â  Â  Â  Â  Â  link.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
Â  Â  Â  Â  Â  Â  link.textContent = `×œ×•"×– ×œ×™×•× ${dateStr}`;
Â  Â  Â  Â  Â  Â  submenu.appendChild(link);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  btn.onclick = () => { submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); };
line 802
Â  Â  Â  Â  div.append(btn, submenu);
Â  Â  Â  Â  mainMenu.appendChild(div);
Â  Â  Â  });
Â  Â  }

Â  Â  function generateDatesFromRange(rangeStr) {
Â  Â  Â  if (!rangeStr || !rangeStr.includes(' - ')) return [];
Â  Â  Â  const [startStr, endStr] = rangeStr.split(' - ');
Â  Â  Â  const [sd, sm, sy] = startStr.split('/').map(Number);
Â  Â  Â  const [ed, em, ey] = endStr.split('/').map(Number);
Â  Â  Â  const start = new Date(sy, sm-1, sd);
Â  Â  Â  const end = new Date(ey, em-1, ed);
Â  Â  Â  const out = [];
Â  Â  Â  for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
Â  Â  Â  Â  out.push(d.toLocaleDateString('he-IL', { day:'2-digit', month:'2-digit', year:'numeric' }));
Â  Â  Â  }
Â  Â  Â  return out;
Â  Â  }

Â  Â  // ---------- Modal UI Logic & State Management ----------
Â  Â  function showModalError(message) {
Â  Â  Â  modalError.textContent = message || '';
Â  Â  Â  if (message) setTimeout(() => { modalError.textContent = ''; }, 4000);
Â  Â  }

Â  Â  function openModalHandler(itemId = null) {
Â  Â  Â  editingItemId = itemId;
Â  Â  Â  selectedGooglePlaceDetails = null;
Â  Â  Â  form.reset();
Â  Â  Â  for (let i = 1; i <= 9; i++) {
Â  Â  Â  Â  const c = document.getElementById(`step-${i}`);
Â  Â  Â  Â  if (c) c.innerHTML = '';
Â  Â  Â  }
Â  Â  Â  const modalTitle = document.getElementById('modal-title');
Â  Â  Â  const finishButton = document.getElementById('modal-finish-btn');
Â  Â  Â Â 
Â  Â  Â  if (editingItemId) {
Â  Â  Â  Â  modalTitle.textContent = '×¢×¨×™×›×ª ××§×•×';
Â  Â  Â  Â  finishButton.textContent = '×©××•×¨ ×©×™× ×•×™×™×';
Â  Â  Â  Â  const item = allItems.find(i => i.id === editingItemId);
Â  Â  Â  Â  isRestaurant = item ? item.type === '××¡×¢×“×”/××•×›×œ' : false;
Â  Â  Â  } else {
Â  Â  Â  Â  modalTitle.textContent = '×”×•×¡×¤×ª ××§×•× ×—×“×©';
Â  Â  Â  Â  finishButton.textContent = '×”×•×¡×£ ×œ×“×£';
Â  Â  Â  Â  isRestaurant = false;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  currentModalStep = 1;
Â  Â  Â  updateModalView();
Â  Â  Â  modal.classList.remove('hidden');
Â  Â  Â  modal.classList.add('flex');
Â  Â  }

Â  Â  function closeModalHandler() {
Â  Â  Â  editingItemId = null;
Â  Â  Â  modal.classList.add('hidden');Â 
Â  Â  Â  modal.classList.remove('flex');
Â  Â  Â  showModalError('');
Â  Â  Â  gmaps_addEditMap = null;
Â  Â  Â  gmaps_addEditMarker = null;
Â  Â  }
Â  Â Â 
Â  Â  function updateModalView() {
Â  Â  Â  const itemTypeEl = document.getElementById('item-type');
Â  Â  Â  let currentType = '';
Â  Â  Â  if(itemTypeEl) {
Â  Â  Â  Â  currentType = itemTypeEl.value;
Â  Â  Â  } else if (editingItemId) {
Â  Â  Â  Â  const item = allItems.find(i => i.id === editingItemId);
Â  Â  Â  Â  if (item) currentType = item.type;
Â  Â  Â  }
Â  Â  Â  isRestaurant = currentType === '××¡×¢×“×”/××•×›×œ';

Â  Â  Â  const baseSteps = [1, 2, 3, 4, 5, 6, 7];
Â  Â  Â  const restaurantSteps = [8, 9];
Â  Â  Â  let steps = [...baseSteps];
Â  Â  Â  if (isRestaurant) steps.push(...restaurantSteps);
Â  Â  Â  steps.sort((a, b) => a - b);
Â  Â  Â  totalModalSteps = steps.length;

Â  Â  Â  document.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
Â  Â  Â  const actualStep = steps[currentModalStep - 1];
Â  Â  Â  const stepEl = document.getElementById(`step-${actualStep}`);
Â  Â  Â  if (stepEl) {
Â  Â  Â  Â  if (!stepEl.innerHTML.trim()) {
Â  Â  Â  Â  Â  generateStepContent(actualStep);
Â  Â  Â  Â  }
Â  Â  Â  Â  stepEl.classList.add('active');
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (actualStep === 4 && gmaps_addEditMap && gmaps_addEditMarker) {
Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  google.maps.event.trigger(gmaps_addEditMap, "resize");
Â  Â  Â  Â  Â  Â  gmaps_addEditMap.setCenter(gmaps_addEditMarker.getPosition());
Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  }
Â  Â  Â  }

Â  Â  Â  backStepBtn.classList.toggle('hidden', currentModalStep === 1);
Â  Â  Â  nextBtn.classList.toggle('hidden', currentModalStep === totalModalSteps);
Â  Â  Â  finishBtn.classList.toggle('hidden', currentModalStep !== totalModalSteps);
Â  Â  Â  stepsIndicator.textContent = `×©×œ×‘ ${currentModalStep} ××ª×•×š ${totalModalSteps}`;
Â  Â  Â  progressBar.style.width = `${(currentModalStep / totalModalSteps) * 100}%`;
Â  Â  }

Â  Â  function handleTypeChange() {
Â  Â  Â  const other = document.getElementById('item-type-other');
Â  Â  Â  const typeSelect = document.getElementById('item-type');
Â  Â  Â  if (other && typeSelect) {
Â  Â  Â  Â  Â  other.classList.toggle('hidden', typeSelect.value !== '××—×¨');
Â  Â  Â  }
Â  Â  Â  document.querySelectorAll('.modal-step').forEach((el) => {
Â  Â  Â  Â  const stepNum = parseInt(el.id.split('-')[1]);
Â  Â  Â  Â  if (stepNum > currentModalStep) el.innerHTML = '';
Â  Â  Â  });
Â  Â  Â  updateModalView();
Â  Â  }

Â  Â  function handleFoodTypeChange() {
Â  Â  Â  const other = document.getElementById('item-food-type-other');
Â  Â  Â  const foodTypeSelect = document.getElementById('item-food-type');
Â  Â  Â  if (other && foodTypeSelect) {
Â  Â  Â  Â  Â  other.classList.toggle('hidden', foodTypeSelect.value !== '××—×¨');
Â  Â  Â  }
Â  Â  }

Â  Â  function createLocationHtml() {
Â  Â  Â  return `
Â  Â  Â  Â  <label class="flex items-center gap-3 text-lg font-bold text-slate-700 mb-3">
Â  Â  Â  Â  Â  <i class="fa-brands fa-google text-slate-400"></i> ×—×™×¤×•×© ××§×•× (Google) <span class="text-red-500">*</span>
Â  Â  Â  Â  </label>
Â  Â  Â  Â  <div class="ac-wrapper">
Â  Â  Â  Â  Â  <input type="text" id="item-location-search-google" class="form-input w-full p-3" placeholder="×”×§×œ×“ ×©× ××§×•× ××• ×›×ª×•×‘×ª...">
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div id="map-preview" class="mt-3"></div>
Â  Â  Â  Â  <div id="google-place-filled-msg" class="text-sm text-green-600 bg-green-50 p-3 rounded-md mt-3 hidden">
Â  Â  Â  Â  Â  <i class="fa-solid fa-check-circle mr-2"></i> ×¤×¨×˜×™ ×”××§×•× ××•×œ××• ×-Google. × ×™×ª×Ÿ ×œ×¢×¨×•×š ×•×œ×”××©×™×š.
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="mt-4 space-y-3 text-sm">
Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="font-semibold text-slate-600">×›×ª×•×‘×ª</label>
Â  Â  Â  Â  Â  Â  Â  <input type="text" id="item-location" class="form-input w-full p-2 mt-1 bg-slate-100" readonly>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="font-semibold text-slate-600">×©×¢×•×ª ×¤×ª×™×—×”</label>
Â  Â  Â  Â  Â  Â  Â  <textarea id="item-hours" class="form-input w-full p-2 mt-1" placeholder="×œ××©×œ: ×©× ×™-×©×™×©×™ 10:00-18:00" rows="3"></textarea>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  <label class="font-semibold text-slate-600">××ª×¨ ××™× ×˜×¨× ×˜</label>
Â  Â  Â  Â  Â  Â  Â  <input type="url" id="item-link" class="form-input w-full p-2 mt-1" placeholder="https://...">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  }
Â  Â Â 
Â  Â  function generateStepContent(step) {
Â  Â  Â  const c = document.getElementById(`step-${step}`);
Â  Â  Â  if (!c) return;
Â  Â Â 
Â  Â  Â  const item = editingItemId ? allItems.find(i => i.id === editingItemId) : null;
Â  Â  Â  const label = "flex items-center gap-3 text-lg font-bold text-slate-700 mb-3";
Â  Â Â 
Â  Â  Â  switch(step) {
Â  Â  Â  Â  case 1:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-signature text-slate-400"></i>×©× ×”××§×•× <span class="text-red-500">*</span></label><input type="text" id="item-name" required class="form-input w-full p-3" placeholder="×œ×“×•×’××”: Top of the Rock">`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-name').value = item.name || '';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 2:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-map-pin text-slate-400"></i>×œ××™×–×” ×™×¢×“? <span class="text-red-500">*</span></label><select id="item-destination" required class="form-select w-full p-3">${siteData.destinations.map(d=>`<option value="${d}">ğŸ“ ${d}</option>`).join('')}</select>`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-destination').value = item.destination || '';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 3:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-shapes text-slate-400"></i>×¡×•×’ ×”××§×•× <span class="text-red-500">*</span></label><select id="item-type" required class="form-select w-full p-3">${[...siteData.placeTypes,"××—×¨"].map(o=>`<option value="${o}">${siteData.placeTypeEmojis[o]||'ğŸ“Œ'} ${o}</option>`).join('')}</select><input type="text" id="item-type-other" class="form-input w-full p-3 mt-3 hidden" placeholder="×”×’×“×¨ ×¡×•×’ ×—×“×©">`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-type').value = item.type || '';
Â  Â  Â  Â  Â  handleTypeChange(); // Call once to set initial view
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 4:
Â  Â  Â  Â  Â  c.innerHTML = createLocationHtml();
Â  Â  Â  Â  Â  const searchInput = c.querySelector('#item-location-search-google');
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (item) {
Â  Â  Â  Â  Â  Â  searchInput.value = item.location || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-location').value = item.location || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-hours').value = item.hours || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-link').value = item.link || '';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  gmaps_initAddEditMap(item?.coords);

Â  Â  Â  Â  Â  initGooglePlacesCustomAutocomplete(searchInput, (placeDetails) => {
Â  Â  Â  Â  Â  Â  document.getElementById('item-location').value = placeDetails.location || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-hours').value = placeDetails.hours || '';
Â  Â  Â  Â  Â  Â  document.getElementById('item-link').value = placeDetails.website || '';
Â  Â  Â  Â  Â  Â  const nameField = document.getElementById('item-name');
Â  Â  Â  Â  Â  Â  if (nameField && (!nameField.value || nameField.value.trim()==='')) {
Â  Â  Â  Â  Â  Â  Â  nameField.value = placeDetails.name;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  gmaps_initAddEditMap(placeDetails.coords);
Â  Â  Â  Â  Â  Â  selectedGooglePlaceDetails = placeDetails;
Â  Â  Â  Â  Â  Â  const msg = document.getElementById('google-place-filled-msg');
Â  Â  Â  Â  Â  Â  if (msg) msg.classList.remove('hidden');
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 5:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-calendar-check text-slate-400"></i>×¦×¨×™×š ×œ×”×–××™×Ÿ ××§×•×?</label><select id="item-reservation" class="form-select w-full p-3"><option value="×œ×">×œ×</option><option value="×›×Ÿ">×›×Ÿ</option><option value="××•××œ×¥">××•××œ×¥</option></select>`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-reservation').value = item.reservation || '×œ×';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 6:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-quote-left text-slate-400"></i>×¤×™×¨×•×˜ ×§×¦×¨ (××•×¤×¦×™×•× ×œ×™)</label><textarea id="item-short-description" class="form-textarea w-full p-3" rows="2" placeholder="××©×¤×˜ ××• ×©× ×™×™×..."></textarea>`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-short-description').value = item.shortDescription || '';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 7:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-pen-to-square text-slate-400"></i>×ª×™××•×¨ ××œ× (××•×¤×¦×™×•× ×œ×™)</label><textarea id="item-description" class="form-textarea w-full p-3" rows="4" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×, ×”××œ×¦×•×ª..."></textarea>`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-description').value = item.description || '';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 8:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-star-of-david text-slate-400"></i>×”×× ×”××¡×¢×“×” ×›×©×¨×”?</label><select id="item-kosher" class="form-select w-full p-3"><option value="×œ×">×œ×</option><option value="×›×Ÿ">×›×Ÿ</option></select>`;
Â  Â  Â  Â  Â  if(item) document.getElementById('item-kosher').value = item.isKosher || '×œ×';
Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  case 9:
Â  Â  Â  Â  Â  c.innerHTML = `<label class="${label}"><i class="fa-solid fa-utensils text-slate-400"></i>×¡×•×’ ××•×›×œ</label><select id="item-food-type" class="form-select w-full p-3">${Object.entries(siteData.foodTypes).map(([n,e])=>`<option value="${n}">${e} ${n}</option>`).join('')}</select><input type="text" id="item-food-type-other" class="form-input w-full p-3 mt-3 hidden" placeholder="×”×’×“×¨ ×¡×•×’ ××•×›×œ">`;
Â  Â  Â  Â  Â  if(item) {
Â  Â  Â  Â  Â  Â  const foodSel = document.getElementById('item-food-type');
Â  Â  Â  Â  Â  Â  const foodOther = document.getElementById('item-food-type-other');
Â  Â  Â  Â  Â  Â  if (siteData.foodTypes[item.foodType]) {
Â  Â  Â  Â  Â  Â  Â  foodSel.value = item.foodType;
Â  Â  Â  Â  Â  Â  } else if (item.foodType) {
Â  Â  Â  Â  Â  Â  Â  foodSel.value = '××—×¨';
Â  Â  Â  Â  Â  Â  Â  foodOther.value = item.foodType;
Â  Â  Â  Â  Â  Â  Â  foodOther.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  break;
Â  Â  Â  }
Â  Â  }


Â  Â  // ---------- Item Rendering Logic ----------
Â  Â  function renderAllItems() {
Â  Â  Â  if (!itemsContainer) return;
Â  Â  Â  if (allItems.length === 0 && !isInitialLoad) {
Â  Â  Â  Â  itemsContainer.innerHTML = `<div class="text-center p-16 bg-white/70 backdrop-blur-md rounded-2xl shadow-sm"><i class="fas fa-map-signs fa-4x text-slate-400 mb-6"></i><h3 class="text-2xl font-bold text-slate-700">×¢×“×™×™×Ÿ ××™×Ÿ ×”××œ×¦×•×ª...</h3><p class="text-slate-500 mt-2">×œ×—×¥ ×¢×œ "×”×•×¡×¤×ª ××§×•×" ×›×“×™ ×œ×™×¦×•×¨ ××ª ×”×¨××©×•×Ÿ.</p></div>`;
Â  Â  Â  Â  loadingMessage.style.display = 'none';
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  const preserved = {};
Â  Â  Â  document.querySelectorAll('#items-container details').forEach(d => { if (d.dataset.key) preserved[d.dataset.key]=d.open; });

Â  Â  Â  itemsContainer.innerHTML = ''; loadingMessage.style.display='none';

Â  Â  Â  const groupedByDest = allItems.reduce((acc, item) => {
Â  Â  Â  Â  const dest = item.destination || '×›×œ×œ×™';
Â  Â  Â  Â  (acc[dest] ||= []).push(item);
Â  Â  Â  Â  return acc;
Â  Â  Â  }, {});

Â  Â  Â  siteData.destinations.forEach(dest => {
Â  Â  Â  Â  if (!groupedByDest[dest]) return;
Â  Â  Â  Â Â 
Â  Â  Â  Â  const destSection = document.createElement('details');
Â  Â  Â  Â  destSection.className = "bg-white/70 backdrop-blur-md rounded-2xl shadow-lg overflow-hidden relative";
Â  Â  Â  Â  destSection.open = preserved[dest] || false;
Â  Â  Â  Â  destSection.dataset.key = dest;
Â  Â  Â  Â  destSection.innerHTML = `<summary class="text-2xl md:text-3xl font-bold text-slate-800 flex justify-between items-center p-5 hover:bg-white/30 transition"><span class="flex items-center gap-4">ğŸ“ ${dest}</span><i class="fa-solid fa-chevron-down chevron-icon"></i></summary>`;
Â  Â  Â  Â  const contentDiv = document.createElement('div');
Â  Â  Â  Â  contentDiv.className = 'p-4 space-y-6 bg-slate-50/70';

Â  Â  Â  Â  const byType = groupedByDest[dest].reduce((acc, item)=>{ (acc[item.type||'×›×œ×œ×™'] ||= []).push(item); return acc; }, {});
Â  Â  Â  Â  Object.keys(byType).sort().forEach(type => {
Â  Â  Â  Â  Â  if (!activeFilters[dest]) activeFilters[dest] = {};
Â  Â  Â  Â  Â  if (!activeFilters[dest][type]) {
Â  Â  Â  Â  Â  Â  activeFilters[dest][type] = { kosher: false, foodType: '', sortBy: 'default', sortPoint: null, sortMeta: {} };
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  const filterState = activeFilters[dest][type];
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  const typeSection = document.createElement('details');
Â  Â  Â  Â  Â  typeSection.className = "bg-white/80 p-4 rounded-xl shadow-md";
Â  Â  Â  Â  Â  typeSection.open = preserved[`${dest}-${type}`] || false;
Â  Â  Â  Â  Â  typeSection.dataset.key = `${dest}-${type}`;
Â  Â  Â  Â  Â  const typeIcon = siteData.placeTypeEmojis[type] || 'ğŸ“Œ';
Â  Â  Â  Â  Â  typeSection.innerHTML = `<summary class="text-lg md:text-xl font-semibold text-slate-700 flex justify-between items-center"><span>${typeIcon} ${type}</span><i class="fa-solid fa-chevron-down chevron-icon"></i></summary>`;

Â  Â  Â  Â  Â  const typeContent = document.createElement('div');
Â  Â  Â  Â  Â  typeContent.className = "mt-4 pt-4 border-t space-y-4";

Â  Â  Â  Â  Â  let itemsForType = [...byType[type]];

Â  Â  Â  Â  Â  const toolsId = `${dest.replace(/\s/g,'')}-${type.replace(/[\s/]/g,'')}`;
Â  Â  Â  Â  Â  let filterHtml = `<div class="local-filters bg-slate-100 p-3 rounded-lg space-y-3">`;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (type === '××¡×¢×“×”/××•×›×œ') {
Â  Â  Â  Â  Â  Â  const allFood = [...new Set(groupedByDest[dest].filter(i=>i.type==='××¡×¢×“×”/××•×›×œ').map(i=>i.foodType).filter(Boolean))];
Â  Â  Â  Â  Â  Â  filterHtml += `
Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-slate-600 text-sm">×¡×™× ×•×Ÿ:</span>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="kosher-filter-${toolsId}" data-destination="${dest}" data-type="${type}" class="local-filter-kosher h-4 w-4 rounded" ${filterState.kosher?'checked':''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="kosher-filter-${toolsId}" class="text-sm font-medium text-slate-600">×›×©×¨ ×‘×œ×‘×“</label>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <select data-destination="${dest}" data-type="${type}" class="local-filter-food-type form-select rounded-md text-sm py-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">×›×œ ×¡×•×’×™ ×”××•×›×œ</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${allFood.sort().map(ft=>`<option value="${ft}" ${filterState.foodType===ft?'selected':''}>${siteData.foodTypes[ft]||'ğŸ´'} ${ft||''}</option>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const hotelOptions = tripHotels.filter(h => h.coords).map(h => `<option value="${h.id}" ${filterState.sortMeta?.hotelId === h.id ? 'selected' : ''}>${h.name}</option>`).join('');
Â  Â  Â  Â  Â  filterHtml += `
Â  Â  Â  Â  Â  Â  <div class="sort-controls pt-3 border-t border-slate-200">
Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap items-center gap-x-4 gap-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-600 text-sm whitespace-nowrap">××™×•×Ÿ ×œ×¤×™ ××¨×—×§:</label>
Â  Â  Â  Â  Â  Â  Â  Â  <select class="sort-by-select form-select rounded-md text-sm py-1 flex-grow" data-destination="${dest}" data-type="${type}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="default" ${filterState.sortBy === 'default' ? 'selected' : ''}>×‘×¨×™×¨×ª ××—×“×œ</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="distance_user" ${filterState.sortBy === 'distance_user' ? 'selected' : ''}>××”××™×§×•× ×©×œ×™</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tripHotels.length > 0 ? `<option value="distance_hotel" ${filterState.sortBy === 'distance_hotel' ? 'selected' : ''}>×××œ×•×Ÿ</option>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <select class="hotel-sort-select form-select rounded-md text-sm py-1 flex-grow ${filterState.sortBy === 'distance_hotel' ? '' : 'hidden'}" data-destination="${dest}" data-type="${type}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="">×‘×—×¨ ××œ×•×Ÿ...</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${hotelOptions}
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  ${ (filterState.sortBy.startsWith('distance_') && filterState.sortPoint) ? `
Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-slate-500 mt-2 text-center bg-slate-200/70 p-1 rounded">
Â  Â  Â  Â  Â  Â  Â  Â  ×××™×™×Ÿ ×: <b>${filterState.sortMeta?.hotelName || filterState.sortMeta?.address || '×”××™×§×•× ×©×œ×™'}</b>
Â  Â  Â  Â  Â  Â  Â  </div>` : '' }
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  filterHtml += `</div>`;
Â  Â  Â  Â  Â  typeContent.insertAdjacentHTML('afterbegin', filterHtml);

Â  Â  Â  Â  Â  if (type === '××¡×¢×“×”/××•×›×œ') {
Â  Â  Â  Â  Â  Â  if (filterState.kosher) itemsForType = itemsForType.filter(i=>i.isKosher==='×›×Ÿ');
Â  Â  Â  Â  Â  Â  if (filterState.foodType) itemsForType = itemsForType.filter(i=>i.foodType===filterState.foodType);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (filterState.sortBy.startsWith('distance_') && filterState.sortPoint) {
Â  Â  Â  Â  Â  Â  itemsForType.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  item.airDistanceKm = calculateDistanceInMeters(filterState.sortPoint, item.coords) / 1000;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  itemsForType.sort((a,b)=> (a.airDistanceKm??Infinity) - (b.airDistanceKm??Infinity));
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  itemsForType.forEach(item => delete item.airDistanceKm);
Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  const grid = document.createElement('div');
Â  Â  Â  Â  Â  grid.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4';
Â  Â  Â  Â  Â  if (itemsForType.length === 0) {
Â  Â  Â  Â  Â  Â  grid.innerHTML = `<p class="text-slate-500 col-span-full text-center">××™×Ÿ ××§×•××•×ª ×”×ª×•×××™× ×œ×¡×™× ×•×Ÿ.</p>`;
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  itemsForType.forEach((item, index) => {
Â  Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  card.className = 'item-card bg-white/90 p-4 rounded-xl shadow-lg flex flex-col justify-between hover:scale-105 hover:shadow-2xl';
Â  Â  Â  Â  Â  Â  Â  card.dataset.id = item.id;
Â  Â  Â  Â  Â  Â  Â  card.style.animationDelay = `${index * 50}ms`;
Â  Â  Â  Â  Â  Â  Â  card.classList.add('item-card-anim');

Â  Â  Â  Â  Â  Â  Â  let tags = '';
Â  Â  Â  Â  Â  Â  Â  if (item.isKosher==='×›×Ÿ') tags += `<span class="text-xs font-bold text-green-600 bg-green-100 px-2 py-1 rounded-full">×›×©×¨</span>`;
Â  Â  Â  Â  Â  Â  Â  if (item.foodType) tags += `<span class="text-xs font-bold text-sky-600 bg-sky-100 px-2 py-1 rounded-full">${siteData.foodTypes[item.foodType]||''} ${item.foodType}</span>`;
Â  Â  Â  Â  Â  Â  Â  if (item.reservation && item.reservation!=='×œ×') tags += `<span class="text-xs font-bold text-amber-600 bg-amber-100 px-2 py-1 rounded-full">×”×–×× ×”: ${item.reservation}</span>`;

Â  Â  Â  Â  Â  Â  Â  const distanceHtml = (filterState.sortBy.startsWith('distance_') && item.airDistanceKm!==undefined && item.airDistanceKm!==Infinity)
Â  Â  Â  Â  Â  Â  Â  Â  ? `<div class="air-distance-info flex items-center justify-center text-xs text-slate-600 mt-2 border-t pt-2 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-plane-up fa-fw text-blue-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>××¨×—×§ ××•×•×™×¨×™: <b>${item.airDistanceKm.toFixed(1)} ×§"×</b></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>` : '';

Â  Â  Â  Â  Â  Â  Â  const hasCoords = !!item.coords;
Â  Â  Â  Â  Â  Â  Â  const navigateButton = `
Â  Â  Â  Â  Â  Â  Â  Â  <button data-id="${item.id}" class="navigate-btn action-btn bg-blue-100 text-blue-600 w-9 h-9 flex items-center justify-center rounded-full hover:bg-blue-200 transition ${!hasCoords ? 'opacity-50 cursor-not-allowed' : ''}" title="× ×•×•×˜ ×œ××§×•×" ${!hasCoords ? 'disabled' : ''}>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-diamond-turn-right"></i>
Â  Â  Â  Â  Â  Â  Â  Â  </button>`;
Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  const ratingHtml = renderStars(item.rating);

Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="text-base md:text-lg font-bold text-slate-800 flex-1 mb-1">${item.name}</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${ratingHtml ? `<div class="mb-2">${ratingHtml}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-2 min-h-[26px] mb-3">${tags}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.shortDescription ? `<p class="text-sm text-slate-600 mb-4">${item.shortDescription}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  ${distanceHtml}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-auto pt-3 border-t flex items-center justify-between gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${navigateButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.link ? `<a href="${item.link}" target="_blank" class="action-btn bg-green-100 text-green-600 w-9 h-9 flex items-center justify-center rounded-full hover:bg-green-200 transition" title="××ª×¨"><i class="fa-solid fa-link"></i></a>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="edit-btn action-btn bg-slate-200 text-slate-600 w-9 h-9 flex items-center justify-center rounded-full hover:bg-slate-300 transition" title="×¢×¨×™×›×”"><i class="fas fa-pencil"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="delete-btn action-btn bg-slate-200 text-slate-600 w-9 h-9 flex items-center justify-center rounded-full hover:text-red-500 hover:bg-red-100 transition" title="××—×™×§×”"><i class="fas fa-trash"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  grid.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  typeContent.appendChild(grid);
Â  Â  Â  Â  Â  typeSection.appendChild(typeContent);
Â  Â  Â  Â  Â  contentDiv.appendChild(typeSection);
Â  Â  Â  Â  });

Â  Â  Â  Â  destSection.appendChild(contentDiv);
Â  Â  Â  Â  const loader = document.createElement('div');
Â  Â  Â  Â  loader.className = 'section-loader hidden';
Â  Â  Â  Â  loader.innerHTML = `<i class="fas fa-sync-alt fa-2x fa-spin text-blue-500"></i>`;
Â  Â  Â  Â  destSection.appendChild(loader);
Â  Â  Â  Â  itemsContainer.appendChild(destSection);
Â  Â  Â  });
Â  Â  }

Â  Â  // ---------- Details Modal Logic ----------
Â  Â  // *** FIX: ×”×¤×•× ×§×¦×™×” ×”×¤×›×” ×œ-async ×›×“×™ ×œ××¤×©×¨ ×× ×’× ×•×Ÿ ×ª×™×§×•×Ÿ (××™×’×¨×¦×™×”) ***
Â  Â  async function openDetailsModal(itemId) {
Â  Â  Â  const item = allItems.find(i=>i.id===itemId);
Â  Â  Â  if (!item) return;

Â  Â  Â  // ---------- *** ×× ×’× ×•×Ÿ ×ª×™×§×•×Ÿ (××™×’×¨×¦×™×”) ××•×˜×•××˜×™ *** ----------
Â  Â  Â  // ×‘×•×“×§ ×× ×”×ª××•× ×•×ª ×©××•×¨×•×ª ×‘×¤×•×¨××˜ ×”×™×©×Ÿ (URL) ×‘××§×•× ×‘×¤×•×¨××˜ ×”×—×“×© (reference)
Â  Â  Â  if (item.photos && item.photos.length > 0 && typeof item.photos[0] === 'string' && item.photos[0].startsWith('http')) {
Â  Â  Â  Â  // ×¤×•×¨××˜ ×™×©×Ÿ ×–×•×”×”. × × ×¡×” ×œ×ª×§×Ÿ.
Â  Â  Â  Â  if (item.placeId && gmapsApiLoaded && gmaps_placesService) {
Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  console.log(`××ª×§×Ÿ ×ª××•× ×•×ª ×¢×‘×•×¨: ${item.name} (${item.id})`);
Â  Â  Â  Â  Â  Â  const request = { placeId: item.placeId, fields: ["photos"] };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×”××¨×” ×©×œ getDetails ×œ-Promise
Â  Â  Â  Â  Â  Â  const place = await new Promise((resolve, reject) => {
Â  Â  Â  Â  Â  Â  Â  gmaps_placesService.getDetails(request, (place, status) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (status === google.maps.places.PlacesServiceStatus.OK && place) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(place);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  reject(new Error(`Places API failed: ${status}`));
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // ×—×™×œ×•×¥ ×”-references ×”×—×“×©×™×
Â  Â  Â  Â  Â  Â  const newPhotoReferences = place.photos ? place.photos.slice(0, 3).map(p => p.photo_reference) : [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×¢×“×›×•×Ÿ ×”×¤×¨×™×˜ ×‘-Firestore
Â  Â  Â  Â  Â  Â  const itemRef = doc(db, 'trips', tripId, 'places', item.id);
Â  Â  Â  Â  Â  Â  await updateDoc(itemRef, { photos: newPhotoReferences });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // ×¢×“×›×•×Ÿ ×”××•×‘×™×™×§×˜ ×”×œ×•×§×œ×™ ×›×“×™ ×©×”-UI ×™×ª×¢×“×›×Ÿ ××™×“
Â  Â  Â  Â  Â  Â  item.photos = newPhotoReferences;
Â  Â  Â  Â  Â  Â  console.log(`×”×ª××•× ×•×ª ×ª×•×§× ×• ×‘×”×¦×œ×—×” ×¢×‘×•×¨: ${item.id}`);

Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  console.error(`× ×›×©×œ ×‘×ª×™×§×•×Ÿ ×ª××•× ×•×ª ×¢×‘×•×¨ ${item.id}:`, err);
Â  Â  Â  Â  Â  Â  // ×œ× ×—×•×¡× ××ª ×¤×ª×™×—×ª ×”××•×“×œ, ×¤×©×•×˜ ×¨×•×©× ×©×’×™××”
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else if (!item.placeId) {
Â  Â  Â  Â  Â  console.warn(`×œ× × ×™×ª×Ÿ ×œ×ª×§×Ÿ ×ª××•× ×•×ª ×¢×‘×•×¨ ${item.name}: ×—×¡×¨ placeId.`);
Â  Â  Â  Â  Â  // ×× ×§×” ××ª ×”×ª××•× ×•×ª ×”×©×‘×•×¨×•×ª ×›×“×™ ×©×œ× ×™×•×¦×’×•
Â  Â  Â  Â  Â  item.photos = []; 
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  Â  // ---------- *** ×¡×•×£ ×× ×’× ×•×Ÿ ×ª×™×§×•×Ÿ *** ----------


Â  Â  Â  const wrap = document.getElementById('details-modal-content');

Â  Â  Â  let tags = '';
Â  Â  Â  if (item.isKosher==='×›×Ÿ') tags += `<span class="text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full">×›×©×¨</span>`;
Â  Â  Â  if (item.foodType) tags += `<span class="text-sm font-bold text-sky-700 bg-sky-100 px-3 py-1 rounded-full">${siteData.foodTypes[item.foodType]||''} ${item.foodType}</span>`;
Â  Â  Â  if (item.reservation && item.reservation!=='×œ×') tags += `<span class="text-sm font-bold text-amber-700 bg-amber-100 px-3 py-1 rounded-full">×”×–×× ×”: ${item.reservation}</span>`;
Â  Â  Â Â 
Â  Â  Â  const ratingHtml = renderStars(item.rating);

Â  Â  Â  // *** FIX: ×‘× ×™×™×ª URL ×©×œ ×ª××•× ×” ×-photo_reference ***
Â  Â  Â  let photosHtml = '';
Â  Â  Â  if (item.photos && item.photos.length > 0) {
Â  Â  Â  Â  photosHtml = `<div class="grid grid-cols-3 gap-2">
Â  Â  Â  Â  Â  ${item.photos.map(ref => {
Â  Â  Â  Â  Â  Â  // ×‘×“×™×§×” ×× ×–×” ×¢×“×™×™×Ÿ URL ×™×©×Ÿ (×œ××§×¨×” ×©×”×ª×™×§×•×Ÿ × ×›×©×œ)
Â  Â  Â  Â  Â  Â  if (typeof ref === 'string' && ref.startsWith('http')) {
Â  Â  Â  Â  Â  Â  Â  return `<a href="${ref}" target="_blank"><img src="${ref}" class="w-full h-24 object-cover rounded-lg shadow-md" loading="lazy" onerror="this.src='https://placehold.co/400x200/e0e0e0/707070?text=Expired'; this.onerror=null;"></a>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  // ×‘× ×™×™×ª ×”-URL ×”×—×“×© ×•×”×ª×§×™×Ÿ
Â  Â  Â  Â  Â  Â  const url = `https://maps.googleapis.com/maps/api/place/photo?maxwidth=800&photoreference=${ref}&key=${GOOGLE_MAPS_API_KEY}`;
Â  Â  Â  Â  Â  Â  return `<a href="${url}" target="_blank"><img src="${url}" class="w-full h-24 object-cover rounded-lg shadow-md hover:opacity-80 transition-opacity" loading="lazy"></a>`;
Â  Â  Â  Â  Â  }).join('')}
Â  Â  Â  Â  </div>`;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const navigateButtonInModal = item.coords ? `<button data-id="${item.id}" class="navigate-btn flex-1 text-center bg-blue-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-blue-700 transition"><i class="fa-solid fa-diamond-turn-right mr-2"></i>× ×•×•×˜</button>` : '';

Â  Â  Â  wrap.innerHTML = `
Â  Â  Â  Â  <button id="details-modal-close" class="absolute top-3 left-3 w-8 h-8 bg-slate-100 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 z-10 transition-colors"><i class="fas fa-times"></i></button>
Â  Â  Â  Â  <div class="p-6 border-b">
Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-slate-800">${item.name}</h3>
Â  Â  Â  Â  Â  <div class="flex justify-between items-center mt-2">
Â  Â  Â  Â  Â  Â  <p class="text-slate-500">${siteData.placeTypeEmojis[item.type]||'ğŸ“Œ'} ${item.type}</p>
Â  Â  Â  Â  Â  Â  ${ratingHtml}
Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="p-6 flex-grow overflow-y-auto space-y-5 bg-slate-50">
Â  Â  Â  Â  Â  ${tags ? `<div class="flex flex-wrap gap-3 items-center">${tags}</div>` : ''}
Â  Â  Â  Â  Â  ${photosHtml}
Â  Â  Â  Â  Â  ${item.shortDescription ? `<div class="bg-blue-50 border-l-4 border-blue-400 p-4 rounded"><p class="text-slate-700 font-semibold">${item.shortDescription}</p></div>` : ''}
Â  Â  Â  Â  Â  ${item.description ? `<div class="bg-white p-4 rounded-lg shadow-inner"><p class="text-slate-700 whitespace-pre-wrap">${item.description}</p></div>` : ''}
Â  Â  Â  Â  Â  ${item.location ? `<div class="flex items-start gap-4"><i class="fa-solid fa-location-dot fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 font-semibold">${item.location}</p></div>` : ''}
Â  Â  Â  Â  Â  ${item.hours ? `<div class="flex items-start gap-4"><i class="fa-regular fa-clock fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 whitespace-pre-wrap">${item.hours}</p></div>` : ''}
Â  Â  Â  Â  Â  ${item.coords ? `<div id="details-map" class="w-full h-48 rounded-lg shadow-md"></div>` : ''}
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="p-4 bg-slate-100 border-t flex flex-wrap justify-center gap-3">
Â  Â  Â  Â  Â  ${navigateButtonInModal}
Â  Â  Â  Â  Â  ${item.link ? `<a href="${item.link}" target="_blank" class="flex-1 text-center bg-green-500 text-white font-bold py-3 px-5 rounded-lg hover:bg-green-600 transition"><i class="fa-solid fa-link mr-2"></i>××ª×¨</a>` : ''}
Â  Â  Â  Â  Â  <button data-id="${item.id}" class="edit-btn-modal flex-1 text-center bg-slate-600 text-white font-bold py-3 px-5 rounded-lg hover:bg-slate-700 transition"><i class="fas fa-pencil mr-2"></i>×¢×¨×•×š</button>
Â  Â  Â  Â  </div>
Â  Â  Â  `;
Â  Â  Â  detailsModal.classList.remove('hidden'); detailsModal.classList.add('flex');
Â  Â  Â  document.getElementById('details-modal-close').addEventListener('click', closeDetailsModal);
Â  Â  Â  document.querySelector('.edit-btn-modal').addEventListener('click', (e)=>{ closeDetailsModal(); openModalHandler(e.currentTarget.dataset.id); });
Â  Â  Â  const navBtn = document.querySelector('#details-modal-content .navigate-btn');
Â  Â  Â  if (navBtn) {
Â  Â  Â  Â  navBtn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  const id = e.currentTarget.dataset.id;
Â  Â  Â  Â  Â  const itemToNav = allItems.find(i => i.id === id);
Â  Â  Â  Â  Â  if(itemToNav) openNavigationChoiceModal(itemToNav);
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  if (item.coords) gmaps_initDetailsMap(item.coords);
Â  Â  }

Â  Â  function closeDetailsModal() {
Â  Â  Â  detailsModal.classList.add('hidden');Â 
Â  Â  Â  detailsModal.classList.remove('flex');
Â  Â  Â  gmaps_detailsMap = null; gmaps_detailsMarker = null;
Â  Â  }

Â  Â  function openNavigationChoiceModal(item) {
Â  Â  Â  if (!item.coords) return;
Â  Â  Â  const { lat, lng } = item.coords;
Â  Â  Â  document.getElementById('nav-link-google').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
Â  Â  Â  document.getElementById('nav-link-waze').href = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
Â  Â  Â  navigationModal.classList.remove('hidden');
Â  Â  Â  navigationModal.classList.add('flex');
Â  Â  }
Â  Â  function closeNavigationModal() {
Â  Â  Â  navigationModal.classList.add('hidden');
Â  Â  Â  navigationModal.classList.remove('flex');
Â  Â  }

Â  Â  // ---------- Global Event Listeners Setup ----------
Â  Â  function attachEvents() {
Â  Â  Â  hamburgerBtn.addEventListener('click', toggleSidebar);
Â  Â  Â  closeSidebarBtn.addEventListener('click', toggleSidebar);
Â  Â  Â  overlay.addEventListener('click', toggleSidebar);

Â  Â  Â  if (backBtn) {
Â  Â  Â  Â  backBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  if (tripId) window.location.href = `trip.html?id=${tripId}`;
Â  Â  Â  Â  Â  else window.location.href = 'index.html';
Â  Â  Â  Â  });
Â  Â  Â  }

Â  Â  Â  openModalBtn.addEventListener('click', () => openModalHandler());
Â  Â  Â  closeModalBtn.addEventListener('click', closeModalHandler);

Â  Â  Â  nextBtn.addEventListener('click', () => {Â 
Â  Â  Â  Â  Â  if (currentModalStep < totalModalSteps) {Â 
Â  Â  Â  Â  Â  Â  Â  currentModalStep++;Â 
Â  Â  Â  Â  Â  Â  Â  updateModalView();Â 
Â  Â  Â  Â  Â  }Â 
Â  Â  Â  });
Â  Â  Â  backStepBtn.addEventListener('click', () => {Â 
Â  Â  Â  Â  Â  if (currentModalStep > 1) {Â 
Â  Â  Â  Â  Â  Â  Â  currentModalStep--;Â 
Â  Â  Â  Â  Â  Â  Â  updateModalView();Â 
Â  Â  Â  Â  Â  }Â 
Â  Â  Â  });

Â  Â  Â  getLocationBtn.addEventListener('click', handleGetLocation);
Â  Â  Â  detailsModal.addEventListener('click', (e)=>{ if (e.target.id==='details-modal') closeDetailsModal(); });
Â  Â  Â Â 
Â  Â  Â  closeNavigationModalBtn.addEventListener('click', closeNavigationModal);
Â  Â  Â  navigationModal.addEventListener('click', (e) => { if (e.target.id === 'navigation-choice-modal') closeNavigationModal(); });

Â  Â  Â  form.addEventListener('keydown', e => {
Â  Â  Â  Â  if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  if (!nextBtn.classList.contains('hidden')) nextBtn.click();
Â  Â  Â  Â  Â  else if (!finishBtn.classList.contains('hidden')) finishBtn.click();
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  Â Â 
Â  Â  Â  form.addEventListener('change', e => {
Â  Â  Â  Â  Â  if (e.target.id === 'item-type') {
Â  Â  Â  Â  Â  Â  Â  handleTypeChange();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (e.target.id === 'item-food-type') {
Â  Â  Â  Â  Â  Â  Â  handleFoodTypeChange();
Â  Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  itemsContainer.addEventListener('click', (e) => {
Â  Â  Â  Â  const card = e.target.closest('.item-card'); if (!card) return;
Â  Â  Â  Â  const actionBtn = e.target.closest('.action-btn');
Â  Â  Â  Â  const id = card.dataset.id;
Â  Â  Â  Â  const item = allItems.find(i=>i.id===id);
Â  Â  Â  Â  if (actionBtn) {
Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  if (actionBtn.matches('.delete-btn')) {
Â  Â  Â  Â  Â  Â  const confirmBtn = document.getElementById('delete-modal-confirm');
Â  Â  Â  Â  Â  Â  const title = document.getElementById('delete-modal-title');
Â  Â  Â  Â  Â  Â  title.textContent = `×”×× ×œ××—×•×§ ××ª "${item?.name||''}"?`;
Â  Â  Â  Â  Â  Â  const closeDelete = () => { deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); };
Â  Â  Â  Â  Â  Â  const handler = async () => {
Â  Â  Â  Â  Â  Â  Â  try { await deleteDoc(doc(db, 'trips', tripId, 'places', id)); } catch(e){ console.error(e); } finally { closeDelete(); }
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  confirmBtn.addEventListener('click', handler, { once:true });
Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-cancel').addEventListener('click', closeDelete, { once:true });
Â  Â  Â  Â  Â  Â  deleteModal.classList.remove('hidden'); deleteModal.classList.add('flex');
Â  Â  Â  Â  Â  } else if (actionBtn.matches('.edit-btn')) {
Â  Â  Â  Â  Â  Â  openModalHandler(id);
Â  Â  Â  Â  Â  } else if (actionBtn.matches('.navigate-btn')) {
Â  Â  Â  Â  Â  Â  if (item) openNavigationChoiceModal(item);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // *** FIX: ×§×¨×™××” ×œ×¤×•× ×§×¦×™×” ××¡×™× ×›×¨×•× ×™×ª ***
Â  Â  Â  Â  (async () => { await openDetailsModal(id); })();
Â  Â  Â  });

Â  Â  Â  itemsContainer.addEventListener('change', async e => {
Â  Â  Â  Â  const t = e.target;
Â  Â  Â  Â  const dest = t.dataset.destination;
Â  Â  Â  Â  const type = t.dataset.type;
Â  Â  Â  Â  if (!dest || !type || !activeFilters[dest] || !activeFilters[dest][type]) return;
Â  Â  Â  Â  const filter = activeFilters[dest][type];

Â  Â  Â  Â  if (t.matches('.local-filter-kosher')) {
Â  Â  Â  Â  Â  filter.kosher = t.checked;
Â  Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  }
Â  Â  Â  Â  if (t.matches('.local-filter-food-type')) {
Â  Â  Â  Â  Â  filter.foodType = t.value;
Â  Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  if (t.matches('.sort-by-select')) {
Â  Â  Â  Â  Â  const newSortBy = t.value;
Â  Â  Â  Â  Â  filter.sortBy = newSortBy;
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  if (newSortBy === 'default') {
Â  Â  Â  Â  Â  Â  filter.sortPoint = null;
Â  Â  Â  Â  Â  Â  filter.sortMeta = {};
Â  Â  Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  Â  } else if (newSortBy === 'distance_user') {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  const location = await handleGetLocation();
Â  Â  Â  Â  Â  Â  Â  filter.sortPoint = location;
Â  Â  Â  Â  Â  Â  Â  filter.sortMeta = { address: '×”××™×§×•× ×©×œ×™' };
Â  Â  Â  Â  Â  Â  } catch {
Â  Â  Â  Â  Â  Â  Â  filter.sortBy = 'default';
Â  Â  Â  Â  Â  Â  Â  filter.sortPoint = null;
Â  Â  Â  Â  Â  Â  Â  filter.sortMeta = {};
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  Â  } else if (newSortBy === 'distance_hotel') {
Â  Â  Â  Â  Â  Â  if (filter.sortMeta?.hotelId) {
Â  Â  Â  Â  Â  Â  Â  Â  const selectedHotel = tripHotels.find(h => h.id === filter.sortMeta.hotelId);
Â  Â  Â  Â  Â  Â  Â  Â  if (selectedHotel) filter.sortPoint = selectedHotel.coords;
Â  Â  Â  Â  Â  Â  Â  Â  else filter.sortPoint = null;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  filter.sortPoint = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  if (t.matches('.hotel-sort-select')) {
Â  Â  Â  Â  Â  const hotelId = t.value;
Â  Â  Â  Â  Â  if (!hotelId) {
Â  Â  Â  Â  Â  Â  filter.sortPoint = null;
Â  Â  Â  Â  Â  Â  filter.sortMeta = {};
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  const selectedHotel = tripHotels.find(h => h.id === hotelId);
Â  Â  Â  Â  Â  Â  if (selectedHotel && selectedHotel.coords) {
Â  Â  Â  Â  Â  Â  Â  filter.sortPoint = selectedHotel.coords;
Â  Â  Â  Â  Â  Â  Â  filter.sortMeta = { hotelId: hotelId, hotelName: selectedHotel.name };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  }
Â  Â  Â  });

Â  Â  Â  form.addEventListener('submit', async (e) => {
Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  if (currentModalStep !== totalModalSteps) return;
Â  Â  Â  Â  const gv = id => document.getElementById(id) ? document.getElementById(id).value : null;

Â  Â  Â  Â  const name = gv('item-name');
Â  Â  Â  Â  if (!name || name.trim()==='') { showModalError('×©× ×”××§×•× ×”×•× ×©×“×” ×—×•×‘×”.'); return; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  const locationText = gv('item-location');
Â  Â  Â  Â  if (!locationText || locationText.trim() === '') {
Â  Â  Â  Â  Â  showModalError('×‘×—×™×¨×ª ×›×ª×•×‘×ª ×•××™×§×•× ×¢×œ ×”××¤×” ×”×™× ×©×“×” ×—×•×‘×”.');
Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }

Â  Â  Â  Â  let finalType = gv('item-type');
Â  Â  Â  Â  if (finalType === '××—×¨') {
Â  Â  Â  Â  Â  finalType = (gv('item-type-other')||'').trim() || '×›×œ×œ×™';
Â  Â  Â  Â  Â  if (finalType !== '×›×œ×œ×™' && !siteData.placeTypes.includes(finalType)) {
Â  Â  Â  Â  Â  Â  await setDoc(settingsDocRef, { placeTypes: arrayUnion(finalType) }, { merge:true });
Â  Â  Â  Â  Â  Â  siteData.customPlaceTypes.push(finalType);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  let finalFoodType = isRestaurant ? gv('item-food-type') : null;
Â  Â  Â  Â  if (isRestaurant && finalFoodType === '××—×¨') {
Â  Â  Â  Â  Â  finalFoodType = (gv('item-food-type-other')||'').trim() || null;
Â  Â  Â  Â  Â  if (finalFoodType && !siteData.foodTypes[finalFoodType]) {
Â  Â  Â  Â  Â  Â  await setDoc(settingsDocRef, { foodTypes: arrayUnion(finalFoodType) }, { merge:true });
Â  Â  Â  Â  Â  Â  siteData.customFoodTypes[finalFoodType] = 'ğŸ´';
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------- *** FIX: ××™×¡×•×£ × ×ª×•× ×™× × ×›×•×Ÿ *** ----------
Â  Â  Â  Â  const existing = editingItemId ? allItems.find(i=>i.id === editingItemId) : null;

Â  Â  Â  Â  // ×‘×¨×™×¨×ª ××—×“×œ ×œ× ×ª×•× ×™× ×§×™×™××™× ××• ×¢×¨×›×™× ×¨×™×§×™×
Â  Â  Â  Â  let photos = existing?.photos || [];
Â  Â  Â  Â  let rating = existing?.rating || null;
Â  Â  Â  Â  let coords = existing?.coords || null;
Â  Â  Â  Â  let placeId = existing?.placeId || null; // *** FIX: ×©××™×¨×ª placeId ***

Â  Â  Â  Â  // ×× × ×‘×—×¨ ××§×•× ×—×“×© ××’×•×’×œ ×‘×¡×©×Ÿ ×”×–×”, ×”× ×ª×•× ×™× ×©×œ×• ××§×‘×œ×™× ×¢×“×™×¤×•×ª
Â  Â  Â  Â  if (selectedGooglePlaceDetails) {
Â  Â  Â  Â  Â  Â  // ×“×¨×™×¡×” ×©×œ ×”× ×ª×•× ×™× ×”×™×©× ×™×. selectedGooglePlaceDetails ××›×™×œ ×›×¢×ª photo_references
Â  Â  Â  Â  Â  Â  photos = selectedGooglePlaceDetails.photos || [];
Â  Â  Â  Â  Â  Â  rating = selectedGooglePlaceDetails.rating || null;
Â  Â  Â  Â  Â  Â  placeId = selectedGooglePlaceDetails.placeId || null; // *** FIX: ×©××™×¨×ª placeId ***
Â  Â  Â  Â  }

Â  Â  Â  Â  // ×”×§×•××•×¨×“×™× ×˜×•×ª ×”×¡×•×¤×™×•×ª ×•×”×§×•×‘×¢×•×ª ××’×™×¢×•×ª ×××™×§×•× ×”××¨×§×¨ ×¢×œ ×”××¤×”
Â  Â  Â  Â  if (gmaps_addEditMarker) {
Â  Â  Â  Â  Â  Â  const markerPosition = gmaps_addEditMarker.getPosition();
Â  Â  Â  Â  Â  Â  if (markerPosition) {
Â  Â  Â  Â  Â  Â  Â  Â  coords = { lat: markerPosition.lat(), lng: markerPosition.lng() };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ×•×œ×™×“×¦×™×” ×¡×•×¤×™×ª ×œ×§×•××•×¨×“×™× ×˜×•×ª
Â  Â  Â  Â  if (!coords) {
Â  Â  Â  Â  Â  Â  showModalError('×™×© ×œ××§× × ×¢×¥ ×¢×œ ×”××¤×” ××• ×œ×‘×—×•×¨ ××§×•× ××”×—×™×¤×•×©.');
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  Â  Â  // ---------- *** ×¡×•×£ ×”×ª×™×§×•×Ÿ *** ----------

Â  Â  Â  Â  const data = {
Â  Â  Â  Â  Â  name: name,
Â  Â  Â  Â  Â  destination: gv('item-destination'),
Â  Â  Â  Â  Â  type: finalType,
Â  Â  Â  Â  Â  shortDescription: gv('item-short-description'),
Â  Â  Â  Â  Â  description: gv('item-description'),
Â  Â  Â  Â  Â  isKosher: isRestaurant ? gv('item-kosher') : null,
Â  Â  Â  Â  Â  foodType: finalFoodType,
Â  Â  Â  Â  Â  location: locationText,
Â  Â  Â  Â  Â  hours: gv('item-hours'),
Â  Â  Â  Â  Â  link: gv('item-link'),
Â  Â  Â  Â  Â  reservation: gv('item-reservation'),
Â  Â  Â  Â  Â  author: currentUser.uid,
Â  Â  Â  Â  Â  coords: coords,
Â  Â  Â  Â  Â  photos: photos, // *** ×›×¢×ª ××›×™×œ photo_references ***
Â  Â  Â  Â  Â  rating: rating,
Â  Â  Â  Â  Â  placeId: placeId // *** FIX: ×©××™×¨×ª placeId ***
Â  Â  Â  Â  };

Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  if (editingItemId) {
Â  Â  Â  Â  Â  Â  await updateDoc(doc(db, 'trips', tripId, 'places', editingItemId), { ...data, updatedAt: serverTimestamp() });
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  await addDoc(collection(db, 'trips', tripId, 'places'), { ...data, createdAt: serverTimestamp() });
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  closeModalHandler();
Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  console.error('save err', err);
Â  Â  Â  Â  Â  showModalError('×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×™×˜.');
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  // ---------- Data Fetching & Realtime Updates ----------
Â  Â  function listenPlaces() {
Â  Â  Â  const qRef = query(collection(db, 'trips', tripId, 'places'), orderBy('createdAt','desc'));
Â  Â  Â  onSnapshot(qRef, (snap) => {
Â  Â  Â  Â  const newItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
Â  Â  Â  Â  newItems.forEach(n => {
Â  Â  Â  Â  Â  const old = allItems.find(i=>i.id===n.id);
Â  Â  Â  Â  Â  if (old?.airDistanceKm) n.airDistanceKm = old.airDistanceKm;
Â  Â  Â  Â  });
Â  Â  Â  Â  allItems = newItems;
Â  Â  Â  Â  renderAllItems();
Â  Â  Â  Â  if (isInitialLoad) {
Â  Â  Â  Â  Â  isInitialLoad = false;
Â  Â  Â  Â  Â  initialLoader.style.opacity = '0';
Â  Â  Â  Â  Â  mainContent.style.opacity = '1';
Â  Â  Â  Â  Â  setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
Â  Â  Â  Â  }
Â  Â  Â  }, (err)=> {
Â  Â  Â  Â  console.error('places snapshot', err);
Â  Â  Â  Â  loadingMessage.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”××™×“×¢.";
Â  Â  Â  });
Â  Â  }
Â  Â Â 
Â  Â  async function loadTripHotels() {
Â  Â  Â  if (!tripId) return;
Â  Â  Â  try {
Â  Â  Â  Â  const logisticsRef = collection(db, 'trips', tripId, 'logistics');
Â  Â  Â  Â  const q = query(logisticsRef, where("type", "==", "hotel"));
Â  Â  Â  Â  const snapshot = await getDocs(q);
Â  Â  Â  Â  tripHotels = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  } catch (e) {
Â  Â  Â  Â  console.error("Error loading hotels:", e);
Â  Â  Â  Â  tripHotels = [];
Â  Â  Â  }
Â  Â  }

Â  Â  // ---------- Page Initialization ----------
Â  Â  async function initPage() {
Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  tripId = urlParams.get('id') || urlParams.get('tripId');
Â  Â  Â  if (!tripId) {
Â  Â  Â  Â  showAlert("×©×’×™××”: ×œ× × ××¦× ××–×”×” ×˜×™×•×œ.", "×©×’×™××” ×§×¨×™×˜×™×ª");
Â  Â  Â  Â  setTimeout(() => location.href = 'index.html', 3000);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â Â 
Â  Â  Â  const smartRouteBtn = document.getElementById('smart-route-btn');
Â  Â  Â  if (smartRouteBtn) {
Â  Â  Â  Â  Â  smartRouteBtn.href = `edit-trip?id=${tripId}`;
Â  Â  Â  }

Â  Â  Â  try {
Â  Â  Â  Â  await loadGoogleMapsApi();
Â  Â  Â  Â  // *** FIX: ××ª×—×•×œ ×©×™×¨×•×ª×™ ×’×•×’×œ ×‘××•×¤×Ÿ ×’×œ×•×‘×œ×™ ***
Â  Â  Â  Â  if (gmapsApiLoaded) {
Â  Â  Â  Â  Â  // × ×™×¦×•×¨ ××œ×× ×˜ ××¤×” "×“××”" × ×¡×ª×¨ ×›×“×™ ×œ××ª×—×œ ××ª ×”×©×™×¨×•×ª×™×
Â  Â  Â  Â  Â  const dummyMapDiv = document.createElement('div');
Â  Â  Â  Â  Â  if (!gmaps_placesService) {
Â  Â  Â  Â  Â  Â  gmaps_placesService = new google.maps.places.PlacesService(new google.maps.Map(dummyMapDiv));
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  if (!gmaps_autocompleteService) {
Â  Â  Â  Â  Â  Â  gmaps_autocompleteService = new google.maps.places.AutocompleteService();
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  // *** ×¡×•×£ ×”×ª×™×§×•×Ÿ ***
Â  Â  Â  } catch (error) {
Â  Â  Â  Â  console.error(error);
Â  Â  Â  Â  showAlert("×œ× × ×™×ª×Ÿ ×”×™×” ×œ×˜×¢×•×Ÿ ××ª ×©×™×¨×•×ª×™ ×”××¤×•×ª ×©×œ ×’×•×’×œ. ×—×œ×§ ××”×ª×›×•× ×•×ª ×œ× ×™×¢×‘×“×•.");
Â  Â  Â  }

Â  Â  Â  attachEvents();
Â  Â  Â Â 
Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  if (!user) { location.replace('login.html'); return; }
Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  const displayName = user.displayName || user.email.split('@')[0];
Â  Â  Â  Â  authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
Â  Â  Â  Â  document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

Â  Â  Â  Â  const tripRef = doc(db, 'trips', tripId);
Â  Â  Â  Â  const tripSnap = await getDoc(tripRef);

Â  Â  Â  Â  if (tripSnap.exists()) {
Â  Â  Â  Â  Â  const loadedTripData = tripSnap.data();
Â  Â  Â  Â  Â  const canAccess = loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid);

Â  Â  Â  Â  Â  if (canAccess) {
Â  Â  Â  Â  Â  Â  tripData = loadedTripData;
Â  Â  Â  Â  Â  Â  if (tripTitleLine && tripData?.name) {
Â  Â  Â  Â  Â  Â  Â  tripTitleLine.textContent = `××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª ×œ×˜×™×•×œ - ${tripData.name}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  await loadTripHotels();
Â  Â  Â  Â  Â  Â  await loadCustomSettings();
Â  Â  Â  Â  Â  Â  buildMenuFromTrip();
Â  Â  Â  Â  Â  Â  listenPlaces();
Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  showAlert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.');
Â  Â  Â  Â  Â  Â  setTimeout(() => location.href='index.html', 3000);
Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  showAlert('×”×˜×™×•×œ ×œ× × ××¦×.');
Â  Â  Â  Â  Â  setTimeout(() => location.href='index.html', 3000);
Â  Â  Â  Â  }
Â  Â  Â  });
Â  Â  }

Â  Â  if ('serviceWorker' in navigator) {
Â  Â  Â  window.addEventListener('load', () => {
Â  Â  Â  Â  navigator.serviceWorker.register('/service-worker.js').catch(()=>{});
Â  Â  Â  });
Â  Â  }

Â  Â  initPage();
Â  </script>
</body>
</html>

