<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
  <title>××¡×¢ ×—×œ×•××•×ª ğŸ—½ ××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#0f172a">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Assistant', 'sans-serif'],
            rubik: ['Rubik', 'sans-serif'],
          },
          colors: {
            vacation: {
              primary: '#0ea5e9', // Sky 500
              dark: '#0284c7', // Sky 600
              accent: '#f59e0b', // Amber 500
              surface: '#ffffff', 
              glass: 'rgba(255, 255, 255, 0.9)',
            }
          },
          animation: {
            'float': 'float 6s ease-in-out infinite',
            'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.3s ease-out',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-10px)' },
            },
            slideUp: {
              '0%': { transform: 'translateY(100%)' },
              '100%': { transform: 'translateY(0)' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            }
          }
        }
      }
    }
  </script>

  <style>
    /* Global base */
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      background-color: #0f172a;
      overscroll-behavior-y: none; 
      -webkit-tap-highlight-color: transparent;
      user-select: none;
      -webkit-user-select: none;
    }
    
    /* Fixed Background Layer - Solves Jitter on Mobile */
    .fixed-bg-layer {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100dvh; /* Dynamic Viewport Height for Mobile */
      z-index: -1;
      pointer-events: none;
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    /* Allow text selection only on specific readable areas */
    input, textarea, .prose, .selectable-text {
      user-select: text;
      -webkit-user-select: text;
    }

    body {
      overflow-x: hidden;
      display: flex;
      flex-direction: column;
    }
    
    /* Scrollbar Styling */
    ::-webkit-scrollbar { width: 4px; height: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
    
    /* Custom Input Styles */
    .form-input, .form-select, .form-textarea {
      width: 100%;
      box-sizing: border-box;
      transition: all 0.2s ease-in-out;
      border-radius: 0.75rem;
      border: 1px solid #e2e8f0;
      background-color: #ffffff;
      font-size: 16px; /* Prevents iOS zoom */
      appearance: none;
      -webkit-appearance: none;
    }
    
    .form-textarea {
      resize: vertical;
      min-height: 80px;
      line-height: 1.5;
    }

    .form-input:focus, .form-select:focus, .form-textarea:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.15);
      outline: none;
    }

    /* Maps */
    #map-preview, #details-map {
      height: 220px;
      width: 100%;
      border-radius: 1rem;
      overflow: hidden;
      background-color: #e2e8f0;
      touch-action: none; 
      box-shadow: inset 0 2px 4px rgba(0,0,0,0.06);
    }

    /* Accordion / Details */
    details > summary { list-style: none; cursor: pointer; outline: none; }
    details > summary::-webkit-details-marker { display: none; }
    .chevron-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    details[open] > summary .chevron-icon { transform: rotate(180deg); }

    /* Animations */
    .modal-step { 
      display: none; 
      width: 100%; 
    }
    .modal-step.active { display: block; animation: fadeIn 0.3s ease-out; }
    
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
    @keyframes pulse-ring { 
      0% { transform: scale(0.8); opacity: 0.5; } 
      100% { transform: scale(1.3); opacity: 0; } 
    }

    .plane-spinner { animation: spin 4s linear infinite; }
    .pulse-effect::before {
      content: '';
      position: absolute;
      top: 50%; left: 50%;
      width: 100%; height: 100%;
      background: rgba(14, 165, 233, 0.3);
      border-radius: 50%;
      transform: translate(-50%, -50%);
      animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
      z-index: -1;
    }

    .item-card-anim { animation: fadeInUp 0.5s both cubic-bezier(0.4, 0, 0.2, 1); }
    @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* Autocomplete */
    .ac-list {
      position: absolute; top: 100%; right: 0; left: 0; z-index: 1050;
      background: rgba(255,255,255,0.98);
      backdrop-filter: blur(10px);
      border: 1px solid #e2e8f0; border-radius: 1rem;
      margin-top: 0.5rem; max-height: 250px; overflow-y: auto;
      box-shadow: 0 10px 25px -5px rgba(0,0,0,0.15);
    }
    .ac-item { padding: 1rem; cursor: pointer; display: flex; align-items: center; gap: 0.75rem; border-bottom: 1px solid #f1f5f9; }
    .ac-item:last-child { border-bottom: none; }
    .ac-item:active { background: #e0f2fe; }

    /* Modal Mobile Optimization (Bottom Sheet) */
    @media (max-width: 640px) {
      .modal-content-wrapper {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        border-bottom-left-radius: 0 !important;
        border-bottom-right-radius: 0 !important;
        max-height: 92vh !important;
        animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        display: flex;
        flex-direction: column;
      }
    }
    
    /* Scroll Lock */
    body.modal-locked { 
      overflow: hidden; 
    }
    
    /* Glass Effect Utility */
    .glass-panel {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border: 1px solid rgba(255, 255, 255, 0.6);
    }
    
    /* Hide scrollbar utility */
    .hide-scrollbar::-webkit-scrollbar { display: none; }
    .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

    /* Safe Area padding for iPhones */
    .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }

    /* Clean Card Design */
    .item-card {
      background: #ffffff;
      border: 1px solid #f1f5f9;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
    }
  </style>
</head>
<body class="bg-slate-900 text-slate-800 antialiased selection:bg-cyan-200 selection:text-cyan-900">

  <!-- Initial Loader -->
  <div id="initial-loader" class="fixed inset-0 z-[200] flex items-center justify-center transition-opacity duration-500 bg-slate-900">
    <div class="fixed inset-0 z-0 opacity-30 bg-cover bg-center" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div class="relative z-10 text-white text-center flex flex-col items-center">
      <div class="w-28 h-28 mb-8 relative flex items-center justify-center pulse-effect">
        <i class="fas fa-plane-departure fa-4x text-cyan-400 plane-spinner drop-shadow-lg"></i>
      </div>
      <p class="text-3xl font-bold tracking-tight font-rubik text-cyan-100">××ª×—×‘×¨×™× ×œ××¡×¢...</p>
      <div class="mt-6 w-48 h-1 bg-white/20 rounded-full overflow-hidden">
        <div class="h-full bg-cyan-400 animate-[loading_1.5s_ease-in-out_infinite]" style="width: 50%"></div>
      </div>
    </div>
  </div>

  <!-- STABLE BACKGROUND FIX -->
  <div class="fixed-bg-layer" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
  <div class="fixed-bg-layer bg-gradient-to-b from-slate-900/60 via-slate-900/40 to-slate-900/80 backdrop-blur-[2px]"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform translate-x-full transition-transform duration-300 ease-out border-l border-white/20">
    <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-l from-cyan-50 to-transparent">
      <h2 class="text-2xl font-bold text-slate-800 font-rubik">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>
    <nav id="main-menu" class="p-4 space-y-3 overflow-y-auto h-[calc(100%-80px)] pb-20"></nav>
  </aside>
  
  <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300"></div>

  <!-- Main Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-700 min-h-screen flex flex-col">
    
    <!-- Header -->
    <header class="sticky top-0 z-40 glass-panel shadow-sm border-b border-white/30 transition-all duration-300">
      <div class="container mx-auto px-4 sm:px-6">
        <div class="flex items-center justify-between h-16 sm:h-20">
          <div class="flex items-center gap-3">
            <button id="back-btn" class="w-10 h-10 rounded-full bg-white/50 hover:bg-cyan-50 text-slate-700 hover:text-cyan-600 transition flex items-center justify-center shadow-sm backdrop-blur-md" title="×—×–×¨×”">
              <i class="fas fa-arrow-right"></i>
            </button>
            <h1 class="text-xl sm:text-2xl font-bold text-slate-800 truncate font-rubik">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</h1>
          </div>
          <div class="flex items-center gap-3">
            <div id="auth-container" class="flex items-center"></div>
            <button id="hamburger-btn" class="w-10 h-10 rounded-full bg-white/50 hover:bg-cyan-50 text-slate-700 hover:text-cyan-600 transition flex items-center justify-center shadow-sm backdrop-blur-md">
              <i class="fas fa-bars"></i>
            </button>
          </div>
        </div>
      </div>
    </header>

    <!-- Sub-header / Status -->
    <div id="trip-banner" class="glass-panel border-b border-white/20 relative overflow-hidden">
      <div class="absolute top-0 right-0 w-full h-1 bg-gradient-to-r from-cyan-400 via-blue-500 to-purple-500"></div>
      <div class="container mx-auto px-4 py-3">
        <p id="trip-title-line" class="text-center text-slate-700 font-bold text-sm sm:text-base flex items-center justify-center gap-2">
          <i class="fas fa-suitcase-rolling text-cyan-600"></i>
          <span>×˜×•×¢×Ÿ × ×ª×•× ×™×...</span>
        </p>
      </div>
    </div>

    <main class="flex-grow p-4 sm:p-6 lg:p-8 pb-32">
      <div class="max-w-6xl mx-auto">
        
        <!-- Hero Section -->
        <div class="text-center mb-10 mt-4 animate-float">
          <h2 class="text-4xl sm:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-b from-white to-cyan-100 drop-shadow-lg font-rubik">
            ×ª×—× ×•×ª ×‘××¡×¢ âœ¨
          </h2>
          <p class="mt-3 text-lg text-cyan-50 max-w-2xl mx-auto font-light drop-shadow-md">
            ××•×¡×£ ×”×”××œ×¦×•×ª, ×”×ª×’×œ×™×•×ª ×•×”××§×•××•×ª ×©××¡×•×¨ ×œ× ×• ×œ×¤×¡×¤×¡ ×‘×˜×™×•×œ.
          </p>
        </div>

        <!-- Action Buttons -->
        <div class="mb-10 overflow-x-auto pb-4 -mx-4 px-4 sm:mx-0 sm:px-0 hide-scrollbar flex justify-center">
          <div class="flex items-center gap-3 sm:gap-4 flex-nowrap min-w-max">
            <a id="smart-route-btn" href="#" class="group relative px-6 py-3 rounded-full bg-gradient-to-r from-purple-600 to-indigo-600 text-white font-bold shadow-lg shadow-indigo-500/30 hover:shadow-indigo-500/50 hover:scale-105 transition-all duration-300 flex items-center overflow-hidden">
              <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
              <i class="fas fa-magic-wand-sparkles mr-2 animate-pulse"></i> ×‘× ×™×™×ª ××¡×œ×•×œ ×—×›×
            </a>
            
            <button id="open-modal-btn" class="group relative px-6 py-3 rounded-full bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold shadow-lg shadow-cyan-500/30 hover:shadow-cyan-500/50 hover:scale-105 transition-all duration-300 flex items-center overflow-hidden">
              <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
              <i class="fas fa-plus mr-2"></i> ×”×•×¡×¤×ª ××§×•×
            </button>
            
            <button id="get-location-btn" class="px-6 py-3 rounded-full bg-white/20 backdrop-blur-md border border-white/30 text-white font-semibold shadow-lg hover:bg-white/30 transition-all duration-300 hover:scale-105 flex items-center">
              <i class="fas fa-location-arrow mr-2"></i> ×× ×™ ×›××Ÿ
            </button>
          </div>
        </div>

        <!-- Items Container -->
        <div id="items-container" class="space-y-6 min-h-[300px]">
          <div id="loading-message" class="flex flex-col items-center justify-center py-12 bg-white/10 backdrop-blur-md rounded-2xl border border-white/10 text-white">
            <i class="fas fa-circle-notch fa-spin fa-2x mb-3 text-cyan-400"></i>
            <p>×˜×•×¢×Ÿ ××ª ×”××§×•××•×ª ×”×›×™ ×©×•×•×™×...</p>
          </div>
        </div>
      
      </div>
    </main>
  </div>

  <!-- Modals -->
  
  <!-- Add / Edit Item Modal -->
  <div id="item-modal" class="fixed inset-0 z-[160] hidden items-center justify-center sm:p-4 transition-all duration-300">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm transition-opacity" id="modal-backdrop"></div>
    
    <div class="modal-content-wrapper relative bg-white w-full sm:max-w-2xl sm:rounded-3xl shadow-2xl flex flex-col max-h-full sm:max-h-[85vh] overflow-hidden">
      <!-- Modal Header -->
      <div class="p-5 border-b border-slate-100 flex justify-between items-center bg-gradient-to-r from-white to-slate-50 relative z-10 shrink-0">
        <div>
          <h3 id="modal-title" class="text-2xl font-bold text-slate-800 font-rubik">×”×•×¡×¤×ª ××§×•× ×—×“×©</h3>
          <p id="modal-steps-indicator" class="text-xs font-bold text-cyan-600 mt-1 uppercase tracking-wide"></p>
        </div>
        <button id="modal-close-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:bg-red-50 hover:text-red-500 transition flex items-center justify-center">
          <i class="fas fa-times fa-lg"></i>
        </button>
      </div>

      <!-- Progress Bar -->
      <div class="w-full bg-slate-100 h-1.5 relative z-10 shrink-0">
        <div id="step-progress-bar" class="bg-gradient-to-r from-cyan-400 to-blue-500 h-full transition-all duration-500 ease-out shadow-[0_0_10px_rgba(6,182,212,0.5)]" style="width:0%;"></div>
      </div>

      <!-- Form Content -->
      <form id="item-form" class="flex-grow overflow-y-auto p-6 space-y-2 relative scroll-smooth overscroll-contain">
        <div id="step-1" class="modal-step"></div>
        <div id="step-2" class="modal-step"></div>
        <div id="step-3" class="modal-step"></div>
        <div id="step-4" class="modal-step"></div>
        <div id="step-5" class="modal-step"></div>
        <div id="step-6" class="modal-step"></div>
        <div id="step-7" class="modal-step"></div>
        <div id="step-8" class="modal-step"></div>
        <div id="step-9" class="modal-step"></div>
      </form>

      <!-- Modal Footer -->
      <div class="p-4 bg-white border-t border-slate-100 flex flex-col gap-2 relative z-10 pb-safe shrink-0">
        <div id="modal-error-message" class="text-red-500 text-sm font-bold h-5 text-center transition-all"></div>
        <div class="flex justify-between items-center gap-3">
          <button type="button" id="modal-back-btn" class="py-3 px-6 rounded-xl text-slate-600 bg-slate-100 hover:bg-slate-200 transition font-bold hidden w-1/3">
            <i class="fas fa-arrow-right ml-2"></i> ××—×•×¨×”
          </button>
          
          <button type="button" id="modal-next-btn" class="py-3 px-6 rounded-xl bg-slate-800 text-white font-bold hover:bg-slate-900 transition flex-grow shadow-lg shadow-slate-300/50">
            ×”×‘× <i class="fas fa-arrow-left mr-2"></i>
          </button>
          
          <button type="submit" form="item-form" id="modal-finish-btn" class="py-3 px-6 rounded-xl bg-gradient-to-r from-green-500 to-emerald-600 text-white font-bold hover:shadow-emerald-500/40 hover:scale-[1.02] transition shadow-lg flex-grow hidden">
            <i class="fas fa-check ml-2"></i> ×¡×™×•× ×•×©××™×¨×”
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Details Modal -->
  <div id="details-modal" class="fixed inset-0 z-[170] hidden items-center justify-center sm:p-4 transition-all duration-300">
    <div class="absolute inset-0 bg-slate-900/80 backdrop-blur-sm" id="details-modal-backdrop"></div>
    <div id="details-modal-content" class="modal-content-wrapper relative bg-white w-full sm:max-w-2xl sm:rounded-3xl shadow-2xl flex flex-col max-h-full sm:max-h-[90vh] overflow-hidden">
      <!-- Content Injected via JS -->
    </div>
  </div>

  <!-- Delete Confirm Modal -->
  <div id="delete-confirm-modal" class="fixed inset-0 z-[180] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
    <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-sm w-full relative z-10 animate-bounce-in">
      <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500">
        <i class="fas fa-trash-alt fa-3x"></i>
      </div>
      <h3 id="delete-modal-title" class="text-2xl font-bold text-slate-800 mb-2">××—×™×§×ª ××§×•×</h3>
      <p id="delete-modal-text" class="text-slate-500 mb-8">×”×× ××ª×” ×‘×˜×•×—? ×”×¤×¢×•×œ×” ×”×–×• ×‘×œ×ª×™ ×”×¤×™×›×”.</p>
      <div class="flex justify-center gap-4">
        <button id="delete-modal-cancel" class="flex-1 py-3 bg-slate-100 text-slate-700 font-bold rounded-xl hover:bg-slate-200 transition">×‘×™×˜×•×œ</button>
        <button id="delete-modal-confirm" class="flex-1 py-3 bg-red-500 text-white font-bold rounded-xl hover:bg-red-600 shadow-lg shadow-red-500/30 transition">××—×§ ×œ×ª××™×“</button>
      </div>
    </div>
  </div>

  <!-- Alert Modal -->
  <div id="alert-modal" class="fixed inset-0 z-[190] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm"></div>
    <div class="bg-white rounded-3xl shadow-2xl p-8 text-center max-w-sm w-full relative z-10">
      <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500">
        <i class="fas fa-info fa-2x"></i>
      </div>
      <h3 id="alert-modal-title" class="text-xl font-bold text-slate-800 mb-3">×”×•×“×¢×”</h3>
      <p id="alert-modal-text" class="text-slate-600 mb-6 leading-relaxed"></p>
      <button id="alert-modal-ok" class="py-3 px-8 bg-slate-800 text-white font-bold rounded-xl hover:bg-slate-900 w-full shadow-lg">××™×©×•×¨</button>
    </div>
  </div>

  <!-- Navigation choice -->
  <div id="navigation-choice-modal" class="fixed inset-0 z-[180] hidden items-center justify-center p-4">
    <div class="absolute inset-0 bg-slate-900/70 backdrop-blur-sm" id="nav-backdrop"></div>
    <div class="bg-white rounded-3xl shadow-2xl p-6 text-center max-w-xs w-full relative z-10">
      <button id="navigation-modal-close" class="absolute top-4 right-4 w-8 h-8 bg-slate-50 rounded-full text-slate-400 hover:text-red-500 transition"><i class="fas fa-times"></i></button>
      <h3 class="text-xl font-bold text-slate-800 mb-6 mt-2">×‘×—×¨ ××¤×œ×™×§×¦×™×™×ª × ×™×•×•×˜</h3>
      <div class="space-y-4">
        <a id="nav-link-waze" href="#" target="_blank" class="flex items-center justify-center gap-3 w-full bg-[#33ccff] text-white font-bold py-4 px-5 rounded-2xl hover:brightness-105 transition shadow-lg shadow-cyan-400/20">
          <i class="fa-brands fa-waze fa-xl"></i> Waze
        </a>
        <a id="nav-link-google" href="#" target="_blank" class="flex items-center justify-center gap-3 w-full bg-slate-100 text-slate-700 font-bold py-4 px-5 rounded-2xl hover:bg-slate-200 transition border border-slate-200">
          <i class="fa-brands fa-google fa-xl text-red-500"></i> Google Maps
        </a>
      </div>
    </div>
  </div>

  <!-- JS Modules -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, addDoc, query,
      onSnapshot, serverTimestamp, deleteDoc, updateDoc, setDoc,
      arrayUnion, orderBy, enableIndexedDbPersistence, where, getDocs
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // --- Firebase Config ---
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') console.warn("Persistence failed - multiple tabs open.");
      else if (err.code === 'unimplemented') console.warn("Persistence not supported.");
    });

    // --- State ---
    let currentUser = null;
    let tripId = null;
    let tripData = null;
    let tripHotels = [];
    let allItems = [];
    let activeFilters = {};
    let isInitialLoad = true;
    let currentModalStep = 1;
    let totalModalSteps = 1;
    let editingItemId = null;
    let isRestaurant = false;
    let userLocation = null;
    let lastUsedDestination = null; 
    
    // --- Scroll Locking State ---
    let scrollPosition = 0;

    const photosRepairInFlight = new Set();
    const GOOGLE_MAPS_API_KEY = "AIzaSyAz7QZ2CBpCK_aOVbkqQLjfMRG5taaFs8c";
    let gmapsApiLoaded = false;
    let gmaps_addEditMap = null, gmaps_addEditMarker = null;
    let gmaps_detailsMap = null, gmaps_detailsMarker = null;
    let gmaps_autocompleteService = null, gmaps_placesService = null;
    let selectedGooglePlaceDetails = null;

    const settingsDocRef = doc(db, 'app_settings', 'custom_types');
    const siteData = {
      destinations: [],
      basePlaceTypes: ["××¡×¢×“×”/××•×›×œ","×¡×•×¤×¨","××•×–×™××•×Ÿ","×§× ×™×•×Ÿ/××¨×›×– ×§× ×™×•×ª","××˜×¨×§×¦×™×”","×—×•×£","×¡×™×•×¨"],
      customPlaceTypes: [],
      get placeTypes() { return [...this.basePlaceTypes, ...this.customPlaceTypes]; },
      baseFoodTypes: { "××™×˜×œ×§×™":"ğŸ","×—×œ×‘×™":"ğŸ§€","×‘×©×¨×™":"ğŸ¥©","×¦××—×•× ×™":"ğŸ¥—","××¡×™×™×ª×™":"ğŸœ","×©×•×•××¨××”":"ğŸ¥™","×¤×™×¦×”":"ğŸ•","×”××‘×•×¨×’×¨":"ğŸ”","×‘×™×ª ×§×¤×”":"â˜•" },
      customFoodTypes: {},
      get foodTypes() { return {...this.baseFoodTypes, ...this.customFoodTypes, "××—×¨":"ğŸ´"}; },
      placeTypeEmojis: { "××¡×¢×“×”/××•×›×œ":"ğŸ”","×¡×•×¤×¨":"ğŸ›’","××•×–×™××•×Ÿ":"ğŸ›ï¸","×§× ×™×•×Ÿ/××¨×›×– ×§× ×™×•×ª":"ğŸ›ï¸","××˜×¨×§×¦×™×”":"ğŸ¢","×—×•×£":"ğŸ–ï¸","×¡×™×•×¨":"ğŸš¶â€â™‚ï¸" }
    };

    // --- DOM Elements ---
    const initialLoader = document.getElementById('initial-loader');
    const mainContent = document.getElementById('main-content');
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');
    const mainMenu = document.getElementById('main-menu');
    const backBtn = document.getElementById('back-btn');

    const modal = document.getElementById('item-modal');
    const form = document.getElementById('item-form');
    const openModalBtn = document.getElementById('open-modal-btn');
    const closeModalBtn = document.getElementById('modal-close-btn');
    const nextBtn = document.getElementById('modal-next-btn');
    const backStepBtn = document.getElementById('modal-back-btn');
    const finishBtn = document.getElementById('modal-finish-btn');
    const stepsIndicator = document.getElementById('modal-steps-indicator');
    const progressBar = document.getElementById('step-progress-bar');
    const modalError = document.getElementById('modal-error-message');

    const itemsContainer = document.getElementById('items-container');
    const loadingMessage = document.getElementById('loading-message');
    const getLocationBtn = document.getElementById('get-location-btn');
    const detailsModal = document.getElementById('details-modal');
    const deleteModal = document.getElementById('delete-confirm-modal');
    const authContainer = document.getElementById('auth-container');
    const tripTitleLine = document.getElementById('trip-title-line');
    const navigationModal = document.getElementById('navigation-choice-modal');
    const closeNavigationModalBtn = document.getElementById('navigation-modal-close');

    // --- Utilities ---
    function debounce(func, delay) {
      let timeout;
      return function(...args) {
        clearTimeout(timeout);
        timeout = setTimeout(() => func.apply(this, args), delay);
      };
    }

    // Improved Scroll Lock without jumps
    function lockBodyScroll() {
        scrollPosition = window.pageYOffset;
        document.body.style.overflow = 'hidden';
        document.body.classList.add('modal-locked');
    }

    function unlockBodyScroll() {
        document.body.classList.remove('modal-locked');
        document.body.style.removeProperty('overflow');
        if (Math.abs(window.pageYOffset - scrollPosition) > 5) {
             window.scrollTo({ top: scrollPosition, behavior: 'instant' });
        }
    }

    function toggleSidebar() {
      const isClosed = sidebar.classList.contains('translate-x-full');
      if (isClosed) {
        sidebar.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
        setTimeout(() => overlay.classList.remove('opacity-0'), 10);
        lockBodyScroll();
      } else {
        sidebar.classList.add('translate-x-full');
        overlay.classList.add('opacity-0');
        setTimeout(() => overlay.classList.add('hidden'), 300);
        unlockBodyScroll();
      }
    }

    function showAlert(message, title = '×”×•×“×¢×”') {
      const alertModal = document.getElementById('alert-modal');
      document.getElementById('alert-modal-title').textContent = title;
      document.getElementById('alert-modal-text').innerHTML = message;
      alertModal.classList.remove('hidden');
      alertModal.classList.add('flex');
      lockBodyScroll();

      document.getElementById('alert-modal-ok').onclick = () => {
        alertModal.classList.add('hidden');
        alertModal.classList.remove('flex');
        unlockBodyScroll();
      };
    }

    function calculateDistanceInMeters(loc1, loc2) {
      if (!loc1 || !loc2) return Infinity;
      const R = 6371e3;
      const phi1 = loc1.lat * Math.PI / 180;
      const phi2 = loc2.lat * Math.PI / 180;
      const dPhi = (loc2.lat - loc1.lat) * Math.PI / 180;
      const dLam = (loc2.lng - loc1.lng) * Math.PI / 180;
      const a = Math.sin(dPhi/2)**2 + Math.cos(phi1)*Math.cos(phi2)*Math.sin(dLam/2)**2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
    }

    async function handleGetLocation() {
      return new Promise((resolve, reject) => {
        if (!navigator.geolocation) {
          showAlert("×“×¤×“×¤×Ÿ ×–×” ××™× ×• ×ª×•××š ×‘×©×™×¨×•×ª×™ ××™×§×•×.");
          return reject();
        }
        getLocationBtn.innerHTML = `<i class="fas fa-spinner fa-spin mr-2"></i> ×××ª×¨...`;
        getLocationBtn.disabled = true;
        navigator.geolocation.getCurrentPosition(
          (pos) => {
            userLocation = { lat: pos.coords.latitude, lng: pos.coords.longitude };
            getLocationBtn.innerHTML = `<i class="fas fa-check-circle mr-2"></i> × ××¦×!`;
            setTimeout(() => { 
                getLocationBtn.innerHTML = `<i class="fas fa-location-arrow mr-2"></i> ×× ×™ ×›××Ÿ`;
                getLocationBtn.disabled = false;
            }, 3000);
            resolve(userLocation);
          },
          (err) => {
            console.error(err);
            getLocationBtn.innerHTML = `<i class="fas fa-exclamation-triangle mr-2"></i> ×©×’×™××”`;
            getLocationBtn.disabled = false;
            showAlert("×œ× × ×™×ª×Ÿ ×”×™×” ×œ×§×‘×œ ××ª ××™×§×•××š. ×•×•×“× ×©×”-GPS ×“×œ×•×§ ×•×”××ª×¨ ×××•×©×¨.");
            reject(err);
          },
          { enableHighAccuracy: true, timeout: 10000 }
        );
      });
    }

    function renderStars(rating) {
      if (!rating || typeof rating !== 'number' || rating <= 0) return '';
      let starsHtml = `<div class="rating-stars flex items-center gap-0.5 bg-amber-50 px-2 py-0.5 rounded-full border border-amber-100" title="×“×™×¨×•×’: ${rating.toFixed(1)}">`;
      starsHtml += `<span class="text-amber-500 font-bold text-sm ml-1">${rating.toFixed(1)}</span>`;
      const fullStars = Math.floor(rating);
      const halfStar = rating % 1 >= 0.4;
      starsHtml += `<span class="text-amber-400 text-xs flex">`;
      for(let i = 0; i < fullStars; i++) starsHtml += '<i class="fas fa-star"></i>';
      if(halfStar) starsHtml += '<i class="fas fa-star-half-alt"></i>';
      starsHtml += `</span></div>`;
      return starsHtml;
    }

    // --- Google Maps Logic ---
    function loadGoogleMapsApi() {
      if (window.google && window.google.maps) {
        gmapsApiLoaded = true;
        return Promise.resolve();
      }
      return new Promise((resolve, reject) => {
        const script = document.createElement('script');
        script.src = `https://maps.googleapis.com/maps/api/js?key=${GOOGLE_MAPS_API_KEY}&libraries=places,marker&language=iw&loading=async`;
        script.onload = () => { gmapsApiLoaded = true; resolve(); };
        script.onerror = () => reject(new Error('Google Maps failed to load.'));
        document.head.appendChild(script);
      });
    }

    function gmaps_initAddEditMap(location = { lat: 31.7683, lng: 35.2137 }) { // Default Jerusalem
      const mapDiv = document.getElementById('map-preview');
      if (!mapDiv || !gmapsApiLoaded) return;
      
      requestAnimationFrame(() => {
        if (!gmaps_addEditMap) {
          gmaps_addEditMap = new google.maps.Map(mapDiv, {
            center: location, zoom: 15, mapTypeControl: false, streetViewControl: false,
            gestureHandling: 'cooperative', 
            styles: [ { "featureType": "poi", "elementType": "labels", "stylers": [ { "visibility": "off" } ] } ]
          });
          gmaps_addEditMarker = new google.maps.Marker({
            position: location, map: gmaps_addEditMap, draggable: true,
            animation: google.maps.Animation.DROP
          });
          gmaps_addEditMarker.addListener('dragend', () => {
            const pos = gmaps_addEditMarker.getPosition();
            if (selectedGooglePlaceDetails) {
              selectedGooglePlaceDetails.coords = { lat: pos.lat(), lng: pos.lng() };
            }
          });
          if (!gmaps_autocompleteService) gmaps_autocompleteService = new google.maps.places.AutocompleteService();
          if (!gmaps_placesService) gmaps_placesService = new google.maps.places.PlacesService(gmaps_addEditMap);
        } else {
          gmaps_addEditMap.setCenter(location);
          gmaps_addEditMap.setZoom(15);
          gmaps_addEditMarker.setPosition(location);
          google.maps.event.trigger(gmaps_addEditMap, 'resize');
        }
      });
    }

    function gmaps_initDetailsMap(coords) {
      const mapDiv = document.getElementById('details-map');
      if (!mapDiv || !gmapsApiLoaded) return;
      
      setTimeout(() => {
          if (!gmaps_detailsMap) {
            gmaps_detailsMap = new google.maps.Map(mapDiv, { 
                center: coords, zoom: 16, mapTypeControl: false, disableDefaultUI: true, gestureHandling: 'cooperative' 
            });
            gmaps_detailsMarker = new google.maps.Marker({ position: coords, map: gmaps_detailsMap });
          } else {
            gmaps_detailsMap.setCenter(coords);
            gmaps_detailsMarker.setPosition(coords);
            google.maps.event.trigger(gmaps_detailsMap, 'resize');
          }
      }, 300);
    }

    function initGooglePlacesCustomAutocomplete(inputElement, onSelectCallback) {
      if (!gmapsApiLoaded || !inputElement) return;
      const wrapper = inputElement.closest('.ac-wrapper');
      if (!wrapper) return;
      let list = wrapper.querySelector('.ac-list');
      if (!list) {
        list = document.createElement('div');
        list.className = 'ac-list hidden';
        wrapper.appendChild(list);
      }

      const handleSearch = debounce(async (query) => {
        if (query.length < 2) { list.innerHTML = ''; list.classList.add('hidden'); return; }
        gmaps_autocompleteService.getPlacePredictions({ input: query }, (predictions, status) => {
          list.innerHTML = '';
          if (status !== google.maps.places.PlacesServiceStatus.OK || !predictions) { list.classList.add('hidden'); return; }
          predictions.forEach(prediction => {
            const item = document.createElement('div');
            item.className = 'ac-item';
            item.innerHTML = `
              <div class="bg-cyan-50 text-cyan-500 rounded-full w-8 h-8 flex items-center justify-center flex-shrink-0"><i class="fas fa-map-marker-alt"></i></div>
              <div class="flex-grow min-w-0">
                <div class="font-semibold text-slate-800 truncate">${prediction.structured_formatting.main_text}</div>
                <div class="text-xs text-slate-500 truncate">${prediction.structured_formatting.secondary_text}</div>
              </div>`;
            item.addEventListener('click', () => {
              list.classList.add('hidden');
              inputElement.value = prediction.description; // Temp value
              const request = { placeId: prediction.place_id, fields: ["place_id","name","formatted_address","geometry","website","opening_hours","photos","types","rating"] };
              gmaps_placesService.getDetails(request, (place, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && place) {
                  const details = {
                    placeId: place.place_id || prediction.place_id,
                    name: place.name,
                    location: place.formatted_address,
                    coords: { lat: place.geometry.location.lat(), lng: place.geometry.location.lng() },
                    website: place.website || '',
                    hours: place.opening_hours ? place.opening_hours.weekday_text.join('\n') : '',
                    photos: place.photos ? place.photos.slice(0, 3).map(p => p.getUrl({ maxWidth: 800 })) : [],
                    types: place.types || [],
                    rating: place.rating || null
                  };
                  onSelectCallback(details);
                }
              });
            });
            list.appendChild(item);
          });
          list.classList.remove('hidden');
        });
      }, 400);

      inputElement.addEventListener('input', () => handleSearch(inputElement.value));
      document.addEventListener('click', (e) => { if (!wrapper.contains(e.target)) list.classList.add('hidden'); });
    }

    async function loadCustomSettings() {
      try {
        const snap = await getDoc(settingsDocRef);
        if (snap.exists()) {
          const data = snap.data();
          siteData.customPlaceTypes = data.placeTypes || [];
          if (data.foodTypes) data.foodTypes.forEach(t => { siteData.customFoodTypes[t] = 'ğŸ´'; });
        } else {
          await setDoc(settingsDocRef, { placeTypes: [], foodTypes: [] });
        }
      } catch (e) { console.error('loadCustomSettings', e); }
    }

    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations || !Array.isArray(tripData.destinations)) return;
      siteData.destinations = tripData.destinations.map(d => d.nameHe || d.name || '×™×¢×“');
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        div.className = 'mb-1';
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-4 bg-white hover:bg-cyan-50 rounded-2xl font-bold text-slate-700 flex justify-between items-center shadow-sm border border-slate-100 transition-all';
        btn.innerHTML = `<span class="flex items-center gap-3"><i class="fas fa-map-marked-alt text-cyan-500"></i> ${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down chevron-icon text-slate-400"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-2 mr-4 border-r-2 border-cyan-100 pr-3 space-y-1 hidden';
        if (dest.dates) {
          generateDatesFromRange(dest.dates).forEach(dateStr => {
            const link = document.createElement('a');
            link.href = `daily-schedule.html?id=${tripId}&date=${encodeURIComponent(dateStr)}`;
            link.className = 'block w-full text-right py-2 px-3 text-slate-600 hover:bg-cyan-50 hover:text-cyan-700 rounded-lg transition text-sm font-medium';
            link.innerHTML = `<i class="far fa-calendar-alt ml-2 opacity-50"></i> ×œ×•"×– ×œ×™×•× ${dateStr}`;
            submenu.appendChild(link);
          });
        }
        btn.onclick = () => { 
            submenu.classList.toggle('hidden'); 
            btn.querySelector('.chevron-icon').classList.toggle('rotate-180');
            btn.classList.toggle('bg-cyan-50');
        };
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const [sd, sm, sy] = startStr.split('/').map(Number);
      const [ed, em, ey] = endStr.split('/').map(Number);
      const start = new Date(sy, sm-1, sd);
      const end = new Date(ey, em-1, ed);
      const out = [];
      for (let d = new Date(start); d <= end; d.setDate(d.getDate()+1)) {
        out.push(d.toLocaleDateString('he-IL', { day:'2-digit', month:'2-digit', year:'numeric' }));
      }
      return out;
    }

    // --- Modal Logic ---
    function showModalError(message) {
      modalError.textContent = message || '';
      if (message) setTimeout(() => { modalError.textContent = ''; }, 4000);
    }

    function openModalHandler(itemId = null) {
      editingItemId = itemId;
      selectedGooglePlaceDetails = null;
      form.reset();
      for (let i = 1; i <= 9; i++) {
        const c = document.getElementById(`step-${i}`);
        if (c) c.innerHTML = '';
      }
      const modalTitle = document.getElementById('modal-title');
      const finishButton = document.getElementById('modal-finish-btn');

      if (editingItemId) {
        modalTitle.textContent = '×¢×¨×™×›×ª ××§×•×';
        finishButton.innerHTML = '<i class="fas fa-save ml-2"></i> ×©××•×¨ ×©×™× ×•×™×™×';
        const item = allItems.find(i => i.id === editingItemId);
        isRestaurant = item ? item.type === '××¡×¢×“×”/××•×›×œ' : false;
      } else {
        modalTitle.textContent = '×”×•×¡×¤×ª ××§×•×';
        finishButton.innerHTML = '<i class="fas fa-plus ml-2"></i> ×”×•×¡×£ ×œ×¨×©×™××”';
        isRestaurant = false;
      }

      currentModalStep = 1;
      updateModalView();
      modal.classList.remove('hidden');
      modal.classList.add('flex');
      lockBodyScroll();
    }

    function closeModalHandler() {
      editingItemId = null;
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      showModalError('');
      unlockBodyScroll();
    }

    function updateModalView() {
      const itemTypeEl = document.getElementById('item-type');
      let currentType = '';
      if(itemTypeEl) currentType = itemTypeEl.value;
      else if (editingItemId) {
        const item = allItems.find(i => i.id === editingItemId);
        if (item) currentType = item.type;
      }
      isRestaurant = currentType === '××¡×¢×“×”/××•×›×œ';

      const baseSteps = [1, 2, 3, 4, 5, 6, 7];
      const restaurantSteps = [8, 9];
      let steps = [...baseSteps];
      if (isRestaurant) steps.push(...restaurantSteps);
      steps.sort((a, b) => a - b);
      totalModalSteps = steps.length;

      document.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
      const actualStep = steps[currentModalStep - 1];
      const stepEl = document.getElementById(`step-${actualStep}`);
      if (stepEl) {
        if (!stepEl.innerHTML.trim()) generateStepContent(actualStep);
        stepEl.classList.add('active');

        if (actualStep === 4) {
              setTimeout(() => {
                if(gmaps_addEditMap) google.maps.event.trigger(gmaps_addEditMap, "resize");
                if(gmaps_addEditMarker) gmaps_addEditMap.setCenter(gmaps_addEditMarker.getPosition());
              }, 300);
        }
      }

      backStepBtn.classList.toggle('hidden', currentModalStep === 1);
      nextBtn.classList.toggle('hidden', currentModalStep === totalModalSteps);
      finishBtn.classList.toggle('hidden', currentModalStep !== totalModalSteps);
      stepsIndicator.textContent = `×©×œ×‘ ${currentModalStep} ××ª×•×š ${totalModalSteps}`;
      progressBar.style.width = `${(currentModalStep / totalModalSteps) * 100}%`;
    }

    function handleTypeChange() {
      const other = document.getElementById('item-type-other');
      const typeSelect = document.getElementById('item-type');
      if (other && typeSelect) {
        other.classList.toggle('hidden', typeSelect.value !== '××—×¨');
      }
      document.querySelectorAll('.modal-step').forEach((el) => {
        const stepNum = parseInt(el.id.split('-')[1]);
        if (stepNum > currentModalStep) el.innerHTML = '';
      });
      updateModalView();
    }

    function handleFoodTypeChange() {
      const other = document.getElementById('item-food-type-other');
      const foodTypeSelect = document.getElementById('item-food-type');
      if (other && foodTypeSelect) {
        other.classList.toggle('hidden', foodTypeSelect.value !== '××—×¨');
      }
    }

    function createLocationHtml() {
      return `
        <label class="block text-lg font-bold text-slate-800 mb-2">
          <i class="fa-brands fa-google text-blue-500 ml-2"></i>×—×™×¤×•×© ×‘-Google <span class="text-red-500">*</span>
        </label>
        <div class="ac-wrapper relative">
          <input type="text" id="item-location-search-google" class="form-input w-full p-4 pl-10 shadow-sm" placeholder="×”×§×œ×“ ×©× ××¡×¢×“×”, ××•×–×™××•×Ÿ ××• ×›×ª×•×‘×ª...">
          <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-slate-400"></i>
        </div>
        <div id="map-preview" class="mt-4 border-2 border-slate-200"></div>
        <div id="google-place-filled-msg" class="text-sm font-semibold text-green-700 bg-green-50 p-3 rounded-xl mt-3 hidden flex items-center border border-green-100">
          <i class="fas fa-check-circle ml-2 text-green-500 text-lg"></i>
          <span>×”×¤×¨×˜×™× × ×˜×¢× ×• ××’×•×’×œ! × ×™×ª×Ÿ ×œ×¢×¨×•×š ×œ××˜×”.</span>
        </div>
        <div class="mt-4 p-4 bg-slate-50 rounded-xl border border-slate-100 space-y-3">
          <div>
            <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">×›×ª×•×‘×ª ××“×•×™×™×§×ª</label>
            <input type="text" id="item-location" class="form-input w-full p-2 mt-1 bg-white" readonly>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">×©×¢×•×ª ×¤×ª×™×—×”</label>
              <textarea id="item-hours" class="form-input w-full p-2 mt-1 text-sm" placeholder="×œ××©×œ: ×‘'-×”' 09:00-18:00" rows="2"></textarea>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">××ª×¨ ××™× ×˜×¨× ×˜</label>
              <input type="url" id="item-link" class="form-input w-full p-2 mt-1 text-sm" placeholder="https://...">
            </div>
          </div>
        </div>
      `;
    }

    function generateStepContent(step) {
      const c = document.getElementById(`step-${step}`);
      if (!c) return;

      const item = editingItemId ? allItems.find(i => i.id === editingItemId) : null;
      const label = "block text-lg font-bold text-slate-800 mb-3";

      switch(step) {
        case 1:
          c.innerHTML = `
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-cyan-100 text-cyan-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-store fa-2x"></i>
                </div>
                <h4 class="text-xl font-bold text-slate-700">××™×š ×§×•×¨××™× ×œ××§×•×?</h4>
            </div>
            <input type="text" id="item-name" required class="form-input w-full p-4 text-center text-xl font-bold" placeholder="×œ××©×œ: ××’×“×œ ××™×™×¤×œ" autofocus>`;
          if(item) document.getElementById('item-name').value = item.name || '';
          break;
        case 2:
          c.innerHTML = `
            <div class="text-center mb-6">
                <div class="w-16 h-16 bg-purple-100 text-purple-600 rounded-full flex items-center justify-center mx-auto mb-3">
                    <i class="fas fa-map-marked-alt fa-2x"></i>
                </div>
                <h4 class="text-xl font-bold text-slate-700">×œ××™×–×” ×™×¢×“ ×–×” ×©×™×™×š?</h4>
            </div>
            <select id="item-destination" required class="form-select w-full p-4 text-lg bg-white shadow-sm cursor-pointer">
                ${siteData.destinations.map(d=>`<option value="${d}">ğŸ“ ${d}</option>`).join('')}
            </select>`;
          if(item) document.getElementById('item-destination').value = item.destination || '';
          else if (lastUsedDestination) document.getElementById('item-destination').value = lastUsedDestination;
          break;
        case 3:
          c.innerHTML = `
            <label class="${label}">××” ×¡×•×’ ×”××§×•×? <span class="text-red-500">*</span></label>
            <div class="relative">
                <select id="item-type" required class="form-select w-full p-4 text-lg appearance-none bg-white">
                    ${[...siteData.placeTypes,"××—×¨"].map(o=>`<option value="${o}">${siteData.placeTypeEmojis[o]||'ğŸ“Œ'} ${o}</option>`).join('')}
                </select>
                <i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
            </div>
            <input type="text" id="item-type-other" class="form-input w-full p-3 mt-3 hidden border-dashed border-2" placeholder="×”×’×“×¨ ×¡×•×’ ×—×“×©...">`;
          if(item) document.getElementById('item-type').value = item.type || '';
          handleTypeChange();
          break;
        case 4:
          c.innerHTML = createLocationHtml();
          const searchInput = c.querySelector('#item-location-search-google');
          
          if (item) {
            searchInput.value = item.location || '';
            document.getElementById('item-location').value = item.location || '';
            document.getElementById('item-hours').value = item.hours || '';
            document.getElementById('item-link').value = item.link || '';
          }
          
          gmaps_initAddEditMap(item?.coords);
          
          initGooglePlacesCustomAutocomplete(searchInput, (placeDetails) => {
            document.getElementById('item-location').value = placeDetails.location || '';
            document.getElementById('item-hours').value = placeDetails.hours || '';
            document.getElementById('item-link').value = placeDetails.website || '';
            const nameField = document.getElementById('item-name');
            if (nameField && (!nameField.value || nameField.value.trim()==='')) nameField.value = placeDetails.name;
            gmaps_initAddEditMap(placeDetails.coords);
            selectedGooglePlaceDetails = placeDetails;
            const msg = document.getElementById('google-place-filled-msg');
            if (msg) msg.classList.remove('hidden');
          });

          if (!item) {
            const nameVal = document.getElementById('item-name')?.value;
            if (nameVal) {
                searchInput.value = nameVal;
                setTimeout(() => searchInput.dispatchEvent(new Event('input')), 500);
            }
          }
          break;
        case 5:
          c.innerHTML = `<label class="${label}">×¦×¨×™×š ×œ×”×–××™×Ÿ ××§×•× ××¨××©?</label>
          <div class="grid grid-cols-3 gap-3">
            <label class="cursor-pointer">
                <input type="radio" name="res_radio" value="×œ×" class="peer sr-only" checked>
                <div class="p-3 text-center rounded-xl border-2 border-slate-200 peer-checked:border-green-500 peer-checked:bg-green-50 transition">
                    <i class="fas fa-walking text-2xl mb-1 text-slate-400 peer-checked:text-green-500"></i>
                    <div class="font-bold text-sm">×œ×</div>
                </div>
            </label>
            <label class="cursor-pointer">
                <input type="radio" name="res_radio" value="××•××œ×¥" class="peer sr-only">
                <div class="p-3 text-center rounded-xl border-2 border-slate-200 peer-checked:border-orange-500 peer-checked:bg-orange-50 transition">
                    <i class="fas fa-ticket-alt text-2xl mb-1 text-slate-400 peer-checked:text-orange-500"></i>
                    <div class="font-bold text-sm">××•××œ×¥</div>
                </div>
            </label>
            <label class="cursor-pointer">
                <input type="radio" name="res_radio" value="×›×Ÿ" class="peer sr-only">
                <div class="p-3 text-center rounded-xl border-2 border-slate-200 peer-checked:border-red-500 peer-checked:bg-red-50 transition">
                    <i class="fas fa-calendar-check text-2xl mb-1 text-slate-400 peer-checked:text-red-500"></i>
                    <div class="font-bold text-sm">×—×•×‘×”</div>
                </div>
            </label>
          </div>
          <select id="item-reservation" class="hidden"><option value="×œ×">×œ×</option><option value="×›×Ÿ">×›×Ÿ</option><option value="××•××œ×¥">××•××œ×¥</option></select>
          `;
          
          const radios = document.querySelectorAll('input[name="res_radio"]');
          radios.forEach(r => r.addEventListener('change', () => { document.getElementById('item-reservation').value = r.value; }));
          
          if(item) {
             const val = item.reservation || '×œ×';
             document.getElementById('item-reservation').value = val;
             const r = document.querySelector(`input[name="res_radio"][value="${val}"]`);
             if(r) r.checked = true;
          }
          break;
        case 6:
          c.innerHTML = `<label class="${label}">××©×¤×˜ ××—×¥ (×ª×™××•×¨ ×§×¦×¨)</label><textarea id="item-short-description" class="form-textarea w-full p-4" rows="3" placeholder="×œ××©×œ: ×”×ª×¦×¤×™×ª ×”×›×™ ×™×¤×” ×‘×¢×™×¨ ×‘×©×§×™×¢×”..."></textarea>`;
          if(item) document.getElementById('item-short-description').value = item.shortDescription || '';
          break;
        case 7:
          c.innerHTML = `<label class="${label}">×˜×™×¤×™× ×•××™×“×¢ × ×•×¡×£</label><textarea id="item-description" class="form-textarea w-full p-4" rows="6" placeholder="×›××Ÿ ××¤×©×¨ ×œ×›×ª×•×‘ ×‘××¨×™×›×•×ª ×¢×œ ×”××§×•×, ××—×™×¨×™×, ×“×¨×›×™ ×”×’×¢×” ××•××œ×¦×•×ª ×•×¢×•×“..."></textarea>`;
          if(item) document.getElementById('item-description').value = item.description || '';
          break;
        case 8: // Restaurant only
          c.innerHTML = `<label class="${label}">×”×× ×”××§×•× ×›×©×¨?</label><select id="item-kosher" class="form-select w-full p-4 text-lg"><option value="×œ×">×œ×</option><option value="×›×Ÿ">×›×Ÿ</option></select>`;
          if(item) document.getElementById('item-kosher').value = item.isKosher || '×œ×';
          break;
        case 9: // Restaurant only
          c.innerHTML = `<label class="${label}">×¡×•×’ ×”××˜×‘×—</label><select id="item-food-type" class="form-select w-full p-4 text-lg">${Object.entries(siteData.foodTypes).map(([n,e])=>`<option value="${n}">${e} ${n}</option>`).join('')}</select><input type="text" id="item-food-type-other" class="form-input w-full p-3 mt-3 hidden" placeholder="×”×’×“×¨ ×¡×•×’...">`;
          if(item) {
            const foodSel = document.getElementById('item-food-type');
            const foodOther = document.getElementById('item-food-type-other');
            if (siteData.foodTypes[item.foodType]) foodSel.value = item.foodType;
            else if (item.foodType) { foodSel.value = '××—×¨'; foodOther.value = item.foodType; foodOther.classList.remove('hidden'); }
          }
          break;
      }
      // REMOVED: attachPlainPasteToModalFields call to fix paste bug
    }

    // --- Rendering ---
    function renderAllItems() {
      if (!itemsContainer) return;
      if (allItems.length === 0 && !isInitialLoad) {
        itemsContainer.innerHTML = `
          <div class="text-center p-10 bg-white/10 backdrop-blur-md rounded-3xl shadow-lg border border-white/20 animate-fadeIn">
            <div class="bg-white/20 w-24 h-24 rounded-full flex items-center justify-center mx-auto mb-6">
                <i class="fas fa-umbrella-beach fa-3x text-cyan-200"></i>
            </div>
            <h3 class="text-2xl font-bold text-white mb-2">×”×¨×©×™××” ×¨×™×§×”!</h3>
            <p class="text-cyan-100">×–×” ×”×–××Ÿ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×—×œ×•×...</p>
          </div>`;
        loadingMessage.style.display = 'none';
        return;
      }
      const preserved = {};
      document.querySelectorAll('#items-container details').forEach(d => { if (d.dataset.key) preserved[d.dataset.key]=d.open; });

      itemsContainer.innerHTML = '';
      loadingMessage.style.display='none';

      const groupedByDest = allItems.reduce((acc, item) => {
        const dest = item.destination || '×›×œ×œ×™';
        (acc[dest] ||= []).push(item);
        return acc;
      }, {});

      siteData.destinations.forEach(dest => {
        if (!groupedByDest[dest]) return;

        const destSection = document.createElement('details');
        destSection.className = "group glass-panel rounded-3xl shadow-lg overflow-hidden relative mb-6 transition-all duration-300";
        destSection.open = preserved[dest] || false;
        destSection.dataset.key = dest;
        destSection.innerHTML = `
            <summary class="text-xl md:text-2xl font-bold text-slate-800 flex justify-between items-center p-6 hover:bg-white/40 transition select-none cursor-pointer">
                <span class="flex items-center gap-3">
                    <span class="bg-cyan-100 text-cyan-600 w-10 h-10 rounded-full flex items-center justify-center shadow-sm text-base"><i class="fas fa-map-marker-alt"></i></span> 
                    ${dest}
                </span>
                <i class="fa-solid fa-chevron-down chevron-icon text-slate-400 bg-white/50 w-8 h-8 rounded-full flex items-center justify-center"></i>
            </summary>`;
        
        const contentDiv = document.createElement('div');
        contentDiv.className = 'p-3 sm:p-5 space-y-4 bg-slate-50/50';

        const byType = groupedByDest[dest].reduce((acc, item)=>{ (acc[item.type||'×›×œ×œ×™'] ||= []).push(item); return acc; }, {});
        
        Object.keys(byType).sort().forEach(type => {
          if (!activeFilters[dest]) activeFilters[dest] = {};
          if (!activeFilters[dest][type]) activeFilters[dest][type] = { kosher: false, foodType: '', sortBy: 'default', sortPoint: null, sortMeta: {} };
          const filterState = activeFilters[dest][type];

          const typeSection = document.createElement('details');
          typeSection.className = "bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden";
          typeSection.open = preserved[`${dest}-${type}`] || false;
          typeSection.dataset.key = `${dest}-${type}`;
          const typeIcon = siteData.placeTypeEmojis[type] || 'ğŸ“Œ';
          
          typeSection.innerHTML = `
            <summary class="text-lg font-semibold text-slate-700 flex justify-between items-center p-4 hover:bg-slate-50 transition cursor-pointer">
                <span class="flex items-center gap-2">${typeIcon} ${type} <span class="text-xs bg-slate-100 text-slate-500 px-2 py-0.5 rounded-full ml-2">${byType[type].length}</span></span>
                <i class="fa-solid fa-chevron-down chevron-icon text-slate-300"></i>
            </summary>`;

          const typeContent = document.createElement('div');
          typeContent.className = "p-3 sm:p-4 bg-slate-50 border-t border-slate-100";

          let itemsForType = [...byType[type]];
          
          // Filters UI
          const toolsId = `${dest.replace(/\s/g,'')}-${type.replace(/[\s/]/g,'')}`;
          let filterHtml = `<div class="bg-white p-3 rounded-xl border border-slate-200 mb-4 shadow-sm text-sm">`;
          
          if (type === '××¡×¢×“×”/××•×›×œ') {
            const allFood = [...new Set(groupedByDest[dest].filter(i=>i.type==='××¡×¢×“×”/××•×›×œ').map(i=>i.foodType).filter(Boolean))];
            filterHtml += `
              <div class="flex flex-wrap items-center gap-3 mb-3 pb-3 border-b border-slate-100">
                <div class="flex items-center gap-2 bg-slate-100 px-3 py-1.5 rounded-lg">
                  <input type="checkbox" id="kosher-filter-${toolsId}" data-destination="${dest}" data-type="${type}" class="local-filter-kosher w-4 h-4 text-green-500 rounded focus:ring-green-500" ${filterState.kosher?'checked':''}>
                  <label for="kosher-filter-${toolsId}" class="font-medium text-slate-600 cursor-pointer">×›×©×¨ ×‘×œ×‘×“</label>
                </div>
                <select data-destination="${dest}" data-type="${type}" class="local-filter-food-type form-select text-sm py-1.5 pl-2 pr-8 rounded-lg border-slate-200 bg-slate-50">
                  <option value="">ğŸ´ ×›×œ ×¡×•×’×™ ×”××•×›×œ</option>
                  ${allFood.sort().map(ft=>`<option value="${ft}" ${filterState.foodType===ft?'selected':''}>${siteData.foodTypes[ft]||'ğŸ´'} ${ft}</option>`).join('')}
                </select>
              </div>`;
          }

          const hotelOptions = tripHotels.filter(h => h.coords).map(h => `<option value="${h.id}" ${filterState.sortMeta?.hotelId === h.id ? 'selected' : ''}>ğŸ¨ ${h.name}</option>`).join('');
          filterHtml += `
            <div class="flex flex-wrap items-center gap-2">
               <span class="text-slate-400 font-medium"><i class="fas fa-sort-amount-down"></i></span>
               <select class="sort-by-select form-select text-sm py-1.5 pl-2 pr-8 rounded-lg border-slate-200 bg-slate-50 flex-grow sm:flex-grow-0 min-w-[130px]" data-destination="${dest}" data-type="${type}">
                 <option value="default" ${filterState.sortBy === 'default' ? 'selected' : ''}>×œ×œ× ××™×•×Ÿ</option>
                 <option value="distance_user" ${filterState.sortBy === 'distance_user' ? 'selected' : ''}>×”×›×™ ×§×¨×•×‘ ××œ×™</option>
                 ${tripHotels.length > 0 ? `<option value="distance_hotel" ${filterState.sortBy === 'distance_hotel' ? 'selected' : ''}>××¨×—×§ ×××œ×•×Ÿ...</option>` : ''}
               </select>
               <select class="hotel-sort-select form-select text-sm py-1.5 pl-2 pr-8 rounded-lg border-slate-200 bg-slate-50 flex-grow sm:flex-grow-0 ${filterState.sortBy === 'distance_hotel' ? '' : 'hidden'}" data-destination="${dest}" data-type="${type}">
                 <option value="">×‘×—×¨ ××œ×•×Ÿ...</option>
                 ${hotelOptions}
               </select>
            </div>`;
          filterHtml += `</div>`;
          typeContent.insertAdjacentHTML('afterbegin', filterHtml);

          // Filtering Logic
          if (type === '××¡×¢×“×”/××•×›×œ') {
            if (filterState.kosher) itemsForType = itemsForType.filter(i=>i.isKosher==='×›×Ÿ');
            if (filterState.foodType) itemsForType = itemsForType.filter(i=>i.foodType===filterState.foodType);
          }
          if (filterState.sortBy.startsWith('distance_') && filterState.sortPoint) {
            itemsForType.forEach(item => { item.airDistanceKm = calculateDistanceInMeters(filterState.sortPoint, item.coords) / 1000; });
            itemsForType.sort((a,b)=> (a.airDistanceKm??Infinity) - (b.airDistanceKm??Infinity));
          } else {
            itemsForType.forEach(item => delete item.airDistanceKm);
          }

          // Grid
          const grid = document.createElement('div');
          grid.className = 'grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-4';
          
          if (itemsForType.length === 0) {
            grid.innerHTML = `<div class="col-span-full py-8 text-center text-slate-400 bg-white rounded-xl border border-dashed border-slate-200"><i class="far fa-sad-tear mb-2 text-2xl"></i><p>×œ× × ××¦××• ××§×•××•×ª ×œ×¤×™ ×”×¡×™× ×•×Ÿ.</p></div>`;
          } else {
            itemsForType.forEach((item, index) => {
              const card = document.createElement('div');
              // REMOVED 'group' class to handle click manually
              card.className = 'item-card relative rounded-2xl flex flex-col transition-all duration-300 overflow-hidden item-card-anim transform-gpu';
              card.style.animationDelay = `${index * 50}ms`;
              card.dataset.id = item.id;

              // Image header (Slightly reduced height)
              let imgHeader = '';
              if (item.photos && item.photos.length > 0) {
                  imgHeader = `<div class="h-28 w-full bg-cover bg-center" style="background-image:url('${item.photos[0]}');">
                    <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent"></div>
                  </div>`;
              } else {
                  // Fallback pattern
                  imgHeader = `<div class="h-28 w-full bg-slate-50 flex items-center justify-center relative overflow-hidden">
                    <i class="fas fa-map-marker-alt text-slate-200 text-5xl absolute -bottom-2 -right-2 transform rotate-12"></i>
                  </div>`;
              }

              let badges = '';
              if (item.isKosher==='×›×Ÿ') badges += `<span class="bg-green-100 text-green-700 text-[10px] font-bold px-2 py-0.5 rounded-md shadow-sm">×›×©×¨</span>`;
              if (item.foodType) badges += `<span class="bg-orange-100 text-orange-700 text-[10px] font-bold px-2 py-0.5 rounded-md shadow-sm">${siteData.foodTypes[item.foodType]||''} ${item.foodType}</span>`;
              if (item.reservation && item.reservation!=='×œ×') badges += `<span class="bg-rose-100 text-rose-700 text-[10px] font-bold px-2 py-0.5 rounded-md shadow-sm">×”×–×× ×”: ${item.reservation}</span>`;

              const distInfo = (item.airDistanceKm!==undefined && item.airDistanceKm!==Infinity)
                ? `<div class="absolute top-2 right-2 bg-black/60 backdrop-blur text-white text-xs px-2 py-1 rounded-lg font-bold shadow-sm"><i class="fas fa-location-arrow text-cyan-400 mr-1"></i>${item.airDistanceKm.toFixed(1)} ×§"×</div>` : '';

              const ratingHtml = renderStars(item.rating);

              // REFACTORED CARD CONTENT & BUTTONS (No inline onClicks)
              // Removed grey background from description
              card.innerHTML = `
                ${imgHeader}
                ${distInfo}
                <div class="p-4 flex-grow flex flex-col">
                  <div class="flex justify-between items-start mb-1">
                    <h5 class="text-lg font-bold text-slate-800 leading-tight transition line-clamp-2">${item.name}</h5>
                    <div class="flex-shrink-0 ml-2">${ratingHtml}</div>
                  </div>
                  
                  <div class="flex flex-wrap gap-1.5 mb-2 min-h-[20px]">${badges}</div>
                  
                  ${item.shortDescription ? `<p class="text-sm text-slate-600 line-clamp-2 mb-3 italic">"${item.shortDescription}"</p>` : ''}
                  
                  <div class="mt-auto pt-3 border-t border-slate-50 flex items-center justify-between gap-3 relative z-10">
                      <button class="navigate-btn bg-slate-50 text-cyan-600 hover:bg-cyan-500 hover:text-white rounded-lg px-3 py-1.5 text-sm font-bold flex-1 transition flex items-center justify-center gap-2 ${!item.coords ? 'opacity-50 cursor-not-allowed' : ''}" ${!item.coords ? 'disabled' : ''}>
                        <i class="fas fa-diamond-turn-right"></i> × ×™×•×•×˜
                      </button>
                      <div class="flex gap-2">
                        ${item.link ? `<a href="${item.link}" target="_blank" class="link-btn w-8 h-8 rounded-full bg-slate-50 hover:bg-green-100 text-slate-400 hover:text-green-600 flex items-center justify-center transition" title="××ª×¨"><i class="fas fa-link"></i></a>` : ''}
                        <button class="edit-btn action-btn w-8 h-8 rounded-full bg-slate-50 hover:bg-blue-100 text-slate-400 hover:text-blue-600 flex items-center justify-center transition" title="×¢×¨×™×›×”"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn action-btn w-8 h-8 rounded-full bg-slate-50 hover:bg-red-100 text-slate-400 hover:text-red-600 flex items-center justify-center transition" title="××—×™×§×”"><i class="fas fa-trash-alt"></i></button>
                      </div>
                  </div>
                </div>`;
              grid.appendChild(card);
            });
          }
          typeContent.appendChild(grid);
          typeSection.appendChild(typeContent);
          contentDiv.appendChild(typeSection);
        });
        destSection.appendChild(contentDiv);
        itemsContainer.appendChild(destSection);
      });
    }

    // --- Details & Navigation ---
    function openDetailsModal(itemId) {
      const item = allItems.find(i=>i.id===itemId);
      if (!item) return;
      ensurePhotosForItem(item); 
      const wrap = document.getElementById('details-modal-content');

      let tags = '';
      if (item.isKosher==='×›×Ÿ') tags += `<span class="text-xs font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full border border-green-200 shadow-sm">×›×©×¨</span>`;
      if (item.foodType) tags += `<span class="text-xs font-bold text-orange-700 bg-orange-100 px-3 py-1 rounded-full border border-orange-200 shadow-sm">${siteData.foodTypes[item.foodType]||''} ${item.foodType}</span>`;
      if (item.reservation && item.reservation!=='×œ×') tags += `<span class="text-xs font-bold text-rose-700 bg-rose-100 px-3 py-1 rounded-full border border-rose-200 shadow-sm">×”×–×× ×”: ${item.reservation}</span>`;
      const ratingHtml = renderStars(item.rating);

      let photosHtml = '';
      if (item.photos && item.photos.length > 0) {
        photosHtml = `<div class="grid grid-cols-3 gap-2 mb-4">
          ${item.photos.map(u=>`<div class="aspect-square bg-slate-100 rounded-xl overflow-hidden shadow-sm cursor-pointer hover:opacity-90 transition"><img src="${u}" class="w-full h-full object-cover" loading="lazy" onclick="window.open('${u}','_blank')"></div>`).join('')}
        </div>`;
      }

      const navBtn = item.coords ? `<button data-id="${item.id}" class="navigate-btn flex-1 bg-gradient-to-r from-cyan-500 to-blue-600 text-white font-bold py-3 px-5 rounded-xl hover:shadow-lg hover:scale-[1.02] transition flex items-center justify-center gap-2"><i class="fa-solid fa-diamond-turn-right"></i> × ×•×•×˜ ×œ××§×•×</button>` : '';

      wrap.innerHTML = `
        <div class="relative h-40 bg-slate-200 shrink-0">
           ${item.photos && item.photos[0] ? `<div class="absolute inset-0 bg-cover bg-center" style="background-image:url('${item.photos[0]}')"></div><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div>` : `<div class="absolute inset-0 flex items-center justify-center text-slate-300"><i class="fas fa-image fa-4x"></i></div>`}
           <button id="details-modal-close" class="absolute top-4 left-4 w-9 h-9 bg-white/20 backdrop-blur rounded-full text-white hover:bg-white hover:text-slate-800 transition flex items-center justify-center"><i class="fas fa-times"></i></button>
           <div class="absolute bottom-0 right-0 p-5 text-white w-full">
               <h3 class="text-3xl font-bold font-rubik drop-shadow-md leading-tight">${item.name}</h3>
               <div class="flex items-center gap-3 mt-1 text-sm font-medium opacity-90">
                 <span>${siteData.placeTypeEmojis[item.type]||'ğŸ“Œ'} ${item.type}</span>
                 ${ratingHtml ? `<span class="mx-1">â€¢</span> ${ratingHtml}` : ''}
               </div>
           </div>
        </div>

        <div class="p-5 flex-grow overflow-y-auto space-y-5 bg-white scroll-smooth pb-8 selectable-text">
          ${tags ? `<div class="flex flex-wrap gap-2">${tags}</div>` : ''}
          ${photosHtml}
          
          ${item.shortDescription ? `<div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-l-4 border-blue-400 p-4 rounded-r-xl shadow-sm"><p class="text-slate-800 font-medium italic">"${item.shortDescription}"</p></div>` : ''}
          
          ${item.description ? `<div class="prose prose-slate max-w-none text-slate-600 text-sm whitespace-pre-line leading-relaxed">${item.description}</div>` : ''}
          
          <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100 space-y-3 shadow-inner">
             ${item.location ? `<div class="flex items-start gap-3"><div class="w-6 text-center"><i class="fa-solid fa-location-dot text-red-400"></i></div><p class="text-slate-700 font-medium text-sm flex-1">${item.location}</p></div>` : ''}
             ${item.hours ? `<div class="flex items-start gap-3"><div class="w-6 text-center"><i class="fa-regular fa-clock text-blue-400"></i></div><p class="text-slate-700 text-sm whitespace-pre-wrap flex-1">${item.hours}</p></div>` : ''}
             ${item.link ? `<div class="flex items-start gap-3"><div class="w-6 text-center"><i class="fa-solid fa-globe text-green-400"></i></div><a href="${item.link}" target="_blank" class="text-blue-600 hover:underline text-sm truncate flex-1 block">××¢×‘×¨ ×œ××ª×¨ ×”×‘×™×ª</a></div>` : ''}
          </div>
          
          ${item.coords ? `<div id="details-map" class="w-full h-40 rounded-xl overflow-hidden shadow-md border border-slate-200"></div>` : ''}
        </div>
        
        <div class="p-4 bg-white border-t border-slate-100 flex gap-3 shadow-[0_-5px_15px_rgba(0,0,0,0.03)] pb-safe shrink-0">
          ${navBtn}
          <button data-id="${item.id}" class="edit-btn-modal flex-1 bg-slate-100 text-slate-600 font-bold py-3 px-5 rounded-xl hover:bg-slate-200 transition flex items-center justify-center gap-2"><i class="fas fa-pencil-alt"></i> ×¢×¨×•×š</button>
        </div>
      `;
      detailsModal.classList.remove('hidden');
      detailsModal.classList.add('flex');
      lockBodyScroll();

      document.getElementById('details-modal-close').addEventListener('click', closeDetailsModal, { once:true });
      document.querySelector('.edit-btn-modal').addEventListener('click', (e)=>{ closeDetailsModal(); openModalHandler(e.currentTarget.dataset.id); }, { once:true });
      
      const nBtn = document.querySelector('#details-modal-content .navigate-btn');
      if(nBtn) nBtn.addEventListener('click', (e)=> {
         const it = allItems.find(i=>i.id===e.currentTarget.dataset.id);
         if(it) openNavigationChoiceModal(it);
      });

      if (item.coords) gmaps_initDetailsMap(item.coords);
    }

    function closeDetailsModal() {
      detailsModal.classList.add('hidden');
      detailsModal.classList.remove('flex');
      gmaps_detailsMap = null;
      gmaps_detailsMarker = null;
      unlockBodyScroll();
    }

    function openNavigationChoiceModal(item) {
      if (!item.coords) return;
      const { lat, lng } = item.coords;
      document.getElementById('nav-link-google').href = `https://www.google.com/maps/search/?api=1&query=${lat},${lng}`;
      document.getElementById('nav-link-waze').href = `https://waze.com/ul?ll=${lat},${lng}&navigate=yes`;
      navigationModal.classList.remove('hidden');
      navigationModal.classList.add('flex');
      lockBodyScroll();
    }
    function closeNavigationModal() {
      navigationModal.classList.add('hidden');
      navigationModal.classList.remove('flex');
      unlockBodyScroll();
    }

    // --- Events & Init ---
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);
      if (backBtn) backBtn.addEventListener('click', () => { window.location.href = tripId ? `trip.html?id=${tripId}` : 'index.html'; });

      openModalBtn.addEventListener('click', () => openModalHandler());
      closeModalBtn.addEventListener('click', closeModalHandler);
      document.getElementById('modal-backdrop').addEventListener('click', closeModalHandler);

      nextBtn.addEventListener('click', () => { if (currentModalStep < totalModalSteps) { currentModalStep++; updateModalView(); } });
      backStepBtn.addEventListener('click', () => { if (currentModalStep > 1) { currentModalStep--; updateModalView(); } });

      getLocationBtn.addEventListener('click', handleGetLocation);
      document.getElementById('details-modal-backdrop').addEventListener('click', closeDetailsModal);
      
      closeNavigationModalBtn.addEventListener('click', closeNavigationModal);
      document.getElementById('nav-backdrop').addEventListener('click', closeNavigationModal);

      form.addEventListener('keydown', e => {
        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
          e.preventDefault();
          if (!nextBtn.classList.contains('hidden')) nextBtn.click();
          else if (!finishBtn.classList.contains('hidden')) finishBtn.click();
        }
      });
      form.addEventListener('change', e => {
        if (e.target.id === 'item-type') handleTypeChange();
        if (e.target.id === 'item-food-type') handleFoodTypeChange();
      });

      // FIXED: Centralized Click Handling for Cards and Buttons
      itemsContainer.addEventListener('click', (e) => {
        // First check if it's a specific action button (Delete, Edit, Navigate, Link)
        const actionBtn = e.target.closest('.action-btn, .navigate-btn, .link-btn');
        const card = e.target.closest('.item-card');
        
        // If it is a button inside a card
        if (actionBtn && card) {
           e.stopPropagation(); // Stop event from bubbling to card click
           const id = card.dataset.id;
           const item = allItems.find(i=>i.id===id);
           
           if (actionBtn.matches('.delete-btn')) {
             document.getElementById('delete-modal-title').textContent = `×œ××—×•×§ ××ª "${item?.name}"?`;
             const confirmBtn = document.getElementById('delete-modal-confirm');
             const cancelBtn = document.getElementById('delete-modal-cancel');
             const close = () => { deleteModal.classList.add('hidden'); deleteModal.classList.remove('flex'); unlockBodyScroll(); };
             
             confirmBtn.onclick = async () => {
               try { await deleteDoc(doc(db, 'trips', tripId, 'places', id)); } catch(e){console.error(e);} finally { close(); }
             };
             cancelBtn.onclick = close;
             deleteModal.classList.remove('hidden'); deleteModal.classList.add('flex'); lockBodyScroll();
           } 
           else if (actionBtn.matches('.edit-btn')) {
             openModalHandler(id);
           } 
           else if (actionBtn.matches('.navigate-btn')) {
             if(item) openNavigationChoiceModal(item);
           }
           else if (actionBtn.matches('.link-btn')) {
               // Let default link behavior happen (new tab)
           }
           return; 
        }

        // If it's just the card body (not a button)
        if (card) {
           const id = card.dataset.id;
           openDetailsModal(id);
        }
      });

      // Filter events
      itemsContainer.addEventListener('change', async e => {
        const t = e.target;
        const dest = t.dataset.destination;
        const type = t.dataset.type;
        if (!dest || !type || !activeFilters[dest] || !activeFilters[dest][type]) return;
        const filter = activeFilters[dest][type];

        if (t.matches('.local-filter-kosher')) { filter.kosher = t.checked; renderAllItems(); }
        if (t.matches('.local-filter-food-type')) { filter.foodType = t.value; renderAllItems(); }
        
        if (t.matches('.sort-by-select')) {
          filter.sortBy = t.value;
          if (t.value === 'default') { filter.sortPoint = null; renderAllItems(); }
          else if (t.value === 'distance_user') {
             try { const loc = await handleGetLocation(); filter.sortPoint = loc; } catch { filter.sortBy='default'; }
             renderAllItems();
          } else if (t.value === 'distance_hotel') {
             if (filter.sortMeta?.hotelId) {
                const h = tripHotels.find(x=>x.id===filter.sortMeta.hotelId);
                filter.sortPoint = h ? h.coords : null;
             } else filter.sortPoint=null;
             renderAllItems();
          }
        }
        if (t.matches('.hotel-sort-select')) {
           const hid = t.value;
           if (!hid) { filter.sortPoint=null; filter.sortMeta={}; }
           else {
             const h = tripHotels.find(x=>x.id===hid);
             if(h && h.coords) { filter.sortPoint=h.coords; filter.sortMeta={hotelId:hid, hotelName:h.name}; }
           }
           renderAllItems();
        }
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (currentModalStep !== totalModalSteps) return;
        const gv = id => document.getElementById(id) ? document.getElementById(id).value : null;

        const name = gv('item-name');
        if (!name || name.trim()==='') { showModalError('×—×¡×¨ ×©× ×œ××§×•×'); return; }
        
        // Coords Validation
        let coords = editingItemId ? allItems.find(i=>i.id===editingItemId)?.coords : null;
        let photos = editingItemId ? allItems.find(i=>i.id===editingItemId)?.photos || [] : [];
        let rating = editingItemId ? allItems.find(i=>i.id===editingItemId)?.rating : null;
        let googlePlaceId = editingItemId ? allItems.find(i=>i.id===editingItemId)?.googlePlaceId : null;

        if (selectedGooglePlaceDetails) {
           if(selectedGooglePlaceDetails.photos?.length) photos = [...selectedGooglePlaceDetails.photos];
           if(typeof selectedGooglePlaceDetails.rating==='number') rating = selectedGooglePlaceDetails.rating;
           if(selectedGooglePlaceDetails.placeId) googlePlaceId = selectedGooglePlaceDetails.placeId;
           coords = selectedGooglePlaceDetails.coords;
        } else if (gmaps_addEditMarker && gmaps_addEditMarker.getPosition()) {
           const p = gmaps_addEditMarker.getPosition();
           coords = { lat: p.lat(), lng: p.lng() };
        }

        if (!coords) { showModalError('×—×•×‘×” ×œ×‘×—×•×¨ ××™×§×•× ×‘××¤×” ××• ×‘×—×™×¤×•×©'); return; }

        // Types
        let finalType = gv('item-type');
        if(finalType==='××—×¨') {
           finalType = (gv('item-type-other')||'').trim() || '×›×œ×œ×™';
           if(finalType!=='×›×œ×œ×™' && !siteData.placeTypes.includes(finalType)) {
             await setDoc(settingsDocRef, { placeTypes: arrayUnion(finalType) }, { merge:true });
             siteData.customPlaceTypes.push(finalType);
           }
        }
        let finalFood = isRestaurant ? gv('item-food-type') : null;
        if(isRestaurant && finalFood==='××—×¨') {
           finalFood = (gv('item-food-type-other')||'').trim() || null;
           if(finalFood && !siteData.foodTypes[finalFood]) {
             await setDoc(settingsDocRef, { foodTypes: arrayUnion(finalFood) }, { merge:true });
             siteData.customFoodTypes[finalFood]='ğŸ´';
           }
        }
        
        const destValue = gv('item-destination');
        lastUsedDestination = destValue;

        const data = {
          name, destination: destValue, type: finalType,
          shortDescription: gv('item-short-description'), description: gv('item-description'),
          isKosher: isRestaurant?gv('item-kosher'):null, foodType: finalFood,
          location: gv('item-location'), hours: gv('item-hours'), link: gv('item-link'),
          reservation: gv('item-reservation'), author: currentUser.uid,
          coords, photos, rating, googlePlaceId: googlePlaceId || null
        };

        try {
          if (editingItemId) await updateDoc(doc(db, 'trips', tripId, 'places', editingItemId), { ...data, updatedAt: serverTimestamp() });
          else await addDoc(collection(db, 'trips', tripId, 'places'), { ...data, createdAt: serverTimestamp() });
          closeModalHandler();
        } catch (err) { console.error(err); showModalError('×©×’×™××” ×‘×©××™×¨×”'); }
      });
    }

    // --- Self Healing ---
    async function ensurePhotosForItem(item) {
       try {
         if (!gmapsApiLoaded || !item.googlePlaceId || (item.photos?.length) || photosRepairInFlight.has(item.id)) return;
         if (!gmaps_placesService) gmaps_placesService = new google.maps.places.PlacesService(document.createElement('div'));
         
         photosRepairInFlight.add(item.id);
         gmaps_placesService.getDetails({ placeId: item.googlePlaceId, fields: ["photos","rating"] }, async (place, status) => {
           photosRepairInFlight.delete(item.id);
           if (status === google.maps.places.PlacesServiceStatus.OK && place && place.photos?.length) {
             const newPhotos = place.photos.slice(0,3).map(p => p.getUrl({ maxWidth: 800 }));
             await updateDoc(doc(db, 'trips', tripId, 'places', item.id), {
               photos: newPhotos, rating: (typeof place.rating==='number'?place.rating:(item.rating||null)), updatedAt: serverTimestamp()
             });
           }
         });
       } catch(e) { photosRepairInFlight.delete(item?.id); }
    }

    // --- Boot ---
    function listenPlaces() {
      const qRef = query(collection(db, 'trips', tripId, 'places'), orderBy('createdAt','desc'));
      onSnapshot(qRef, (snap) => {
        const newItems = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // preserve calc distances
        newItems.forEach(n => { const old = allItems.find(i=>i.id===n.id); if(old?.airDistanceKm) n.airDistanceKm = old.airDistanceKm; });
        allItems = newItems;
        renderAllItems();
        allItems.forEach(it => ensurePhotosForItem(it));

        if (isInitialLoad) {
           isInitialLoad = false;
           initialLoader.style.opacity = '0';
           mainContent.style.opacity = '1';
           setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
        }
      }, (err) => { console.error(err); loadingMessage.textContent = "×©×’×™××” ×‘×˜×¢×™× ×ª ×”××™×“×¢."; });
    }

    async function loadTripHotels() {
      if (!tripId) return;
      try {
        const snap = await getDocs(query(collection(db, 'trips', tripId, 'logistics'), where("type", "==", "hotel")));
        tripHotels = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      } catch (e) { console.error(e); tripHotels = []; }
    }

    async function initPage() {
      const urlParams = new URLSearchParams(window.location.search);
      tripId = urlParams.get('id') || urlParams.get('tripId');
      if (!tripId) { showAlert("×œ× × ××¦× ×˜×™×•×œ", "×©×’×™××”"); setTimeout(() => location.href='index.html', 2000); return; }

      const sBtn = document.getElementById('smart-route-btn');
      if (sBtn) sBtn.href = `edit-trip?id=${tripId}`;

      try { await loadGoogleMapsApi(); } catch (e) { console.error(e); showAlert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”××¤×•×ª"); }

      attachEvents();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-bold text-slate-700 hidden sm:block bg-white/50 px-3 py-1 rounded-full backdrop-blur">ğŸ‘‹ ${displayName}</span><button id="sign-out-btn" class="w-9 h-9 flex items-center justify-center rounded-full bg-red-50 text-red-500 hover:bg-red-500 hover:text-white transition shadow-sm ml-2"><i class="fas fa-sign-out-alt"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        const tripSnap = await getDoc(doc(db, 'trips', tripId));
        if (tripSnap.exists()) {
           const data = tripSnap.data();
           if (data.editors && data.editors.includes(currentUser.uid)) {
             tripData = data;
             if (tripTitleLine && tripData.name) tripTitleLine.innerHTML = `<span class="font-rubik text-slate-600">××ª×›× × ×™× ××ª:</span> <span class="font-bold text-transparent bg-clip-text bg-gradient-to-r from-cyan-600 to-blue-600">${tripData.name}</span>`;
             await Promise.all([loadTripHotels(), loadCustomSettings()]);
             buildMenuFromTrip();
             listenPlaces();
           } else { showAlert('××™×Ÿ ×’×™×©×”'); setTimeout(() => location.href='index.html', 2000); }
        } else { showAlert('×”×˜×™×•×œ ×œ× × ××¦×'); setTimeout(() => location.href='index.html', 2000); }
      });
    }

    if ('serviceWorker' in navigator) { window.addEventListener('load', () => navigator.serviceWorker.register('/service-worker.js').catch(()=>{})); }

    initPage();
  </script>
</body>
</html>