<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ייצוא סיכום טיול ל-PDF</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- ספרייה ליצירת PDF מ-HTML -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <style>
        body { font-family: 'Assistant', sans-serif; }
        .export-btn { transition: all 0.3s ease; }
        .export-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Styles for the hidden report content to be exported */
        @media print {
            .page-break { page-break-before: always; }
        }
        #report-content .page {
            page-break-after: always;
            padding: 20mm;
            box-sizing: border-box;
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- This hidden div will be used to render the report before exporting -->
    <div id="report-container" class="hidden fixed -left-[9999px] top-0 bg-white text-black" style="width: 210mm;">
        <div id="report-content"></div>
    </div>

    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/IrS6mDW.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/60"></div>
    
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה לדף הטיול">
                            <i class="fas fa-arrow-left fa-lg"></i>
                        </a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">ייצוא סיכום טיול</h1>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
                <i class="fas fa-file-export fa-3x text-blue-500 mb-4"></i>
                <h2 id="export-title" class="text-3xl font-extrabold text-slate-800">הפקת סיכום הטיול</h2>
                <p class="text-slate-600 mt-2 mb-8">לחץ על הכפתור כדי ליצור קובץ PDF מסודר עם כל פרטי הטיול, מוכן להדפסה או שמירה.</p>

                <div class="flex gap-4 justify-center">
                    <button id="generate-pdf-btn" class="export-btn w-full sm:w-auto bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-pdf mr-2"></i> צור קובץ PDF
                    </button>
                </div>

                <div id="status-container" class="mt-8 min-h-[60px] flex flex-col items-center justify-center">
                    <div id="loader" class="loader hidden"></div>
                    <p id="status-message" class="text-slate-500 font-semibold"></p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- DOM Elements ---
        const DOM = {
            loader: document.getElementById('loader'),
            statusMessage: document.getElementById('status-message'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            pageTitle: document.getElementById('page-title'),
            exportTitle: document.getElementById('export-title'),
            reportContent: document.getElementById('report-content'),
        };

        // --- State ---
        let tripId = null;
        let isGenerating = false;

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                alert("שגיאה: לא נמצא מזהה טיול.");
                window.location.href = 'index.html';
                return;
            }

            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const tripRef = doc(db, "trips", tripId);
                    const tripSnap = await getDoc(tripRef);
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.data();
                        if (!tripData.editors?.includes(user.uid)) {
                            alert("אין לך הרשאה לצפות בטיול זה.");
                            window.location.href = 'index.html';
                        }
                        DOM.pageTitle.textContent += ` - ${tripData.name}`;
                        DOM.exportTitle.textContent += ` "${tripData.name}"`;
                    } else {
                        alert("הטיול לא נמצא.");
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        function setStatus(message, showLoader = false) {
            DOM.statusMessage.textContent = message;
            DOM.loader.classList.toggle('hidden', !showLoader);
            isGenerating = showLoader;
            DOM.generatePdfBtn.disabled = isGenerating;
        }

        // --- Data Fetching ---
        async function fetchAllTripData() {
            setStatus('שלב 1/3: טוען נתונים מהשרת...', true);

            const tripRef = doc(db, 'trips', tripId);
            const collectionsToFetch = ['logistics', 'places', 'checklists', 'schedules'];

            const [tripSnap, ...collectionsSnaps] = await Promise.all([
                getDoc(tripRef),
                ...collectionsToFetch.map(c => getDocs(query(collection(db, 'trips', tripId, c), orderBy('createdAt'))))
            ]);

            const allData = {
                tripData: tripSnap.data(),
                logistics: collectionsSnaps[0].docs.map(d => ({ id: d.id, ...d.data() })),
                places: collectionsSnaps[1].docs.map(d => ({ id: d.id, ...d.data() })),
                checklists: collectionsSnaps[2].docs.map(d => ({ id: d.id, ...d.data() })),
                schedules: []
            };

            const scheduleDocs = collectionsSnaps[3].docs;
            for (const scheduleDoc of scheduleDocs) {
                const dayData = { id: scheduleDoc.id, ...scheduleDoc.data() };
                const itemsQuery = query(collection(scheduleDoc.ref, 'items'), orderBy('sort'));
                dayData.items = (await getDocs(itemsQuery)).docs.map(d => d.data());
                allData.schedules.push(dayData);
            }
            
            allData.schedules.sort((a,b) => a.id.localeCompare(b.id));
            return allData;
        }

        // --- Document Generation Orchestrator ---
        async function generatePdf() {
            if (isGenerating) return;
            
            try {
                const allData = await fetchAllTripData();
                
                setStatus('שלב 2/3: בונה את המסמך...', true);
                buildHtmlReport(allData);

                setStatus('שלב 3/3: מייצא לקובץ PDF...', true);
                const element = DOM.reportContent;
                const opt = {
                    margin: 10,
                    filename: `trip_summary_${tripId}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, useCORS: true, logging: false },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                };
                
                await html2pdf().set(opt).from(element).save();
                
                setStatus('ההורדה הושלמה!', false);
            } catch (error) {
                console.error(`Error generating PDF:`, error);
                setStatus(`שגיאה ביצירת הקובץ: ${error.message}`, false);
            } finally {
                DOM.reportContent.innerHTML = ''; // Clean up
            }
        }
        
        // --- Helper: Date Formatting ---
        function formatISODate(isoDate) {
            if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return isoDate || '';
            const [year, month, day] = isoDate.split('-');
            const dateObj = new Date(year, month - 1, day);
            const weekday = dateObj.toLocaleDateString('he-IL', { weekday: 'long', timeZone: 'UTC' });
            return `${weekday}, ${day}/${month}/${year}`;
        }
        
        // --- HTML Report Builder ---
        function buildHtmlReport(data) {
            let html = '';

            // 1. Cover Page
            html += `
                <div class="page flex flex-col items-center justify-center text-center" style="height: 277mm;">
                    <h1 class="text-5xl font-extrabold mb-8">${data.tripData.name}</h1>
                    <p class="text-2xl text-gray-600">סיכום טיול</p>
                    <p class="text-xl text-gray-500 mt-4">תאריכים: ${data.tripData.startDate} - ${data.tripData.endDate}</p>
                </div>`;

            // 2. Logistics Summary
            if (data.logistics.length > 0) {
                html += `
                    <div class="page">
                        <h2 class="text-3xl font-bold mb-6 border-b pb-2">סיכום לוגיסטיקה</h2>
                        <table class="w-full text-right border-collapse">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 border">תיאור</th>
                                    <th class="p-3 border">יעד/תאריכים</th>
                                    <th class="p-3 border">מחיר</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.logistics.map(item => `
                                    <tr class="hover:bg-gray-50">
                                        <td class="p-3 border">${item.name || item.type}</td>
                                        <td class="p-3 border">${item.destination || item.dates || ''}</td>
                                        <td class="p-3 border">$${(item.price || item.price_per_person || 0).toLocaleString()}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>`;
            }

            // 3. Daily Schedule
            data.schedules.forEach(day => {
                html += `
                    <div class="page">
                        <h2 class="text-3xl font-bold mb-6 border-b pb-2">${formatISODate(day.id)}</h2>
                        <div class="space-y-6">
                            ${day.items.map(item => `
                                <div class="p-4 bg-gray-50 rounded-lg">
                                    <p class="text-lg font-bold">${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''} - ${item.title}</p>
                                    ${item.summary ? `<p class="mt-2 text-gray-700 pl-4 border-r-4 border-blue-300">${item.summary}</p>` : ''}
                                    ${(item.refs && item.refs.length > 0) ? `
                                        <div class="mt-3 text-sm text-gray-600 space-y-1">
                                            ${item.refs.map(ref => {
                                                const source = ref.type === 'logistics' ? data.logistics : data.places;
                                                const fullItem = source.find(s => s.id === ref.id);
                                                if (!fullItem) return '';
                                                let refText = `<strong>פרטים:</strong> ${fullItem.name}. `;
                                                if (fullItem.location || fullItem.address) refText += `<strong>כתובת:</strong> ${fullItem.location || fullItem.address}.`;
                                                return `<div>${refText}</div>`;
                                            }).join('')}
                                        </div>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
            });
            
            // 4. Checklists
            if (data.checklists.length > 0) {
                html += `
                    <div class="page">
                        <h2 class="text-3xl font-bold mb-6 border-b pb-2">רשימות ציוד</h2>
                        ${data.checklists.map(list => `
                            <div class="mb-8">
                                <h3 class="text-xl font-semibold mb-3">${list.name}</h3>
                                <ul class="list-none space-y-2">
                                    ${list.items.map(item => `
                                        <li class="flex items-center gap-3">
                                            <span class="w-5 h-5 border-2 border-gray-400 rounded"></span>
                                            <span>${item.text} (כמות: ${item.quantity})</span>
                                        </li>
                                    `).join('')}
                                </ul>
                            </div>
                        `).join('')}
                    </div>`;
            }
            
            DOM.reportContent.innerHTML = html;
        }


        // --- Event Listeners ---
        DOM.generatePdfBtn.addEventListener('click', generatePdf);

        // --- Start the App ---
        initPage();
    </script>
</body>
</html>

