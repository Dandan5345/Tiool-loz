<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>ייצוא סיכום טיול</title>

    <!-- UI Frameworks & Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <style>
        /* --- General Setup --- */
        :root { 
            --safe-pad: env(safe-area-inset-bottom, 0px); 
            --primary-color: #0ea5e9; /* sky-500 */
            --bg-color: #f8fafc;
        }
        
        * { -webkit-tap-highlight-color: transparent; }
        
        html, body { height: 100%; margin: 0; padding: 0; }
        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: var(--bg-color);
            color: #1e293b;
            overflow-x: hidden;
        }

        /* --- UI Components --- */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.1);
        }

        .action-btn { 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            position: relative;
            overflow: hidden;
        }
        .action-btn:active { transform: scale(0.96); }
        .action-btn::after {
            content: "";
            position: absolute;
            top: 50%; left: 50%;
            width: 300%; height: 300%;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%) scale(0);
            transition: transform 0.5s;
        }
        .action-btn:active::after { transform: translate(-50%, -50%) scale(1); }

        /* Toggle Switch Styling */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #0ea5e9;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #0ea5e9;
        }
        .toggle-checkbox:checked + .toggle-label:before {
            transform: translateX(100%);
        }
        
        .loader { border: 3px solid #f3f3f3; border-top: 3px solid #0ea5e9; border-radius: 50%; width: 32px; height: 32px; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Report Specific Styles (Preview & Print) --- */
        #preview-wrapper { background-color: #cbd5e1; min-height: 100vh; padding-bottom: 80px; }
        
        .report-page {
            width: 210mm; min-height: 297mm; padding: 15mm; margin: 20px auto; 
            background: white; position: relative;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            color: #1e293b; font-size: 11pt; line-height: 1.5;
            direction: rtl;
        }

        .page-break { page-break-before: always; }
        .section-title { 
            font-family: 'Rubik', sans-serif;
            font-size: 24pt; font-weight: 700; color: #0f172a; 
            border-bottom: 4px solid #38bdf8; padding-bottom: 10px; margin-bottom: 25px; margin-top: 10px;
            display: flex; align-items: center; gap: 15px; 
        }
        
        /* Cards in Report */
        .info-card { 
            background-color: #fff; 
            border: 1px solid #e2e8f0; 
            border-radius: 12px; 
            padding: 16px; margin-bottom: 16px; 
            break-inside: avoid; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-right: 5px solid #cbd5e1;
        }
        
        /* Transport Colors */
        .transport-flight { border-right-color: #0ea5e9; background-color: #f0f9ff; }
        .transport-ride { border-right-color: #10b981; background-color: #ecfdf5; }
        .transport-ferry { border-right-color: #3b82f6; background-color: #eff6ff; }
        .transport-train { border-right-color: #f97316; background-color: #fff7ed; }
        .transport-car_rental { border-right-color: #8b5cf6; background-color: #f5f3ff; }
        .hotel-card { border-right-color: #f43f5e; }

        .card-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px 20px; }
        .detail-item { display: flex; align-items: flex-start; gap: 8px; font-size: 10.5pt; }
        .detail-item i { color: #64748b; width: 20px; text-align: center; margin-top: 4px; font-size: 0.9em; }
        .detail-item .value { font-weight: 600; color: #334155; }
        
        /* Maps */
        .map-container { 
            height: 300px; width: 100%; 
            border-radius: 12px; overflow: hidden; 
            border: 1px solid #e2e8f0; margin: 15px 0; 
            z-index: 1; background: #e2e8f0;
            break-inside: avoid;
        }

        /* --- Utilities --- */
        .rtl-force { direction: rtl; unicode-bidi: isolate; }
        .ltr-force { direction: ltr; unicode-bidi: bidi-override; text-align: left; }

        /* --- Responsive Mobile --- */
        @media screen and (max-width: 768px) {
            .report-page { width: 100%; margin: 0; border-radius: 0; box-shadow: none; padding: 20px 15px; min-height: auto; }
            .card-grid { grid-template-columns: 1fr; }
            .cover-page h1 { font-size: 32pt; }
        }

        /* --- PRINT MODAL & STYLES --- */
        @media print {
            @page { size: A4; margin: 0; }
            body { background: white; -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            body > *:not(#preview-wrapper) { display: none !important; }
            #preview-wrapper { display: block !important; background: white !important; padding: 0 !important; margin: 0 !important; }
            .report-page { width: 100% !important; margin: 0 !important; box-shadow: none !important; padding: 10mm !important; page-break-after: always; }
            .report-page:last-child { page-break-after: auto; }
            
            /* Hide buttons during print */
            #floating-action-btn, #print-modal { display: none !important; }
            
            .map-container { border: 1px solid #ccc; }
        }
    </style>
</head>
<body>

    <!-- Screen 1: Configuration -->
    <div id="main-content" class="min-h-screen flex flex-col relative">
        <!-- Background Image -->
        <div class="fixed inset-0 -z-10 bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1469854523086-cc02fe5d8800?q=80&w=2021&auto=format&fit=crop');"></div>
        <div class="fixed inset-0 -z-10 bg-slate-900/70 backdrop-blur-[2px]"></div>

        <!-- Navbar -->
        <header class="sticky top-0 z-30 px-4 py-3 flex items-center gap-3 text-white">
            <a id="back-to-trip-btn" href="#" class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center hover:bg-white/30 transition">
                <i class="fas fa-arrow-right text-lg"></i>
            </a>
            <h1 class="text-lg font-bold text-shadow">ייצוא סיכום טיול</h1>
        </header>

        <!-- Config Card -->
        <main class="flex-grow flex items-center justify-center p-4">
            <div class="glass-panel w-full max-w-md rounded-3xl p-6 sm:p-8 text-center animate-fade-in-up">
                <div class="w-16 h-16 bg-sky-100 rounded-2xl flex items-center justify-center mx-auto mb-4 text-sky-600 shadow-sm">
                    <i class="fas fa-file-pdf text-3xl"></i>
                </div>
                
                <h2 id="export-title" class="text-2xl font-bold text-slate-800 mb-2">הפקת מסמך טיול</h2>
                <p class="text-slate-500 text-sm mb-8">בחר את המידע שברצונך לכלול ב-PDF</p>

                <!-- Toggles Grid -->
                <div class="grid grid-cols-1 gap-4 mb-8 text-right">
                    
                    <!-- Toggle Item -->
                    <div class="flex items-center justify-between bg-white/60 p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center"><i class="fas fa-map-marked-alt"></i></div>
                            <span class="font-semibold text-slate-700">מפות מסלול</span>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="include-maps-checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="include-maps-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between bg-white/60 p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fas fa-umbrella-beach"></i></div>
                            <span class="font-semibold text-slate-700">אטרקציות</span>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="include-attractions-checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="include-attractions-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between bg-white/60 p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-amber-100 text-amber-600 flex items-center justify-center"><i class="fas fa-calendar-alt"></i></div>
                            <span class="font-semibold text-slate-700">לו"ז יומי</span>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="include-schedule-checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="include-schedule-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>

                    <div class="flex items-center justify-between bg-white/60 p-4 rounded-2xl border border-slate-100 shadow-sm">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-pink-100 text-pink-600 flex items-center justify-center"><i class="fas fa-clipboard-check"></i></div>
                            <span class="font-semibold text-slate-700">צ'קליסטים</span>
                        </div>
                        <div class="relative inline-block w-12 mr-2 align-middle select-none transition duration-200 ease-in">
                            <input type="checkbox" name="toggle" id="include-checklists-checkbox" checked class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/>
                            <label for="include-checklists-checkbox" class="toggle-label block overflow-hidden h-6 rounded-full bg-slate-300 cursor-pointer"></label>
                        </div>
                    </div>
                </div>

                <button id="start-preview-btn" class="action-btn w-full bg-sky-500 hover:bg-sky-600 text-white font-bold py-4 rounded-xl shadow-lg shadow-sky-500/30 flex items-center justify-center gap-2 text-lg">
                    <span>הצג תצוגה מקדימה</span>
                    <i class="fas fa-arrow-left"></i>
                </button>

                <div id="status-container" class="mt-4 h-6">
                    <p id="status-message" class="text-slate-500 text-sm font-medium"></p>
                </div>
            </div>
        </main>
    </div>

    <!-- Screen 2: Preview Area -->
    <div id="preview-wrapper" class="hidden">
        <!-- Top Bar for Preview -->
        <div class="bg-slate-800 text-white px-4 py-3 flex items-center justify-between sticky top-0 z-50 shadow-md">
            <button id="close-preview-btn" class="text-slate-300 hover:text-white flex items-center gap-2">
                <i class="fas fa-times"></i> חזור לעריכה
            </button>
            <span class="font-bold text-sm">תצוגה מקדימה</span>
        </div>

        <div id="preview-container" class="pb-20"></div>
        
        <!-- Floating Print Button -->
        <button id="floating-action-btn" class="action-btn fixed bottom-6 left-6 bg-rose-500 hover:bg-rose-600 text-white w-16 h-16 rounded-full shadow-2xl shadow-rose-500/40 z-[80] flex items-center justify-center border-4 border-white/20" title="הדפסה">
            <i class="fas fa-print text-2xl"></i>
        </button>
    </div>

    <!-- Print Modal -->
    <div id="print-modal" class="hidden fixed inset-0 z-[100] flex items-end sm:items-center justify-center bg-black/60 backdrop-blur-sm transition-opacity duration-300">
        <div class="bg-white w-full sm:w-[450px] sm:rounded-3xl rounded-t-3xl p-6 shadow-2xl animate-slide-up">
            
            <!-- Header -->
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-slate-800">שמירת הטיול כ-PDF</h3>
                <button id="close-modal-btn" class="w-8 h-8 rounded-full bg-slate-100 text-slate-500 flex items-center justify-center hover:bg-slate-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- Content -->
            <div id="modal-content-wrapper">
                <div class="bg-sky-50 p-4 rounded-xl border border-sky-100 mb-6 flex gap-3">
                    <i class="fas fa-info-circle text-sky-500 mt-1"></i>
                    <div class="text-sm text-slate-700">
                        <p class="font-bold mb-1">כיצד לשמור בנייד?</p>
                        <p>במסך הבא, לחץ על אייקון <strong>השיתוף</strong> ואז בחר <strong>"שמור בקבצים"</strong> או "הדפס".</p>
                    </div>
                </div>

                <button id="trigger-print-btn" class="action-btn w-full bg-rose-500 text-white py-4 rounded-xl font-bold text-lg shadow-lg shadow-rose-500/25 mb-3">
                    <i class="fas fa-print ml-2"></i> פתח מסך הדפסה
                </button>
                <p class="text-xs text-center text-slate-400">עובד גם באייפון וגם באנדרואיד</p>
            </div>

            <!-- Loader State -->
            <div id="modal-loader" class="hidden py-8 text-center">
                <div class="loader mx-auto mb-4"></div>
                <p class="font-bold text-slate-700">מכין להדפסה...</p>
                <p class="text-sm text-slate-500">מסדר את המפות לדף A4</p>
            </div>
        </div>
    </div>

    <style>
        @keyframes slide-up { from { transform: translateY(100%); } to { transform: translateY(0); } }
        .animate-slide-up { animation: slide-up 0.3s ease-out forwards; }
    </style>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(console.warn);

        // UI References
        const DOM = {
            mainContent: document.getElementById('main-content'),
            previewWrapper: document.getElementById('preview-wrapper'),
            previewContainer: document.getElementById('preview-container'),
            startBtn: document.getElementById('start-preview-btn'),
            closePreviewBtn: document.getElementById('close-preview-btn'),
            floatPrintBtn: document.getElementById('floating-action-btn'),
            printModal: document.getElementById('print-modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            triggerPrintBtn: document.getElementById('trigger-print-btn'),
            statusMsg: document.getElementById('status-message'),
            inputs: {
                maps: document.getElementById('include-maps-checkbox'),
                attr: document.getElementById('include-attractions-checkbox'),
                sched: document.getElementById('include-schedule-checkbox'),
                list: document.getElementById('include-checklists-checkbox')
            }
        };

        let tripId = null;
        let tripDataCache = null;
        let mapInstances = [];

        // --- Initialization ---
        function init() {
            const params = new URLSearchParams(window.location.search);
            tripId = params.get('tripId');
            
            if(!tripId) {
                alert("שגיאה: לא זוהה טיול. מועבר לדף הבית.");
                window.location.href = 'index.html';
                return;
            }

            document.getElementById('back-to-trip-btn').href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if(user) {
                    loadTripData(user.uid);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData(uid) {
            DOM.statusMsg.textContent = "טוען נתונים...";
            try {
                const docRef = doc(db, "trips", tripId);
                const snap = await getDoc(docRef);
                
                if(snap.exists()) {
                    const data = snap.data();
                    if(data.owner === uid || (data.editors && data.editors.includes(uid))) {
                        document.getElementById('export-title').textContent = `הפקת מסמך: ${data.name}`;
                        DOM.statusMsg.textContent = "";
                    } else {
                        alert("אין לך הרשאות לצפות בטיול זה");
                        window.location.href = 'index.html';
                    }
                }
            } catch(e) {
                console.error(e);
                DOM.statusMsg.textContent = "שגיאה בטעינת נתונים";
            }
        }

        // --- Data Fetching Logic ---
        async function fetchAllData() {
            if(tripDataCache) return tripDataCache;

            DOM.startBtn.innerHTML = `<div class="loader w-6 h-6 border-2"></div> טוען...`;
            DOM.startBtn.disabled = true;

            try {
                const tripRef = doc(db, 'trips', tripId);
                
                // Fetch Main Trip + Collections in parallel
                const [tripSnap, logisticsSnap, placesSnap, checklistsSnap, notesSnap, schedSnap] = await Promise.all([
                    getDoc(tripRef),
                    getDocs(query(collection(db, 'trips', tripId, 'logistics'), orderBy('createdAt'))),
                    getDocs(query(collection(db, 'trips', tripId, 'places'), orderBy('createdAt'))),
                    getDocs(query(collection(db, 'trips', tripId, 'checklists'), orderBy('createdAt'))),
                    getDocs(query(collection(db, 'trips', tripId, 'notes'), orderBy('createdAt'))),
                    getDocs(query(collection(db, 'trips', tripId, 'schedules')))
                ]);

                // Process Schedule Sub-collections
                const schedules = [];
                for(const d of schedSnap.docs) {
                    const day = { id: d.id, ...d.data() };
                    const [items, dayNotes] = await Promise.all([
                        getDocs(query(collection(d.ref, 'items'), orderBy('sort'))),
                        getDocs(query(collection(d.ref, 'notes'), orderBy('createdAt')))
                    ]);
                    day.items = items.docs.map(x => x.data());
                    day.notes = dayNotes.docs.map(x => x.data());
                    schedules.push(day);
                }
                schedules.sort((a,b) => a.id.localeCompare(b.id));

                tripDataCache = {
                    trip: tripSnap.data(),
                    logistics: logisticsSnap.docs.map(d => ({id: d.id, ...d.data()})),
                    places: placesSnap.docs.map(d => ({id: d.id, ...d.data()})),
                    checklists: checklistsSnap.docs.map(d => ({id: d.id, ...d.data()})),
                    notes: notesSnap.docs.map(d => ({id: d.id, ...d.data()})),
                    schedules
                };
                
                return tripDataCache;

            } catch (error) {
                alert("שגיאה במשיכת הנתונים: " + error.message);
                return null;
            } finally {
                DOM.startBtn.innerHTML = `<span>הצג תצוגה מקדימה</span> <i class="fas fa-arrow-left"></i>`;
                DOM.startBtn.disabled = false;
            }
        }

        // --- HTML Generation ---
        const sanitize = (str) => str ? String(str).replace(/</g, "&lt;") : '';
        const formatDate = (d) => { if(!d) return ''; try { const [y,m,d2] = d.split('-'); return `${d2}/${m}/${y}`; } catch(e) { return d; } };

        function generateReportHTML(data) {
            const { trip, logistics, places, checklists, schedules, notes } = data;
            let html = '';

            // Cover Page
            html += `
            <div class="report-page cover-page flex flex-col items-center justify-center text-center" style="min-height: 270mm;">
                <h1 style="font-size: 42pt; color: #0c4a6e; font-weight: 800; line-height: 1.2;">${sanitize(trip.name)}</h1>
                <h2 style="font-size: 18pt; color: #64748b; margin-top: 10px;">${formatDate(trip.startDate)} - ${formatDate(trip.endDate)}</h2>
                <div style="margin-top: 50px; width: 80%; border-top: 2px solid #e2e8f0; padding-top: 20px;">
                    ${(trip.destinations || []).map(d => `
                        <div class="flex justify-between border-b border-slate-100 py-3 text-xl">
                            <span class="font-bold">${sanitize(d.nameHe)}</span>
                            <span class="text-slate-500">${sanitize(d.dates)}</span>
                        </div>
                    `).join('')}
                </div>
            </div>`;

            // 1. Maps
            if(DOM.inputs.maps.checked) {
                html += `<div class="page-break"></div>
                <div class="report-page">
                    <h3 class="section-title"><i class="fas fa-map-marked-alt text-sky-500"></i> מפת המסע</h3>
                    <div id="main-trip-map" class="map-container" style="height: 400px;"></div>
                    
                    <h4 class="font-bold text-lg mt-6 mb-2">פירוט תחבורה ומעברים</h4>
                    ${logistics.filter(l => ['flight','train','ferry','car_rental','ride'].includes(l.type)).map(item => renderLogisticCard(item, true)).join('')}
                </div>`;
            }

            // 2. Schedule
            if(DOM.inputs.sched.checked && schedules.length) {
                html += `<div class="page-break"></div><div class="report-page">
                <h3 class="section-title"><i class="fas fa-calendar-day text-sky-500"></i> תוכנית הטיול</h3>`;
                
                schedules.forEach((day, idx) => {
                    if(idx > 0 && idx % 2 === 0) html += `</div><div class="page-break"></div><div class="report-page">`; // Simple pagination logic
                    
                    html += `
                    <div class="mb-8 break-inside-avoid">
                        <div class="flex items-center gap-3 mb-4 bg-slate-50 p-3 rounded-lg border-r-4 border-sky-500">
                            <div class="font-bold text-xl text-slate-700">${formatDate(day.id)}</div>
                            ${day.title ? `<div class="text-lg text-slate-600">| ${sanitize(day.title)}</div>` : ''}
                        </div>
                        <div class="pr-4 border-r-2 border-slate-200 mr-3 space-y-4">
                            ${(day.items||[]).map(item => `
                                <div class="relative">
                                    <div class="absolute -right-[21px] top-1 w-3 h-3 bg-sky-400 rounded-full border-2 border-white"></div>
                                    <div class="flex gap-4">
                                        <div class="text-sky-600 font-bold w-16 ltr-force text-right text-sm pt-0.5">${sanitize(item.startTime)}</div>
                                        <div class="flex-1">
                                            <div class="font-bold text-slate-800">${sanitize(item.title)}</div>
                                            ${item.summary ? `<div class="text-slate-600 text-sm mt-1">${sanitize(item.summary)}</div>` : ''}
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                             ${(!day.items || day.items.length === 0) ? '<p class="text-slate-400 italic mr-2">אין פעילות מתוכננת</p>' : ''}
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }

            // 3. Attractions
            if(DOM.inputs.attr.checked && places.length) {
                html += `<div class="page-break"></div><div class="report-page">
                <h3 class="section-title"><i class="fas fa-umbrella-beach text-sky-500"></i> מקומות עניין ומסעדות</h3>
                ${places.map(p => renderPlaceCard(p)).join('')}
                </div>`;
            }

            // 4. Checklists
            if(DOM.inputs.list.checked && checklists.length) {
                html += `<div class="page-break"></div><div class="report-page">
                <h3 class="section-title"><i class="fas fa-check-double text-sky-500"></i> רשימות וציוד</h3>
                <div class="grid grid-cols-2 gap-6">
                ${checklists.map(list => `
                    <div class="border border-slate-200 rounded-lg p-4 bg-slate-50 break-inside-avoid">
                        <h4 class="font-bold text-lg text-slate-700 mb-3 border-b border-slate-200 pb-2">${sanitize(list.name)}</h4>
                        <ul class="space-y-2">
                            ${(list.items||[]).map(i => `
                                <li class="flex items-start gap-2 text-sm">
                                    <i class="far ${i.checked ? 'fa-check-square text-emerald-500' : 'fa-square text-slate-300'} mt-1"></i>
                                    <span class="${i.checked ? 'line-through text-slate-400' : 'text-slate-700'}">${sanitize(i.text)} ${i.quantity > 1 ? `(${i.quantity})` : ''}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `).join('')}
                </div>
                </div>`;
            }

            return html;
        }

        function renderLogisticCard(item, showMap) {
            let icon = 'fa-plane';
            let colorClass = 'transport-flight';
            if(item.type === 'car_rental') { icon = 'fa-car'; colorClass = 'transport-car_rental'; }
            if(item.type === 'train') { icon = 'fa-train'; colorClass = 'transport-train'; }
            
            // Map ID generation
            const mapId = `map-log-${item.id}`;
            
            let content = `<div class="info-card ${colorClass}">
                <div class="flex items-center gap-3 mb-3">
                    <div class="w-8 h-8 rounded-full bg-white/50 flex items-center justify-center"><i class="fas ${icon}"></i></div>
                    <h4 class="font-bold text-lg">${sanitize(item.company || item.airline || 'תחבורה')}</h4>
                </div>
                <div class="card-grid">
                    ${item.dates ? `<div class="detail-item"><i class="fas fa-calendar"></i><span>${sanitize(item.dates)}</span></div>` : ''}
                    ${item.price ? `<div class="detail-item"><i class="fas fa-tag"></i><span>${sanitize(item.price)}</span></div>` : ''}
                    ${item.flight_number ? `<div class="detail-item"><i class="fas fa-ticket-alt"></i><span>${sanitize(item.flight_number)}</span></div>` : ''}
                </div>
                ${(showMap && (item.coords || item.from_coords)) ? 
                    `<div id="${mapId}" class="map-container h-40 mt-3" 
                        data-coords='${JSON.stringify(item.coords || item.from_coords)}' 
                        data-to='${JSON.stringify(item.to_coords)}'></div>` 
                : ''}
            </div>`;
            return content;
        }

        function renderPlaceCard(place) {
            return `<div class="info-card" style="border-right: 5px solid #8b5cf6;">
                <h4 class="font-bold text-lg text-slate-800 mb-2">${sanitize(place.name)}</h4>
                <div class="card-grid">
                    <div class="detail-item"><i class="fas fa-map-marker-alt"></i><span>${sanitize(place.location || place.destination)}</span></div>
                    ${place.link ? `<div class="detail-item"><i class="fas fa-link"></i><span class="truncate max-w-[150px]">${sanitize(place.link)}</span></div>` : ''}
                </div>
                ${place.description ? `<p class="text-sm text-slate-600 mt-2 border-t border-slate-100 pt-2">${sanitize(place.description)}</p>` : ''}
            </div>`;
        }

        // --- Rendering & Logic ---
        async function showPreview() {
            const data = await fetchAllData();
            if(!data) return;

            DOM.previewContainer.innerHTML = generateReportHTML(data);
            
            // Transition
            DOM.mainContent.classList.add('hidden');
            DOM.previewWrapper.classList.remove('hidden');
            window.scrollTo(0,0);

            // Init Maps after DOM update
            setTimeout(() => initMaps(data), 100);
        }

        function initMaps(data) {
            mapInstances.forEach(m => m.remove());
            mapInstances = [];

            // 1. Main Map
            if(DOM.inputs.maps.checked && document.getElementById('main-trip-map')) {
                const map = L.map('main-trip-map').setView([32, 34], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
                
                const points = [];
                (data.trip.destinations||[]).forEach(d => {
                    if(d.coords) {
                        L.marker([d.coords.lat, d.coords.lng]).addTo(map).bindTooltip(d.nameHe, {permanent:true});
                        points.push([d.coords.lat, d.coords.lng]);
                    }
                });
                
                if(points.length > 1) {
                    const line = L.polyline(points, {color: '#0ea5e9', weight: 3, dashArray: '10,10'}).addTo(map);
                    map.fitBounds(line.getBounds(), {padding:[50,50]});
                } else if(points.length === 1) {
                    map.setView(points[0], 8);
                }
                mapInstances.push(map);
            }

            // 2. Mini Maps
            document.querySelectorAll('.map-container[data-coords]').forEach(el => {
                try {
                    const c1 = JSON.parse(el.dataset.coords);
                    const c2 = el.dataset.to ? JSON.parse(el.dataset.to) : null;
                    
                    if(c1 && c1.lat) {
                        const map = L.map(el, {zoomControl:false, attributionControl:false});
                        L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png').addTo(map);
                        L.marker([c1.lat, c1.lng]).addTo(map);
                        
                        if(c2 && c2.lat) {
                            L.marker([c2.lat, c2.lng]).addTo(map);
                            const group = new L.featureGroup([L.marker([c1.lat, c1.lng]), L.marker([c2.lat, c2.lng])]);
                            map.fitBounds(group.getBounds(), {padding:[20,20]});
                        } else {
                            map.setView([c1.lat, c1.lng], 13);
                        }
                        mapInstances.push(map);
                    }
                } catch(e) {}
            });
        }

        // --- Print Logic (THE FIX) ---
        function openModal() { DOM.printModal.classList.remove('hidden'); }
        function closeModal() { DOM.printModal.classList.add('hidden'); }
        
        function handlePrint() {
            // 1. Show Loader inside modal
            document.getElementById('modal-content-wrapper').classList.add('hidden');
            document.getElementById('modal-loader').classList.remove('hidden');

            // 2. Resize maps (crucial for print)
            mapInstances.forEach(m => m.invalidateSize());

            // 3. Execution Delay (Minimal for iOS PWA support)
            setTimeout(() => {
                window.print();
                
                // Reset modal state after print dialog closes (or user returns)
                setTimeout(() => {
                    closeModal();
                    document.getElementById('modal-content-wrapper').classList.remove('hidden');
                    document.getElementById('modal-loader').classList.add('hidden');
                }, 500);
            }, 400); // 400ms is the sweet spot for map rendering + holding user gesture
        }

        // Events
        DOM.startBtn.addEventListener('click', showPreview);
        DOM.closePreviewBtn.addEventListener('click', () => {
            DOM.previewWrapper.classList.add('hidden');
            DOM.mainContent.classList.remove('hidden');
        });
        DOM.floatPrintBtn.addEventListener('click', openModal);
        DOM.closeModalBtn.addEventListener('click', closeModal);
        DOM.triggerPrintBtn.addEventListener('click', handlePrint);

        init();
    </script>
</body>
</html>

