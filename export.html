<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ייצוא סיכום טיול</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; }
        .export-btn { transition: all 0.3s ease; }
        .export-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* סגנונות עבור דוח ה-PDF שנוצר */
        .report-page {
            width: 210mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-sizing: border-box;
            color: #333;
            font-size: 14px;
        }
        .report-page h1, .report-page h2, .report-page h3, .report-page h4, .report-page h5 {
            font-family: 'Assistant', sans-serif;
            font-weight: 700;
        }
        .report-page h1 { font-size: 32px; text-align: center; margin-top: 50mm; margin-bottom: 10px; }
        .report-page h2 { font-size: 18px; text-align: center; margin-bottom: 20mm; color: #555; }
        .report-page h3 { font-size: 24px; text-align: center; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .report-page h4 { font-size: 20px; margin-top: 20px; margin-bottom: 10px; color: #2c3e50; border-right: 3px solid #3498db; padding-right: 10px;}
        .report-page h5 { font-size: 16px; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }
        .report-page .page-break { page-break-before: always; }

        .detail-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            break-inside: avoid;
        }
        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 4px 0;
        }
        .detail-item i {
            color: #888;
            margin-top: 3px;
        }
        .detail-item .label {
            color: #666;
            min-width: 90px;
        }
        .detail-item .value {
            font-weight: 600;
            color: #111;
        }

        .daily-item { margin-bottom: 15px; break-inside: avoid; }
        .daily-item .time { font-weight: 600; }
        .daily-item .summary { padding-right: 15px; border-right: 2px solid #eee; margin-top: 5px; }
        .daily-item .ref-details { font-size: 12px; color: #555; background-color: #f9f9f9; padding: 5px; border-radius: 4px; margin-top: 5px; }
        .checklist ul { list-style: none; padding: 0; }
        .checklist li { margin-bottom: 5px; font-size: 14px; }
    </style>
</head>
<body class="bg-slate-100">

    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/IrS6mDW.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/60"></div>
    
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה לדף הטיול">
                            <i class="fas fa-arrow-left fa-lg"></i>
                        </a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">ייצוא סיכום טיול</h1>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
                <i class="fas fa-file-export fa-3x text-blue-500 mb-4"></i>
                <h2 id="export-title" class="text-3xl font-extrabold text-slate-800">הפקת סיכום הטיול</h2>
                <p class="text-slate-600 mt-2 mb-8">לחץ על הכפתור כדי ליצור קובץ PDF מסודר עם כל פרטי הטיול, מוכן להדפסה או שמירה.</p>

                <div class="flex justify-center">
                    <button id="generate-pdf-btn" class="export-btn w-full sm:w-auto flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-pdf mr-2"></i> צור קובץ PDF
                    </button>
                </div>

                <div id="status-container" class="mt-8 min-h-[60px] flex flex-col items-center justify-center">
                    <div id="loader" class="loader hidden"></div>
                    <p id="status-message" class="text-slate-500 font-semibold"></p>
                </div>
            </div>
        </main>
    </div>

    <div id="report-container" class="invisible absolute -top-[9999px] -left-[9999px]"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(console.warn);

        // --- DOM Elements ---
        const DOM = {
            loader: document.getElementById('loader'),
            statusMessage: document.getElementById('status-message'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            pageTitle: document.getElementById('page-title'),
            exportTitle: document.getElementById('export-title'),
            reportContainer: document.getElementById('report-container'),
        };

        // --- State ---
        let tripId = null;
        let isGenerating = false;

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                alert("שגיאה: לא נמצא מזהה טיול.");
                window.location.href = 'index.html';
                return;
            }

            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const tripRef = doc(db, "trips", tripId);
                    const tripSnap = await getDoc(tripRef);
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.data();
                        if (!tripData.editors?.includes(user.uid)) {
                            alert("אין לך הרשאה לצפות בטיול זה.");
                            window.location.href = 'index.html';
                            return;
                        }
                        DOM.pageTitle.textContent += ` - ${tripData.name}`;
                        DOM.exportTitle.textContent += ` "${tripData.name}"`;
                    } else {
                        alert("הטיול לא נמצא.");
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        function setStatus(message, showLoader = false) {
            isGenerating = showLoader;
            DOM.statusMessage.textContent = message;
            DOM.loader.classList.toggle('hidden', !showLoader);
            DOM.generatePdfBtn.disabled = isGenerating;
        }

        // --- Data Fetching ---
        async function fetchAllTripData() {
            setStatus('טוען את כל נתוני הטיול...', true);

            const tripRef = doc(db, 'trips', tripId);
            const collectionsToFetch = ['logistics', 'places', 'checklists', 'schedules'];

            const [tripSnap, ...collectionsSnaps] = await Promise.all([
                getDoc(tripRef),
                ...collectionsToFetch.map(c => getDocs(query(collection(db, 'trips', tripId, c), orderBy('createdAt'))))
            ]);

            const allData = {
                tripData: tripSnap.data(),
                logistics: collectionsSnaps[0].docs.map(d => ({ id: d.id, ...d.data() })),
                places: collectionsSnaps[1].docs.map(d => ({ id: d.id, ...d.data() })),
                checklists: collectionsSnaps[2].docs.map(d => ({ id: d.id, ...d.data() })),
                schedules: []
            };

            const scheduleDocs = collectionsSnaps[3].docs;
            for (const scheduleDoc of scheduleDocs) {
                const dayData = { id: scheduleDoc.id, ...scheduleDoc.data() };
                const itemsQuery = query(collection(scheduleDoc.ref, 'items'), orderBy('sort'));
                const [itemsSnap] = await Promise.all([getDocs(itemsQuery)]);
                dayData.items = itemsSnap.docs.map(d => d.data());
                allData.schedules.push(dayData);
            }
            
            allData.schedules.sort((a,b) => a.id.localeCompare(b.id));

            return allData;
        }
        
        // --- Helper: Date Formatting ---
        function formatISODate(isoDate) {
            const [year, month, day] = isoDate.split('-');
            const dateObj = new Date(year, month - 1, day);
            const weekday = dateObj.toLocaleDateString('he-IL', { weekday: 'long' });
            return `${weekday}, ${day}/${month}/${year}`;
        }

        // --- HTML Report Builder ---
        function renderReportHtml(data) {
            let html = '<div class="report-page">';

            // 1. Cover Page
            html += `<h1>${data.tripData.name}</h1>`;
            html += `<h2>${data.tripData.startDate} - ${data.tripData.endDate}</h2>`;

            // Helper function for rendering detail items
            const detailItem = (icon, label, value) => {
                if (!value && typeof value !== 'number') return '';
                return `<div class="detail-item">
                    <i class="fas ${icon} fa-fw"></i>
                    <span class="label">${label}:</span>
                    <span class="value">${value}</span>
                </div>`;
            };

            // 2. Logistics Details
            if (data.logistics.length > 0) {
                html += `<div class="page-break"></div><h3>סיכום לוגיסטיקה</h3>`;
                
                const hotels = data.logistics.filter(i => i.type === 'hotel');
                const flights = data.logistics.filter(i => i.type === 'flight');
                const cars = data.logistics.filter(i => i.type === 'car_rental');
                const others = data.logistics.filter(i => ['ferry', 'train'].includes(i.type));

                if(hotels.length) {
                    html += `<h4>🏨 מלונות</h4>`;
                    hotels.forEach(item => {
                        html += `<div class="detail-card">
                            <h5>${item.name || 'מלון'}</h5>
                            ${detailItem('fa-calendar-days', 'תאריכים', item.dates)}
                            ${detailItem('fa-map-marker-alt', 'יעד', item.destination)}
                            ${detailItem('fa-location-dot', 'כתובת', item.address)}
                            ${detailItem('fa-dollar-sign', 'מחיר', item.price ? `$${item.price.toLocaleString()}` : '')}
                            ${detailItem('fa-building-user', 'הוזמן דרך', item.booked_via)}
                            ${detailItem('fa-info-circle', 'פרטים נוספים', item.additional_details)}
                        </div>`;
                    });
                }
                if(flights.length) {
                    html += `<h4>✈️ טיסות</h4>`;
                    flights.forEach(item => {
                        const from = item.from || {};
                        const to = item.to || {};
                        const luggage = `תיקי יד: ${item.hand_bag_count || 0}, טרולי: ${item.trolley_count || 0}, מזוודות: ${item.checked_bags_count || 0}`;
                        html += `<div class="detail-card">
                            <h5>${from.destination || 'מקור'} ← ${to.destination || 'יעד'}</h5>
                            ${detailItem('fa-building', 'חברת תעופה', item.airline)}
                            ${detailItem('fa-hashtag', 'מספר טיסה', item.flight_number)}
                            ${detailItem('fa-calendar-day', 'תאריך', item.dates)}
                            ${detailItem('fa-clock', 'שעת המראה', item.departure_time)}
                            ${detailItem('fa-clock', 'שעת נחיתה', item.arrival_time)}
                            ${detailItem('fa-dollar-sign', 'מחיר לאדם', item.price_per_person ? `$${item.price_per_person.toLocaleString()}` : '')}
                            ${detailItem('fa-chair', 'מקומות ישיבה', item.seats?.join(', '))}
                            ${detailItem('fa-suitcase', 'כבודה', luggage)}
                            ${detailItem('fa-info-circle', 'פרטים נוספים', item.additional_details)}
                        </div>`;
                    });
                }
                if(cars.length) {
                    html += `<h4>🚗 רכבים שכורים</h4>`;
                    cars.forEach(item => {
                        html += `<div class="detail-card">
                            <h5>רכב שכור ב${item.destination || ''}</h5>
                             ${detailItem('fa-calendar-days', 'תאריכים', item.dates)}
                            ${detailItem('fa-clock', 'שעת איסוף', item.pickup_time)}
                            ${detailItem('fa-clock', 'שעת החזרה', item.return_time)}
                            ${detailItem('fa-map-marker-alt', 'מיקום איסוף', item.pickup_location)}
                            ${detailItem('fa-car-side', 'סוג רכב', item.car_type)}
                            ${detailItem('fa-dollar-sign', 'מחיר', item.price ? `$${item.price.toLocaleString()}` : '')}
                            ${detailItem('fa-building-user', 'הוזמן דרך', item.booked_via)}
                        </div>`;
                    });
                }
                if(others.length) {
                    html += `<h4>🚢 רכבות ומעבורות</h4>`;
                    others.forEach(item => {
                        const isFerry = item.type === 'ferry';
                        const title = isFerry ? `מעבורת: ${item.from_destination} ← ${item.to_destination}` : `רכבת: ${item.from_station} ← ${item.to_station}`;
                        const fromLabel = isFerry ? 'נמל יציאה' : 'תחנת יציאה';
                        const toLabel = isFerry ? 'נמל הגעה' : 'תחנת הגעה';
                        const fromVal = item.from_destination || item.from_station;
                        const toVal = item.to_destination || item.to_station;
                        html += `<div class="detail-card">
                            <h5>${title}</h5>
                            ${detailItem('fa-building', 'חברה', item.company)}
                            ${detailItem('fa-map-pin', fromLabel, fromVal)}
                            ${detailItem('fa-map-pin', toLabel, toVal)}
                            ${detailItem('fa-calendar-day', 'תאריך', item.date)}
                            ${detailItem('fa-clock', 'שעת יציאה', item.departure_time)}
                            ${detailItem('fa-clock', 'שעת הגעה', item.arrival_time)}
                            ${detailItem('fa-dollar-sign', 'מחיר', item.price ? `$${item.price.toLocaleString()}` : '')}
                        </div>`;
                    });
                }
            }

            // 3. Places of Interest
            if (data.places.length > 0) {
                html += `<div class="page-break"></div><h3>אטרקציות ומקומות עניין</h3>`;
                data.places.forEach(place => {
                     html += `<div class="detail-card">
                        <h5>${place.name || 'מקום'} (${place.type || ''})</h5>
                        ${detailItem('fa-location-dot', 'כתובת', place.address)}
                        ${detailItem('fa-align-left', 'הערות', place.notes)}
                     </div>`;
                });
            }

            // 4. Daily Schedule
            data.schedules.forEach(day => {
                html += `<div class="page-break"></div><h3>לו"ז יומי: ${formatISODate(day.id)}</h3>`;
                day.items.forEach(item => {
                    const time = `${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''}`;
                    html += `<div class="daily-item">
                                <h5><span class="time">${time}</span> - ${item.title}</h5>`;
                    if (item.summary) {
                        html += `<p class="summary">${item.summary}</p>`;
                    }
                    if (item.refs && item.refs.length > 0) {
                        item.refs.forEach(ref => {
                           const source = ref.type === 'logistics' ? data.logistics : data.places;
                           const fullItem = source.find(s => s.id === ref.id);
                           if (fullItem) {
                               let refText = `<b>מקושר ל:</b> ${fullItem.name}. `;
                               if (fullItem.location || fullItem.address) refText += `<b>כתובת:</b> ${fullItem.location || fullItem.address}.`;
                               html += `<div class="ref-details">${refText}</div>`;
                           }
                        });
                    }
                    html += `</div>`;
                });
            });

            // 5. Checklists
            if (data.checklists.length > 0) {
                html += `<div class="page-break"></div><h3>רשימות ציוד</h3>`;
                data.checklists.forEach(list => {
                    html += `<div class="checklist">
                                <h4>${list.name}</h4>
                                <ul>`;
                    list.items.forEach(item => {
                        html += `<li>☐ ${item.text} (כמות: ${item.quantity})</li>`;
                    });
                    html += `</ul></div>`;
                });
            }

            html += '</div>'; // close report-page
            return html;
        }


        // --- PDF Generation Orchestrator ---
        async function generatePdf() {
            if (isGenerating) return;
            
            try {
                const allData = await fetchAllTripData();
                setStatus('מייצר את קובץ ה-PDF...', true);

                DOM.reportContainer.innerHTML = renderReportHtml(allData);
                
                const element = DOM.reportContainer.querySelector('.report-page');
                const opt = {
                    margin:       [15, 10, 15, 10],
                    filename:     `Trip_Summary_${tripId}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['css', 'legacy'] }
                };

                await html2pdf().set(opt).from(element).save();
                
                setStatus('ההורדה הושלמה!', false);

            } catch (error) {
                console.error("Error generating PDF:", error);
                setStatus(`שגיאה ביצירת הקובץ: ${error.message}`, false);
            } finally {
                DOM.reportContainer.innerHTML = ''; // Clean up
            }
        }
        
        // --- Event Listeners ---
        DOM.generatePdfBtn.addEventListener('click', generatePdf);

        // --- Start the App ---
        initPage();
    </script>
</body>
</html>