<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ייצוא סיכום טיול</title>

    <!-- UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- יצירת קבצים -->
    <!-- jsPDF + AutoTable -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <!-- DOCX (UMD – יחשוף window.docx) -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <!-- FileSaver (saveAs גלובלי) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <!-- פונט עברי/ערבי ל-PDF (מכיל מחרוזת base64 גלובלית) -->
    <script src="https://cdn.jsdelivr.net/gh/tomer-panfil/Amiri-Font-for-jsPDF/Amiri-Regular.js"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; }
        .export-btn { transition: all 0.3s ease; }
        .export-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/IrS6mDW.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/60"></div>

    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה לדף הטיול">
                            <i class="fas fa-arrow-left fa-lg"></i>
                        </a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">ייצוא סיכום טיול</h1>
                    </div>
                    <div id="auth-container"></div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
                <i class="fas fa-file-export fa-3x text-blue-500 mb-4"></i>
                <h2 id="export-title" class="text-3xl font-extrabold text-slate-800">הפקת סיכום הטיול</h2>
                <p class="text-slate-600 mt-2 mb-8">בחר את הפורמט הרצוי כדי ליצור קובץ מסודר עם כל פרטי הטיול, מוכן להדפסה או שמירה.</p>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="generate-pdf-btn" class="export-btn w-full sm:w-auto flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-pdf mr-2"></i> צור קובץ PDF
                    </button>
                    <button id="generate-docx-btn" class="export-btn w-full sm:w-auto flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-word mr-2"></i> צור קובץ Word
                    </button>
                </div>

                <div id="status-container" class="mt-8 min-h-[60px] flex flex-col items-center justify-center">
                    <div id="loader" class="loader hidden"></div>
                    <p id="status-message" class="text-slate-500 font-semibold"></p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(console.warn);

        // --- DOM Elements ---
        const DOM = {
            loader: document.getElementById('loader'),
            statusMessage: document.getElementById('status-message'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            generateDocxBtn: document.getElementById('generate-docx-btn'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            pageTitle: document.getElementById('page-title'),
            exportTitle: document.getElementById('export-title'),
            authContainer: document.getElementById('auth-container'),
        };

        // --- State ---
        let tripId = null;
        let currentUser = null;
        let isGenerating = false;

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                alert("שגיאה: לא נמצא מזהה טיול.");
                window.location.href = 'index.html';
                return;
            }

            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    const tripRef = doc(db, "trips", tripId);
                    const tripSnap = await getDoc(tripRef);
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.data();
                        const canAccess = tripData.editors?.includes(currentUser.uid);
                        if (!canAccess) {
                            alert("אין לך הרשאה לצפות בטיול זה.");
                            window.location.href = 'index.html';
                            return;
                        }
                        DOM.pageTitle.textContent += ` - ${tripData.name}`;
                        DOM.exportTitle.textContent += ` "${tripData.name}"`;
                    } else {
                        alert("הטיול לא נמצא.");
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        function setStatus(message, showLoader = false) {
            DOM.statusMessage.textContent = message;
            DOM.loader.classList.toggle('hidden', !showLoader);
            DOM.generatePdfBtn.disabled = isGenerating;
            DOM.generateDocxBtn.disabled = isGenerating;
        }

        // --- Data Fetching ---
        async function fetchAllTripData() {
            setStatus('טוען נתונים מהשרת...', true);

            const tripRef = doc(db, 'trips', tripId);
            const collectionsToFetch = ['logistics', 'places', 'checklists', 'schedules'];

            const [tripSnap, ...collectionsSnaps] = await Promise.all([
                getDoc(tripRef),
                ...collectionsToFetch.map(c => getDocs(query(collection(db, 'trips', tripId, c), orderBy('createdAt'))))
            ]);

            const allData = {
                tripData: tripSnap.data(),
                logistics: collectionsSnaps[0].docs.map(d => ({ id: d.id, ...d.data() })),
                places: collectionsSnaps[1].docs.map(d => ({ id: d.id, ...d.data() })),
                checklists: collectionsSnaps[2].docs.map(d => ({ id: d.id, ...d.data() })),
                schedules: []
            };

            // Fetch nested items and notes for each schedule day
            const scheduleDocs = collectionsSnaps[3].docs;
            for (const scheduleDoc of scheduleDocs) {
                const dayData = { id: scheduleDoc.id, ...scheduleDoc.data() };
                const itemsQuery = query(collection(scheduleDoc.ref, 'items'), orderBy('sort'));
                const notesQuery = query(collection(scheduleDoc.ref, 'notes'), orderBy('createdAt'));

                const [itemsSnap, notesSnap] = await Promise.all([
                    getDocs(itemsQuery),
                    getDocs(notesQuery)
                ]);

                dayData.items = itemsSnap.docs.map(d => d.data());
                dayData.notes = notesSnap.docs.map(d => d.data());
                allData.schedules.push(dayData);
            }

            // Sort schedules by date
            allData.schedules.sort((a,b) => a.id.localeCompare(b.id));

            return allData;
        }

        // --- Document Generation Orchestrator ---
        async function generateDocument(format) {
            if (isGenerating) return;
            isGenerating = true;

            try {
                const allData = await fetchAllTripData();
                setStatus(`מייצר קובץ ${format.toUpperCase()}...`, true);

                if (format === 'pdf') {
                    await buildPdf(allData);
                } else if (format === 'docx') {
                    await buildDocx(allData);
                }

                setStatus('ההורדה הושלמה!', false);
            } catch (error) {
                console.error(`Error generating ${format}:`, error);
                setStatus(`שגיאה ביצירת הקובץ: ${error.message}`, false);
            } finally {
                isGenerating = false;
                DOM.generatePdfBtn.disabled = isGenerating;
                DOM.generateDocxBtn.disabled = isGenerating;
            }
        }

        // --- Helper: Date Formatting ---
        function formatISODate(isoDate) {
            const [year, month, day] = isoDate.split('-');
            const dateObj = new Date(year, month - 1, day);
            const weekday = dateObj.toLocaleDateString('he-IL', { weekday: 'long' });
            return `${weekday}, ${day}/${month}/${year}`;
        }

        // --- PDF Builder ---
        async function buildPdf(data) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });

            // הגדרת פונט עברי/RTL – קח את משתנה הבסיס64 מהגלובל
            const amiriBase64 =
                window.amiri_regular_base64 ||
                window.amiriRegularBase64 ||
                window.AmiriRegular ||
                window.amiriRegular ||
                null;

            if (!amiriBase64) {
                throw new Error("לא נטען הפונט Amiri (בדוק שהסקריפט Amiri-Regular.js נטען לפני המודול).");
            }

            // רישום הפונט ב-jsPDF
            doc.addFileToVFS('Amiri-Regular.ttf', amiriBase64);
            doc.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
            doc.setFont('Amiri');

            // פונקציה פשוטה ל-RTL
            const reversedText = (text) => String(text ?? '').split('').reverse().join('');

            // 1) שער
            doc.setFontSize(32);
            doc.text(reversedText(data.tripData.name), doc.internal.pageSize.getWidth() / 2, 80, { align: 'center' });
            doc.setFontSize(16);
            doc.text(reversedText(`תאריכים: ${data.tripData.startDate} - ${data.tripData.endDate}`), doc.internal.pageSize.getWidth() / 2, 100, { align: 'center' });

            // 2) לוגיסטיקה
            doc.addPage();
            doc.setFontSize(22);
            doc.text(reversedText('סיכום לוגיסטיקה'), 105, 20, { align: 'center' });

            if (data.logistics.length > 0) {
                const logisticsBody = data.logistics.map(item => [
                    reversedText(item.name || item.type || ''),
                    reversedText(item.destination || item.dates || ''),
                    `$${Number(item.price ?? item.price_per_person ?? 0).toLocaleString()}`
                ]);
                doc.autoTable({
                    startY: 30,
                    head: [[reversedText('תיאור'), reversedText('יעד/תאריכים'), reversedText('מחיר')].reverse()],
                    body: logisticsBody.map(row => row.reverse()),
                    styles: { font: 'Amiri', halign: 'right' },
                    headStyles: { fillColor: [41, 128, 185], halign: 'right' },
                });
            } else {
                doc.setFontSize(12);
                doc.text(reversedText('לא נמצאו פריטי לוגיסטיקה.'), 105, 40, { align: 'center' });
            }

            // 3) לו"ז יומי
            for (const day of data.schedules) {
                doc.addPage();
                doc.setFontSize(22);
                doc.text(reversedText(formatISODate(day.id)), 105, 20, { align: 'center' });
                let y = 35;

                for (const item of day.items) {
                    if (y > 270) { doc.addPage(); y = 20; }
                    doc.setFontSize(14);
                    const time = `${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''}`;
                    doc.text(reversedText(`${time} - ${item.title ?? ''}`), 195, y, { align: 'right' });
                    y += 7;

                    if (item.summary) {
                        doc.setFontSize(10);
                        const wrapped = doc.splitTextToSize(reversedText(item.summary), 180);
                        doc.text(wrapped, 190, y, { align: 'right', maxWidth: 180 });
                        y += (wrapped.length * 4) + 2;
                    }

                    if (Array.isArray(item.refs) && item.refs.length) {
                        for (const ref of item.refs) {
                            const source = ref.type === 'logistics' ? data.logistics : data.places;
                            const fullItem = source.find(s => s.id === ref.id);
                            if (fullItem) {
                                doc.setFontSize(10);
                                doc.setTextColor(100);
                                let refText = `פרטים: ${fullItem.name ?? ''}. `;
                                if (fullItem.location || fullItem.address) refText += `כתובת: ${fullItem.location || fullItem.address}.`;
                                const wrappedRef = doc.splitTextToSize(reversedText(refText), 170);
                                doc.text(wrappedRef, 185, y, { align: 'right', maxWidth: 170 });
                                y += wrappedRef.length * 4;
                                doc.setTextColor(0);
                            }
                        }
                    }
                    y += 5;
                }
            }

            // 4) צ'ק-ליסטים
            if (data.checklists.length > 0) {
                doc.addPage();
                doc.setFontSize(22);
                doc.text(reversedText('רשימות וצ\'ק-ליסטים'), 105, 20, { align: 'center' });
                let checklistY = 30;
                data.checklists.forEach(list => {
                    doc.setFontSize(16);
                    doc.text(reversedText(list.name ?? ''), 195, checklistY, { align: 'right' });
                    checklistY += 8;
                    (list.items ?? []).forEach(it => {
                        doc.setFontSize(12);
                        const qty = Number(it.quantity ?? 1);
                        const itemText = `[ ] ${it.text ?? ''} (x${qty})`;
                        doc.text(reversedText(itemText), 190, checklistY, { align: 'right' });
                        checklistY += 6;
                    });
                    checklistY += 10;
                });
            }

            doc.save(`trip_summary_${tripId}.pdf`);
        }

        // --- Word (.docx) Builder ---
        async function buildDocx(data) {
            // לפרק אובייקטים מתוך window.docx (UMD)
            const {
                Document, Packer, Paragraph, TextRun,
                HeadingLevel, Table, TableCell, TableRow,
                WidthType, AlignmentType, BorderStyle
            } = window.docx || {};

            if (!Document) {
                throw new Error("ספריית docx לא נטענה (window.docx ריק). ודא שהסקрипט של docx נטען לפני המודול.");
            }

            // עזר: תא טבלה מטקסט
            const cell = (text, widthDxa) => new TableCell({
                width: widthDxa ? { size: widthDxa, type: WidthType.DXA } : undefined,
                children: [ new Paragraph(String(text ?? "")) ],
            });

            const sections = [];

            // 1) שער
            sections.push({
                children: [
                    new Paragraph({ text: "", spacing: { before: 4000 } }),
                    new Paragraph({
                        children: [ new TextRun({ text: data.tripData.name, bold: true }) ],
                        heading: HeadingLevel.TITLE,
                        alignment: AlignmentType.CENTER,
                    }),
                    new Paragraph({
                        children: [ new TextRun({ text: `תאריכים: ${data.tripData.startDate} - ${data.tripData.endDate}` }) ],
                        heading: HeadingLevel.HEADING_2,
                        alignment: AlignmentType.CENTER,
                    }),
                ],
            });

            // 2) לוגיסטיקה
            const headerRow = new TableRow({
                children: [
                    cell("תיאור", 3000),
                    cell("יעד/תאריכים", 4000),
                    cell("מחיר", 2000),
                ],
                tableHeader: true,
            });

            const logisticsRows = data.logistics.map(item =>
                new TableRow({
                    children: [
                        cell(item.name || item.type, 3000),
                        cell(item.destination || item.dates || "", 4000),
                        cell(`$${Number(item.price ?? item.price_per_person ?? 0).toLocaleString()}`, 2000),
                    ],
                })
            );

            const logisticsTable = new Table({
                rows: [headerRow, ...logisticsRows],
            });

            sections.push({
                children: [
                    new Paragraph({ text: "סיכום לוגיסטיקה", heading: HeadingLevel.HEADING_1, pageBreakBefore: true }),
                    logisticsTable
                ]
            });

            // 3) לו"ז יומי
            data.schedules.forEach(day => {
                const dayChildren = [
                    new Paragraph({ text: formatISODate(day.id), heading: HeadingLevel.HEADING_1, pageBreakBefore: true })
                ];

                day.items.forEach(item => {
                    const time = `${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''}`;
                    dayChildren.push(new Paragraph({
                        children: [ new TextRun({ text: `${time} - ${item.title ?? ""}`, bold: true }) ],
                    }));

                    if (item.summary) dayChildren.push(new Paragraph({ text: item.summary }));

                    if (Array.isArray(item.refs) && item.refs.length) {
                        for (const ref of item.refs) {
                            const source = ref.type === 'logistics' ? data.logistics : data.places;
                            const fullItem = source.find(s => s.id === ref.id);
                            if (fullItem) {
                                let refText = `פרטים: ${fullItem.name ?? ''}. `;
                                if (fullItem.location || fullItem.address) refText += `כתובת: ${fullItem.location || fullItem.address}.`;
                                dayChildren.push(new Paragraph({ text: refText }));
                            }
                        }
                    }
                });

                sections.push({ children: dayChildren });
            });

            // 4) צ'ק-ליסטים
            if (data.checklists.length > 0) {
                const checklistChildren = [ new Paragraph({ text: "רשימות וצ'ק-ליסטים", heading: HeadingLevel.HEADING_1, pageBreakBefore: true }) ];
                data.checklists.forEach(list => {
                    checklistChildren.push(new Paragraph({ text: list.name, heading: HeadingLevel.HEADING_2 }));
                    (list.items ?? []).forEach(it => {
                        const qty = Number(it.quantity ?? 1);
                        checklistChildren.push(new Paragraph({ text: `☐ ${it.text ?? ""} (x${qty})` }));
                    });
                });
                sections.push({ children: checklistChildren });
            }

            const doc = new Document({
                creator: "Tiool-Loz App",
                title: data.tripData.name,
                sections
            });

            const blob = await Packer.toBlob(doc);
            window.saveAs(blob, `trip_summary_${tripId}.docx`);
        }

        // --- Event Listeners ---
        DOM.generatePdfBtn.addEventListener('click', () => generateDocument('pdf'));
        DOM.generateDocxBtn.addEventListener('click', () => generateDocument('docx'));

        // --- Start the App ---
        initPage();
    </script>
</body>
</html>