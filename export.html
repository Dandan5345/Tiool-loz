<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>×™×™×¦×•× ×¡×™×›×•× ×˜×™×•×œ</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" xintegrity="sha512-GsLlZN/3F2ErC5ifS5QtgpiJtWd43JWSuIgh7mbzZ8zBps+dvLusV+eNQATqgA/HdeKFVgA5v3S/cIrLF7QnIg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; }
        .export-btn { transition: all 0.3s ease; }
        .export-btn:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* ×¡×’× ×•× ×•×ª ×¢×‘×•×¨ ×“×•×— ×”-PDF ×©× ×•×¦×¨ */
        .report-page {
            width: 210mm;
            padding: 15mm;
            margin: 0 auto;
            background: white;
            box-sizing: border-box;
            color: #333;
            font-size: 14px;
        }
        .report-page h1, .report-page h2, .report-page h3, .report-page h4, .report-page h5 {
            font-family: 'Assistant', sans-serif;
            font-weight: 700;
        }
        .report-page h1 { font-size: 32px; text-align: center; margin-top: 50mm; margin-bottom: 10px; }
        .report-page h2 { font-size: 18px; text-align: center; margin-bottom: 20mm; color: #555; }
        .report-page h3 { font-size: 24px; text-align: center; margin-bottom: 15px; border-bottom: 2px solid #3498db; padding-bottom: 5px; }
        .report-page h4 { font-size: 20px; margin-top: 20px; margin-bottom: 10px; color: #2c3e50; border-right: 3px solid #3498db; padding-right: 10px;}
        .report-page h5 { font-size: 16px; font-weight: 600; margin-top: 15px; margin-bottom: 5px; }
        .report-page .page-break { page-break-before: always; }

        .detail-card {
            background-color: #f9f9f9;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            break-inside: avoid;
        }
        .detail-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 4px 0;
        }
        .detail-item i {
            color: #888;
            margin-top: 3px;
            width: 16px; /* for alignment */
            text-align: center;
        }
        .detail-item .label {
            color: #666;
            min-width: 90px;
        }
        .detail-item .value {
            font-weight: 600;
            color: #111;
            white-space: pre-wrap; /* To respect newlines in descriptions */
        }

        .daily-item { margin-bottom: 15px; break-inside: avoid; }
        .daily-item .time { font-weight: 600; }
        .daily-item .summary { padding-right: 15px; border-right: 2px solid #eee; margin-top: 5px; white-space: pre-wrap; }
        .daily-item .ref-details { font-size: 12px; color: #555; background-color: #f9f9f9; padding: 5px; border-radius: 4px; margin-top: 5px; }
        
        .note-item {
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-right-width: 5px;
            padding: 10px 12px;
            margin-top: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
            break-inside: avoid;
        }
        .note-item strong {
            display: block;
            margin-bottom: 4px;
            color: #2c3e50;
        }
        .note-item p {
            white-space: pre-wrap;
            font-size: 13px;
            color: #444;
            margin: 0;
        }
        .note-color-red { border-right-color: #ef4444; }
        .note-color-green { border-right-color: #22c55e; }
        .note-color-blue { border-right-color: #3b82f6; }
        .note-color-yellow { border-right-color: #eab308; }
        .note-color-orange { border-right-color: #f97316; }

        /* --- ×©×™× ×•×™: ×¡×’× ×•× ×•×ª ×—×“×©×™× ×•××•×¨×—×‘×™× ×œ×¨×©×™××•×ª ×¦×™×•×“ --- */
        .checklist-container { break-inside: avoid; margin-bottom: 20px; }
        .checklist-group { margin-bottom: 15px; }
        .checklist-group h4 { font-size: 18px; font-weight: 700; color: #1e3a8a; background-color: #e0f2fe; padding: 8px; border-radius: 6px; }
        .checklist-group h5 { font-size: 16px; font-weight: 600; color: #1e40af; margin-top: 10px; padding-right: 8px; border-right: 2px solid #93c5fd; }
        .checklist-list-title { font-size: 15px; font-weight: bold; color: #1d4ed8; margin-top: 10px; margin-bottom: 5px; }

        .checklist-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 8px;
            margin-bottom: 4px;
            border-right: 4px solid transparent;
            border-radius: 4px;
            background-color: #f8fafc;
        }
        .checklist-item .checkbox { font-size: 18px; color: #333; line-height: 1.2; }
        .checklist-item .item-details { flex-grow: 1; }
        .checklist-item .item-text { font-weight: 600; }
        .checklist-item .item-description { font-size: 12px; color: #555; margin-top: 2px; white-space: pre-wrap; }
        .item-checked .item-text, .item-checked .item-description { text-decoration: line-through; color: #999; }
        
        .priority-3 { border-right-color: #f43f5e; } /* High */
        .priority-2 { border-right-color: #f97316; } /* Medium */
        .priority-1 { border-right-color: #eab308; } /* Low */

    </style>
</head>
<body class="bg-slate-100">

    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/IrS6mDW.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/60"></div>
    
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ">
                            <i class="fas fa-arrow-left fa-lg"></i>
                        </a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">×™×™×¦×•× ×¡×™×›×•× ×˜×™×•×œ</h1>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
                <i class="fas fa-file-export fa-3x text-blue-500 mb-4"></i>
                <h2 id="export-title" class="text-3xl font-extrabold text-slate-800">×”×¤×§×ª ×¡×™×›×•× ×”×˜×™×•×œ</h2>
                <p class="text-slate-600 mt-2 mb-8">×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×›×“×™ ×œ×™×¦×•×¨ ×§×•×‘×¥ PDF ××¡×•×“×¨ ×¢× ×›×œ ×¤×¨×˜×™ ×”×˜×™×•×œ, ××•×›×Ÿ ×œ×”×“×¤×¡×” ××• ×©××™×¨×”.</p>

                <div class="flex justify-center">
                    <button id="generate-pdf-btn" class="export-btn w-full sm:w-auto flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-pdf mr-2"></i> ×¦×•×¨ ×§×•×‘×¥ PDF
                    </button>
                </div>

                <div id="status-container" class="mt-8 min-h-[60px] flex flex-col items-center justify-center">
                    <div id="loader" class="loader hidden"></div>
                    <p id="status-message" class="text-slate-500 font-semibold"></p>
                </div>
            </div>
        </main>
    </div>

    <div id="report-container" class="invisible absolute -top-[9999px] -left-[9999px]"></div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        enableIndexedDbPersistence(db).catch(console.warn);

        // --- DOM Elements ---
        const DOM = {
            loader: document.getElementById('loader'),
            statusMessage: document.getElementById('status-message'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            pageTitle: document.getElementById('page-title'),
            exportTitle: document.getElementById('export-title'),
            reportContainer: document.getElementById('report-container'),
        };

        // --- State ---
        let tripId = null;
        let isGenerating = false;

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                alert("×©×’×™××”: ×œ× × ××¦× ××–×”×” ×˜×™×•×œ.");
                window.location.href = 'index.html';
                return;
            }

            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    const tripRef = doc(db, "trips", tripId);
                    const tripSnap = await getDoc(tripRef);
                    if (tripSnap.exists()) {
                        const tripData = tripSnap.data();
                        if (!tripData.editors?.includes(user.uid)) {
                            alert("××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.");
                            window.location.href = 'index.html';
                            return;
                        }
                        DOM.pageTitle.textContent += ` - ${tripData.name}`;
                        DOM.exportTitle.textContent += ` "${tripData.name}"`;
                    } else {
                        alert("×”×˜×™×•×œ ×œ× × ××¦×.");
                        window.location.href = 'index.html';
                    }
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        function setStatus(message, showLoader = false) {
            isGenerating = showLoader;
            DOM.statusMessage.textContent = message;
            DOM.loader.classList.toggle('hidden', !showLoader);
            DOM.generatePdfBtn.disabled = isGenerating;
        }

        // --- Data Fetching ---
        async function fetchAllTripData() {
            setStatus('×˜×•×¢×Ÿ ××ª ×›×œ × ×ª×•× ×™ ×”×˜×™×•×œ...', true);

            const tripRef = doc(db, 'trips', tripId);
            const collectionsToFetch = ['logistics', 'places', 'checklists', 'schedules'];

            const [tripSnap, ...collectionsSnaps] = await Promise.all([
                getDoc(tripRef),
                ...collectionsToFetch.map(c => getDocs(query(collection(db, 'trips', tripId, c), orderBy('createdAt'))))
            ]);

            const allData = {
                tripData: tripSnap.data(),
                logistics: collectionsSnaps[0].docs.map(d => ({ id: d.id, ...d.data() })),
                places: collectionsSnaps[1].docs.map(d => ({ id: d.id, ...d.data() })),
                checklists: collectionsSnaps[2].docs.map(d => ({ id: d.id, ...d.data() })),
                schedules: []
            };

            const scheduleDocs = collectionsSnaps[3].docs;
            for (const scheduleDoc of scheduleDocs) {
                const dayData = { id: scheduleDoc.id, ...scheduleDoc.data() };
                const itemsQuery = query(collection(scheduleDoc.ref, 'items'), orderBy('sort'));
                const notesQuery = query(collection(scheduleDoc.ref, 'notes'), orderBy('createdAt'));
                
                const [itemsSnap, notesSnap] = await Promise.all([
                    getDocs(itemsQuery),
                    getDocs(notesQuery)
                ]);

                dayData.items = itemsSnap.docs.map(d => d.data());
                dayData.notes = notesSnap.docs.map(d => d.data());
                
                allData.schedules.push(dayData);
            }
            
            allData.schedules.sort((a,b) => a.id.localeCompare(b.id));

            return allData;
        }
        
        // --- Helpers ---
        function formatISODate(isoDate) {
            if (!isoDate) return '';
            const [year, month, day] = isoDate.split('-');
            const dateObj = new Date(year, month - 1, day);
            const weekday = dateObj.toLocaleDateString('he-IL', { weekday: 'long' });
            return `${weekday}, ${day}/${month}/${year}`;
        }
        
        // --- ×©×™× ×•×™: ×”×•×¡×¤×ª ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ×§×™×‘×•×¥ ×›××• ×‘×“×£ ×”×¨×©×™××•×ª ---
        const groupBy = (arr, key, fallback='×›×œ×œ×™') => arr.reduce((r,v)=>{
            const k = v[key] || fallback; (r[k] = r[k] || []).push(v); return r;
        },{});
        
        const getEmoji = (category, value)=>{
            const map = {
                types: {'×œ×¤× ×™ ×”×˜×™×•×œ':'âœˆï¸','×œ×¤× ×™ ×™×¢×“':'ğŸ—ºï¸','×œ×¤× ×™ ××¢×‘×¨':'ğŸšš','××—×¨':'ğŸ“‹'},
            };
            if (!value || !map[category]) return '';
            const key = Object.keys(map[category]).find(k => value.includes(k));
            return key ? map[category][key] : '';
        };

        // --- HTML Report Builder ---
        function renderReportHtml(data) {
            let html = '<div class="report-page">';

            // 1. Cover Page
            html += `<h1>${data.tripData.name}</h1>`;
            html += `<h2>${data.tripData.startDate} - ${data.tripData.endDate}</h2>`;

            // Helper function for rendering detail items
            const detailItem = (icon, label, value) => {
                if (!value && typeof value !== 'number') return '';
                const sanitizedValue = String(value).replace(/</g, "&lt;").replace(/>/g, "&gt;");
                return `<div class="detail-item">
                        <i class="fas ${icon} fa-fw"></i>
                        <span class="label">${label}:</span>
                        <span class="value">${sanitizedValue}</span>
                    </div>`;
            };

            // 2. Logistics Details
            if (data.logistics.length > 0) {
                html += `<div class="page-break"></div><h3>×¡×™×›×•× ×œ×•×’×™×¡×˜×™×§×”</h3>`;
                
                const hotels = data.logistics.filter(i => i.type === 'hotel');
                const flights = data.logistics.filter(i => i.type === 'flight');
                const cars = data.logistics.filter(i => i.type === 'car_rental');
                const others = data.logistics.filter(i => ['ferry', 'train'].includes(i.type));

                if(hotels.length) {
                    html += `<h4>ğŸ¨ ××œ×•× ×•×ª</h4>`;
                    hotels.forEach(item => {
                        html += `<div class="detail-card">
                            <h5>${item.name || '××œ×•×Ÿ'}</h5>
                            ${detailItem('fa-calendar-days', '×ª××¨×™×›×™×', item.dates)}
                            ${detailItem('fa-map-marker-alt', '×™×¢×“', item.destination)}
                            ${detailItem('fa-location-dot', '×›×ª×•×‘×ª', item.address)}
                            ${detailItem('fa-dollar-sign', '××—×™×¨', item.price ? `$${item.price.toLocaleString()}` : '')}
                            ${detailItem('fa-building-user', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                            ${detailItem('fa-info-circle', '×¤×¨×˜×™× × ×•×¡×¤×™×', item.additional_details)}
                        </div>`;
                    });
                }
                if(flights.length) {
                    html += `<h4>âœˆï¸ ×˜×™×¡×•×ª</h4>`;
                    flights.forEach(item => {
                        const from = item.from || {};
                        const to = item.to || {};
                        const luggage = `×ª×™×§×™ ×™×“: ${item.hand_bag_count || 0}, ×˜×¨×•×œ×™: ${item.trolley_count || 0}, ××–×•×•×“×•×ª: ${item.checked_bags_count || 0}`;
                        html += `<div class="detail-card">
                            <h5>${from.destination || '××§×•×¨'} â† ${to.destination || '×™×¢×“'}</h5>
                            ${detailItem('fa-building', '×—×‘×¨×ª ×ª×¢×•×¤×”', item.airline)}
                            ${detailItem('fa-hashtag', '××¡×¤×¨ ×˜×™×¡×”', item.flight_number)}
                            ${detailItem('fa-calendar-day', '×ª××¨×™×š', item.dates)}
                            ${detailItem('fa-clock', '×©×¢×ª ×”××¨××”', item.departure_time)}
                            ${detailItem('fa-clock', '×©×¢×ª × ×—×™×ª×”', item.arrival_time)}
                            ${detailItem('fa-dollar-sign', '××—×™×¨ ×œ××“×', item.price_per_person ? `$${item.price_per_person.toLocaleString()}` : '')}
                            ${detailItem('fa-chair', '××§×•××•×ª ×™×©×™×‘×”', item.seats?.join(', '))}
                            ${detailItem('fa-suitcase', '×›×‘×•×“×”', luggage)}
                            ${detailItem('fa-info-circle', '×¤×¨×˜×™× × ×•×¡×¤×™×', item.additional_details)}
                        </div>`;
                    });
                }
                if(cars.length) {
                    html += `<h4>ğŸš— ×¨×›×‘×™× ×©×›×•×¨×™×</h4>`;
                    cars.forEach(item => {
                        html += `<div class="detail-card">
                            <h5>×¨×›×‘ ×©×›×•×¨ ×‘${item.destination || ''}</h5>
                             ${detailItem('fa-calendar-days', '×ª××¨×™×›×™×', item.dates)}
                            ${detailItem('fa-clock', '×©×¢×ª ××™×¡×•×£', item.pickup_time)}
                            ${detailItem('fa-clock', '×©×¢×ª ×”×—×–×¨×”', item.return_time)}
                            ${detailItem('fa-map-marker-alt', '××™×§×•× ××™×¡×•×£', item.pickup_location)}
                            ${detailItem('fa-car-side', '×¡×•×’ ×¨×›×‘', item.car_type)}
                            ${detailItem('fa-dollar-sign', '××—×™×¨', item.price ? `$${item.price.toLocaleString()}` : '')}
                            ${detailItem('fa-building-user', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                        </div>`;
                    });
                }
                if(others.length) {
                    html += `<h4>ğŸš¢ ×¨×›×‘×•×ª ×•××¢×‘×•×¨×•×ª</h4>`;
                    others.forEach(item => {
                        const isFerry = item.type === 'ferry';
                        const title = isFerry ? `××¢×‘×•×¨×ª: ${item.from_destination} â† ${item.to_destination}` : `×¨×›×‘×ª: ${item.from_station} â† ${item.to_station}`;
                        const fromLabel = isFerry ? '× ××œ ×™×¦×™××”' : '×ª×—× ×ª ×™×¦×™××”';
                        const toLabel = isFerry ? '× ××œ ×”×’×¢×”' : '×ª×—× ×ª ×”×’×¢×”';
                        const fromVal = item.from_destination || item.from_station;
                        const toVal = item.to_destination || item.to_station;
                        html += `<div class="detail-card">
                            <h5>${title}</h5>
                            ${detailItem('fa-building', '×—×‘×¨×”', item.company)}
                            ${detailItem('fa-map-pin', fromLabel, fromVal)}
                            ${detailItem('fa-map-pin', toLabel, toVal)}
                            ${detailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                            ${detailItem('fa-clock', '×©×¢×ª ×™×¦×™××”', item.departure_time)}
                            ${detailItem('fa-clock', '×©×¢×ª ×”×’×¢×”', item.arrival_time)}
                            ${detailItem('fa-dollar-sign', '××—×™×¨', item.price ? `$${item.price.toLocaleString()}` : '')}
                        </div>`;
                    });
                }
            }

            // 3. Places of Interest (Attractions)
            if (data.places.length > 0) {
                html += `<div class="page-break"></div><h3>××˜×¨×§×¦×™×•×ª ×•××§×•××•×ª ×¢× ×™×™×Ÿ</h3>`;
                data.places.forEach(place => {
                       html += `<div class="detail-card">
                            <h5>${place.name || '××§×•×'} (${place.type || '×œ× ×¦×•×™×Ÿ ×¡×•×’'})</h5>
                            ${detailItem('fa-map-marker-alt', '×™×¢×“', place.destination)}
                            ${detailItem('fa-location-dot', '×›×ª×•×‘×ª', place.location)}
                            ${detailItem('fa-clock', '×©×¢×•×ª ×¤×ª×™×—×”', place.hours)}
                            ${detailItem('fa-calendar-check', '×”×–×× ×”', place.reservation)}
                            ${detailItem('fa-align-left', '×ª×™××•×¨ ×§×¦×¨', place.shortDescription)}
                            ${detailItem('fa-pen-to-square', '×ª×™××•×¨ ××œ×', place.description)}
                            ${place.type === '××¡×¢×“×”/××•×›×œ' ? detailItem('fa-star-of-david', '×›×©×¨×•×ª', place.isKosher) : ''}
                            ${place.type === '××¡×¢×“×”/××•×›×œ' ? detailItem('fa-utensils', '×¡×•×’ ××•×›×œ', place.foodType) : ''}
                            ${detailItem('fa-link', '×§×™×©×•×¨', place.link)}
                           </div>`;
                });
            }

            // 4. Daily Schedule
            if (data.schedules.length > 0) {
                 data.schedules.forEach(day => {
                    const dayTitle = day.title ? ` - ${day.title}` : '';
                    html += `<div class="page-break"></div><h3>×œ×•"×– ×™×•××™: ${formatISODate(day.id)}${dayTitle}</h3>`;
                    
                    if (day.items && day.items.length > 0) {
                        day.items.forEach(item => {
                            const time = `${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''}`;
                            html += `<div class="daily-item">
                                        <h5><span class="time">${time}</span> - ${item.title}</h5>`;
                            if (item.summary) {
                                html += `<p class="summary">${item.summary}</p>`;
                            }
                            if (item.refs && item.refs.length > 0) {
                                item.refs.forEach(ref => {
                                    const source = ref.type === 'logistics' ? data.logistics : data.places;
                                    const fullItem = source.find(s => s.id === ref.id);
                                    if (fullItem) {
                                        let refText = `<b>××§×•×©×¨ ×œ:</b> ${fullItem.name}. `;
                                        const address = fullItem.address || fullItem.location;
                                        if (address) refText += `<b>×›×ª×•×‘×ª:</b> ${address}.`;
                                        html += `<div class="ref-details">${refText}</div>`;
                                    }
                                });
                            }
                            html += `</div>`;
                        });
                    } else {
                        html += `<p style="text-align: center; color: #777; margin-top: 20px;">××™×Ÿ ×¤×¢×™×œ×•×™×•×ª ××ª×•×›× × ×•×ª ×œ×™×•× ×–×”.</p>`;
                    }

                    if (day.notes && day.notes.length > 0) {
                        html += `<h5 style="margin-top: 25px;">ğŸ“ ×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h5>`;
                        day.notes.forEach(note => {
                            const sanitizedDetails = note.details ? String(note.details).replace(/</g, "&lt;").replace(/>/g, "&gt;") : '';
                            html += `<div class="note-item note-color-${note.color || 'yellow'}">
                                <strong>${note.kind}: ${note.title || ''}</strong>
                                ${note.details ? `<p>${sanitizedDetails}</p>` : ''}
                             </div>`;
                        });
                    }
                });
            }

            // --- ×©×™× ×•×™: ×”×—×œ×¤×ª ×›×œ ×”×œ×•×’×™×§×” ×©×œ ×”×¦×’×ª ×¨×©×™××•×ª ×”×¦×™×•×“ ---
            // 5. Checklists - New detailed version
            if (data.checklists.length > 0) {
                html += `<div class="page-break"></div><h3>×¨×©×™××•×ª ×¦×™×•×“</h3>`;
                
                const byType = groupBy(data.checklists, 'type');
                const typeKeys = Object.keys(byType).sort();

                for (const type of typeKeys) {
                    const listsInType = byType[type];
                    const typeEmoji = getEmoji('types', type);
                    html += `<div class="checklist-group"><h4>${typeEmoji} ${type || '×›×œ×œ×™'}</h4>`;
                    
                    const byDest = groupBy(listsInType, 'destination');
                    const destKeys = Object.keys(byDest).sort();

                    for (const dest of destKeys) {
                        const listsInDest = byDest[dest];
                        if (dest !== '×›×œ×œ×™') {
                            html += `<h5>×™×¢×“: ${dest}</h5>`;
                        }

                        const byTopic = groupBy(listsInDest, 'subType');
                        const topicKeys = Object.keys(byTopic).sort();

                        for (const topic of topicKeys) {
                             if (topic !== '×›×œ×œ×™') {
                                html += `<h5>× ×•×©×: ${topic}</h5>`;
                            }
                            
                            listsInTopic.forEach(list => {
                                html += `<div class="checklist-container">`;
                                html += `<div class="checklist-list-title">${list.name}</div>`;
                                
                                const sortedItems = (list.items || []).slice().sort((a,b) => (b.priority || 0) - (a.priority || 0));

                                if (sortedItems.length > 0) {
                                    sortedItems.forEach(item => {
                                        const checkbox = item.checked ? 'â˜‘' : 'â˜';
                                        const checkedClass = item.checked ? 'item-checked' : '';
                                        const descriptionHtml = item.description ? `<p class="item-description">${item.description.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</p>` : '';
                                        
                                        html += `
                                        <div class="checklist-item priority-${item.priority || 1} ${checkedClass}">
                                            <span class="checkbox">${checkbox}</span>
                                            <div class="item-details">
                                                <span class="item-text">${item.text} (×›××•×ª: ${item.quantity || 1})</span>
                                                ${descriptionHtml}
                                            </div>
                                        </div>`;
                                    });
                                } else {
                                    html += `<p style="font-size: 12px; color: #888;">××™×Ÿ ×¤×¨×™×˜×™× ×‘×¨×©×™××” ×–×•.</p>`;
                                }
                                html += `</div>`;
                            });
                        }
                    }
                    html += `</div>`; // close checklist-group
                }
            }
            // --- ×¡×•×£ ×”×©×™× ×•×™ ---

            html += '</div>'; // close report-page
            return html;
        }

        // --- PDF Generation Orchestrator ---
        async function generatePdf() {
            if (isGenerating) return;
            
            try {
                const allData = await fetchAllTripData();
                setStatus('××™×™×¦×¨ ××ª ×§×•×‘×¥ ×”-PDF...', true);

                DOM.reportContainer.innerHTML = renderReportHtml(allData);
                
                const element = DOM.reportContainer.querySelector('.report-page');
                const opt = {
                    margin:       [15, 10, 15, 10],
                    filename:     `Trip_Summary_${allData.tripData.name || tripId}.pdf`,
                    image:        { type: 'jpeg', quality: 0.98 },
                    html2canvas:  { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak:    { mode: ['css', 'legacy'] }
                };

                await html2pdf().set(opt).from(element).save();
                
                setStatus('×”×”×•×¨×“×” ×”×•×©×œ××”!', false);

            } catch (error) {
                console.error("Error generating PDF:", error);
                setStatus(`×©×’×™××” ×‘×™×¦×™×¨×ª ×”×§×•×‘×¥: ${error.message}`, false);
            } finally {
                DOM.reportContainer.innerHTML = ''; // Clean up
            }
        }
        
        // --- Event Listeners ---
        DOM.generatePdfBtn.addEventListener('click', generatePdf);

        // --- Start the App ---
        initPage();
    </script>
</body>
</html>