<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ייצוא סיכום טיול</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <!-- ספריות צד-שלישי ליצירת קבצים -->
    <!-- PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Word (.docx) -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>

    <!-- פונט עברי עבור PDF -->
    <script src="https://cdn.jsdelivr.net/gh/tomer-panfil/Amiri-Font-for-jsPDF/Amiri-Regular.js"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; }
        .export-btn { transition: all 0.3s ease; }
        .export-btn:hover:not(:disabled) { transform: translateY(-3px) scale(1.02); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .export-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="bg-slate-100">

    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/IrS6mDW.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/60"></div>
    
    <div class="relative z-10 min-h-screen flex flex-col">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה לדף הטיול">
                            <i class="fas fa-arrow-left fa-lg"></i>
                        </a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">ייצוא סיכום טיול</h1>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow flex items-center justify-center p-4">
            <div class="w-full max-w-2xl bg-white/90 backdrop-blur-sm rounded-2xl shadow-2xl p-8 text-center">
                <i class="fas fa-file-export fa-3x text-blue-500 mb-4"></i>
                <h2 id="export-title" class="text-3xl font-extrabold text-slate-800">הפקת סיכום הטיול</h2>
                <p class="text-slate-600 mt-2 mb-8">בחר את הפורמט הרצוי כדי ליצור קובץ מסודר עם כל פרטי הטיול, מוכן להדפסה או שמירה.</p>

                <div class="flex flex-col sm:flex-row gap-4 justify-center">
                    <button id="generate-pdf-btn" class="export-btn w-full sm:w-auto flex-1 bg-red-500 hover:bg-red-600 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-pdf mr-2"></i> צור קובץ PDF
                    </button>
                    <button id="generate-docx-btn" class="export-btn w-full sm:w-auto flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-6 rounded-xl">
                        <i class="fas fa-file-word mr-2"></i> צור קובץ Word
                    </button>
                </div>

                <div id="status-container" class="mt-8 min-h-[60px] flex flex-col items-center justify-center">
                    <div id="loader" class="loader hidden"></div>
                    <p id="status-message" class="text-slate-500 font-semibold"></p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        // --- Firebase Imports ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, getDocs, query, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- DOM Elements ---
        const DOM = {
            loader: document.getElementById('loader'),
            statusMessage: document.getElementById('status-message'),
            generatePdfBtn: document.getElementById('generate-pdf-btn'),
            generateDocxBtn: document.getElementById('generate-docx-btn'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            pageTitle: document.getElementById('page-title'),
            exportTitle: document.getElementById('export-title'),
        };

        // --- State ---
        let tripId = null;
        let currentUser = null;
        let isGenerating = false;
        let db;

        // --- Main Initialization Function ---
        async function initPage() {
            // 1. Initialize Firebase safely
            try {
                // Use environment variables for configuration for better security
                const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                const auth = getAuth(app);
                
                // Authenticate the user
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Firebase initialization failed:", error);
                setStatus("שגיאה בהתחברות לשירות. נסה לרענן את הדף.");
                return;
            }

            // 2. Get Trip ID from URL
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                setStatus("שגיאה: לא נמצא מזהה טיול. הנך מועבר לדף הבית.");
                setTimeout(() => window.location.href = 'index.html', 3000);
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            // 3. Set up Auth Listener and fetch initial data
            const auth = getAuth();
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await verifyAccessAndLoadTripName();
                } else {
                     setStatus("נדרשת התחברות. הנך מועבר לדף ההתחברות.");
                     setTimeout(() => window.location.href = 'login.html', 3000);
                }
            });

            // 4. Attach event listeners
            DOM.generatePdfBtn.addEventListener('click', () => generateDocument('pdf'));
            DOM.generateDocxBtn.addEventListener('click', () => generateDocument('docx'));
        }
        
        async function verifyAccessAndLoadTripName() {
            try {
                const tripRef = doc(db, "trips", tripId);
                const tripSnap = await getDoc(tripRef);

                if (tripSnap.exists()) {
                    const tripData = tripSnap.data();
                    // IMPORTANT: This is client-side validation. Ensure you have Firestore security rules to enforce this on the server.
                    const canAccess = tripData.editors?.includes(currentUser.uid); 
                    if (!canAccess) {
                        setStatus("אין לך הרשאה לצפות בטיול זה. הנך מועבר לדף הבית.");
                        setTimeout(() => window.location.href = 'index.html', 3000);
                    } else {
                        DOM.pageTitle.textContent = `ייצוא סיכום טיול - ${tripData.name}`;
                        DOM.exportTitle.textContent = `הפקת סיכום הטיול "${tripData.name}"`;
                        DOM.generatePdfBtn.disabled = false;
                        DOM.generateDocxBtn.disabled = false;
                    }
                } else {
                    setStatus("הטיול לא נמצא. הנך מועבר לדף הבית.");
                    setTimeout(() => window.location.href = 'index.html', 3000);
                }
            } catch (error) {
                console.error("Error verifying access:", error);
                setStatus("שגיאה באימות הרשאות הגישה לטיול.");
            }
        }

        function setStatus(message, showLoader = false) {
            DOM.statusMessage.textContent = message;
            DOM.loader.classList.toggle('hidden', !showLoader);
            const shouldDisableButtons = isGenerating || showLoader;
            DOM.generatePdfBtn.disabled = shouldDisableButtons;
            DOM.generateDocxBtn.disabled = shouldDisableButtons;
        }

        // --- Data Fetching ---
        async function fetchAllTripData() {
            setStatus('טוען נתונים מהשרת...', true);
            const tripRef = doc(db, 'trips', tripId);
            const collectionsToFetch = ['logistics', 'places', 'checklists', 'schedules'];

            const [tripSnap, ...collectionsSnaps] = await Promise.all([
                getDoc(tripRef),
                ...collectionsToFetch.map(c => getDocs(query(collection(db, 'trips', tripId, c), orderBy('createdAt'))))
            ]);

            if (!tripSnap.exists()) throw new Error("Trip data not found.");

            const allData = {
                tripData: tripSnap.data(),
                logistics: collectionsSnaps[0].docs.map(d => ({ id: d.id, ...d.data() })),
                places: collectionsSnaps[1].docs.map(d => ({ id: d.id, ...d.data() })),
                checklists: collectionsSnaps[2].docs.map(d => ({ id: d.id, ...d.data() })),
                schedules: []
            };

            const scheduleDocs = collectionsSnaps[3].docs;
            for (const scheduleDoc of scheduleDocs) {
                const dayData = { id: scheduleDoc.id, ...scheduleDoc.data() };
                const itemsQuery = query(collection(scheduleDoc.ref, 'items'), orderBy('sort'));
                const notesQuery = query(collection(scheduleDoc.ref, 'notes'), orderBy('createdAt'));
                
                const [itemsSnap, notesSnap] = await Promise.all([ getDocs(itemsQuery), getDocs(notesQuery) ]);

                dayData.items = itemsSnap.docs.map(d => d.data());
                dayData.notes = notesSnap.docs.map(d => d.data());
                allData.schedules.push(dayData);
            }
            
            allData.schedules.sort((a,b) => a.id.localeCompare(b.id));
            return allData;
        }

        // --- Document Generation Orchestrator ---
        async function generateDocument(format) {
            if (isGenerating) return;
            isGenerating = true;
            
            try {
                const allData = await fetchAllTripData();
                setStatus(`מייצר קובץ ${format.toUpperCase()}...`, true);

                if (format === 'pdf') {
                    await buildPdf(allData);
                } else if (format === 'docx') {
                    await buildDocx(allData);
                }
                
                setStatus('ההורדה הושלמה!', false);
            } catch (error) {
                console.error(`Error generating ${format}:`, error);
                setStatus(`שגיאה ביצירת הקובץ: ${error.message}`, false);
            } finally {
                isGenerating = false;
                setStatus('מוכן לייצוא נוסף.', false);
            }
        }
        
        // --- Helper: Date Formatting ---
        function formatISODate(isoDate) {
             if (!isoDate || !/^\d{4}-\d{2}-\d{2}$/.test(isoDate)) return "תאריך לא תקין";
            const [year, month, day] = isoDate.split('-');
            const dateObj = new Date(year, month - 1, day);
            const weekday = dateObj.toLocaleDateString('he-IL', { weekday: 'long', timeZone: 'UTC' });
            return `${weekday}, ${day}/${month}/${year}`;
        }

        // --- PDF Builder ---
        async function buildPdf(data) {
            const { jsPDF } = window.jspdf;
            const docPDF = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            
            docPDF.addFileToVFS('Amiri-Regular.ttf', amiri_regular_base64);
            docPDF.addFont('Amiri-Regular.ttf', 'Amiri', 'normal');
            docPDF.setFont('Amiri');
            
            const reversedText = (text) => String(text).split('').reverse().join('');

            // Cover Page
            docPDF.setFontSize(32);
            docPDF.text(reversedText(data.tripData.name), docPDF.internal.pageSize.getWidth() / 2, 80, { align: 'center' });
            docPDF.setFontSize(16);
            docPDF.text(reversedText(`תאריכים: ${data.tripData.startDate} - ${data.tripData.endDate}`), docPDF.internal.pageSize.getWidth() / 2, 100, { align: 'center' });

            // Logistics
            if (data.logistics.length > 0) {
                docPDF.addPage();
                docPDF.setFontSize(22);
                docPDF.text(reversedText('סיכום לוגיסטיקה'), 105, 20, { align: 'center' });
                const logisticsBody = data.logistics.map(item => [
                    reversedText(item.name || item.type || 'N/A'),
                    reversedText(item.destination || item.dates || ''),
                    `$${(item.price || item.price_per_person || 0).toLocaleString()}`
                ]);
                docPDF.autoTable({
                    startY: 30,
                    head: [[reversedText('מחיר'), reversedText('יעד/תאריכים'), reversedText('תיאור')]],
                    body: logisticsBody.map(row => row.reverse()),
                    styles: { font: 'Amiri', halign: 'right' },
                    headStyles: { fillColor: [41, 128, 185], halign: 'right' },
                });
            }

            // Daily Schedule
            for (const day of data.schedules) {
                docPDF.addPage();
                docPDF.setFontSize(22);
                docPDF.text(reversedText(formatISODate(day.id)), 105, 20, { align: 'center' });
                let y = 35;

                for (const item of day.items) {
                    if (y > 270) { docPDF.addPage(); y = 20; }
                    docPDF.setFontSize(14);
                    const time = `${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''}`;
                    docPDF.text(reversedText(`${time} - ${item.title}`), 195, y, { align: 'right' });
                    y += 7;

                    if (item.summary) {
                        docPDF.setFontSize(10);
                        const summaryLines = docPDF.splitTextToSize(reversedText(item.summary), 180);
                        docPDF.text(summaryLines, 190, y, { align: 'right' });
                        y += (summaryLines.length * 4) + 2;
                    }
                    
                    if (item.refs && item.refs.length > 0) {
                        for (const ref of item.refs) {
                           const source = ref.type === 'logistics' ? data.logistics : data.places;
                           const fullItem = source.find(s => s.id === ref.id);
                           if (fullItem) {
                               docPDF.setFontSize(10);
                               docPDF.setTextColor(100);
                               let refText = `פרטים: ${fullItem.name}. `;
                               if (fullItem.location || fullItem.address) refText += `כתובת: ${fullItem.location || fullItem.address}.`;
                               const refLines = docPDF.splitTextToSize(reversedText(refText), 170);
                               docPDF.text(refLines, 185, y, { align: 'right' });
                               y += (refLines.length * 4);
                               docPDF.setTextColor(0);
                           }
                        }
                    }
                     y += 5;
                }
            }
            
            // Checklists
            if(data.checklists.length > 0) {
                 docPDF.addPage();
                 docPDF.setFontSize(22);
                 docPDF.text(reversedText('רשימות וצ\'ק-ליסטים'), 105, 20, { align: 'center' });
                 let checklistY = 30;
                 data.checklists.forEach(list => {
                     if (checklistY > 260) { docPDF.addPage(); checklistY = 20; }
                     docPDF.setFontSize(16);
                     docPDF.text(reversedText(list.name), 195, checklistY, { align: 'right' });
                     checklistY += 8;
                     list.items.forEach(item => {
                         if (checklistY > 270) { docPDF.addPage(); checklistY = 20; }
                         docPDF.setFontSize(12);
                         const itemText = `[ ] ${item.text} (x${item.quantity})`;
                         docPDF.text(reversedText(itemText), 190, checklistY, { align: 'right' });
                         checklistY += 6;
                     });
                     checklistY += 10;
                 });
            }

            docPDF.save(`trip_summary_${tripId}.pdf`);
        }
        
        // --- Word (.docx) Builder ---
        async function buildDocx(data) {
             const { Document, Packer, Paragraph, TextRun, HeadingLevel, Table, TableCell, TableRow, WidthType, AlignmentType } = docx;

            const sections = [];

            // Cover Page
            sections.push({
                children: [
                    new Paragraph({ text: "", spacing: { before: 4000 } }),
                    new Paragraph({ text: data.tripData.name, heading: HeadingLevel.TITLE, alignment: AlignmentType.CENTER }),
                    new Paragraph({ text: `תאריכים: ${data.tripData.startDate} - ${data.tripData.endDate}`, heading: HeadingLevel.HEADING_2, alignment: AlignmentType.CENTER }),
                ],
            });

            // Logistics
            if (data.logistics.length > 0) {
                const logisticsRows = data.logistics.map(item => new TableRow({
                    children: [
                        new TableCell({ children: [new Paragraph({ children: [new TextRun(item.name || item.type || 'N/A')]})], width: { size: 3000, type: WidthType.DXA } }),
                        new TableCell({ children: [new Paragraph({ children: [new TextRun(item.destination || item.dates || '')]})], width: { size: 4000, type: WidthType.DXA } }),
                        new TableCell({ children: [new Paragraph({ children: [new TextRun(`$${(item.price || item.price_per_person || 0).toLocaleString()}`) ]})], width: { size: 2000, type: WidthType.DXA } }),
                    ],
                }));

                const logisticsTable = new Table({
                    rows: [
                        new TableRow({
                            children: [
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "תיאור", bold: true })]})] }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "יעד/תאריכים", bold: true })]})] }),
                                new TableCell({ children: [new Paragraph({ children: [new TextRun({ text: "מחיר", bold: true })]})] }),
                            ],
                            tableHeader: true,
                        }),
                        ...logisticsRows
                    ],
                    width: { size: 9000, type: WidthType.DXA },
                });
                
                sections.push({
                    properties: { page: {SectPr:{type: "nextPage"}}},
                    children: [
                        new Paragraph({ text: "סיכום לוגיסטיקה", heading: HeadingLevel.HEADING_1 }),
                        logisticsTable
                    ]
                });
            }


            // Daily Schedule
            data.schedules.forEach(day => {
                const dayChildren = [new Paragraph({ text: formatISODate(day.id), heading: HeadingLevel.HEADING_1 })];
                day.items.forEach(item => {
                    const time = `${item.startTime || ''}${item.endTime ? ' - ' + item.endTime : ''}`;
                    dayChildren.push(new Paragraph({
                        children: [ new TextRun({ text: `${time} - ${item.title}`, bold: true })], spacing: { before: 200 }
                    }));
                    if(item.summary) {
                        dayChildren.push(new Paragraph({ text: item.summary, style: "IntenseQuote" }));
                    }
                    if (item.refs && item.refs.length > 0) {
                         for (const ref of item.refs) {
                           const source = ref.type === 'logistics' ? data.logistics : data.places;
                           const fullItem = source.find(s => s.id === ref.id);
                            if (fullItem) {
                                let refText = `פרטים: ${fullItem.name}. `;
                                if (fullItem.location || fullItem.address) refText += `כתובת: ${fullItem.location || fullItem.address}.`;
                                dayChildren.push(new Paragraph({ text: refText, indentation: { left: 400 }, style: "Compact" }));
                            }
                         }
                    }
                });
                sections.push({ properties: { page: {SectPr:{type: "nextPage"}}}, children: dayChildren });
            });
            
            // Checklists
             if(data.checklists.length > 0) {
                 const checklistChildren = [new Paragraph({ text: "רשימות וצ'ק-ליסטים", heading: HeadingLevel.HEADING_1 })];
                 data.checklists.forEach(list => {
                     checklistChildren.push(new Paragraph({ text: list.name, heading: HeadingLevel.HEADING_2, spacing: { before: 300 }}));
                     list.items.forEach(item => {
                         checklistChildren.push(new Paragraph({ text: `${item.text} (x${item.quantity})`, bullet: { level: 0 } }));
                     });
                 });
                 sections.push({ properties: { page: {SectPr:{type: "nextPage"}}}, children: checklistChildren });
             }

            // Generate and download
            const doc = new Document({
                creator: "Tiool-Loz App",
                title: data.tripData.name,
                sections: sections
            });

            const blob = await Packer.toBlob(doc);
            saveAs(blob, `trip_summary_${tripId}.docx`);
        }

        // --- Start the App after the DOM is fully loaded ---
        document.addEventListener('DOMContentLoaded', initPage);

    </script>
</body>
</html>
