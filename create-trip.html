<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>יצירת טיול חדש</title>

    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- LeafletJS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Litepicker for Date Range -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <style>
        body { font-family: 'Assistant', sans-serif; }
        .main-button {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .main-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .modal-content {
            transition: opacity 0.3s, transform 0.3s;
        }
        .step-hidden {
            opacity: 0;
            transform: translateX(20px);
            display: none !important;
        }
        .leaflet-container { z-index: 10; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[200] flex items-center justify-center">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
    </div>

    <!-- Fixed Background -->
    <div id="page-bg" class="fixed inset-0 z-0 bg-cover bg-center transition-all duration-500" style="background-image: url('https://images.unsplash.com/photo-1499591934245-40232654b021?q=80&w=2070&auto=format&fit=crop');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <!-- Main Content Wrapper -->
    <div class="relative z-10 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-sm sticky top-0 z-40">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
                <a href="index.html" class="text-white font-bold text-xl hover:text-gray-200">
                    <i class="fas fa-home ml-2"></i> חזרה לדף הבית
                </a>
                <button id="settings-btn" class="text-white hover:text-gray-300 transition duration-300">
                    <i class="fas fa-cog fa-lg"></i>
                </button>
            </div>
        </header>

        <!-- Page Content -->
        <main class="flex-grow flex items-center justify-center text-center p-4">
            <div class="space-y-6">
                <h1 class="text-4xl md:text-5xl font-bold text-white drop-shadow-lg">ניהול הטיולים שלך</h1>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 max-w-3xl mx-auto">
                    <!-- Create New Trip Button -->
                    <button id="create-general-btn" class="main-button bg-white/20 backdrop-blur-md hover:bg-white/30 p-8 rounded-xl text-white">
                        <i class="fas fa-map-signs text-4xl mb-3"></i>
                        <h2 class="text-2xl font-bold">יצירת לו"ז כללי חדש</h2>
                        <p class="mt-1">הגדר את מסגרת הטיול, היעדים והתאריכים.</p>
                    </button>

                    <!-- Edit Existing Trip Dropdown -->
                    <div class="relative group">
                        <button class="main-button bg-white/20 backdrop-blur-md hover:bg-white/30 p-8 rounded-xl text-white w-full h-full">
                            <i class="fas fa-edit text-4xl mb-3"></i>
                            <h2 class="text-2xl font-bold">ערוך טיול קיים</h2>
                            <p class="mt-1">פתח ובצע שינויים בטיולים שיצרת.</p>
                        </button>
                        <div id="edit-trip-dropdown" class="absolute right-0 mt-2 w-full bg-white rounded-md shadow-lg py-1 z-20 hidden group-hover:block max-h-60 overflow-y-auto no-scrollbar">
                            <p class="px-4 py-2 text-sm text-gray-500">טוען טיולים...</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Create Trip Modal -->
    <div id="create-trip-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-3xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b flex justify-between items-center">
                <h2 id="modal-title" class="text-xl font-bold">יצירת טיול חדש - שלב 1 מתוך 3</h2>
                <button id="close-modal-btn" class="p-2 text-gray-500 hover:text-red-600">&times;</button>
            </header>
            
            <main class="p-6 overflow-y-auto flex-grow">
                <!-- Step 1: Basic Info -->
                <div id="step-1" class="modal-content">
                    <div class="space-y-4">
                        <div>
                            <label for="trip-name" class="block mb-1 font-semibold text-right">שם הטיול</label>
                            <input type="text" id="trip-name" placeholder="לדוגמה: הטיול הגדול לאירופה" class="w-full p-2 border rounded-md">
                        </div>
                        <div>
                            <label for="trip-dates" class="block mb-1 font-semibold text-right">תאריכי הטיול (התחלה וסיום)</label>
                            <input type="text" id="trip-dates" class="w-full p-2 border rounded-md text-center">
                        </div>
                    </div>
                </div>

                <!-- Step 2: Destinations -->
                <div id="step-2" class="modal-content step-hidden">
                    <div id="destinations-container" class="space-y-6">
                        <!-- Destination items will be injected here -->
                    </div>
                    <button id="add-destination-btn" class="mt-6 w-full bg-gray-200 hover:bg-gray-300 font-semibold py-2 rounded-lg flex items-center justify-center gap-2">
                        <i class="fas fa-plus-circle"></i> הוסף יעד
                    </button>
                </div>

                <!-- Step 3: Review Map -->
                <div id="step-3" class="modal-content step-hidden">
                    <p class="mb-4 text-center">זוהי מפת המסלול שלך. ודא שהכל נכון לפני השמירה.</p>
                    <div id="review-map" class="w-full h-80 bg-gray-200 rounded-lg"></div>
                    <div id="review-legend" class="mt-4 text-right"></div>
                </div>
            </main>

            <footer class="p-4 border-t flex justify-between">
                <button id="back-btn" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded-lg hidden">חזור</button>
                <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">הבא</button>
                <button id="save-trip-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg hidden">שמור טיול</button>
            </footer>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/70 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-md">
            <h2 class="text-xl font-bold mb-4 text-right">הגדרות עמוד</h2>
            <div>
                <label for="bg-url-input" class="block mb-1 font-semibold text-right">קישור לתמונת רקע</label>
                <input type="url" id="bg-url-input" class="w-full p-2 border rounded-md text-left" dir="ltr">
            </div>
            <div class="mt-6 flex justify-end gap-4">
                <button id="close-settings-btn" class="bg-gray-300 hover:bg-gray-400 font-bold py-2 px-4 rounded-lg">ביטול</button>
                <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">שמירה</button>
            </div>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, where, onSnapshot, addDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            pageBg: document.getElementById('page-bg'),
            createGeneralBtn: document.getElementById('create-general-btn'),
            editTripDropdown: document.getElementById('edit-trip-dropdown'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            bgUrlInput: document.getElementById('bg-url-input'),
            createTripModal: document.getElementById('create-trip-modal'),
            closeModalBtn: document.getElementById('close-modal-btn'),
            modalTitle: document.getElementById('modal-title'),
            steps: [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')],
            backBtn: document.getElementById('back-btn'),
            nextBtn: document.getElementById('next-btn'),
            saveTripBtn: document.getElementById('save-trip-btn'),
            tripNameInput: document.getElementById('trip-name'),
            tripDatesInput: document.getElementById('trip-dates'),
            destinationsContainer: document.getElementById('destinations-container'),
            addDestinationBtn: document.getElementById('add-destination-btn'),
            reviewMapContainer: document.getElementById('review-map'),
            reviewLegend: document.getElementById('review-legend'),
        };

        let currentUser = null;
        let currentStep = 0;
        let tripData = {};
        let destinationUIs = []; // To hold map instances and elements
        let reviewMap = null;

        // --- Auth & Page Load ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                loadPageSettings();
                loadUserTrips();
                DOM.loadingOverlay.style.display = 'none';
            } else {
                window.location.href = 'login.html';
            }
        });

        async function loadPageSettings() {
            const userDocRef = doc(db, "users", currentUser.uid);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                const settings = docSnap.data().settings;
                if (settings?.createTripBg) {
                    DOM.pageBg.style.backgroundImage = `url('${settings.createTripBg}')`;
                    DOM.bgUrlInput.value = settings.createTripBg;
                }
            }
        }
        
        function loadUserTrips() {
            const q = query(collection(db, "trips"), where("ownerId", "==", currentUser.uid));
            onSnapshot(q, (querySnapshot) => {
                if (querySnapshot.empty) {
                    DOM.editTripDropdown.innerHTML = `<p class="px-4 py-2 text-sm text-gray-500">אין טיולים קיימים.</p>`;
                    return;
                }
                DOM.editTripDropdown.innerHTML = '';
                querySnapshot.forEach((doc) => {
                    const trip = doc.data();
                    const link = document.createElement('a');
                    link.href = `edit-trip.html?id=${doc.id}`; // This page will be created later
                    link.className = 'block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100';
                    link.textContent = trip.name;
                    DOM.editTripDropdown.appendChild(link);
                });
            });
        }

        // --- Modal & Step Management ---
        function openCreateModal() {
            resetModal();
            DOM.createTripModal.classList.remove('hidden');
            new Litepicker({ element: DOM.tripDatesInput, singleMode: false, lang: 'he-IL', format: 'DD/MM/YYYY' });
        }

        function closeModal() {
            DOM.createTripModal.classList.add('hidden');
        }

        function updateStep(newStep) {
            if (newStep < 0 || newStep >= DOM.steps.length) return;
            
            // Validation before proceeding
            if (newStep > currentStep) {
                if (currentStep === 0 && (!DOM.tripNameInput.value || !DOM.tripDatesInput.value)) {
                    alert('יש למלא שם ותאריכי טיול.');
                    return;
                }
                if (currentStep === 1 && destinationUIs.length === 0) {
                    alert('יש להוסיף לפחות יעד אחד.');
                    return;
                }
            }

            DOM.steps[currentStep].classList.add('step-hidden');
            currentStep = newStep;
            DOM.steps[currentStep].classList.remove('step-hidden');
            
            DOM.modalTitle.textContent = `יצירת טיול חדש - שלב ${currentStep + 1} מתוך 3`;
            DOM.backBtn.classList.toggle('hidden', currentStep === 0);
            DOM.nextBtn.textContent = (currentStep === 1) ? 'צור מפת מסלול' : 'הבא';
            DOM.nextBtn.classList.toggle('hidden', currentStep === 2);
            DOM.saveTripBtn.classList.toggle('hidden', currentStep !== 2);

            if (currentStep === 2) {
                generateReviewMap();
            }
        }

        function resetModal() {
            currentStep = 0;
            updateStep(0);
            DOM.tripNameInput.value = '';
            DOM.tripDatesInput.value = '';
            DOM.destinationsContainer.innerHTML = '';
            destinationUIs = [];
            if (reviewMap) {
                reviewMap.remove();
                reviewMap = null;
            }
        }

        // --- Destination Management ---
        function addDestination() {
            const id = `dest-${Date.now()}`;
            const destinationDiv = document.createElement('div');
            destinationDiv.id = id;
            destinationDiv.className = 'p-4 border rounded-lg space-y-3 relative';
            destinationDiv.innerHTML = `
                <button class="remove-dest-btn absolute top-2 left-2 text-red-500 hover:text-red-700">&times;</button>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block mb-1 text-sm font-semibold text-right">שם היעד (עברית)</label>
                        <input type="text" class="dest-name-he w-full p-2 border rounded-md">
                    </div>
                    <div>
                        <label class="block mb-1 text-sm font-semibold text-right">תאריכים ביעד</label>
                        <input type="text" class="dest-dates w-full p-2 border rounded-md text-center">
                    </div>
                </div>
                <div>
                    <label class="block mb-1 text-sm font-semibold text-right">שם היעד (אנגלית, לחיפוש)</label>
                    <div class="flex gap-2">
                        <input type="text" class="dest-name-en w-full p-2 border rounded-md">
                        <button class="find-map-btn bg-blue-500 text-white px-3 rounded-md hover:bg-blue-600">מצא</button>
                    </div>
                </div>
                <div class="dest-map w-full h-48 bg-gray-200 rounded-md mt-2"></div>
            `;
            DOM.destinationsContainer.appendChild(destinationDiv);
            
            const mapContainer = destinationDiv.querySelector('.dest-map');
            const map = L.map(mapContainer).setView([51.505, -0.09], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            destinationUIs.push({
                id: id,
                element: destinationDiv,
                map: map,
                marker: null,
                coords: null
            });
            
            new Litepicker({ element: destinationDiv.querySelector('.dest-dates'), singleMode: false, lang: 'he-IL', format: 'DD/MM/YYYY' });
        }

        async function findOnMap(e) {
            const btn = e.target;
            const parent = btn.closest('.relative');
            const query = parent.querySelector('.dest-name-en').value;
            if (!query) return;

            const ui = destinationUIs.find(d => d.id === parent.id);
            if (!ui) return;

            btn.textContent = '...';
            const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}`);
            const data = await response.json();
            btn.textContent = 'מצא';

            if (data && data.length > 0) {
                const { lat, lon } = data[0];
                ui.coords = { lat: parseFloat(lat), lng: parseFloat(lon) };
                if (ui.marker) ui.marker.setLatLng([lat, lon]);
                else ui.marker = L.marker([lat, lon]).addTo(ui.map);
                ui.map.setView([lat, lon], 10);
            } else {
                alert('היעד לא נמצא.');
            }
        }
        
        function removeDestination(e) {
            const btn = e.target;
            const parent = btn.closest('.relative');
            const uiIndex = destinationUIs.findIndex(d => d.id === parent.id);
            if (uiIndex > -1) {
                destinationUIs[uiIndex].map.remove();
                destinationUIs.splice(uiIndex, 1);
                parent.remove();
            }
        }

        // --- Review Map ---
        function generateReviewMap() {
            if (reviewMap) reviewMap.remove();
            reviewMap = L.map(DOM.reviewMapContainer).setView([51.505, -0.09], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(reviewMap);

            const points = [];
            DOM.reviewLegend.innerHTML = '<h4 class="font-bold mb-2">מקרא:</h4>';

            destinationUIs.forEach((ui, index) => {
                const nameHe = ui.element.querySelector('.dest-name-he').value;
                const dates = ui.element.querySelector('.dest-dates').value;
                if (ui.coords) {
                    points.push([ui.coords.lat, ui.coords.lng]);
                    L.marker([ui.coords.lat, ui.coords.lng])
                        .addTo(reviewMap)
                        .bindPopup(`<b>${index + 1}. ${nameHe}</b><br>${dates}`);
                    
                    const p = document.createElement('p');
                    p.textContent = `${index + 1}. ${nameHe} (${dates})`;
                    DOM.reviewLegend.appendChild(p);
                }
            });

            if (points.length > 1) {
                L.polyline(points, {color: 'blue', dashArray: '5, 10'}).addTo(reviewMap);
                reviewMap.fitBounds(points, { padding: [50, 50] });
            } else if (points.length === 1) {
                reviewMap.setView(points[0], 8);
            }
        }

        // --- Save Logic ---
        async function saveTrip() {
            const [tripStart, tripEnd] = DOM.tripDatesInput.value.split(' - ');
            
            const finalTripData = {
                name: DOM.tripNameInput.value,
                startDate: tripStart,
                endDate: tripEnd,
                ownerId: currentUser.uid,
                createdAt: new Date(),
                destinations: destinationUIs.map(ui => ({
                    nameHe: ui.element.querySelector('.dest-name-he').value,
                    nameEn: ui.element.querySelector('.dest-name-en').value,
                    dates: ui.element.querySelector('.dest-dates').value,
                    coords: ui.coords
                }))
            };

            try {
                DOM.saveTripBtn.textContent = 'שומר...';
                DOM.saveTripBtn.disabled = true;
                const docRef = await addDoc(collection(db, "trips"), finalTripData);
                alert('הטיול נשמר בהצלחה!');
                window.location.href = `trip.html?id=${docRef.id}`; // Redirect to the new trip page
            } catch (error) {
                console.error("Error adding document: ", error);
                alert('שגיאה בשמירת הטיול.');
                DOM.saveTripBtn.textContent = 'שמור טיול';
                DOM.saveTripBtn.disabled = false;
            }
        }
        
        async function saveSettings() {
            const userDocRef = doc(db, "users", currentUser.uid);
            try {
                await setDoc(userDocRef, {
                    settings: { createTripBg: DOM.bgUrlInput.value }
                }, { merge: true });
                DOM.pageBg.style.backgroundImage = `url('${DOM.bgUrlInput.value}')`;
                DOM.settingsModal.classList.add('hidden');
            } catch (e) {
                alert('שגיאה בשמירת ההגדרות');
            }
        }

        // --- Event Listeners ---
        DOM.createGeneralBtn.addEventListener('click', openCreateModal);
        DOM.closeModalBtn.addEventListener('click', closeModal);
        DOM.nextBtn.addEventListener('click', () => updateStep(currentStep + 1));
        DOM.backBtn.addEventListener('click', () => updateStep(currentStep - 1));
        DOM.addDestinationBtn.addEventListener('click', addDestination);
        DOM.destinationsContainer.addEventListener('click', e => {
            if (e.target.classList.contains('find-map-btn')) findOnMap(e);
            if (e.target.classList.contains('remove-dest-btn')) removeDestination(e);
        });
        DOM.saveTripBtn.addEventListener('click', saveTrip);
        DOM.settingsBtn.addEventListener('click', () => DOM.settingsModal.classList.remove('hidden'));
        DOM.closeSettingsBtn.addEventListener('click', () => DOM.settingsModal.classList.add('hidden'));
        DOM.saveSettingsBtn.addEventListener('click', saveSettings);

    </script>
</body>
</html>