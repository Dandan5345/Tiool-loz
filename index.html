<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מתכנן הטיולים שלך</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        #loading-overlay {
            transition: opacity 0.5s ease-in-out;
        }
        .main-nav-button {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .main-nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-gray-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">טוען את מתכנן הטיולים...</p>
    </div>

    <!-- Fixed Background -->
    <div id="main-bg" class="fixed inset-0 z-0 bg-cover bg-center transition-all duration-500"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <!-- Scrollable Content Wrapper -->
    <div class="relative z-10 min-h-screen flex flex-col">
        <!-- Header -->
        <header class="bg-white/10 backdrop-blur-sm sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- User Authentication Section -->
                    <div id="auth-container">
                        <button id="login-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                            התחברות / הרשמה
                        </button>
                        <div id="user-info" class="hidden group relative">
                            <button id="user-name-btn" class="text-lg font-semibold text-white cursor-pointer"></button>
                            <div class="absolute left-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20 hidden group-hover:block">
                                <a href="#" id="logout-btn" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-right">התנתקות</a>
                            </div>
                        </div>
                    </div>

                    <!-- Settings Button -->
                    <button id="settings-btn" class="hidden text-white hover:text-gray-300 transition duration-300">
                        <i class="fas fa-cog fa-lg"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex-grow flex items-center justify-center text-center p-4">
            <div>
                <h1 class="text-4xl md:text-6xl font-bold text-white mb-4 drop-shadow-lg">מתכנן הטיולים שלך</h1>
                <p id="login-prompt-message" class="text-xl text-slate-200 mt-4">על מנת להתחיל, יש <a href="login.html" class="font-bold underline hover:text-blue-300">להתחבר או להירשם</a></p>
                
                <div id="main-actions" class="hidden mt-8 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-2xl mx-auto">
                    <button id="create-trip-btn" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-6 rounded-xl text-white text-center">
                        <i class="fas fa-plus-circle text-3xl mb-2"></i>
                        <span class="font-bold text-lg">יצירת טיול חדש</span>
                    </button>

                    <div class="relative group w-full">
                        <button id="my-trips-btn" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-6 rounded-xl text-white text-center w-full">
                            <i class="fas fa-suitcase-rolling text-3xl mb-2"></i>
                            <span class="font-bold text-lg">הטיולים שלי</span>
                        </button>
                        <div id="trips-dropdown" class="absolute right-0 mt-2 w-full bg-white rounded-md shadow-lg py-1 z-20 hidden group-hover:block max-h-60 overflow-y-auto no-scrollbar">
                            <p class="px-4 py-2 text-sm text-gray-500 text-right">אין טיולים להצגה.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-md text-black">
            <h2 class="text-2xl font-bold mb-6 text-right">הגדרות</h2>
            <div class="mb-6 text-right">
                <label for="bg-image-url" class="block mb-2 font-semibold">תמונת רקע (קישור)</label>
                <input type="url" id="bg-image-url" placeholder="https://example.com/image.jpg" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-left" dir="ltr">
            </div>
            <div id="default-trip-section" class="mb-6 text-right hidden">
                <h3 class="font-semibold mb-3">טיול ברירת מחדל</h3>
                <p class="text-sm text-gray-600 mb-3">בחר טיול שייטען אוטומטית בכניסה לאתר.</p>
                <div id="default-trip-list" class="space-y-2 max-h-48 overflow-y-auto no-scrollbar pr-2"></div>
            </div>
            <div class="flex justify-end space-x-4 space-x-reverse">
                <button id="close-settings-btn" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-4 rounded-lg">סגירה</button>
                <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">שמירה</button>
            </div>
        </div>
    </div>


    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
      import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
      import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

      const firebaseConfig = {
        apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
        authDomain: "tiool-loz.firebaseapp.com",
        projectId: "tiool-loz",
        storageBucket: "tiool-loz.appspot.com",
        messagingSenderId: "226069823505",
        appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);
      
      const DOM = {
          loadingOverlay: document.getElementById('loading-overlay'),
          loginBtn: document.getElementById('login-btn'),
          userInfo: document.getElementById('user-info'),
          userNameBtn: document.getElementById('user-name-btn'),
          logoutBtn: document.getElementById('logout-btn'),
          mainActions: document.getElementById('main-actions'),
          settingsBtn: document.getElementById('settings-btn'),
          createTripBtn: document.getElementById('create-trip-btn'),
          tripsDropdown: document.getElementById('trips-dropdown'),
          loginPromptMessage: document.getElementById('login-prompt-message'),
          settingsModal: document.getElementById('settings-modal'),
          closeSettingsBtn: document.getElementById('close-settings-btn'),
          saveSettingsBtn: document.getElementById('save-settings-btn'),
          bgImageUrlInput: document.getElementById('bg-image-url'),
          defaultTripSection: document.getElementById('default-trip-section'),
          defaultTripList: document.getElementById('default-trip-list'),
          mainBg: document.getElementById('main-bg'),
      };

      let currentUser = null;
      let userUnsubscribe = null; 
      let tripsUnsubscribe = null;
      let isInitialLoad = true;

      function hideLoader() {
        if (isInitialLoad) {
            DOM.loadingOverlay.classList.add('opacity-0');
            setTimeout(() => {
                DOM.loadingOverlay.style.display = 'none';
            }, 500);
            isInitialLoad = false;
        }
      }

      onAuthStateChanged(auth, (user) => {
        if (userUnsubscribe) userUnsubscribe();
        if (tripsUnsubscribe) tripsUnsubscribe();

        if (user) {
            currentUser = user;
            DOM.loginBtn.classList.add('hidden');
            DOM.userInfo.classList.remove('hidden');
            DOM.mainActions.classList.remove('hidden');
            DOM.loginPromptMessage.classList.add('hidden');
            DOM.settingsBtn.classList.remove('hidden');

            const userDocRef = doc(db, "users", user.uid);
            
            userUnsubscribe = onSnapshot(userDocRef, (docSnap) => {
                const userData = docSnap.exists() ? docSnap.data() : {};
                DOM.userNameBtn.textContent = `שלום, ${userData.name || 'משתמש'}`;
                applyUserSettings(userData.settings);

                if (userData.settings?.defaultTripId && !window.location.search.includes('no_redirect')) {
                    window.location.href = `trip.html?id=${userData.settings.defaultTripId}`;
                } else {
                    hideLoader();
                }
            }, (error) => {
                console.error("Error fetching user data:", error);
                applyUserSettings(null); // Apply default settings on error
                hideLoader();
            });

            listenToUserTrips(user.uid);

        } else {
            currentUser = null;
            DOM.loginBtn.classList.remove('hidden');
            DOM.userInfo.classList.add('hidden');
            DOM.mainActions.classList.add('hidden');
            DOM.loginPromptMessage.classList.remove('hidden');
            DOM.settingsBtn.classList.add('hidden');
            resetUI();
            hideLoader();
        }
      });
      
      function applyUserSettings(settings) {
        const defaultBg = 'https://i.imgur.com/PXLTIi4.jpeg';
        const bgUrl = settings?.backgroundImage || defaultBg;
        DOM.mainBg.style.backgroundImage = `url('${bgUrl}')`;
        DOM.bgImageUrlInput.value = settings?.backgroundImage || '';
      }

      function resetUI() {
          DOM.userNameBtn.textContent = '';
          DOM.tripsDropdown.innerHTML = `<p class="px-4 py-2 text-sm text-gray-500 text-right">אין טיולים להצגה.</p>`;
          DOM.defaultTripList.innerHTML = '';
          DOM.defaultTripSection.classList.add('hidden');
          applyUserSettings(null);
      }

      function listenToUserTrips(uid) {
        const tripsQuery = query(collection(db, "trips"), where("ownerId", "==", uid));
        tripsUnsubscribe = onSnapshot(tripsQuery, (querySnapshot) => {
            const trips = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            updateTripsUI(trips);
        });
      }

      async function updateTripsUI(trips) {
        if (trips.length > 0) {
            DOM.tripsDropdown.innerHTML = trips.map(trip => 
                `<a href="trip.html?id=${trip.id}" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 text-right">${trip.name}</a>`
            ).join('');
        } else {
            DOM.tripsDropdown.innerHTML = `<p class="px-4 py-2 text-sm text-gray-500 text-right">עדיין לא יצרת טיולים.</p>`;
        }

        if (!currentUser) return;
        const userDoc = await getDoc(doc(db, "users", currentUser.uid));
        const currentSettings = userDoc.data()?.settings || {};
        const defaultTripId = currentSettings.defaultTripId;

        if (trips.length > 0) {
            DOM.defaultTripList.innerHTML = trips.map(trip => `
                <div class="flex items-center justify-between">
                    <label for="trip-${trip.id}" class="flex-grow">${trip.name}</label>
                    <input type="radio" name="default-trip" id="trip-${trip.id}" value="${trip.id}" class="form-radio h-5 w-5 text-blue-600" ${trip.id === defaultTripId ? 'checked' : ''}>
                </div>
            `).join('');
            DOM.defaultTripSection.classList.remove('hidden');
        } else {
            DOM.defaultTripList.innerHTML = '';
            DOM.defaultTripSection.classList.add('hidden');
        }
      }

      DOM.loginBtn.addEventListener('click', () => { window.location.href = 'login.html'; });
      DOM.logoutBtn.addEventListener('click', () => { signOut(auth).catch(error => console.error("Error signing out: ", error)); });
      DOM.createTripBtn.addEventListener('click', () => { window.location.href = 'create-trip.html'; });
      DOM.settingsBtn.addEventListener('click', () => { DOM.settingsModal.classList.remove('hidden'); });
      DOM.closeSettingsBtn.addEventListener('click', () => { DOM.settingsModal.classList.add('hidden'); });
      
      DOM.saveSettingsBtn.addEventListener('click', async () => {
        if (!currentUser) return;
        const bgImage = DOM.bgImageUrlInput.value;
        const selectedRadio = document.querySelector('input[name="default-trip"]:checked');
        const defaultTripId = selectedRadio ? selectedRadio.value : null;
        try {
            await setDoc(doc(db, "users", currentUser.uid), { 
                settings: { backgroundImage: bgImage, defaultTripId: defaultTripId }
            }, { merge: true });
            alert('ההגדרות נשמרו!');
            DOM.settingsModal.classList.add('hidden');
        } catch (error) {
            console.error("Error saving settings: ", error);
            alert('אירעה שגיאה בשמירת ההגדרות.');
        }
      });

    </script>
</body>
</html>