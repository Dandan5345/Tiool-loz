<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>לו״ז טיול בקלות</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet"/>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

  <style>
    :root { --glass: rgba(255,255,255,0.16); --glass-border: rgba(255,255,255,0.25); }
    body { font-family: 'Assistant', sans-serif; }
    #bg-gradient {
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(59,130,246,0.35), transparent 60%),
        radial-gradient(1000px 700px at 0% 100%, rgba(168,85,247,0.35), transparent 60%),
        linear-gradient(180deg, #0f172a 0%, #111827 65%, #0b1020 100%);
    }
    .glass { background: var(--glass); backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px); border: 1px solid var(--glass-border); }
    .main-nav-button { transition: transform .2s ease, box-shadow .2s ease, background .2s ease; }
    .main-nav-button:hover { transform: translateY(-4px); box-shadow: 0 10px 25px rgba(0,0,0,.25); }
    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    #loading-overlay { transition: opacity .4s ease; }
    .modal-content { transition: opacity .25s, transform .25s; }
    .step-hidden { opacity: 0; transform: translateY(6px); display: none !important; }
    .leaflet-container { z-index: 10; border-radius: .75rem; }
    .step-dot { width:28px; height:28px; border-radius:999px; display:inline-flex; align-items:center; justify-content:center; }
    .step-dot.active { background:#2563eb; color:white; }
    .step-dot.inactive { background:#e5e7eb; color:#6b7280; }
    /* For settings modal accordions */
    .permission-details { max-height: 0; overflow: hidden; transition: max-height 0.4s ease-out; }
  </style>
</head>
<body class="bg-gray-900 text-white selection:bg-blue-600/40">

  <div id="loading-overlay" class="fixed inset-0 z-[200] flex flex-col items-center justify-center gap-4 bg-[#0b1020]">
    <i class="fas fa-plane-departure text-5xl text-blue-400 animate-pulse"></i>
    <p class="text-xl font-bold text-slate-200">טוען את לו״ז טיול בקלות…</p>
  </div>

  <div id="bg-gradient" class="fixed inset-0 -z-10"></div>
  <div class="pointer-events-none fixed inset-0 -z-10 bg-[radial-gradient(800px_400px_at_50%_0%,rgba(0,0,0,.25),transparent_70%)]"></div>

  <header class="sticky top-0 z-30">
    <div class="glass">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-3">
            <span class="inline-flex items-center justify-center w-9 h-9 rounded-xl bg-white/20"><i class="fa-solid fa-location-dot"></i></span>
            <span class="font-semibold tracking-wide">לו״ז טיול בקלות</span>
          </div>
          <div class="flex items-center gap-2">
            <div id="auth-container" class="flex items-center"></div>
            <button id="settings-btn" class="hidden p-2 rounded-lg hover:bg-white/10 transition" title="הגדרות"><i class="fas fa-cog"></i></button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main class="min-h-[calc(100vh-4rem)]">
    <section class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 sm:py-14">
      <div class="max-w-3xl mx-auto text-center">
        <h1 class="text-4xl md:text-6xl font-extrabold leading-[1.15] drop-shadow-sm">לו״ז טיול בקלות</h1>
        <p class="mt-4 text-slate-200/90 text-lg">תכננו מסלול, נהלו יעדים ותאריכים—הכל בקלות ובמהירות.</p>
        <p id="login-prompt-message" class="mt-4 text-slate-300">כדי להתחיל, <a href="login.html" class="underline decoration-blue-400 hover:text-blue-300 font-semibold">התחבר/י או הירשם/מי</a></p>
      </div>

      <div id="main-actions" class="hidden mt-10 grid grid-cols-1 sm:grid-cols-2 gap-4 max-w-3xl mx-auto">
        <button id="create-trip-btn" class="main-nav-button glass rounded-2xl p-6 text-left">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-white/20 grid place-items-center shrink-0"><i class="fa-solid fa-plus text-xl"></i></div>
            <div>
              <div class="font-bold text-xl">יצירת טיול חדש</div>
              <div class="text-slate-200/80 text-sm mt-1">שם, תאריכים, יעדים ומפה—במודאל נוח.</div>
            </div>
          </div>
        </button>
        <div class="relative">
          <button id="my-trips-btn" class="main-nav-button glass rounded-2xl p-6 w-full text-left">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-xl bg-white/20 grid place-items-center shrink-0"><i class="fa-solid fa-suitcase-rolling text-xl"></i></div>
              <div class="flex-1">
                <div class="font-bold text-xl">הטיולים שלי</div>
                <div class="text-slate-200/80 text-sm mt-1">פתח/י טיולים שיצרת.</div>
              </div>
              <i class="fa-solid fa-chevron-down opacity-80"></i>
            </div>
          </button>
          <div id="trips-dropdown" class="absolute right-0 mt-2 w-full glass rounded-xl py-2 z-20 hidden max-h-72 overflow-y-auto no-scrollbar"></div>
        </div>
      </div>

      <section id="shared-trips-section" class="hidden mt-10 max-w-3xl mx-auto">
        <h2 class="text-2xl font-bold mb-4 text-center">טיולים ששותפו איתי</h2>
        <div id="shared-trips-container" class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          </div>
      </section>

    </section>
  </main>

  <div id="settings-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
    <div class="glass w-full max-w-3xl rounded-2xl shadow-2xl text-white max-h-[90vh] flex flex-col">
      <header class="px-6 py-4 border-b border-white/20 flex items-center justify-between">
        <h2 class="text-xl font-bold">הגדרות</h2>
        <button id="close-settings-btn" class="p-2 rounded-lg hover:bg-white/10"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="px-6 py-6 space-y-8 overflow-y-auto no-scrollbar">
        <section>
          <h3 class="font-bold text-lg mb-3 border-b border-white/10 pb-2">ניהול טיולים</h3>
          <p class="text-sm text-slate-300 mb-4">מחק/י לצמיתות טיולים שבבעלותך, או עזוב/י טיולים ששותפו איתך.</p>
          <div id="trip-management-list" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar pr-2">
            <p class="text-slate-400 text-sm">טוען רשימת טיולים...</p>
          </div>
        </section>
        
        <section id="permission-management-section" class="hidden">
          <h3 class="font-bold text-lg mb-3 border-b border-white/10 pb-2">ניהול הרשאות שיתוף</h3>
          <p class="text-sm text-slate-300 mb-4">נהל/י גישה למשתמשים אחרים בטיולים שיצרת.</p>
          <div id="permission-management-list" class="space-y-3">
             <p class="text-slate-400 text-sm">טוען רשימת טיולים...</p>
          </div>
        </section>
      </main>
      <footer class="px-6 py-4 border-t border-white/20 flex justify-end">
        <button id="settings-done-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg">סיום</button>
      </footer>
    </div>
  </div>

  <div id="logout-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
      <div class="glass rounded-2xl w-full max-w-sm p-6 text-center">
        <h2 class="text-2xl font-bold mb-3">התנתקות</h2>
        <p class="text-slate-200/90 mb-6">להתנתק מהמערכת?</p>
        <div class="flex justify-center gap-3">
            <button id="cancel-logout-btn" class="glass px-6 py-2 rounded-lg hover:bg-white/10">ביטול</button>
            <button id="confirm-logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold px-6 py-2 rounded-lg">התנתק</button>
        </div>
      </div>
  </div>

  <div id="create-trip-modal" class="hidden fixed inset-0 bg-black/60 flex items-center justify-center z-50 p-4">
      <div class="glass rounded-2xl w-full max-w-3xl max-h-[92vh] flex flex-col">
        <header class="p-4 border-b border-white/20 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <span id="step-dot-1" class="step-dot inactive">1</span>
                <span id="step-dot-2" class="step-dot inactive">2</span>
                <span id="step-dot-3" class="step-dot inactive">3</span>
            </div>
            <h2 id="modal-title" class="text-lg sm:text-xl font-bold">יצירת טיול חדש - שלב 1 מתוך 3</h2>
            <button id="close-modal-btn" class="p-2 rounded-lg hover:bg-white/10"><i class="fa-solid fa-xmark"></i></button>
        </header>
        <div class="w-full h-1 bg-white/10">
            <div id="step-progress" class="h-1 bg-blue-500" style="width: 33%;"></div>
        </div>
        <main class="p-6 overflow-y-auto flex-grow">
            <div id="step-1" class="modal-content">
                <div class="space-y-4">
                    <div>
                        <label for="trip-name" class="block mb-1 font-semibold text-right">שם הטיול</label>
                        <input type="text" id="trip-name" placeholder="לדוגמה: הטיול הגדול לאירופה" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 text-white placeholder:text-slate-300">
                    </div>
                    <div>
                        <label for="trip-dates" class="block mb-1 font-semibold text-right">תאריכי הטיול (התחלה וסיום)</label>
                        <input type="text" id="trip-dates" class="w-full p-3 rounded-lg bg-white/10 border border-white/20 focus:outline-none focus:ring-2 focus:ring-blue-500 text-center text-white placeholder:text-slate-300">
                    </div>
                </div>
            </div>
            <div id="step-2" class="modal-content step-hidden">
                <div id="destinations-container" class="space-y-6"></div>
                <button id="add-destination-btn" class="mt-6 w-full glass font-semibold py-3 rounded-lg flex items-center justify-center gap-2 hover:bg-white/10">
                    <i class="fas fa-plus-circle"></i> הוסף יעד
                </button>
            </div>
            <div id="step-3" class="modal-content step-hidden">
                <p class="mb-4 text-center text-slate-200/90">בדוק/י את מפת המסלול והפרטים לפני שמירה.</p>
                <div id="review-map" class="w-full h-80 bg-white/5 rounded-lg border border-white/15"></div>
                <div id="review-legend" class="mt-4 text-right text-slate-200/95"></div>
            </div>
        </main>
        <footer class="p-4 border-t border-white/20 flex justify-between">
            <button id="back-btn" class="glass hover:bg-white/10 text-white font-bold py-2 px-4 rounded-lg hidden">חזור</button>
            <div class="flex gap-3">
                <button id="next-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">הבא</button>
                <button id="save-trip-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg hidden">שמור טיול</button>
            </div>
        </footer>
      </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, addDoc, serverTimestamp, updateDoc, deleteDoc, deleteField } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- DOM Elements ---
    const DOM = {
        loadingOverlay: document.getElementById('loading-overlay'),
        authContainer: document.getElementById('auth-container'),
        mainActions: document.getElementById('main-actions'),
        loginPromptMessage: document.getElementById('login-prompt-message'),
        myTripsBtn: document.getElementById('my-trips-btn'),
        tripsDropdown: document.getElementById('trips-dropdown'),
        createTripBtn: document.getElementById('create-trip-btn'),
        sharedTripsSection: document.getElementById('shared-trips-section'),
        sharedTripsContainer: document.getElementById('shared-trips-container'),
        settingsBtn: document.getElementById('settings-btn'),
        settingsModal: document.getElementById('settings-modal'),
        closeSettingsBtn: document.getElementById('close-settings-btn'),
        settingsDoneBtn: document.getElementById('settings-done-btn'),
        tripManagementList: document.getElementById('trip-management-list'),
        permissionManagementSection: document.getElementById('permission-management-section'),
        permissionManagementList: document.getElementById('permission-management-list'),
        logoutModal: document.getElementById('logout-modal'),
        cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
        confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
        createTripModal: document.getElementById('create-trip-modal'),
        closeModalBtn: document.getElementById('close-modal-btn'),
        modalTitle: document.getElementById('modal-title'),
        stepElems: [document.getElementById('step-1'), document.getElementById('step-2'), document.getElementById('step-3')],
        backBtn: document.getElementById('back-btn'),
        nextBtn: document.getElementById('next-btn'),
        saveTripBtn: document.getElementById('save-trip-btn'),
        tripNameInput: document.getElementById('trip-name'),
        tripDatesInput: document.getElementById('trip-dates'),
        destinationsContainer: document.getElementById('destinations-container'),
        addDestinationBtn: document.getElementById('add-destination-btn'),
        reviewMapContainer: document.getElementById('review-map'),
        reviewLegend: document.getElementById('review-legend'),
        stepDots: [document.getElementById('step-dot-1'), document.getElementById('step-dot-2'), document.getElementById('step-dot-3')],
        stepProgress: document.getElementById('step-progress'),
    };

    let currentUser = null;
    let ownedTrips = [];
    let sharedTrips = [];
    let tripsUnsubscribe = () => {};
    let sharedTripsUnsubscribe = () => {};

    // --- Authentication Flow ---
    onAuthStateChanged(auth, (user) => {
        tripsUnsubscribe();
        sharedTripsUnsubscribe();

        if (user) {
            currentUser = user;
            DOM.authContainer.innerHTML = `<button id="user-name-btn" class="font-semibold text-white/90 hover:text-white transition"></button>`;
            getDoc(doc(db, "users", user.uid)).then(snap => {
                document.getElementById('user-name-btn').textContent = `שלום, ${snap.data()?.name || 'משתמש'}`;
                document.getElementById('user-name-btn').addEventListener('click', () => DOM.logoutModal.classList.remove('hidden'));
            });
            
            DOM.mainActions.classList.remove('hidden');
            DOM.loginPromptMessage.classList.add('hidden');
            DOM.settingsBtn.classList.remove('hidden');
            listenToAllUserTrips(user.uid);
        } else {
            currentUser = null;
            DOM.mainActions.classList.add('hidden');
            DOM.loginPromptMessage.classList.remove('hidden');
            DOM.settingsBtn.classList.add('hidden');
            DOM.sharedTripsSection.classList.add('hidden');
            DOM.authContainer.innerHTML = `<a href="login.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">התחבר</a>`;
            ownedTrips = []; sharedTrips = [];
            updateOwnedTripsUI([]);
        }
        DOM.loadingOverlay.style.display = 'none';
    });

    function listenToAllUserTrips(uid) {
        const ownedQuery = query(collection(db, "trips"), where("ownerId", "==", uid));
        tripsUnsubscribe = onSnapshot(ownedQuery, (qs) => {
            ownedTrips = qs.docs.map(d => ({ id: d.id, ...d.data() }));
            updateOwnedTripsUI(ownedTrips);
            updateSettingsUI();
        }, (error) => console.error("Error fetching owned trips:", error));

        const sharedQuery = query(collection(db, "trips"), where(`sharedWith.${uid}`, "in", ["viewer", "editor"]));
        sharedTripsUnsubscribe = onSnapshot(sharedQuery, (qs) => {
            sharedTrips = qs.docs.map(d => ({ id: d.id, ...d.data() }));
            updateSharedTripsUI(sharedTrips);
            updateSettingsUI();
        }, (error) => console.error("Error fetching shared trips:", error));
    }

    // --- UI Population ---
    function updateOwnedTripsUI(trips) {
        if (trips.length > 0) {
            DOM.tripsDropdown.innerHTML = trips.map(trip => 
                `<a href="trip.html?id=${trip.id}" class="block px-4 py-2 text-sm hover:bg-white/10 text-right border-b border-white/15 last:border-b-0">${trip.name}</a>`
            ).join('');
        } else {
            DOM.tripsDropdown.innerHTML = `<div class="px-4 py-3 text-sm text-slate-200/90">לא יצרת טיולים עדיין.</div>`;
        }
    }

    function updateSharedTripsUI(trips) {
        if (trips.length > 0) {
            DOM.sharedTripsSection.classList.remove('hidden');
            DOM.sharedTripsContainer.innerHTML = trips.map(trip => {
                const role = trip.sharedWith[currentUser.uid];
                const roleText = role === 'editor' ? 'עורך' : 'צופה';
                const roleColor = role === 'editor' ? 'text-emerald-400' : 'text-sky-400';
                return `
                <a href="trip.html?id=${trip.id}" class="main-nav-button glass rounded-2xl p-4 text-left block">
                    <div class="font-bold truncate">${trip.name}</div>
                    <div class="text-sm text-slate-300 mt-1" data-owner-id="${trip.ownerId}">מאת: (טוען שם...)</div>
                    <div class="text-xs font-bold ${roleColor} mt-2 uppercase tracking-wider">תפקיד: ${roleText}</div>
                </a>`;
            }).join('');

            trips.forEach(async (trip) => {
                try {
                    const ownerSnap = await getDoc(doc(db, "users", trip.ownerId));
                    const ownerName = ownerSnap.exists() ? ownerSnap.data().name : "אלמוני";
                    const el = DOM.sharedTripsContainer.querySelector(`[data-owner-id="${trip.ownerId}"]`);
                    if (el) el.textContent = `מאת: ${ownerName}`;
                } catch (e) { console.error("Could not fetch owner name", e); }
            });
        } else {
            DOM.sharedTripsSection.classList.add('hidden');
        }
    }

    function updateSettingsUI() {
        populateTripManagementList();
        populatePermissionManagementList();
    }

    // --- Settings Modal Logic ---
    function populateTripManagementList() {
        const allTrips = [...ownedTrips, ...sharedTrips];
        if (allTrips.length === 0) {
            DOM.tripManagementList.innerHTML = `<p class="text-slate-400 text-sm">אין טיולים לניהול.</p>`;
            return;
        }
        DOM.tripManagementList.innerHTML = allTrips.map(trip => {
            const isOwner = trip.ownerId === currentUser.uid;
            const btnClass = isOwner ? 'bg-red-800/60 hover:bg-red-700/80' : 'bg-yellow-800/60 hover:bg-yellow-700/80';
            const btnText = isOwner ? 'מחק לצמיתות' : 'עזוב טיול';
            return `
            <div class="flex items-center justify-between gap-3 glass p-2 rounded-lg">
                <span class="text-sm truncate">${trip.name}</span>
                <button data-trip-id="${trip.id}" data-trip-name="${trip.name}" data-is-owner="${isOwner}" class="manage-trip-btn text-xs font-bold ${btnClass} px-3 py-1 rounded-md transition-colors">
                    ${btnText}
                </button>
            </div>`;
        }).join('');
    }

    function populatePermissionManagementList() {
        if (ownedTrips.length === 0) {
            DOM.permissionManagementSection.classList.add('hidden');
            return;
        }
        DOM.permissionManagementSection.classList.remove('hidden');
        DOM.permissionManagementList.innerHTML = ownedTrips.map(trip => `
            <div class="glass rounded-lg">
                <button class="w-full p-3 text-right flex justify-between items-center permission-trip-header">
                    <span class="font-semibold">${trip.name}</span>
                    <i class="fas fa-chevron-down transition-transform"></i>
                </button>
                <div class="permission-details px-3 pb-3" data-trip-id="${trip.id}">
                    <p class="text-slate-300 text-center text-sm p-4">טוען רשימת משתתפים...</p>
                </div>
            </div>
        `).join('');
    }

    async function handleManageTripClick(e) {
        const btn = e.target.closest('.manage-trip-btn');
        if (!btn) return;

        const { tripId, tripName, isOwner } = btn.dataset;
        const isOwnerBool = isOwner === 'true';

        if (isOwnerBool) {
            if (confirm(`האם אתה בטוח שברצונך למחוק לצמיתות את הטיול "${tripName}"?\nפעולה זו אינה הפיכה!`)) {
                await deleteDoc(doc(db, "trips", tripId));
            }
        } else {
            if (confirm(`האם אתה בטוח שברצונך לעזוב את הטיול "${tripName}"?\nלא תוכל לגשת אליו יותר אלא אם תוזמן שוב.`)) {
                const tripRef = doc(db, "trips", tripId);
                await updateDoc(tripRef, {
                    [`sharedWith.${currentUser.uid}`]: deleteField()
                });
            }
        }
    }
    
    async function handlePermissionHeaderClick(e) {
        const header = e.target.closest('.permission-trip-header');
        if (!header) return;

        const details = header.nextElementSibling;
        const icon = header.querySelector('i');
        const isOpen = details.style.maxHeight && details.style.maxHeight !== '0px';

        document.querySelectorAll('.permission-details').forEach(el => {
            el.style.maxHeight = '0px';
            el.previousElementSibling.querySelector('i').classList.remove('rotate-180');
        });

        if (!isOpen) {
            icon.classList.add('rotate-180');
            const tripId = details.dataset.tripId;
            const trip = ownedTrips.find(t => t.id === tripId);
            
            const sharedWith = trip.sharedWith || {};
            const sharedUids = Object.keys(sharedWith);

            if (sharedUids.length === 0) {
                details.innerHTML = `<p class="text-slate-300 text-center text-sm p-4">טיול זה אינו משותף עם איש.</p>`;
            } else {
                details.innerHTML = ``; 
                for (const uid of sharedUids) {
                    const role = sharedWith[uid];
                    const userSnap = await getDoc(doc(db, "users", uid));
                    const userName = userSnap.exists() ? userSnap.data().name : `משתמש (${uid.slice(0,5)}...)`;
                    
                    const userHtml = `
                    <div class="p-2 border-b border-white/10 last:border-b-0 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2" data-uid="${uid}">
                        <span class="text-sm">${userName}</span>
                        <div class="flex items-center gap-4">
                            <div class="flex items-center gap-2 text-xs">
                                <label><input type="radio" name="role-${uid}-${tripId}" value="viewer" ${role === 'viewer' ? 'checked' : ''}> צפייה</label>
                                <label><input type="radio" name="role-${uid}-${tripId}" value="editor" ${role === 'editor' ? 'checked' : ''}> עריכה</label>
                            </div>
                            <button class="revoke-access-btn text-red-400 hover:text-red-300 text-xs"><i class="fas fa-trash-alt"></i> בטל גישה</button>
                        </div>
                    </div>`;
                    details.innerHTML += userHtml;
                }
            }
            details.style.maxHeight = details.scrollHeight + "px";
        }
    }
    
    async function handlePermissionChange(e) {
        const input = e.target;
        if (input.type !== 'radio' || !input.checked) return;

        const newRole = input.value;
        const userDiv = input.closest('[data-uid]');
        const detailsDiv = input.closest('[data-trip-id]');
        const uid = userDiv.dataset.uid;
        const tripId = detailsDiv.dataset.tripId;

        const tripRef = doc(db, "trips", tripId);
        await updateDoc(tripRef, { [`sharedWith.${uid}`]: newRole });
    }
    
    async function handleRevokeAccess(e) {
        const btn = e.target.closest('.revoke-access-btn');
        if (!btn) return;
        
        const userDiv = btn.closest('[data-uid]');
        const detailsDiv = btn.closest('[data-trip-id]');
        const uid = userDiv.dataset.uid;
        const tripId = detailsDiv.dataset.tripId;

        if (confirm(`האם לבטל את הגישה של משתמש זה לטיול?`)) {
            const tripRef = doc(db, "trips", tripId);
            await updateDoc(tripRef, { [`sharedWith.${uid}`]: deleteField() });
            userDiv.remove();
        }
    }

    // --- Event Listeners ---
    DOM.myTripsBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      DOM.tripsDropdown.classList.toggle('hidden');
    });
    document.addEventListener('click', (e) => {
        if (!DOM.tripsDropdown.contains(e.target) && !DOM.myTripsBtn.contains(e.target)) {
            DOM.tripsDropdown.classList.add('hidden');
        }
    });
    DOM.settingsBtn.addEventListener('click', () => DOM.settingsModal.classList.remove('hidden'));
    DOM.closeSettingsBtn.addEventListener('click', () => DOM.settingsModal.classList.add('hidden'));
    DOM.settingsDoneBtn.addEventListener('click', () => DOM.settingsModal.classList.add('hidden'));
    DOM.tripManagementList.addEventListener('click', handleManageTripClick);
    DOM.permissionManagementList.addEventListener('click', handlePermissionHeaderClick);
    DOM.permissionManagementList.addEventListener('change', handlePermissionChange);
    DOM.permissionManagementList.addEventListener('click', handleRevokeAccess);
    DOM.logoutModal.querySelector('#cancel-logout-btn').addEventListener('click', () => DOM.logoutModal.classList.add('hidden'));
    DOM.logoutModal.querySelector('#confirm-logout-btn').addEventListener('click', () => signOut(auth));

    // --- Create Trip Modal Logic ---
    let currentStep = 0;
    let destinationUIs = [];
    let reviewMap = null;

    function openCreateModal() {
        if (!currentUser) { location.href = 'login.html'; return; }
        DOM.createTripModal.classList.remove('hidden');
        new Litepicker({ element: DOM.tripDatesInput, singleMode: false, lang: 'he-IL', format: 'DD/MM/YYYY' });
        setStep(0, true);
    }

    function closeCreateModal() { DOM.createTripModal.classList.add('hidden'); }

    function setStep(newStep, isReset = false) {
        if (!isReset) {
            if (newStep < 0 || newStep >= DOM.stepElems.length) return;
            if (newStep > currentStep) {
                if (currentStep === 0 && (!DOM.tripNameInput.value.trim() || !DOM.tripDatesInput.value.trim())) return alert('יש למלא שם ותאריכי טיול.');
                if (currentStep === 1 && destinationUIs.length === 0) return alert('יש להוסיף לפחות יעד אחד.');
            }
        }
        
        DOM.stepElems.forEach((el, idx) => el.classList.toggle('step-hidden', idx !== newStep));
        currentStep = newStep;

        DOM.modalTitle.textContent = `יצירת טיול חדש - שלב ${currentStep + 1} מתוך 3`;
        DOM.backBtn.classList.toggle('hidden', currentStep === 0);
        DOM.nextBtn.classList.toggle('hidden', currentStep === 2);
        DOM.saveTripBtn.classList.toggle('hidden', currentStep !== 2);
        
        DOM.stepDots.forEach((dot, idx) => {
            dot.classList.toggle('active', idx === currentStep);
            dot.classList.toggle('inactive', idx !== currentStep);
        });
        DOM.stepProgress.style.width = (33.3 * (currentStep + 1)) + '%';

        if (currentStep === 2) generateReviewMap();
    }
    
    function addDestination() { /* Logic unchanged */ }
    async function findOnMap(e) { /* Logic unchanged */ }
    function removeDestination(e) { /* Logic unchanged */ }
    function generateReviewMap() { /* Logic unchanged */ }

    async function saveTrip() {
        if (!currentUser) return alert('יש להתחבר לפני שמירה.');
        const [tripStart, tripEnd] = (DOM.tripDatesInput.value || '').split(' - ');
        
        const finalTripData = {
            name: DOM.tripNameInput.value.trim(),
            startDate: tripStart || '',
            endDate: tripEnd || '',
            ownerId: currentUser.uid,
            createdAt: serverTimestamp(),
            sharedWith: {}, // Initialize empty sharedWith map
            destinations: destinationUIs.map(ui => ({ /* ... */ })),
        };
        
        try {
            DOM.saveTripBtn.disabled = true;
            DOM.saveTripBtn.textContent = 'שומר...';
            const docRef = await addDoc(collection(db, "trips"), finalTripData);
            window.location.href = `trip.html?id=${docRef.id}`;
        } catch (err) {
            console.error('Error adding document:', err);
            alert('שגיאה בשמירת הטיול.');
            DOM.saveTripBtn.disabled = false;
            DOM.saveTripBtn.textContent = 'שמור טיול';
        }
    }

    DOM.createTripBtn.addEventListener('click', openCreateModal);
    DOM.closeModalBtn.addEventListener('click', closeCreateModal);
    DOM.nextBtn.addEventListener('click', () => setStep(currentStep + 1));
    DOM.backBtn.addEventListener('click', () => setStep(currentStep - 1));
    DOM.addDestinationBtn.addEventListener('click', addDestination);
    DOM.destinationsContainer.addEventListener('click', (e) => {
        if (e.target.closest('.find-map-btn')) findOnMap(e);
        if (e.target.closest('.remove-dest-btn')) removeDestination(e);
    });
    DOM.saveTripBtn.addEventListener('click', saveTrip);

  </script>
</body>
</html>