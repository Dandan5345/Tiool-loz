<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>התחברות / הרשמה - מתכנן טיולים</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Google Fonts - Rubik -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

  <style>
    body {
      font-family: 'Rubik', sans-serif;
      background-image: url('https://images.unsplash.com/photo-1501785888041-af3ef285b470?q=80&w=2070&auto=format&fit=crop');
      background-size: cover;
      background-position: center;
    }
    .form-container { backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); }
    #password-reqs ul { list-style: none; padding-right: 0; }
    #password-reqs li { color: #b91c1c; transition: color .3s ease; display: flex; align-items: center; }
    #password-reqs li.valid { color: #15803d; }
    #password-reqs li .icon { margin-left: .5rem; width: 1.25rem; }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-200">

  <div class="w-full max-w-md mx-auto bg-white/80 form-container rounded-2xl shadow-2xl p-8 m-4">

    <!-- Tabs -->
    <div id="auth-tabs" class="flex border-b border-gray-300 mb-6">
      <button id="login-tab" class="flex-1 py-3 text-lg font-semibold text-center border-b-4 border-blue-600 text-blue-600">התחברות</button>
      <button id="signup-tab" class="flex-1 py-3 text-lg font-semibold text-center text-gray-500">הרשמה</button>
    </div>

    <!-- Message Area -->
    <div id="message-area" class="hidden p-3 mb-4 text-center rounded-md"></div>

    <!-- Login Form -->
    <form id="login-form" novalidate>
      <div class="mb-4">
        <label for="login-email" class="block text-gray-700 mb-2">כתובת מייל</label>
        <input type="email" id="login-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div class="mb-6">
        <label for="login-password" class="block text-gray-700 mb-2">סיסמה</label>
        <input type="password" id="login-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <button id="login-submit" type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
        התחבר
      </button>
    </form>

    <!-- Signup Form -->
    <form id="signup-form" class="hidden" novalidate>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="signup-firstname" class="block text-gray-700 mb-2">שם פרטי</label>
          <input type="text" id="signup-firstname" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label for="signup-lastname" class="block text-gray-700 mb-2">שם משפחה</label>
          <input type="text" id="signup-lastname" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
      </div>
      <div class="mb-4">
        <label for="signup-email" class="block text-gray-700 mb-2">כתובת מייל</label>
        <input type="email" id="signup-email" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
      </div>
      <div class="mb-4">
        <label for="signup-password" class="block text-gray-700 mb-2">סיסמה</label>
        <input type="password" id="signup-password" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required minlength="8">
      </div>
      <div id="password-reqs" class="text-sm mt-2 mb-6">
        <ul>
          <li id="req-length"><span class="icon"></span>לפחות 8 תווים</li>
          <li id="req-upper"><span class="icon"></span>אות גדולה אחת (באנגלית)</li>
          <li id="req-number"><span class="icon"></span>ספרה אחת לפחות</li>
          <li id="req-special"><span class="icon"></span>תו מיוחד אחד (!@#$)</li>
        </ul>
      </div>
      <button id="signup-submit" type="submit" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
        הרשמה
      </button>
    </form>

    <!-- Google Finish Signup Form -->
    <div id="google-finish-signup" class="hidden">
      <h2 class="text-xl font-bold text-center mb-4">צעד אחרון...</h2>
      <p class="text-center text-gray-600 mb-6">אנא אשר/י את שמך לפני שממשיכים.</p>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
        <div>
          <label for="google-firstname" class="block text-gray-700 mb-2">שם פרטי</label>
          <input type="text" id="google-firstname" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
        <div>
          <label for="google-lastname" class="block text-gray-700 mb-2">שם משפחה</label>
          <input type="text" id="google-lastname" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" required>
        </div>
      </div>
      <button id="finish-google-signup-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-300">
        צור חשבון
      </button>
    </div>

    <!-- Divider -->
    <div id="divider" class="my-6 flex items-center">
      <div class="flex-grow border-t border-gray-300"></div>
      <span class="flex-shrink mx-4 text-gray-500">או</span>
      <div class="flex-grow border-t border-gray-300"></div>
    </div>

    <!-- Google Sign-in Button -->
    <button id="google-signin-btn" class="w-full bg-white hover:bg-gray-100 text-gray-800 font-semibold py-2 px-4 border border-gray-300 rounded-lg shadow-sm flex items-center justify-center transition duration-300">
      <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google icon" class="w-6 h-6 ml-3">
      <span>התחברות עם גוגל</span>
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import {
      getAuth,
      setPersistence,
      browserLocalPersistence,
      createUserWithEmailAndPassword,
      signInWithEmailAndPassword,
      GoogleAuthProvider,
      signInWithPopup,
      sendEmailVerification,
      onAuthStateChanged
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    await setPersistence(auth, browserLocalPersistence);
    const db = getFirestore(app);

    const DOM = {
      loginTab: document.getElementById('login-tab'),
      signupTab: document.getElementById('signup-tab'),
      loginForm: document.getElementById('login-form'),
      signupForm: document.getElementById('signup-form'),
      googleSigninBtn: document.getElementById('google-signin-btn'),
      messageArea: document.getElementById('message-area'),
      signupPasswordInput: document.getElementById('signup-password'),
      signupSubmitBtn: document.getElementById('signup-submit'),
      loginSubmitBtn: document.getElementById('login-submit'),
      passwordReqs: {
        length: document.getElementById('req-length'),
        upper: document.getElementById('req-upper'),
        number: document.getElementById('req-number'),
        special: document.getElementById('req-special'),
      },
      googleFinishSignupForm: document.getElementById('google-finish-signup'),
      finishGoogleSignupBtn: document.getElementById('finish-google-signup-btn'),
      authTabs: document.getElementById('auth-tabs'),
      divider: document.getElementById('divider'),
    };

    const icons = {
      valid: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-green-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd" /></svg>`,
      invalid: `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-700" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd" /></svg>`
    };

    let pendingGoogleUser = null;

    // === Helpers: בדיקת השלמת פרופיל ===
    function isProfileCompleteData(data) {
      if (!data) return false;
      return data.profileComplete === true || (!!data.firstName && !!data.lastName);
    }

    async function ensureRedirectIfComplete(user) {
      try {
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists() && isProfileCompleteData(snap.data())) {
          window.location.href = 'index.html';
          return true;
        }
      } catch (e) {
        console.error('Error checking user doc:', e);
      }
      return false;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) return;

      // אם כבר מציגים את טופס ההשלמה – אל תדרוס
      if (!DOM.googleFinishSignupForm.classList.contains('hidden')) return;

      // אם הפרופיל כבר הושלם – הפניה מידית
      const redirected = await ensureRedirectIfComplete(user);
      if (redirected) return;

      // אם לא הושלם והמשתמש מחובר עם Google – הצג טופס השלמה
      const isGoogle = user.providerData?.some(p => p.providerId === 'google.com');
      if (isGoogle) {
        pendingGoogleUser = user;
        showGoogleFinishSignupStep(user);
      }
    });

    function showMessage(text, isError = false) {
      DOM.messageArea.textContent = text;
      DOM.messageArea.classList.remove('hidden', 'bg-red-100', 'text-red-700', 'bg-green-100', 'text-green-700');
      DOM.messageArea.classList.add(isError ? 'bg-red-100' : 'bg-green-100', isError ? 'text-red-700' : 'text-green-700');
    }
    function clearMessage() {
      DOM.messageArea.textContent = '';
      DOM.messageArea.classList.add('hidden');
    }
    function setLoading(button, loading) {
      if (!button) return;
      button.disabled = loading;
      button.classList.toggle('opacity-60', loading);
    }

    DOM.loginTab.addEventListener('click', () => {
      DOM.loginTab.classList.add('border-blue-600', 'text-blue-600');
      DOM.loginTab.classList.remove('text-gray-500');
      DOM.signupTab.classList.remove('border-blue-600', 'text-blue-600');
      DOM.signupTab.classList.add('text-gray-500');
      DOM.loginForm.classList.remove('hidden');
      DOM.signupForm.classList.add('hidden');
      clearMessage();
    });

    DOM.signupTab.addEventListener('click', () => {
      DOM.signupTab.classList.add('border-blue-600', 'text-blue-600');
      DOM.signupTab.classList.remove('text-gray-500');
      DOM.loginTab.classList.remove('border-blue-600', 'text-blue-600');
      DOM.loginTab.classList.add('text-gray-500');
      DOM.signupForm.classList.remove('hidden');
      DOM.loginForm.classList.add('hidden');
      validatePassword();
      clearMessage();
    });

    function validatePassword() {
      const pass = DOM.signupPasswordInput.value || '';
      const checks = {
        length: pass.length >= 8,
        upper: /[A-Z]/.test(pass),
        number: /[0-9]/.test(pass),
        special: /[!@#$%^&*(),.?":{}|<>]/.test(pass)
      };
      for (const [k, ok] of Object.entries(checks)) updateReqUI(k, ok);
      return Object.values(checks).every(Boolean);
    }
    function updateReqUI(reqName, isValid) {
      const el = DOM.passwordReqs[reqName];
      const iconSpan = el.querySelector('.icon');
      el.classList.toggle('valid', isValid);
      iconSpan.innerHTML = isValid ? icons.valid : icons.invalid;
    }
    DOM.signupPasswordInput?.addEventListener('input', validatePassword);

    // ===== Signup with Email/Password =====
    DOM.signupForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessage();
      if (!validatePassword()) return showMessage('הסיסמה אינה עומדת בכל הדרישות.', true);
      const first = document.getElementById('signup-firstname').value.trim();
      const last  = document.getElementById('signup-lastname').value.trim();
      const email = document.getElementById('signup-email').value.trim();
      const pass  = DOM.signupPasswordInput.value;

      if (!first || !last) return showMessage('אנא מלא שם פרטי ושם משפחה.', true);

      try {
        setLoading(DOM.signupSubmitBtn, true);
        const cred = await createUserWithEmailAndPassword(auth, email, pass);
        await sendEmailVerification(cred.user);
        await setDoc(doc(db, "users", cred.user.uid), {
          name: `${first} ${last}`,
          firstName: first,
          lastName: last,
          email: cred.user.email,
          provider: 'password',
          profileComplete: true,
          createdAt: serverTimestamp()
        }, { merge: true });
        showMessage('הרשמה הושלמה! שלחנו מייל לאימות. אשר/י את המייל ואז התחבר/י.');
        DOM.signupForm.reset();
        validatePassword();
      } catch (err) {
        showMessage(getFriendlyErrorMessage(err.code), true);
      } finally {
        setLoading(DOM.signupSubmitBtn, false);
      }
    });

    // ===== Login with Email/Password =====
    DOM.loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      clearMessage();
      const email = document.getElementById('login-email').value.trim();
      const password = document.getElementById('login-password').value;
      try {
        setLoading(DOM.loginSubmitBtn, true);
        const cred = await signInWithEmailAndPassword(auth, email, password);
        if (!cred.user.emailVerified) return showMessage('עליך לאמת את כתובת המייל לפני התחברות.', true);
        // אם נמצא פרופיל מלא – הפניה, אחרת (בחשבון סיסמה) אין צורך בטופס השלמה
        const redirected = await ensureRedirectIfComplete(cred.user);
        if (!redirected) window.location.href = 'index.html';
      } catch (err) {
        showMessage(getFriendlyErrorMessage(err.code), true);
      } finally {
        setLoading(DOM.loginSubmitBtn, false);
      }
    });

    // ===== Google Sign-In =====
    DOM.googleSigninBtn.addEventListener('click', async () => {
      clearMessage();
      const provider = new GoogleAuthProvider();
      try {
        const result = await signInWithPopup(auth, provider);
        const user = result.user;

        // אם למשתמש כבר יש פרופיל מלא – מפנים מיד
        const snap = await getDoc(doc(db, "users", user.uid));
        if (snap.exists() && isProfileCompleteData(snap.data())) {
          window.location.href = 'index.html';
          return;
        }

        // אחרת – הצג טופס השלמת שם פעם אחת
        pendingGoogleUser = user;
        showGoogleFinishSignupStep(user);
      } catch (error) {
        if (error.code === 'auth/operation-not-allowed') {
          showMessage('כניסה עם Google לא מאופשרת ב־Firebase Console (Authentication > Sign-in method).', true);
        } else if (error.code === 'auth/unauthorized-domain') {
          showMessage('הדומיין הנוכחי לא מאושר ב־Authentication > Settings > Authorized domains.', true);
        } else if (error.code === 'auth/popup-blocked') {
          showMessage('הדפדפן חסם את חלון ההתחברות. בטל/י חוסם פופ-אפים ונסה/י שוב.', true);
        } else {
          showMessage(getFriendlyErrorMessage(error.code), true);
        }
      }
    });

    function showGoogleFinishSignupStep(user) {
      DOM.authTabs.classList.add('hidden');
      DOM.loginForm.classList.add('hidden');
      DOM.signupForm.classList.add('hidden');
      DOM.divider.classList.add('hidden');
      DOM.googleSigninBtn.classList.add('hidden');
      DOM.googleFinishSignupForm.classList.remove('hidden');

      const firstNameInput = document.getElementById('google-firstname');
      const lastNameInput  = document.getElementById('google-lastname');
      const nameParts = (user.displayName || '').trim().split(' ').filter(Boolean);
      firstNameInput.value = nameParts[0] || '';
      lastNameInput.value  = nameParts.slice(1).join(' ') || '';
    }

    DOM.finishGoogleSignupBtn.addEventListener('click', async () => {
      if (!pendingGoogleUser) return;
      const first = document.getElementById('google-firstname').value.trim();
      const last  = document.getElementById('google-lastname').value.trim();
      if (!first || !last) return showMessage('אנא מלא שם פרטי ושם משפחה.', true);

      try {
        const ref = doc(db, "users", pendingGoogleUser.uid);
        const snap = await getDoc(ref);

        const payload = {
          name: `${first} ${last}`,
          firstName: first,
          lastName: last,
          email: pendingGoogleUser.email,
          provider: 'google',
          profileComplete: true
        };
        if (snap.exists()) payload.updatedAt = serverTimestamp();
        else payload.createdAt = serverTimestamp();

        await setDoc(ref, payload, { merge: true });
        window.location.href = 'index.html';
      } catch (err) {
        console.error(err);
        showMessage('שגיאה ביצירת/עדכון החשבון. נסה שוב.', true);
      }
    });

    function getFriendlyErrorMessage(code) {
      switch (code) {
        case 'auth/invalid-email': return 'כתובת המייל אינה תקינה.';
        case 'auth/user-not-found':
        case 'auth/wrong-password':
        case 'auth/invalid-credential': return 'שם המשתמש או הסיסמה שגויים.';
        case 'auth/email-already-in-use': return 'כתובת המייל הזו כבר קיימת במערכת.';
        case 'auth/weak-password': return 'הסיסמה חלשה מדי.';
        case 'auth/too-many-requests': return 'יותר מדי נסיונות. נסה מאוחר יותר.';
        case 'auth/popup-closed-by-user': return 'חלון ההתחברות נסגר.';
        default: return 'אירעה שגיאה. נסה שוב.';
      }
    }
  </script>
</body>
</html>