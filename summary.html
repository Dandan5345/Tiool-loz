<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>住 转 注专</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; }
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body class="bg-slate-100">

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[100] flex items-center justify-center">
        <i class="fas fa-spinner fa-spin fa-3x text-blue-600"></i>
    </div>

    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/NSS7bvI.webp');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <div class="relative z-10">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 flex items-center justify-between h-16">
                <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="专 祝 "><i class="fas fa-arrow-left fa-lg"></i></a>
                <h1 class="text-xl font-bold text-slate-800">住 转 注专</h1>
                <div id="auth-container"></div>
            </div>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto space-y-12">
                <div class="text-center">
                    <h2 id="trip-title" class="text-5xl font-extrabold text-white drop-shadow-lg"></h2>
                </div>

                <section id="hotel-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md"> 转</h3>
                    <div id="hotel-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>

                <section id="transport-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">锔 注专</h3>
                    <div id="transport-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUser, tripId, logisticsUnsubscribe = null;

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            tripTitle: document.getElementById('trip-title'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            hotelContainer: document.getElementById('hotel-cards-container'),
            transportContainer: document.getElementById('transport-cards-container'),
        };

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                alert("砖:  爪  .");
                window.location.href = 'index.html';
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, user => {
                if (user) {
                    currentUser = user;
                    loadTripData();
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData() {
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);
            if (tripSnap.exists() && tripSnap.data().ownerId === currentUser.uid) {
                DOM.tripTitle.textContent = `住 注专: ${tripSnap.data().name}`;
                listenToLogistics();
            } else {
                alert("  爪  砖  专砖 爪驻转 .");
                window.location.href = 'index.html';
            }
        }

        function listenToLogistics() {
            if (logisticsUnsubscribe) logisticsUnsubscribe();
            const logisticsColRef = collection(db, "trips", tripId, "logistics");
            logisticsUnsubscribe = onSnapshot(logisticsColRef, snapshot => {
                const allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderItems(allItems);
                DOM.loadingOverlay.style.display = 'none';
            });
        }

        // --- Render Functions ---
        function renderItems(items) {
            const hotels = items.filter(item => item.type === 'hotel');
            const transports = items.filter(item => item.type === 'transport');
            
            renderCards(DOM.hotelContainer, hotels, createHotelCard);
            renderCards(DOM.transportContainer, transports, createTransportCard);
        }

        function renderCards(container, items, cardCreator) {
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<p class="text-white/70 text-center col-span-full"> 驻专 爪 拽专 .</p>`;
                return;
            }
            items.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(item => {
                container.appendChild(cardCreator(item));
            });
        }

        function createHotelCard(item) {
            const card = document.createElement('div');
            card.className = "bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-lg";
            card.innerHTML = `
                <h4 class="font-bold text-lg text-slate-800 mb-2">${item.name}</h4>
                <p class="text-sm text-slate-500 mb-3">${item.dates}</p>
                <ul class="text-sm space-y-1">
                    <li><strong>专:</strong> $${(item.price || 0).toLocaleString()}</li>
                    <li><strong>专转 拽专:</strong> ${item.breakfast || ' 爪'}</li>
                    <li><strong>:</strong> ${item.kitchen || ' 爪'}</li>
                </ul>
                <div class="mt-4 pt-3 border-t flex gap-2">
                    <a href="${item.link || '#'}" target="_blank" class="flex-1 text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg text-sm ${!item.link ? 'opacity-50 cursor-not-allowed' : 'hover:bg-blue-600'}">转专</a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address || '')}" target="_blank" class="flex-1 text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg text-sm ${!item.address ? 'opacity-50 cursor-not-allowed' : 'hover:bg-slate-700'}"></a>
                </div>
            `;
            return card;
        }

        function createTransportCard(item) {
            const card = document.createElement('div');
            card.className = "bg-white/90 backdrop-blur-sm p-4 rounded-xl shadow-lg";
            card.innerHTML = `
                <h4 class="font-bold text-lg text-slate-800 mb-2">${item.company}: ${item.from} <i class="fas fa-arrow-left"></i> ${item.to}</h4>
                <p class="text-sm text-slate-500 mb-3">${item.date} | ${item.time}</p>
                <p class="text-sm"><strong>住驻专 住/:</strong> ${item.refNumber || ' 爪'}</p>
            `;
            return card;
        }

        // --- Start Page ---
        initPage();
    </script>
</body>
</html>