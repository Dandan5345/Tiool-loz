<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”</title>
    
    <script src="https://cdn.tailwindcss.com">
  tailwind.config = {
    theme: {
      extend: {
        fontFamily: {
          sans: ['Assistant', 'sans-serif'],
          rubik: ['Rubik', 'sans-serif'],
        }
      }
    }
  }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />

    <!-- Litepicker for Date Range -->
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <!-- Google Maps API Script -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAz7QZ2CBpCK_aOVbkqQLjfMRG5taaFs8c&libraries=places,marker&callback=initMaps&language=iw" async defer></script>

    <style>
        html {
            overflow-x: hidden;
        }
        body { 
            font-family: 'Assistant', sans-serif; 
            touch-action: manipulation;
            overflow-x: hidden;
            /* FIX: Set a dark background on the body itself to prevent the white flash on mobile overscroll. */
            /* This color will be visible during the "bounce" effect and is covered by the fixed background during normal view. */
            background-color: #111827; 
        }
        
     /* Sidebar Styles */
        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-track { background: transparent; }
        #sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .submenu.open { max-height: 1000px; }
        
        .chevron-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }
        
        body.modal-locked { overflow: hidden; }
        
        /* Modal Styles */
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-step { display: none; animation: fadeIn 0.5s; }
        .modal-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Modal Progress Bar */
        .progress-bar { display: flex; justify-content: space-around; margin-bottom: 1.5rem; }
        .progress-step {
            flex: 1; text-align: center; position: relative;
            color: #a0aec0; font-size: 0.875rem; font-weight: 600;
        }
        .progress-step:not(:last-child)::after {
            content: ''; position: absolute; top: 12px; right: -50%;
            height: 2px; width: 100%; background-color: #e2e8f0; z-index: 0;
        }
        .progress-step .step-circle {
            width: 24px; height: 24px; border-radius: 50%; background-color: #e2e8f0;
            display: inline-flex; align-items: center; justify-content: center;
            position: relative; z-index: 1; transition: background-color 0.3s;
        }
        .progress-step.active .step-circle { background-color: #3b82f6; color: white; }
        .progress-step.active { color: #2d3748; }
        .progress-step.active:not(:last-child)::after { background-color: #3b82f6; }

        /* Map Styles */
        .map-container { 
            width: 100%; 
            border-radius: 0.5rem; 
            border: 1px solid #e2e8f0; 
            z-index: 10; 
            background-color: #f0f0f0;
        }
        .small-map-container { height: 200px; }
        .final-map-container { height: 300px; }
        .details-map-container { height: 250px; }
        
        /* Loading Overlay */
        #loading-overlay { transition: opacity 0.5s ease-in-out; }

        /* Autocomplete Styles */
        .autocomplete-suggestions {
            position: absolute; background-color: white;
            border: 1px solid #d1d5db; border-top: none;
            border-radius: 0 0 0.375rem 0.375rem; max-height: 150px;
            overflow-y: auto; z-index: 9999;
            width: 100%; 
        }
        .autocomplete-suggestion { padding: 0.5rem; cursor: pointer; }
        .autocomplete-suggestion:hover { background-color: #f3f4f6; }

        /* Notification Banner */
        #notification-banner {
            transition: transform 0.5s ease-in-out, opacity 0.5s ease-in-out;
            transform: translateY(-100%);
        }

        /* Native Date Input Styles (Fallback) */
        input[type="date"] { position: relative; }
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute; right: 0; top: 0; width: 100%; height: 100%;
            padding: 0; margin: 0; background: transparent; color: transparent;
            border: none; cursor: pointer;
        }

        /* Litepicker RTL Fixes */
        .litepicker .container__months .month-item-header .button-previous-month,
        .litepicker .container__months .month-item-header .button-next-month {
            transform: scaleX(-1); /* Flip arrows for RTL */
        }

        ::-webkit-scrollbar-corner {
            background: transparent;
        }
    </style>
</head>
<body class=""> 

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ × ×ª×•× ×™×, × × ×œ×”××ª×™×Ÿ...</p>
    </div>
    
    <!-- Notification Banner for errors and messages -->
    <div id="notification-banner" class="fixed top-4 right-4 z-[101] p-4 rounded-lg shadow-lg text-white opacity-0 transform -translate-y-12">
        <p id="notification-message"></p>
    </div>

    <!-- Restored Static Background with performance fix -->
    <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/MjekTyd.jpeg'); will-change: transform;"></div>
    <div class="fixed inset-0 z-0 bg-black/60"></div>

  <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300 opacity-0"></div>

    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform translate-x-full transition-transform duration-300 ease-out border-l border-white/20 flex flex-col">
      
      <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-l from-cyan-50 to-transparent shrink-0">
        <h2 class="text-2xl font-bold text-slate-800 font-rubik">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
        <button id="close-sidebar-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
          <i class="fas fa-times fa-lg"></i>
        </button>
      </div>

      <nav id="main-menu" class="p-4 space-y-3 overflow-y-auto flex-grow pb-20 scroll-smooth">
        <div class="text-center py-10 text-slate-400">
            <i class="fas fa-circle-notch fa-spin mb-2"></i>
            <p class="text-sm">×˜×•×¢×Ÿ ×ª×¤×¨×™×˜...</p>
        </div>
      </nav>
      
      <div class="p-4 border-t border-slate-100 bg-slate-50 shrink-0 text-center">
          <p class="text-xs text-slate-400">×ª×›× ×•×Ÿ ×˜×™×•×œ ×—×›×</p>
      </div>
    </aside>
    <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

    <div class="relative z-10 flex min-h-screen flex-col">
        <header class="bg-white/90 backdrop-blur-sm sticky top-0 z-40 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ"><i class="fas fa-arrow-left fa-lg"></i></a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="auth-container" class="flex items-center"></div>
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="flex-grow p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto space-y-12 pb-12">
                <div class="text-center">
                    <h2 class="text-5xl font-extrabold text-white drop-shadow-xl">×”×œ×•×’×™×¡×˜×™×§×” ×©×œ ×”×˜×™×•×œ</h2>
                    <p class="mt-4 text-xl text-slate-200 max-w-2xl mx-auto">×›×œ ×”××œ×•× ×•×ª, ×”×˜×™×¡×•×ª, ×”×¨×›×‘×™×, ×”×¨×›×‘×•×ª ×•×”××¢×‘×•×¨×•×ª ×‘××§×•× ××—×“.</p>
                    <button id="open-add-modal-btn" class="mt-8 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i>×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×•×’×™×¡×˜×™
                    </button>
                </div>

                <section id="hotel-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ¨ ×¡×™×›×•× ×”××œ×•× ×•×ª ×©×œ× ×•</h3>
                    <div id="hotel-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </section>

                <section id="transport-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">âœˆï¸ ×¡×™×›×•× ×”××¢×‘×¨×™× ×©×œ× ×•</h3>
                    <div id="transport-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    </div>
                </section>

                <section id="cost-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ“Š ×¡×™×›×•××™ ×¢×œ×•×™×•×ª</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg ring-1 ring-black ring-opacity-5">
                            <h4 class="font-bold text-xl text-slate-700 mb-4">ğŸ§¾ ×¡×™×›×•× ×œ×•×’×™×¡×˜×™×§×”</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-right">
                                    <thead class="bg-slate-50"><tr><th class="p-3 font-semibold rounded-tr-lg">×§×˜×’×•×¨×™×”</th><th class="p-3 font-semibold text-left rounded-tl-lg">×¢×œ×•×ª ($)</th></tr></thead>
                                    <tbody id="logistics-summary-tbody" class="divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-gradient-to-br from-blue-500 to-indigo-600 p-6 rounded-2xl shadow-lg flex flex-col justify-center items-center text-white">
                            <h4 class="font-bold text-xl mb-2 drop-shadow">ğŸ’° ×”×©×•×¨×” ×”×ª×—×ª×•× ×”</h4>
                            <div id="grand-total-container" class="text-center">
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>
    
    <div id="item-modal" class="modal fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95 opacity-0">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©</h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="item-form" class="flex-grow overflow-y-auto p-8 space-y-6"></form>
            <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
                <button type="button" id="modal-back-btn" class="py-2 px-5 rounded-lg hover:bg-slate-200 transition hidden font-semibold">××—×•×¨×”</button>
                <div id="modal-error-message" class="text-red-500 text-sm font-bold h-5 flex-grow text-center"></div>
                <button type="button" id="modal-next-btn" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
                <button type="submit" form="item-form" id="modal-finish-btn" class="py-2 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition hidden">×©××•×¨ ×¤×¨×™×˜</button>
            </div>
        </div>
    </div>
    
    <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center opacity-0 transition-opacity duration-300">
       <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-95 opacity-0 transition-all duration-300">
            <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
            <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§?</h3>
            <div class="flex justify-center gap-4 mt-6">
                <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
                <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="modal fixed inset-0 bg-black/60 z-[75] hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95 opacity-0">
            <!-- Details content will be injected here -->
        </div>
    </div>

    <div id="address-picker-modal" class="modal fixed inset-0 bg-black/60 z-[85] hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-lg max-h-[80vh] flex flex-col transform scale-95 opacity-0">
            <div class="p-5 border-b flex justify-between items-center">
                <h3 class="text-xl font-bold text-slate-800">×‘×—×™×¨×ª ×›×ª×•×‘×ª ××”×˜×™×•×œ</h3>
                <button id="address-picker-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="address-picker-content" class="p-4 overflow-y-auto">
                <!-- Addresses will be loaded here -->
            </div>
        </div>
    </div>

    <script>
        // --- Google Maps Services Initialization ---
        // This function is called by the Google Maps script tag's callback parameter
        let geocoder;
        let autocompleteService;
        let directionsService;
        let placesService; 
        
        function initMaps() {
            geocoder = new google.maps.Geocoder();
            autocompleteService = new google.maps.places.AutocompleteService();
            directionsService = new google.maps.DirectionsService();
            // The map element passed to PlacesService is temporary and not displayed.
            // It's required for the service to function.
            const mapDiv = document.createElement('div');
            placesService = new google.maps.places.PlacesService(new google.maps.Map(mapDiv));
            
            // Dispatch a custom event to let the module script know that Google Maps is ready
            window.dispatchEvent(new CustomEvent('google-maps-ready'));
        }
    </script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, addDoc, query, onSnapshot,
            serverTimestamp, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration & Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & Constants ---
        const FLIGHT_API_BASE = "https://calm-resonance-b9ec.doronenakache.workers.dev/api";
        let tripId = null;
        let tripData = null;
        let currentUser = null;
        let allItems = [];
        let editingItem = null; 
        let itemToDelete = null;
        let logisticsUnsubscribe = null; // To detach the listener
        
        let modalState = {
            mainType: null, subType: null, currentStep: 1, data: {},
            maps: {}, flightDataFound: false,
        };
        // For managing Google Maps objects
        let mapMarkers = {};
        let mapPolylines = {};
        let directionsRenderer; 
        let detailsDirectionsRenderer;
        
        let currentAddressPickerTarget = null; // To know which input to fill

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            notificationBanner: document.getElementById('notification-banner'),
            notificationMessage: document.getElementById('notification-message'),
            pageTitle: document.getElementById('page-title'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            authContainer: document.getElementById('auth-container'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            hotelContainer: document.getElementById('hotel-cards-container'),
            transportContainer: document.getElementById('transport-cards-container'),
            modal: document.getElementById('item-modal'),
            modalContent: document.querySelector('#item-modal .modal-content'),
            modalTitle: document.getElementById('modal-title'),
            modalForm: document.getElementById('item-form'),
            modalNextBtn: document.getElementById('modal-next-btn'),
            modalBackBtn: document.getElementById('modal-back-btn'),
            modalFinishBtn: document.getElementById('modal-finish-btn'),
            modalError: document.getElementById('modal-error-message'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            deleteModal: document.getElementById('delete-confirm-modal'),
            deleteModalContent: document.querySelector('#delete-confirm-modal .modal-content'),
            deleteModalTitle: document.getElementById('delete-modal-title'),
            deleteConfirmBtn: document.getElementById('delete-modal-confirm'),
            deleteCancelBtn: document.getElementById('delete-modal-cancel'),
            detailsModal: document.getElementById('details-modal'),
            detailsModalContent: document.querySelector('#details-modal .modal-content'),
            addressPickerModal: document.getElementById('address-picker-modal'),
            addressPickerModalContent: document.querySelector('#address-picker-modal .modal-content'),
            addressPickerContent: document.getElementById('address-picker-content'),
            addressPickerCloseBtn: document.getElementById('address-picker-close-btn'),
            logisticsSummaryBody: document.getElementById('logistics-summary-tbody'),
            grandTotalContainer: document.getElementById('grand-total-container'),
        };

        // --- Utilities ---

        // Debounce function to limit how often a function can be called.
        const debounce = (func, delay) => {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => {
                    func.apply(this, args);
                }, delay);
            };
        };

        function showNotification(message, type = 'error', duration = 5000) {
            DOM.notificationMessage.textContent = message;
            DOM.notificationBanner.className = `fixed top-4 right-4 z-[101] p-4 rounded-lg shadow-lg text-white opacity-0 transform -translate-y-12 ${type === 'error' ? 'bg-red-500' : (type === 'success' ? 'bg-green-500' : 'bg-blue-500')}`;
            
            DOM.notificationBanner.classList.remove('opacity-0', '-translate-y-12');
            DOM.notificationBanner.classList.add('opacity-100', 'translate-y-0');

            setTimeout(() => {
                DOM.notificationBanner.classList.remove('opacity-100', 'translate-y-0');
                DOM.notificationBanner.classList.add('opacity-0', '-translate-y-12');
            }, duration);
        }

        function formatDateToInput(d) { // Converts DD/MM/YYYY to YYYY-MM-DD
            if (!d || d.indexOf('/') === -1) return '';
            const parts = d.split('/');
            if (parts.length !== 3) return '';
            return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
        }
        
        function formatApiDateToInput(d) { // Converts YYYY-MM-DDTHH:mm:ss to YYYY-MM-DD
            if (!d) return '';
            return d.split('T')[0];
        }

        function formatApiTimeToInput(d) { // Converts YYYY-MM-DDTHH:mm:ss to HH:mm
             if (!d) return "â€”";
             const m = d.match(/(?:T|\s)(\d{2}:\d{2})/);
             return m ? m[1] : "â€”";
        }

        function formatDateFromInput(d) { // Converts YYYY-MM-DD to DD/MM/YYYY
            if (!d) return '';
            const parts = d.split('-');
            if (parts.length !== 3) return '';
            return `${parts[2]}/${parts[1]}/${parts[0]}`;
        }

        function formatLitepickerDateToInput(d) { // d is JS Date object from litepicker
            if (!d) return '';
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId') || urlParams.get('id');
            if (!tripId) {
                showNotification("×©×’×™××”: ×œ× × ××¦× ××–×”×” ×˜×™×•×œ. ××—×–×™×¨ ××•×ª×š ×œ×“×£ ×”×‘×™×ª.");
                setTimeout(() => window.location.href = 'index.html', 3000);
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    // Wait for Google Maps to be ready before loading page data that might need it
                    if (window.google && window.google.maps) {
                        loadPageData();
                    } else {
                        window.addEventListener('google-maps-ready', loadPageData, { once: true });
                    }
                    setupAuthUI(user);
                } else {
                    showNotification("× ×“×¨×©×ª ×”×ª×—×‘×¨×•×ª. ××¢×‘×™×¨ ×œ×“×£ ×”×›× ×™×¡×”...", "info");
                    setTimeout(() => window.location.href = 'login.html', 2500);
                }
            });
        }

        async function loadPageData() {
            if (logisticsUnsubscribe) logisticsUnsubscribe(); 

            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);

            if (!tripSnap.exists()) {
                showNotification("×”×˜×™×•×œ ×œ× × ××¦×. ××—×–×™×¨ ××•×ª×š ×œ×“×£ ×”×‘×™×ª.");
                setTimeout(() => window.location.href = 'index.html', 3000);
                return;
            }

            const tripDataFromSnap = tripSnap.data();
            const canAccess = tripDataFromSnap.owner === currentUser.uid || (tripDataFromSnap.editors && tripDataFromSnap.editors.includes(currentUser.uid));

            if (!canAccess) {
                showNotification('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×ª×•×›×Ÿ ×–×”.');
                setTimeout(() => location.href = 'index.html', 3000);
                return;
            }
            
            tripData = tripDataFromSnap;
            document.title = `×œ×•×’×™×¡×˜×™×§×” - ${tripData.name}`;
            DOM.pageTitle.textContent = `×œ×•×’×™×¡×˜×™×§×” - ${tripData.name}`;
            buildMenuFromTrip();

            const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
            const q = query(logisticsCollectionRef);

            logisticsUnsubscribe = onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
                DOM.loadingOverlay.style.opacity = '0';
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);
            }, (error) => {
                console.error("Snapshot error:", error);
                showNotification("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×œ×•×’×™×¡×˜×™×§×”.");
                DOM.loadingOverlay.style.opacity = '0';
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);
            });
        }

        // --- UI Population ---
        function renderApp() {
            const hotels = allItems.filter(item => item.type === 'hotel');
            const transports = allItems.filter(item => ['flight', 'car_rental', 'ferry', 'train', 'ride'].includes(item.type));
            
            renderCards(DOM.hotelContainer, hotels, createHotelCard);
            renderCards(DOM.transportContainer, transports, createTransportCard);
            renderSummaryTables();
        }

        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? docSnap.data().name : '××©×ª××©';
                DOM.authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${name} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
                document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
            });
        }

        // --- ×¢×–×¨×™ ×ª××¨×™×›×™× ×œ×ª×¤×¨×™×˜ ---
        function parseDDMMYYYY(s) {
            if (!s || typeof s !== 'string') return null;
            const [d, m, y] = s.split('/').map(Number);
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            return new Date(y, m - 1, d);
        }

        function hebWeekday(d) {
            const n = d.toLocaleDateString('he-IL', { weekday: 'long' });
            return n.startsWith('×™×•×') ? n : `×™×•× ${n}`;
        }

        function dotted(d) {
            return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
        }
        
        // ×”×¢×¨×”: ×™×© ×œ×š ×›×‘×¨ ×¤×•× ×§×¦×™×” ×‘×©× generateDatesFromRange ×‘×§×•×“, 
        // ××•××œ×¥ ×œ×”×—×œ×™×£ ××•×ª×” ×‘×’×¨×¡×” ×”×–×• ×©×¢×•×‘×“×ª ×¢× ×”×¤×•× ×§×¦×™×•×ª ×”×—×“×©×•×ª:
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDDMMYYYY(startStr);
            const endDate = parseDDMMYYYY(endStr);
            if (!startDate || !endDate) return [];
            
            const dates = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dd = String(currentDate.getDate()).padStart(2,'0');
                const mm = String(currentDate.getMonth()+1).padStart(2,'0');
                const yyyy = currentDate.getFullYear();
                dates.push(`${dd}/${mm}/${yyyy}`);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // --- ×¤×•× ×§×¦×™×™×ª ×‘× ×™×™×ª ×”×ª×¤×¨×™×˜ ×”×—×“×©×” ---
        function buildMenuFromTrip() {
            DOM.mainMenu.innerHTML = ''; 

            // 1. ×›×¤×ª×•×¨×™ × ×™×•×•×˜ ××”×™×¨×™×
            const tParam = `?tripId=${tripId}`;
            const navLinks = [
                { name: '××¨×›×– ×”×‘×§×¨×”', icon: 'fa-home', href: `trip.html${tParam}`, color: 'text-blue-600', bg: 'bg-blue-50' },
                { name: '× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”', icon: 'fa-suitcase', href: `summary.html${tParam}`, color: 'text-orange-600', bg: 'bg-orange-50' },
                { name: '××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª', icon: 'fa-utensils', href: `attractions.html${tParam}`, color: 'text-cyan-600', bg: 'bg-cyan-50' },
                { name: '×¨×©×™××•×ª ×•×¦\'×§ ×œ×™×¡×˜', icon: 'fa-list-check', href: `checklists.html${tParam}`, color: 'text-emerald-600', bg: 'bg-emerald-50' },
                { name: '××¢×§×‘ ×”×•×¦××•×ª', icon: 'fa-coins', href: `expenses.html${tParam}`, color: 'text-rose-600', bg: 'bg-rose-50' },
                { name: '×‘× ×™×™×ª ××¡×œ×•×œ ×—×›×', icon: 'fa-magic-wand-sparkles', href: `edit-trip.html${tParam}`, color: 'text-purple-600', bg: 'bg-purple-50' }
            ];

            const navContainer = document.createElement('div');
            navContainer.className = 'space-y-2 mb-6';
            const currentPath = window.location.pathname; // ×œ×–×™×”×•×™ ×”×“×£ ×”× ×•×›×—×™

            navLinks.forEach(link => {
                const a = document.createElement('a');
                a.href = link.href;
                // ×‘×“×™×§×” ×‘×¡×™×¡×™×ª ×× ×–×” ×”×“×£ ×”× ×•×›×—×™ (×œ××©×œ summary.html)
                const isActive = currentPath.includes(link.href.split('?')[0].replace('summary.html', '')) && link.href.includes('summary.html'); 

                a.className = `flex items-center gap-3 w-full p-3 rounded-xl transition-all hover:translate-x-1 ${isActive ? 'bg-slate-100 font-bold border-r-4 border-cyan-500' : 'hover:bg-slate-50'}`;
                
                a.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${link.bg} ${link.color} flex items-center justify-center shadow-sm">
                        <i class="fas ${link.icon}"></i>
                    </div>
                    <span class="text-slate-700 ${isActive ? 'font-bold' : 'font-medium'}">${link.name}</span>
                `;
                navContainer.appendChild(a);
            });
            DOM.mainMenu.appendChild(navContainer);

            // 2. ×›×•×ª×¨×ª ×œ×™×¢×“×™×
            const separator = document.createElement('div');
            separator.className = 'h-px bg-slate-200 my-4';
            DOM.mainMenu.appendChild(separator);

            const scheduleHeader = document.createElement('h3');
            scheduleHeader.className = 'text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2';
            scheduleHeader.innerText = "×œ×•×´×– ×™×•××™ ×œ×¤×™ ×™×¢×“×™×";
            DOM.mainMenu.appendChild(scheduleHeader);

            if (!tripData?.destinations || !Array.isArray(tripData.destinations)) {
                DOM.mainMenu.insertAdjacentHTML('beforeend', '<p class="text-center text-slate-400 text-sm">×œ× ×”×•×’×“×¨×• ×™×¢×“×™×.</p>');
                return;
            }

            // ××™×•×Ÿ ×™×¢×“×™× ×œ×¤×™ ×ª××¨×™×š
            const sortedDestinations = [...tripData.destinations].sort((a, b) => {
                const dateA = parseDDMMYYYY(a.dates?.split(' - ')[0]);
                const dateB = parseDDMMYYYY(b.dates?.split(' - ')[0]);
                if (!dateA) return 1; if (!dateB) return -1;
                return dateA - dateB;
            });

            sortedDestinations.forEach(dest => {
                const destinationDiv = document.createElement('div');
                destinationDiv.className = 'mb-2';

                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 hover:bg-cyan-50 rounded-xl font-bold text-slate-700 flex justify-between items-center transition-all group';
                button.innerHTML = `
                    <span class="flex items-center gap-3"><i class="fas fa-map-marked-alt text-slate-400 group-hover:text-cyan-500 transition-colors"></i> ${dest.nameHe}</span> 
                    <i class="fas fa-chevron-down chevron-icon text-slate-300 text-sm"></i>`;

                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-4 border-r-2 border-slate-100 pr-2 space-y-1';

                const dates = generateDatesFromRange(dest.dates);
                if(dates.length === 0) {
                     submenu.innerHTML = '<div class="text-xs text-slate-400 pr-3 py-1">×œ×œ× ×ª××¨×™×›×™×</div>';
                } else {
                    dates.forEach(dateStr => {
                        const d = parseDDMMYYYY(dateStr);
                        const a = document.createElement('a');
                        a.href = `daily-schedule.html?tripId=${tripId}&date=${dateStr}`;
                        a.className = 'block w-full text-right py-2 px-3 text-slate-600 hover:bg-slate-50 hover:text-cyan-700 rounded-lg transition text-sm';
                        a.innerHTML = `<div class="flex items-center gap-2"><span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span><span class="font-medium">${hebWeekday(d)}</span><span class="text-xs text-slate-400">(${dotted(d)})</span></div>`;
                        submenu.appendChild(a);
                    });
                }

                button.addEventListener('click', () => {
                    submenu.classList.toggle('open');
                    button.querySelector('.chevron-icon').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }
        
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const [startDay, startMonth, startYear] = startStr.split('/').map(Number);
            const [endDay, endMonth, endYear] = endStr.split('/').map(Number);
            
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                dates.push(currentDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit', year: 'numeric'}));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // --- Card Creation ---
        /**
         * Parses a date string in DD/MM/YYYY format into a Date object for sorting.
         * @param {string} dateStr The date string.
         * @returns {Date|null} A Date object or null if invalid.
         */
        function parseDateForSort(dateStr) {
            if (!dateStr || typeof dateStr !== 'string' || !dateStr.includes('/')) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            // new Date(year, monthIndex, day)
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function renderCards(container, items, cardCreator) {
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<div class="text-center bg-white/30 backdrop-blur-sm p-8 rounded-xl col-span-full ring-1 ring-white/20 flex flex-col items-center justify-center gap-4">
                    <i class="fas fa-box-open text-4xl text-white/80"></i>
                    <p class="text-white text-lg drop-shadow">×¢×“×™×™×Ÿ ×œ× × ×•×¡×¤×• ×¤×¨×™×˜×™× ×‘×§×˜×’×•×¨×™×” ×–×•. ×œ×—×¦×• ×¢×œ '×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×•×’×™×¡×˜×™' ×›×“×™ ×œ×”×ª×—×™×œ!</p>
                </div>`;
                return;
            }
            
            items.sort((a, b) => {
                // Get the primary date string for each item. For hotels/cars, use the start date of the range.
                const dateStringA = a.type === 'hotel' || a.type === 'car_rental' ? a.dates?.split(' - ')[0] : a.date;
                const dateStringB = b.type === 'hotel' || b.type === 'car_rental' ? b.dates?.split(' - ')[0] : b.date;

                const dateA = parseDateForSort(dateStringA);
                const dateB = parseDateForSort(dateStringB);
                
                if (!dateA && !dateB) return 0; // If both have no date, keep original order
                if (!dateA) return 1; // Put items without dates at the end
                if (!dateB) return -1; // Keep items with dates at the start
                
                return dateA - dateB; // Sort ascending
            }).forEach(item => {
                const card = cardCreator(item);
                container.appendChild(card);
            });
        }

        function getPaymentPriceBadgeClasses(item) {
            const payment = item.payment || { status: 'unpaid' };
            switch (payment.status) {
                case 'paid':
                    return 'bg-green-100 text-green-800 ring-1 ring-green-200';
                case 'partial':
                    return 'bg-orange-100 text-orange-800 ring-1 ring-orange-200';
                case 'unpaid':
                default:
                    return 'bg-slate-100 text-slate-800 ring-1 ring-slate-200';
            }
        }

        function createHotelCard(item) {
            const card = document.createElement('div');
            card.className = "bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex flex-col cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 ring-1 ring-black ring-opacity-5";
            card.dataset.id = item.id;
            card.dataset.action = 'view-details';

            let starsHtml = '';
            if (item.stars && item.stars > 0) {
                for (let i = 0; i < 5; i++) {
                    starsHtml += `<i class="fas fa-star ${i < item.stars ? 'text-yellow-400' : 'text-slate-300'}"></i>`;
                }
            }
            
            const mealColorMap = {
                '××¨×•×—×ª ×‘×•×§×¨': 'bg-yellow-100 text-yellow-800',
                '×—×¦×™ ×¤× ×¡×™×•×Ÿ': 'bg-orange-100 text-orange-800',
                '×”×›×œ ×›×œ×•×œ': 'bg-blue-100 text-blue-800',
                '×—×¦×™ ××˜×‘×— ×‘×—×“×¨': 'bg-green-100 text-green-800',
                '××˜×‘×— ××œ× ×‘×—×“×¨': 'bg-emerald-100 text-emerald-800',
            };
            const mealIcons = {
                '××¨×•×—×ª ×‘×•×§×¨': 'fa-coffee', '×—×¦×™ ×¤× ×¡×™×•×Ÿ': 'fa-plate-wheat', '×”×›×œ ×›×œ×•×œ': 'fa-utensils',
                '×—×¦×™ ××˜×‘×— ×‘×—×“×¨': 'fa-kitchen-set', '××˜×‘×— ××œ× ×‘×—×“×¨': 'fa-blender'
            };
            let mealsHtml = '';
            if (item.meals && Array.isArray(item.meals) && item.meals.length > 0) {
                mealsHtml = item.meals.map(meal => `<span class="inline-flex items-center gap-1.5 ${mealColorMap[meal] || 'bg-slate-100 text-slate-600'} text-xs font-medium px-2 py-1 rounded-full"><i class="fas ${mealIcons[meal] || 'fa-circle-check'}"></i> ${meal}</span>`).join(' ');
            }

            const priceBadgeClasses = getPaymentPriceBadgeClasses(item);

            card.innerHTML = `
                <div class="flex-grow">
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-lg text-slate-800">${item.name || '××œ×•×Ÿ ×œ×œ× ×©×'}</h4>
                            <p class="text-sm text-slate-500 mb-1">${item.destination || ''}</p>
                            <div class="flex items-center gap-2 text-sm">
                                ${starsHtml ? `<div class="flex items-center gap-0.5">${starsHtml}</div>` : ''}
                                ${item.booking_rating ? `<span class="font-bold bg-blue-600 text-white text-xs rounded-md px-2 py-0.5">${item.booking_rating}</span>` : ''}
                            </div>
                        </div>
                        <div class="flex gap-2 shrink-0 ml-2">
                            <button class="edit-btn text-slate-400 hover:text-blue-500" data-id="${item.id}" title="×¢×¨×™×›×”"><i class="fas fa-pencil"></i></button>
                            <button class="delete-btn text-slate-400 hover:text-red-500" data-id="${item.id}" data-name="${item.name || '××œ×•×Ÿ'}" title="××—×™×§×”"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                    <div class="mt-3 text-slate-600 text-sm space-y-2">
                        <div class="flex items-center gap-2"><i class="fa-solid fa-calendar-days fa-fw text-slate-400"></i> <strong>×ª××¨×™×›×™×:</strong> ${item.dates || '×œ× ×¦×•×™×Ÿ'}</div>
                        <div class="flex items-center gap-2">
                            <i class="fa-solid fa-tag fa-fw text-slate-400"></i> 
                            <strong>××—×™×¨:</strong> 
                            <span class="px-2 py-0.5 rounded-md font-bold ${priceBadgeClasses}">$${item.price ? item.price.toLocaleString() : '×œ× ×¦×•×™×Ÿ'}</span>
                        </div>
                    </div>
                </div>
                ${mealsHtml ? `<div class="mt-4 pt-3 border-t border-slate-200 flex flex-wrap gap-2">${mealsHtml}</div>` : ''}
            `;
            return card;
        }

        function createTransportCard(item) {
            const card = document.createElement('div');
            card.className = "bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex flex-col cursor-pointer hover:shadow-xl hover:-translate-y-1 transition-all duration-300 ring-1 ring-black ring-opacity-5";
            card.dataset.id = item.id;
            card.dataset.action = 'view-details';
            
            const travelers = item.travelers || 1;
            const price_per_person = item.price_per_person || 0;
            const totalPrice = (item.type === 'car_rental' ? item.price : price_per_person * travelers) || 0;
            const priceBadgeClasses = getPaymentPriceBadgeClasses(item);

            let title, icon, details;
            switch (item.type) {
                case 'flight':
                    title = `×˜×™×¡×”`; icon = 'fa-plane-departure';
                    details = `<p class="font-semibold text-slate-700">${item.from?.destination || '?'} â†’ ${item.to?.destination || '?'}</p><p class="text-sm text-slate-500">${item.airline || ''} | ${item.date || ''}</p>`;
                    break;
                case 'car_rental':
                    title = `×¨×›×‘ ×©×›×•×¨`; icon = 'fa-car';
                    details = `<p class="font-semibold text-slate-700">${item.destination || ''}</p><p class="text-sm text-slate-500">${item.booked_via || ''}</p>`;
                    break;
                case 'ferry':
                    title = `××¢×‘×•×¨×ª`; icon = 'fa-ship';
                    details = `<p class="font-semibold text-slate-700">${item.from_destination || '?'} â†’ ${item.to_destination || '?'}</p><p class="text-sm text-slate-500">${item.company || ''} | ${item.date || ''}</p>`;
                    break;
                case 'train':
                    title = `×¨×›×‘×ª`; icon = 'fa-train';
                    details = `<p class="font-semibold text-slate-700">${item.from_station || '?'} â†’ ${item.to_station || '?'}</p><p class="text-sm text-slate-500">${item.company || ''} | ${item.date || ''}</p>`;
                    break;
                case 'ride':
                    title = `×”×¡×¢×” / ××•× ×™×ª`; icon = 'fa-taxi';
                    details = `<p class="font-semibold text-slate-700">${item.from_address?.split(',')[0] || '?'} â†’ ${item.to_address?.split(',')[0] || '?'}</p><p class="text-sm text-slate-500">${item.date || ''} | ${item.pickup_time || ''}</p>`;
                    break;
                default:
                    title = "××¢×‘×¨ ×œ× ×™×“×•×¢"; icon = 'fa-question-circle';
                    details = '';
            }

            card.innerHTML = `
                <div class="flex-grow">
                     <div class="flex justify-between items-start mb-2">
                         <div class="flex items-center gap-4">
                             <i class="fas ${icon} fa-2x text-sky-500 w-8 text-center"></i>
                             <div>
                                 <h4 class="font-bold text-lg text-slate-800">${title}</h4>
                             </div>
                         </div>
                         <div class="flex gap-2">
                             <button class="edit-btn text-slate-400 hover:text-blue-500" data-id="${item.id}" title="×¢×¨×™×›×”"><i class="fas fa-pencil"></i></button>
                             <button class="delete-btn text-slate-400 hover:text-red-500" data-id="${item.id}" data-name="${title}" title="××—×™×§×”"><i class="fas fa-times"></i></button>
                         </div>
                     </div>
                     <div class="pr-12">${details}</div>
                </div>
                <div class="mt-auto pt-4 border-t flex justify-between items-center text-slate-700">
                    <div class="flex items-center gap-1 text-sm"><i class="fa-solid fa-users text-slate-400"></i><span>${travelers}</span></div>
                    <div><span class="px-2 py-1 rounded-md font-bold text-base ${priceBadgeClasses}">$${totalPrice.toLocaleString()}</span></div>
                </div>`;
            return card;
        }

        // --- Modal Logic ---
        function resetModalState() {
            Object.values(modalState.maps).forEach(map => {
                // Google Maps doesn't have a simple remove, we just clear the container
            });
            clearAllMapObjects();
            
            modalState = {
                mainType: null, subType: null, currentStep: 1, data: {},
                maps: {}, flightDataFound: false,
            };
            editingItem = null;
        }

        function openModal(itemToEdit = null) {
            // UPDATE: Prevent background from scrolling when modal is open
            document.body.classList.add('overflow-hidden');
            
            resetModalState();
            if (itemToEdit) {
                DOM.modalTitle.textContent = '×¢×¨×™×›×ª ×¤×¨×™×˜';
                editingItem = { id: itemToEdit.id };
                modalState.mainType = (itemToEdit.type === 'hotel') ? 'hotel' : 'transport';
                modalState.subType = ['flight', 'car_rental', 'ferry', 'train', 'ride'].includes(itemToEdit.type) ? itemToEdit.type : null;
                modalState.data = JSON.parse(JSON.stringify(itemToEdit));
                
                if (modalState.subType === 'flight') {
                    modalState.flightDataFound = true; // For edits, skip search
                }
                
                if (modalState.data.type === 'ride' && modalState.data.route_geometry && typeof modalState.data.route_geometry === 'string') {
                    try {
                        modalState.data.route_geometry = JSON.parse(modalState.data.route_geometry);
                    } catch (e) {
                        console.error("Failed to parse route geometry:", e);
                        delete modalState.data.route_geometry;
                    }
                }

                // Deconstruct 'dates' string into individual date fields for the native form inputs
                const type = itemToEdit.type;
                if ((type === 'hotel' || type === 'car_rental') && itemToEdit.dates) {
                    const [start, end] = itemToEdit.dates.split(' - ');
                    if (type === 'hotel') {
                        modalState.data.checkin_date = start;
                        modalState.data.checkout_date = end;
                    } else { // car_rental
                        modalState.data.pickup_date = start;
                        modalState.data.return_date = end;
                    }
                }
                // No need for an else-if for single dates, as `itemToEdit.date` is already in `modalState.data` from the deep copy.

            } else {
                DOM.modalTitle.textContent = '×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©';
            }
            
            generateStepContent();
            updateModalNav();
            
            DOM.modal.classList.remove('hidden');
            setTimeout(() => {
                DOM.modal.classList.remove('opacity-0');
                DOM.modalContent.classList.remove('scale-95', 'opacity-0');
                
                initializeFieldPlugins();
                setTimeout(() => {
                    Object.values(modalState.maps).forEach(map => {
                        if(map) google.maps.event.trigger(map, 'resize');
                    });
                }, 100);
            }, 10);
        }

        function closeModal() {
            // UPDATE: Restore background scrolling when modal is closed
            document.body.classList.remove('overflow-hidden');
            
            DOM.modal.classList.add('opacity-0');
            DOM.modalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                DOM.modal.classList.add('hidden');
                resetModalState();
            }, 300);
        }
        
        function getStepDefinition() {
            const paymentStep = { title: "×¡×˜×˜×•×¡ ×ª×©×œ×•×", fields: [{id: 'payment', type: 'payment_status'}] };
            
            const steps = {
                start: { title: "××™×–×” ×¤×¨×™×˜ ×œ×”×•×¡×™×£?", fields: [{ id: 'mainType', type: 'radio', options: [{value: 'hotel', label: 'ğŸ¨ ××œ×•×Ÿ'}, {value: 'transport', label: 'âœˆï¸ ××¢×‘×¨'}] }] },
                hotel: [
                    { title: "×™×¢×“ ×•×¤×¨×˜×™× ×‘×¡×™×¡×™×™×", fields: [
                        {id: 'destination', label: '×‘×—×™×¨×ª ×™×¢×“ ××”×˜×™×•×œ', type: 'select', optionsKey: 'tripDestinations'},
                        {id: 'name', label: '×©× ×”××œ×•×Ÿ'},
                        {id: 'booked_via', label: '×”×•×–××Ÿ ×“×¨×š?'}
                    ] },
                    { title: "×ª××¨×™×›×™× ×•××—×™×¨", fields: [
                        {id: 'stay_dates', label: '×ª××¨×™×›×™ ×©×”×™×™×”', type: 'daterange'},
                        {id: 'price', label: '××—×™×¨ ×›×•×œ×œ (×‘×“×•×œ×¨×™×)', type: 'number'}
                    ]},
                    { title: "××™×§×•× ××“×•×™×§", fields: [
                        {id: 'address', label: '×›×ª×•×‘×ª ××“×•×™×§×ª', type: 'addressmap'}
                    ]},
                    { title: "×©×™×¨×•×ª×™× ×•×“×™×¨×•×’×™×", fields: [
                        {id: 'meals', label: '××¨×•×—×•×ª', type: 'custom_multiselect', options: ['××¨×•×—×ª ×‘×•×§×¨', '×—×¦×™ ×¤× ×¡×™×•×Ÿ', '×”×›×œ ×›×œ×•×œ', '×—×¦×™ ××˜×‘×— ×‘×—×“×¨', '××˜×‘×— ××œ× ×‘×—×“×¨']},
                        {id: 'stars', label: '×“×™×¨×•×’ ×›×•×›×‘×™×', type: 'starrating'},
                        {id: 'booking_rating', label: '×“×™×¨×•×’ ×‘×•×§×™× ×’ (××•×¤×¦×™×•× ×œ×™)', type: 'number', placeholder: '×œ×“×•×’××”: 8.9'}
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        {id: 'link', label: '×§×™×©×•×¨ ×œ××ª×¨ (×‘×•×§×™× ×’ ×•×›×•\')', type: 'url'},
                        {id: 'additional_details', label: '×”×¢×¨×•×ª × ×•×¡×¤×•×ª', type: 'textarea'}
                    ]},
                    paymentStep
                ],
                transport: { title: "××™×–×” ×¡×•×’ ××¢×‘×¨?", fields: [{ id: 'subType', type: 'radio', options: [
                    {value: 'flight', label: 'âœˆï¸ ×˜×™×¡×”'}, 
                    {value: 'car_rental', label: 'ğŸš— ×¨×›×‘ ×©×›×•×¨'},
                    {value: 'ride', label: 'ğŸš• ××•× ×™×ª/×”×¡×¢×”'},
                    {value: 'ferry', label: 'ğŸš¢ ××¢×‘×•×¨×ª'},
                    {value: 'train', label: 'ğŸš† ×¨×›×‘×ª'}
                ] }] },
                flight_search: { title: "×—×™×¤×•×© ×¤×¨×˜×™ ×˜×™×¡×”", fields: [{id: 'flight_search', type: 'flight_search_ui'}] },
                ride: [
                    { title: "××¡×œ×•×œ ×”× ×¡×™×¢×”", fields: [{ id: 'routemap', type: 'routemap'}] },
                    { title: "×¤×¨×˜×™ ×”×–×× ×”", fields: [
                        { id: 'booked_via', label: '×××™×¤×” ×”×•×–××Ÿ?'},
                        { id: 'company', label: '×—×‘×¨×ª ×”×”×¡×¢×•×ª/××•× ×™×•×ª'}
                    ]},
                    { title: "×¤×¨×˜×™× ×œ×•×’×™×¡×˜×™×™×", fields: [
                        { id: 'date', label: '×ª××¨×™×š × ×¡×™×¢×”', type: 'date' },
                        { id: 'pickup_time', label: '×©×¢×ª ××™×¡×•×£', type: 'time'},
                        { id: 'driver_name', label: '×©× ×”× ×”×’ (××•×¤×¦×™×•× ×œ×™)'},
                        { id: 'driver_phone', label: '×˜×œ×¤×•×Ÿ ×”× ×”×’ (××•×¤×¦×™×•× ×œ×™)', type: 'tel'},
                        { id: 'vehicle_number', label: '××¡×¤×¨ ×¨×›×‘ (××•×¤×¦×™×•× ×œ×™)'},
                        { id: 'vehicle_details', label: '×¤×¨×˜×™ ×”×¨×›×‘ (×œ×“×•×’××”: ××¨×¦×“×¡ ×©×—×•×¨×”)', type: 'text'},
                        { id: 'travelers', label: '××¡×¤×¨ × ×•×¡×¢×™×', type: 'number', default: 2},
                        { id: 'price_per_person', label: '××—×™×¨ ×œ× ×•×¡×¢ (×‘×“×•×œ×¨×™×)', type: 'number'},
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        { id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (×”×¢×¨×•×ª, × ×§×•×“×ª ××¤×’×© ×•×›×•\')', type: 'textarea'}
                    ]},
                    paymentStep
                ],
                car_rental: [
                    { title: "×¤×¨×˜×™ ×”×©×›×¨×ª ×”×¨×›×‘", fields: [
                        {id: 'destination', label: '×œ××™×–×” ×™×¢×“?', type: 'text'},
                        {id: 'booked_via', label: '×“×¨×š ××™×¤×” ×”×•×–××Ÿ?'},
                        {id: 'pickup_location', label: '×××™×¤×” ×œ×•×§×—×™× ×‘×“×™×•×§?', type: 'text_autocomplete'},
                    ]},
                    { title: "×ª××¨×™×›×™× ×•×¡×•×’", fields: [
                        {id: 'pickup_date', label: '×ª××¨×™×š ××™×¡×•×£', type: 'date'},
                        {id: 'return_date', label: '×ª××¨×™×š ×”×—×–×¨×”', type: 'date'},
                        {id: 'pickup_time', label: '×©×¢×ª ××™×¡×•×£', type: 'time'},
                        {id: 'return_time', label: '×©×¢×ª ×”×—×–×¨×”', type: 'time'},
                        {id: 'car_type', label: '×¡×•×’ ×¨×›×‘', type: 'text', placeholder: '×œ×“×•×’××”: SUV, ××™× ×™'},
                    ]},
                    { title: "×¢×œ×•×ª ×•×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        {id: 'travelers', label: '××¡×¤×¨ × ×•×¡×¢×™×', type: 'number', default: 2},
                        {id: 'price', label: '××—×™×¨ ×›×•×œ×œ (×‘×“×•×œ×¨×™×)', type: 'number'},
                        {id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
                    ]},
                    paymentStep
                ],
                flight: [
                    { title: "××¡×œ×•×œ ×”×˜×™×¡×”", fields: [ { id: 'flightroute', type: 'flightroute'} ]},
                    { title: "×¤×¨×˜×™ ×”×˜×™×¡×”", fields: [
                        { id: 'airline', label: '×—×‘×¨×ª ×ª×¢×•×¤×”' },
                        { id: 'flight_number', label: '××¡×¤×¨ ×˜×™×¡×”'},
                        { id: 'date', label: '×ª××¨×™×š ×˜×™×¡×”', type: 'date' },
                        { id: 'departure_time', label: '×©×¢×ª ×”××¨××” (×©×¢×•×Ÿ ××§×•××™ ×™×¦×™××”)', type: 'time' },
                        { id: 'arrival_time', label: '×©×¢×ª × ×—×™×ª×” (×©×¢×•×Ÿ ××§×•××™ ×™×¢×“)', type: 'time' },
                        { id: 'travelers', label: '××¡×¤×¨ × ×•×¡×¢×™×', type: 'number', default: 2},
                        { id: 'price_per_person', label: '××—×™×¨ ×œ× ×•×¡×¢ (×‘×“×•×œ×¨×™×)', type: 'number' },
                    ]},
                    { title: "×›×‘×•×“×”, ×™×©×™×‘×” ×•×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [ 
                        { id: 'luggage', type: 'luggage' }, 
                        { id: 'seats', type: 'seats' },
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
                    ]},
                    paymentStep
                ],
                ferry: [
                    { title: "×¤×¨×˜×™ ×”××¢×‘×•×¨×ª", fields: [
                        { id: 'company', label: '×—×‘×¨×” ××¤×¢×™×œ×”' },
                        { id: 'from_destination', label: '× ×§×•×“×ª ×™×¦×™××”', type: 'text_autocomplete' },
                        { id: 'to_destination', label: '× ×§×•×“×ª ×”×’×¢×”', type: 'text_autocomplete' },
                    ]},
                    { title: "×ª××¨×™×›×™× ×•×¢×œ×•×ª", fields: [
                        { id: 'date', label: '×ª××¨×™×š', type: 'date' },
                        { id: 'departure_time', label: '×©×¢×ª ×™×¦×™××”', type: 'time' },
                        { id: 'arrival_time', label: '×©×¢×ª ×”×’×¢×” ××©×•×¢×¨×ª', type: 'time' },
                        { id: 'travelers', label: '××¡×¤×¨ × ×•×¡×¢×™×', type: 'number', default: 2},
                        { id: 'price_per_person', label: '××—×™×¨ ×œ× ×•×¡×¢ (×‘×“×•×œ×¨×™×)', type: 'number' },
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (×¡×•×’ ×›×¨×˜×™×¡, ×¡×™×¤×•×Ÿ ×•×›×•\')', type: 'textarea'}
                    ]},
                    paymentStep
                ],
                train: [
                    { title: "×¤×¨×˜×™ ×”×¨×›×‘×ª", fields: [
                        { id: 'company', label: '×—×‘×¨×” ××¤×¢×™×œ×”' },
                        { id: 'from_station', label: '×ª×—× ×ª ×™×¦×™××”', type: 'text_autocomplete' },
                        { id: 'to_station', label: '×ª×—× ×ª ×”×’×¢×”', type: 'text_autocomplete' },
                    ]},
                    { title: "×ª××¨×™×›×™× ×•×¢×œ×•×ª", fields: [
                        { id: 'date', label: '×ª××¨×™×š', type: 'date' },
                        { id: 'departure_time', label: '×©×¢×ª ×™×¦×™××”', type: 'time' },
                        { id: 'arrival_time', label: '×©×¢×ª ×”×’×¢×” ××©×•×¢×¨×ª', type: 'time' },
                        { id: 'travelers', label: '××¡×¤×¨ × ×•×¡×¢×™×', type: 'number', default: 2},
                        { id: 'price_per_person', label: '××—×™×¨ ×œ× ×•×¡×¢ (×‘×“×•×œ×¨×™×)', type: 'number' },
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        { id: 'seat_info', label: '×¤×¨×˜×™ ××•×©×‘×™× (××•×¤×¦×™×•× ×œ×™)', type: 'text'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××—×œ×§×”, ×§×¨×•×Ÿ ×•×›×•\')', type: 'textarea'}
                    ]},
                    paymentStep
                ]
            };
            
            if (editingItem) return steps[modalState.subType || modalState.mainType];
            if (!modalState.mainType) return [steps.start];
            if (modalState.mainType === 'hotel') return steps.hotel;
            if (modalState.mainType === 'transport' && !modalState.subType) return [steps.transport];
            if (modalState.subType === 'flight' && !modalState.flightDataFound) return [steps.flight_search];
            if (modalState.subType) return steps[modalState.subType];
            return [];
        }

        function renderProgressBar() {
            const stepDefinitions = getStepDefinition();
            const totalSteps = stepDefinitions.length;
            if (totalSteps <= 1) return '';

            let html = '<div class="progress-bar">';
            for (let i = 0; i < totalSteps; i++) {
                const isActive = (i + 1) <= modalState.currentStep ? 'active' : '';
                html += `<div class="progress-step ${isActive}">
                            <div class="step-circle">${i + 1}</div>
                            </div>`;
            }
            html += '</div>';
            return html;
        }

        function generateStepContent() {
            const stepDefinitions = getStepDefinition();
            if (!stepDefinitions || stepDefinitions.length === 0) {
                DOM.modalForm.innerHTML = `<p>×©×’×™××”: ×œ× × ××¦××• ×©×œ×‘×™× ×œ×”×’×“×¨×”.</p>`;
                return;
            }

            const currentStepIndex = modalState.currentStep - 1;
            const stepDef = stepDefinitions[currentStepIndex];
            
            if (!stepDef) {
                console.error("Invalid step definition for step:", modalState.currentStep);
                DOM.modalForm.innerHTML = `<p>×©×’×™××”: ×©×œ×‘ ×œ× ×ª×§×™×Ÿ.</p>`;
                return;
            }

            let html = renderProgressBar();
            html += `<div class="modal-step active" data-step="${modalState.currentStep}">
                         <h4 class="text-xl font-bold text-slate-800 mb-6">${stepDef.title}</h4>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-5">`;
            
            stepDef.fields.forEach(field => {
                // Dynamically populate destination options if needed
                if (field.optionsKey === 'tripDestinations') {
                    field.options = (tripData?.destinations || []).map(dest => ({ value: dest.nameHe, label: dest.nameHe }));
                }

                const isFullWidth = ['addressmap', 'textarea', 'routemap', 'flightroute', 'luggage', 'seats', 'flight_search_ui', 'custom_multiselect', 'starrating', 'daterange', 'payment_status'].includes(field.type);
                html += `<div class="${isFullWidth ? 'md:col-span-2' : ''}">${renderField(field)}</div>`;
            });
            html += `</div></div>`;
            DOM.modalForm.innerHTML = html;
        }
        
        function renderAutocompleteAddressInput(id, label) {
            const value = modalState.data[id] || '';
            const isHotelAddress = id === 'address';
            const placeholderText = isHotelAddress ? "×”×§×œ×“ ×©× ××œ×•×Ÿ ××œ× / ×›×ª×•×‘×ª..." : "×”×§×œ×“ ×©× ××§×•× ××• ×›×ª×•×‘×ª...";

            return `
            <div class="relative">
                <label class="block"><span class="text-sm font-semibold text-slate-700">${label}</span>
                    <div class="flex items-center mt-1">
                        <input type="text" id="${id}" value="${value}" class="block w-full p-2 border bg-white rounded-l-md rounded-r-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="${placeholderText}" autocomplete="off">
                        <button type="button" data-action="search-address" data-target-input="${id}" class="p-2 text-white bg-slate-600 hover:bg-slate-700 shrink-0" title="××¦× ×›×ª×•×‘×ª ×‘××¤×”">
                            <i class="fas fa-search"></i>
                        </button>
                        <button type="button" data-action="open-address-picker" data-target-input="${id}" class="p-2 text-slate-500 hover:text-blue-600 shrink-0 border-y border-r rounded-r-md" title="×¤× ×§×¡ ×›×ª×•×‘×•×ª">
                            <i class="fas fa-book-atlas"></i>
                        </button>
                    </div>
                </label>
                 ${isHotelAddress ? `<div class="mt-2 p-2 bg-sky-50 border border-sky-200 rounded-md text-sm text-sky-800 flex items-start gap-2">
                    <i class="fas fa-info-circle mt-1"></i>
                    <span>×”×§×œ×™×“×• ××ª ×©× ×”××œ×•×Ÿ ×”××œ× ×•×œ×—×¦×• ×¢×œ ×›×¤×ª×•×¨ ×”×—×™×¤×•×© <i class="fas fa-search"></i> ×›×“×™ ×œ××ª×¨ ××•×ª×• ××•×˜×•××˜×™×ª ×¢×œ ×”××¤×”.</span>
                </div>` : ''}
                <div id="${id}-suggestions" class="autocomplete-suggestions"></div>
            </div>`;
        }

        function renderField(field) {
            const value = modalState.data[field.id] || field.default || '';
            
            switch(field.type) {
                case 'radio':
                    return `<div class="space-y-2 md:col-span-2">
                                <label class="block text-sm font-semibold text-slate-700">${field.label || ''}</label>
                                <div class="grid grid-cols-2 gap-4">${field.options.map(opt => `
                                    <label class="flex flex-col items-center justify-center gap-2 p-4 border-2 rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-colors hover:border-blue-400">
                                        <input type="radio" id="${field.id}-${opt.value || opt}" name="${field.id}" value="${opt.value || opt}" ${ (opt.value || opt) === value ? 'checked' : ''} class="hidden">
                                        <span class="text-2xl">${opt.label.split(' ')[0]}</span>
                                        <span class="font-bold text-slate-700">${opt.label.split(' ')[1]}</span>
                                    </label>`).join('')}
                                </div></div>`;
                case 'select':
                    const selectOptions = field.options.map(opt => `<option value="${typeof opt === 'object' ? opt.value : opt}" ${value === (typeof opt === 'object' ? opt.value : opt) ? 'selected' : ''}>${typeof opt === 'object' ? opt.label : opt}</option>`).join('');
                    return `<label class="block"><span class="text-sm font-semibold text-slate-700">${field.label}</span>
                                <select id="${field.id}" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    <option value="">-- ×‘×—×¨ --</option>
                                    ${selectOptions}
                                </select>
                            </label>`;
                case 'custom_multiselect':
                    const mealIcons = {'××¨×•×—×ª ×‘×•×§×¨':'fa-coffee','×—×¦×™ ×¤× ×¡×™×•×Ÿ':'fa-plate-wheat','×”×›×œ ×›×œ×•×œ':'fa-utensils','×—×¦×™ ××˜×‘×— ×‘×—×“×¨':'fa-kitchen-set','××˜×‘×— ××œ× ×‘×—×“×¨':'fa-blender'};
                    let optionsHtml = field.options.map(opt => {
                        const isSelected = Array.isArray(value) && value.includes(opt);
                        return `<button type="button" data-value="${opt}" class="meal-option-btn text-sm p-3 rounded-lg border transition-all duration-200 flex items-center gap-2 font-medium ${isSelected ? 'bg-blue-500 text-white border-blue-500 shadow-md' : 'bg-white hover:border-slate-400 hover:shadow-sm'}">
                                    <i class="fas ${mealIcons[opt] || 'fa-check'}"></i>
                                    <span>${opt}</span>
                                </button>`;
                    }).join('');
                    return `<div>
                                <label class="block text-sm font-semibold text-slate-700 mb-2">${field.label}</label>
                                <div class="flex flex-wrap gap-3" id="${field.id}-container">
                                    ${optionsHtml}
                                </div>
                            </div>`;
                case 'starrating':
                    let starsHTML = `<div class="flex items-center gap-1 text-2xl text-slate-300" id="${field.id}-container">`;
                    for(let i = 1; i <= 5; i++) {
                        starsHTML += `<i class="fas fa-star cursor-pointer star-rating-icon" data-value="${i}"></i>`;
                    }
                    starsHTML += `</div><input type="hidden" id="${field.id}" value="${value || 0}">`;
                    return `<div class="flex flex-col"><span class="text-sm font-semibold text-slate-700 mb-1">${field.label}</span>${starsHTML}</div>`;
                case 'textarea':
                    return `<label class="block"><span class="text-sm font-semibold text-slate-700">${field.label}</span>
                                <textarea id="${field.id}" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" rows="3">${modalState.data[field.id] || ''}</textarea>
                            </label>`;
                case 'addressmap':
                    return `<div>
                                ${renderAutocompleteAddressInput(field.id, field.label)}
                                <div id="map-container" class="mt-4 small-map-container map-container"></div>
                            </div>`;
                case 'text_autocomplete':
                    return renderAutocompleteAddressInput(field.id, field.label);
                case 'routemap':
                    return `
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                               ${renderAutocompleteAddressInput('from_address', '×××™×¤×”?')}
                               ${renderAutocompleteAddressInput('to_address', '×œ××™×¤×”?')}
                            </div>
                            <div class="text-center my-4">
                                <button type="button" data-action="calculate-ride-route" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">×—×©×‘ ××¡×œ×•×œ</button>
                            </div>
                            <div class="grid grid-cols-2 gap-4 text-center bg-slate-100 p-2 rounded-lg">
                                <div><p class="text-sm text-slate-500">×–××Ÿ × ×¡×™×¢×”</p><p id="route-duration" class="font-bold text-lg">${formatDuration(modalState.data.route_duration)}</p></div>
                                <div><p class="text-sm text-slate-500">××¨×—×§</p><p id="route-distance" class="font-bold text-lg">${formatDistance(modalState.data.route_distance)}</p></div>
                            </div>
                            <div id="map-ride-route" class="mt-4 final-map-container map-container"></div>`;
                case 'flightroute':
                    return `
                            <div class="space-y-4">
                                ${renderFlightLeg('from', '×××™×¤×”?', modalState.data, '×××™×–×• ×¢×™×¨ ×××¨×™××™×?')}
                                ${renderFlightLeg('to', '×œ××™×¤×”?', modalState.data, '×‘××™×–×• ×¢×™×¨ × ×•×—×ª×™×?')}
                                <div id="connections-container" class="space-y-4">${(modalState.data.connections || []).map((conn, i) => renderFlightLeg(`connection-${i}`, `×§×•× ×§×©×Ÿ ${i+1}`, conn)).join('')}</div>
                                <button type="button" id="add-connection-btn" class="text-sm text-blue-600 hover:underline"><i class="fas fa-plus mr-1"></i>×”×•×¡×£ ×§×•× ×§×©×Ÿ</button>
                                <hr class="my-6"/>
                                <h5 class="text-lg font-bold text-slate-700">××¤×ª ××¡×œ×•×œ ××¡×›××ª</h5>
                                <div class="text-center">
                                    <button type="button" id="calculate-final-route-btn" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">×”×¦×’ ××¡×œ×•×œ ××œ×</button>
                                </div>
                                <div id="map-final-route" class="mt-4 final-map-container map-container"></div>
                            </div>`;
                case 'luggage':
                    return `<fieldset class="border p-4 rounded-lg">
                                <legend class="px-2 font-semibold">×¤×¨×˜×™ ×›×‘×•×“×” (×œ× ×•×¡×¢)</legend>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    <label><span class="text-sm font-semibold text-slate-700">×ª×™×§×™ ×™×“</span><input type="number" id="hand_bag_count" value="${modalState.data.hand_bag_count || 1}" class="mt-1 block w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"></label>
                                    <label><span class="text-sm font-semibold text-slate-700">×˜×¨×•×œ×™ (×›××•×ª)</span><input type="number" id="trolley_count" value="${modalState.data.trolley_count || 1}" class="mt-1 block w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"></label>
                                    <label><span class="text-sm font-semibold text-slate-700">××–×•×•×“×•×ª (×›××•×ª)</span><input type="number" id="checked_bags_count" value="${modalState.data.checked_bags_count || 1}" class="mt-1 block w-full p-2 border rounded-md bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent"></label>
                                </div>
                            </fieldset>`;
                case 'seats':
                    return `<fieldset class="border p-4 rounded-lg">
                                <legend class="px-2 font-semibold">××§×•××•×ª ×™×©×™×‘×”</legend>
                                <div id="seats-container" class="flex flex-wrap gap-2"></div>
                                <button type="button" id="add-seat-btn" class="mt-2 text-sm text-blue-600 hover:underline"><i class="fas fa-plus mr-1"></i>×”×•×¡×£ ××§×•× ×™×©×™×‘×”</button>
                            </fieldset>`;
                case 'daterange':
                    return `<div class="md:col-span-2">
                                <label for="litepicker-input" class="block text-sm font-semibold text-slate-700 mb-1">${field.label}</label>
                                <input readonly type="text" id="litepicker-input" class="w-full p-2 border rounded-md shadow-sm bg-white cursor-pointer text-center focus:ring-2 focus:ring-blue-500" placeholder="×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××¨×™×›×™×">
                                <input type="hidden" id="checkin_date">
                                <input type="hidden" id="checkout_date">
                            </div>`;
                case 'date':
                    const inputDateValue = formatDateToInput(value);
                    return `<label class="block"><span class="text-sm font-semibold text-slate-700">${field.label}</span>
                    <input type="date" id="${field.id}" value="${inputDateValue}" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                </label>`;
                case 'flight_search_ui':
                    const today = new Date();
                    today.setMinutes(today.getMinutes() - today.getTimezoneOffset());
                    const todayString = today.toISOString().slice(0, 10);
                    return `
                            <fieldset class="border p-4 rounded-lg bg-slate-50">
                                <legend class="px-2 font-semibold text-slate-600">×—×™×¤×•×© ××•×˜×•××˜×™</legend>
                                <div class="grid grid-cols-1 md:grid-cols-5 gap-4 items-end">
                                    <div class="md:col-span-2">
                                        <label for="flight_number_search" class="block text-sm font-medium text-slate-700">××¡×¤×¨ ×˜×™×¡×”</label>
                                        <input type="text" id="flight_number_search" class="mt-1 block w-full p-2 border rounded-md uppercase shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="×œ×“×•×’××”: LY2523">
                                    </div>
                                    <div class="md:col-span-2">
                                        <label for="flight_date_search" class="block text-sm font-medium text-slate-700">×ª××¨×™×š</label>
                                        <input type="date" id="flight_date_search" value="${todayString}" class="mt-1 block w-full p-2 border rounded-md shadow-sm focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                                    </div>
                                    <div class="md:col-span-1">
                                        <button type="button" data-action="search-flight-api" class="w-full py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2 shadow-sm">
                                            <i class="fas fa-search"></i> <span class="hidden md:inline">×—×¤×©</span>
                                        </button>
                                    </div>
                                </div>
                            </fieldset>
                            <div class="flex items-center my-6">
                                <hr class="flex-grow border-slate-200">
                                <span class="px-4 text-sm font-semibold text-slate-500">××•</span>
                                <hr class="flex-grow border-slate-200">
                            </div>
                            <div class="text-center">
                                <button type="button" data-action="skip-flight-search" class="py-2 px-8 bg-slate-200 text-slate-700 font-semibold rounded-lg hover:bg-slate-300 transition">
                                    ×”××©×š ×œ××™×œ×•×™ ×™×“× ×™
                                </button>
                            </div>
                            `;
                case 'payment_status':
                    const payment = modalState.data.payment || { status: 'unpaid', amountPaid: 0 };
                    const isPartial = payment.status === 'partial';
                    return `<fieldset class="border p-4 rounded-lg">
                                <legend class="px-2 font-semibold text-slate-700">×¡×˜×˜×•×¡ ×ª×©×œ×•×</legend>
                                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 sm:gap-6">
                                    <div class="flex gap-4">
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="paymentStatus" value="unpaid" ${payment.status === 'unpaid' ? 'checked' : ''} class="payment-status-radio"> <span>×œ× ×©×•×œ×</span></label>
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="paymentStatus" value="paid" ${payment.status === 'paid' ? 'checked' : ''} class="payment-status-radio"> <span>×©×•×œ× ×‘××œ×•××•</span></label>
                                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="paymentStatus" value="partial" ${isPartial ? 'checked' : ''} class="payment-status-radio"> <span>×ª×©×œ×•× ×—×œ×§×™</span></label>
                                    </div>
                                    <div id="amount-paid-wrapper" class="relative ${isPartial ? '' : 'hidden'}">
                                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-500">$</span>
                                        <input type="number" id="amountPaid" value="${payment.amountPaid || ''}" class="p-2 border rounded-md w-32 pr-7" placeholder="×¡×›×•×">
                                    </div>
                                </div>
                            </fieldset>`;
                default: // text, url, number, time, tel
                    return `<label class="block"><span class="text-sm font-semibold text-slate-700">${field.label}</span>
                    <input type="${field.type || 'text'}" id="${field.id}" value="${value}" class="mt-1 block w-full p-2 border rounded-md shadow-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="${field.placeholder || ''}">
                    </label>`;
            }
        }
        
        function renderFlightLeg(id, legend, data = {}, destinationLabel = '×™×¢×“') {
            let legData = {};
            if (id === 'from' || id === 'to') {
                legData = data[id] || {};
            } else if (id.startsWith('connection-')) {
                const index = parseInt(id.split('-')[1], 10);
                legData = data.connections?.[index] || {};
            }

            return `<fieldset class="border p-4 rounded-lg" id="fieldset-${id}">
                <legend class="px-2 font-semibold">${legend}</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label><span class="text-sm font-semibold text-slate-700">${destinationLabel}</span><input type="text" id="${id}_destination" value="${legData.destination || ''}" class="mt-1 block w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: × ×™×• ×™×•×¨×§"></label>
                    <label><span class="text-sm font-semibold text-slate-700">×©× ×©×“×” ×ª×¢×•×¤×”</span><input type="text" id="${id}_airport_name" value="${legData.airport_name || ''}" class="mt-1 block w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: JFK"></label>
                    <div class="md:col-span-2">
                         ${renderAutocompleteAddressInput(`${id}_airport_address`, '×›×ª×•×‘×ª ×©×“×” ×ª×¢×•×¤×”')}
                    </div>
                    <div id="map-${id}" class="mt-2 md:col-span-2 small-map-container map-container"></div>
                </div>
            </fieldset>`;
        }
        
        function placeMarker(mapKey, coords, popupText = '') {
            const map = modalState.maps[mapKey];
            if (!map) return;
            
            clearMapObjects(mapKey, ['markers']);

            const marker = new google.maps.Marker({
                position: coords,
                map: map,
                animation: google.maps.Animation.DROP,
            });

            if (popupText) {
                const infoWindow = new google.maps.InfoWindow({ content: popupText });
                marker.addListener('click', () => infoWindow.open(map, marker));
            }
            
            map.setCenter(coords);
            map.setZoom(13);
            if (!mapMarkers[mapKey]) mapMarkers[mapKey] = [];
            mapMarkers[mapKey].push(marker);
        }

        function initializeFieldPlugins() {
             // Handle paste event
             document.querySelectorAll('#item-form input[type="text"], #item-form input[type="url"], #item-form input[type="tel"], #item-form input[type="number"], #item-form textarea').forEach(input => {
                 if (input.hasPasteListener) return;
                 input.hasPasteListener = true;
                 input.addEventListener('paste', (e) => {
                     e.preventDefault();
                     const text = (e.clipboardData || window.clipboardData).getData('text/plain');
                     e.target.value = text;
                 });
             });

            // Handle destination change to auto-fill dates
            const destinationSelect = document.getElementById('destination');
            if (destinationSelect) {
                destinationSelect.addEventListener('change', (e) => {
                    const selectedDestinationName = e.target.value;
                    const destData = tripData.destinations.find(d => d.nameHe === selectedDestinationName);
                    if (destData && destData.dates) {
                        const [startStr, endStr] = destData.dates.split(' - ');
                        const checkinInput = document.getElementById('checkin_date');
                        const checkoutInput = document.getElementById('checkout_date');

                        if (checkinInput) checkinInput.value = formatDateToInput(startStr);
                        if (checkoutInput) checkoutInput.value = formatDateToInput(endStr);
                        
                        // Also update the litepicker if it exists
                        const picker = document.getElementById('litepicker-input')?.litepickerInstance;
                        if(picker){
                            picker.setDateRange(formatDateToInput(startStr), formatDateToInput(endStr));
                        }
                    }
                });
            }

            // Litepicker initialization for daterange
            const litepickerInput = document.getElementById('litepicker-input');
            if (litepickerInput && typeof Litepicker !== 'undefined') {
                const checkinHidden = document.getElementById('checkin_date');
                const checkoutHidden = document.getElementById('checkout_date');

                if (modalState.data.checkin_date) {
                    checkinHidden.value = formatDateToInput(modalState.data.checkin_date);
                }
                if (modalState.data.checkout_date) {
                    checkoutHidden.value = formatDateToInput(modalState.data.checkout_date);
                }
                
                const picker = new Litepicker({
                    element: litepickerInput,
                    firstDay: 0, // 0 = Sunday
                    singleMode: false,
                    allowRepick: true,
                    lang: 'he-IL',
                    format: 'DD/MM/YYYY',
                    delimiter: ' - ',
                    setup: (picker) => {
                        picker.on('selected', (date1, date2) => {
                            checkinHidden.value = formatLitepickerDateToInput(date1.toJSDate());
                            checkoutHidden.value = formatLitepickerDateToInput(date2.toJSDate());
                        });
                    }
                });
                litepickerInput.litepickerInstance = picker;

                if (checkinHidden.value && checkoutHidden.value) {
                    picker.setDateRange(checkinHidden.value, checkoutHidden.value);
                }
            }
            
            // Payment status logic
            const amountPaidWrapper = document.getElementById('amount-paid-wrapper');
            document.querySelectorAll('.payment-status-radio').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    if (e.target.value === 'partial') {
                        amountPaidWrapper?.classList.remove('hidden');
                    } else {
                        amountPaidWrapper?.classList.add('hidden');
                    }
                });
            });

            // Handle star rating UI
            const starContainer = document.getElementById('stars-container');
            if (starContainer) {
                const starIcons = starContainer.querySelectorAll('.star-rating-icon');
                const hiddenInput = document.getElementById('stars');
                
                const updateStars = (rating) => {
                    starIcons.forEach(star => {
                        star.classList.toggle('text-yellow-400', star.dataset.value <= rating);
                        star.classList.toggle('text-slate-300', star.dataset.value > rating);
                    });
                    hiddenInput.value = rating;
                };

                starIcons.forEach(star => {
                    star.addEventListener('click', () => {
                        const rating = star.dataset.value;
                        updateStars(rating);
                    });
                });

                if (hiddenInput.value > 0) {
                    updateStars(hiddenInput.value);
                }
            }

            // Handle custom meals multi-select
            const mealsContainer = document.getElementById('meals-container');
            if (mealsContainer) {
                if (!modalState.data.meals || !Array.isArray(modalState.data.meals)) {
                    modalState.data.meals = [];
                }
                mealsContainer.addEventListener('click', e => {
                    const button = e.target.closest('.meal-option-btn');
                    if (button) {
                        const value = button.dataset.value;
                        button.classList.toggle('bg-blue-500');
                        button.classList.toggle('text-white');
                        button.classList.toggle('border-blue-500');
                        button.classList.toggle('shadow-md');
                        button.classList.toggle('bg-white');

                        const index = modalState.data.meals.indexOf(value);
                        if (index > -1) {
                            modalState.data.meals.splice(index, 1);
                        } else {
                            modalState.data.meals.push(value);
                        }
                    }
                });
            }


            // Initialize maps and populate with existing data if editing
            if (document.getElementById('map-container')) {
                initMap('map-container', 'hotel');
                if (modalState.data.coords) placeMarker('hotel', modalState.data.coords, modalState.data.address);
            }
            if (document.querySelector('[id^="map-from"]')) {
                initMap('map-from', 'from');
                if (modalState.data.from?.coords) placeMarker('from', modalState.data.from.coords, modalState.data.from.destination);
            }
            if (document.querySelector('[id^="map-to"]')) {
                initMap('map-to', 'to');
                if (modalState.data.to?.coords) placeMarker('to', modalState.data.to.coords, modalState.data.to.destination);
            }
            (modalState.data.connections || []).forEach((conn, i) => {
                const mapId = `map-connection-${i}`;
                const mapKey = `connection-${i}`;
                initMap(mapId, mapKey);
                if (conn.coords) placeMarker(mapKey, conn.coords, conn.destination);
            });
            if (document.querySelector('[id^="map-final-route"]')) {
                initMap('map-final-route', 'final-route');
                showFinalRouteOnMap(); // Draw flight route immediately if data exists
            }
            if (document.getElementById('map-ride-route')) {
                initMap('map-ride-route', 'ride-route');
                if (modalState.data.route_geometry && Array.isArray(modalState.data.route_geometry)) {
                    drawRouteOnMap(modalState.maps['ride-route'], 'ride-route', modalState.data.route_geometry, modalState.data.from_coords, modalState.data.to_coords);
                }
            }
            
            if (document.getElementById('add-seat-btn')) {
                (modalState.data.seats || []).forEach(seat => addSeatInput(seat));
            }

            // Add debounced input listener for autocomplete suggestions
            const debouncedAutocomplete = debounce(handleAddressAutocomplete, 400);
            document.querySelectorAll('input[id*="address"], input[id*="location"], input[id*="station"], input[id*="destination"]').forEach(input => {
                if (input.type === 'text') {
                    input.addEventListener('input', () => debouncedAutocomplete(input));
                }
            });
        }
        
        function updateModalNav() {
            const stepDefinitions = getStepDefinition();
            const totalSteps = stepDefinitions.length;
            const isLastStep = modalState.currentStep >= totalSteps;

            const isFirstStepEver = !modalState.mainType;
            const isSubTypeChoiceStep = modalState.mainType === 'transport' && !modalState.subType;
            const isFlightSearchStep = modalState.subType === 'flight' && !modalState.flightDataFound && !editingItem;
            
            const isAnyChoiceStep = isFirstStepEver || isSubTypeChoiceStep || isFlightSearchStep;

            DOM.modalBackBtn.classList.toggle('hidden', modalState.currentStep === 1 && isAnyChoiceStep);
            DOM.modalFinishBtn.classList.toggle('hidden', !isLastStep || isAnyChoiceStep);
            DOM.modalNextBtn.classList.toggle('hidden', isLastStep);
            
            // On choice steps, always show Next button.
            if (isAnyChoiceStep) {
                 DOM.modalNextBtn.classList.remove('hidden');
                 DOM.modalFinishBtn.classList.add('hidden');
            }
        }

        function collectStepData() {
            const stepDefinitions = getStepDefinition();
            if (!stepDefinitions.length) return false;
            const stepDef = stepDefinitions[modalState.currentStep - 1];
            DOM.modalError.textContent = '';

            stepDef.fields.forEach(field => {
                let value;
                if (field.type === 'radio') {
                    const checked = document.querySelector(`input[name="${field.id}"]:checked`);
                    value = checked ? checked.value : null;
                } else if (field.type === 'custom_multiselect') {
                    // Data is already in modalState.data.meals, so we do nothing here.
                    return;
                } else if (field.type === 'starrating') {
                    const hiddenInput = document.getElementById(field.id);
                    value = hiddenInput ? parseInt(hiddenInput.value, 10) || 0 : 0;
                } else if (field.type === 'payment_status') {
                    const status = document.querySelector('input[name="paymentStatus"]:checked')?.value || 'unpaid';
                    const amountPaid = status === 'partial' ? parseFloat(document.getElementById('amountPaid')?.value) || 0 : 0;
                    modalState.data.payment = { status, amountPaid };
                    return;
                } else if (field.type === 'routemap') {
                    modalState.data.from_address = document.getElementById('from_address').value;
                    modalState.data.to_address = document.getElementById('to_address').value;
                    return; 
                } else if (field.type === 'flightroute') {
                    const collectLegData = (legId, existingData = {}) => ({
                        destination: document.getElementById(`${legId}_destination`)?.value,
                        airport_name: document.getElementById(`${legId}_airport_name`)?.value,
                        airport_address: document.getElementById(`${legId}_airport_address`)?.value,
                        coords: existingData.coords,
                    });
                    
                    modalState.data.from = collectLegData('from', modalState.data.from);
                    modalState.data.to = collectLegData('to', modalState.data.to);
                    modalState.data.connections = (modalState.data.connections || []).map((conn, i) => collectLegData(`connection-${i}`, conn));
                    return;
                } else if (field.type === 'luggage') {
                    modalState.data.hand_bag_count = document.getElementById('hand_bag_count').value;
                    modalState.data.trolley_count = document.getElementById('trolley_count').value;
                    modalState.data.checked_bags_count = document.getElementById('checked_bags_count').value;
                    return;
                } else if (field.type === 'seats') {
                    modalState.data.seats = Array.from(document.querySelectorAll('.seat-input-wrapper input')).map(i => i.value).filter(Boolean);
                    return;
                } else if (field.type === 'flight_search_ui') {
                    return; // This step is handled by button clicks, not by 'next'
                } else if (field.type === 'daterange') {
                    modalState.data.checkin_date = document.getElementById('checkin_date').value;
                    modalState.data.checkout_date = document.getElementById('checkout_date').value;
                    return;
                }
                else {
                    const input = document.getElementById(field.id);
                    if (input) {
                        value = field.type === 'number' ? (input.value ? parseFloat(input.value) : null) : input.value;
                    }
                }
                
                if (field.id) modalState.data[field.id] = value;
            });
            
            // Post-collection processing for dates
            const finalType = modalState.subType || modalState.mainType;
            if (finalType === 'hotel') {
                const checkin = formatDateFromInput(modalState.data.checkin_date);
                const checkout = formatDateFromInput(modalState.data.checkout_date);
                if (checkin && checkout) modalState.data.dates = `${checkin} - ${checkout}`;
            } else if (finalType === 'car_rental') {
                const pickup = formatDateFromInput(modalState.data.pickup_date);
                const ret = formatDateFromInput(modalState.data.return_date);
                if (pickup && ret) modalState.data.dates = `${pickup} - ${ret}`;
            } else if (modalState.data.date && typeof modalState.data.date === 'string' && modalState.data.date.includes('-')) {
                // FIX: Only convert if it's in YYYY-MM-DD format to prevent errors on back/next navigation.
                modalState.data.date = formatDateFromInput(modalState.data.date);
            }

            if (!modalState.mainType) modalState.mainType = modalState.data.mainType;
            if (modalState.mainType === 'transport' && !modalState.subType) modalState.subType = modalState.data.subType;
            
            return true;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!collectStepData()) return;

            const finalData = { ...modalState.data };
            finalData.type = modalState.subType || modalState.mainType;
            
            if (finalData.type === 'ride' && finalData.route_geometry && Array.isArray(finalData.route_geometry)) {
                finalData.route_geometry = JSON.stringify(finalData.route_geometry);
            }
            
            // Clean up temporary date fields before saving
            delete finalData.checkin_date;
            delete finalData.checkout_date;
            delete finalData.pickup_date;
            delete finalData.return_date;
            
            delete finalData.mainType;
            delete finalData.subType;
            
            if (finalData.type === 'flight' && finalData.date) {
                delete finalData.dates;
            }


            const cleanDataForFirebase = (obj) => {
                if (obj === null || obj === undefined) return null;
                if (Array.isArray(obj)) return obj.map(item => cleanDataForFirebase(item));
                if (typeof obj !== 'object' || obj instanceof Date) return obj;

                const newObj = {};
                for (const key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                        const value = obj[key];
                        if (value !== undefined) {
                            newObj[key] = cleanDataForFirebase(value);
                        }
                    }
                }
                return newObj;
            };
            const cleanedData = cleanDataForFirebase(finalData);

            try {
                const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
                if (editingItem && editingItem.id) {
                    await updateDoc(doc(logisticsCollectionRef, editingItem.id), cleanedData);
                } else {
                    cleanedData.createdAt = serverTimestamp();
                    await addDoc(logisticsCollectionRef, cleanedData);
                }
                closeModal();
            } catch (err) {
                console.error("Error saving document:", err);
                DOM.modalError.textContent = '×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×™×˜.';
            }
        }
        
        // --- Map & Geocoding & Routing Logic ---
        function initMap(containerId, mapKey) {
            const mapContainer = document.getElementById(containerId);
            if (!mapContainer) return;
            
            clearMapObjects(mapKey);

            const map = new google.maps.Map(mapContainer, {
                center: { lat: 31.7683, lng: 35.2137 }, // Jerusalem
                zoom: 2,
                mapTypeControl: false,
                streetViewControl: false,
                styles: [
                    { featureType: "poi", stylers: [{ visibility: "off" }] },
                    { featureType: "transit", elementType: "labels.icon", stylers: [{ visibility: "off" }] }
                ]
            });
            modalState.maps[mapKey] = map;
            mapMarkers[mapKey] = [];
            mapPolylines[mapKey] = [];
        }

        function geocodeAddress(address, placeId = null) {
            return new Promise((resolve) => {
                const request = placeId ? { placeId } : { address };
                if (!address && !placeId) {
                    resolve({ success: false, message: '×œ× ×”×•×–× ×” ×›×ª×•×‘×ª.' });
                    return;
                }
                geocoder.geocode(request, (results, status) => {
                    if (status === 'OK' && results[0]) {
                        const location = results[0].geometry.location;
                        resolve({ 
                            success: true, 
                            coords: { lat: location.lat(), lng: location.lng() },
                            formattedAddress: results[0].formatted_address
                        });
                    } else {
                        resolve({ success: false, message: `×”×›×ª×•×‘×ª ×œ× × ××¦××”. (${status})` });
                    }
                });
            });
        }
        
        async function findAddressOnMap(mapKey, address, placeId = null) {
            DOM.modalError.textContent = '××—×¤×©...';
            const result = await geocodeAddress(address, placeId);
            
            if (result.success) {
                DOM.modalError.textContent = '';
                const coords = { lat: result.coords.lat, lng: result.coords.lng };
                placeMarker(mapKey, coords, result.formattedAddress);
                
                const legId = mapKey;
                if (legId === 'from' || legId === 'to') {
                    if (!modalState.data[legId]) modalState.data[legId] = {};
                    modalState.data[legId].coords = coords;
                } else if (legId.startsWith('connection-')) {
                    const index = parseInt(legId.split('-')[1], 10);
                    if (modalState.data.connections && modalState.data.connections[index]) {
                        modalState.data.connections[index].coords = coords;
                    }
                } else { // hotel or ride address
                     modalState.data.coords = coords;
                }
                return result.formattedAddress; // Return the full address
            } else {
                DOM.modalError.textContent = result.message;
                
                const legId = mapKey;
                if (legId === 'from' || legId === 'to') {
                    if (modalState.data[legId]) delete modalState.data[legId].coords;
                } else if (legId.startsWith('connection-')) {
                    const index = parseInt(legId.split('-')[1], 10);
                    if (modalState.data.connections?.[index]) {
                        delete modalState.data.connections[index].coords;
                    }
                } else { // hotel
                   if (modalState.data.coords) delete modalState.data.coords;
                }
                return null;
            }
        }
        
        function fetchRoute(startCoords, endCoords) {
             return new Promise((resolve) => {
                 const request = {
                     origin: startCoords,
                     destination: endCoords,
                     travelMode: 'DRIVING'
                 };
                 directionsService.route(request, (result, status) => {
                     if (status == 'OK') {
                         const route = result.routes[0].legs[0];
                         resolve({
                             success: true,
                             geometry: result.routes[0].overview_path.map(p => ({lat: p.lat(), lng: p.lng()})),
                             duration: route.duration.value, // in seconds
                             distance: route.distance.value, // in meters
                         });
                     } else {
                         resolve({ success: false, message: `×œ× × ××¦× ××¡×œ×•×œ. (${status})` });
                     }
                 });
             });
        }
        
        function drawRouteOnMap(map, mapKey, geometry, startCoords, endCoords) {
            clearMapObjects(mapKey);

            if (startCoords) {
                const startMarker = new google.maps.Marker({ position: startCoords, map: map, label: 'A' });
                mapMarkers[mapKey].push(startMarker);
            }
            if (endCoords) {
                const endMarker = new google.maps.Marker({ position: endCoords, map: map, label: 'B' });
                mapMarkers[mapKey].push(endMarker);
            }
            
            const routePath = new google.maps.Polyline({
                path: geometry,
                geodesic: true,
                strokeColor: '#3b82f6',
                strokeOpacity: 1.0,
                strokeWeight: 5
            });

            routePath.setMap(map);
            mapPolylines[mapKey].push(routePath);
            
            const bounds = new google.maps.LatLngBounds();
            geometry.forEach(point => bounds.extend(point));
            map.fitBounds(bounds);
        }

        function showFinalRouteOnMap() {
            const finalMap = modalState.maps['final-route'];
            if (!finalMap) return;
            
            collectStepData(); 
            clearMapObjects('final-route');

            const allLegs = [modalState.data.from, ...(modalState.data.connections || []), modalState.data.to];
            const points = allLegs.filter(leg => leg && leg.coords).map(leg => leg.coords);
            
            if (points.length > 0) {
                const bounds = new google.maps.LatLngBounds();
                points.forEach((point, index) => {
                    bounds.extend(point);
                    const marker = new google.maps.Marker({
                        position: point,
                        map: finalMap,
                        label: String.fromCharCode(65 + index) // A, B, C...
                    });
                    mapMarkers['final-route'].push(marker);
                });

                finalMap.fitBounds(bounds);

                if (points.length > 1) {
                    const flightPath = new google.maps.Polyline({
                        path: points,
                        geodesic: true,
                        strokeColor: '#3b82f6',
                        strokeOpacity: 0,
                        strokeWeight: 2,
                        icons: [{
                            icon: {
                                path: 'M 0,-1 0,1',
                                strokeOpacity: 1,
                                scale: 4
                            },
                            offset: '0',
                            repeat: '20px'
                        }]
                    });
                    flightPath.setMap(finalMap);
                    mapPolylines['final-route'].push(flightPath);
                }
            }
        }

        function clearMapObjects(mapKey, types = ['markers', 'polylines', 'directions']) {
            if (types.includes('markers') && mapMarkers[mapKey]) {
                mapMarkers[mapKey].forEach(marker => marker.setMap(null));
                mapMarkers[mapKey] = [];
            }
            if (types.includes('polylines') && mapPolylines[mapKey]) {
                mapPolylines[mapKey].forEach(line => line.setMap(null));
                mapPolylines[mapKey] = [];
            }
            if (types.includes('directions')) {
                if (directionsRenderer) directionsRenderer.setMap(null);
                if (detailsDirectionsRenderer) detailsDirectionsRenderer.setMap(null);
            }
        }

        function clearAllMapObjects() {
            Object.keys(modalState.maps).forEach(key => clearMapObjects(key));
            if(detailsDirectionsRenderer) detailsDirectionsRenderer.setMap(null);
        }
        
        async function preSearchHotelAddress(hotelName) {
            if (!hotelName) return;
            const result = await geocodeAddress(hotelName);
            if (result.success) {
                modalState.data.address = result.formattedAddress;
                modalState.data.coords = result.coords;
            } else {
                // Clear any previous data if search fails, but don't show error yet
                delete modalState.data.address;
                delete modalState.data.coords;
            }
        }


        // --- Dynamic Form Elements ---
        function addConnection() {
            if (!modalState.data.connections) modalState.data.connections = [];
            const index = modalState.data.connections.length;
            modalState.data.connections.push({});
            
            const container = document.getElementById('connections-container');
            const legHtml = renderFlightLeg(`connection-${index}`, `×§×•× ×§×©×Ÿ ${index + 1}`);
            const div = document.createElement('div');
            div.innerHTML = legHtml;
            container.appendChild(div.firstChild);
            
            initMap(`map-connection-${index}`, `connection-${index}`);
            // Re-attach listeners for the new inputs
            initializeFieldPlugins();
        }

        function addSeatInput(value = '') {
            const container = document.getElementById('seats-container');
            if (!container) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'seat-input-wrapper flex items-center gap-2';
            wrapper.innerHTML = `
                <input type="text" class="p-2 border rounded-md w-24 focus:ring-2 focus:ring-blue-500 focus:border-transparent" placeholder="×œ×“×•×’××”: A40" value="${value}">
                <button type="button" class="remove-seat-btn text-red-500 hover:text-red-700 text-xl font-bold">Ã—</button>
            `;
            wrapper.querySelector('.remove-seat-btn').addEventListener('click', () => wrapper.remove());
            container.appendChild(wrapper);
        }
        
        // --- Delete/Details Modals ---
        function handleDelete(id, name) {
            // UPDATE: Prevent background from scrolling when modal is open
            document.body.classList.add('overflow-hidden');
            
            itemToDelete = { id, name };
            DOM.deleteModalTitle.textContent = `×”×× ×œ××—×•×§ ××ª "${name}"?`;
            
            DOM.deleteModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.deleteModal.classList.remove('opacity-0');
                DOM.deleteModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        async function confirmDeletion() {
            if (!itemToDelete) return;
            try {
                await deleteDoc(doc(db, "trips", tripId, "logistics", itemToDelete.id));
            } catch (error) {
                console.error("Failed to delete item:", error);
            } finally {
                closeDeleteModal();
            }
        }

        function closeDeleteModal() {
            // UPDATE: Restore background scrolling when modal is closed
            document.body.classList.remove('overflow-hidden');

            DOM.deleteModal.classList.add('opacity-0');
            DOM.deleteModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                DOM.deleteModal.classList.add('hidden');
                itemToDelete = null;
            }, 300);
        }
        
        // --- Address Picker Modal ---
        function getKnownAddresses() {
            const addresses = new Map();
            const addAddress = (name, address) => {
                if (address && !addresses.has(address)) {
                    addresses.set(address, name);
                }
            };

            allItems.forEach(item => {
                switch (item.type) {
                    case 'hotel':
                        if (item.address) addAddress(`ğŸ¨ ${item.name}`, item.address);
                        break;
                    case 'flight':
                        if (item.from?.airport_address) addAddress(`âœˆï¸ ${item.from.airport_name || item.from.destination}`, item.from.airport_address);
                        if (item.to?.airport_address) addAddress(`âœˆï¸ ${item.to.airport_name || item.to.destination}`, item.to.airport_address);
                        (item.connections || []).forEach(c => {
                           if (c.airport_address) addAddress(`âœˆï¸ ${c.airport_name || c.destination}`, c.airport_address);
                        });
                        break;
                    case 'ferry':
                        if (item.from_destination) addAddress(`ğŸš¢ ××¢×‘×•×¨×ª ×-${item.from_destination}`, item.from_destination);
                        if (item.to_destination) addAddress(`ğŸš¢ ××¢×‘×•×¨×ª ××œ-${item.to_destination}`, item.to_destination);
                        break;
                    case 'train':
                        if (item.from_station) addAddress(`ğŸš† ×¨×›×‘×ª ×-${item.from_station}`, item.from_station);
                        if (item.to_station) addAddress(`ğŸš† ×¨×›×‘×ª ××œ-${item.to_station}`, item.to_station);
                        break;
                }
            });
            return Array.from(addresses, ([address, name]) => ({ name, address }));
        }

        function openAddressPicker(targetInputId) {
            // UPDATE: Prevent background from scrolling when modal is open
            document.body.classList.add('overflow-hidden');
            
            currentAddressPickerTarget = targetInputId;
            const knownAddresses = getKnownAddresses();
            DOM.addressPickerContent.innerHTML = '';
            
            if (knownAddresses.length === 0) {
                DOM.addressPickerContent.innerHTML = '<p class="text-slate-500 text-center">×œ× × ××¦××• ×›×ª×•×‘×•×ª ×©××•×¨×•×ª ×‘×˜×™×•×œ.</p>';
            } else {
                const list = document.createElement('ul');
                list.className = 'space-y-2';
                knownAddresses.forEach(({ name, address }) => {
                    const li = document.createElement('li');
                    li.className = 'p-3 hover:bg-slate-100 rounded-md cursor-pointer border';
                    li.dataset.address = address;
                    li.innerHTML = `<p class="font-semibold text-slate-700">${name}</p><p class="text-sm text-slate-500">${address}</p>`;
                    list.appendChild(li);
                });
                DOM.addressPickerContent.appendChild(list);
            }

            DOM.addressPickerModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.addressPickerModal.classList.remove('opacity-0');
                DOM.addressPickerModalContent.classList.remove('scale-95', 'opacity-0');
            }, 10);
        }

        function closeAddressPicker() {
            // UPDATE: Restore background scrolling when modal is closed
            document.body.classList.remove('overflow-hidden');

            DOM.addressPickerModal.classList.add('opacity-0');
            DOM.addressPickerModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                DOM.addressPickerModal.classList.add('hidden');
                currentAddressPickerTarget = null;
            }, 300);
        }

        // --- Event Listeners ---
        document.getElementById('open-add-modal-btn').addEventListener('click', () => openModal());
        DOM.modalCloseBtn.addEventListener('click', closeModal);
        DOM.modalForm.addEventListener('submit', handleFormSubmit);
        
        DOM.modalNextBtn.addEventListener('click', () => {
            const isFlightSearchStep = modalState.subType === 'flight' && !modalState.flightDataFound && !editingItem;
            if (isFlightSearchStep) {
                modalState.flightDataFound = true;
                modalState.currentStep = 1;
                generateStepContent();
                updateModalNav();
                setTimeout(() => {
                    initializeFieldPlugins();
                    Object.values(modalState.maps).forEach(m => {
                        if (m) google.maps.event.trigger(m, 'resize');
                    });
                }, 100);
                return;
            }
            
            const wasChoiceStep = !modalState.mainType || (modalState.mainType === 'transport' && !modalState.subType);
            const wasHotelNameStep = modalState.mainType === 'hotel' && modalState.currentStep === 1;

            if (collectStepData()) {
                if(wasHotelNameStep && !editingItem) {
                    preSearchHotelAddress(modalState.data.name);
                }

                modalState.currentStep = wasChoiceStep ? 1 : modalState.currentStep + 1;
                generateStepContent();
                updateModalNav();
                setTimeout(() => {
                    initializeFieldPlugins();
                    Object.values(modalState.maps).forEach(m => {
                        if (m) google.maps.event.trigger(m, 'resize');
                    });
                }, 100);
            }
        });

        DOM.modalBackBtn.addEventListener('click', () => {
            collectStepData();
            if (modalState.currentStep === 1) {
                if (modalState.subType === 'flight' && modalState.flightDataFound) { modalState.flightDataFound = false; }
                else if (modalState.subType) { modalState.subType = null; modalState.data.subType = null; } 
                else if (modalState.mainType) { modalState.mainType = null; modalState.data.mainType = null; }
            } else {
                modalState.currentStep--;
            }
            generateStepContent();
            updateModalNav();
            setTimeout(() => {
                initializeFieldPlugins();
                Object.values(modalState.maps).forEach(m => {
                    if (m) google.maps.event.trigger(m, 'resize');
                });
            }, 100);
        });
        
        async function searchFlightWithWorker(num, date) {
             const url = `${FLIGHT_API_BASE}/flights/number/${encodeURIComponent(num)}/${encodeURIComponent(date)}`;
             try {
               const r = await fetch(url);
               if(!r.ok){
                   let j; 
                   try { j=await r.json() } catch{};
                   throw new Error(j?.error||"×©×’×™××” ×‘×—×™×¤×•×© ×”×˜×™×¡×”");
               }
               const flights = await r.json();
               return { success: true, flights };
             } catch(err) {
                 return { success: false, message: err.message };
             }
        }

        DOM.modalForm.addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const { action, legId, targetInput } = target.dataset;

            const handleSearch = async (searchFunction, button) => {
                const originalText = button.innerHTML;
                button.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                button.disabled = true;
                try {
                    await searchFunction();
                } finally {
                    button.innerHTML = originalText;
                    button.disabled = false;
                }
            };
            
            if (action === 'open-address-picker') {
                openAddressPicker(targetInput);
            } else if (action === 'search-address') {
                const inputElement = document.getElementById(target.dataset.targetInput);
                if (inputElement) {
                   await handleSearch(() => findPlaceAndFill(inputElement), target);
                }
            } else if (action === 'find-flight-leg') {
                const address = document.getElementById(`${legId}_airport_address`).value;
                await handleSearch(() => findAddressOnMap(legId, address), target);
            } else if(action === 'calculate-ride-route') {
                await handleSearch(async () => {
                    const fromAddress = document.getElementById('from_address').value;
                    const toAddress = document.getElementById('to_address').value;
                    modalState.data.from_address = fromAddress;
                    modalState.data.to_address = toAddress;

                    DOM.modalError.textContent = '××—×©×‘ ××¡×œ×•×œ...';
                    const [fromResult, toResult] = await Promise.all([geocodeAddress(fromAddress), geocodeAddress(toAddress)]);

                    if (!fromResult.success || !toResult.success) {
                        DOM.modalError.textContent = fromResult.message || toResult.message || '×œ× × ×™×ª×Ÿ ×œ××¦×•× ××ª ×”×›×ª×•×‘×•×ª.';
                        return;
                    }

                    modalState.data.from_coords = fromResult.coords;
                    modalState.data.to_coords = toResult.coords;
                    
                    const routeResult = await fetchRoute(fromResult.coords, toResult.coords);
                    if (routeResult.success) {
                        DOM.modalError.textContent = '';
                        modalState.data.route_geometry = routeResult.geometry;
                        modalState.data.route_duration = routeResult.duration;
                        modalState.data.route_distance = routeResult.distance;
                        document.getElementById('route-duration').textContent = formatDuration(routeResult.duration);
                        document.getElementById('route-distance').textContent = formatDistance(routeResult.distance);

                        const map = modalState.maps['ride-route'];
                        if (map) {
                           drawRouteOnMap(map, 'ride-route', routeResult.geometry, fromResult.coords, toResult.coords);
                        }

                    } else {
                        DOM.modalError.textContent = routeResult.message;
                    }
                }, target);
            } else if (action === 'search-flight-api') {
                 await handleSearch(async () => {
                    DOM.modalError.textContent = '';
                    const num = document.getElementById('flight_number_search').value.trim().toUpperCase();
                    const date = document.getElementById('flight_date_search').value;
                    if (!num || !date) {
                        DOM.modalError.textContent = '× × ×œ××œ× ××¡×¤×¨ ×˜×™×¡×” ×•×ª××¨×™×š.';
                        return;
                    }
                    const result = await searchFlightWithWorker(num, date);
                    if (result.success && result.flights.length > 0) {
                        const flight = result.flights[0]; // Take the first result
                        // Populate modalState.data
                        modalState.data.airline = flight.airline?.name;
                        modalState.data.flight_number = flight.number;
                        
                        const departureTimeLocal = flight.departure?.scheduledTime?.local;
                        if (departureTimeLocal) {
                            modalState.data.date = formatDateFromInput(formatApiDateToInput(departureTimeLocal));
                        } else {
                            modalState.data.date = formatDateFromInput(date); // Fallback
                        }
                        
                        modalState.data.departure_time = formatApiTimeToInput(flight.departure?.scheduledTime?.local);
                        modalState.data.arrival_time = formatApiTimeToInput(flight.arrival?.scheduledTime?.local);
                        
                          modalState.data.from = {
                              destination: flight.departure?.airport?.name,
                              airport_name: flight.departure?.airport?.name,
                              airport_address: flight.departure?.airport?.name, 
                          };
                          modalState.data.to = {
                              destination: flight.arrival?.airport?.name,
                              airport_name: flight.arrival?.airport?.name,
                              airport_address: flight.arrival?.airport?.name, 
                          };

                        modalState.flightDataFound = true;
                        modalState.currentStep = 1; // Start the flight form from step 1
                        generateStepContent();
                        updateModalNav();
                        
                        setTimeout(async () => {
                             initializeFieldPlugins();
                             
                             const geocodeAirport = (mapKey, airportName) => {
                                 return new Promise(resolve => {
                                     if (!airportName) return resolve();
                                     const request = { query: airportName, fields: ['place_id'] };
                                     placesService.findPlaceFromQuery(request, async (results, status) => {
                                         if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
                                             const placeId = results[0].place_id;
                                             await findAddressOnMap(mapKey, null, placeId);
                                         }
                                         resolve();
                                     });
                                 });
                             };
                             
                             await Promise.all([
                                 geocodeAirport('from', flight.departure?.airport?.name),
                                 geocodeAirport('to', flight.arrival?.airport?.name)
                             ]);

                             showFinalRouteOnMap();
                        }, 100);

                    } else {
                        DOM.modalError.textContent = result.message || '×œ× × ××¦××” ×˜×™×¡×” ×ª×•×××ª.';
                    }
                }, target);
            } else if (action === 'skip-flight-search') {
                modalState.flightDataFound = true;
                modalState.currentStep = 1; // Start flight form from step 1
                generateStepContent();
                updateModalNav();
                 setTimeout(() => {
                     initializeFieldPlugins();
                     Object.values(modalState.maps).forEach(m => {
                         if (m) google.maps.event.trigger(m, 'resize');
                    });
                 }, 100);
            } else if (target.id === 'add-connection-btn') {
                addConnection();
            } else if (target.id === 'calculate-final-route-btn') {
                showFinalRouteOnMap();
            } else if (target.id === 'add-seat-btn') {
                addSeatInput();
            }
        });

        document.addEventListener('click', e => {
            const isAutocomplete = e.target.closest('.autocomplete-suggestion') || e.target.closest('[data-action="search-address"]');
            if (!isAutocomplete) {
                document.querySelectorAll('.autocomplete-suggestions').forEach(s => s.innerHTML = '');
            }
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                e.stopPropagation();
                const item = allItems.find(i => i.id === editBtn.dataset.id);
                if (item) openModal(item);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                e.stopPropagation();
                handleDelete(deleteBtn.dataset.id, deleteBtn.dataset.name);
                return;
            }

            const card = e.target.closest('[data-action="view-details"]');
            if (card) {
              const item = allItems.find(i => i.id === card.dataset.id);
              if (item) openDetailsModal(item);
            }
        });

        // --- Autocomplete and Search Logic ---
        async function handlePlaceSelection(prediction, inputElement) {
            if (!prediction || !inputElement) return;
        
            // Immediately update input to give user feedback, geocode in background
            inputElement.value = prediction.description;
            const suggestionsContainer = document.getElementById(`${inputElement.id}-suggestions`);
            if (suggestionsContainer) suggestionsContainer.innerHTML = '';
        
            const geocodeResult = await geocodeAddress(null, prediction.place_id);
            if (geocodeResult.success) {
                inputElement.value = geocodeResult.formattedAddress;
            } else {
                // If geocoding fails, stick with the description
                inputElement.value = prediction.description;
            }
        
            const inputId = inputElement.id;
            let mapKey = null;
        
            // Determine which map to update and which data to store
            if (inputId === 'address') { // Hotel
                mapKey = 'hotel';
                if (geocodeResult.success) modalState.data.coords = geocodeResult.coords;
            } else if (inputId.includes('_airport_address')) { // Flight
                mapKey = inputId.replace('_airport_address', '');
            } else if (inputId === 'from_address') { // Ride start
                if (geocodeResult.success) modalState.data.from_coords = geocodeResult.coords;
            } else if (inputId === 'to_address') { // Ride end
                if (geocodeResult.success) modalState.data.to_coords = geocodeResult.coords;
            }
        
            if (mapKey && geocodeResult.success) {
                await findAddressOnMap(mapKey, geocodeResult.formattedAddress, prediction.place_id);
            }
        
            // Auto-fill related fields specifically for flights from the prediction data
            const isFlight = inputId.includes('_airport_address');
            if (isFlight) {
                const baseId = inputId.replace('_airport_address', '');
                const nameInput = document.getElementById(`${baseId}_airport_name`);
                const destinationInput = document.getElementById(`${baseId}_destination`);
                if (nameInput) nameInput.value = prediction.structured_formatting.main_text;
                if (destinationInput) destinationInput.value = prediction.structured_formatting.main_text;
                setTimeout(showFinalRouteOnMap, 100);
            }
        }


        // Function for the search button click. Finds a specific place.
        async function findPlaceAndFill(inputElement) {
            const query = inputElement.value;
            if (query.length < 3) {
                DOM.modalError.textContent = '× × ×œ×”×–×™×Ÿ ×œ×¤×—×•×ª 3 ×ª×•×•×™× ×œ×—×™×¤×•×©.';
                return;
            }
            DOM.modalError.textContent = '';
            
            const request = {
                query: query,
                fields: ['place_id', 'name', 'formatted_address'],
            };
            
            let mapKey;
            const inputId = inputElement.id;
            if (inputId === 'address') {
                mapKey = 'hotel';
            } else if (inputId.includes('airport_address')) {
                mapKey = inputId.replace('_airport_address', '');
            } else if (inputId === 'from_address' || inputId === 'to_address') {
                mapKey = 'ride-route'; // Just a temporary key, map is handled by 'calculate'
            } else {
                 mapKey = inputId;
            }

            placesService.findPlaceFromQuery(request, async (results, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && results && results[0]) {
                    const place = results[0];
                    const formattedAddress = await findAddressOnMap(mapKey, place.formatted_address, place.place_id);
                    if (formattedAddress) {
                        inputElement.value = formattedAddress; // Update input with full, correct address
                    }
                    if (modalState.subType === 'flight') {
                       setTimeout(showFinalRouteOnMap, 100);
                    }
                } else {
                    DOM.modalError.textContent = '×”××§×•× ×œ× × ××¦×. × ×¡×” × ×™×¡×•×— ××—×¨.';
                }
            });
        }

        // Function for live autocomplete suggestions (now debounced)
        async function handleAddressAutocomplete(input) {
            const suggestionsContainer = document.getElementById(`${input.id}-suggestions`);
            if (!suggestionsContainer) return;

            const query = input.value;
            if (query.length < 3) {
                suggestionsContainer.innerHTML = '';
                return;
            }

            autocompleteService.getPlacePredictions({ input: query, types: ['geocode', 'establishment'] }, (predictions, status) => {
                if (status === google.maps.places.PlacesServiceStatus.OK && predictions) {
                    displayAutocompleteSuggestions(predictions, input, suggestionsContainer);
                } else {
                    suggestionsContainer.innerHTML = '';
                }
            });
        }
        
        function displayAutocompleteSuggestions(predictions, input, suggestionsContainer) {
            suggestionsContainer.innerHTML = '';
            predictions.forEach(prediction => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'autocomplete-suggestion';
                const isAirport = prediction.types.includes('airport');
                suggestionDiv.innerHTML = `<i class="fas ${isAirport ? 'fa-plane-departure' : 'fa-map-marker-alt'} fa-fw text-slate-400 mr-2"></i> ${prediction.description}`;
                
                suggestionDiv.addEventListener('click', () => {
                    handlePlaceSelection(prediction, input);
                });
                suggestionsContainer.appendChild(suggestionDiv);
            });
        }

// --- Sidebar Activation (Updated) ---
        const toggleSidebar = () => {
            const isClosed = DOM.sidebar.classList.contains('translate-x-full');
            if (isClosed) { // ×¤×ª×™×—×”
                DOM.sidebar.classList.remove('translate-x-full');
                DOM.overlay.classList.remove('hidden');
                requestAnimationFrame(() => DOM.overlay.classList.remove('opacity-0'));
                document.body.classList.add('modal-locked');
            } else { // ×¡×’×™×¨×”
                DOM.sidebar.classList.add('translate-x-full');
                DOM.overlay.classList.add('opacity-0');
                setTimeout(() => {
                    DOM.overlay.classList.add('hidden');
                    document.body.classList.remove('modal-locked');
                }, 300);
            }
        };
        // (×”×××–×™× ×™× × ×©××¨×™× ××•×ª×• ×“×‘×¨ ×›×™ ×”-ID ×œ× ×”×©×ª× ×”)
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);
        
        // --- Address Picker Listeners ---
        DOM.addressPickerCloseBtn.addEventListener('click', closeAddressPicker);
        DOM.addressPickerContent.addEventListener('click', (e) => {
            const targetLi = e.target.closest('li[data-address]');
            if (targetLi && currentAddressPickerTarget) {
                const address = targetLi.dataset.address;
                const input = document.getElementById(currentAddressPickerTarget);
                if (input) {
                    input.value = address;
                }
                closeAddressPicker();
            }
        });
        
        // --- Details Modal ---
        function openDetailsModal(item) {
            // UPDATE: Prevent background from scrolling when modal is open
            document.body.classList.add('overflow-hidden');

            let contentHtml = `
                <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl sticky top-0 z-10">
                    <h3 id="details-modal-title" class="text-xl md:text-2xl font-bold text-slate-800 line-clamp-1">×¤×¨×˜×™ ×¤×¨×™×˜</h3>
                    <button id="details-modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-4 sm:p-6 space-y-6">`;

            switch(item.type) {
                case 'hotel': contentHtml += generateHotelDetailsHTML(item); break;
                case 'ride': contentHtml += generateRideDetailsHTML(item); break;
                case 'flight': contentHtml += generateFlightDetailsHTML(item); break;
                case 'car_rental': contentHtml += generateCarRentalDetailsHTML(item); break;
                case 'ferry': contentHtml += generateFerryDetailsHTML(item); break;
                case 'train': contentHtml += generateTrainDetailsHTML(item); break;
                default: contentHtml += `<p>××™×Ÿ ×ª×¦×•×’×” ××¤×•×¨×˜×ª ×¢×‘×•×¨ ×¡×•×’ ×¤×¨×™×˜ ×–×”.</p>`;
            }
            
            contentHtml += `</div>`; // Close scrollable container
            DOM.detailsModalContent.innerHTML = contentHtml;

            DOM.detailsModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.detailsModal.classList.remove('opacity-0');
                DOM.detailsModalContent.classList.remove('scale-95', 'opacity-0');
                initDetailsMap(item);
                initDetailsPaymentControls(item.id); // Add listeners for payment controls
            }, 10);

            document.getElementById('details-modal-close-btn').addEventListener('click', closeDetailsModal);
      // Add listener for copy address buttons
Â  Â  Â  Â  Â  Â  DOM.detailsModalContent.querySelectorAll('.copy-address-btn').forEach(button => {
Â  Â  Â  Â  Â  Â  Â  Â  button.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const address = button.dataset.address;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  navigator.clipboard.writeText(address).then(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification('×”×›×ª×•×‘×ª ×”×•×¢×ª×§×”!', 'success', 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).catch(err => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error('Failed to copy: ', err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showNotification('×”×”×¢×ª×§×” × ×›×©×œ×”', 'error', 2000);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
        
          }

        function closeDetailsModal() {
            // UPDATE: Restore background scrolling when modal is closed
            document.body.classList.remove('overflow-hidden');
            
            DOM.detailsModal.classList.add('opacity-0');
            DOM.detailsModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
                DOM.detailsModal.classList.add('hidden');
                clearMapObjects('details', ['directions']);
            }, 300);
        }

        // --- Details HTML Generators (Redesigned) ---
        function createDetailItem(icon, label, value, extraClasses = '') {
            if (!value || value === '-') return '';
            return `<div class="bg-slate-50 p-3 rounded-lg ${extraClasses}">
                        <div class="text-xs text-slate-500 font-semibold flex items-center gap-2 mb-1"><i class="fas ${icon} fa-fw"></i> ${label}</div>
                        <div class="text-slate-800 font-bold text-base break-words">${value}</div>
                    </div>`;
        }
        
        
        function createAddressDetailItem(icon, label, address) {
Â  Â  Â  Â  Â  Â  if (!address) return '';

Â  Â  Â  Â  Â  Â  // Use Google Maps universal URL
Â  Â  Â  Â  Â  Â  const navigateUrl = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}`;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-slate-50 p-3 rounded-lg sm:col-span-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs text-slate-500 font-semibold flex items-center gap-2 mb-1"><i class="fas ${icon} fa-fw"></i> ${label}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-800 font-bold text-base break-words mb-2">${address}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="copy-address-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded-md hover:bg-blue-200" data-address="${address}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-copy mr-1"></i>×”×¢×ª×§ ×›×ª×•×‘×ª
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${navigateUrl}" target="_blank" class="text-xs bg-green-100 text-green-700 px-2 py-1 rounded-md hover:bg-green-200 inline-flex items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-diamond-turn-right mr-1"></i>× ×•×•×˜
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  A </div>`;
Â  Â  Â  Â  }

        function generateHotelDetailsHTML(item) {
             let starsHtml = '';
             if (item.stars && item.stars > 0) {
                 for (let i = 0; i < 5; i++) {
                     starsHtml += `<i class="fas fa-star ${i < item.stars ? 'text-yellow-400' : 'text-slate-300'}"></i>`;
                 }
             }
             let mealsHtml = (item.meals && Array.isArray(item.meals) && item.meals.length > 0) ? item.meals.join(', ') : '-';
             
             return `
                 <h4 class="text-2xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-hotel text-blue-500"></i> ${item.name}</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                     ${createDetailItem('fa-map-pin', '×™×¢×“', item.destination)}
                     ${createDetailItem('fa-calendar-days', '×ª××¨×™×›×™×', item.dates)}
                     ${createDetailItem('fa-bookmark', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                     ${createDetailItem('fa-dollar-sign', '××—×™×¨', `$${(item.price || 0).toLocaleString()}`)}
                     ${createDetailItem('fa-utensils', '××¨×•×—×•×ª', mealsHtml)}
                     ${createDetailItem('fa-star', '×“×™×¨×•×’ ×›×•×›×‘×™×', starsHtml)}
                     ${createDetailItem('fa-thumbs-up', '×“×™×¨×•×’ ×‘×•×§×™× ×’', item.booking_rating)}
                     ${createDetailItem('fa-location-dot', '×›×ª×•×‘×ª', item.address, 'sm:col-span-2')}
                 </div>
                 ${generatePaymentDetailsHTML(item)}
                 ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                 <div class="grid grid-cols-2 gap-4 mt-4">
                     <a href="${item.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                     <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition ${item.address ? '' : 'opacity-50 cursor-not-allowed'}">× ×™×•×•×˜ <i class="fa-solid fa-diamond-turn-right text-xs"></i></a>
                 </div>
                 ${item.coords ? '<div id="details-map" class="details-map-container map-container mt-4"></div>' : ''}
               `;
        }
        
        function generateRideDetailsHTML(item) {
            const title = `×”×¡×¢×”: ${item.from_address?.split(',')[0] || ''} â†’ ${item.to_address?.split(',')[0] || ''}`;
            let route_geometry = item.route_geometry;
            if(typeof route_geometry === 'string') {
                 try { route_geometry = JSON.parse(route_geometry); } catch(e) { route_geometry = null; }
            }

            return `
                 <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-taxi text-sky-500"></i> ${title}</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                     ${createDetailItem('fa-arrow-up', '×××™×¤×”', item.from_address, 'sm:col-span-2')}
                     ${createDetailItem('fa-arrow-down', '×œ××™×¤×”', item.to_address, 'sm:col-span-2')}
                     ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                     ${createDetailItem('fa-clock', '×©×¢×ª ××™×¡×•×£', item.pickup_time)}
                     ${createDetailItem('fa-building', '×—×‘×¨×”', item.company)}
                     ${createDetailItem('fa-bookmark', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                     ${createDetailItem('fa-user-tie', '×©× × ×”×’', item.driver_name)}
                     ${createDetailItem('fa-phone', '×˜×œ×¤×•×Ÿ × ×”×’', item.driver_phone ? `<a href="tel:${item.driver_phone}" class="text-blue-600 hover:underline">${item.driver_phone}</a>` : '-')}
                     ${createDetailItem('fa-car', '×¤×¨×˜×™ ×¨×›×‘', `${item.vehicle_details || ''} (${item.vehicle_number || ''})`)}
                     ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                     ${createDetailItem('fa-dollar-sign', '××—×™×¨', `$${((item.price_per_person || 0) * (item.travelers || 1)).toLocaleString()}`)}
                 </div>
                 ${generatePaymentDetailsHTML(item)}
                 ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                 <div class="grid grid-cols-1 gap-4 mt-4">
                     <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                 </div>
                 ${route_geometry ? '<div id="details-map" class="details-map-container map-container mt-4"></div>' : ''}
                 `;
        }

        function generateFlightDetailsHTML(item) {
Â  Â  Â  Â  Â  Â  const title = `×˜×™×¡×”: ${item.from?.destination || ''} â†’ ${item.to?.destination || ''}`;
Â  Â  Â  Â  Â  Â  const travelers = item.travelers || (item.seats?.length || 1);
Â  Â  Â  Â  Â  Â  const totalPrice = (item.price_per_person || 0) * travelers;
Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-plane-departure text-sky-500"></i> ${title}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createAddressDetailItem('fa-plane-departure', `×××¨×™××™× ×: ${item.from?.airport_name || item.from?.destination || ''}`, item.from?.airport_address)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createAddressDetailItem('fa-plane-arrival', `× ×•×—×ª×™× ×‘: ${item.to?.airport_name || item.to?.destination || ''}`, item.to?.airport_address)}

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-plane', '×—×‘×¨×ª ×ª×¢×•×¤×”', `${item.airline || '-'} #${item.flight_number || ''}`)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date || item.dates)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-clock', '×©×¢×ª ×”××¨××”', item.departure_time)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-clock', '×©×¢×ª × ×—×™×ª×”', item.arrival_time)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-users', '× ×•×¡×¢×™×', travelers)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-tag', '××—×™×¨ ×œ× ×•×¡×¢', `$${(item.price_per_person || 0).toLocaleString()}`)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `<span class="font-bold text-green-700 text-base">$${totalPrice.toLocaleString()}</span>`,'bg-green-50 sm:col-span-2')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${createDetailItem('fa-chair', '××§×•××•×ª', (item.seats || []).join(', ') || '-', 'sm:col-span-2')}
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â ${generatePaymentDetailsHTML(item)}
Â  Â  Â  Â  Â  Â  Â  Â  Â ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â ${(item.from?.coords || item.to?.coords) ? '<div id="details-map" class="details-map-container map-container mt-4"></div>' : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  }

        function generateCarRentalDetailsHTML(item) {
            return `
                 <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-car text-green-500"></i> ×¨×›×‘ ×©×›×•×¨: ${item.destination || ''}</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                     ${createDetailItem('fa-location-dot', '××™×§×•× ××™×¡×•×£', item.pickup_location, 'sm:col-span-2')}
                     ${createDetailItem('fa-calendar-days', '×ª××¨×™×›×™×', item.dates)}
                     ${createDetailItem('fa-clock', '×©×¢×•×ª', `${item.pickup_time || '?'} - ${item.return_time || '?'}`)}
                     ${createDetailItem('fa-car-side', '×¡×•×’ ×¨×›×‘', item.car_type)}
                     ${createDetailItem('fa-bookmark', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                     ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                     ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `$${(item.price || 0). toLocaleString()}`)}
                 </div>
                 ${generatePaymentDetailsHTML(item)}
                 ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                 <div class="grid grid-cols-1 gap-4 mt-4">
                     <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                 </div>
                 `;
        }
        
        function generateFerryDetailsHTML(item) {
             const title = `××¢×‘×•×¨×ª: ${item.from_destination || ''} â†’ ${item.to_destination || ''}`;
             const totalPrice = (item.price_per_person || 0) * (item.travelers || 1);
             return `
                 <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-ship text-indigo-500"></i> ${title}</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                     ${createDetailItem('fa-building', '×—×‘×¨×”', item.company)}
                     ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                     ${createDetailItem('fa-clock', '×©×¢×ª ×™×¦×™××”', item.departure_time)}
                     ${createDetailItem('fa-clock', '×©×¢×ª ×”×’×¢×”', item.arrival_time)}
                     ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                     ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `$${totalPrice.toLocaleString()}`)}
                 </div>
                 ${generatePaymentDetailsHTML(item)}
                 ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                 <div class="grid grid-cols-1 gap-4 mt-4">
                     <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                 </div>
                 `;
        }
        
        function generateTrainDetailsHTML(item) {
             const title = `×¨×›×‘×ª: ${item.from_station || ''} â†’ ${item.to_station || ''}`;
             const totalPrice = (item.price_per_person || 0) * (item.travelers || 1);
             return `
                 <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-train text-orange-500"></i> ${title}</h4>
                 <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                     ${createDetailItem('fa-building', '×—×‘×¨×”', item.company)}
                     ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                     ${createDetailItem('fa-clock', '×©×¢×ª ×™×¦×™××”', item.departure_time)}
                     ${createDetailItem('fa-clock', '×©×¢×ª ×”×’×¢×”', item.arrival_time)}
                     ${createDetailItem('fa-chair', '××•×©×‘×™×', item.seat_info)}
                     ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                     ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `$${totalPrice.toLocaleString()}`, 'sm:col-span-2')}
                 </div>
                 ${generatePaymentDetailsHTML(item)}
                 ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                 <div class="grid grid-cols-1 gap-4 mt-4">
                     <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                 </div>
                 `;
        }

        function initDetailsMap(item) {
            const mapContainer = document.getElementById('details-map');
            if (!mapContainer) return;

            const map = new google.maps.Map(mapContainer, {
                center: { lat: 31.7683, lng: 35.2137 },
                zoom: 2,
                mapTypeControl: false,
                streetViewControl: false,
            });
            
            const bounds = new google.maps.LatLngBounds();

            if (item.type === 'hotel' && item.coords) {
                const marker = new google.maps.Marker({ position: item.coords, map: map });
                map.setCenter(item.coords);
                map.setZoom(13);
            } else if (item.type === 'ride' && item.from_coords && item.to_coords) {
                if (detailsDirectionsRenderer) detailsDirectionsRenderer.setMap(null);
                detailsDirectionsRenderer = new google.maps.DirectionsRenderer({ suppressMarkers: true });
                detailsDirectionsRenderer.setMap(map);
                
                const request = { origin: item.from_coords, destination: item.to_coords, travelMode: 'DRIVING' };
                directionsService.route(request, (result, status) => {
                    if (status == 'OK') {
                        detailsDirectionsRenderer.setDirections(result);
                        new google.maps.Marker({ position: item.from_coords, map: map, label: 'A'});
                        new google.maps.Marker({ position: item.to_coords, map: map, label: 'B'});
                    }
                });
            } else if (item.type === 'flight') {
                const allLegs = [item.from, ...(item.connections || []), item.to];
                const points = allLegs.filter(leg => leg && leg.coords).map(leg => leg.coords);
                
                if (points.length > 0) {
                    points.forEach((point, index) => {
                        bounds.extend(point);
                        new google.maps.Marker({ position: point, map: map, label: String.fromCharCode(65 + index) });
                    });
                    
                    if (points.length > 1) {
                         new google.maps.Polyline({
                             path: points, geodesic: true, strokeColor: '#3b82f6', strokeWeight: 2, map: map
                        });
                    }
                    map.fitBounds(bounds);
                }
            }
        }

        // --- Summary Table & Helpers ---
        function formatDuration(seconds) {
            if (!seconds) return '-';
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            return `${h > 0 ? h + '×© ' : ''}${m}×“`;
        }

        function formatDistance(meters) {
            if (!meters) return '-';
            return `${(meters / 1000).toFixed(1)} ×§"×`;
        }

        function renderSummaryTables() {
            const categories = {
                hotel: { label: 'ğŸ¨ ××œ×•× ×•×ª', total: 0 },
                flight: { label: 'âœˆï¸ ×˜×™×¡×•×ª', total: 0 },
                car_rental: { label: 'ğŸš— ×¨×›×‘×™×', total: 0 },
                ride: { label: 'ğŸš• ×”×¡×¢×•×ª', total: 0 },
                ferry: { label: 'ğŸš¢ ××¢×‘×•×¨×•×ª', total: 0 },
                train: { label: 'ğŸš† ×¨×›×‘×•×ª', total: 0 },
            };

            let grandTotal = 0;
            let totalPaid = 0;

            allItems.forEach(item => {
                const itemPrice = getItemPrice(item);
                if (categories[item.type]) {
                    categories[item.type].total += itemPrice;
                }
                grandTotal += itemPrice;

                const payment = item.payment || { status: 'unpaid' };
                if (payment.status === 'paid') {
                    totalPaid += itemPrice;
                } else if (payment.status === 'partial') {
                    totalPaid += payment.amountPaid || 0;
                }
            });

            DOM.logisticsSummaryBody.innerHTML = '';
            for (const key in categories) {
                const category = categories[key];
                if (category.total > 0 || allItems.some(item => item.type === key)) {
                    DOM.logisticsSummaryBody.innerHTML += `
                        <tr class="hover:bg-slate-50">
                            <td class="p-3">${category.label}</td>
                            <td class="p-3 font-mono text-left">$${category.total.toLocaleString()}</td>
                        </tr>`;
                }
            }
             DOM.logisticsSummaryBody.innerHTML += `
                <tr class="font-bold bg-slate-100 text-slate-800">
                    <td class="p-3 rounded-br-lg">×¡×”"×›</td>
                    <td class="p-3 font-mono text-left rounded-bl-lg">$${grandTotal.toLocaleString()}</td>
                </tr>`;

            const remaining = grandTotal - totalPaid;
            DOM.grandTotalContainer.innerHTML = `
                <p class="text-4xl font-bold drop-shadow-sm font-mono">$${grandTotal.toLocaleString()}</p>
                <p class="text-slate-200 mt-1">×¢×œ×•×ª ×›×•×œ×œ×ª</p>
                <div class="mt-4 text-sm grid grid-cols-2 gap-2 w-full max-w-xs mx-auto">
                    <div class="bg-white/20 p-2 rounded-lg">
                        <div class="font-bold text-lg">$${totalPaid.toLocaleString()}</div>
                        <div class="opacity-80">×©×•×œ×</div>
                    </div>
                     <div class="bg-white/20 p-2 rounded-lg">
                        <div class="font-bold text-lg">$${remaining.toLocaleString()}</div>
                        <div class="opacity-80">×™×ª×¨×”</div>
                    </div>
                </div>
            `;
        }

        // --- Payment Logic ---
        function getItemPrice(item) {
            if (item.type === 'hotel' || item.type === 'car_rental') {
                return item.price || 0;
            }
            return (item.price_per_person || 0) * (item.travelers || 1);
        }
        
        function generatePaymentDetailsHTML(item) {
            const payment = item.payment || { status: 'unpaid', amountPaid: 0 };
            const isPartial = payment.status === 'partial';
            const totalCost = getItemPrice(item);

            return `
            <div data-item-id="${item.id}" id="details-payment-section" class="p-4 bg-slate-100 rounded-lg mt-4">
                <h5 class="font-bold mb-2 text-slate-700">×¡×˜×˜×•×¡ ×ª×©×œ×•×</h5>
                <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4 sm:gap-6">
                    <div>
                        <select id="details-payment-status" class="p-2 border rounded-md bg-white">
                            <option value="unpaid" ${payment.status === 'unpaid' ? 'selected' : ''}>×œ× ×©×•×œ×</option>
                            <option value="paid" ${payment.status === 'paid' ? 'selected' : ''}>×©×•×œ× ×‘××œ×•××•</option>
                            <option value="partial" ${isPartial ? 'selected' : ''}>×ª×©×œ×•× ×—×œ×§×™</option>
                        </select>
                    </div>
                    <div id="details-amount-paid-wrapper" class="relative ${isPartial ? '' : 'hidden'}">
                        <span class="absolute inset-y-0 right-0 flex items-center pr-3 text-slate-500">$</span>
                        <input type="number" id="details-amount-paid" value="${payment.amountPaid || ''}" class="p-2 border rounded-md w-32 pr-7" placeholder="×¡×›×•×">
                        <span class="mr-2 text-slate-500">/ $${totalCost.toLocaleString()}</span>
                    </div>
                </div>
            </div>`;
        }
        
        function initDetailsPaymentControls(itemId) {
            const statusSelect = document.getElementById('details-payment-status');
            const amountWrapper = document.getElementById('details-amount-paid-wrapper');
            const amountInput = document.getElementById('details-amount-paid');

            const handleUpdate = debounce(async () => {
                const newStatus = statusSelect.value;
                const newAmount = newStatus === 'partial' ? parseFloat(amountInput.value) || 0 : 0;
                
                const itemRef = doc(db, "trips", tripId, "logistics", itemId);
                try {
                    await updateDoc(itemRef, {
                        payment: {
                            status: newStatus,
                            amountPaid: newAmount
                        }
                    });
                    showNotification('×¡×˜×˜×•×¡ ×”×ª×©×œ×•× ×¢×•×“×›×Ÿ', 'success', 2000);
                } catch (err) {
                    console.error("Error updating payment status:", err);
                    showNotification('×©×’×™××” ×‘×¢×“×›×•×Ÿ ×”×ª×©×œ×•×');
                }

            }, 700);

            if (statusSelect) {
                statusSelect.addEventListener('change', () => {
                    amountWrapper.classList.toggle('hidden', statusSelect.value !== 'partial');
                    handleUpdate();
                });
            }
            if (amountInput) {
                amountInput.addEventListener('input', handleUpdate);
            }
        }

        // --- Start the page ---
        initPage();
    </script>
</body>
</html>
