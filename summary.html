<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”</title>
Â  Â Â 
Â  Â  Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
Â  Â Â 
Â  Â  Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
Â  Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
Â  Â  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

Â  Â  Â  Â  <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>

Â  Â  <style>
Â  Â  Â  Â  body { font-family: 'Assistant', sans-serif; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Sidebar Styles */
Â  Â  Â  Â  #sidebar { transition: transform 0.3s ease-in-out; }
Â  Â  Â  Â  .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
Â  Â  Â  Â  .submenu.open { max-height: 1200px; }
Â  Â  Â  Â  .chevron-icon { transition: transform 0.3s ease-out; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Modal Styles */
Â  Â  Â  Â  .modal { transition: opacity 0.3s ease; }
Â  Â  Â  Â  .modal-content { transition: transform 0.3s ease; }
Â  Â  Â  Â  .modal-step { display: none; animation: fadeIn 0.5s; }
Â  Â  Â  Â  .modal-step.active { display: block; }
Â  Â  Â  Â  @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Map Styles */
Â  Â  Â  Â  .leaflet-container { width: 100%; border-radius: 0.5rem; border: 1px solid #e2e8f0; z-index: 10; }
Â  Â  Â  Â  .small-map-container { height: 200px; }
Â  Â  Â  Â  .final-map-container { height: 300px; }
Â  Â  Â  Â  .litepicker { z-index: 100 !important; }

Â  Â  Â  Â  /* Loading Overlay */
Â  Â  Â  Â  #loading-overlay { transition: opacity 0.5s ease-in-out; }
Â  Â  </style>
</head>
<body class="bg-slate-100">

Â  Â  Â  Â  <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
Â  Â  Â  Â  <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
Â  Â  Â  Â  <p class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ × ×ª×•× ×™×, × × ×œ×”××ª×™×Ÿ...</p>
Â  Â  </div>

Â  Â  Â  Â  <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/MjekTyd.jpeg');"></div>
Â  Â  <div class="fixed inset-0 z-0 bg-black/50"></div>

Â  Â  Â  Â  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
Â  Â  Â  Â  <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
Â  Â  Â  Â  Â  Â  <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <nav id="main-menu" class="p-4 space-y-2"></nav>
Â  Â  </aside>
Â  Â  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

Â  Â  Â  Â  <div class="relative z-10">
Â  Â  Â  Â  Â  Â  Â  Â  <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-40 shadow-sm">
Â  Â  Â  Â  Â  Â  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between h-16">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ"><i class="fas fa-arrow-left fa-lg"></i></a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 id="page-title" class="text-xl font-bold text-slate-800">× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="auth-container" class="flex items-center"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <main class="p-4 sm:p-6 lg:p-8">
Â  Â  Â  Â  Â  Â  <div class="max-w-7xl mx-auto space-y-12">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">×”×œ×•×’×™×¡×˜×™×§×” ×©×œ ×”×˜×™×•×œ</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="mt-4 text-xl text-slate-200 max-w-2xl mx-auto">×›×œ ×”××œ×•× ×•×ª, ×”×˜×™×¡×•×ª, ×”×¨×›×‘×™×, ×”×¨×›×‘×•×ª ×•×”××¢×‘×•×¨×•×ª ×‘××§×•× ××—×“.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="open-add-modal-btn" class="mt-8 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-plus mr-2"></i>×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×•×’×™×¡×˜×™
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <section id="hotel-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ¨ ×¡×™×›×•× ×”××œ×•× ×•×ª ×©×œ× ×•</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="hotel-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <section id="transport-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">âœˆï¸ ×¡×™×›×•× ×”××¢×‘×¨×™× ×©×œ× ×•</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="transport-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <section id="cost-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ“Š ×¡×™×›×•××™ ×¢×œ×•×™×•×ª</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-xl text-slate-700 mb-4">ğŸ§¾ ×¡×™×›×•× ×œ×•×’×™×¡×˜×™×§×”</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-x-auto">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm text-right">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="bg-slate-50"><tr><th class="p-3 font-semibold">×§×˜×’×•×¨×™×”</th><th class="p-3 font-semibold text-left">×¢×œ×•×ª ($)</th></tr></thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="logistics-summary-tbody" class="divide-y divide-slate-200"></tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex flex-col justify-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-xl text-slate-700 mb-4">ğŸ’° ×”×©×•×¨×” ×”×ª×—×ª×•× ×”</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="grand-total-container" class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  <div id="item-modal" class="modal fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4 opacity-0">
Â  Â  Â  Â  <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95">
Â  Â  Â  Â  Â  Â  <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
Â  Â  Â  Â  Â  Â  Â  Â  <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©</h3>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <form id="item-form" class="flex-grow overflow-y-auto p-6 space-y-6"></form>
Â  Â  Â  Â  Â  Â  <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="modal-back-btn" class="py-2 px-5 rounded-lg hover:bg-slate-200 transition hidden font-semibold">××—×•×¨×”</button>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="modal-error-message" class="text-red-500 text-sm font-bold h-5 flex-grow text-center"></div>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="modal-next-btn" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button type="submit" form="item-form" id="modal-finish-btn" class="py-2 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition hidden">×©××•×¨ ×¤×¨×™×˜</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  <div id="delete-confirm-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center opacity-0">
Â  Â  Â  Â  Â <div class="modal-content bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-95">
Â  Â  Â  Â  Â  Â  <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
Â  Â  Â  Â  Â  Â  <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§?</h3>
Â  Â  Â  Â  Â  Â  <div class="flex justify-center gap-4 mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  Â  Â  <div id="details-modal" class="modal fixed inset-0 bg-black/60 z-[75] hidden items-center justify-center p-4 opacity-0">
Â  Â  Â  Â  <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>


Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
Â  Â  Â  Â  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
Â  Â  Â  Â  import { getFirestore, collection, doc, getDoc, addDoc, query, onSnapshot, serverTimestamp, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

Â  Â  Â  Â  // --- Firebase Configuration (Same as trip page) ---
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
Â  Â  Â  Â  Â  Â  authDomain: "tiool-loz.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "tiool-loz",
Â  Â  Â  Â  Â  Â  storageBucket: "tiool-loz.appspot.com",
Â  Â  Â  Â  Â  Â  messagingSenderId: "226069823505",
Â  Â  Â  Â  Â  Â  appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
Â  Â  Â  Â  };
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- App Initialization ---
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const db = getFirestore(app);

Â  Â  Â  Â  // --- Global State & Constants ---
Â  Â  Â  Â  let tripId = null;
Â  Â  Â  Â  let tripData = null;
Â  Â  Â  Â  let currentUser = null;
Â  Â  Â  Â  let allItems = [];
Â  Â  Â  Â  let editingItem = null;Â 
Â  Â  Â  Â  let itemToDelete = null;
Â  Â  Â  Â  let logisticsUnsubscribe = null; // To detach the listener
Â  Â  Â  Â  let modalState = {
Â  Â  Â  Â  Â  Â  mainType: null, subType: null, currentStep: 1, data: {},
Â  Â  Â  Â  Â  Â  maps: {}, mapMarkers: {}, datePicker: null,
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  const DOM = {
Â  Â  Â  Â  Â  Â  loadingOverlay: document.getElementById('loading-overlay'),
Â  Â  Â  Â  Â  Â  pageTitle: document.getElementById('page-title'),
Â  Â  Â  Â  Â  Â  backToTripBtn: document.getElementById('back-to-trip-btn'),
Â  Â  Â  Â  Â  Â  authContainer: document.getElementById('auth-container'),
Â  Â  Â  Â  Â  Â  sidebar: document.getElementById('sidebar'),
Â  Â  Â  Â  Â  Â  hamburgerBtn: document.getElementById('hamburger-btn'),
Â  Â  Â  Â  Â  Â  closeSidebarBtn: document.getElementById('close-sidebar-btn'),
Â  Â  Â  Â  Â  Â  overlay: document.getElementById('overlay'),
Â  Â  Â  Â  Â  Â  mainMenu: document.getElementById('main-menu'),
Â  Â  Â  Â  Â  Â  hotelContainer: document.getElementById('hotel-cards-container'),
Â  Â  Â  Â  Â  Â  transportContainer: document.getElementById('transport-cards-container'),
Â  Â  Â  Â  Â  Â  modal: document.getElementById('item-modal'),
Â  Â  Â  Â  Â  Â  modalTitle: document.getElementById('modal-title'),
Â  Â  Â  Â  Â  Â  modalForm: document.getElementById('item-form'),
Â  Â  Â  Â  Â  Â  modalNextBtn: document.getElementById('modal-next-btn'),
Â  Â  Â  Â  Â  Â  modalBackBtn: document.getElementById('modal-back-btn'),
Â  Â  Â  Â  Â  Â  modalFinishBtn: document.getElementById('modal-finish-btn'),
Â  Â  Â  Â  Â  Â  modalError: document.getElementById('modal-error-message'),
Â  Â  Â  Â  Â  Â  modalCloseBtn: document.getElementById('modal-close-btn'),
Â  Â  Â  Â  Â  Â  deleteModal: document.getElementById('delete-confirm-modal'),
Â  Â  Â  Â  Â  Â  deleteModalTitle: document.getElementById('delete-modal-title'),
Â  Â  Â  Â  Â  Â  deleteConfirmBtn: document.getElementById('delete-modal-confirm'),
Â  Â  Â  Â  Â  Â  deleteCancelBtn: document.getElementById('delete-modal-cancel'),
Â  Â  Â  Â  Â  Â  detailsModal: document.getElementById('details-modal'),
Â  Â  Â  Â  Â  Â  logisticsSummaryBody: document.getElementById('logistics-summary-tbody'),
Â  Â  Â  Â  Â  Â  grandTotalContainer: document.getElementById('grand-total-container'),
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- Page Initialization ---
Â  Â  Â  Â  function initPage() {
Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  tripId = urlParams.get('tripId');
Â  Â  Â  Â  Â  Â  if (!tripId) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("×©×’×™××”: ×œ× × ××¦× ××–×”×” ×˜×™×•×œ.");
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'index.html';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (user) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadPageData();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupAuthUI(user);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'login.html';
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  async function loadPageData() {
Â  Â  Â  Â  Â  Â  if (logisticsUnsubscribe) logisticsUnsubscribe(); // Detach previous listener if exists

Â  Â  Â  Â  Â  Â  const tripRef = doc(db, "trips", tripId);
Â  Â  Â  Â  Â  Â  const tripSnap = await getDoc(tripRef);

Â  Â  Â  Â  Â  Â  if (!tripSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  alert("×”×˜×™×•×œ ×œ× × ××¦×.");
Â  Â  Â  Â  Â  Â  Â  Â  window.location.href = 'index.html';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const tripDataFromSnap = tripSnap.data();

Â  Â  Â  Â  Â  Â  // ×‘×“×™×§×” ×—×“×©×”: ×”×× ×”××©×ª××© ×”× ×•×›×—×™ ×›×œ×•×œ ×‘××¢×¨×š ×”×¢×•×¨×›×™× (editors)
Â  Â  Â  Â  Â  Â  const canAccess = tripDataFromSnap.editors && tripDataFromSnap.editors.includes(currentUser.uid);

Â  Â  Â  Â  Â  Â  if (!canAccess) {
Â  Â  Â  Â  Â  Â  Â  Â  // ×× ××™×Ÿ ×”×¨×©××”, ×”×¢×‘×¨ ×œ×“×£ ×”×‘×™×ª
Â  Â  Â  Â  Â  Â  Â  Â  alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××ª ×”×œ×•"×–.');
Â  Â  Â  Â  Â  Â  Â  Â  location.href = 'index.html';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // ×× ×™×© ×”×¨×©××”, ×”××¢×¨×›×ª ×××©×™×›×” ×›×¨×’×™×œ
Â  Â  Â  Â  Â  Â  tripData = tripDataFromSnap;
Â  Â  Â  Â  Â  Â  document.title = `×œ×•×’×™×¡×˜×™×§×” - ${tripData.name}`;
Â  Â  Â  Â  Â  Â  DOM.pageTitle.textContent = `×œ×•×’×™×¡×˜×™×§×” - ${tripData.name}`;
Â  Â  Â  Â  Â  Â  buildSidebarMenu();

Â  Â  Â  Â  Â  Â  // Now, listen for logistics data in the subcollection
Â  Â  Â  Â  Â  Â  const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
Â  Â  Â  Â  Â  Â  const q = query(logisticsCollectionRef);

Â  Â  Â  Â  Â  Â  logisticsUnsubscribe = onSnapshot(q, (snapshot) => {
Â  Â  Â  Â  Â  Â  Â  Â  allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  renderApp();
Â  Â  Â  Â  Â  Â  Â  Â  DOM.loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  }, (error) => {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Snapshot error:", error);
Â  Â  Â  Â  Â  Â  Â  Â  alert("×©×’×™××” ×‘×˜×¢×™× ×ª × ×ª×•× ×™ ×”×œ×•×’×™×¡×˜×™×§×”.");
Â  Â  Â  Â  Â  Â  Â  Â  DOM.loadingOverlay.style.display = 'none';
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- UI Population ---
Â  Â  Â  Â  function renderApp() {
Â  Â  Â  Â  Â  Â  const hotels = allItems.filter(item => item.type === 'hotel');
Â  Â  Â  Â  Â  Â  const transports = allItems.filter(item => ['flight', 'car_rental', 'ferry', 'train'].includes(item.type));
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderCards(DOM.hotelContainer, hotels, createHotelCard);
Â  Â  Â  Â  Â  Â  renderCards(DOM.transportContainer, transports, createTransportCard);
Â  Â  Â  Â  Â  Â  renderSummaryTables();
Â  Â  Â  Â  }

Â  Â  Â  Â  function setupAuthUI(user) {
Â  Â  Â  Â  Â  Â  const userDocRef = doc(db, "users", user.uid);
Â  Â  Â  Â  Â  Â  getDoc(userDocRef).then(docSnap => {
Â  Â  Â  Â  Â  Â  Â  Â  const name = docSnap.exists() ? docSnap.data().name : '××©×ª××©';
Â  Â  Â  Â  Â  Â  Â  Â  DOM.authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${name} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function buildSidebarMenu() {
Â  Â  Â  Â  Â  Â  DOM.mainMenu.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (!tripData || !tripData.destinations) return;

Â  Â  Â  Â  Â  Â  tripData.destinations.forEach(dest => {
Â  Â  Â  Â  Â  Â  Â  Â  const destinationDiv = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  const button = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
Â  Â  Â  Â  Â  Â  Â  Â  button.innerHTML = `<span>${dest.nameHe}</span> <i class="fas fa-chevron-down chevron-icon"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const submenu = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const dates = generateDatesFromRange(dest.dates);
Â  Â  Â  Â  Â  Â  Â  Â  dates.forEach(dateStr => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayLink = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayLink.href = `daily-schedule.html?tripId=${tripId}&date=${dateStr}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayLink.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md transition-colors';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  dayLink.textContent = `×œ×•"×– ×œ×™×•× ${dateStr}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenu.appendChild(dayLink);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  button.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenu.classList.toggle('open');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  button.querySelector('i').classList.toggle('rotate-180');
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  destinationDiv.appendChild(button);
Â  Â  Â  Â  Â  Â  Â  Â  destinationDiv.appendChild(submenu);
Â  Â  Â  Â  Â  Â  Â  Â  DOM.mainMenu.appendChild(destinationDiv);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function generateDatesFromRange(rangeStr) {
Â  Â  Â  Â  Â  Â  if (!rangeStr || !rangeStr.includes(' - ')) return [];
Â  Â  Â  Â  Â  Â  const [startStr, endStr] = rangeStr.split(' - ');
Â  Â  Â  Â  Â  Â  const [startDay, startMonth, startYear] = startStr.split('/').map(Number);
Â  Â  Â  Â  Â  Â  const [endDay, endMonth, endYear] = endStr.split('/').map(Number);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const startDate = new Date(startYear, startMonth - 1, startDay);
Â  Â  Â  Â  Â  Â  const endDate = new Date(endYear, endMonth - 1, endDay);
Â  Â  Â  Â  Â  Â  const dates = [];
Â  Â  Â  Â  Â  Â  let currentDate = new Date(startDate);

Â  Â  Â  Â  Â  Â  while (currentDate <= endDate) {
Â  Â  Â  Â  Â  Â  Â  Â  dates.push(currentDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit', year: 'numeric'}));
Â  Â  Â  Â  Â  Â  Â  Â  currentDate.setDate(currentDate.getDate() + 1);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  return dates;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Card Creation ---
Â  Â  Â  Â  function renderCards(container, items, cardCreator) {
Â  Â  Â  Â  Â  Â  container.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (items.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  container.innerHTML = `<div class="text-center bg-white/20 p-8 rounded-xl col-span-full"><p class="text-white text-lg">×¢×“×™×™×Ÿ ×œ× × ×•×¡×¤×• ×¤×¨×™×˜×™× ×‘×§×˜×’×•×¨×™×” ×–×•.</p></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  items.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  const card = cardCreator(item);
Â  Â  Â  Â  Â  Â  Â  Â  container.appendChild(card);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function createHotelCard(item) {
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.className = "bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex flex-col";
Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex-grow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h4 class="font-bold text-lg text-slate-800">${item.name}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="edit-btn text-slate-400 hover:text-blue-500" data-id="${item.id}"><i class="fas fa-pencil"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="delete-btn text-slate-400 hover:text-red-500" data-id="${item.id}" data-name="${item.name}"><i class="fas fa-trash"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-slate-500 mb-3">${item.destination} | ${item.dates}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="space-y-2 text-slate-600 text-sm mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="flex items-center gap-2"><i class="fa-solid fa-tag fa-fw text-blue-500"></i> <strong>××—×™×¨:</strong> $${item.price ? item.price.toLocaleString() : '×œ× ×¦×•×™×Ÿ'}</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <li class="flex items-center gap-2"><i class="fa-solid fa-building-user fa-fw text-slate-500"></i> <strong>×”×•×–××Ÿ ×“×¨×š:</strong> ${item.booked_via}</li>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.additional_details ? `<div class="mt-2 p-3 bg-slate-100 rounded-lg text-sm text-slate-700"><p class="font-bold mb-1">×¤×¨×˜×™× × ×•×¡×¤×™×:</p><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-4 pt-4 border-t grid grid-cols-2 gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${item.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.link ? '' : 'opacity-50 cursor-not-allowed'}">×œ××ª×¨ <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition ${item.address ? '' : 'opacity-50 cursor-not-allowed'}">× ×•×•×˜ <i class="fa-solid fa-diamond-turn-right text-xs"></i></a>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  return card;
Â  Â  Â  Â  }

Â  Â  Â  Â  function createTransportCard(item) {
Â  Â  Â  Â  Â  Â  const card = document.createElement('div');
Â  Â  Â  Â  Â  Â  card.className = "bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex flex-col cursor-pointer hover:shadow-xl transition-shadow";
Â  Â  Â  Â  Â  Â  card.dataset.id = item.id;
Â  Â  Â  Â  Â  Â  card.dataset.action = 'view-details';

Â  Â  Â  Â  Â  Â  let title, icon, details;
Â  Â  Â  Â  Â  Â  switch (item.type) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'flight':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = `×˜×™×¡×”: ${item.from?.destination || ''} â† ${item.to?.destination || ''}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon = 'fa-plane-departure';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = `<p class="text-sm text-slate-500">${item.airline}</p><p class="text-sm text-slate-600 font-semibold">${item.dates || ''}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'car_rental':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = `×¨×›×‘ ×©×›×•×¨: ${item.destination}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon = 'fa-car';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = `<p class="text-sm text-slate-500">${item.booked_via}</p><p class="text-sm text-slate-600 font-semibold">$${(item.price || 0).toLocaleString()}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'ferry':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = `××¢×‘×•×¨×ª: ${item.from_destination} â† ${item.to_destination}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon = 'fa-ship';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = `<p class="text-sm text-slate-500">${item.company}</p><p class="text-sm text-slate-600 font-semibold">${item.date || ''}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  case 'train':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = `×¨×›×‘×ª: ${item.from_station} â† ${item.to_station}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon = 'fa-train';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = `<p class="text-sm text-slate-500">${item.company}</p><p class="text-sm text-slate-600 font-semibold">${item.date || ''}</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title = "××¢×‘×¨ ×œ× ×™×“×•×¢";
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  icon = 'fa-question-circle';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details = '';
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-start">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas ${icon} fa-2x text-sky-500"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-lg text-slate-800">${title}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${details}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="edit-btn text-slate-400 hover:text-blue-500" data-id="${item.id}"><i class="fas fa-pencil"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <button class="delete-btn text-slate-400 hover:text-red-500" data-id="${item.id}" data-name="${title}"><i class="fas fa-trash"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  return card;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Modal Logic ---
Â  Â  Â  Â Â 
Â  Â  Â  Â  function resetModalState() {
Â  Â  Â  Â  Â  Â  Object.values(modalState.maps).forEach(map => map.remove());
Â  Â  Â  Â  Â  Â  if (modalState.datePicker) modalState.datePicker.destroy();
Â  Â  Â  Â  Â  Â  modalState = {
Â  Â  Â  Â  Â  Â  Â  Â  mainType: null, subType: null, currentStep: 1, data: {},
Â  Â  Â  Â  Â  Â  Â  Â  maps: {}, mapMarkers: {}, datePicker: null,
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  editingItem = null;
Â  Â  Â  Â  }

Â  Â  Â  Â  function openModal(itemToEdit = null) {
Â  Â  Â  Â  Â  Â  resetModalState();
Â  Â  Â  Â  Â  Â  if (itemToEdit) {
Â  Â  Â  Â  Â  Â  Â  Â  editingItem = { id: itemToEdit.id };
Â  Â  Â  Â  Â  Â  Â  Â  modalState.mainType = (itemToEdit.type === 'hotel') ? 'hotel' : 'transport';
Â  Â  Â  Â  Â  Â  Â  Â  modalState.subType = ['flight', 'car_rental', 'ferry', 'train'].includes(itemToEdit.type) ? itemToEdit.type : null;
Â  Â  Â  Â  Â  Â  Â  Â  modalState.data = JSON.parse(JSON.stringify(itemToEdit)); // Deep copy
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalTitle.textContent = '×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  generateStepContent();
Â  Â  Â  Â  Â  Â  updateModalNav();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  DOM.modal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modal.classList.remove('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modal.querySelector('.modal-content').classList.remove('scale-95');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  initializeFieldPlugins();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.values(modalState.maps).forEach(map => map?.invalidateSize());
Â  Â  Â  Â  Â  Â  Â  Â  }, 100);
Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeModal() {
Â  Â  Â  Â  Â  Â  DOM.modal.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  DOM.modal.querySelector('.modal-content').classList.add('scale-95');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  resetModalState();
Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getStepDefinition() {
Â  Â  Â  Â  Â  Â  const steps = {
Â  Â  Â  Â  Â  Â  Â  Â  start: { title: "××™×–×” ×¤×¨×™×˜ ×œ×”×•×¡×™×£?", fields: [{ id: 'mainType', type: 'radio', options: [{value: 'hotel', label: 'ğŸ¨ ××œ×•×Ÿ'}, {value: 'transport', label: 'âœˆï¸ ××¢×‘×¨'}] }] },
Â  Â  Â  Â  Â  Â  Â  Â  hotel: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™ ×”××œ×•×Ÿ", fields: [{id: 'name', label: '×©× ×”××œ×•×Ÿ', required: true}, {id: 'booked_via', label: '×”×•×–××Ÿ ×“×¨×š?', required: true}] },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×ª××¨×™×›×™× ×•××—×™×¨", fields: [{id: 'dates', label: '×ª××¨×™×š ×¦\'×§-××™×Ÿ ×•×¦\'×§-×××•×˜', type: 'daterange', required: true}, {id: 'price', label: '××—×™×¨ (×‘×“×•×œ×¨×™×)', type: 'number', required: true}] },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "××™×§×•× ×”××œ×•×Ÿ", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'destination', label: '×™×¢×“ (×¢×™×¨, ××–×•×¨)', type: 'text', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'address', label: '×›×ª×•×‘×ª ××“×•×™×§×ª', type: 'addressmap', required: true}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'link', label: '×§×™×©×•×¨ ×œ××ª×¨ (×‘×•×§×™× ×’ ×•×›×•\')', type: 'url'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  transport: { title: "××™×–×” ×¡×•×’ ××¢×‘×¨?", fields: [{ id: 'subType', type: 'radio', options: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {value: 'flight', label: 'âœˆï¸ ×˜×™×¡×”'},Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {value: 'car_rental', label: 'ğŸš— ×¨×›×‘ ×©×›×•×¨'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {value: 'ferry', label: 'ğŸš¢ ××¢×‘×•×¨×ª'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {value: 'train', label: 'ğŸš† ×¨×›×‘×ª'}
Â  Â  Â  Â  Â  Â  Â  Â  ] }] },
Â  Â  Â  Â  Â  Â  Â  Â  car_rental: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™ ×”×©×›×¨×ª ×”×¨×›×‘", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'destination', label: '×œ××™×–×” ×™×¢×“?', type: 'text', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'booked_via', label: '×“×¨×š ××™×¤×” ×”×•×–××Ÿ?', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'pickup_location', label: '×××™×¤×” ×œ×•×§×—×™× ×‘×“×™×•×§?', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×ª××¨×™×›×™× ×•×¡×•×’", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'dates', label: '×ª××¨×™×›×™ ××™×¡×•×£ ×•×”×—×–×¨×”', type: 'daterange', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'pickup_time', label: '×©×¢×ª ××™×¡×•×£', type: 'time', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'return_time', label: '×©×¢×ª ×”×—×–×¨×”', type: 'time', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'car_type', label: '×¡×•×’ ×¨×›×‘', type: 'text', placeholder: '×œ×“×•×’××”: SUV, ××™× ×™', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¢×œ×•×ª ×•×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'price', label: '××—×™×¨ (×‘×“×•×œ×¨×™×)', type: 'number', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]}
Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  flight: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "××¡×œ×•×œ ×”×˜×™×¡×”", fields: [ { id: 'flightroute', type: 'flightroute', required: true } ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™ ×”×˜×™×¡×”", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'airline', label: '×—×‘×¨×ª ×ª×¢×•×¤×”', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'flight_number', label: '××¡×¤×¨ ×˜×™×¡×”', required: true},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'dates', label: '×ª××¨×™×š ×˜×™×¡×”', type: 'date', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'departure_time', label: '×©×¢×ª ×”××¨××” (×©×¢×•×Ÿ ××§×•××™ ×™×¦×™××”)', type: 'time', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'arrival_time', label: '×©×¢×ª × ×—×™×ª×” (×©×¢×•×Ÿ ××§×•××™ ×™×¢×“)', type: 'time', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'price_per_person', label: '××—×™×¨ ×œ××“× (×‘×“×•×œ×¨×™×)', type: 'number', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×›×‘×•×“×”, ×™×©×™×‘×” ×•×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'luggage', type: 'luggage' },Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'seats', type: 'seats' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]}
Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  ferry: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™ ×”××¢×‘×•×¨×ª", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'company', label: '×—×‘×¨×” ××¤×¢×™×œ×”', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'from_destination', label: '× ×§×•×“×ª ×™×¦×™××”', type: 'text', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'to_destination', label: '× ×§×•×“×ª ×”×’×¢×”', type: 'text', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×ª××¨×™×›×™× ×•×¢×œ×•×ª", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'date', label: '×ª××¨×™×š', type: 'date', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'departure_time', label: '×©×¢×ª ×™×¦×™××”', type: 'time', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'arrival_time', label: '×©×¢×ª ×”×’×¢×” ××©×•×¢×¨×ª', type: 'time', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'price', label: '××—×™×¨ ×›×•×œ×œ (×‘×“×•×œ×¨×™×)', type: 'number', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (×¡×•×’ ×›×¨×˜×™×¡, ×¡×™×¤×•×Ÿ ×•×›×•\')', type: 'textarea'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]}
Â  Â  Â  Â  Â  Â  Â  Â  ],
Â  Â  Â  Â  Â  Â  Â  Â  train: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™ ×”×¨×›×‘×ª", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'company', label: '×—×‘×¨×” ××¤×¢×™×œ×”', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'from_station', label: '×ª×—× ×ª ×™×¦×™××”', type: 'text', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'to_station', label: '×ª×—× ×ª ×”×’×¢×”', type: 'text', required: true },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â { title: "×ª××¨×™×›×™× ×•×¢×œ×•×ª", fields: [
Â  Â  Â  Â  Â  Â  Â  _D]
## Â  Â  Â  Â  Â  Â  Â  Â  { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { id: 'seat_info', label: '×¤×¨×˜×™ ××•×©×‘×™× (××•×¤×¦×™×•× ×œ×™)', type: 'text'},
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××—×œ×§×”, ×§×¨×•×Ÿ ×•×›×•\')', type: 'textarea'}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]}
Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (editingItem) return steps[modalState.subType || modalState.mainType];
Â  Â  Â  Â  Â  Â  if (!modalState.mainType) return [steps.start];
Â  Â  Â  Â  Â  Â  if (modalState.mainType === 'hotel') return steps.hotel;
Â  Â  Â  Â  Â  Â  if (modalState.mainType === 'transport' && !modalState.subType) return [steps.transport];
Â  Â  Â  Â  Â  Â  if (modalState.subType) return steps[modalState.subType];
Â  Â  Â  Â  Â  Â  return [];
Â  Â  Â  Â  }

Â  Â  Â  Â  function generateStepContent() {
Â  Â  Â  Â  Â  Â  const stepDefinitions = getStepDefinition();
Â  Â  Â  Â  Â  Â  if (!stepDefinitions || stepDefinitions.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalForm.innerHTML = `<p>×©×’×™××”: ×œ× × ××¦××• ×©×œ×‘×™× ×œ×”×’×“×¨×”.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const currentStepIndex = modalState.currentStep - 1;
Â  Â  Â  Â  Â  Â  const stepDef = stepDefinitions[currentStepIndex];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!stepDef) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Invalid step definition for step:", modalState.currentStep);
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalForm.innerHTML = `<p>×©×’×™××”: ×©×œ×‘ ×œ× ×ª×§×™×Ÿ.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let html = `<div class="modal-step active" data-step="${modalState.currentStep}">
Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-xl font-bold text-slate-800 mb-6">${stepDef.title}</h4>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  stepDef.fields.forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  html += `<div class="mb-4">${renderField(field)}</div>`;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  html += `</div>`;
Â  Â  Â  Â  Â  Â  DOM.modalForm.innerHTML = html;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderField(field) {
Â  Â  Â  Â  Â  Â  const value = modalState.data[field.id] || '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  switch(field.type) {
Â  Â  Â  Â  Â  Â  Â  Â  case 'radio':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block text-sm font-semibold text-slate-600">${field.label}</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-wrap gap-4">${field.options.map(opt => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" id="${field.id}-${opt.value || opt}" name="${field.id}" value="${opt.value || opt}" ${ (opt.value || opt) === value ? 'checked' : ''} class="form-radio">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span>${opt.label || opt}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>`).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  case 'textarea':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <textarea id="${field.id}" class="mt-1 block w-full p-2 border rounded-md shadow-sm" rows="3">${modalState.data[field.id] || ''}</textarea>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>`;
Â  Â  Â  Â  Â  Â  Â  Â  case 'addressmap':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="${field.id}" value="${modalState.data.address || ''}" class="block w-full p-2 border rounded-md shadow-sm" placeholder="×”×–×Ÿ ×›×ª×•×‘×ª ××œ××”">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-action="find-address" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-700">××¦×</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="map-container" class="mt-4 small-map-container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  case 'flightroute':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${renderFlightLeg('from', '×××™×¤×”?', modalState.data)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${renderFlightLeg('to', '×œ××™×¤×”?', modalState.data)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="connections-container" class="space-y-4">${(modalState.data.connections || []).map((conn, i) => renderFlightLeg(`connection-${i}`, `×§×•× ×§×©×Ÿ ${i+1}`, conn)).join('')}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="add-connection-btn" class="text-sm text-blue-600 hover:underline"><i class="fas fa-plus mr-1"></i>×”×•×¡×£ ×§×•× ×§×©×Ÿ</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <hr class="my-6"/>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h5 class="text-lg font-bold text-slate-700">××¤×ª ××¡×œ×•×œ ××¡×›××ª</h5>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="calculate-final-route-btn" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">×”×¦×’ ××¡×œ×•×œ ××œ×</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="map-final-route" class="mt-4 final-map-container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  case 'luggage':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<fieldset class="border p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <legend class="px-2 font-semibold">×¤×¨×˜×™ ×›×‘×•×“×” (×œ× ×•×¡×¢)</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><span class="text-sm font-semibold text-slate-600">×ª×™×§×™ ×™×“</span><input type="number" id="hand_bag_count" value="${modalState.data.hand_bag_count || 1}" class="mt-1 block w-full p-2 border rounded-md"></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><span class="text-sm font-semibold text-slate-600">×˜×¨×•×œ×™ (×›××•×ª)</span><input type="number" id="trolley_count" value="${modalState.data.trolley_count || 1}" class="mt-1 block w-full p-2 border rounded-md"></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><span class="text-sm font-semibold text-slate-600">××–×•×•×“×•×ª (×›××•×ª)</span><input type="number" id="checked_bags_count" value="${modalState.data.checked_bags_count || 1}" class="mt-1 block w-full p-2 border rounded-md"></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>`;
Â  Â  Â  Â  Â  Â  Â  Â  case 'seats':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<fieldset class="border p-4 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <legend class="px-2 font-semibold">××§×•××•×ª ×™×©×™×‘×”</legend>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="seats-container" class="flex flex-wrap gap-2"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" id="add-seat-btn" class="mt-2 text-sm text-blue-600 hover:underline"><i class="fas fa-plus mr-1"></i>×”×•×¡×£ ××§×•× ×™×©×™×‘×”</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </fieldset>`;
Â  Â  Â  Â  Â  Â  Â  Â  case 'daterange':
Â  Â  Â  Â  Â  Â  Â  Â  case 'date':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â return `<label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="${field.id}" value="${value}" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××¨×™×›×™×">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>`;
Â  Â  Â  Â  Â  Â  Â  Â  default: // text, url, number, time
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return `<label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="${field.type || 'text'}" id="${field.id}" value="${value}" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="${field.placeholder || ''}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderFlightLeg(id, legend, data = {}) {
Â  Â  Â  Â  Â  Â  let legData = {};
Â  Â  Â  Â  Â  Â  if (id === 'from' || id === 'to') {
Â  Â  Â  Â  Â  Â  Â  Â  legData = data[id] || {};
Â  Â  Â  Â  Â  Â  } else if (id.startsWith('connection-')) {
Â  Â  Â  Â  Â  Â  Â  Â  const index = parseInt(id.split('-')[1], 10);
Â  Â  Â  Â  Â  Â  Â  Â  legData = data.connections?.[index] || {};
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  return `<fieldset class="border p-4 rounded-lg" id="fieldset-${id}">
Â  Â  Â  Â  Â  Â  Â  Â  <legend class="px-2 font-semibold">${legend}</legend>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><span class="text-sm font-semibold text-slate-600">×™×¢×“</span><input type="text" id="${id}_destination" value="${legData.destination || ''}" class="mt-1 block w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: × ×™×• ×™×•×¨×§"></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label><span class="text-sm font-semibold text-slate-600">×©× ×©×“×” ×ª×¢×•×¤×”</span><input type="text" id="${id}_airport_name" value="${legData.airport_name || ''}" class="mt-1 block w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: JFK"></label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="md:col-span-2"><span class="text-sm font-semibold text-slate-600">×›×ª×•×‘×ª ×©×“×” ×ª×¢×•×¤×”</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="${id}_airport_address" value="${legData.airport_address || ''}" class="block w-full p-2 border rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" data-action="find-flight-leg" data-leg-id="${id}" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-700">××¦×</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="map-${id}" class="mt-2 md:col-span-2 small-map-container"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </fieldset>`;
Â  Â  Â  Â  }

Â  Â  Â  Â  function initializeFieldPlugins() {
Â  Â  Â  Â  Â  Â  const dateInput = DOM.modalForm.querySelector('#dates, #date');
Â  Â  Â  Â  Â  Â  if (dateInput) {
Â  Â  Â  Â  Â  Â  Â  Â  const isSingle = dateInput.id === 'date' || modalState.subType === 'flight';
Â  Â  Â  Â  Â  Â  Â  Â  modalState.datePicker = new Litepicker({Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  element: dateInput,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  singleMode: isSingle,Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  format: 'DD/MM/YYYY'Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (document.getElementById('map-container')) initMap('map-container', 'hotel');
Â  Â  Â  Â  Â  Â  if (document.querySelector('[id^="map-from"]')) initMap('map-from', 'from');
Â  Â  Â  Â  Â  Â  if (document.querySelector('[id^="map-to"]')) initMap('map-to', 'to');
Â  Â  Â  Â  Â  Â  (modalState.data.connections || []).forEach((conn, i) => initMap(`map-connection-${i}`, `connection-${i}`));
Â  Â  Â  Â  Â  Â  if (document.querySelector('[id^="map-final-route"]')) initMap('map-final-route', 'final-route');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (document.getElementById('add-seat-btn')) {
Â  Â  Â  Â  Â  Â  Â  Â  (modalState.data.seats || []).forEach(seat => addSeatInput(seat));
Â  Â  Â  _D>
Â  Â  Â  Â  function updateModalNav() {
Â  Â  Â  Â  Â  Â  const stepDefinitions = getStepDefinition();
Â  Â  Â  Â  Â  Â  const isLastStep = modalState.currentStep >= stepDefinitions.length;
Â  Â  Â  Â  Â  Â  const isChoiceStep = !modalState.mainType || (modalState.mainType === 'transport' && !modalState.subType);

Â  Â  Â  Â  Â  Â  DOM.modalBackBtn.classList.toggle('hidden', modalState.currentStep === 1 && isChoiceStep);
Â  Â  Â  Â  Â  Â  DOM.modalNextBtn.classList.toggle('hidden', isLastStep && !isChoiceStep);
Â  Â  Â  Â  Â  Â  DOM.modalFinishBtn.classList.toggle('hidden', !isLastStep || isChoiceStep);
Â  Â  Â  Â  }

Â  Â  Â  Â  function collectStepData() {
Â  Â  Â  Â  Â  Â  const stepDefinitions = getStepDefinition();
Â  Â  Â  Â  Â  Â  if (!stepDefinitions.length) return false;
Â  Â  Â  Â  Â  Â  const stepDef = stepDefinitions[modalState.currentStep - 1];
Â  Â  Â  Â  Â  Â  let isValid = true;
Â  Â  Â  Â  Â  Â  DOM.modalError.textContent = '';

Â  Â  Â  Â  Â  Â  stepDef.fields.forEach(field => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!isValid) return;Â 
Â  Â  Â  Â  Â  Â  Â  Â  let value;
Â  Â  Â  Â  Â  Â  Â  Â  if (field.type === 'radio') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const checked = document.querySelector(`input[name="${field.id}"]:checked`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value = checked ? checked.value : null;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (field.type === 'flightroute') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const collectLegData = (legId, existingData = {}) => ({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destination: document.getElementById(`${legId}_destination`)?.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  airport_name: document.getElementById(`${legId}_airport_name`)?.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  airport_address: document.getElementById(`${legId}_airport_address`)?.value,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  coords: existingData.coords,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.from = collectLegData('from', modalState.data.from);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.to = collectLegData('to', modalState.data.to);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.connections = (modalState.data.connections || []).map((conn, i) => collectLegData(`connection-${i}`, conn));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (field.type === 'luggage') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.hand_bag_count = document.getElementById('hand_bag_count').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.trolley_count = document.getElementById('trolley_count').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.checked_bags_count = document.getElementById('checked_bags_count').value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (field.type === 'seats') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.seats = Array.from(document.querySelectorAll('.seat-input-wrapper input')).map(i => i.value).filter(Boolean);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const input = document.getElementById(field.id);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (input) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â value = field.type === 'number' ? parseFloat(input.value) || 0 : input.value;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (field.required && !value) {
Â  Â  Â  Â  Â  _D>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalError.textContent = `×©×“×” ×—×•×‘×”: ${field.label}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  isValid = false;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (field.id) modalState.data[field.id] = value;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (isValid && !modalState.mainType) modalState.mainType = modalState.data.mainType;
Â  Â  Â  Â  Â  Â  if (isValid && modalState.mainType === 'transport' && !modalState.subType) modalState.subType = modalState.data.subType;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  return isValid;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function handleFormSubmit(e) {
Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  if (!collectStepData()) return;

Â  Â  Â  Â  Â  Â  const finalData = { ...modalState.data };
Â  Â  Â  Â  Â  Â  finalData.type = modalState.subType || modalState.mainType;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  delete finalData.mainType;
Â  Â  Â  Â  Â  Â  delete finalData.subType;

Â  Â  Â  Â  Â  Â  const cleanDataForFirebase = (obj) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (obj === null || obj === undefined) return null;
Â  Â  Â  Â  Â  Â  Â  Â  if (Array.isArray(obj)) return obj.map(item => cleanDataForFirebase(item));
Â  Â  Â  Â  Â  Â  Â  Â  if (typeof obj !== 'object') return obj;

Â  Â  Â  Â  Â  Â  Â  Â  const newObj = {};
Â  Â  Â  Â  Â  Â  Â  Â  for (const key in obj) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (Object.prototype.hasOwnProperty.call(obj, key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const value = obj[key];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (value !== undefined) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newObj[key] = cleanDataForFirebase(value);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  return newObj;
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const cleanedData = cleanDataForFirebase(finalData);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
Â  Â  Â  Â  Â  Â  Â  Â  if (editingItem && editingItem.id) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(doc(logisticsCollectionRef, editingItem.id), cleanedData);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cleanedData.createdAt = serverTimestamp();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await addDoc(logisticsCollectionRef, cleanedData);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving document:", err);
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalError.textContent = '×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×™×˜.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Map & Geocoding Logic ---
Â  Â  Â  Â  function initMap(containerId, mapKey) {
Â  Â  Â  Â  Â  Â  if (modalState.maps[mapKey]) modalState.maps[mapKey].remove();
Â  Â  Â  Â  Â  Â  const mapContainer = document.getElementById(containerId);
Â  Â  Â  Â  Â  Â  if (!mapContainer) return;

Â  Â  Â  Â  Â  Â  const map = L.map(containerId).setView([31.7683, 35.2137], 2);
Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
Â  Â  Â  Â  Â  Â  modalState.maps[mapKey] = map;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function geocodeAddress(address) {
Â  Â  Â  Â  Â  Â  if (!address) return null;
Â  Â  Â  Â  Â  Â  const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  return (data && data.length > 0) ? { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) } : null;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Geocoding error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  return null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function findAddressOnMap(mapKey, address) {
Â  Â  Â  Â  Â  Â  DOM.modalError.textContent = '××—×¤×©...';
Â  Â  Â  Â  Â  Â  const coords = await geocodeAddress(address);
Â  Â  Â  Â  Â  Â  const map = modalState.maps[mapKey];

Â  Â  Â  Â  Â  Â  if (coords && map) {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalError.textContent = '';
Â  Â  Â  Â  Â  Â  Â  Â  map.setView([coords.lat, coords.lng], 13);
Â  Â  Â  Â  Â  Â  Â  Â  if (modalState.mapMarkers[mapKey]) modalState.mapMarkers[mapKey].remove();
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const marker = L.marker([coords.lat, coords.lng]).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  modalState.mapMarkers[mapKey] = marker;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const legId = mapKey;
Â  Â  Â  Â  Â  Â  Â  Â  if (legId === 'from' || legId === 'to') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!modalState.data[legId]) modalState.data[legId] = {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data[legId].coords = coords;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (legId.startsWith('connection-')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const index = parseInt(legId.split('-')[1], 10);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (modalState.data.connections && modalState.data.connections[index]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalState.data.connections[index].coords = coords;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â modalState.data.coords = coords;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.modalError.textContent = '×”×›×ª×•×‘×ª ×œ× × ××¦××”.';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function showFinalRouteOnMap() {
Â  Â  Â  Â  Â  Â  const finalMap = modalState.maps['final-route'];
Â  Â  Â  Â  Â  Â  if (!finalMap) return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  collectStepData();Â 

Â  Â  Â  Â  Â  Â  Object.values(finalMap._layers).forEach(layer => {
Â  Â  Â  Â  Â  Â  Â  Â  if (layer instanceof L.Marker || layer instanceof L.Polyline || layer instanceof L.PolylineDecorator) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  finalMap.removeLayer(layer);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const points = [];
Â  Â  Â  Â  Â  Â  const allLegs = [modalState.data.from, ...(modalState.data.connections || []), modalState.data.to];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  allLegs.forEach(leg => {
Â  Â  Â  Â  Â  Â  Â  Â  if (leg && leg.coords) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  points.push([leg.coords.lat, leg.coords.lng]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.marker([leg.coords.lat, leg.coords.lng]).addTo(finalMap);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (points.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  finalMap.fitBounds(points, { padding: [50, 50] });
Â  Â  Â  Â  Â  Â  Â  Â  if (points.length > 1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const polyline = L.polyline(points, {color: '#3b82f6', weight: 3, dashArray: '10, 10'}).addTo(finalMap);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.polylineDecorator(polyline, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  patterns: [
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  { offset: 25, repeat: 50, symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { fillOpacity: 1, weight: 0, color: '#3b82f6' } }) }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ]
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }).addTo(finalMap);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Dynamic Form Elements ---
Â  Â  Â  Â  function addConnection() {
Â  Â  Â  Â  Â  Â  if (!modalState.data.connections) modalState.data.connections = [];
Â  Â  Â  Â  Â  Â  const index = modalState.data.connections.length;
Â  Â  Â  Â  Â  Â  modalState.data.connections.push({});
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const container = document.getElementById('connections-container');
Â  Â  Â  Â  Â  Â  const legHtml = renderFlightLeg(`connection-${index}`, `×§×•× ×§×©×Ÿ ${index + 1}`);
Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  div.innerHTML = legHtml;
Â  Â  Â  Â  Â  Â  container.appendChild(div.firstChild);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  initMap(`map-connection-${index}`, `connection-${index}`);
Â  Â  Â  Â  Â  Â  setTimeout(() => modalState.maps[`connection-${index}`]?.invalidateSize(), 10);
Â  Â  Â  Â  }

Â  Â  Â  Â  function addSeatInput(value = '') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('seats-container');
Â  Â  Â  Â  Â  Â  if (!container) return;
Â  Â  Â  Â  Â  Â  const wrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  wrapper.className = 'seat-input-wrapper flex items-center gap-2';
Â  Â  Â  Â  Â  Â  wrapper.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" class="p-2 border rounded-md w-24" placeholder="×œ×“×•×’××”: A40" value="${value}">
Â  Â  Â  Â  Â  Â  Â  Â  <button type="button" class="remove-seat-btn text-red-500 hover:text-red-700 text-xl font-bold">Ã—</button>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  wrapper.querySelector('.remove-seat-btn').addEventListener('click', () => wrapper.remove());
Â  Â  Â  Â  Â  Â  container.appendChild(wrapper);
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Delete/Details Modals ---
Â  Â  Â  Â  function handleDelete(id, name) {
Â  Â  Â  Â  Â  Â  itemToDelete = { id, name };
Â  Â  Â  Â  Â  Â  DOM.deleteModalTitle.textContent = `×”×× ×œ××—×•×§ ××ª "${name}"?`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  DOM.deleteModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.deleteModal.classList.remove('opacity-0');
Â  Â  Â  Â  Â  Â  Â  Â  DOM.deleteModal.querySelector('.modal-content').classList.remove('scale-95');
Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function confirmDeletion() {
Â  Â  Â  Â  Â  Â  if (!itemToDelete) return;
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await deleteDoc(doc(db, "trips", tripId, "logistics", itemToDelete.id));
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to delete item:", error);
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  closeDeleteModal();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeDeleteModal() {
Â  Â  Â  Â  Â  Â  DOM.deleteModal.classList.add('opacity-0');
Â  Â  Â  Â  Â  Â  DOM.deleteModal.querySelector('.modal-content').classList.add('scale-95');
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  DOM.deleteModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  itemToDelete = null;
Â  Â  Â  Â  Â  Â  }, 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Event Listeners ---
Â  Â  Â  Â  document.getElementById('open-add-modal-btn').addEventListener('click', () => openModal());
Â  Â  Â  Â  DOM.modalCloseBtn.addEventListener('click', closeModal);
Â  Â  Â  Â  DOM.modalForm.addEventListener('submit', handleFormSubmit);
Â  Â  Â  Â Â 
Â  Â  Â  Â  DOM.modalNextBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const wasChoiceStep = !modalState.mainType || (modalState.mainType === 'transport' && !modalState.subType);
Â  Â  Â  Â  Â  Â  if (collectStepData()) {
Â  Â  Â  Â  Â  Â  Â  Â  modalState.currentStep = wasChoiceStep ? 1 : modalState.currentStep + 1;
Â  Â  Â  Â  Â  Â  Â  Â  generateStepContent();
Â  Â  Â  Â  Â  Â  Â  Â  updateModalNav();
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  initializeFieldPlugins();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Object.values(modalState.maps).forEach(m => m?.invalidateSize());
Â  Â  Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  DOM.modalBackBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  collectStepData();
Â  Â  Â  Â  Â  Â  if (modalState.currentStep === 1) {
Â  Â  Â  Â  Â  Â  Â  Â  if (modalState.subType) { modalState.subType = null; modalState.data.subType = null; }Â 
Â  Â  Â  Â  Â  Â  Â  Â  else if (modalState.mainType) { modalState.mainType = null; modalState.data.mainType = null; }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  modalState.currentStep--;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  generateStepContent();
Â  Â  Â  Â  Â  Â  updateModalNav();
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  initializeFieldPlugins();
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(modalState.maps).forEach(m => m?.invalidateSize());
Â  Â  Â  Â  Â  Â  }, 10);
Â  Â  Â  Â  });

Â  Â  Â  Â  DOM.modalForm.addEventListener('click', e => {
Â  Â  Â  Â  Â  Â  const target = e.target.closest('button');
Â  Â  Â  Â  Â  Â  if (!target) return;
Â  Â  Â  Â  Â  Â  const { action, legId } = target.dataset;

Â  Â  Â  Â  Â  Â  if (action === 'find-address') {
Â  Â  Â  Â  Â  Â  Â  Â  findAddressOnMap('hotel', document.getElementById('address').value);
Â  Â  Â  Â  Â  Â  } else if (action === 'find-flight-leg') {
Â  Â  Â  Â  Â  Â  Â  Â  const address = document.getElementById(`${legId}_airport_address`).value;
Â  Â  Â  Â  Â  Â  Â  Â  findAddressOnMap(legId, address);
Â  Â  Â  Â  Â  Â  } else if (target.id === 'add-connection-btn') {
Â  Â  Â  Â  Â  Â  Â  Â  addConnection();
Â  Â  Â  Â  Â  Â  } else if (target.id === 'calculate-final-route-btn') {
Â  Â  Â  Â  Â  Â  Â  Â  showFinalRouteOnMap();
Â  Â  Â  Â  Â  Â  } else if (target.id === 'add-seat-btn') {
Â  Â  Â  Â  Â  Â  Â  Â  addSeatInput();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  document.addEventListener('click', e => {
Â  Â  Â  Â  Â  Â  const editBtn = e.target.closest('.edit-btn');
Â  Â  Â  Â  Â  Â  if (editBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  const item = allItems.find(i => i.id === editBtn.dataset.id);
Â  Â  Â  Â  Â  Â  Â  Â  if (item) openModal(item);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const deleteBtn = e.target.closest('.delete-btn');
Â  Â  Â  Â  Â  Â  if (deleteBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  Â  Â  handleDelete(deleteBtn.dataset.id, deleteBtn.dataset.name);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Sidebar Activation ---
Â  Â  Â  Â  const toggleSidebar = () => {
Â  Â  Â  Â  Â  Â  DOM.sidebar.classList.toggle('translate-x-full');
Â  Â  Â  Â  Â  Â  DOM.overlay.classList.toggle('hidden');
Â  Â  Â  Â  };
Â  Â  Â  Â  DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
Â  Â  Â  Â  DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
Â  Â  Â  Â  DOM.overlay.addEventListener('click', toggleSidebar);

Â  Â  Â  Â  // --- Delete Modal Listeners ---
Â  Â  Â  Â  DOM.deleteConfirmBtn.addEventListener('click', confirmDeletion);
Â  Â  Â  Â  DOM.deleteCancelBtn.addEventListener('click', closeDeleteModal);

Â  Â  Â  Â  // --- Summary Table Logic ---
Â  Â  Â  Â  function renderSummaryTables() {
Â  Â  Â  Â  Â  Â  const categories = {
Â  Â  Â  Â  Â  Â  Â  Â  hotel: { label: 'ğŸ¨ ××œ×•× ×•×ª', total: 0, items: [] },
Â  Â  Â  Â  Â  Â  Â  Â  flight: { label: 'âœˆï¸ ×˜×™×¡×•×ª', total: 0, items: [] },
Â  Â  Â  Â  Â  Â  Â  Â  car_rental: { label: 'ğŸš— ×¨×›×‘×™×', total: 0, items: [] },
Â  Â  Â  Â  Â  Â  Â  Â  ferry: { label: 'ğŸš¢ ××¢×‘×•×¨×•×ª', total: 0, items: [] },
Â  Â  Â  Â  Â  Â  Â  Â  train: { label: 'ğŸš† ×¨×›×‘×•×ª', total: 0, items: [] },
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  allItems.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if (categories[item.type]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let price = 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (item.type === 'flight') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const numSeats = item.seats?.length || 1;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price = (item.price_per_person || 0) * numSeats;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  price = item.price || 0;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  categories[item.type].total += price;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  DOM.logisticsSummaryBody.innerHTML = '';
Â  Â  Â  Â  Â  Â  let grandTotal = 0;
Â  Â  Â  Â  Â  Â  for (const key in categories) {
Â  Â  Â  Â  Â  Â  Â  Â  const category = categories[key];
Â  Â  Â  Â  Â  Â  Â  Â  if (category.total > 0 || allItems.some(item => item.type === key)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  DOM.logisticsSummaryBody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3">${category.label}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 font-mono text-left">$${category.total.toLocaleString()}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  grandTotal += category.total;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â DOM.logisticsSummaryBody.innerHTML += `
Â  Â  Â  Â  Â  Â  Â  Â  <tr class="font-bold bg-slate-100 text-slate-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3">×¡×”"×›</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="p-3 font-mono text-left">$${grandTotal.toLocaleString()}</td>
Â  Â  Â  Â  Â  Â  Â  Â  </tr>`;

Â  Â  Â  Â  Â  Â  DOM.grandTotalContainer.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-4xl font-bold text-blue-600 drop-shadow-sm font-mono">$${grandTotal.toLocaleString()}</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-slate-500 mt-1">×¢×œ×•×ª ×›×•×œ×œ×ª ××©×•×¢×¨×ª</p>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- Start the page ---
Â  Â  Â  Â  initPage();
Â  Â  </script>
</body>
</html>