<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/bundle.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js"></script>

    <style>
        :root {
            --primary-color: #2563eb;
            --secondary-color: #3b82f6;
            --accent-color: #f9a8d4;
            --surface-color: #ffffff;
            --background-color: #f1f5f9;
        }

        body {
            font-family: 'Assistant', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #f0f4f8, #e2e8f0);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .card {
            background: var(--surface-color);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.7);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            cursor: pointer;
        }
        .card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
            transform: translateY(-4px);
        }

        .icon-chip {
            width: 56px; height: 56px;
            border-radius: 9999px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, #e0f2fe, #bfdbfe);
            border: 1px solid #93c5fd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .icon-chip i { color: #2563eb; }

        .price-chip {
            background: #e6f2ff; border: 1px solid #cfe3ff; color: #1e3a8a;
            font-weight: 800; border-radius: 9999px; padding: .35rem .8rem;
            white-space: nowrap;
        }
        .vehicle-number-chip {
            background: #d1fae5;
            border: 1px solid #6ee7b7;
            color: #065f46;
            font-weight: 700;
            border-radius: 9999px;
            padding: .25rem .75rem;
            font-size: 0.875rem;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .action-button {
            transition: transform 0.2s ease;
        }
        .action-button:hover {
            transform: scale(1.1);
        }

        .modal-overlay { transition: opacity 0.3s ease; }
        .modal-content-container { transition: transform 0.3s ease; }
        .modal-step { display: none; animation: fadeIn 0.5s; }
        .modal-step.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .leaflet-container { border-radius: 0.5rem; border: 1px solid #e2e8f0; z-index: 10; }
        .small-map-container { height: 250px; }
        .final-map-container { height: 350px; }
        .details-map-container { height: 250px; }
        .litepicker { z-index: 100 !important; }

        .autocomplete-suggestions {
            position: absolute;
            background-color: white;
            border: 1px solid #d1d5db;
            border-top: none;
            border-radius: 0 0 0.375rem 0.375rem;
            max-height: 150px;
            overflow-y: auto;
            z-index: 9999;
            width: calc(100% - 40px);
        }
        .autocomplete-suggestion {
            padding: 0.5rem;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f3f4f6;
        }
        
        .custom-scrollbar::-webkit-scrollbar { width: 8px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f5f9; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-100 custom-scrollbar">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
        <div class="w-16 h-16 border-4 border-dashed rounded-full animate-spin border-blue-600"></div>
        <p class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ × ×ª×•× ×™×, × × ×œ×”××ª×™×Ÿ...</p>
    </div>
    
    <!-- Page Background -->
    <div class="fixed inset-0 z-0 bg-gray-900"></div>
    <div class="fixed inset-0 z-0 bg-gradient-to-br from-blue-700 to-indigo-800 opacity-60"></div>
    <div class="fixed inset-0 z-0 bg-dots-pattern"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto custom-scrollbar transition-transform duration-300">
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
            <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500 transition-colors"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <nav id="main-menu" class="p-4 space-y-2"></nav>
    </aside>
    <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

    <!-- Main Content -->
    <div class="relative z-10">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-40 shadow-sm rounded-b-xl">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600 transition-colors" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ"><i class="fas fa-arrow-left fa-lg"></i></a>
                        <h1 id="page-title" class="text-xl font-bold text-slate-800">× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <div id="auth-container" class="flex items-center"></div>
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none transition-colors"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="p-4 sm:p-6 lg:p-8">
            <div class="max-w-7xl mx-auto space-y-12">
                <div class="text-center">
                    <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">×”×œ×•×’×™×¡×˜×™×§×” ×©×œ ×”×˜×™×•×œ</h2>
                    <p class="mt-4 text-xl text-slate-200 max-w-2xl mx-auto drop-shadow">×›×œ ×”××œ×•× ×•×ª, ×”×˜×™×¡×•×ª, ×”×¨×›×‘×™×, ×”×¨×›×‘×•×ª ×•×”××¢×‘×•×¨×•×ª ×‘××§×•× ××—×“.</p>
                    <button id="open-add-modal-btn" class="mt-8 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fas fa-plus ml-2"></i>×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×•×’×™×¡×˜×™
                    </button>
                </div>

                <section id="hotel-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ¨ ×¡×™×›×•× ×”××œ×•× ×•×ª ×©×œ× ×•</h3>
                    <div id="hotel-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        <p class="text-white/80 text-center col-span-full">×˜×•×¢×Ÿ ×¡×™×›×•× ××œ×•× ×•×ª...</p>
                    </div>
                </section>

                <section id="transport-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">âœˆï¸ ×¡×™×›×•× ×”××¢×‘×¨×™× ×©×œ× ×•</h3>
                    <div id="transport-cards-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                           <p class="text-white/80 text-center col-span-full">×˜×•×¢×Ÿ ×¡×™×›×•× ××¢×‘×¨×™×...</p>
                    </div>
                </section>

                <section id="cost-summary">
                    <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">ğŸ“Š ×¡×™×›×•××™ ×¢×œ×•×™×•×ª</h3>
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                            <h4 class="font-bold text-xl text-slate-700 mb-4">ğŸ§¾ ×¡×™×›×•× ×œ×•×’×™×¡×˜×™×§×”</h4>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm text-right">
                                    <thead class="bg-slate-50"><tr><th class="p-3 font-semibold">×§×˜×’×•×¨×™×”</th><th class="p-3 font-semibold text-left">×¢×œ×•×ª ($)</th></tr></thead>
                                    <tbody id="logistics-summary-tbody" class="divide-y divide-slate-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg flex flex-col justify-center">
                            <h4 class="font-bold text-xl text-slate-700 mb-4">ğŸ’° ×”×©×•×¨×” ×”×ª×—×ª×•× ×”</h4>
                            <div id="grand-total-container" class="text-center">
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="item-modal" class="modal-overlay fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content-container bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©</h3>
                <button id="modal-close-btn" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="item-form" class="flex-grow overflow-y-auto p-6 space-y-6 custom-scrollbar"></form>
            <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
                <button type="button" id="modal-back-btn" class="py-2 px-5 rounded-lg hover:bg-slate-200 transition font-semibold">××—×•×¨×”</button>
                <div id="modal-error-message" class="text-red-500 text-sm font-bold h-5 flex-grow text-center"></div>
                <button type="button" id="modal-next-btn" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
                <button type="submit" form="item-form" id="modal-finish-btn" class="py-2 px-5 bg-green-500 text-white font-bold rounded-lg hover:bg-green-600 transition hidden">×©××•×¨ ×¤×¨×™×˜</button>
            </div>
        </div>
    </div>
    
    <div id="delete-confirm-modal" class="modal-overlay fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center opacity-0">
       <div class="modal-content-container bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full transform scale-95">
            <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
            <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§?</h3>
            <div class="flex justify-center gap-4 mt-6">
                <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
                <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
            </div>
        </div>
    </div>
    
    <div id="details-modal" class="modal-overlay fixed inset-0 bg-black/60 z-[75] hidden items-center justify-center p-4 opacity-0">
        <div class="modal-content-container bg-white rounded-2xl shadow-xl w-full max-w-3xl max-h-[95vh] flex flex-col transform scale-95">
            <!-- Details content will be injected here -->
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, collection, doc, getDoc, addDoc, query, onSnapshot,
            serverTimestamp, deleteDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration & Initialization ---
        // DO NOT EDIT: These are global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & Constants ---
        let tripId = null;
        let tripData = null;
        let currentUser = null;
        let allItems = [];
        let editingItem = null; 
        let itemToDelete = null;
        let logisticsUnsubscribe = null;
        let detailsMap = null;
        let modalState = {
            mainType: null, subType: null, currentStep: 1, data: {},
            maps: {}, mapLayers: {}, datePicker: null,
        };

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            pageTitle: document.getElementById('page-title'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            authContainer: document.getElementById('auth-container'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            hotelContainer: document.getElementById('hotel-cards-container'),
            transportContainer: document.getElementById('transport-cards-container'),
            modal: document.getElementById('item-modal'),
            modalTitle: document.getElementById('modal-title'),
            modalForm: document.getElementById('item-form'),
            modalNextBtn: document.getElementById('modal-next-btn'),
            modalBackBtn: document.getElementById('modal-back-btn'),
            modalFinishBtn: document.getElementById('modal-finish-btn'),
            modalError: document.getElementById('modal-error-message'),
            modalCloseBtn: document.getElementById('modal-close-btn'),
            deleteModal: document.getElementById('delete-confirm-modal'),
            deleteModalTitle: document.getElementById('delete-modal-title'),
            deleteConfirmBtn: document.getElementById('delete-modal-confirm'),
            deleteCancelBtn: document.getElementById('delete-modal-cancel'),
            detailsModal: document.getElementById('details-modal'),
            logisticsSummaryBody: document.getElementById('logistics-summary-tbody'),
            grandTotalContainer: document.getElementById('grand-total-container'),
        };

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId') || urlParams.get('id');
            if (!tripId) {
                console.error("×©×’×™××”: ×œ× × ××¦× ××–×”×” ×˜×™×•×œ. ××—×–×™×¨ ××•×ª×š ×œ×“×£ ×”×‘×™×ª.");
                setTimeout(() => window.location.href = 'index.html', 100);
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    currentUser = user;
                    await loadPageData();
                    setupAuthUI(user);
                } else {
                    if (initialAuthToken) {
                         try {
                            await signInWithCustomToken(auth, initialAuthToken);
                            console.log("Signed in with custom token.");
                        } catch (error) {
                            console.error("Custom token sign-in failed:", error);
                            await signInAnonymously(auth);
                        }
                    } else {
                        await signInAnonymously(auth);
                    }
                }
            });
        }

        async function loadPageData() {
            if (logisticsUnsubscribe) logisticsUnsubscribe(); 
            if (!currentUser) {
                console.error("××™×Ÿ ××©×ª××© ××—×•×‘×¨.");
                return;
            }

            const tripDocRef = doc(db, `artifacts/${appId}/public/data/trips`, tripId);
            const tripSnap = await getDoc(tripDocRef);

            if (!tripSnap.exists()) {
                console.error("×”×˜×™×•×œ ×œ× × ××¦×. ××—×–×™×¨ ××•×ª×š ×œ×“×£ ×”×‘×™×ª.");
                setTimeout(() => window.location.href = 'index.html', 100);
                return;
            }

            const tripDataFromSnap = tripSnap.data();
            const canAccess = tripDataFromSnap.owner === currentUser.uid || (tripDataFromSnap.editors && tripDataFromSnap.editors.includes(currentUser.uid));

            if (!canAccess) {
                console.error('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×ª×•×›×Ÿ ×–×”.');
                setTimeout(() => location.href = 'index.html', 100);
                return;
            }
            
            tripData = tripDataFromSnap;
            document.title = `×œ×•×’×™×¡×˜×™×§×” - ${tripData.name}`;
            DOM.pageTitle.textContent = `×œ×•×’×™×¡×˜×™×§×” - ${tripData.name}`;
            buildSidebarMenu();

            const logisticsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips/${tripId}/logistics`);
            const q = query(logisticsCollectionRef);

            logisticsUnsubscribe = onSnapshot(q, (snapshot) => {
                allItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderApp();
                DOM.loadingOverlay.classList.add('opacity-0');
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);
            }, (error) => {
                console.error("Snapshot error:", error);
                DOM.loadingOverlay.classList.add('opacity-0');
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);
            });
        }

        // --- UI Population ---
        function renderApp() {
            const hotels = allItems.filter(item => item.type === 'hotel');
            const transports = allItems.filter(item => ['flight', 'car_rental', 'ferry', 'train', 'ride'].includes(item.type));
            
            renderCards(DOM.hotelContainer, hotels, createHotelCard);
            renderCards(DOM.transportContainer, transports, createTransportCard);
            renderSummaryTables();
        }

        function setupAuthUI(user) {
            const userDocRef = doc(db, `artifacts/${appId}/users`, user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? docSnap.data().name : '××•×¨×—';
                DOM.authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${name} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500 transition-colors"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
                document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
            });
        }

        function buildSidebarMenu() {
            DOM.mainMenu.innerHTML = '';
            if (!tripData || !tripData.destinations) return;

            tripData.destinations.forEach(dest => {
                const destinationDiv = document.createElement('div');
                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
                button.innerHTML = `<span>${dest.nameHe}</span> <i class="fas fa-chevron-down chevron-icon transition-transform"></i>`;
                
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200 transition-all duration-300 overflow-hidden max-h-0';
                
                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dateStr => {
                    const dayLink = document.createElement('a');
                    dayLink.href = `daily-schedule.html?tripId=${tripId}&date=${dateStr}`;
                    dayLink.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md transition-colors';
                    dayLink.textContent = `×œ×•"×– ×œ×™×•× ${dateStr}`;
                    submenu.appendChild(dayLink);
                });

                button.addEventListener('click', () => {
                    submenu.classList.toggle('max-h-0');
                    button.querySelector('i').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }
        
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const [startDay, startMonth, startYear] = startStr.split('/').map(Number);
            const [endDay, endMonth, endYear] = endStr.split('/').map(Number);
            
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                dates.push(currentDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit', year: 'numeric'}));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        // --- Card Creation ---
        function renderCards(container, items, cardCreator) {
            container.innerHTML = '';
            if (items.length === 0) {
                container.innerHTML = `<div class="text-center bg-white/30 backdrop-blur-sm p-8 rounded-xl col-span-full"><p class="text-white text-lg drop-shadow">×¢×“×™×™×Ÿ ×œ× × ×•×¡×¤×• ×¤×¨×™×˜×™× ×‘×§×˜×’×•×¨×™×” ×–×•. ×œ×—×¦×• ×¢×œ '×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×•×’×™×¡×˜×™' ×›×“×™ ×œ×”×ª×—×™×œ!</p></div>`;
                return;
            }
            items.sort((a,b) => (a.createdAt?.seconds || 0) - (b.createdAt?.seconds || 0)).forEach(item => {
                const card = cardCreator(item);
                container.appendChild(card);
            });
        }

        function createHotelCard(item) {
            const card = document.createElement('div');
            card.className = "card p-5 flex flex-col justify-between";
            card.dataset.id = item.id;
            card.dataset.action = 'view-details';

            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <div class="icon-chip bg-blue-100 border-blue-200"><i class="fas fa-hotel fa-lg text-blue-600"></i></div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-lg text-slate-800">${item.name || '××œ×•×Ÿ ×œ×œ× ×©×'}</h4>
                            <p class="text-sm text-slate-500 truncate">${item.destination || ''}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-btn text-slate-400 hover:text-blue-500 action-button" data-id="${item.id}" title="×¢×¨×™×›×”"><i class="fas fa-pencil"></i></button>
                        <button class="delete-btn text-slate-400 hover:text-red-500 action-button" data-id="${item.id}" data-name="${item.name || '××œ×•×Ÿ'}" title="××—×™×§×”"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="mt-4 flex flex-col gap-2 text-sm text-slate-600">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-calendar-days fa-fw text-sky-500"></i> <span>${item.dates || '×œ× ×¦×•×™×Ÿ ×ª××¨×™×š'}</span></div>
                    <div class="flex items-center gap-2"><i class="fa-solid fa-tag fa-fw text-green-500"></i> <span>××—×™×¨: <strong class="font-mono text-slate-800">$${(item.price || 0).toLocaleString()}</strong></span></div>
                </div>
                <div class="mt-auto pt-4 border-t text-center">
                   <span class="text-sm text-blue-600 font-semibold">×œ×—×¥ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×...</span>
                </div>`;
            return card;
        }

        function createTransportCard(item) {
            const card = document.createElement('div');
            card.className = "card p-5 flex flex-col justify-between";
            card.dataset.id = item.id;
            card.dataset.action = 'view-details';

            let title, icon, subtitle;
            let extraChip = '';

            switch (item.type) {
                case 'flight':
                    title = `×˜×™×¡×”`;
                    icon = 'fa-plane-departure';
                    subtitle = `${item.from?.destination || '?'} â† ${item.to?.destination || '?'}`;
                    break;
                case 'car_rental':
                    title = `×¨×›×‘ ×©×›×•×¨`;
                    icon = 'fa-car';
                    subtitle = `×‘${item.destination || ''}`;
                    break;
                case 'ferry':
                    title = `××¢×‘×•×¨×ª`;
                    icon = 'fa-ship';
                    subtitle = `${item.from_destination || '?'} â† ${item.to_destination || '?'}`;
                    break;
                case 'train':
                    title = `×¨×›×‘×ª`;
                    icon = 'fa-train';
                    subtitle = `${item.from_station || '?'} â† ${item.to_station || '?'}`;
                    break;
                case 'ride':
                    title = `×”×¡×¢×” / ××•× ×™×ª`;
                    icon = 'fa-taxi';
                    subtitle = `×${item.from_address?.split(',')[0] || '?'}`;
                    if (item.vehicle_number) {
                        extraChip = `<div class="vehicle-number-chip"><i class="fa-solid fa-car-side"></i> ${item.vehicle_number}</div>`;
                    }
                    break;
                default:
                    title = "××¢×‘×¨";
                    icon = 'fa-question';
                    subtitle = '';
            }

            const price = item.type === 'flight' ? (item.price_per_person * (item.seats?.length || 1)) : (item.price || 0);

            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div class="flex items-center gap-3">
                        <div class="icon-chip bg-emerald-100 border-emerald-200"><i class="fas ${icon} fa-lg text-emerald-600"></i></div>
                        <div class="min-w-0">
                            <h4 class="font-bold text-lg text-slate-800">${title}</h4>
                            <p class="text-sm text-slate-500 truncate">${subtitle}</p>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button class="edit-btn text-slate-400 hover:text-blue-500 action-button" data-id="${item.id}" title="×¢×¨×™×›×”"><i class="fas fa-pencil"></i></button>
                        <button class="delete-btn text-slate-400 hover:text-red-500 action-button" data-id="${item.id}" data-name="${title}" title="××—×™×§×”"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="mt-4 flex flex-col gap-2 text-sm text-slate-600">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-calendar-days fa-fw text-sky-500"></i> <span>${item.dates || item.date || '×œ× ×¦×•×™×Ÿ ×ª××¨×™×š'}</span></div>
                    <div class="flex items-center gap-2"><i class="fa-solid fa-tag fa-fw text-green-500"></i> <span>××—×™×¨: <strong class="font-mono text-slate-800">$${price.toLocaleString()}</strong></span></div>
                </div>
                <div class="flex justify-between items-center mt-auto pt-4 border-t text-center">
                    <span class="text-sm text-blue-600 font-semibold">×œ×—×¥ ×œ×¤×¨×˜×™× × ×•×¡×¤×™×...</span>
                    ${extraChip}
                </div>`;
            return card;
        }

        // --- Modal Logic ---
        
        function resetModalState() {
            Object.values(modalState.maps).forEach(map => map.remove());
            if (modalState.datePicker) modalState.datePicker.destroy();
            modalState = {
                mainType: null, subType: null, currentStep: 1, data: {},
                maps: {}, mapLayers: {}, datePicker: null,
            };
            editingItem = null;
        }

        function openModal(itemToEdit = null) {
            resetModalState();
            if (itemToEdit) {
                DOM.modalTitle.textContent = '×¢×¨×™×›×ª ×¤×¨×™×˜';
                editingItem = { id: itemToEdit.id };
                modalState.mainType = (itemToEdit.type === 'hotel') ? 'hotel' : 'transport';
                modalState.subType = ['flight', 'car_rental', 'ferry', 'train', 'ride'].includes(itemToEdit.type) ? itemToEdit.type : null;
                modalState.data = JSON.parse(JSON.stringify(itemToEdit));
                
                if (modalState.data.type === 'ride' && modalState.data.route_geometry && typeof modalState.data.route_geometry === 'string') {
                    try {
                        modalState.data.route_geometry = JSON.parse(modalState.data.route_geometry);
                    } catch (e) {
                        console.error("Failed to parse route geometry:", e);
                        delete modalState.data.route_geometry;
                    }
                }
            } else {
                DOM.modalTitle.textContent = '×”×•×¡×¤×ª ×¤×¨×™×˜ ×—×“×©';
            }
            
            generateStepContent();
            updateModalNav();
            
            DOM.modal.classList.remove('hidden');
            setTimeout(() => {
                DOM.modal.classList.remove('opacity-0');
                DOM.modal.querySelector('.modal-content-container').classList.remove('scale-95');
                initializeFieldPlugins();
                setTimeout(() => {
                    Object.values(modalState.maps).forEach(map => map?.invalidateSize());
                }, 100);
            }, 10);
        }

        function closeModal() {
            DOM.modal.classList.add('opacity-0');
            DOM.modal.querySelector('.modal-content-container').classList.add('scale-95');
            setTimeout(() => {
                DOM.modal.classList.add('hidden');
                resetModalState();
            }, 300);
        }
        
        function getStepDefinition() {
            const steps = {
                start: { title: "××™×–×” ×¤×¨×™×˜ ×œ×”×•×¡×™×£?", fields: [{ id: 'mainType', type: 'radio', options: [{value: 'hotel', label: 'ğŸ¨ ××œ×•×Ÿ'}, {value: 'transport', label: 'âœˆï¸ ××¢×‘×¨'}] }] },
                hotel: [
                    { title: "×¤×¨×˜×™ ×”××œ×•×Ÿ", fields: [{id: 'name', label: '×©× ×”××œ×•×Ÿ'}, {id: 'booked_via', label: '×”×•×–××Ÿ ×“×¨×š?'}] },
                    { title: "×ª××¨×™×›×™× ×•××—×™×¨", fields: [{id: 'dates', label: '×ª××¨×™×š ×¦\'×§-××™×Ÿ ×•×¦\'×§-×××•×˜', type: 'daterange'}, {id: 'price', label: '××—×™×¨ ×›×•×œ×œ (×‘×“×•×œ×¨×™×)', type: 'number'}] },
                    { title: "××™×§×•× ×”××œ×•×Ÿ", fields: [
                        {id: 'destination', label: '×™×¢×“ (×¢×™×¨, ××–×•×¨)', type: 'text'},
                        {id: 'address', label: '×›×ª×•×‘×ª ××“×•×™×§×ª', type: 'addressmap'}
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        {id: 'link', label: '×§×™×©×•×¨ ×œ××ª×¨ (×‘×•×§×™× ×’ ×•×›×•\')', type: 'url'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
                    ]},
                ],
                transport: { title: "××™×–×” ×¡×•×’ ××¢×‘×¨?", fields: [{ id: 'subType', type: 'radio', options: [
                    {value: 'flight', label: 'âœˆï¸ ×˜×™×¡×”'}, 
                    {value: 'car_rental', label: 'ğŸš— ×¨×›×‘ ×©×›×•×¨'},
                    {value: 'ride', label: 'ğŸš• ××•× ×™×ª/×”×¡×¢×”'},
                    {value: 'ferry', label: 'ğŸš¢ ××¢×‘×•×¨×ª'},
                    {value: 'train', label: 'ğŸš† ×¨×›×‘×ª'}
                ] }] },
                ride: [
                    { title: "××¡×œ×•×œ ×”× ×¡×™×¢×”", fields: [{ id: 'routemap', type: 'routemap'}] },
                    { title: "×¤×¨×˜×™ ×”×–×× ×”", fields: [
                        { id: 'booked_via', label: '×××™×¤×” ×”×•×–××Ÿ?'},
                        { id: 'company', label: '×—×‘×¨×ª ×”×”×¡×¢×•×ª/××•× ×™×•×ª'}
                    ]},
                    { title: "×¤×¨×˜×™× ×œ×•×’×™×¡×˜×™×™×", fields: [
                        { id: 'date', label: '×ª××¨×™×š × ×¡×™×¢×”', type: 'date' },
                        { id: 'pickup_time', label: '×©×¢×ª ××™×¡×•×£', type: 'time'},
                        { id: 'driver_name', label: '×©× ×”× ×”×’ (××•×¤×¦×™×•× ×œ×™)'},
                        { id: 'driver_phone', label: '×˜×œ×¤×•×Ÿ ×”× ×”×’ (××•×¤×¦×™×•× ×œ×™)', type: 'tel'},
                        { id: 'vehicle_number', label: '××¡×¤×¨ ×¨×›×‘ (××•×¤×¦×™×•× ×œ×™)'},
                        { id: 'vehicle_details', label: '×¤×¨×˜×™ ×”×¨×›×‘ (×œ×“×•×’××”: ××¨×¦×“×¡ ×©×—×•×¨×”)', type: 'text'},
                        { id: 'price', label: '××—×™×¨ (×‘×“×•×œ×¨×™×, 0 ×× ×—×™× ×)', type: 'number'},
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        { id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (×”×¢×¨×•×ª, × ×§×•×“×ª ××¤×’×© ×•×›×•\')', type: 'textarea'}
                    ]}
                ],
                car_rental: [
                    { title: "×¤×¨×˜×™ ×”×©×›×¨×ª ×”×¨×›×‘", fields: [
                        {id: 'destination', label: '×œ××™×–×” ×™×¢×“?', type: 'text'},
                        {id: 'booked_via', label: '×“×¨×š ××™×¤×” ×”×•×–××Ÿ?'},
                        {id: 'pickup_location', label: '×××™×¤×” ×œ×•×§×—×™× ×‘×“×™×•×§?', type: 'text_autocomplete'},
                    ]},
                    { title: "×ª××¨×™×›×™× ×•×¡×•×’", fields: [
                        {id: 'dates', label: '×ª××¨×™×›×™ ××™×¡×•×£ ×•×”×—×–×¨×”', type: 'daterange'},
                        {id: 'pickup_time', label: '×©×¢×ª ××™×¡×•×£', type: 'time'},
                        {id: 'return_time', label: '×©×¢×ª ×”×—×–×¨×”', type: 'time'},
                        {id: 'car_type', label: '×¡×•×’ ×¨×›×‘', type: 'text', placeholder: '×œ×“×•×’××”: SUV, ××™× ×™'},
                    ]},
                    { title: "×¢×œ×•×ª ×•×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        {id: 'price', label: '××—×™×¨ (×‘×“×•×œ×¨×™×)', type: 'number'},
                        {id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
                    ]}
                ],
                flight: [
                    { title: "××¡×œ×•×œ ×”×˜×™×¡×”", fields: [ { id: 'flightroute', type: 'flightroute'} ]},
                    { title: "×¤×¨×˜×™ ×”×˜×™×¡×”", fields: [
                        { id: 'airline', label: '×—×‘×¨×ª ×ª×¢×•×¤×”' },
                        { id: 'flight_number', label: '××¡×¤×¨ ×˜×™×¡×”'},
                        { id: 'dates', label: '×ª××¨×™×š ×˜×™×¡×”', type: 'date' },
                        { id: 'departure_time', label: '×©×¢×ª ×”××¨××” (×©×¢×•×Ÿ ××§×•××™ ×™×¦×™××”)', type: 'time' },
                        { id: 'arrival_time', label: '×©×¢×ª × ×—×™×ª×” (×©×¢×•×Ÿ ××§×•××™ ×™×¢×“)', type: 'time' },
                        { id: 'price_per_person', label: '××—×™×¨ ×œ××“× (×‘×“×•×œ×¨×™×)', type: 'number' },
                    ]},
                    { title: "×›×‘×•×“×”, ×™×©×™×‘×” ×•×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [ 
                        { id: 'luggage', type: 'luggage' }, 
                        { id: 'seats', type: 'seats' },
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××•×¤×¦×™×•× ×œ×™)', type: 'textarea'}
                    ]}
                ],
                ferry: [
                    { title: "×¤×¨×˜×™ ×”××¢×‘×•×¨×ª", fields: [
                        { id: 'company', label: '×—×‘×¨×” ××¤×¢×™×œ×”' },
                        { id: 'from_destination', label: '× ×§×•×“×ª ×™×¦×™××”', type: 'text_autocomplete' },
                        { id: 'to_destination', label: '× ×§×•×“×ª ×”×’×¢×”', type: 'text_autocomplete' },
                    ]},
                    { title: "×ª××¨×™×›×™× ×•×¢×œ×•×ª", fields: [
                        { id: 'date', label: '×ª××¨×™×š', type: 'date' },
                        { id: 'departure_time', label: '×©×¢×ª ×™×¦×™××”', type: 'time' },
                        { id: 'arrival_time', label: '×©×¢×ª ×”×’×¢×” ××©×•×¢×¨×ª', type: 'time' },
                        { id: 'price', label: '××—×™×¨ ×›×•×œ×œ (×‘×“×•×œ×¨×™×)', type: 'number' },
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (×¡×•×’ ×›×¨×˜×™×¡, ×¡×™×¤×•×Ÿ ×•×›×•\')', type: 'textarea'}
                    ]}
                ],
                train: [
                    { title: "×¤×¨×˜×™ ×”×¨×›×‘×ª", fields: [
                        { id: 'company', label: '×—×‘×¨×” ××¤×¢×™×œ×”' },
                        { id: 'from_station', label: '×ª×—× ×ª ×™×¦×™××”', type: 'text_autocomplete' },
                        { id: 'to_station', label: '×ª×—× ×ª ×”×’×¢×”', type: 'text_autocomplete' },
                    ]},
                    { title: "×ª××¨×™×›×™× ×•×¢×œ×•×ª", fields: [
                        { id: 'date', label: '×ª××¨×™×š', type: 'date' },
                        { id: 'departure_time', label: '×©×¢×ª ×™×¦×™××”', type: 'time' },
                        { id: 'arrival_time', label: '×©×¢×ª ×”×’×¢×” ××©×•×¢×¨×ª', type: 'time' },
                        { id: 'price', label: '××—×™×¨ ×›×•×œ×œ (×‘×“×•×œ×¨×™×)', type: 'number' },
                    ]},
                    { title: "×¤×¨×˜×™× × ×•×¡×¤×™×", fields: [
                        { id: 'booking_link', label: '×§×™×©×•×¨ ×œ×”×–×× ×” (××•×¤×¦×™×•× ×œ×™)', type: 'url'},
                        { id: 'seat_info', label: '×¤×¨×˜×™ ××•×©×‘×™× (××•×¤×¦×™×•× ×œ×™)', type: 'text'},
                        {id: 'additional_details', label: '×¤×™×¨×•×˜ × ×•×¡×£ (××—×œ×§×”, ×§×¨×•×Ÿ ×•×›×•\')', type: 'textarea'}
                    ]}
                ]
            };
            
            if (editingItem) return steps[modalState.subType || modalState.mainType];
            if (!modalState.mainType) return [steps.start];
            if (modalState.mainType === 'hotel') return steps.hotel;
            if (modalState.mainType === 'transport' && !modalState.subType) return [steps.transport];
            if (modalState.subType) return steps[modalState.subType];
            return [];
        }

        function generateStepContent() {
            const stepDefinitions = getStepDefinition();
            if (!stepDefinitions || stepDefinitions.length === 0) {
                DOM.modalForm.innerHTML = `<p class="text-center text-red-500">×©×’×™××”: ×œ× × ××¦××• ×©×œ×‘×™× ×œ×”×’×“×¨×”.</p>`;
                return;
            }

            const currentStepIndex = modalState.currentStep - 1;
            const stepDef = stepDefinitions[currentStepIndex];
            
            if (!stepDef) {
                console.error("Invalid step definition for step:", modalState.currentStep);
                DOM.modalForm.innerHTML = `<p class="text-center text-red-500">×©×’×™××”: ×©×œ×‘ ×œ× ×ª×§×™×Ÿ.</p>`;
                return;
            }

            let html = `<div class="modal-step active" data-step="${modalState.currentStep}">
                <h4 class="text-xl font-bold text-slate-800 mb-6">${stepDef.title}</h4>`;
            
            stepDef.fields.forEach(field => {
                html += `<div class="mb-4">${renderField(field)}</div>`;
            });
            html += `</div>`;
            DOM.modalForm.innerHTML = html;
        }
        
        const debounce = (func, delay) => {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        };
        const debouncedAutocomplete = debounce(handleAddressAutocomplete, 300);

        function renderAutocompleteAddressInput(id, label) {
            const value = modalState.data[id] || '';
            return `
            <div class="relative">
                <label class="block"><span class="text-sm font-semibold text-slate-600">${label}</span>
                    <div class="flex items-center mt-1">
                        <input type="text" id="${id}" value="${value}" class="block w-full p-2 border rounded-md" placeholder="×”×ª×—×œ ×œ×”×§×œ×™×“ ×›×ª×•×‘×ª..." oninput="window.debouncedAutocomplete(event)" autocomplete="off">
                    </div>
                </label>
                <div id="${id}-suggestions" class="autocomplete-suggestions"></div>
            </div>`;
        }

        function renderField(field) {
            const value = modalState.data[field.id] || '';
            
            switch(field.type) {
                case 'radio':
                    return `<div class="space-y-2">
                        <label class="block text-sm font-semibold text-slate-600">${field.label || ''}</label>
                        <div class="flex flex-wrap gap-4">${field.options.map(opt => `
                            <label class="flex items-center gap-2 p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500 transition-colors">
                                <input type="radio" id="${field.id}-${opt.value || opt}" name="${field.id}" value="${opt.value || opt}" ${ (opt.value || opt) === value ? 'checked' : ''} class="form-radio">
                                <span>${opt.label || opt}</span>
                            </label>`).join('')}
                        </div></div>`;
                case 'textarea':
                    return `<label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
                                <textarea id="${field.id}" class="mt-1 block w-full p-2 border rounded-md shadow-sm" rows="3">${modalState.data[field.id] || ''}</textarea>
                                </label>`;
                case 'addressmap':
                    return `<div>
                        ${renderAutocompleteAddressInput(field.id, field.label)}
                        <button type="button" data-action="find-address" class="mt-2 px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-700 w-full text-center">××¦× ×›×ª×•×‘×ª ×¢×œ ×”××¤×”</button>
                        <div id="map-container" class="mt-4 small-map-container"></div>
                    </div>`;
                case 'text_autocomplete':
                    return renderAutocompleteAddressInput(field.id, field.label);
                case 'routemap':
                    return `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            ${renderAutocompleteAddressInput('from_address', '×××™×¤×”?')}
                            ${renderAutocompleteAddressInput('to_address', '×œ××™×¤×”?')}
                        </div>
                        <div class="text-center my-4">
                           <button type="button" data-action="calculate-ride-route" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">×—×©×‘ ××¡×œ×•×œ</button>
                        </div>
                        <div class="grid grid-cols-2 gap-4 text-center bg-slate-100 p-2 rounded-lg">
                            <div><p class="text-sm text-slate-500">×–××Ÿ × ×¡×™×¢×”</p><p id="route-duration" class="font-bold text-lg">${formatDuration(modalState.data.route_duration)}</p></div>
                            <div><p class="text-sm text-slate-500">××¨×—×§</p><p id="route-distance" class="font-bold text-lg">${formatDistance(modalState.data.route_distance)}</p></div>
                        </div>
                        <div id="map-ride-route" class="mt-4 final-map-container"></div>`;
                case 'flightroute':
                    return `
                        <div class="space-y-4">
                            ${renderFlightLeg('from', '×××™×¤×”?', modalState.data, '×××™×–×• ×¢×™×¨ ×××¨×™××™×?')}
                            ${renderFlightLeg('to', '×œ××™×¤×”?', modalState.data, '×‘××™×–×• ×¢×™×¨ × ×•×—×ª×™×?')}
                            <div id="connections-container" class="space-y-4">${(modalState.data.connections || []).map((conn, i) => renderFlightLeg(`connection-${i}`, `×§×•× ×§×©×Ÿ ${i+1}`, conn)).join('')}</div>
                            <button type="button" id="add-connection-btn" class="text-sm text-blue-600 hover:underline"><i class="fas fa-plus ml-1"></i>×”×•×¡×£ ×§×•× ×§×©×Ÿ</button>
                            <hr class="my-6"/>
                            <h5 class="text-lg font-bold text-slate-700">××¤×ª ××¡×œ×•×œ ××¡×›××ª</h5>
                            <div class="text-center">
                                <button type="button" id="calculate-final-route-btn" class="px-4 py-2 bg-sky-600 text-white rounded-md hover:bg-sky-700">×”×¦×’ ××¡×œ×•×œ ××œ×</button>
                            </div>
                            <div id="map-final-route" class="mt-4 final-map-container"></div>
                        </div>`;
                case 'luggage':
                    return `<fieldset class="border p-4 rounded-lg">
                        <legend class="px-2 font-semibold">×¤×¨×˜×™ ×›×‘×•×“×” (×œ× ×•×¡×¢)</legend>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <label><span class="text-sm font-semibold text-slate-600">×ª×™×§×™ ×™×“</span><input type="number" id="hand_bag_count" value="${modalState.data.hand_bag_count || 1}" class="mt-1 block w-full p-2 border rounded-md"></label>
                            <label><span class="text-sm font-semibold text-slate-600">×˜×¨×•×œ×™ (×›××•×ª)</span><input type="number" id="trolley_count" value="${modalState.data.trolley_count || 1}" class="mt-1 block w-full p-2 border rounded-md"></label>
                            <label><span class="text-sm font-semibold text-slate-600">××–×•×•×“×•×ª (×›××•×ª)</span><input type="number" id="checked_bags_count" value="${modalState.data.checked_bags_count || 1}" class="mt-1 block w-full p-2 border rounded-md"></label>
                        </div>
                    </fieldset>`;
                case 'seats':
                    return `<fieldset class="border p-4 rounded-lg">
                        <legend class="px-2 font-semibold">××§×•××•×ª ×™×©×™×‘×”</legend>
                        <div id="seats-container" class="flex flex-wrap gap-2"></div>
                        <button type="button" id="add-seat-btn" class="mt-2 text-sm text-blue-600 hover:underline"><i class="fas fa-plus ml-1"></i>×”×•×¡×£ ××§×•× ×™×©×™×‘×”</button>
                    </fieldset>`;
                case 'daterange':
                case 'date':
                    return `<label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
                                <input type="text" id="${field.id}" value="${value}" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="×œ×—×¥ ×œ×‘×—×™×¨×ª ×ª××¨×™×›×™×">
                                </label>`;
                default:
                    return `<label class="block"><span class="text-sm font-semibold text-slate-600">${field.label}</span>
                                <input type="${field.type || 'text'}" id="${field.id}" value="${value}" class="mt-1 block w-full p-2 border rounded-md shadow-sm" placeholder="${field.placeholder || ''}">
                                </label>`;
            }
        }
        
        function renderFlightLeg(id, legend, data = {}, destinationLabel = '×™×¢×“') {
            let legData = {};
            if (id === 'from' || id === 'to') {
                legData = data[id] || {};
            } else if (id.startsWith('connection-')) {
                const index = parseInt(id.split('-')[1], 10);
                legData = data.connections?.[index] || {};
            }

            return `<fieldset class="border p-4 rounded-lg" id="fieldset-${id}">
                <legend class="px-2 font-semibold">${legend}</legend>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <label><span class="text-sm font-semibold text-slate-600">${destinationLabel}</span><input type="text" id="${id}_destination" value="${legData.destination || ''}" class="mt-1 block w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: × ×™×• ×™×•×¨×§"></label>
                    <label><span class="text-sm font-semibold text-slate-600">×©× ×©×“×” ×ª×¢×•×¤×”</span><input type="text" id="${id}_airport_name" value="${legData.airport_name || ''}" class="mt-1 block w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: JFK"></label>
                    <div class="md:col-span-2">
                                ${renderAutocompleteAddressInput(`${id}_airport_address`, '×›×ª×•×‘×ª ×©×“×” ×ª×¢×•×¤×”')}
                    </div>
                    <div class="md:col-span-2 text-center">
                        <button type="button" data-action="find-flight-leg" data-leg-id="${id}" class="px-4 py-2 bg-slate-600 text-white rounded-md hover:bg-slate-700">××¦× ×¢×œ ×”××¤×”</button>
                    </div>
                    <div id="map-${id}" class="mt-2 md:col-span-2 small-map-container"></div>
                </div>
            </fieldset>`;
        }

        function initializeFieldPlugins() {
            const dateInput = DOM.modalForm.querySelector('#dates, #date');
            if (dateInput) {
                const isSingle = dateInput.id === 'date' || modalState.subType === 'flight';
                modalState.datePicker = new Litepicker({ 
                    element: dateInput, 
                    singleMode: isSingle, 
                    format: 'DD/MM/YYYY' 
                });
            }
            
            if (document.getElementById('map-container')) initMap('map-container', 'hotel');
            if (document.querySelector('[id^="map-from"]')) initMap('map-from', 'from');
            if (document.querySelector('[id^="map-to"]')) initMap('map-to', 'to');
            (modalState.data.connections || []).forEach((conn, i) => initMap(`map-connection-${i}`, `connection-${i}`));
            if (document.querySelector('[id^="map-final-route"]')) initMap('map-final-route', 'final-route');
            if (document.getElementById('map-ride-route')) {
                initMap('map-ride-route', 'ride-route');
                if (modalState.data.route_geometry && Array.isArray(modalState.data.route_geometry)) {
                    drawRouteOnMap(modalState.maps['ride-route'], 'ride-route', modalState.data.route_geometry, modalState.data.from_coords, modalState.data.to_coords);
                }
            }
            
            if (document.getElementById('add-seat-btn')) {
                (modalState.data.seats || []).forEach(seat => addSeatInput(seat));
            }
        }
        
        function updateModalNav() {
            const stepDefinitions = getStepDefinition();
            const isLastStep = modalState.currentStep >= stepDefinitions.length;
            const isChoiceStep = !modalState.mainType || (modalState.mainType === 'transport' && !modalState.subType);

            DOM.modalBackBtn.classList.toggle('hidden', modalState.currentStep === 1 && isChoiceStep);
            DOM.modalNextBtn.classList.toggle('hidden', isLastStep && !isChoiceStep);
            DOM.modalFinishBtn.classList.toggle('hidden', !isLastStep || isChoiceStep);
        }

        function collectStepData() {
            const stepDefinitions = getStepDefinition();
            if (!stepDefinitions.length) return false;
            const stepDef = stepDefinitions[modalState.currentStep - 1];
            DOM.modalError.textContent = '';

            stepDef.fields.forEach(field => {
                let value;
                if (field.type === 'radio') {
                    const checked = document.querySelector(`input[name="${field.id}"]:checked`);
                    value = checked ? checked.value : null;
                } else if (field.type === 'routemap') {
                    modalState.data.from_address = document.getElementById('from_address').value;
                    modalState.data.to_address = document.getElementById('to_address').value;
                    return; 
                } else if (field.type === 'flightroute') {
                    const collectLegData = (legId, existingData = {}) => ({
                        destination: document.getElementById(`${legId}_destination`)?.value,
                        airport_name: document.getElementById(`${legId}_airport_name`)?.value,
                        airport_address: document.getElementById(`${legId}_airport_address`)?.value,
                        coords: existingData.coords,
                    });
                    
                    modalState.data.from = collectLegData('from', modalState.data.from);
                    modalState.data.to = collectLegData('to', modalState.data.to);
                    modalState.data.connections = (modalState.data.connections || []).map((conn, i) => collectLegData(`connection-${i}`, conn));
                    return;
                } else if (field.type === 'luggage') {
                    modalState.data.hand_bag_count = document.getElementById('hand_bag_count').value;
                    modalState.data.trolley_count = document.getElementById('trolley_count').value;
                    modalState.data.checked_bags_count = document.getElementById('checked_bags_count').value;
                    return;
                } else if (field.type === 'seats') {
                    modalState.data.seats = Array.from(document.querySelectorAll('.seat-input-wrapper input')).map(i => i.value).filter(Boolean);
                    return;
                }
                else {
                    const input = document.getElementById(field.id);
                    if (input) {
                        value = field.type === 'number' ? parseFloat(input.value) || 0 : input.value;
                    }
                }
                
                if (field.id) modalState.data[field.id] = value;
            });
            
            if (!modalState.mainType) modalState.mainType = modalState.data.mainType;
            if (modalState.mainType === 'transport' && !modalState.subType) modalState.subType = modalState.data.subType;
            
            return true;
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            if (!collectStepData()) return;

            const finalData = { ...modalState.data };
            finalData.type = modalState.subType || modalState.mainType;
            
            if (finalData.type === 'ride' && finalData.route_geometry && Array.isArray(finalData.route_geometry)) {
                finalData.route_geometry = JSON.stringify(finalData.route_geometry);
            }
            
            delete finalData.mainType;
            delete finalData.subType;

            const cleanDataForFirebase = (obj) => {
                if (obj === null || obj === undefined) return null;
                if (Array.isArray(obj)) return obj.map(item => cleanDataForFirebase(item));
                if (typeof obj !== 'object' || obj instanceof Date) return obj;

                const newObj = {};
                for (const key in obj) {
                    if (Object.prototype.hasOwnProperty.call(obj, key)) {
                        const value = obj[key];
                        if (value !== undefined) {
                            newObj[key] = cleanDataForFirebase(value);
                        }
                    }
                }
                return newObj;
            };
            const cleanedData = cleanDataForFirebase(finalData);

            try {
                const logisticsCollectionRef = collection(db, `artifacts/${appId}/public/data/trips/${tripId}/logistics`);
                if (editingItem && editingItem.id) {
                    await updateDoc(doc(logisticsCollectionRef, editingItem.id), cleanedData);
                } else {
                    cleanedData.createdAt = serverTimestamp();
                    await addDoc(logisticsCollectionRef, cleanedData);
                }
                closeModal();
            } catch (err) {
                console.error("Error saving document:", err);
                DOM.modalError.textContent = '×©×’×™××” ×‘×©××™×¨×ª ×”×¤×¨×™×˜.';
            }
        }
        
        // --- Map & Geocoding & Routing Logic ---
        function initMap(containerId, mapKey) {
            if (modalState.maps[mapKey]) modalState.maps[mapKey].remove();
            const mapContainer = document.getElementById(containerId);
            if (!mapContainer) return;

            const map = L.map(containerId).setView([31.7683, 35.2137], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            modalState.maps[mapKey] = map;
            modalState.mapLayers[mapKey] = L.layerGroup().addTo(map);
        }

        async function geocodeAddress(address) {
            if (!address) return { success: false, message: '×œ× ×”×•×–× ×” ×›×ª×•×‘×ª.' };
            const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`;
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 8000);

            try {
                const response = await fetch(url, { 
                    signal: controller.signal,
                    headers: { 'Accept-Language': 'en' }
                });
                const data = await response.json();
                if (data && data.length > 0) {
                    return { success: true, coords: { lat: parseFloat(data[0].lat), lon: parseFloat(data[0].lon) } };
                } else {
                    return { success: false, message: '×”×›×ª×•×‘×ª ×œ× × ××¦××”.' };
                }
            } catch (error) {
                if (error.name === 'AbortError') {
                    return { success: false, message: '×”×—×™×¤×•×© ××¨×š ×–××Ÿ ×¨×‘ ××“×™.' };
                } else {
                    console.error('Geocoding error:', error);
                    return { success: false, message: '×©×’×™××ª ×¨×©×ª ×‘×—×™×¤×•×©.' };
                }
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function findAddressOnMap(mapKey, address) {
            DOM.modalError.textContent = '××—×¤×©...';
            const result = await geocodeAddress(address);
            const map = modalState.maps[mapKey];
            const layerGroup = modalState.mapLayers[mapKey];

            if (result.success && map && layerGroup) {
                DOM.modalError.textContent = '';
                const coords = { lat: result.coords.lat, lng: result.coords.lon };
                map.setView(coords, 13);
                layerGroup.clearLayers();
                
                L.marker(coords).addTo(layerGroup);
                
                const legId = mapKey;
                if (legId === 'from' || legId === 'to') {
                    if (!modalState.data[legId]) modalState.data[legId] = {};
                    modalState.data[legId].coords = coords;
                } else if (legId.startsWith('connection-')) {
                    const index = parseInt(legId.split('-')[1], 10);
                    if (modalState.data.connections && modalState.data.connections[index]) {
                        modalState.data.connections[index].coords = coords;
                    }
                } else {
                    modalState.data.coords = coords;
                }
            } else {
                DOM.modalError.textContent = result.message;
                
                const legId = mapKey;
                if (legId === 'from' || legId === 'to') {
                    if (modalState.data[legId]) delete modalState.data[legId].coords;
                } else if (legId.startsWith('connection-')) {
                    const index = parseInt(legId.split('-')[1], 10);
                    if (modalState.data.connections?.[index]) {
                        delete modalState.data.connections[index].coords;
                    }
                } else {
                   if (modalState.data.coords) delete modalState.data.coords;
                }
            }
        }
        
        async function fetchRoute(startCoords, endCoords) {
            const url = `https://router.project-osrm.org/route/v1/driving/${startCoords.lon},${startCoords.lat};${endCoords.lon},${endCoords.lat}?overview=full&geometries=geojson`;
            try {
                const response = await fetch(url);
                const data = await response.json();
                if (data.code === 'Ok' && data.routes.length > 0) {
                    const route = data.routes[0];
                    return {
                        success: true,
                        geometry: route.geometry.coordinates.map(c => [c[1], c[0]]),
                        duration: route.duration,
                        distance: route.distance,
                    };
                } else {
                    return { success: false, message: '×œ× × ××¦× ××¡×œ×•×œ.' };
                }
            } catch (error) {
                console.error("Routing error:", error);
                return { success: false, message: '×©×’×™××ª ×¨×©×ª ×‘×—×™×©×•×‘ ×”××¡×œ×•×œ.' };
            }
        }
        
        function drawRouteOnMap(map, mapKey, geometry, startCoords, endCoords) {
            const layerGroup = modalState.mapLayers[mapKey];
            if (!map || !layerGroup) return;

            layerGroup.clearLayers();
            const latlngs = geometry.map(coord => L.latLng(coord[0], coord[1]));
            
            if (startCoords) L.marker([startCoords.lat, startCoords.lon]).addTo(layerGroup).bindPopup('×”×ª×—×œ×”');
            if (endCoords) L.marker([endCoords.lat, endCoords.lon]).addTo(layerGroup).bindPopup('×¡×™×•×');

            const polyline = L.polyline(latlngs, {color: '#3b82f6', weight: 5}).addTo(layerGroup);
            map.fitBounds(polyline.getBounds(), {padding: [20, 20]});
        }

        function showFinalRouteOnMap() {
            const finalMap = modalState.maps['final-route'];
            const finalLayers = modalState.mapLayers['final-route'];
            if (!finalMap || !finalLayers) return;
            
            collectStepData(); 

            finalLayers.clearLayers();

            const points = [];
            const allLegs = [modalState.data.from, ...(modalState.data.connections || []), modalState.data.to];
            
            allLegs.forEach(leg => {
                if (leg && leg.coords) {
                    const coords = [leg.coords.lat, leg.coords.lng || leg.coords.lon];
                    points.push(coords);
                    L.marker(coords).addTo(finalLayers);
                }
            });

            if (points.length > 0) {
                finalMap.fitBounds(points, { padding: [50, 50] });
                if (points.length > 1) {
                    const polyline = L.polyline(points, {color: '#3b82f6', weight: 3, dashArray: '10, 10'}).addTo(finalLayers);
                    L.polylineDecorator(polyline, {
                        patterns: [
                            { offset: 25, repeat: 50, symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { fillOpacity: 1, weight: 0, color: '#3b82f6' } }) }
                        ]
                    }).addTo(finalLayers);
                }
            }
        }

        // --- Dynamic Form Elements ---
        function addConnection() {
            if (!modalState.data.connections) modalState.data.connections = [];
            const index = modalState.data.connections.length;
            modalState.data.connections.push({});
            
            const container = document.getElementById('connections-container');
            const legHtml = renderFlightLeg(`connection-${index}`, `×§×•× ×§×©×Ÿ ${index + 1}`);
            const div = document.createElement('div');
            div.innerHTML = legHtml;
            container.appendChild(div.firstChild);
            
            initMap(`map-connection-${index}`, `connection-${index}`);
            setTimeout(() => modalState.maps[`connection-${index}`]?.invalidateSize(), 10);
        }

        function addSeatInput(value = '') {
            const container = document.getElementById('seats-container');
            if (!container) return;
            const wrapper = document.createElement('div');
            wrapper.className = 'seat-input-wrapper flex items-center gap-2';
            wrapper.innerHTML = `
                <input type="text" class="p-2 border rounded-md w-24" placeholder="×œ×“×•×’××”: A40" value="${value}">
                <button type="button" class="remove-seat-btn text-red-500 hover:text-red-700 text-xl font-bold">Ã—</button>
            `;
            wrapper.querySelector('.remove-seat-btn').addEventListener('click', () => wrapper.remove());
            container.appendChild(wrapper);
        }
        
        // --- Delete/Details Modals ---
        function handleDelete(id, name) {
            itemToDelete = { id, name };
            DOM.deleteModalTitle.textContent = `×”×× ×œ××—×•×§ ××ª "${name}"?`;
            
            DOM.deleteModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.deleteModal.classList.remove('opacity-0');
                DOM.deleteModal.querySelector('.modal-content-container').classList.remove('scale-95');
            }, 10);
        }

        async function confirmDeletion() {
            if (!itemToDelete) return;
            try {
                await deleteDoc(doc(db, `artifacts/${appId}/public/data/trips/${tripId}/logistics`, itemToDelete.id));
            } catch (error) {
                console.error("Failed to delete item:", error);
            } finally {
                closeDeleteModal();
            }
        }

        function closeDeleteModal() {
            DOM.deleteModal.classList.add('opacity-0');
            DOM.deleteModal.querySelector('.modal-content-container').classList.add('scale-95');
            setTimeout(() => {
                DOM.deleteModal.classList.add('hidden');
                itemToDelete = null;
            }, 300);
        }
        
        function openDetailsModal(item) {
            let contentHtml = '';
            contentHtml += `
                <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                    <h3 id="details-modal-title" class="text-2xl font-bold text-slate-800">×¤×¨×˜×™ ×¤×¨×™×˜</h3>
                    <button id="details-modal-close-btn" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <div class="flex-grow overflow-y-auto p-6 space-y-6 custom-scrollbar">`;

            switch(item.type) {
                case 'hotel': contentHtml += generateHotelDetailsHTML(item); break;
                case 'ride': contentHtml += generateRideDetailsHTML(item); break;
                case 'flight': contentHtml += generateFlightDetailsHTML(item); break;
                case 'car_rental': contentHtml += generateCarRentalDetailsHTML(item); break;
                case 'ferry': contentHtml += generateFerryDetailsHTML(item); break;
                case 'train': contentHtml += generateTrainDetailsHTML(item); break;
                default: contentHtml += `<p class="text-center text-slate-500">××™×Ÿ ×ª×¦×•×’×” ××¤×•×¨×˜×ª ×¢×‘×•×¨ ×¡×•×’ ×¤×¨×™×˜ ×–×”.</p>`;
            }
            
            contentHtml += `</div>`;
            DOM.detailsModal.innerHTML = contentHtml;

            DOM.detailsModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.detailsModal.classList.remove('opacity-0');
                DOM.detailsModal.querySelector('.modal-content-container').classList.remove('scale-95');
                initDetailsMap(item);
            }, 10);

            document.getElementById('details-modal-close-btn').addEventListener('click', closeDetailsModal);
        }

        function closeDetailsModal() {
            DOM.detailsModal.classList.add('opacity-0');
            DOM.detailsModal.querySelector('.modal-content-container').classList.add('scale-95');
            setTimeout(() => {
                DOM.detailsModal.classList.add('hidden');
                if (detailsMap) {
                    detailsMap.remove();
                    detailsMap = null;
                }
            }, 300);
        }

        // --- Details HTML Generators ---
        function generateHotelDetailsHTML(item) {
             return `
                <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-hotel text-blue-500"></i> ${item.name}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×™×¢×“:</strong> ${item.destination || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×ª××¨×™×›×™×:</strong> ${item.dates || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×”×•×–××Ÿ ×“×¨×š:</strong> ${item.booked_via || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨:</strong> $${(item.price || 0).toLocaleString()}</div>
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×›×ª×•×‘×ª:</strong> ${item.address || '-'}</div>
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-2 gap-4">
                     <a href="${item.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.link ? '' : 'opacity-50 cursor-not-allowed'}" ${item.link ? '' : 'disabled'}>×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition ${item.address ? '' : 'opacity-50 cursor-not-allowed'}" ${item.address ? '' : 'disabled'}>× ×™×•×•×˜ <i class="fa-solid fa-diamond-turn-right text-xs"></i></a>
                </div>
                ${item.coords ? '<div id="details-map" class="details-map-container"></div>' : ''}
            `;
        }
        
        function generateRideDetailsHTML(item) {
            const title = `×”×¡×¢×”: ${item.from_address?.split(',')[0] || ''} â† ${item.to_address?.split(',')[0] || ''}`;
            let route_geometry = item.route_geometry;
            if(typeof route_geometry === 'string') {
                try { route_geometry = JSON.parse(route_geometry); } catch(e) { route_geometry = null; }
            }

            return `
                <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-taxi text-sky-500"></i> ${title}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×××™×¤×”:</strong> ${item.from_address || '-'}</div>
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×œ××™×¤×”:</strong> ${item.to_address || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×ª××¨×™×š:</strong> ${item.date || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª ××™×¡×•×£:</strong> ${item.pickup_time || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×—×‘×¨×”:</strong> ${item.company || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×”×•×–××Ÿ ×“×¨×š:</strong> ${item.booked_via || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©× × ×”×’:</strong> ${item.driver_name || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×˜×œ×¤×•×Ÿ × ×”×’:</strong> ${item.driver_phone ? `<a href="tel:${item.driver_phone}" class="text-blue-600 hover:underline">${item.driver_phone}</a>` : '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××¡×¤×¨ ×¨×›×‘:</strong> ${item.vehicle_number || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×¤×¨×˜×™ ×¨×›×‘:</strong> ${item.vehicle_details || '-'}</div>
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨:</strong> $${(item.price || 0).toLocaleString()}</div>
                </div>
                    ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                    <div class="grid grid-cols-1 gap-4">
                     <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}" ${item.booking_link ? '' : 'disabled'}>×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
                ${route_geometry ? '<div id="details-map" class="details-map-container"></div>' : ''}
            `;
        }

        function generateFlightDetailsHTML(item) {
            const title = `×˜×™×¡×”: ${item.from?.destination || ''} â† ${item.to?.destination || ''}`;
            const numSeats = item.seats?.length || 1;
            const totalPrice = (item.price_per_person || 0) * numSeats;
            return `
                <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-plane-departure text-sky-500"></i> ${title}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×—×‘×¨×ª ×ª×¢×•×¤×”:</strong> ${item.airline || '-'} #${item.flight_number || ''}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×ª××¨×™×š:</strong> ${item.dates || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª ×”××¨××”:</strong> ${item.departure_time || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª × ×—×™×ª×”:</strong> ${item.arrival_time || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨ ×œ××“×:</strong> $${(item.price_per_person || 0).toLocaleString()}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨ ×›×•×œ×œ (${numSeats} × ×•×¡×¢×™×):</strong> $${totalPrice.toLocaleString()}</div>
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××§×•××•×ª:</strong> ${(item.seats || []).join(', ') || '-'}</div>
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                ${(item.from?.coords || item.to?.coords) ? '<div id="details-map" class="details-map-container"></div>' : ''}
            `;
        }

        function generateCarRentalDetailsHTML(item) {
            return `
                <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-car text-green-500"></i> ×¨×›×‘ ×©×›×•×¨: ${item.destination || ''}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××™×§×•× ××™×¡×•×£:</strong> ${item.pickup_location || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×ª××¨×™×›×™×:</strong> ${item.dates || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×•×ª:</strong> ${item.pickup_time || '?'} - ${item.return_time || '?'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×¡×•×’ ×¨×›×‘:</strong> ${item.car_type || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×”×•×–××Ÿ ×“×¨×š:</strong> ${item.booked_via || '-'}</div>
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨:</strong> $${(item.price || 0).toLocaleString()}</div>
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}" ${item.booking_link ? '' : 'disabled'}>×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
            `;
        }
        
        function generateFerryDetailsHTML(item) {
             const title = `××¢×‘×•×¨×ª: ${item.from_destination || ''} â† ${item.to_destination || ''}`;
             return `
                <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-ship text-indigo-500"></i> ${title}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×—×‘×¨×”:</strong> ${item.company || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×ª××¨×™×š:</strong> ${item.date || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª ×™×¦×™××”:</strong> ${item.departure_time || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª ×”×’×¢×”:</strong> ${item.arrival_time || '-'}</div>
                    <div class="md:col-span-2 p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨:</strong> $${(item.price || 0).toLocaleString()}</div>
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}" ${item.booking_link ? '' : 'disabled'}>×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
            `;
        }
        
        function generateTrainDetailsHTML(item) {
             const title = `×¨×›×‘×ª: ${item.from_station || ''} â† ${item.to_station || ''}`;
             return `
                <h4 class="text-xl font-bold text-slate-800 flex items-center gap-3"><i class="fas fa-train text-orange-500"></i> ${title}</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×—×‘×¨×”:</strong> ${item.company || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×ª××¨×™×š:</strong> ${item.date || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª ×™×¦×™××”:</strong> ${item.departure_time || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">×©×¢×ª ×”×’×¢×”:</strong> ${item.arrival_time || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××•×©×‘×™×:</strong> ${item.seat_info || '-'}</div>
                    <div class="p-3 bg-slate-50 rounded-lg"><strong class="text-slate-500 block">××—×™×¨:</strong> $${(item.price || 0).toLocaleString()}</div>
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}" ${item.booking_link ? '' : 'disabled'}>×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
            `;
        }

        function initDetailsMap(item) {
            if(detailsMap) {
                detailsMap.remove();
                detailsMap = null;
            }
            const mapContainer = document.getElementById('details-map');
            if (!mapContainer) return;

            detailsMap = L.map('details-map').setView([31.7683, 35.2137], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailsMap);
            const layerGroup = L.layerGroup().addTo(detailsMap);

            if (item.type === 'hotel' && item.coords) {
                const coords = [item.coords.lat, item.coords.lng || item.coords.lon];
                L.marker(coords).addTo(layerGroup);
                detailsMap.setView(coords, 13);
            } else if (item.type === 'ride' && item.route_geometry) {
                 let route_geometry = item.route_geometry;
                 if(typeof route_geometry === 'string') {
                     try { route_geometry = JSON.parse(route_geometry); } catch(e) { route_geometry = null; }
                 }
                 if(route_geometry) {
                     const latlngs = route_geometry.map(coord => L.latLng(coord[0], coord[1]));
                     if (item.from_coords) L.marker([item.from_coords.lat, item.from_coords.lon]).addTo(layerGroup).bindPopup('×”×ª×—×œ×”');
                     if (item.to_coords) L.marker([item.to_coords.lat, item.to_coords.lon]).addTo(layerGroup).bindPopup('×¡×™×•×');
                     const polyline = L.polyline(latlngs, {color: '#3b82f6', weight: 5}).addTo(layerGroup);
                     detailsMap.fitBounds(polyline.getBounds(), {padding: [20, 20]});
                 }
            } else if (item.type === 'flight') {
                const points = [];
                const allLegs = [item.from, ...(item.connections || []), item.to];
                allLegs.forEach(leg => {
                    if (leg && leg.coords) {
                        const coords = [leg.coords.lat, leg.coords.lng || leg.coords.lon];
                        points.push(coords);
                        L.marker(coords).addTo(layerGroup).bindPopup(leg.destination || '');
                    }
                });
                if (points.length > 1) {
                    L.polyline(points, {color: '#3b82f6', weight: 3, dashArray: '10, 10'}).addTo(layerGroup);
                    detailsMap.fitBounds(points, { padding: [50, 50] });
                } else if (points.length === 1) {
                    detailsMap.setView(points[0], 8);
                }
            }
            setTimeout(() => detailsMap.invalidateSize(), 100);
        }

        // --- Summary Table Logic ---
        function renderSummaryTables() {
            const categories = {
                hotel: { label: 'ğŸ¨ ××œ×•× ×•×ª', total: 0 },
                flight: { label: 'âœˆï¸ ×˜×™×¡×•×ª', total: 0 },
                car_rental: { label: 'ğŸš— ×¨×›×‘×™×', total: 0 },
                ride: { label: 'ğŸš• ×”×¡×¢×•×ª', total: 0 },
                ferry: { label: 'ğŸš¢ ××¢×‘×•×¨×•×ª', total: 0 },
                train: { label: 'ğŸš† ×¨×›×‘×•×ª', total: 0 },
            };

            allItems.forEach(item => {
                if (categories[item.type]) {
                    let price = 0;
                    if (item.type === 'flight') {
                        const numSeats = item.seats?.length || 1;
                        price = (item.price_per_person || 0) * numSeats;
                    } else {
                        price = item.price || 0;
                    }
                    categories[item.type].total += price;
                }
            });

            DOM.logisticsSummaryBody.innerHTML = '';
            let grandTotal = 0;
            for (const key in categories) {
                const category = categories[key];
                if (category.total > 0 || allItems.some(item => item.type === key)) {
                    DOM.logisticsSummaryBody.innerHTML += `
                        <tr>
                            <td class="p-3">${category.label}</td>
                            <td class="p-3 font-mono text-left">$${category.total.toLocaleString()}</td>
                        </tr>`;
                    grandTotal += category.total;
                }
            }
            DOM.logisticsSummaryBody.innerHTML += `
                <tr class="font-bold bg-slate-100 text-slate-800">
                    <td class="p-3">×¡×”"×›</td>
                    <td class="p-3 font-mono text-left">$${grandTotal.toLocaleString()}</td>
                </tr>`;

            DOM.grandTotalContainer.innerHTML = `
                <p class="text-4xl font-bold text-blue-600 drop-shadow-sm font-mono">$${grandTotal.toLocaleString()}</p>
                <p class="text-slate-500 mt-1">×¢×œ×•×ª ×›×•×œ×œ×ª ××©×•×¢×¨×ª</p>
            `;
        }
        
        // --- Utility Functions ---
        function formatDuration(seconds) {
            if (seconds === undefined || seconds === null) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        function formatDistance(meters) {
            if (meters === undefined || meters === null) return '-';
            return `${(meters / 1000).toFixed(1)} ×§"×`;
        }

        // --- Event Listeners ---
        document.getElementById('open-add-modal-btn').addEventListener('click', () => openModal());
        DOM.modalCloseBtn.addEventListener('click', closeModal);
        DOM.modalForm.addEventListener('submit', handleFormSubmit);
        
        DOM.modalNextBtn.addEventListener('click', () => {
            const wasChoiceStep = !modalState.mainType || (modalState.mainType === 'transport' && !modalState.subType);
            if (collectStepData()) {
                modalState.currentStep = wasChoiceStep ? 1 : modalState.currentStep + 1;
                generateStepContent();
                updateModalNav();
                setTimeout(() => {
                    initializeFieldPlugins();
                    Object.values(modalState.maps).forEach(m => m?.invalidateSize());
                }, 10);
            }
        });

        DOM.modalBackBtn.addEventListener('click', () => {
            collectStepData();
            if (modalState.currentStep === 1) {
                if (modalState.subType) { modalState.subType = null; modalState.data.subType = null; } 
                else if (modalState.mainType) { modalState.mainType = null; modalState.data.mainType = null; }
            } else {
                modalState.currentStep--;
            }
            generateStepContent();
            updateModalNav();
            setTimeout(() => {
                initializeFieldPlugins();
                Object.values(modalState.maps).forEach(m => m?.invalidateSize());
            }, 10);
        });

        DOM.modalForm.addEventListener('click', async e => {
            const target = e.target.closest('button');
            if (!target) return;
            const { action, legId } = target.dataset;

            const handleSearch = async (searchFunction) => {
                const originalText = target.innerHTML;
                target.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                target.disabled = true;
                try {
                    await searchFunction();
                } finally {
                    target.innerHTML = originalText;
                    target.disabled = false;
                }
            };
            
            if (action === 'find-address') {
                await handleSearch(() => findAddressOnMap('hotel', document.getElementById('address').value));
            } else if (action === 'find-flight-leg') {
                const address = document.getElementById(`${legId}_airport_address`).value;
                await handleSearch(() => findAddressOnMap(legId, address));
            } else if(action === 'calculate-ride-route') {
                await handleSearch(async () => {
                    const fromAddress = document.getElementById('from_address').value;
                    const toAddress = document.getElementById('to_address').value;
                    modalState.data.from_address = fromAddress;
                    modalState.data.to_address = toAddress;

                    DOM.modalError.textContent = '××—×©×‘ ××¡×œ×•×œ...';
                    const [fromResult, toResult] = await Promise.all([geocodeAddress(fromAddress), geocodeAddress(toAddress)]);

                    if (!fromResult.success || !toResult.success) {
                        DOM.modalError.textContent = fromResult.message || toResult.message || '×œ× × ×™×ª×Ÿ ×œ××¦×•× ××ª ×”×›×ª×•×‘×•×ª.';
                        return;
                    }

                    modalState.data.from_coords = fromResult.coords;
                    modalState.data.to_coords = toResult.coords;
                    
                    const routeResult = await fetchRoute(fromResult.coords, toResult.coords);
                    if (routeResult.success) {
                        DOM.modalError.textContent = '';
                        modalState.data.route_geometry = routeResult.geometry;
                        modalState.data.route_duration = routeResult.duration;
                        modalState.data.route_distance = routeResult.distance;
                        document.getElementById('route-duration').textContent = formatDuration(routeResult.duration);
                        document.getElementById('route-distance').textContent = formatDistance(routeResult.distance);
                        const map = modalState.maps['ride-route'];
                        if (map) {
                           drawRouteOnMap(map, 'ride-route', routeResult.geometry, fromResult.coords, toResult.coords);
                        }
                    } else {
                        DOM.modalError.textContent = routeResult.message;
                    }
                });
            } else if (target.id === 'add-connection-btn') {
                addConnection();
            } else if (target.id === 'calculate-final-route-btn') {
                showFinalRouteOnMap();
            } else if (target.id === 'add-seat-btn') {
                addSeatInput();
            }
        });

        document.addEventListener('click', e => {
            const editBtn = e.target.closest('.edit-btn');
            if (editBtn) {
                e.stopPropagation();
                const item = allItems.find(i => i.id === editBtn.dataset.id);
                if (item) openModal(item);
                return;
            }
            
            const deleteBtn = e.target.closest('.delete-btn');
            if (deleteBtn) {
                e.stopPropagation();
                handleDelete(deleteBtn.dataset.id, deleteBtn.dataset.name);
                return;
            }

            const card = e.target.closest('[data-action="view-details"]');
            if (card) {
                const item = allItems.find(i => i.id === card.dataset.id);
                if (item) openDetailsModal(item);
            }
        });

        // --- Address Autocomplete ---
        async function handleAddressAutocomplete(event) {
            const input = event.target;
            const suggestionsContainer = document.getElementById(`${input.id}-suggestions`);
            if (!suggestionsContainer) return;

            const query = input.value;

            if (query.length < 3) {
                suggestionsContainer.innerHTML = '';
                return;
            }

            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=5`);
                const data = await response.json();
                
                suggestionsContainer.innerHTML = '';
                data.forEach(place => {
                    const suggestionDiv = document.createElement('div');
                    suggestionDiv.textContent = place.display_name;
                    suggestionDiv.className = 'autocomplete-suggestion';
                    suggestionDiv.addEventListener('click', () => {
                        input.value = place.display_name;
                        suggestionsContainer.innerHTML = '';
                    });
                    suggestionsContainer.appendChild(suggestionDiv);
                });
            } catch (error) {
                console.error('Autocomplete error:', error);
            }
        }
        window.debouncedAutocomplete = debouncedAutocomplete;

        // --- Sidebar Activation ---
        const toggleSidebar = () => {
            DOM.sidebar.classList.toggle('translate-x-full');
            DOM.overlay.classList.toggle('hidden');
        };
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);

        // --- Delete Modal Listeners ---
        DOM.deleteConfirmBtn.addEventListener('click', confirmDeletion);
        DOM.deleteCancelBtn.addEventListener('click', closeDeleteModal);
        
        // --- Start the page ---
        initPage();
    </script>
</body>
</html>
