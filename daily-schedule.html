<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>

  <!-- Tailwind + Icons + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet (Map) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

  <style>
    :root{
      --overlay-alpha: 0.5;
      --card-bg: rgba(255,255,255,.9);
      --card-text: #0f172a;
      --modal-bg: #ffffff;
      --modal-text: #0f172a;
    }
    html, body {
      height: 100%;
      font-family: 'Assistant', sans-serif;
      overflow-x: hidden;
      overscroll-behavior-y: contain; /* ××¤×—×™×ª ×§×¤×™×¦×•×ª ×‘×¡×•×£ ×’×œ×™×œ×” */
      background: #f1f5f9;
    }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .leaf-badge { border-inline-start: 4px solid #38bdf8; }
    .timeline { position: relative; }
    .timeline::before { content: ""; position: absolute; right: 20px; top: 0; bottom: 0; width: 2px; background: rgba(30,41,59,.15); }
    .timeline-item { position: relative; padding-right: 56px; }
    .timeline-dot { position: absolute; right: 12px; top: .75rem; width: 16px; height: 16px; border-radius: 9999px; background: white; box-shadow: 0 0 0 4px #e2e8f0 inset, 0 0 0 2px rgba(30,41,59,.1); }
    .bg-fixed-image { background-size: cover; background-position: center; }

    /* Loader */
    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity .5s ease-out; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }

    /* Theme hooks */
    .theme-card { background: var(--card-bg) !important; color: var(--card-text) !important; }
    .theme-modal { background: var(--modal-bg); color: var(--modal-text); }

    /* Map */
    #route-map { height: 380px; border-radius: 1rem; overflow: hidden; }
    .item-modal-map { height: 260px; border-radius: .75rem; overflow: hidden; }

    /* Generic modal backdrop */
    .modal-backdrop { position: fixed; inset:0; background: rgba(0,0,0,.5); display:none; z-index:70; }
    .modal-backdrop.active { display:block; }

    /* Settings modal â€“ mobile-first full screen, scrollable */
    .settings-shell{
      width:100%;
      max-width: 48rem;               /* ~768px */
      height: 92vh;                   /* ××¡×š ××œ× ×›××¢×˜ ×‘× ×™×™×“ */
      max-height: 92vh;
      border-radius: 0;               /* ×‘× ×™×™×“ â€“ ×¤×•×œ-×¡×§×™×Ÿ */
      display:flex; flex-direction:column; overflow:hidden;
    }
    @media (min-width: 768px){
      .settings-shell{
        border-radius: 1rem;
        height: auto;
        max-height: 80vh;             /* ×“×¡×§×˜×•×¤ â€“ ×—×œ×•×Ÿ × ×•×— */
      }
    }
    .settings-header{
      position: sticky; top:0; z-index:2;
      background: rgba(255,255,255,.9); backdrop-filter: blur(6px);
      border-bottom: 1px solid rgba(15,23,42,.08);
    }
    .settings-content{ flex:1; overflow-y:auto; padding: 1rem 1.25rem; }
    .settings-tabs{
      display:flex; gap:.5rem; flex-wrap:wrap;
    }
    .settings-chip{
      border:1px solid rgba(15,23,42,.12);
      padding:.5rem .8rem; border-radius:9999px; font-weight:700;
      background:#f8fafc; cursor:pointer;
    }
    .settings-chip.active{ background:#e2e8f0; }
    .settings-section{
      background:#fff; border:1px solid rgba(15,23,42,.08); border-radius:1rem; padding:1rem;
    }

    /* Item modal container â€“ also scrollable on small screens */
    .item-shell{
      width:100%; max-width: 40rem; /* ~640px */
      max-height: 88vh;
      overflow:auto;
      border-radius: 1rem;
    }
  </style>
</head>
<body>

  <!-- Loader -->
  <div id="initial-loader">
    <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div id="loader-overlay" class="fixed inset-0 z-0" style="background: rgba(0,0,0,var(--overlay-alpha));"></div>
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
    </div>
  </div>

  <!-- Background -->
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
  <div id="page-overlay" class="fixed inset-0 z-0" style="background: rgba(0,0,0,var(--overlay-alpha));"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <!-- Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500 min-h-screen">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-3">
            <!-- Back to trip page -->
            <a id="trip-page-btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border text-slate-700 hover:bg-slate-50" href="#">
              <i class="fa-solid fa-arrow-right"></i> ×“×£ ×”×˜×™×•×œ
            </a>
            <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
          </div>
          <div class="flex items-center gap-2">
            <div id="auth-container" class="flex items-center"></div>
            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×”×’×“×¨×•×ª ×¢×™×¦×•×‘">
              <i class="fa-solid fa-gear fa-lg"></i>
            </button>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <!-- Trip/title banner -->
    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <!-- Summary -->
        <section class="theme-card rounded-2xl shadow-lg p-5 leaf-badge">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold">×œ×•×– ×œ×™×•×</h2>
              <p id="trip-subtitle" class="mt-1 opacity-80"></p>
            </div>
            <div class="flex items-center gap-2">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
        </section>

        <!-- Timeline -->
        <section id="timeline-section" class="theme-card rounded-2xl shadow-lg p-5">
          <div id="no-schedule" class="text-center p-10">
            <i class="fa-regular fa-clock fa-3x opacity-60 mb-4"></i>
            <h3 class="text-xl font-bold mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
            <p class="opacity-80">×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
          </div>
          <div id="timeline" class="timeline space-y-4 hidden"></div>
        </section>

        <!-- Notes/Tips -->
        <section id="notes-section" class="theme-card rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
          <div id="notes-list" class="grid gap-3">
            <div class="opacity-80">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
          </div>
        </section>

        <!-- Route Map -->
        <section id="route-map-section" class="theme-card rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold mb-3">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
          <div id="route-map" class="w-full"></div>
          <div id="route-legend" class="mt-3 grid gap-2"></div>
        </section>

        <!-- CTA -->
        <section class="flex justify-center gap-3">
          <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fa-solid fa-wand-magic-sparkles"></i> ×¦×•×¨ ×œ×•×–
          </a>
          <a id="edit-schedule-bottom-btn" href="#" class="hidden inline-flex items-center gap-2 border font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all">
            <i class="fa-solid fa-pen"></i> ×¢×¨×•×š ×œ×•×–
          </a>
        </section>

      </div>
    </main>
  </div>

  <!-- ===== Item Modal (details + map) ===== -->
  <div id="item-modal-backdrop" class="modal-backdrop"></div>
  <div id="item-modal" class="fixed inset-0 z-[80] hidden flex items-center justify-center p-4">
    <div class="theme-modal item-shell shadow-xl p-5 relative">
      <button id="item-modal-close" class="absolute top-3 left-3 p-2 rounded hover:bg-black/5" title="×¡×’×•×¨">
        <i class="fa-solid fa-xmark"></i>
      </button>
      <div id="item-modal-content"></div>
      <div id="item-modal-map" class="item-modal-map mt-4 hidden"></div>
    </div>
  </div>

  <!-- ===== Settings Modal (mobile-friendly) ===== -->
  <div id="settings-backdrop" class="modal-backdrop"></div>
  <div id="settings-modal" class="fixed inset-0 z-[75] hidden flex items-center justify-center p-0 md:p-4">
    <div class="theme-modal settings-shell shadow-2xl">
      <div class="settings-header px-5 py-3 flex items-center justify-between">
        <h3 class="text-lg md:text-xl font-bold">×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ×”×“×£</h3>
        <button id="settings-close" class="p-2 rounded hover:bg-black/5"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="settings-content">
        <!-- Tabs -->
        <div class="settings-tabs mb-4">
          <button data-tab="bg" class="settings-chip active">×¢×¨×™×›×ª ×¨×§×¢</button>
          <button data-tab="layout" class="settings-chip">×¢×™×¦×•×‘ ×”×œ×•×–</button>
          <button data-tab="theme" class="settings-chip">×›×¨×˜×™×¡×™×•×ª/×—×œ×•× ×•×ª ×•×˜×§×¡×˜</button>
        </div>

        <!-- BG -->
        <div id="tab-bg" class="grid gap-4">
          <div class="settings-section">
            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-3">
                <label class="font-bold">×ª××•× ×ª ×¨×§×¢ (×§×™×©×•×¨):</label>
                <input id="bg-image-url" type="url" placeholder="https://..." class="w-full rounded border px-3 py-2"/>
                <div class="text-sm opacity-80">×× ×¨×™×§ â€“ × ×©×ª××© ×‘×¦×‘×¢ ×¨×§×¢ ×©×ª×‘×—×¨/×™ ×œ××˜×”.</div>

                <label class="font-bold mt-3 block">×¦×‘×¢ ×¨×§×¢ (×× ××™×Ÿ ×ª××•× ×”):</label>
                <input id="bg-color" type="color" value="#0ea5e9" class="w-16 h-10 rounded border p-0">

                <label class="font-bold mt-3 block">×‘×”×™×¨×•×ª ×”×¨×§×¢:</label>
                <input id="bg-brightness" type="range" min="0" max="100" value="70" class="w-full">
                <div class="text-sm opacity-80">0% ×›×”×” ×××•×“ â€¢ 100% ×œ×œ× ×©×›×‘×ª ×”××¤×œ×”.</div>
              </div>

              <div class="space-y-3">
                <label class="font-bold">××™×¤×” ×œ×”×—×™×œ?</label>
                <select id="bg-scope" class="w-full rounded border px-3 py-2">
                  <option value="dest" selected>×‘×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×”×–×” (×‘×¨×™×¨×ª ××—×“×œ)</option>
                  <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ ×”×–×”</option>
                  <option value="trip">×‘×›×œ ×”×œ×•×–×™× ×©×œ ×”×˜×™×•×œ</option>
                </select>

                <button id="bg-apply" class="mt-4 inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                  <i class="fa-solid fa-floppy-disk"></i> ×”×—×œ & ×©××•×¨
                </button>
              </div>
            </div>
          </div>
        </div>

        <!-- Layout -->
        <div id="tab-layout" class="hidden grid gap-4">
          <div class="settings-section">
            <div class="grid md:grid-cols-2 gap-4">
              <div class="space-y-2">
                <label class="font-bold">×‘×—×¨ ×¡×’× ×•×Ÿ ×ª×¦×•×’×”:</label>
                <select id="layout-style" class="w-full rounded border px-3 py-2">
                  <option value="modal" selected>1) ×›×¨×˜×™×¡×™×•×ª + ××•×“×œ ××œ× ×‘×œ×—×™×¦×”</option>
                  <option value="accordion">2) ××§×•×¨×“×™×•×Ÿ (×›×¨×˜×™×¡×™×•×ª × ×¤×ª×—×•×ª) + ×›×¤×ª×•×¨ "×¤×¨×˜×™× ××œ××™×"</option>
                  <option value="inline_full">3) ×¤×ª×™×—×” ××œ××” ×‘×ª×•×š ×”×›×¨×˜×™×¡×™×”</option>
                  <option value="timeline_line">4) ×§×• ×–××Ÿ ××•×“×’×© + ××•×“×œ ××œ×</option>
                </select>
              </div>
              <div class="space-y-2">
                <label class="font-bold">××™×¤×” ×œ×”×—×™×œ?</label>
                <select id="layout-scope" class="w-full rounded border px-3 py-2">
                  <option value="trip" selected>×‘×›×œ ×”×œ×•×–×™× ×©×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                  <option value="dest">×‘×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×”×–×”</option>
                  <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×–×”</option>
                </select>
              </div>
            </div>
            <button id="layout-apply" class="mt-4 inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
              <i class="fa-solid fa-floppy-disk"></i> ×”×—×œ & ×©××•×¨
            </button>
          </div>
        </div>

        <!-- Theme -->
        <div id="tab-theme" class="hidden grid gap-4">
          <div class="settings-section">
            <div class="grid md:grid-cols-2 gap-6">
              <div class="space-y-3">
                <label class="font-bold">×¤×¨×™×¡×˜×™× ××•×›× ×™×:</label>
                <select id="theme-preset" class="w-full rounded border px-3 py-2">
                  <option value="transparent">×©×§×•×£ ×¢× ×˜×§×¡×˜ ×œ×‘×Ÿ (××¢×•×œ×” ×œ×ª××•× ×ª ×¨×§×¢)</option>
                  <option value="classic">×œ×‘×Ÿ ×¢× ×˜×§×¡×˜ ×©×—×•×¨</option>
                  <option value="glass">×–×›×•×›×™×ª ×—×œ×‘×™×ª ×¢×“×™× ×”</option>
                  <option value="ocean">×›×—×•×œ ×¢×“×™×Ÿ / ×˜×§×¡×˜ ×›×”×”</option>
                  <option value="sunset">×›×ª×•×-×–×”×‘×”×‘ / ×˜×§×¡×˜ ×›×”×”</option>
                  <option value="forest">×™×¨×§×¨×§ ×¢×“×™×Ÿ / ×˜×§×¡×˜ ×›×”×”</option>
                  <option value="plum">×©×–×™×£ ×¢×“×™×Ÿ / ×˜×§×¡×˜ ×‘×”×™×¨</option>
                  <option value="slate">Slate ×©×§×•×£ / ×˜×§×¡×˜ ×œ×‘×Ÿ</option>
                  <option value="custom">××•×ª×× ××™×©×™×ªâ€¦</option>
                </select>

                <div id="theme-custom" class="hidden space-y-3">
                  <div>
                    <label class="font-bold">×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª/×—×œ×•× ×•×ª:</label>
                    <input id="theme-card-bg" type="color" value="#ffffff" class="w-16 h-10 rounded border p-0">
                    <label class="font-bold ml-4">××˜×™××•×ª:</label>
                    <input id="theme-card-alpha" type="range" min="10" max="100" value="90">
                  </div>
                  <div>
                    <label class="font-bold">×¦×‘×¢ ×˜×§×¡×˜:</label>
                    <input id="theme-card-text" type="color" value="#0f172a" class="w-16 h-10 rounded border p-0">
                  </div>
                  <div class="text-sm opacity-80">×”×”×’×“×¨×•×ª ×—×œ×•×ª ×’× ×¢×œ ×—×œ×•× ×•×ª (××•×“×œ×™×).</div>
                </div>
              </div>
              <div class="space-y-2">
                <label class="font-bold">××™×¤×” ×œ×”×—×™×œ?</label>
                <select id="theme-scope" class="w-full rounded border px-3 py-2">
                  <option value="trip" selected>×‘×›×œ ×”×œ×•×–×™× ×©×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                  <option value="dest">×‘×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×”×–×”</option>
                  <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×–×”</option>
                </select>
                <button id="theme-apply" class="mt-4 inline-flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700">
                  <i class="fa-solid fa-floppy-disk"></i> ×”×—×œ & ×©××•×¨
                </button>
              </div>
            </div>
          </div>
        </div>

      </div>
      <div class="px-5 py-2 text-xs opacity-70 border-t">×˜×™×¤: ×¦×‘×¢×™ ×”×›×¤×ª×•×¨×™× ×§×‘×•×¢×™× â€“ ×•×™×™×– ×›×—×•×œ, ××¤×•×ª ×™×¨×•×§, â€œ××ª×¨â€ ×ª×›×œ×ª, â€œ×”×–×× ×”â€ ×˜×•×¨×§×™×–.</div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, onSnapshot, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- State ----------
    let currentUser = null;
    let tripId = null;
    let tripData = null;

    let dateStr = null;   // ××”-URL
    let dateISO = null;   // yyyy-mm-dd
    let dayNameHe = "";

    let destForDate = null;
    let schedData = null;
    let scheduleExists = false;
    let cardStyle = 'modal'; // ×‘×¨×™×¨×ª ××—×“×œ

    // UI refs
    const initialLoader   = document.getElementById('initial-loader');
    const mainContent     = document.getElementById('main-content');
    const pageBg          = document.getElementById('page-bg');
    const pageOverlay     = document.getElementById('page-overlay');
    const loaderBg        = document.getElementById('loader-bg');
    const loaderOverlay   = document.getElementById('loader-overlay');
    const sidebar         = document.getElementById('sidebar');
    const hamburgerBtn    = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay         = document.getElementById('overlay');
    const mainMenu        = document.getElementById('main-menu');
    const authContainer   = document.getElementById('auth-container');

    const tripPageBtn     = document.getElementById('trip-page-btn');

    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl       = document.getElementById('day-title');
    const tripSubtitle     = document.getElementById('trip-subtitle');
    const dateChip         = document.getElementById('date-chip');

    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox   = document.getElementById('timeline');
    const createBtn     = document.getElementById('create-schedule-btn');
    const editBottomBtn = document.getElementById('edit-schedule-bottom-btn');

    const notesList     = document.getElementById('notes-list');

    // Settings modal
    const settingsBtn   = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsBackdrop = document.getElementById('settings-backdrop');
    const settingsClose = document.getElementById('settings-close');
    const tabButtons    = [...document.querySelectorAll('.settings-chip')];
    const panels = {
      bg:     document.getElementById('tab-bg'),
      layout: document.getElementById('tab-layout'),
      theme:  document.getElementById('tab-theme')
    };
    const bgImageUrl    = document.getElementById('bg-image-url');
    const bgColorInput  = document.getElementById('bg-color');
    const bgBrightness  = document.getElementById('bg-brightness');
    const bgScope       = document.getElementById('bg-scope');
    const bgApplyBtn    = document.getElementById('bg-apply');

    const layoutStyleSel= document.getElementById('layout-style');
    const layoutScope   = document.getElementById('layout-scope');
    const layoutApply   = document.getElementById('layout-apply');

    const themePreset   = document.getElementById('theme-preset');
    const themeCustomBox= document.getElementById('theme-custom');
    const themeCardBg   = document.getElementById('theme-card-bg');
    const themeCardAlpha= document.getElementById('theme-card-alpha');
    const themeCardText = document.getElementById('theme-card-text');
    const themeScope    = document.getElementById('theme-scope');
    const themeApply    = document.getElementById('theme-apply');

    // Item modal
    const itemModalBackdrop = document.getElementById('item-modal-backdrop');
    const itemModal         = document.getElementById('item-modal');
    const itemModalClose    = document.getElementById('item-modal-close');
    const itemModalContent  = document.getElementById('item-modal-content');
    const itemModalMapBox   = document.getElementById('item-modal-map');

    // ---------- Helpers ----------
    function toggleSidebar(){ sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }
    function openSettings(tab='bg'){
      settingsBackdrop.classList.add('active');
      settingsModal.classList.remove('hidden');
      switchTab(tab);
    }
    function closeSettings(){
      settingsBackdrop.classList.remove('active');
      settingsModal.classList.add('hidden');
    }
    function switchTab(tab){
      Object.entries(panels).forEach(([k,el]) => el.classList.toggle('hidden', k!==tab));
      tabButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.tab===tab));
    }

    function parseLocalDateFlexible(s) {
      if (!s) return null;
      const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/);
      if (!m) return null;
      let d = +m[1], mo = +m[2], y = +m[3];
      if (y < 100) y += 2000;
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
    function toISODateUTC(d) {
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function hebWeekdayUTC(d) {
      const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª'];
      return names[d.getUTCDay()];
    }

    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const start = parseLocalDateFlexible(startStr);
      const end = parseLocalDateFlexible(endStr);
      if (!start || !end) return [];
      const out = [];
      for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) {
        out.push(new Date(t.getTime()));
      }
      return out;
    }

    function destKeyFromDest(dest){
      const key = dest?.id || dest?.nameHe || dest?.name || '';
      return key.toString().toLowerCase().trim().replace(/\s+/g,'_');
    }

    function findDestinationForDate(trip, rawDDMMYYYY) {
      const target = parseLocalDateFlexible(rawDDMMYYYY);
      if (!target) return null;
      const targetISO = toISODateUTC(target);
      return (trip.destinations || []).find(dest => {
        const days = generateDatesFromRange(dest.dates);
        const isoList = days.map(d => toISODateUTC(d));
        return isoList.includes(targetISO);
      }) || null;
    }

    function setOverlayByBrightness(percent){
      const alpha = Math.max(0, Math.min(0.7, 0.7 * (1 - (percent/100))));
      pageOverlay.style.background = `rgba(0,0,0,${alpha})`;
      loaderOverlay.style.background = `rgba(0,0,0,${alpha})`;
    }

    function applyBackgroundSetting(setting, destFallback){
      if (setting && setting.type === 'image' && setting.url){
        pageBg.style.backgroundImage = `url('${setting.url}')`;
        loaderBg.style.backgroundImage = `url('${setting.url}')`;
      } else if (setting && setting.type === 'color' && setting.color){
        const col = setting.color;
        pageBg.style.backgroundImage = `linear-gradient(0deg, ${col}, ${col})`;
        loaderBg.style.backgroundImage = `linear-gradient(0deg, ${col}, ${col})`;
      } else {
        const url = destFallback?.bgUrl || destFallback?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg';
        pageBg.style.backgroundImage = `url('${url}')`;
        loaderBg.style.backgroundImage = `url('${url}')`;
      }
      const bright = (setting && typeof setting.brightness==='number') ? setting.brightness : 70;
      setOverlayByBrightness(bright);
      bgBrightness.value = bright;
      if (setting?.type === 'image') bgImageUrl.value = setting.url || '';
      if (setting?.type === 'color') bgColorInput.value = setting.color || '#0ea5e9';
    }

    function setThemeVars(presetOrCustom){
      const root = document.documentElement;
      function setVars(bgRGBA, text, modalBg, modalText){
        root.style.setProperty('--card-bg', bgRGBA);
        root.style.setProperty('--card-text', text);
        root.style.setProperty('--modal-bg', modalBg);
        root.style.setProperty('--modal-text', modalText);
      }
      switch(presetOrCustom.preset){
        case 'transparent': setVars('rgba(0,0,0,.35)', '#ffffff', 'rgba(0,0,0,.6)', '#ffffff'); break;
        case 'classic':     setVars('rgba(255,255,255,.95)', '#0f172a', '#ffffff', '#0f172a'); break;
        case 'glass':       setVars('rgba(255,255,255,.7)', '#0f172a', 'rgba(255,255,255,.9)', '#0f172a'); break;
        case 'ocean':       setVars('rgba(59,130,246,.12)', '#0f172a', 'rgba(255,255,255,.95)', '#0f172a'); break;
        case 'sunset':      setVars('rgba(251,146,60,.15)', '#0f172a', 'rgba(255,255,255,.95)', '#0f172a'); break;
        case 'forest':      setVars('rgba(34,197,94,.12)', '#0f172a', 'rgba(255,255,255,.95)', '#0f172a'); break;
        case 'plum':        setVars('rgba(147,51,234,.18)', '#f8fafc', 'rgba(30,27,75,.85)', '#f8fafc'); break;
        case 'slate':       setVars('rgba(2,6,23,.35)', '#ffffff', 'rgba(2,6,23,.6)', '#ffffff'); break;
        case 'custom':
        default: {
          const {cardBg='#ffffff', cardAlpha=90, cardText='#0f172a'} = presetOrCustom;
          const a = Math.max(0.1, Math.min(1, cardAlpha/100));
          setVars(`rgba(${hexToRgb(cardBg)},${a})`, cardText, `rgba(${hexToRgb(cardBg)},${Math.min(1,a+0.05)})`, cardText);
        }
      }
    }
    function hexToRgb(hex){
      const v = hex.replace('#','');
      const bigint = parseInt(v, 16);
      const r = (bigint >> 16) & 255;
      const g = (bigint >> 8) & 255;
      const b = bigint & 255;
      return `${r},${g},${b}`;
    }

    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        const dates = generateDatesFromRange(dest.dates);
        dates.forEach(dObj => {
          const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
          const a = document.createElement('a');
          a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
          a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
          a.textContent = `×œ×•"×– ×œ×™×•× ${nice}`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', () => {
          submenu.classList.toggle('open');
          btn.querySelector('i').classList.toggle('rotate-180');
        });
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function renderHeadline(dayTitleFromDoc = null) {
      const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
      const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
      scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
      dayTitleEl.textContent = dayTitleFromDoc
        ? `${dayTitleFromDoc} â€¢ ${dateStr}`
        : `×œ×•×– ×œ×™×•× ${dateStr}`;
      tripSubtitle.textContent = `${destName}${dayPart ? ' â€¢' + dayPart : ''}`;
      dateChip.textContent = dateStr;
    }

    // ---- Item helpers ----
    function itemIcon(it){
      if (it.isBackToHotel) return 'fa-bed';
      return (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs) ? 'fa-triangle-exclamation' : 'fa-location-dot';
    }
    function timeText(it){
      if (!it?.startTime && !it?.endTime) return '--:--';
      return [it.startTime || '', it.endTime ? 'â€“ '+it.endTime : ''].filter(Boolean).join(' ');
    }
    function distanceText(m){
      if (m==null) return '';
      const km = (m/1000).toFixed(2);
      return `<span class="text-xs opacity-70"> â€¢ ××¨×—×§ ×§×•×“×: ${km} ×§×´×</span>`;
    }
    function verifyBadge(it){
      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      if (!needs) return '';
      const list = [
        it.needsVerifyAddress?'×›×ª×•×‘×ª':null,
        it.needsVerifyRoute?'××¡×œ×•×œ':null,
        it.needsVerifyRefs?'×§×™×©×•×¨':null
      ].filter(Boolean).join(' / ');
      return `<span class="inline-flex items-center gap-1 text-[12px] px-2 py-0.5 rounded-full bg-red-100 text-red-800 border border-red-300"><i class="fa-solid fa-circle-exclamation"></i> ×“×¨×•×© ××™××•×ª${list?': '+list:''}</span>`;
    }

    function cardHeaderHtml(it){
      return `
        <div class="flex items-center gap-2 flex-wrap">
          <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
          <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
          ${verifyBadge(it)}
          ${distanceText(it.distanceFromPreviousMeters)}
        </div>
        ${it.summary ? `<div class="mt-1 opacity-90">${it.summary}</div>` : ''}
      `;
    }
    function linksHtmlFor(it, tripId){
      const hasAddr = !!it.address?.label;
      const hasSite = !!it.links?.site;
      const hasBook = !!it.links?.booking;
      const refs = Array.isArray(it.refs)? it.refs : [];
      const refsHtml = refs.map(r=>{
        const href = `${r.page==='summary'?'summary':'attractions'}.html?tripId=${encodeURIComponent(tripId)}&open=${r.type==='logistics'?'logistics':'attraction'}&id=${encodeURIComponent(r.id)}`;
        const icon = r.type==='logistics' ? (r.subType==='hotel'?'ğŸ¨':r.subType==='flight'?'âœˆï¸':r.subType==='train'?'ğŸš†':r.subType==='car_rental'?'ğŸš—':r.subType==='ferry'?'â›´ï¸':'â¬…ï¸') : 'ğŸ“';
        return `<a class="px-2 py-1 rounded bg-indigo-600/90 text-white text-xs" target="_blank" href="${href}">${icon} ${r.label}</a>`;
      }).join(' ');

      const linkBtns = [
        hasSite ? `<a class="inline-flex items-center gap-1 text-sky-700 hover:underline" href="${it.links.site}" target="_blank"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
        hasBook ? `<a class="inline-flex items-center gap-1 text-cyan-700 hover:underline" href="${it.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
        refsHtml
      ].filter(Boolean).join(' ');

      const navHtml = hasAddr ? `
        <div class="flex gap-2">
          <a class="px-2 py-1 rounded bg-[#3b82f6] text-white text-xs" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}"><i class="fa-brands fa-waze"></i> ×•×™×™×–</a>
          <a class="px-2 py-1 rounded bg-[#16a34a] text-white text-xs" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}"><i class="fa-solid fa-location-dot"></i> ××¤×•×ª</a>
        </div>
      ` : '';

      return {linkBtns, navHtml};
    }

    // ---- Item modal map (geocode + render) ----
    let itemModalMap = null;
    async function ensureItemModalMap(addressLabel){
      if (!addressLabel){
        itemModalMapBox.classList.add('hidden');
        return;
      }
      const latlng = await geocodeAddress(addressLabel);
      if (!latlng){
        itemModalMapBox.classList.add('hidden');
        return;
      }
      itemModalMapBox.classList.remove('hidden');

      // × ×§×” ×× ×§×™×™×
      if (itemModalMap){
        itemModalMap.remove();
        itemModalMap = null;
      }
      // ×¦×•×¨ ××¤×”
      itemModalMap = L.map('item-modal-map', { scrollWheelZoom: false });
      const base = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(itemModalMap);
      const marker = L.marker([latlng.lat, latlng.lng]).addTo(itemModalMap);
      marker.bindPopup(addressLabel);
      itemModalMap.setView([latlng.lat, latlng.lng], 15);

      // ×ª×™×§×•×Ÿ ×¨×™× ×“×•×¨ ××—×¨×™ ×¤×ª×™×—×ª ××•×“×œ (×›×“×™ ×œ×—×©×‘ ×’×•×“×œ × ×›×•×Ÿ)
      setTimeout(()=> itemModalMap.invalidateSize(), 150);
    }

    function openItemModal(it){
      const {linkBtns, navHtml} = linksHtmlFor(it, tripId);
      itemModalContent.innerHTML = `
        <div class="flex items-start gap-3">
          <i class="fa-solid ${itemIcon(it)} text-sky-500 mt-1"></i>
          <div>
            <div class="text-xl font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</div>
            <div class="opacity-70">${timeText(it)}</div>
          </div>
        </div>
        ${it.summary ? `<div class="mt-3">${it.summary}</div>`:''}
        ${it.description ? `<div class="mt-3 whitespace-pre-wrap">${it.description}</div>`:''}
        ${it.address?.label ? `<div class="mt-3 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
        ${it.travel?.from?.label || it.travel?.to?.label ? `
          <div class="mt-2 text-sm opacity-80">
            <i class="fa-solid fa-route opacity-60"></i>
            ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''}
            ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''}
            ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}
          </div>` : ''
        }
        ${linkBtns ? `<div class="mt-4 flex flex-wrap gap-2">${linkBtns}</div>` : ''}
        ${navHtml ? `<div class="mt-2">${navHtml}</div>` : ''}
      `;
      itemModalBackdrop.classList.add('active');
      itemModal.classList.remove('hidden');
      ensureItemModalMap(it.address?.label || null);
    }
    function closeItemModal(){
      itemModalBackdrop.classList.remove('active');
      itemModal.classList.add('hidden');
    }

    // ---------- Day route map ----------
    let map, mapLayer;
    const segmentColors = ['#1d4ed8','#dc2626','#16a34a','#f59e0b','#7c3aed','#0891b2','#b45309','#0ea5e9'];
    const geocodeCache = JSON.parse(localStorage.getItem('geocodeCache') || '{}');

    async function geocodeAddress(q){
      if (!q) return null;
      if (geocodeCache[q]) return geocodeCache[q];
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`;
      const res = await fetch(url, {headers: {'Accept':'application/json'}});
      if (!res.ok) return null;
      const data = await res.json();
      const hit = data && data[0] ? {lat:+data[0].lat, lng:+data[0].lon} : null;
      if (hit){ geocodeCache[q] = hit; localStorage.setItem('geocodeCache', JSON.stringify(geocodeCache)); }
      return hit;
    }

    async function renderRouteMap(items){
      const routeContainer = document.getElementById('route-map');
      const legendBox = document.getElementById('route-legend');

      const steps = [];
      (items||[]).forEach(it=>{
        if (it?.address?.label){
          const label = it.address.label;
          if (steps.length===0 || steps[steps.length-1].label !== label){
            steps.push({label});
          }
        }
      });

      if (steps.length < 1){
        legendBox.innerHTML = `<div class="text-sm opacity-70">××™×Ÿ ×›×ª×•×‘×•×ª ×‘×œ×•×– ×œ×”×¦×’×” ×‘××¤×”.</div>`;
        if (map){ map.remove(); map=null; }
        return;
      }

      if (!map){
        map = L.map('route-map', {scrollWheelZoom: true});
        mapLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19, attribution: '&copy; OpenStreetMap'
        }).addTo(map);
      }

      const coords = [];
      for (let i=0;i<steps.length;i++){
        const addr = steps[i].label;
        let latlng = steps[i].latlng;
        if (!latlng){
          latlng = await geocodeAddress(addr);
          await new Promise(r=>setTimeout(r, 180));
        }
        if (latlng) { steps[i].latlng = latlng; coords.push(latlng); }
      }

      map.eachLayer(l=>{ if (l !== mapLayer) map.removeLayer(l); });
      legendBox.innerHTML = '';

      if (coords.length === 0){
        legendBox.innerHTML = `<div class="text-sm opacity-70">×œ× × ××¦××• ×§×•××•×¨×“×™× ×˜×•×ª ×œ×›×ª×•×‘×•×ª.</div>`;
        return;
      }

      const bounds = [];
      steps.forEach((s,idx)=>{
        if (!s.latlng) return;
        const m = L.marker([s.latlng.lat, s.latlng.lng]).addTo(map);
        m.bindPopup(`${idx+1}. ${s.label}`);
        bounds.push([s.latlng.lat, s.latlng.lng]);
      });
      map.fitBounds(bounds, {padding:[30,30]});

      for (let i=0;i<steps.length-1;i++){
        const a = steps[i].latlng, b = steps[i+1].latlng;
        if (!a || !b) continue;
        const color = segmentColors[i % segmentColors.length];
        const line = L.polyline([[a.lat,a.lng],[b.lat,b.lng]], {color, weight:4, opacity:.9}).addTo(map);
        L.polylineDecorator(line, {
          patterns: [{ offset: 25, repeat: 60, symbol: L.Symbol.arrowHead({pixelSize:10, polygon:false, pathOptions:{stroke:true, color}}) }]
        }).addTo(map);

        const leg = document.createElement('div');
        leg.className = 'flex items-center gap-2 text-sm';
        leg.innerHTML = `<span style="display:inline-block;width:14px;height:6px;border-radius:3px;background:${color}"></span> <span>${steps[i].label} <span class="opacity-60">></span> ${steps[i+1].label}</span>`;
        legendBox.appendChild(leg);
      }
    }

    // ---------- Notes colors ----------
    const colorMap = {
      red:    {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:  {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:   {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow: {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange: {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    function classesForColor(c){
      const m = colorMap[c] || colorMap.yellow;
      return `${m.bg} ${m.border} ${m.text}`;
    }
    function renderNotesList(notes){
      if (!notes || notes.length===0){
        notesList.innerHTML = `<div class="opacity-80">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        return `
          <div class="border rounded-xl p-3 ${classesForColor(n.color)}">
            <div class="font-bold">${n.kind}: ${n.title || 'â€”'}</div>
            ${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap">${n.details}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ---------- Events ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);

      settingsBtn.addEventListener('click', ()=> openSettings('bg'));
      settingsClose.addEventListener('click', closeSettings);
      settingsBackdrop.addEventListener('click', closeSettings);

      tabButtons.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          tabButtons.forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          switchTab(btn.dataset.tab);
        });
      });
      themePreset.addEventListener('change', ()=>{
        themeCustomBox.classList.toggle('hidden', themePreset.value!=='custom');
      });

      itemModalClose.addEventListener('click', closeItemModal);
      itemModalBackdrop.addEventListener('click', closeItemModal);

      bgBrightness.addEventListener('input', e=> setOverlayByBrightness(+e.target.value));
    }

    // ---------- UI (Firestore) ----------
    function effectiveUI(){
      const ui = (tripData && tripData.ui) || {};
      const destKey = destKeyFromDest(destForDate);

      const bgDate = (schedData && schedData.background) || null;
      const bgDest = (ui.destBackgrounds && ui.destBackgrounds[destKey]) || null;
      const bgDefault = ui.backgroundDefault || null;

      const layoutDate = (schedData && schedData.ui && schedData.ui.cardStyle) || null;
      const layoutDest = (ui.cardStyleByDest && ui.cardStyleByDest[destKey]) || null;
      const layoutDefault = (ui.cardStyleDefault || 'modal');

      const themeDate = (schedData && schedData.ui && schedData.ui.theme) || null;
      const themeDest = (ui.themeByDest && ui.themeByDest[destKey]) || null;
      const themeDefault = ui.themeDefault || {preset:'classic'};

      return {
        background: bgDate || bgDest || bgDefault,
        layout: layoutDate || layoutDest || layoutDefault,
        theme: themeDate || themeDest || themeDefault
      };
    }

    async function saveBackground(scope, payload){
      const destKey = destKeyFromDest(destForDate);
      if (scope==='date' && dateISO){
        const ref = doc(db, 'trips', tripId, 'schedules', dateISO);
        await setDoc(ref, { background: payload }, { merge:true });
      } else if (scope==='dest'){
        const ref = doc(db, 'trips', tripId);
        const patch = {}; patch[`ui.destBackgrounds.${destKey}`] = payload;
        await setDoc(ref, patch, { merge:true });
      } else {
        const ref = doc(db, 'trips', tripId);
        await setDoc(ref, { ui: { backgroundDefault: payload } }, { merge:true });
      }
    }
    async function saveLayout(scope, style){
      const destKey = destKeyFromDest(destForDate);
      if (scope==='date' && dateISO){
        const ref = doc(db, 'trips', tripId, 'schedules', dateISO);
        await setDoc(ref, { ui: { cardStyle: style } }, { merge:true });
      } else if (scope==='dest'){
        const ref = doc(db, 'trips', tripId);
        const patch = {}; patch[`ui.cardStyleByDest.${destKey}`] = style;
        await setDoc(ref, patch, { merge:true });
      } else {
        const ref = doc(db, 'trips', tripId);
        await setDoc(ref, { ui: { cardStyleDefault: style } }, { merge:true });
      }
    }
    async function saveTheme(scope, themeObj){
      const destKey = destKeyFromDest(destForDate);
      if (scope==='date' && dateISO){
        const ref = doc(db, 'trips', tripId, 'schedules', dateISO);
        await setDoc(ref, { ui: { theme: themeObj } }, { merge:true });
      } else if (scope==='dest'){
        const ref = doc(db, 'trips', tripId);
        const patch = {}; patch[`ui.themeByDest.${destKey}`] = themeObj;
        await setDoc(ref, patch, { merge:true });
      } else {
        const ref = doc(db, 'trips', tripId);
        await setDoc(ref, { ui: { themeDefault: themeObj } }, { merge:true });
      }
    }

    // ---------- Init ----------
    async function initPage() {
      const url = new URLSearchParams(window.location.search);
      tripId = url.get('tripId');
      dateStr = decodeURIComponent(url.get('date') || '').trim();

      const parsed = parseLocalDateFlexible(dateStr);
      if (parsed) {
        dateISO = toISODateUTC(parsed);
        dayNameHe = hebWeekdayUTC(parsed);
      } else {
        dateISO = null;
        dayNameHe = "";
      }

      if (!tripId || !dateStr) {
        alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.');
        location.href = 'index.html'; return;
      }

      attachEvents();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        // Load trip
        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);
        if (!tripSnap.exists()) { alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href = 'index.html'; return; }
        tripData = tripSnap.data();
        if (tripData.ownerId && tripData.ownerId !== currentUser.uid) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.'); location.href = 'index.html'; return;
        }

        // ×™×¢×“/×ª×¤×¨×™×˜
        destForDate = findDestinationForDate(tripData, dateStr);
        buildMenuFromTrip();

        // ×§×™×©×•×¨×™×
        const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
        const editHref   = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
        document.getElementById('create-schedule-btn').href = editHref;
        document.getElementById('edit-schedule-bottom-btn').href = editHref;
        tripPageBtn.href = `summary.html?tripId=${encodeURIComponent(tripId)}`;

        // headline + UI
        if (dateISO){
          const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
          const schedSnap = await getDoc(schedDocRef);
          scheduleExists = schedSnap.exists();
          schedData = scheduleExists ? schedSnap.data() : null;

          renderHeadline(schedData ? (schedData.title || null) : null);

          const uiEff = effectiveUI();
          cardStyle = uiEff.layout || 'modal';
          setThemeVars(uiEff.theme || {preset:'classic'});
          applyBackgroundSetting(uiEff.background, destForDate);

          // items
          const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
          const qItems = query(itemsCol, orderBy('sort','asc'));
          onSnapshot(qItems, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderTimeline(arr);
            toggleCTA(arr && arr.length>0);
          }, ()=> { renderTimeline([]); toggleCTA(false); });

          // notes
          const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
          const qNotes = query(notesCol, orderBy('createdAt','asc'));
          onSnapshot(qNotes, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderNotesList(arr);
          }, ()=> renderNotesList([]));
        } else {
          renderHeadline(null);
          const uiEff = effectiveUI();
          cardStyle = uiEff.layout || 'modal';
          setThemeVars(uiEff.theme || {preset:'classic'});
          applyBackgroundSetting(uiEff.background, destForDate);

          // fallback events
          const eventsCol = collection(db, 'trips', tripId, 'events');
          const q2 = query(eventsCol, where('date','==', dateStr), orderBy('time'));
          onSnapshot(q2, (snap) => {
            const items = snap.docs.map(d => d.data()).map(e=>({
              title: e.title,
              startTime: e.time, endTime:null,
              description: e.notes || null,
              address: e.location ? {label:e.location} : null,
              links: {site: e.link || null, booking: null},
            }));
            renderTimeline(items);
            toggleCTA(items && items.length>0);
          }, () => { renderTimeline([]); toggleCTA(false); });
          renderNotesList([]);
        }

        function toggleCTA(hasItems){
          if (scheduleExists || hasItems){
            createBtn.classList.add('hidden');
            editBottomBtn.classList.remove('hidden');
          } else {
            editBottomBtn.classList.add('hidden');
            createBtn.classList.remove('hidden');
          }
        }

        // Reveal UI
        initialLoader.style.opacity = '0';
        mainContent.style.opacity = '1';
        setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
      });

      // Settings actions
      bgApplyBtn.addEventListener('click', async ()=>{
        const url = (bgImageUrl.value||'').trim();
        const color = bgColorInput.value || '#0ea5e9';
        const brightness = +bgBrightness.value || 70;
        const scope = bgScope.value;
        const payload = url ? {type:'image', url, brightness} : {type:'color', color, brightness};
        await saveBackground(scope, payload);
        applyBackgroundSetting(payload, destForDate);
        alert('×”×¨×§×¢ × ×©××¨.');
      });

      layoutApply.addEventListener('click', async ()=>{
        const style = layoutStyleSel.value;
        const scope = layoutScope.value;
        await saveLayout(scope, style);
        cardStyle = style;
        alert('×¡×’× ×•×Ÿ ×”×ª×¦×•×’×” × ×©××¨.');
      });

      themeApply.addEventListener('click', async ()=>{
        const scope = themeScope.value;
        let themeObj;
        if (themePreset.value==='custom'){
          themeObj = {preset:'custom', cardBg: themeCardBg.value, cardAlpha: +themeCardAlpha.value, cardText: themeCardText.value};
        } else {
          themeObj = {preset: themePreset.value};
        }
        await saveTheme(scope, themeObj);
        setThemeVars(themeObj);
        alert('×¢×¨×›×ª ×”×›×¨×˜×™×¡×™×•×ª/×—×œ×•× ×•×ª × ×©××¨×”.');
      });

      themePreset.dispatchEvent(new Event('change'));
    }

    // ---- Timeline renderers (incl. Accordion) ----
    function renderTimeline(items){
      renderRouteMap(items);

      if (!items || items.length === 0) {
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        timelineBox.innerHTML = '';
        return;
      }
      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      timelineBox.innerHTML = '';

      items.forEach((it, idx)=>{
        const {linkBtns, navHtml} = linksHtmlFor(it, tripId);
        const base = document.createElement('div');
        base.className = 'timeline-item theme-card rounded-xl shadow p-4';

        if (cardStyle === 'accordion' || cardStyle === 'inline_full'){
          base.innerHTML = `
            <span class="timeline-dot"></span>
            <div class="flex items-start gap-4">
              <div class="shrink-0 text-center">
                <div class="text-sm font-bold">${timeText(it)}</div>
                <div class="text-xs opacity-70">×¤×¨×™×˜</div>
              </div>
              <div class="flex-1">
                ${cardHeaderHtml(it)}
                <button class="mt-2 text-sm underline text-sky-700 toggle-btn">×¤×ª×—/×¡×’×•×¨</button>
                <div class="toggle-area mt-3 hidden">
                  ${it.description ? `<p class="whitespace-pre-wrap">${it.description}</p>` : ''}
                  ${it.address?.label ? `<div class="mt-2 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
                  ${it.travel?.from?.label || it.travel?.to?.label ? `
                    <div class="mt-2 text-xs opacity-80">
                      <i class="fa-solid fa-route opacity-60"></i>
                      ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''}
                      ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''}
                      ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}
                    </div>` : ''
                  }
                  ${linkBtns ? `<div class="mt-3 flex flex-wrap gap-2">${linkBtns}</div>` : ''}
                  ${navHtml ? `<div class="mt-2">${navHtml}</div>` : ''}
                  ${cardStyle==='accordion' ? `<button class="mt-3 px-3 py-1 rounded border open-modal">×¤×¨×˜×™× ××œ××™×</button>`:''}
                </div>
              </div>
            </div>
          `;
          base.querySelector('.toggle-btn').addEventListener('click',()=>{
            base.querySelector('.toggle-area').classList.toggle('hidden');
          });
          if (cardStyle==='accordion'){
            base.querySelector('.open-modal').addEventListener('click',()=> openItemModal(it));
          }
        } else {
          // modal / timeline_line
          base.innerHTML = `
            <span class="timeline-dot"></span>
            <button class="w-full text-right">
              <div class="flex items-start gap-4">
                <div class="shrink-0 text-center">
                  <div class="text-sm font-bold">${timeText(it)}</div>
                  <div class="text-xs opacity-70">×¤×¨×™×˜</div>
                </div>
                <div class="flex-1">
                  ${cardHeaderHtml(it)}
                  ${it.address?.label ? `<div class="mt-2 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
                  ${linkBtns ? `<div class="mt-3 flex flex-wrap gap-2">${linkBtns}</div>` : ''}
                </div>
              </div>
            </button>
          `;
          base.querySelector('button').addEventListener('click',()=> openItemModal(it));
          if (cardStyle==='timeline_line'){
            base.style.borderRight = '4px solid rgba(30,41,59,.3)';
          }
        }

        timelineBox.appendChild(base);
      });
    }

    // ---------- Start ----------
    initPage();
  </script>
</body>
</html>
