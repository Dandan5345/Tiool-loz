<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>

  <!-- Tailwind + Icons + Font -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <!-- Arrows on polylines -->
  <script defer src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

  <style>
    :root{
      --card-bg: rgba(255,255,255,.85);
      --card-text: #1e293b;        /* slate-800 */
      --card-text-2: #475569;      /* slate-600 */
      --card-border: rgba(203,213,225,.5);
      --overlay-alpha: .5;
    }
    html,body{height:100%;background:#f1f5f9;font-family:'Assistant',sans-serif;overscroll-behavior-y:contain}
    .bg-fixed-image{background-size:cover;background-position:center}
    #initial-loader{position:fixed;inset:0;z-index:100;display:flex;align-items:center;justify-content:center;transition:opacity .5s}
    @keyframes spin{from{transform:rotate(0)}to{transform:rotate(360deg)}} .plane-spinner{animation:spin 2s linear infinite}
    .themed-card{background:var(--card-bg);color:var(--card-text);border:1px solid var(--card-border);backdrop-filter:blur(10px)}
    .themed-card h1,.themed-card h2,.themed-card h3,.themed-card h4{color:var(--card-text)}
    .themed-card p,.themed-card span,.themed-card div{color:var(--card-text-2)}
    .timeline{position:relative}
    .timeline.layout-line-style::before{content:"";position:absolute;right:20px;top:0;bottom:0;width:2px;background:rgba(30,41,59,.15)}
    .timeline-item-wrapper{position:relative}
    .timeline-time-outside{position:absolute;right:-1.5rem;top:1rem;background:var(--card-bg);padding:.25rem .5rem;border-radius:9999px;font-size:.75rem;font-weight:700;border:1px solid var(--card-border);box-shadow:0 1px 3px rgba(0,0,0,.1);z-index:10}
    /* Scroll-jitter mitigations */
    header,.bg-fixed-image{transform:translateZ(0)}
    /* Maps */
    #route-map,.accordion-map,.modal-map{height:260px;border-radius:1rem;background:#e2e8f0;overflow:hidden}
    #route-map{height:380px}
    .leaflet-container{font-family:'Assistant',sans-serif}
    /* Item modal */
    .item-modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.7);z-index:100;display:none;align-items:center;justify-content:center}
    .item-modal-backdrop.active{display:flex}
    .item-modal{width:100%;max-width:640px;max-height:90vh;overflow:auto;border-radius:1rem;background:var(--card-bg);color:var(--card-text);padding:1rem;transform:scale(.98);transition:transform .2s}
    .item-modal-backdrop.active .item-modal{transform:scale(1)}
    /* Slide panels */
    #sidebar,#settings-modal{transition:transform .3s}
    .submenu{max-height:0;overflow:hidden;transition:max-height .5s}
    .submenu.open{max-height:1200px}
    /* Settings (mobile-friendly) */
    #settings-modal .settings-body{min-height:100%;display:flex;flex-direction:column}
    #settings-modal .settings-header{position:sticky;top:0;background:#fff;border-bottom:1px solid rgba(15,23,42,.08);z-index:2}
    #settings-modal .settings-content{flex:1;overflow:auto;padding:1rem}
    .settings-nav{display:grid;grid-template-columns:repeat(3,1fr);gap:.5rem;border:1px solid #e2e8f0;border-radius:.75rem;padding:.25rem}
    .settings-btn{padding:.5rem;border-radius:.5rem;font-weight:700}
    .settings-btn.active{background:#e2e8f0}
    .settings-section{background:#fff;border:1px solid rgba(15,23,42,.08);border-radius:1rem;padding:1rem}
  </style>
</head>
<body class="bg-slate-100">
  <!-- Loader -->
  <div id="initial-loader">
    <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg')"></div>
    <div id="loader-overlay" class="fixed inset-0 z-0" style="background:rgba(0,0,0,var(--overlay-alpha))"></div>
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
    </div>
  </div>

  <!-- Background -->
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg')"></div>
  <div id="page-bg-overlay" class="fixed inset-0 z-0" style="background:rgba(0,0,0,var(--overlay-alpha))"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-full max-w-sm sm:max-w-md bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
      <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>

  <!-- Settings (slide-in, mobile friendly) -->
  <aside id="settings-modal" class="fixed top-0 right-0 h-full w-full max-w-[20rem] sm:max-w-[24rem] bg-white shadow-2xl z-[80] transform translate-x-full overflow-hidden">
    <div class="settings-body">
      <div class="settings-header p-4 flex items-center justify-between">
        <h2 class="text-2xl font-bold">×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ğŸ¨</h2>
        <button id="close-settings-btn" class="p-2 text-slate-500 hover:text-red-500" aria-label="×¡×’×•×¨ ×”×’×“×¨×•×ª"><i class="fas fa-times fa-lg"></i></button>
      </div>
      <div class="settings-content">
        <div class="settings-nav mb-4">
          <button class="settings-btn active" data-panel="bg">×¨×§×¢</button>
          <button class="settings-btn" data-panel="layout">×¤×¨×™×¡×”</button>
          <button class="settings-btn" data-panel="theme">×¢×¨×›×ª × ×•×©×</button>
        </div>

        <!-- BG -->
        <div id="settings-panel-bg" class="space-y-4">
          <div class="settings-section">
            <label class="font-bold">×ª××•× ×ª ×¨×§×¢ (URL)</label>
            <input id="bg-image-url" type="url" placeholder="https://â€¦" class="w-full mt-1 p-2 border rounded-md">
            <div class="mt-3">
              <label class="font-bold">××• ×‘×—×¨ ×¦×‘×¢</label>
              <input id="bg-color-picker" type="color" value="#f1f5f9" class="w-full h-10 mt-1 border-none cursor-pointer">
            </div>
            <div class="mt-3">
              <label class="font-bold" for="bg-brightness-slider">×‘×”×™×¨×•×ª ×¨×§×¢</label>
              <input id="bg-brightness-slider" type="range" min="0" max="100" value="50" class="w-full">
              <div class="text-xs text-slate-500 mt-1">0% ×›×”×” ×××•×“ â€¢ 100% ×œ×œ× ×©×›×‘×ª ××¤×œ×”</div>
            </div>
            <div class="mt-4 pt-3 border-t">
              <label class="font-bold">×”×—×œ ×¢×œ:</label>
              <select id="bg-scope" class="w-full mt-1 p-2 border rounded-md">
                <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                <option value="date">×¨×§ ×ª××¨×™×š ×–×”</option>
                <option value="trip">×›×œ ×”×œ×•"×–×™× ×‘×˜×™×•×œ</option>
              </select>
              <button id="apply-bg-settings" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
            </div>
          </div>
        </div>

        <!-- Layout -->
        <div id="settings-panel-layout" class="space-y-4 hidden">
          <div class="settings-section space-y-2">
            <p class="font-bold">×¡×’× ×•×Ÿ ×ª×¦×•×’×”</p>
            <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
              <input type="radio" name="timeline-layout" value="default" checked> 
              <div><div class="font-bold">×›×¨×˜×™×¡×™×•×ª (××•×“×œ ×‘×œ×—×™×¦×”)</div><div class="text-sm text-slate-500">×‘×¨×™×¨×ª ××—×“×œ</div></div>
            </label>
            <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
              <input type="radio" name="timeline-layout" value="accordion-summary"> 
              <div><div class="font-bold">××§×•×¨×“×™×•×Ÿ ×—×œ×§×™</div><div class="text-sm text-slate-500">×¤×ª×™×—×” ×œ×¤×™×¨×•×˜ ×§×¦×¨ + ×›×¤×ª×•×¨ ×œ×¤×¨×˜×™× ××œ××™×</div></div>
            </label>
            <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
              <input type="radio" name="timeline-layout" value="accordion-full"> 
              <div><div class="font-bold">××§×•×¨×“×™×•×Ÿ ××œ×</div><div class="text-sm text-slate-500">×›×œ ×”×¤×¨×˜×™× × ×¤×ª×—×™× ×‘×ª×•×š ×”×›×¨×˜×™×¡×™×”</div></div>
            </label>
            <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
              <input type="radio" name="timeline-layout" value="line-style"> 
              <div><div class="font-bold">×¦×™×¨ ×–××Ÿ</div><div class="text-sm text-slate-500">×§×• ×× ×›×™ + ××•×“×œ ×‘×œ×—×™×¦×”</div></div>
            </label>
            <div class="pt-3 border-t">
              <label class="font-bold">×”×—×œ ×¢×œ:</label>
              <select id="layout-scope" class="w-full mt-1 p-2 border rounded-md">
                <option value="trip">×›×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                <option value="destination">×”×™×¢×“ ×”× ×•×›×—×™</option>
                <option value="date">×¨×§ ×ª××¨×™×š ×–×”</option>
              </select>
              <button id="apply-layout-settings" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
            </div>
          </div>
        </div>

        <!-- Theme -->
        <div id="settings-panel-theme" class="space-y-4 hidden">
          <div class="settings-section space-y-3">
            <div>
              <label class="font-bold">×¦×‘×¢ ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª</label>
              <input id="card-bg-color-picker" type="color" value="#ffffff" class="w-full h-10 mt-1 border-none cursor-pointer">
            </div>
            <div>
              <label class="font-bold" for="card-opacity-slider">×©×§×™×¤×•×ª ×¨×§×¢</label>
              <input id="card-opacity-slider" type="range" min="10" max="100" value="85" class="w-full">
            </div>
            <div>
              <label class="font-bold">×¦×‘×¢ ×˜×§×¡×˜</label>
              <input id="card-text-color-picker" type="color" value="#1e293b" class="w-full h-10 mt-1 border-none cursor-pointer">
            </div>

            <!-- scope for theme -->
            <div class="pt-4 border-t">
              <label class="font-bold text-slate-700">×”×—×œ ×”×’×“×¨×•×ª ×¢×œ:</label>
              <select id="theme-scope" class="w-full mt-1 p-2 border rounded-md">
                <option value="trip">×›×œ ×”×œ×•"×–×™× ×©×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×–×”</option>
                <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ ×”×–×”</option>
              </select>
            </div>

            <div class="pt-3 border-t">
              <p class="font-bold">××• ×¢×¨×›×” ××•×›× ×”:</p>
              <div class="grid grid-cols-2 gap-2 mt-2">
                <button class="preset p-3 border rounded-lg" data-theme="glass"><div class="font-bold">×–×›×•×›×™×ª</div><div class="text-xs">×©×§×•×£/×œ×‘×Ÿ</div></button>
                <button class="preset p-3 border rounded-lg" data-theme="light"><div class="font-bold">×‘×”×™×¨</div><div class="text-xs">×œ×‘×Ÿ/×©×—×•×¨</div></button>
                <button class="preset p-3 border rounded-lg text-white bg-slate-800" data-theme="dark"><div class="font-bold">×›×”×”</div><div class="text-xs">×›×”×”/×œ×‘×Ÿ</div></button>
                <button class="preset p-3 border rounded-lg text-white bg-cyan-700" data-theme="ocean"><div class="font-bold">××•×§×™×™× ×•×¡</div><div class="text-xs">×›×—×•×œ/×œ×‘×Ÿ</div></button>
                <button class="preset p-3 border rounded-lg text-white bg-orange-500" data-theme="sunset"><div class="font-bold">×©×§×™×¢×”</div><div class="text-xs">×›×ª×•×/×œ×‘×Ÿ</div></button>
                <button class="preset p-3 border rounded-lg text-white bg-green-800" data-theme="forest"><div class="font-bold">×™×¢×¨</div><div class="text-xs">×™×¨×•×§/×œ×‘×Ÿ</div></button>
                <button class="preset p-3 border rounded-lg bg-violet-200 text-violet-900" data-theme="lavender"><div class="font-bold">×œ×‘× ×“×¨</div><div class="text-xs">×¡×’×•×œ ×‘×”×™×¨</div></button>
                <button class="preset p-3 border rounded-lg bg-amber-100 text-amber-900" data-theme="sand"><div class="font-bold">×—×•×œ</div><div class="text-xs">×¦×”×‘×”×‘</div></button>

                <!-- new presets -->
                <button class="preset p-3 border rounded-lg bg-rose-600 text-white" data-theme="rose">
                  <div class="font-bold">×•×¨×“</div><div class="text-xs">×•×¨×•×“ ×¢×–</div>
                </button>
                <button class="preset p-3 border rounded-lg bg-slate-900 text-white" data-theme="midnight">
                  <div class="font-bold">×—×¦×•×ª</div><div class="text-xs">×›×”×” ×¢××•×§</div>
                </button>
                <button class="preset p-3 border rounded-lg bg-emerald-600 text-white" data-theme="mint">
                  <div class="font-bold">×× ×˜×”</div><div class="text-xs">×™×¨×§×¨×§ ×¨×¢× ×Ÿ</div>
                </button>
                <button class="preset p-3 border rounded-lg bg-amber-700 text-white" data-theme="cafe">
                  <div class="font-bold">×§×¤×”</div><div class="text-xs">×—××™× ××¨×¦×™</div>
                </button>
              </div>

              <button id="apply-theme-settings" class="mt-4 w-full bg-blue-600 text-white font-bold py-2 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </aside>

  <div id="overlay" class="fixed inset-0 bg-black/60 z-[70] hidden"></div>

  <!-- Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500 min-h-screen">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <button id="trip-home-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ"><i class="fas fa-map-signs fa-lg"></i></button>
            <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
          </div>
          <div class="flex items-center gap-2">
            <div id="auth-container" class="flex items-center"></div>
            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×”×’×“×¨×•×ª ×¢×™×¦×•×‘"><i class="fas fa-cog fa-lg"></i></button>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <!-- Title -->
        <section id="title-card" class="themed-card rounded-2xl shadow-lg p-5">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold">×œ×•×– ×œ×™×•×</h2>
              <p id="trip-subtitle" class="mt-1"></p>
            </div>
            <div class="flex items-center gap-2">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
        </section>

        <!-- Timeline -->
        <section id="timeline-section">
          <div id="no-schedule" class="themed-card text-center p-10 rounded-2xl shadow-lg">
            <i class="fa-regular fa-clock fa-3x mb-4"></i>
            <h3 class="text-xl font-bold mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
            <p>×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
          </div>
          <div id="timeline" class="timeline space-y-4 hidden"></div>
        </section>

        <!-- Notes -->
        <section id="notes-section" class="themed-card rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
          <div id="notes-list" class="grid gap-3"><div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div></div>
        </section>

        <!-- Day Route Map -->
        <section id="map-container-section" class="themed-card rounded-2xl shadow-lg p-5 hidden">
          <h3 class="text-lg font-bold mb-3">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
          <div id="route-map"></div>
          <div id="map-legend" class="mt-4 space-y-2 text-sm"></div>
        </section>

        <!-- CTA -->
        <section class="flex justify-center gap-3">
          <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all">
            <i class="fa-solid fa-wand-magic-sparkles"></i> ×¦×•×¨ ×œ×•×–
          </a>
          <a id="edit-schedule-btn" href="#" class="hidden items-center gap-2 bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all">
            <i class="fa-solid fa-pen"></i> ×¢×¨×•×š ×œ×•×–
          </a>
        </section>

      </div>
    </main>
  </div>

  <!-- Item Modal -->
  <div id="item-modal-backdrop" class="item-modal-backdrop" aria-hidden="true">
    <div id="item-modal" class="item-modal" role="dialog" aria-modal="true" aria-labelledby="item-modal-title">
      <button id="item-modal-close" class="p-2 rounded hover:bg-black/5" title="×¡×’×•×¨"><i class="fa-solid fa-xmark"></i></button>
      <div id="item-modal-content" class="mt-2"></div>
      <div id="item-modal-map" class="modal-map mt-4 hidden"></div>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // State
    let currentUser=null, tripId=null, tripData=null, dateStr=null, dateISO=null, dayNameHe="", destForDate=null;
    let currentScheduleItems=[], currentLayout='default';
    let mapInstance=null, mapBase=null, modalMap=null;
    const accordionMaps = {};
    const geocodeCache = JSON.parse(localStorage.getItem('geoCache')||'{}');
    let schedData = null;

    // UI refs
    const initialLoader = document.getElementById('initial-loader');
    const mainContent = document.getElementById('main-content');
    const pageBg = document.getElementById('page-bg');
    const pageBgOverlay = document.getElementById('page-bg-overlay');
    const loaderBg = document.getElementById('loader-bg');

    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');

    const settingsModal = document.getElementById('settings-modal');
    const settingsBtn = document.getElementById('settings-btn');
    const closeSettingsBtn = document.getElementById('close-settings-btn');

    const mainMenu = document.getElementById('main-menu');
    const authContainer = document.getElementById('auth-container');
    const tripHomeBtn = document.getElementById('trip-home-btn');

    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl = document.getElementById('day-title');
    const tripSubtitle = document.getElementById('trip-subtitle');
    const dateChip = document.getElementById('date-chip');

    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox = document.getElementById('timeline');
    const createBtn = document.getElementById('create-schedule-btn');
    const editBtn = document.getElementById('edit-schedule-btn');

    const notesList = document.getElementById('notes-list');
    const mapContainerSection = document.getElementById('map-container-section');
    const mapLegend = document.getElementById('map-legend');

    const itemModalBackdrop = document.getElementById('item-modal-backdrop');
    const itemModal = document.getElementById('item-modal');
    const itemModalClose = document.getElementById('item-modal-close');
    const itemModalContent = document.getElementById('item-modal-content');
    const itemModalMap = document.getElementById('item-modal-map');

    // Helpers
    const sleep = (ms)=>new Promise(r=>setTimeout(r,ms));
    function toggleSidebar(){ sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); settingsModal.classList.add('translate-x-full'); }
    function toggleSettings(){ settingsModal.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); sidebar.classList.add('translate-x-full'); }
    function parseLocalDateFlexible(s){ if(!s) return null; const m=s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/); if(!m) return null; let d=+m[1],mo=+m[2],y=+m[3]; if(y<100) y+=2000; const dt=new Date(Date.UTC(y,mo-1,d)); return isNaN(dt.getTime())?null:dt;}
    function toISO(d){const y=d.getUTCFullYear(),m=String(d.getUTCMonth()+1).padStart(2,'0'),dd=String(d.getUTCDate()).padStart(2,'0');return `${y}-${m}-${dd}`;}
    function hebWeekdayUTC(d){return ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª'][d.getUTCDay()];}
    function generateDatesFromRange(rangeStr){ if(!rangeStr||!rangeStr.includes(' - '))return[]; const[s,e]=rangeStr.split(' - '); const S=parseLocalDateFlexible(s),E=parseLocalDateFlexible(e); if(!S||!E)return[]; const out=[]; for(let t=new Date(S); t<=E; t.setUTCDate(t.getUTCDate()+1)) out.push(new Date(t)); return out;}
    function findDestinationForDate(trip, raw){ const target=parseLocalDateFlexible(raw); if(!target) return null; const iso=toISO(target); return (trip.destinations||[]).find(dest=>generateDatesFromRange(dest.dates).map(toISO).includes(iso))||null;}
    function setBackground({type,value,brightness}){ if(type==='image'){ pageBg.style.backgroundImage=`url('${value}')`; document.body.style.backgroundColor=''; } else { pageBg.style.backgroundImage='none'; document.body.style.backgroundColor=value; } pageBgOverlay.style.backgroundColor=`rgba(0,0,0,${1-(brightness/100)})`; }
    function setTheme({cardBg,cardText,cardText2,cardBorder}){ document.documentElement.style.setProperty('--card-bg',cardBg); document.documentElement.style.setProperty('--card-text',cardText); document.documentElement.style.setProperty('--card-text-2',cardText2||cardText); document.documentElement.style.setProperty('--card-border',cardBorder); renderTimeline(currentScheduleItems); }
    function setCurrentLayout(layout){ currentLayout=layout; timelineBox.className=`timeline space-y-4 ${layout==='line-style'?'layout-line-style':''}`; renderTimeline(currentScheduleItems); }

    // UI hierarchy + saving (Firestore)
    function destKeyFromDest(dest){
      const key = dest?.id || dest?.nameHe || dest?.name || '';
      return String(key).toLowerCase().trim().replace(/\s+/g,'_');
    }
    function effectiveUI(){
      const ui = (tripData && tripData.ui) || {};
      const destKey = destKeyFromDest(destForDate);

      const bgDate = (schedData && schedData.background) || null;
      const bgDest = (ui.destBackgrounds && ui.destBackgrounds[destKey]) || null;
      const bgDefault = ui.backgroundDefault || null;

      const layoutDate = (schedData && schedData.ui && schedData.ui.cardStyle) || null;
      const layoutDest = (ui.cardStyleByDest && ui.cardStyleByDest[destKey]) || null;
      const layoutDefault = ui.cardStyleDefault || 'default';

      const themeDate = (schedData && schedData.ui && schedData.ui.theme) || null;
      const themeDest = (ui.themeByDest && ui.themeByDest[destKey]) || null;
      const themeDefault = ui.themeDefault || null;

      return {
        background: bgDate || bgDest || bgDefault,
        layout: layoutDate || layoutDest || layoutDefault,
        theme: themeDate || themeDest || themeDefault
      };
    }
    async function saveBackground(scope, payload){
      const tripRef = doc(db,'trips',tripId);
      const destKey = destKeyFromDest(destForDate);
      if (scope==='date' && dateISO){
        await setDoc(doc(db,'trips',tripId,'schedules',dateISO), { background: payload }, { merge:true });
      } else if (scope==='destination'){
        const patch = {}; patch[`ui.destBackgrounds.${destKey}`] = payload;
        await setDoc(tripRef, patch, { merge:true });
      } else {
        await setDoc(tripRef, { ui: { backgroundDefault: payload } }, { merge:true });
      }
    }
    async function saveLayout(scope, style){
      const tripRef = doc(db,'trips',tripId);
      const destKey = destKeyFromDest(destForDate);
      if (scope==='date' && dateISO){
        await setDoc(doc(db,'trips',tripId,'schedules',dateISO), { ui: { cardStyle: style } }, { merge:true });
      } else if (scope==='destination'){
        const patch = {}; patch[`ui.cardStyleByDest.${destKey}`] = style;
        await setDoc(tripRef, patch, { merge:true });
      } else {
        await setDoc(tripRef, { ui: { cardStyleDefault: style } }, { merge:true });
      }
    }
    async function saveTheme(scope, themeObj){
      const tripRef = doc(db,'trips',tripId);
      const destKey = destKeyFromDest(destForDate);
      if (scope==='date' && dateISO){
        await setDoc(doc(db,'trips',tripId,'schedules',dateISO), { ui: { theme: themeObj } }, { merge:true });
      } else if (scope==='destination'){
        const patch = {}; patch[`ui.themeByDest.${destKey}`] = themeObj;
        await setDoc(tripRef, patch, { merge:true });
      } else {
        await setDoc(tripRef, { ui: { themeDefault: themeObj } }, { merge:true });
      }
    }
    function applyStylingFromTripData(){
      const uiEff = effectiveUI();
      if (uiEff.background) setBackground(uiEff.background);
      if (uiEff.theme) setTheme(uiEff.theme);
      setCurrentLayout(uiEff.layout || 'default');
    }

    // Icons & text
    function itemIcon(it){ return it.isBackToHotel ? 'fa-solid fa-bed' : (it.needsVerifyAddress||it.needsVerifyRoute||it.needsVerifyRefs) ? 'fa-solid fa-triangle-exclamation' : 'fa-solid fa-location-dot'; }
    function timeText(it){ if(!it?.startTime && !it?.endTime) return '--:--'; return [it.startTime||'', it.endTime?('â€“ '+it.endTime):''].filter(Boolean).join(' '); }

    // Geocoding (OSM Nominatim) + cache
    async function geocode(label){
      if(!label) return null;
      if(geocodeCache[label]) return geocodeCache[label];
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(label)}`;
      const res = await fetch(url, {headers:{'Accept':'application/json'}});
      if(!res.ok) return null;
      const data = await res.json();
      const hit = data && data[0] ? {lat:+data[0].lat, lng:+data[0].lon} : null;
      if(hit){ geocodeCache[label]=hit; localStorage.setItem('geoCache', JSON.stringify(geocodeCache)); }
      await sleep(150); // rate-limit friendly
      return hit;
    }

    // Menu
    function buildMenuFromTrip(){
      mainMenu.innerHTML='';
      if(!tripData?.destinations) return;
      tripData.destinations.forEach(dest=>{
        const wrap=document.createElement('div');
        const btn=document.createElement('button');
        btn.className='w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML=`<span>${dest.nameHe||dest.name}</span> <i class="fas fa-chevron-down transition-transform"></i>`;
        const submenu=document.createElement('div');
        submenu.className='submenu mt-1 mr-2 border-r-2 border-slate-200';
        generateDatesFromRange(dest.dates).forEach(d=>{
          const nice=`${d.getUTCDate()}/${d.getUTCMonth()+1}/${d.getUTCFullYear()}`;
          const a=document.createElement('a');
          a.href=`?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
          a.className='block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
          a.textContent=`×œ×•"×– ×œ×™×•× ${nice}`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click',()=>{ submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); });
        wrap.append(btn,submenu);
        mainMenu.appendChild(wrap);
      });
    }

    function renderHeadline(dayTitle=null){
      const destName=destForDate?.nameHe||destForDate?.name||'×”×™×¢×“';
      const dayPart=dayNameHe?` ${dayNameHe}`:'';
      scheduleHeadline.textContent=`×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
      dayTitleEl.textContent=dayTitle?`${dayTitle} â€¢ ${dateStr}`:`×œ×•×– ×œ×™×•× ${dateStr}`;
      tripSubtitle.textContent=`${destName}${dayPart?(' â€¢'+dayPart):''}`;
      dateChip.textContent=dateStr;
    }

    function linksBlock(it){
      const hasAddr=!!it.address?.label;
      const hasSite=!!it.links?.site;
      const hasBook=!!it.links?.booking;
      const site = hasSite?`<a class="inline-flex items-center gap-1 text-cyan-600 hover:underline" href="${it.links.site}" target="_blank"><i class="fa-solid fa-link"></i> ××ª×¨</a>`:'';
      const book = hasBook?`<a class="inline-flex items-center gap-1 text-teal-600 hover:underline" href="${it.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>`:'';
      const nav = hasAddr?`
        <div class="flex gap-2">
          <a class="px-2 py-1 rounded bg-[#3b82f6] text-white text-xs" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}"><i class="fa-brands fa-waze"></i> ×•×™×™×–</a>
          <a class="px-2 py-1 rounded bg-[#16a34a] text-white text-xs" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}"><i class="fa-solid fa-location-dot"></i> ××¤×•×ª</a>
        </div>`:'';
      return {site,book,nav};
    }

    function fullItemHtml(it,index){
      const hasAddr=!!it.address?.label;
      const hasRoute = it.travel && (it.travel.from || it.travel.to);
      const travel = (it.travel?.from?.label||it.travel?.to?.label) ? `
        <div class="mt-2 text-xs text-slate-500">
          <i class="fa-solid fa-route text-slate-400"></i>
          ${it.travel?.from?.label?`×Ö¾${it.travel.from.label}`:''}
          ${it.travel?.to?.label?` ××œ ${it.travel.to.label}`:''}
          ${it.travel?.timeText?` â€¢ ${it.travel.timeText}`:''}
        </div>`:'';
      const {site,book,nav} = linksBlock(it);
      // inline map container (accordion-full) â€“ route has priority, else point
      const inlineMap = (currentLayout==='accordion-full')
        ? (hasRoute
            ? `<div id="acc-route-${index}" class="accordion-map mt-4 border rounded-lg hidden"></div>`
            : (hasAddr ? `<div id="acc-map-${index}" class="accordion-map mt-4 border rounded-lg hidden"></div>` : '')
          )
        : '';
      return `
        ${it.summary?`<p class="mt-1">${it.summary}</p>`:''}
        ${it.description?`<p class="mt-2 whitespace-pre-wrap">${it.description}</p>`:''}
        ${hasAddr?`<div class="mt-2 text-sm"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>`:''}
        ${travel}
        <div class="mt-3 flex flex-wrap gap-3">${site}${book}</div>
        ${nav?`<div class="mt-2">${nav}</div>`:''}
        ${inlineMap}
      `;
    }

    async function ensureMapIn(elId, address){
      const box=document.getElementById(elId);
      if(!box) return;
      let latlng=null;
      if(address?.lat != null && address?.lng != null) latlng={lat:+address.lat,lng:+address.lng};
      else if(address?.label) latlng=await geocode(address.label);
      if(!latlng){ box.classList.add('hidden'); return; }
      box.classList.remove('hidden');
      const m = L.map(elId,{scrollWheelZoom:false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(m);
      L.marker([latlng.lat,latlng.lng]).addTo(m);
      m.setView([latlng.lat,latlng.lng],15);
      setTimeout(()=>m.invalidateSize(),150);
      return m;
    }

    async function ensureRouteMap(elId, fromAddr, toAddr){
      const box=document.getElementById(elId);
      if(!box) return;
      async function toLatLng(a){
        if(!a) return null;
        if(a.lat!=null && a.lng!=null) return {lat:+a.lat,lng:+a.lng,label:a.label||''};
        if(a.label){ const g=await geocode(a.label); return g?{...g,label:a.label}:null; }
        return null;
      }
      let A = await toLatLng(fromAddr);
      let B = await toLatLng(toAddr);
      if(!A && B) A=B;
      if(!B && A) B=A;
      if(!A || !B){ box.classList.add('hidden'); return; }

      box.classList.remove('hidden');
      const m = L.map(elId,{scrollWheelZoom:false});
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(m);

      const color='#2563eb';
      const line = L.polyline([[A.lat,A.lng],[B.lat,B.lng]],{color,weight:4,opacity:.95}).addTo(m);
      L.marker([A.lat,A.lng]).addTo(m).bindPopup(A.label||'× ×§×•×“×ª ×”×ª×—×œ×”');
      L.marker([B.lat,B.lng]).addTo(m).bindPopup(B.label||'× ×§×•×“×ª ×¡×™×•×');

      if(L.polylineDecorator){
        L.polylineDecorator(line,{
          patterns:[{offset:25,repeat:60,symbol:L.Symbol.arrowHead({pixelSize:10,polygon:false,pathOptions:{color}})}]
        }).addTo(m);
      }
      m.fitBounds(line.getBounds(),{padding:[20,20]});
      setTimeout(()=>m.invalidateSize(),120);
      return m;
    }

    function renderTimeline(items){
      currentScheduleItems = items||[];
      const hasItems = currentScheduleItems.length>0;

      document.getElementById('timeline-section').classList.remove('hidden');
      if(!hasItems){
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        createBtn.classList.remove('hidden');
        editBtn.classList.add('hidden');
        mapContainerSection.classList.add('hidden');
        return;
      }

      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      timelineBox.innerHTML='';
      createBtn.classList.add('hidden');
      editBtn.classList.remove('hidden');
      editBtn.classList.add('inline-flex');

      currentScheduleItems.forEach((it,idx)=>{
        const wrap=document.createElement('div'); wrap.className='timeline-item-wrapper';
        let html='';
        if(currentLayout==='line-style'){
          html = `
            <div class="timeline-time-outside">${timeText(it)}</div>
            <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal">
              <div class="flex items-center gap-3">
                <i class="${itemIcon(it)} text-blue-500 text-lg"></i>
                <h4 class="font-bold text-lg">${it.title||'×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
              </div>
            </div>`;
        } else if(currentLayout==='accordion-summary' || currentLayout==='accordion-full'){
          const summary = `
            <div class="flex items-center justify-between p-4">
              <div class="flex items-center gap-4">
                <i class="${itemIcon(it)} text-blue-500 text-xl w-6 text-center"></i>
                <div>
                  <h4 class="font-bold text-lg">${it.title||'×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                  <p class="text-sm font-mono text-slate-500">${timeText(it)}</p>
                </div>
              </div>
              <i class="fas fa-chevron-down chevron-icon transition-transform group-open:rotate-180"></i>
            </div>`;
          const body = currentLayout==='accordion-summary'
            ? `${it.summary?`<p class="mt-1 text-sm">${it.summary}</p>`:''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal">×¤×¨×˜×™× ××œ××™×â€¦</button>`
            : fullItemHtml(it, idx);
          html = `
            <details id="d-${idx}" class="accordion-item group themed-card rounded-lg shadow-sm">
              <summary class="cursor-pointer list-none">${summary}</summary>
              <div class="p-4 pt-0 pr-12">
                <div class="border-t pt-3" style="border-color:var(--card-border)">${body}</div>
              </div>
            </details>`;
        } else {
          // default (modal on click)
          const {site,book} = linksBlock(it);
          html = `
            <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal">
              <div class="text-sm font-bold text-slate-500">${timeText(it)}</div>
              <h4 class="text-lg font-bold mt-1">${it.title||'×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
              ${it.summary?`<p class="mt-1 text-sm">${it.summary}</p>`:''}
              <div class="flex gap-4 mt-2 pt-2 border-t" style="border-color:var(--card-border)">${site}${book}</div>
            </div>`;
        }
        wrap.innerHTML=html; timelineBox.appendChild(wrap);

        // open modal buttons
        wrap.querySelectorAll('.open-modal').forEach(b=> b.addEventListener('click', (e)=>{ e.stopPropagation(); openItemModal(it); }));

        if(currentLayout==='accordion-full'){
          const det = wrap.querySelector(`#d-${idx}`);
          det?.addEventListener('toggle', async ()=>{
            if(det.open){
              const hasRoute = it.travel && (it.travel.from || it.travel.to);
              if (hasRoute) {
                const elId=`acc-route-${idx}`;
                if(!accordionMaps[elId]) accordionMaps[elId]=await ensureRouteMap(elId, it.travel.from || null, it.travel.to || null);
              } else if (it.address?.label){
                const elId=`acc-map-${idx}`;
                if(!accordionMaps[elId]) accordionMaps[elId]=await ensureMapIn(elId, it.address);
              }
            }
          });
        }

        if(currentLayout==='accordion-summary'){
          const det = wrap.querySelector('details.accordion-item') || wrap.querySelector('details');
          if (det) {
            let openedAt = 0;
            det.addEventListener('toggle', () => { if (det.open) openedAt = Date.now(); });
            det.addEventListener('click', (e) => {
              if (e.target.closest('.chevron-icon')) return; // ignore chevron
              if (det.open && Date.now() - openedAt > 120) openItemModal(it);
            });
          }
        }
      });

      renderRouteMap(currentScheduleItems);
    }

    async function openItemModal(it){
      // Build content
      const head = `
        <div class="flex items-start justify-between gap-3">
          <div class="flex items-center gap-3">
            <i class="${itemIcon(it)} text-sky-500 fa-lg"></i>
            <div>
              <div id="item-modal-title" class="text-xl font-bold">${it.title||'×¤×¨×™×˜ ×œ×œ× ×©×'}</div>
              <div class="text-slate-500">${timeText(it)}</div>
            </div>
          </div>
          <button id="item-modal-close" class="p-2 rounded hover:bg-black/5" title="×¡×’×•×¨"><i class="fa-solid fa-xmark"></i></button>
        </div>`;
      const body = fullItemHtml(it, -1);
      itemModalContent.innerHTML = head + `<div class="mt-3 border-t pt-3" style="border-color:var(--card-border)">${body}</div>`;
      itemModalBackdrop.classList.add('active');
      itemModalBackdrop.setAttribute('aria-hidden','false');

      // Map in modal â€“ route priority
      const hasRoute = it.travel && (it.travel.from || it.travel.to);
      const hasPoint = it.address?.label || (it.address?.lat != null && it.address?.lng != null);
      itemModalMap.classList.add('hidden');
      if (hasRoute) {
        itemModalMap.classList.remove('hidden');
        modalMap = await ensureRouteMap('item-modal-map', it.travel.from || null, it.travel.to || null);
      } else if (hasPoint) {
        itemModalMap.classList.remove('hidden');
        modalMap = await ensureMapIn('item-modal-map', it.address || null);
      }

      const closeNow=()=>{ itemModalBackdrop.classList.remove('active'); itemModalBackdrop.setAttribute('aria-hidden','true'); if(modalMap){ modalMap.remove(); modalMap=null; } };
      document.getElementById('item-modal-close').onclick=closeNow;
      itemModalBackdrop.onclick=(e)=>{ if(e.target===itemModalBackdrop) closeNow(); };
      document.onkeydown=(e)=>{ if(e.key==='Escape') closeNow(); };
      setTimeout(()=> modalMap?.invalidateSize(), 150);
    }

    // Day route map with arrows + legend
    async function renderRouteMap(items){
      const steps=[];
      (items||[]).forEach(it=>{
        if(it?.address?.label){
          const last = steps[steps.length-1];
          if(!last || last.label!==it.address.label) steps.push({label:it.address.label, lat:it.address.lat, lng:it.address.lng});
        }
      });
      if(steps.length<1){ mapContainerSection.classList.add('hidden'); if(mapInstance){mapInstance.remove(); mapInstance=null;} return; }
      mapContainerSection.classList.remove('hidden');

      // Prepare latlngs (geocode as needed)
      for(let i=0;i<steps.length;i++){
        if((steps[i].lat==null||steps[i].lng==null) && steps[i].label){
          const g=await geocode(steps[i].label); if(g){ steps[i].lat=g.lat; steps[i].lng=g.lng; }
        }
      }
      const valid = steps.filter(s=>s.lat!=null && s.lng!=null);
      if(valid.length===0){ mapContainerSection.classList.add('hidden'); return; }

      if(!mapInstance){
        mapInstance = L.map('route-map',{scrollWheelZoom:true});
        mapBase = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; OpenStreetMap'}).addTo(mapInstance);
      } else {
        mapInstance.eachLayer(l=>{ if(l!==mapBase) mapInstance.removeLayer(l); });
      }

      const markers=[], bounds=[];
      valid.forEach((s,i)=>{ const m=L.marker([s.lat,s.lng]).addTo(mapInstance).bindPopup(`${i+1}. ${s.label}`); markers.push(m); bounds.push([s.lat,s.lng]); });
      mapInstance.fitBounds(bounds,{padding:[30,30]});

      // Segments with arrows + legend
      mapLegend.innerHTML='<p class="font-bold">××§×¨× ××¡×œ×•×œ:</p>';
      const colors=['#1d4ed8','#dc2626','#16a34a','#f59e0b','#7c3aed','#0891b2'];
      for(let i=0;i<valid.length-1;i++){
        const a=valid[i], b=valid[i+1], color=colors[i%colors.length];
        const line=L.polyline([[a.lat,a.lng],[b.lat,b.lng]],{color,weight:4,opacity:.9}).addTo(mapInstance);
        if(window.L && L.polylineDecorator){
          L.polylineDecorator(line,{patterns:[{offset:25,repeat:60,symbol:L.Symbol.arrowHead({pixelSize:10,polygon:false,pathOptions:{stroke:true,color}})}]}).addTo(mapInstance);
        }
        const li=document.createElement('div');
        li.className='flex items-center gap-2';
        li.innerHTML=`<span class="w-4 h-1 inline-block" style="background:${color}"></span><span>${a.label} <span style="opacity:.6">></span> ${b.label}</span>`;
        mapLegend.appendChild(li);
      }
      setTimeout(()=>mapInstance.invalidateSize(),150);
    }

    // Notes
    const colorMap={ red:{bg:'bg-red-50',border:'border-red-300',text:'text-red-800'}, green:{bg:'bg-green-50',border:'border-green-300',text:'text-green-800'}, blue:{bg:'bg-blue-50',border:'border-blue-300',text:'text-blue-800'}, yellow:{bg:'bg-yellow-50',border:'border-yellow-300',text:'text-yellow-800'}, orange:{bg:'bg-orange-50',border:'border-orange-300',text:'text-orange-800'} };
    function classesForColor(c){ return colorMap[c]||colorMap.yellow; }
    function renderNotesList(notes){
      if(!notes||notes.length===0){ notesList.innerHTML=`<div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`; return; }
      notesList.innerHTML = notes.map(n=>{
        const cls=classesForColor(n.color);
        return `<div class="border rounded-xl p-3 ${cls.bg} ${cls.border}"><div class="font-bold ${cls.text}">${n.kind}: ${n.title||'â€”'}</div>${n.details?`<div class="mt-1 text-sm whitespace-pre-wrap ${cls.text}">${n.details}</div>`:''}</div>`;
      }).join('');
    }

    // Events
    function attachEvents(){
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      settingsBtn.addEventListener('click', toggleSettings);
      closeSettingsBtn.addEventListener('click', toggleSettings);
      overlay.addEventListener('click', ()=>{ sidebar.classList.add('translate-x-full'); settingsModal.classList.add('translate-x-full'); overlay.classList.add('hidden'); });
      tripHomeBtn.addEventListener('click', ()=>{ window.location.href = `trip.html?tripId=${tripId}`; });

      // settings tabs
      document.querySelectorAll('.settings-btn').forEach(btn=>{
        btn.addEventListener('click',()=>{
          document.querySelectorAll('.settings-btn').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          const id=btn.dataset.panel;
          ['bg','layout','theme'].forEach(p=> document.getElementById(`settings-panel-${p}`).classList.toggle('hidden', p!==id));
        });
      });

      // apply background (save to Firestore)
      document.getElementById('apply-bg-settings').addEventListener('click', async ()=>{
        const url=document.getElementById('bg-image-url').value.trim();
        const color=document.getElementById('bg-color-picker').value;
        const bright=+document.getElementById('bg-brightness-slider').value;
        const scope=document.getElementById('bg-scope').value;
        const payload = url ? { type:'image', value:url, brightness:bright } : { type:'color', value:color, brightness:bright };
        await saveBackground(scope, payload);
        setBackground(payload);
        toggleSettings();
        alert('×”×¨×§×¢ × ×©××¨.');
      });

      // live brightness preview
      document.getElementById('bg-brightness-slider').addEventListener('input',(e)=>{
        const cur=parseFloat(e.target.value); pageBgOverlay.style.backgroundColor=`rgba(0,0,0,${1-(cur/100)})`;
      });

      // layout apply (save to Firestore)
      document.getElementById('apply-layout-settings').addEventListener('click', async ()=>{
        const style = document.querySelector('input[name="timeline-layout"]:checked').value;
        const scope = document.getElementById('layout-scope').value;
        setCurrentLayout(style);
        await saveLayout(scope, style);
        toggleSettings();
        alert('×¡×’× ×•×Ÿ ×”×ª×¦×•×’×” × ×©××¨.');
      });

      // presets
      let presets = {
        glass:{bg:'rgba(255,255,255,.2)', text:'#ffffff', text2:'rgba(226,232,240,.9)', border:'rgba(255,255,255,.35)'},
        light:{bg:'rgba(255,255,255,.9)', text:'#1e293b', text2:'#475569', border:'rgba(226,232,240,.7)'},
        dark:{bg:'rgba(30,41,59,.92)', text:'#f1f5f9', text2:'#cbd5e1', border:'rgba(51,65,85,.6)'},
        ocean:{bg:'rgba(14,116,144,.9)', text:'#f0f9ff', text2:'#a5f3fc', border:'rgba(103,232,249,.4)'},
        sunset:{bg:'rgba(234,88,12,.9)', text:'#fff7ed', text2:'#fed7aa', border:'rgba(251,146,60,.45)'},
        forest:{bg:'rgba(22,101,52,.9)', text:'#f0fdf4', text2:'#bbf7d0', border:'rgba(74,222,128,.35)'},
        lavender:{bg:'rgba(237,233,254,.9)', text:'#4c1d95', text2:'#6d28d9', border:'rgba(196,181,253,.8)'},
        sand:{bg:'rgba(254,243,199,.9)', text:'#78350f', text2:'#92400e', border:'rgba(252,211,77,.7)'}
      };
      presets = {
        ...presets,
        rose:     {bg:'rgba(190,18,60,.9)',  text:'#fff1f2', text2:'#ffe4e6', border:'rgba(244,114,182,.4)'},
        midnight: {bg:'rgba(2,6,23,.92)',    text:'#e2e8f0', text2:'#94a3b8', border:'rgba(51,65,85,.6)'},
        mint:     {bg:'rgba(5,150,105,.9)',  text:'#ecfdf5', text2:'#bbf7d0', border:'rgba(16,185,129,.45)'},
        cafe:     {bg:'rgba(120,53,15,.92)', text:'#fff7ed', text2:'#fed7aa', border:'rgba(180,83,9,.5)'}
      };

      document.querySelectorAll('.preset').forEach(b=>{
        b.addEventListener('click',()=>{
          const p=presets[b.dataset.theme]; if(!p) return;
          // update pickers visual (preview)
          document.getElementById('card-text-color-picker').value=p.text;
          document.getElementById('card-bg-color-picker').value='#ffffff';
          document.getElementById('card-opacity-slider').value=Math.round((parseFloat(p.bg.split(',')[3])||.9) * 100);
          setTheme({cardBg:p.bg, cardText:p.text, cardText2:p.text2, cardBorder:p.border});
        });
      });

      // custom theme + save
      document.getElementById('apply-theme-settings').addEventListener('click', async ()=>{
        const scope = document.getElementById('theme-scope').value;
        const hex=document.getElementById('card-bg-color-picker').value;
        const op=+document.getElementById('card-opacity-slider').value/100;
        const text=document.getElementById('card-text-color-picker').value;
        const r=parseInt(hex.slice(1,3),16), g=parseInt(hex.slice(3,5),16), b=parseInt(hex.slice(5,7),16);
        const border=`rgba(${Math.max(0,r-30)},${Math.max(0,g-30)},${Math.max(0,b-30)},.5)`;
        const themeObj={cardBg:`rgba(${r},${g},${b},${Math.max(.1,Math.min(1,op))})`, cardText:text, cardText2:text, cardBorder:border};
        setTheme(themeObj);
        await saveTheme(scope, themeObj);
        toggleSettings();
        alert('×¢×¨×›×ª ×”× ×•×©× × ×©××¨×”.');
      });

      // item modal close (global)
      itemModalClose?.addEventListener('click', ()=>{
        itemModalBackdrop.classList.remove('active');
        if(modalMap){modalMap.remove(); modalMap=null;}
      });
    }

    // Init
    async function initPage(){
      const url=new URLSearchParams(location.search);
      tripId=url.get('tripId');
      dateStr=decodeURIComponent(url.get('date')||'').trim();
      const parsed=parseLocalDateFlexible(dateStr);
      if(parsed){ dateISO=toISO(parsed); dayNameHe=hebWeekdayUTC(parsed); }
      if(!tripId||!dateStr){ alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.'); location.href='index.html'; return; }

      attachEvents();

      onAuthStateChanged(auth, async (user)=>{
        if(!user){ location.replace('login.html'); return; }
        currentUser=user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" class="p-2 text-slate-600 hover:text-red-500" title="×”×ª× ×ª×§"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click',()=>signOut(auth));

        // Trip
        const tripRef=doc(db,'trips',tripId);
        const tripSnap=await getDoc(tripRef);
        if(!tripSnap.exists()){ alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href='index.html'; return; }
        tripData=tripSnap.data();
        if(tripData.ownerId && tripData.ownerId!==currentUser.uid){ alert('××™×Ÿ ×”×¨×©××” ×œ×˜×™×•×œ ×–×”.'); location.href='index.html'; return; }

        destForDate = findDestinationForDate(tripData, dateStr);
        const bgUrl = destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg';
        setBackground({type:'image', value:bgUrl, brightness:50});
        loaderBg.style.backgroundImage=`url('${bgUrl}')`;

        buildMenuFromTrip();
        applyStylingFromTripData(); // defaults/destination level (before schedule doc)

        // Links
        const destNameParam=encodeURIComponent(destForDate?.nameHe||destForDate?.name||'');
        const editHref=`create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
        editBtn.href=editHref; createBtn.href=editHref;

        // Headline + data
        if(dateISO){
          const schedDocRef=doc(db,'trips',tripId,'schedules',dateISO);
          const schedSnap=await getDoc(schedDocRef);
          schedData = schedSnap.exists()? schedSnap.data() : null;
          const dayTitle = schedData ? (schedData.title||null) : null;
          renderHeadline(dayTitle);
          applyStylingFromTripData(); // re-apply with date-level overrides

          // Items
          const itemsCol=collection(db,'trips',tripId,'schedules',dateISO,'items');
          onSnapshot(query(itemsCol),(snap)=>{
            const arr=snap.docs.map(d=>({id:d.id,...d.data()}));
            arr.sort((a,b)=>{
              const sa=(a.sort??999999)-(b.sort??999999);
              if(sa!==0) return sa;
              return String(a.startTime||'').localeCompare(String(b.startTime||''));
            });
            renderTimeline(arr);
          }, ()=>renderTimeline([]));

          // Notes
          const notesCol=collection(db,'trips',tripId,'schedules',dateISO,'notes');
          onSnapshot(query(notesCol),(snap)=>{
            const arr=snap.docs.map(d=>({id:d.id,...d.data()}));
            renderNotesList(arr);
          },()=>renderNotesList([]));
        } else {
          renderHeadline(null);
          renderTimeline([]);
          renderNotesList([]);
        }

        // Reveal
        initialLoader.style.opacity='0';
        mainContent.style.opacity='1';
        setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
      });
    }

    initPage();
  </script>
</body>
</html>
