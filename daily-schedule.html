<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Assistant', sans-serif; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .leaf-badge { border-inline-start: 4px solid #38bdf8; }
    .timeline { position: relative; }
    .timeline::before { content: ""; position: absolute; right: 20px; top: 0; bottom: 0; width: 2px; background: rgba(30,41,59,.15); }
    .timeline-item { position: relative; padding-right: 56px; }
    .timeline-dot { position: absolute; right: 12px; top: .75rem; width: 16px; height: 16px; border-radius: 9999px; background: white; box-shadow: 0 0 0 4px #e2e8f0 inset, 0 0 0 2px rgba(30,41,59,.1); }
    .bg-fixed-image { background-size: cover; background-position: center; }
    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity .5s ease-out; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }
  </style>
</head>
<body class="bg-slate-100">
  <!-- Loader -->
  <div id="initial-loader">
    <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
    </div>
  </div>

  <!-- Background -->
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
  <div class="fixed inset-0 z-0 bg-black/50"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <!-- Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <button id="back-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×”">
              <i class="fas fa-arrow-right fa-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
          </div>
          <div class="flex items-center gap-4">
            <div id="auth-container" class="flex items-center"></div>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <!-- Trip/title banner -->
    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <!-- Summary card -->
        <section class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 leaf-badge">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold text-slate-800">×œ×•×– ×œ×™×•×</h2>
              <p id="trip-subtitle" class="text-slate-500 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 text-slate-600">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
          <div class="mt-3 flex gap-2 justify-end">
            <a id="edit-schedule-btn" href="#" class="inline-flex items-center gap-2 px-4 py-2 rounded-lg border text-slate-700 hover:bg-slate-50">
              <i class="fa-solid fa-pen"></i> ×¢×¨×•×š ×œ×•×–
            </a>
          </div>
        </section>

        <!-- Timeline -->
        <section id="timeline-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5">
          <div id="no-schedule" class="text-center p-10">
            <i class="fa-regular fa-clock fa-3x text-slate-400 mb-4"></i>
            <h3 class="text-xl font-bold text-slate-700 mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
            <p class="text-slate-500">×œ×—×¥ â€œ×¢×¨×•×š ×œ×•×–â€ ××• â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
          </div>
          <div id="timeline" class="timeline space-y-4 hidden"></div>
        </section>

        <!-- Notes/Tips -->
        <section id="notes-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold text-slate-800 mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
          <div id="notes-list" class="grid gap-3">
            <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
          </div>
        </section>

        <!-- CTA -->
        <section class="flex justify-center gap-3">
          <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            ×¦×•×¨ ×œ×•×–
          </a>
        </section>

      </div>
    </main>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- State ----------
    let currentUser = null;
    let tripId = null;
    let tripData = null;

    let dateStr = null;   // ××•×¦×’ ×›×¤×™ ×©×‘× ×‘-URL
    let dateISO = null;   // yyyy-mm-dd (×œ××¡××›×™ schedules)
    let dayNameHe = "";

    let destForDate = null;

    // UI
    const initialLoader   = document.getElementById('initial-loader');
    const mainContent     = document.getElementById('main-content');
    const pageBg          = document.getElementById('page-bg');
    const loaderBg        = document.getElementById('loader-bg');
    const sidebar         = document.getElementById('sidebar');
    const hamburgerBtn    = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay         = document.getElementById('overlay');
    const mainMenu        = document.getElementById('main-menu');
    const authContainer   = document.getElementById('auth-container');
    const backBtn         = document.getElementById('back-btn');

    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl       = document.getElementById('day-title');
    const tripSubtitle     = document.getElementById('trip-subtitle');
    const dateChip         = document.getElementById('date-chip');

    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox   = document.getElementById('timeline');
    const createBtn     = document.getElementById('create-schedule-btn');
    const editBtn       = document.getElementById('edit-schedule-btn');

    const notesList     = document.getElementById('notes-list');
    const notesSection  = document.getElementById('notes-section');

    // ---------- Helpers ----------
    function toggleSidebar(){ sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }

    function parseLocalDateFlexible(s) {
      if (!s) return null;
      const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/);
      if (!m) return null;
      let d = +m[1], mo = +m[2], y = +m[3];
      if (y < 100) y += 2000;
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
    function toISODateUTC(d) {
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function hebWeekdayUTC(d) {
      const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª'];
      return names[d.getUTCDay()];
    }

    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const start = parseLocalDateFlexible(startStr);
      const end = parseLocalDateFlexible(endStr);
      if (!start || !end) return [];
      const out = [];
      for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) {
        out.push(new Date(t.getTime()));
      }
      return out;
    }

    function findDestinationForDate(trip, rawDDMMYYYY) {
      const target = parseLocalDateFlexible(rawDDMMYYYY);
      if (!target) return null;
      const targetISO = toISODateUTC(target);
      return (trip.destinations || []).find(dest => {
        const days = generateDatesFromRange(dest.dates);
        const isoList = days.map(d => toISODateUTC(d));
        return isoList.includes(targetISO);
      }) || null;
    }

    function setBackgroundForDest(dest) {
      const url = dest?.bgUrl || dest?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg';
      pageBg.style.backgroundImage = `url('${url}')`;
      loaderBg.style.backgroundImage = `url('${url}')`;
    }

    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        const dates = generateDatesFromRange(dest.dates);
        dates.forEach(dObj => {
          const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
          const a = document.createElement('a');
          a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
          a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
          a.textContent = `×œ×•"×– ×œ×™×•× ${nice}`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', () => {
          submenu.classList.toggle('open');
          btn.querySelector('i').classList.toggle('rotate-180');
        });
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function renderHeadline(dayTitleFromDoc = null) {
      const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
      const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
      scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
      dayTitleEl.textContent = dayTitleFromDoc
        ? `${dayTitleFromDoc} â€¢ ${dateStr}`
        : `×œ×•×– ×œ×™×•× ${dateStr}`;
      tripSubtitle.textContent = `${destName}${dayPart ? ' â€¢' + dayPart : ''}`;
      dateChip.textContent = dateStr;
    }

    // Map item -> DOM
    function itemIcon(it){
      if (it.isBackToHotel) return 'fa-bed';
      return (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs) ? 'fa-triangle-exclamation' : 'fa-location-dot';
    }
    function timeText(it){
      if (!it?.startTime && !it?.endTime) return '--:--';
      return [it.startTime || '', it.endTime ? 'â€“ '+it.endTime : ''].filter(Boolean).join(' ');
    }
    function distanceText(m){
      if (m==null) return '';
      const km = (m/1000).toFixed(2);
      return `<span class="text-xs text-slate-500"> â€¢ ××¨×—×§ ×§×•×“×: ${km} ×§×´×</span>`;
    }
    function verifyBadge(it){
      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      if (!needs) return '';
      const list = [
        it.needsVerifyAddress?'×›×ª×•×‘×ª':null,
        it.needsVerifyRoute?'××¡×œ×•×œ':null,
        it.needsVerifyRefs?'×§×™×©×•×¨':null
      ].filter(Boolean).join(' / ');
      return `<span class="inline-flex items-center gap-1 text-[12px] px-2 py-0.5 rounded-full bg-red-100 text-red-800 border border-red-300"><i class="fa-solid fa-circle-exclamation"></i> ×“×¨×•×© ××™××•×ª${list?': '+list:''}</span>`;
    }

    function renderTimelineFromItems(items){
      if (!items || items.length === 0) {
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        timelineBox.innerHTML = '';
        return;
      }
      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      timelineBox.innerHTML = '';

      items.forEach(it=>{
        const hasAddr = !!it.address?.label;
        const hasSite = !!it.links?.site;
        const hasBook = !!it.links?.booking;
        const refs = Array.isArray(it.refs)? it.refs : [];

        const refsHtml = refs.map(r=>{
          const href = `${r.page==='summary'?'summary':'attractions'}.html?tripId=${encodeURIComponent(tripId)}&open=${r.type==='logistics'?'logistics':'attraction'}&id=${encodeURIComponent(r.id)}`;
          const icon = r.type==='logistics' ? (r.subType==='hotel'?'ğŸ¨':r.subType==='flight'?'âœˆï¸':r.subType==='train'?'ğŸš†':r.subType==='car_rental'?'ğŸš—':r.subType==='ferry'?'â›´ï¸':'â¬…ï¸') : 'ğŸ“';
          return `<a class="px-2 py-1 rounded bg-indigo-600/90 text-white text-xs" target="_blank" href="${href}">${icon} ${r.label}</a>`;
        }).join(' ');

        const linksHtml = [
          hasSite ? `<a class="inline-flex items-center gap-1 text-sky-700 hover:underline" href="${it.links.site}" target="_blank"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
          hasBook ? `<a class="inline-flex items-center gap-1 text-emerald-700 hover:underline" href="${it.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
          refsHtml
        ].filter(Boolean).join(' ');

        const navHtml = hasAddr ? `
          <div class="flex gap-2">
            <a class="px-2 py-1 rounded bg-[#33ccff] text-white text-xs" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}"><i class="fa-brands fa-waze"></i> × ×•×•×˜</a>
            <a class="px-2 py-1 rounded bg-[#4285F4] text-white text-xs" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}"><i class="fa-solid fa-location-dot"></i> ××¤×•×ª</a>
          </div>
        ` : '';

        const travelHtml = it.travel?.from?.label || it.travel?.to?.label ? `
          <div class="mt-2 text-xs text-slate-600">
            <i class="fa-solid fa-route text-slate-400"></i>
            ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''}
            ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''}
            ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}
          </div>
        ` : '';

        const item = document.createElement('div');
        item.className = 'timeline-item bg-white/90 rounded-xl shadow p-4';
        item.innerHTML = `
          <span class="timeline-dot"></span>
          <div class="flex items-start gap-4">
            <div class="shrink-0 text-center">
              <div class="text-sm font-bold text-slate-700">${timeText(it)}</div>
              <div class="text-xs text-slate-500">×¤×¨×™×˜</div>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 flex-wrap">
                <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
                <h4 class="text-lg font-bold text-slate-800">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                ${verifyBadge(it)}
                ${distanceText(it.distanceFromPreviousMeters)}
              </div>
              ${it.summary ? `<div class="mt-1 text-slate-700">${it.summary}</div>` : ''}
              ${it.description ? `<p class="mt-2 text-slate-700 whitespace-pre-wrap">${it.description}</p>` : ''}
              ${hasAddr ? `<div class="mt-2 text-sm text-slate-600"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>` : ''}
              ${travelHtml}
              ${linksHtml ? `<div class="mt-3 flex flex-wrap gap-2">${linksHtml}</div>` : ''}
              ${navHtml ? `<div class="mt-2">${navHtml}</div>` : ''}
            </div>
          </div>
        `;
        timelineBox.appendChild(item);
      });
    }

    const colorMap = {
      red:    {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:  {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:   {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow: {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange: {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    function classesForColor(c){
      const m = colorMap[c] || colorMap.yellow;
      return `${m.bg} ${m.border} ${m.text}`;
    }
    function renderNotesList(notes){
      if (!notes || notes.length===0){
        notesList.innerHTML = `<div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const cls = classesForColor(n.color);
        return `
          <div class="border rounded-xl p-3 ${cls}">
            <div class="font-bold">${n.kind}: ${n.title || 'â€”'}</div>
            ${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap">${n.details}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ---------- Events ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);
      if (backBtn) {
        backBtn.addEventListener('click', () => {
          if (window.history.length > 1) history.back();
          else window.location.href = 'index.html';
        });
      }
    }

    // ---------- Init ----------
    async function initPage() {
      const url = new URLSearchParams(window.location.search);
      tripId = url.get('tripId');
      dateStr = decodeURIComponent(url.get('date') || '').trim();

      const parsed = parseLocalDateFlexible(dateStr);
      if (parsed) {
        dateISO = toISODateUTC(parsed);
        dayNameHe = hebWeekdayUTC(parsed);
      } else {
        dateISO = null;
        dayNameHe = "";
      }

      if (!tripId || !dateStr) {
        alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.');
        location.href = 'index.html'; return;
      }

      attachEvents();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        // Load trip
        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);
        if (!tripSnap.exists()) { alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href = 'index.html'; return; }
        tripData = tripSnap.data();
        if (tripData.ownerId && tripData.ownerId !== currentUser.uid) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.'); location.href = 'index.html'; return;
        }

        // ×™×¢×“ ×œ××•×ª×• ×ª××¨×™×š, ×¨×§×¢ ×•×ª×¤×¨×™×˜
        destForDate = findDestinationForDate(tripData, dateStr);
        setBackgroundForDest(destForDate);
        buildMenuFromTrip();

        // ×§×™×©×•×¨×™× ×œ×™×¦×™×¨×”/×¢×¨×™×›×”
        const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
        const editHref   = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
        editBtn.href   = editHref;
        createBtn.href = editHref;

        // ×›×•×ª×¨×ª ××”××¡××š ×©×œ ×”×™×•× (title) + ×”×–× ×•×ª realtime ×œ×¤×¨×™×˜×™×/×“×’×©×™×
        if (dateISO){
          const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
          const schedSnap = await getDoc(schedDocRef);
          const dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
          renderHeadline(dayTitleFromDoc);

          // items
          const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
          const qItems = query(itemsCol, orderBy('sort','asc'));
          onSnapshot(qItems, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderTimelineFromItems(arr);
          }, ()=> renderTimelineFromItems([]));

          // notes
          const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
          const qNotes = query(notesCol, orderBy('createdAt','asc'));
          onSnapshot(qNotes, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderNotesList(arr);
          }, ()=> renderNotesList([]));
        } else {
          // ×× ×œ× ×”×¦×œ×—× ×• ×œ×¤×¨×© ××ª ×”×ª××¨×™×š â€“ ×¢×“×™×™×Ÿ × ×¦×™×’ ×›×•×ª×¨×ª ×•×™×¢×“
          renderHeadline(null);
          // × ×¡×™×•×Ÿ fallback ×™×©×Ÿ (×× ×§×™×™××•×ª ×™×©×•×™×•×ª events ×›×œ×œ×™×•×ª ×œ×¤×™ ×”××—×¨×•×–×ª)
          const eventsCol = collection(db, 'trips', tripId, 'events');
          const q2 = query(eventsCol, where('date','==', dateStr), orderBy('time'));
          onSnapshot(q2, (snap) => {
            const items = snap.docs.map(d => d.data()).map(e=>({
              title: e.title,
              startTime: e.time, endTime:null,
              description: e.notes || null,
              address: e.location ? {label:e.location} : null,
              links: {site: e.link || null, booking: null},
            }));
            renderTimelineFromItems(items);
          }, () => renderTimelineFromItems([]));
          // notes section ×¨×™×§
          renderNotesList([]);
        }

        // Reveal UI
        initialLoader.style.opacity = '0';
        mainContent.style.opacity = '1';
        setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
      });
    }

    initPage();
  </script>
</body>
</html>