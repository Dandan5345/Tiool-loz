<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>לוז יומי • מסע חלומות</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <!-- Leaflet CSS for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-text-color: #1e293b; /* slate-800 */
            --card-secondary-text-color: #475569; /* slate-600 */
            --card-border-color: rgba(203, 213, 225, 0.5); /* slate-300 with opacity */
        }

        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: #f1f5f9; /* slate-100 */
        }
        #sidebar, #settings-modal { 
            transition: transform 0.3s ease-in-out; 
        }
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out; 
        }
        .submenu.open { 
            max-height: 1200px; 
        }
        
        /* Themed Card Style */
        .themed-card {
            background: var(--card-bg);
            color: var(--card-text-color);
            border: 1px solid var(--card-border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .themed-card h1, .themed-card h2, .themed-card h3, .themed-card h4 {
             color: var(--card-text-color);
        }
        .themed-card p, .themed-card span, .themed-card div:not(.themed-card-override), .themed-card a:not(.themed-card-override) {
            color: var(--card-secondary-text-color);
        }
        .themed-card h2, .themed-card .font-extrabold, .themed-card .font-bold {
            color: var(--card-text-color);
        }
        .themed-card .text-slate-700 { color: var(--card-text-color); }
        .themed-card .text-slate-800 { color: var(--card-text-color); }
        .themed-card .text-slate-500 { color: var(--card-secondary-text-color); }
        .themed-card .text-slate-600 { color: var(--card-secondary-text-color); }


        /* Timeline Styles */
        .timeline { position: relative; }
        .timeline.layout-line-style::before, .timeline.layout-line-style-accordion-full::before, .timeline.layout-line-style-accordion-summary::before { 
            content: ""; 
            position: absolute; 
            right: 2.5rem; /* Adjusted for larger clickable area */
            top: 0; 
            bottom: 0; 
            width: 2px; 
            background: rgba(30,41,59,.15); 
        }
        .timeline-item-wrapper {
            position: relative;
        }
        .timeline.layout-line-style .timeline-item-wrapper, .timeline.layout-line-style-accordion-full .timeline-item-wrapper, .timeline.layout-line-style-accordion-summary .timeline-item-wrapper {
            padding-right: 6rem; /* Make space for the time */
        }
        .timeline-time-outside {
            position: absolute;
            right: 0;
            top: 1rem;
            background: var(--card-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
            width: 5rem;
            text-align: center;
        }
        
        /* Fix for scroll jitter */
        .bg-fixed-image, header {
            transform: translateZ(0);
        }
        .bg-fixed-image { 
            background-size: cover; 
            background-position: center; 
        }
        #initial-loader { 
            position: fixed; 
            inset: 0; 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: opacity .5s ease-out; 
        }
        @keyframes spin { 
            from { transform: rotate(0); } 
            to { transform: rotate(360deg); } 
        }
        .plane-spinner { 
            animation: spin 2s linear infinite; 
        }

        /* Map Styles */
        #route-map, .accordion-map-container, #modal-map {
            height: 450px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background-color: #e2e8f0; /* Placeholder background */
        }
        #modal-map, .accordion-map-container {
            height: 250px; /* Smaller map for modals and accordions */
        }
        .leaflet-container {
             font-family: 'Assistant', sans-serif;
        }

        /* Accordion styles based on user example */
        details > summary { 
            list-style: none; /* Remove default marker */
            cursor: pointer;
        }
        details > summary::-webkit-details-marker { 
            display: none; /* Remove default marker for Chrome */
        }
        .chevron-icon { 
            transition: transform 0.3s ease-out; 
        }
        details[open] > summary .chevron-icon { 
            transform: rotate(180deg); 
        }
        
        /* Custom modal for item details */
        .item-detail-modal {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.7); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .item-detail-modal.visible { opacity: 1; visibility: visible; }
        .item-detail-modal-content {
            background: var(--card-bg); color: var(--card-text-color);
            padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s;
        }
        .item-detail-modal.visible .item-detail-modal-content { transform: scale(1); }

        /* Selected Theme Button */
        .theme-preset-btn.selected-theme {
            box-shadow: 0 0 0 3px #3b82f6; /* Ring effect */
        }
        
        /* Action buttons in cards */
        .action-button {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.3rem 0.8rem; border-radius: 9999px;
            font-size: 0.8rem; font-weight: 600; color: white;
            transition: opacity 0.2s; text-decoration: none;
        }
        .action-button:hover { opacity: 0.85; }
        .action-button.gmaps { background-color: #16a34a; } /* Green-600 */
        .action-button.waze { background-color: #2563eb; } /* Blue-600 */
        .action-button.site { background-color: #0891b2; } /* Cyan-600 */
        .action-button.booking { background-color: #0d9488; } /* Teal-600 */
    </style>
</head>
<body class="bg-slate-100">
    <!-- Loader -->
    <div id="initial-loader">
        <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
        <div class="fixed inset-0 z-0 bg-black/50"></div>
        <div class="text-white text-center relative z-10">
            <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
            <p class="text-2xl font-bold">טוען את הלוז...</p>
        </div>
    </div>

    <!-- Background -->
    <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div id="page-bg-overlay" class="fixed inset-0 z-0 bg-black/50"></div>

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-full max-w-sm sm:max-w-md bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-slate-800">תפריט המסע 🧭</h2>
            <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <nav id="main-menu" class="p-4 space-y-2"></nav>
    </aside>
    
    <!-- Settings Modal -->
    <aside id="settings-modal" class="fixed top-0 right-0 h-full w-full max-w-sm sm:w-96 bg-white shadow-2xl z-[80] transform translate-x-full">
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-slate-800">הגדרות עיצוב 🎨</h2>
            <button id="close-settings-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-4.5rem)]">
            <!-- Settings Navigation -->
            <div class="grid grid-cols-3 gap-2 border border-slate-200 rounded-lg p-1">
                <button data-panel="bg" class="settings-nav-btn bg-slate-200 p-2 rounded-md text-sm font-bold">רקע</button>
                <button data-panel="layout" class="settings-nav-btn p-2 rounded-md text-sm font-bold text-slate-500">פריסה</button>
                <button data-panel="theme" class="settings-nav-btn p-2 rounded-md text-sm font-bold text-slate-500">ערכת נושא</button>
            </div>

            <!-- Background Panel -->
            <div id="settings-panel-bg" class="settings-panel space-y-4">
                <div>
                    <label class="font-bold text-slate-700">תמונת רקע (URL)</label>
                    <input id="bg-image-url" type="text" placeholder="הדבק קישור לתמונה" class="w-full mt-1 p-2 border rounded-md">
                </div>
                <div>
                    <label class="font-bold text-slate-700">או בחר צבע רקע</label>
                    <input id="bg-color-picker" type="color" value="#f1f5f9" class="w-full h-10 mt-1 border-none cursor-pointer">
                </div>
                 <div>
                    <label for="bg-brightness-slider" class="font-bold text-slate-700">בהירות רקע</label>
                    <input id="bg-brightness-slider" type="range" min="0" max="100" value="50" class="w-full mt-1">
                </div>
                <div class="pt-4 border-t">
                    <label class="font-bold text-slate-700">החל הגדרות על:</label>
                    <select id="bg-scope" class="w-full mt-1 p-2 border rounded-md">
                        <option value="destination">כל התאריכים ביעד זה (ברירת מחדל)</option>
                        <option value="date">רק בתאריך הספציפי הזה</option>
                        <option value="trip">כל הלו"זים של הטיול</option>
                    </select>
                </div>
                <button id="apply-bg-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">החל שינויים</button>
            </div>

            <!-- Layout Panel -->
            <div id="settings-panel-layout" class="settings-panel space-y-4 hidden">
                 <p class="font-bold text-slate-700">סגנון תצוגת הלו"ז:</p>
                 <div class="space-y-2">
                    <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="default">
                        <div><span class="font-bold">כרטיסיות (ברירת מחדל)</span><p class="text-sm text-slate-500">כרטיסיה עם פרטים עיקריים. לחיצה פותחת חלון עם כל המידע.</p></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="accordion-summary">
                        <div><span class="font-bold">אקורדיון חלקי</span><p class="text-sm text-slate-500">כרטיסיה עם כותרת ושעה. לחיצה מרחיבה לפירוט.</p></div>
                    </label>
                     <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="accordion-full">
                        <div><span class="font-bold">אקורדיון מלא</span><p class="text-sm text-slate-500">כרטיסיה עם כותרת ושעה. לחיצה מרחיבה וחושפת את כל הפרטים.</p></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="line-style">
                        <div><span class="font-bold">ציר זמן</span><p class="text-sm text-slate-500">קו אנכי עם כרטיסיות בצד. לחיצה פותחת חלון עם כל המידע.</p></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="line-style-accordion-summary">
                        <div><span class="font-bold">ציר זמן אקורדיון חלקי</span><p class="text-sm text-slate-500">שילוב של ציר זמן עם אקורדיון נפתח לתקציר.</p></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="line-style-accordion-full">
                        <div><span class="font-bold">ציר זמן אקורדיון מלא</span><p class="text-sm text-slate-500">שילוב של ציר זמן עם אקורדיון נפתח לכל הפרטים.</p></div>
                    </label>
                 </div>
                 <div class="pt-4 border-t">
                    <label class="font-bold text-slate-700">החל הגדרות על:</label>
                    <select id="layout-scope" class="w-full mt-1 p-2 border rounded-md">
                        <option value="trip">כל הלו"זים של הטיול (ברירת מחדל)</option>
                        <option value="destination">כל התאריכים ביעד זה</option>
                        <option value="date">רק בתאריך הספציפי הזה</option>
                    </select>
                </div>
                 <button id="apply-layout-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">החל שינויים</button>
            </div>

            <!-- Theme Panel -->
            <div id="settings-panel-theme" class="settings-panel space-y-4 hidden">
                <div>
                    <label class="font-bold text-slate-700">צבע רקע כרטיסיות</label>
                    <input id="card-bg-color-picker" type="color" value="#ffffff" class="w-full h-10 mt-1 border-none cursor-pointer">
                </div>
                 <div>
                    <label for="card-opacity-slider" class="font-bold text-slate-700">שקיפות רקע כרטיסיות</label>
                    <input id="card-opacity-slider" type="range" min="0" max="100" value="85" class="w-full mt-1">
                </div>
                <div>
                    <label class="font-bold text-slate-700">צבע טקסט</label>
                    <input id="card-text-color-picker" type="color" value="#1e293b" class="w-full h-10 mt-1 border-none cursor-pointer">
                </div>
                <div class="pt-4 border-t">
                     <p class="font-bold text-slate-700">או בחר ערכת נושא מוכנה:</p>
                     <div id="theme-presets-container" class="grid grid-cols-2 gap-2 mt-2">
                        <!-- Presets will be injected by JS -->
                     </div>
                </div>
                 <button id="apply-theme-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">החל שינויים</button>
            </div>
        </div>
    </aside>

    <div id="overlay" class="fixed inset-0 bg-black/40 cursor-pointer z-50 hidden"></div>

    <!-- Content -->
    <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
        <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="trip-home-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה לדף הטיול">
                            <i class="fas fa-map-signs fa-lg"></i>
                        </a>
                        <h1 class="text-xl font-bold text-slate-800">לוז יומי</h1>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="auth-container" class="flex items-center"></div>
                        <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none" title="הגדרות עיצוב">
                            <i class="fas fa-cog fa-lg"></i>
                        </button>
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-white/70 backdrop-blur-md border-b">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <p id="schedule-headline" class="text-center text-slate-700 font-bold">טוען פרטי תאריך...</p>
            </div>
        </div>

        <main class="p-4 sm:p-6 lg:p-8">
            <div class="max-w-5xl mx-auto space-y-8">

                <section id="title-card" class="themed-card rounded-2xl shadow-lg p-5">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold">לוז ליום</h2>
                            <p id="trip-subtitle" class="mt-1"></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa-regular fa-calendar"></i>
                            <span id="date-chip" class="font-semibold">--/--/----</span>
                        </div>
                    </div>
                </section>

                <section id="timeline-section">
                    <div id="no-schedule" class="themed-card text-center p-10 rounded-2xl shadow-lg">
                        <i class="fa-regular fa-clock fa-3x mb-4"></i>
                        <h3 class="text-xl font-bold mb-1">עדיין אין לוז ליום זה</h3>
                        <p>לחץ “צור לוז” כדי להתחיל לתכנן את היום.</p>
                    </div>
                    <div id="timeline" class="timeline space-y-4 hidden"></div>
                </section>

                <section id="notes-section" class="themed-card rounded-2xl shadow-lg p-5">
                    <h3 class="text-lg font-bold mb-3">דגשים וטיפים ליום זה</h3>
                    <div id="notes-list" class="grid gap-3">
                        <div class="text-slate-500">אין עדיין דגשים/טיפים.</div>
                    </div>
                </section>
                
                <section id="map-container-section" class="themed-card rounded-2xl shadow-lg p-5 hidden">
                    <h3 class="text-lg font-bold mb-3">מפת מסלול היום</h3>
                    <div id="route-map"></div>
                    <div id="map-legend" class="mt-4 space-y-2 text-sm"></div>
                </section>

                <section class="flex justify-center gap-3">
                    <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        צור לוז
                    </a>
                    <a id="edit-schedule-btn" href="#" class="hidden items-center gap-2 bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fa-solid fa-pen"></i>
                        ערוך לוז
                    </a>
                </section>

            </div>
        </main>
    </div>
    
    <!-- Item Detail Modal -->
    <div id="item-detail-modal" class="item-detail-modal">
        <div id="item-detail-modal-content" class="item-detail-modal-content">
            <!-- Content will be injected by JavaScript -->
        </div>
    </div>


    <!-- Firebase + Leaflet + App -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import {
            getFirestore, doc, getDoc, collection, onSnapshot, query, updateDoc, setDoc
        } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // ---------- Firebase ----------
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // ---------- State ----------
        let currentUser = null;
        let tripId = null;
        let tripData = null;
        let dateStr = null;
        let dateISO = null;
        let dayNameHe = "";
        let destForDate = null;
        let currentScheduleItems = [];
        let mapInstance = null;
        let modalMapInstance = null;
        let currentLayout = 'default';
        let currentThemeKey = 'light';
        const accordionMaps = {};

        // ---------- UI Elements ----------
        const initialLoader = document.getElementById('initial-loader');
        const mainContent = document.getElementById('main-content');
        const pageBg = document.getElementById('page-bg');
        const pageBgOverlay = document.getElementById('page-bg-overlay');
        const loaderBg = document.getElementById('loader-bg');
        
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const overlay = document.getElementById('overlay');
        const mainMenu = document.getElementById('main-menu');
        
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');

        const authContainer = document.getElementById('auth-container');
        const tripHomeBtn = document.getElementById('trip-home-btn');
        const scheduleHeadline = document.getElementById('schedule-headline');
        const dayTitleEl = document.getElementById('day-title');
        const tripSubtitle = document.getElementById('trip-subtitle');
        const dateChip = document.getElementById('date-chip');

        const noScheduleBox = document.getElementById('no-schedule');
        const timelineBox = document.getElementById('timeline');
        const createBtn = document.getElementById('create-schedule-btn');
        const editBtn = document.getElementById('edit-schedule-btn');
        
        const notesList = document.getElementById('notes-list');
        const mapContainerSection = document.getElementById('map-container-section');
        const mapLegend = document.getElementById('map-legend');

        const itemDetailModal = document.getElementById('item-detail-modal');
        const itemDetailModalContent = document.getElementById('item-detail-modal-content');

        // ---------- Helpers ----------
        function toggleSidebar() { 
            sidebar.classList.toggle('translate-x-full'); 
            overlay.classList.toggle('hidden'); 
            settingsModal.classList.add('translate-x-full');
        }
        function toggleSettings() { 
            settingsModal.classList.toggle('translate-x-full'); 
            overlay.classList.toggle('hidden'); 
            sidebar.classList.add('translate-x-full');
        }
        
        function parseLocalDateFlexible(s) { if (!s) return null; const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/); if (!m) return null; let d = +m[1], mo = +m[2], y = +m[3]; if (y < 100) y += 2000; const dt = new Date(Date.UTC(y, mo-1, d)); return isNaN(dt.getTime()) ? null : dt; }
        function toISODateUTC(d) { const yyyy = d.getUTCFullYear(); const mm = String(d.getUTCMonth()+1).padStart(2,'0'); const dd = String(d.getUTCDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
        function hebWeekdayUTC(d) { const names = ['יום ראשון','יום שני','יום שלישי','יום רביעי','יום חמישי','יום שישי','יום שבת']; return names[d.getUTCDay()]; }
        function generateDatesFromRange(rangeStr) { if (!rangeStr || !rangeStr.includes(' - ')) return []; const [startStr, endStr] = rangeStr.split(' - '); const start = parseLocalDateFlexible(startStr); const end = parseLocalDateFlexible(endStr); if (!start || !end) return []; const out = []; for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) { out.push(new Date(t.getTime())); } return out; }
        function findDestinationForDate(trip, rawDDMMYYYY) { const target = parseLocalDateFlexible(rawDDMMYYYY); if (!target) return null; const targetISO = toISODateUTC(target); return (trip.destinations || []).find(dest => { const days = generateDatesFromRange(dest.dates); const isoList = days.map(d => toISODateUTC(d)); return isoList.includes(targetISO); }) || null; }

        // ---------- Styling & Layout Functions ----------
        function setBackground(bg) { if (bg.type === 'image') { pageBg.style.backgroundImage = `url('${bg.value}')`; document.body.style.backgroundColor = ''; } else { pageBg.style.backgroundImage = 'none'; document.body.style.backgroundColor = bg.value; } const overlayOpacity = 1 - (bg.brightness / 100); pageBgOverlay.style.backgroundColor = `rgba(0, 0, 0, ${overlayOpacity})`; }
        function setTheme(themeKey) { const theme = themePresets[themeKey]; if(!theme) return; currentThemeKey = themeKey; document.documentElement.style.setProperty('--card-bg', theme.cardBg); document.documentElement.style.setProperty('--card-text-color', theme.cardText); document.documentElement.style.setProperty('--card-secondary-text-color', theme.cardSecondaryText); document.documentElement.style.setProperty('--card-border-color', theme.cardBorder); document.querySelectorAll('.theme-preset-btn').forEach(btn => btn.classList.remove('selected-theme')); document.querySelector(`.theme-preset-btn[data-theme="${themeKey}"]`)?.classList.add('selected-theme'); renderTimelineFromItems(currentScheduleItems); }
        function setCurrentLayout(layout) { currentLayout = layout; timelineBox.className = `timeline space-y-4 layout-${layout}`; document.querySelector(`input[name="timeline-layout"][value="${layout}"]`).checked = true; renderTimelineFromItems(currentScheduleItems); }

        // ---------- Rendering Functions ----------
        function buildMenuFromTrip() {
            mainMenu.innerHTML = '';
            if (!tripData?.destinations) return;
            tripData.destinations.forEach(dest => {
                const div = document.createElement('div');
                const btn = document.createElement('button');
                btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
                btn.innerHTML = `<span>${dest.nameHe || dest.name} ${dest.emoji || ''}</span> <i class="fas fa-chevron-down transition-transform"></i>`;
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dObj => {
                    const day = hebWeekdayUTC(dObj);
                    const date = `${dObj.getUTCDate()}.${dObj.getUTCMonth()+1}.${dObj.getUTCFullYear()}`;
                    const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
                    const a = document.createElement('a');
                    a.href = `?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
                    a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
                    a.textContent = `${day} ${date} (${dest.nameHe} ${dest.emoji || ''})`;
                    submenu.appendChild(a);
                });
                btn.addEventListener('click', () => { submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); });
                div.append(btn, submenu);
                mainMenu.appendChild(div);
            });
        }

        function renderHeadline(dayTitleFromDoc = null) {
            const destName = destForDate?.nameHe || destForDate?.name || 'היעד';
            const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
            scheduleHeadline.textContent = `הלוז של ${destName} לתאריך ${dateStr}${dayPart}`;
            dayTitleEl.textContent = dayTitleFromDoc ? `${dayTitleFromDoc} • ${dateStr}` : `לוז ליום ${dateStr}`;
            tripSubtitle.textContent = `${destName}${dayPart ? ' •' + dayPart : ''}`;
            dateChip.textContent = dateStr;
        }

        function itemEmoji(it) { 
            if (it.travel?.from?.label || it.travel?.to?.label) return '🗺️';
            if (it.address?.label) return '📍';
            return '🚶‍♂️';
        }
        function timeText(it) { if (!it?.startTime && !it?.endTime) return '--:--'; return [it.startTime || '', it.endTime ? '– '+it.endTime : ''].filter(Boolean).join(' '); }
        
        function getFullItemDetailsHTML(it, index) {
            const hasAddr = !!it.address?.label;
            const hasSite = !!it.links?.site;
            const hasBook = !!it.links?.booking;
            const refs = Array.isArray(it.refs)? it.refs : [];

            const refsHtml = refs.map(r=>{ const href = `${r.page==='summary'?'summary':'attractions'}.html?tripId=${encodeURIComponent(tripId)}&open=${r.type==='logistics'?'logistics':'attraction'}&id=${encodeURIComponent(r.id)}`; const icon = r.type==='logistics' ? (r.subType==='hotel'?'🏨':r.subType==='flight'?'✈️':r.subType==='train'?'🚆':r.subType==='car_rental'?'🚗':r.subType==='ferry'?'⛴️':'⬅️') : '📍'; return `<a class="px-2 py-1 rounded bg-indigo-600/90 text-white text-xs" target="_blank" href="${href}">${icon} ${r.label}</a>`; }).join(' ');
            const linksHtml = [ hasSite ? `<a href="${it.links.site}" target="_blank" class="action-button site"><i class="fa-solid fa-link"></i> אתר</a>` : '', hasBook ? `<a href="${it.links.booking}" target="_blank" class="action-button booking"><i class="fa-solid fa-ticket"></i> הזמנה</a>` : '', refsHtml ].filter(Boolean).join(' ');
            const navHtml = hasAddr ? `<div class="flex gap-2"><a href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button waze"><i class="fa-brands fa-waze"></i> Waze</a><a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a></div>` : '';
            const travelHtml = it.travel?.from?.label || it.travel?.to?.label ? `<div class="mt-2 text-sm" style="color: var(--card-secondary-text-color)"><i class="fa-solid fa-route text-slate-400"></i> ${it.travel?.from?.label ? `מ־${it.travel.from.label}`:''} ${it.travel?.to?.label ? ` אל ${it.travel.to.label}`:''} ${it.travel?.timeText ? ` • ${it.travel.timeText}` : ''}</div>` : '';
            const mapHtml = (currentLayout.includes('accordion-full') && hasAddr && it.address.lat && it.address.lng) ? `<div id="accordion-map-${index}" class="accordion-map-container h-64 w-full mt-4 rounded-lg z-0 border"></div>` : '';

            return `
                ${it.description ? `<p class="mt-2 whitespace-pre-wrap">${it.description}</p>` : ''}
                ${hasAddr ? `<div class="mt-2 text-sm"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>` : ''}
                ${travelHtml}
                <div class="mt-3 flex flex-wrap gap-2">${linksHtml}</div>
                <div class="mt-2">${navHtml}</div>
                ${mapHtml}
            `;
        }
        
        function renderTimelineFromItems(items) {
            currentScheduleItems = items;
            if (!items || items.length === 0) {
                noScheduleBox.parentElement.classList.remove('hidden');
                noScheduleBox.classList.remove('hidden');
                timelineBox.classList.add('hidden');
                createBtn.classList.remove('hidden');
                editBtn.classList.add('hidden');
                mapContainerSection.classList.add('hidden');
                return;
            }
            noScheduleBox.parentElement.classList.remove('hidden');
            noScheduleBox.classList.add('hidden');
            timelineBox.classList.remove('hidden');
            timelineBox.innerHTML = '';
            createBtn.classList.add('hidden');
            editBtn.classList.remove('hidden');
            editBtn.classList.add('inline-flex');

            items.forEach((it, index) => {
                const itemWrapper = document.createElement('div');
                itemWrapper.className = 'timeline-item-wrapper';
                let itemHtml;
                const isLineStyle = currentLayout.startsWith('line-style');

                if (isLineStyle) {
                    const isAccordion = currentLayout.includes('accordion');
                    if (isAccordion) {
                        const summaryContent = `<div class="flex items-center justify-between p-4"><div class="flex items-center gap-3"><span class="text-xl">${itemEmoji(it)}</span><h4 class="font-bold text-lg break-words">${it.title || 'פריט ללא שם'}</h4></div><i class="fas fa-chevron-down chevron-icon"></i></div>`;
                        const detailsContent = currentLayout.includes('summary')
                            ? `${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal-btn">פרטים מלאים...</button>`
                            : getFullItemDetailsHTML(it, index);
                        itemHtml = `
                            <div class="timeline-time-outside">${timeText(it)}</div>
                            <details id="details-${index}" class="group accordion-item themed-card rounded-lg shadow-sm" style="padding-right: 0;">
                                <summary>${summaryContent}</summary>
                                <div class="p-4 pt-0 pr-12"><div class="border-t pt-3" style="border-color: var(--card-border-color);">${detailsContent}</div></div>
                            </details>`;
                    } else { // line-style default
                        itemHtml = `
                            <div class="timeline-time-outside">${timeText(it)}</div>
                            <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal-btn">
                                <div class="flex items-center gap-3">
                                    <span class="text-xl">${itemEmoji(it)}</span>
                                    <h4 class="font-bold text-lg break-words">${it.title || 'פריט ללא שם'}</h4>
                                </div>
                            </div>`;
                    }
                } else if (currentLayout.startsWith('accordion')) {
                    const summaryContent = `<div class="flex items-center justify-between p-4"><div class="flex items-center gap-4"><span class="text-2xl">${itemEmoji(it)}</span><div><h4 class="font-bold text-lg">${it.title || 'פריט ללא שם'}</h4><p class="text-sm font-mono" style="color: var(--card-secondary-text-color);">${timeText(it)}</p></div></div><i class="fas fa-chevron-down chevron-icon"></i></div>`;
                    const detailsContent = currentLayout === 'accordion-summary' 
                        ? `${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal-btn">פרטים מלאים...</button>`
                        : getFullItemDetailsHTML(it, index);
                    itemHtml = `
                        <details id="details-${index}" class="group accordion-item themed-card rounded-lg shadow-sm" style="padding-right: 0;">
                            <summary>${summaryContent}</summary>
                            <div class="p-4 pt-0 pr-12"><div class="border-t pt-3" style="border-color: var(--card-border-color);">${detailsContent}</div></div>
                        </details>`;
                } else { // default layout
                    const navLink = it.address?.label ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps"><i class="fa-solid fa-map-location-dot"></i></a>` : '';
                    const siteLink = it.links?.site ? `<a href="${it.links.site}" target="_blank" class="action-button site"><i class="fa-solid fa-link"></i></a>` : '';
                    itemHtml = `
                        <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal-btn">
                            <div class="text-sm font-bold" style="color: var(--card-secondary-text-color);">${timeText(it)}</div>
                            <h4 class="text-lg font-bold mt-1">${it.title || 'פריט ללא שם'}</h4>
                            ${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}
                            <div class="flex gap-2 mt-2 pt-2 border-t" style="border-color: var(--card-border-color);">
                                ${navLink} ${siteLink}
                            </div>
                        </div>`;
                }
                
                itemWrapper.innerHTML = itemHtml;
                timelineBox.appendChild(itemWrapper);
                
                itemWrapper.querySelectorAll('.open-modal-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => { e.stopPropagation(); showItemDetailModal(it); });
                });
            });
            
            document.querySelectorAll('details.accordion-item').forEach((detailsEl) => {
                const index = detailsEl.id.split('-')[1];
                const item = items[index];
                
                detailsEl.addEventListener('toggle', () => {
                    const mapContainerId = `accordion-map-${index}`;
                    if (detailsEl.open && !accordionMaps[mapContainerId] && item.address?.lat && item.address?.lng) {
                        const mapContainer = detailsEl.querySelector(`#${mapContainerId}`);
                        if (mapContainer) {
                            setTimeout(() => {
                                const accordionMap = L.map(mapContainerId).setView([item.address.lat, item.address.lng], 15);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(accordionMap);
                                L.marker([item.address.lat, item.address.lng]).addTo(accordionMap);
                                accordionMaps[mapContainerId] = accordionMap;
                            }, 50);
                        }
                    }
                });
            });

            renderRouteMap(items);
        }

        function closeDetailModal() {
            if (modalMapInstance) { modalMapInstance.remove(); modalMapInstance = null; }
            itemDetailModal.classList.remove('visible');
        }

        function showItemDetailModal(it) {
            const headerHtml = `<div class="flex justify-between items-start"><div><div class="flex items-center gap-3"><span class="text-2xl">${itemEmoji(it)}</span><h3 class="text-2xl font-bold">${it.title || 'פריט ללא שם'}</h3></div><div class="text-md font-semibold mt-1" style="color: var(--card-secondary-text-color)">${timeText(it)}</div></div><button id="close-detail-modal-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button></div>`;
            const fullDetailsHtml = getFullItemDetailsHTML(it);
            const mapHtml = (it.address?.lat && it.address?.lng) ? `<div id="modal-map" class="h-64 w-full mt-4 rounded-lg z-0 border"></div>` : '';
            
            itemDetailModalContent.innerHTML = `<div class="space-y-4">${headerHtml}<div class="border-t pt-4 space-y-3" style="border-color: var(--card-border-color);">${it.summary ? `<p class="text-lg italic" style="color: var(--card-secondary-text-color)">${it.summary}</p>` : ''}${fullDetailsHtml}</div>${mapHtml}</div>`;
            itemDetailModal.classList.add('visible');
            
            if (it.address?.lat && it.address?.lng) {
                setTimeout(() => {
                    const mapContainer = document.getElementById('modal-map');
                    if (mapContainer) {
                        modalMapInstance = L.map('modal-map').setView([it.address.lat, it.address.lng], 15);
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(modalMapInstance);
                        L.marker([it.address.lat, it.address.lng]).addTo(modalMapInstance);
                    }
                }, 50);
            }
            
            document.getElementById('close-detail-modal-btn').addEventListener('click', closeDetailModal);
        }

        const noteColorMap = { red: 'bg-red-100 border-red-200', green: 'bg-green-100 border-green-200', blue: 'bg-blue-100 border-blue-200', yellow: 'bg-yellow-100 border-yellow-200', orange: 'bg-orange-100 border-orange-200' };
        
        function renderNotesList(notes){
            if (!notes || notes.length===0){
                notesList.innerHTML = `<div style="color: var(--card-secondary-text-color);">אין עדיין דגשים/טיפים.</div>`;
                return;
            }
            notesList.innerHTML = notes.map(n=>{
                const cls = noteColorMap[n.color] || noteColorMap.yellow;
                return `<div class="border rounded-xl p-3 ${cls}"><div class="font-bold text-slate-800">${n.kind}: ${n.title || '—'}</div>${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap text-slate-700">${n.details}</div>` : ''}</div>`;
            }).join('');
        }
        
        function renderRouteMap(items) {
            const locations = items.map(it => it.address).filter(addr => addr && addr.lat && addr.lng);
            if (locations.length < 2) { mapContainerSection.classList.add('hidden'); return; }
            mapContainerSection.classList.remove('hidden');
            if (mapInstance) { mapInstance.remove(); }
            mapInstance = L.map('route-map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap' }).addTo(mapInstance);
            const markers = [];
            const routeColors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6', '#d946ef'];
            mapLegend.innerHTML = '<p class="font-bold">מקרא מסלול:</p>';
            locations.forEach((loc, i) => {
                markers.push(L.marker([loc.lat, loc.lng]).addTo(mapInstance).bindPopup(`<b>${i+1}. ${items[i].title}</b><br>${loc.label}`));
                if (i > 0) {
                    const prevLoc = locations[i-1];
                    const color = routeColors[(i - 1) % routeColors.length];
                    L.polyline([[prevLoc.lat, prevLoc.lng], [loc.lat, loc.lng]], { color: color }).addTo(mapInstance);
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center gap-2';
                    legendItem.innerHTML = `<span class="w-4 h-1 inline-block" style="background-color: ${color};"></span><span>מ: ${prevLoc.label} <i class="fa-solid fa-arrow-left fa-xs"></i> ל: ${loc.label}</span>`;
                    mapLegend.appendChild(legendItem);
                }
            });
            if (markers.length > 0) { mapInstance.fitBounds(new L.featureGroup(markers).getBounds().pad(0.2)); }
        }

        // ---------- Event Listeners & Settings ----------
        const themePresets = {
            'light': { name: 'בהיר', desc: 'לבן, טקסט שחור', style: '', cardBg: 'rgba(255, 255, 255, 0.9)', cardText: '#1e293b', cardSecondaryText: '#475569', cardBorder: 'rgba(226, 232, 240, 0.7)', bgHex: '#ffffff', opacity: 90 },
            'dark': { name: 'כהה', desc: 'כהה, טקסט לבן', style: 'bg-slate-800 text-white', cardBg: 'rgba(30, 41, 59, 0.9)', cardText: '#f1f5f9', cardSecondaryText: '#94a3b8', cardBorder: 'rgba(51, 65, 85, 0.8)', bgHex: '#1e293b', opacity: 90 },
            'glass': { name: 'זכוכית', desc: 'שקוף, טקסט לבן', style: 'themed-card-override', cardBg: 'rgba(255, 255, 255, 0.2)', cardText: '#ffffff', cardSecondaryText: 'rgba(226, 232, 240, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#ffffff', opacity: 20 },
            'ocean': { name: 'אוקיינוס', desc: 'כחול, טקסט לבן', style: 'bg-cyan-700 text-white', cardBg: 'rgba(14, 116, 144, 0.9)', cardText: '#f0f9ff', cardSecondaryText: '#a5f3fc', cardBorder: 'rgba(103, 232, 249, 0.3)', bgHex: '#0e7490', opacity: 90 },
            'sunset': { name: 'שקיעה', desc: 'כתום, טקסט לבן', style: 'bg-orange-500 text-white', cardBg: 'rgba(234, 88, 12, 0.9)', cardText: '#fff7ed', cardSecondaryText: '#fed7aa', cardBorder: 'rgba(251, 146, 60, 0.4)', bgHex: '#ea580c', opacity: 90 },
            'forest': { name: 'יער', desc: 'ירוק, טקסט לבן', style: 'bg-green-800 text-white', cardBg: 'rgba(22, 101, 52, 0.9)', cardText: '#f0fdf4', cardSecondaryText: '#bbf7d0', cardBorder: 'rgba(74, 222, 128, 0.3)', bgHex: '#166534', opacity: 90 },
            'lavender': { name: 'לבנדר', desc: 'סגול בהיר, טקסט כהה', style: 'bg-violet-200 text-violet-900', cardBg: 'rgba(237, 233, 254, 0.9)', cardText: '#4c1d95', cardSecondaryText: '#6d28d9', cardBorder: 'rgba(196, 181, 253, 0.8)', bgHex: '#ede9fe', opacity: 90 },
            'sand': { name: 'חול', desc: 'צהבהב, טקסט חום', style: 'bg-amber-100 text-amber-900', cardBg: 'rgba(254, 243, 199, 0.9)', cardText: '#78350f', cardSecondaryText: '#92400e', cardBorder: 'rgba(252, 211, 77, 0.7)', bgHex: '#fef3c7', opacity: 90 },
            'sunrise': { name: 'זריחה', desc: 'גרדיאנט כתום-ורוד', style: 'text-white', cardBg: 'linear-gradient(135deg, #FFD3A5 0%, #FD6585 100%)', cardText: '#431c4f', cardSecondaryText: 'rgba(67, 28, 79, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#FFD3A5', opacity: 100 },
            'twilight': { name: 'דמדומים', desc: 'גרדיאנט סגול-כחול', style: 'text-white', cardBg: 'linear-gradient(135deg, #3023AE 0%, #c86dd7 100%)', cardText: '#ffffff', cardSecondaryText: 'rgba(230, 230, 255, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#3023AE', opacity: 100 },
            'minty': { name: 'מנטה', desc: 'גרדיאנט ירוק-צהוב', style: 'text-black', cardBg: 'linear-gradient(135deg, #96fbc4 0%, #f9f586 100%)', cardText: '#044343', cardSecondaryText: 'rgba(4, 67, 67, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.5)', bgHex: '#96fbc4', opacity: 100 },
            'rose_gold': { name: 'רוז גולד', desc: 'גרדיאנט ורוד-זהב', style: 'text-black', cardBg: 'linear-gradient(135deg, #f0c793 0%, #d9a7c7 100%)', cardText: '#5d4157', cardSecondaryText: 'rgba(93, 65, 87, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.4)', bgHex: '#f0c793', opacity: 100 },
            'paper': { name: 'נייר', desc: 'קרם, טקסט חום', style: 'bg-amber-50 text-amber-900', cardBg: 'rgba(254, 252, 247, 0.9)', cardText: '#583c27', cardSecondaryText: '#8a6e59', cardBorder: 'rgba(214, 203, 189, 0.8)', bgHex: '#fefcf7', opacity: 90 },
            'deep_space': { name: 'חלל עמוק', desc: 'שחור, טקסט זוהר', style: 'bg-gray-900 text-gray-200', cardBg: 'linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)', cardText: '#e0e0e0', cardSecondaryText: '#a0a0c0', cardBorder: '#3d3470', bgHex: '#0f0c29', opacity: 100 },
            'tropical': { name: 'טרופי', desc: 'גרדיאנט ירוק-כחול', style: 'text-white', cardBg: 'linear-gradient(135deg, #00F260 0%, #0575E6 100%)', cardText: '#ffffff', cardSecondaryText: 'rgba(230, 255, 255, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#00F260', opacity: 100 },
            'coral_reef': { name: 'שונית אלמוגים', desc: 'גרדיאנט ורוד-כתום', style: 'text-black', cardBg: 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)', cardText: '#8a2326', cardSecondaryText: 'rgba(138, 35, 38, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.4)', bgHex: '#ff9a9e', opacity: 100 }
        };

        function attachEvents() {
            hamburgerBtn.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', toggleSidebar);
            settingsBtn.addEventListener('click', toggleSettings);
            closeSettingsBtn.addEventListener('click', toggleSettings);
            overlay.addEventListener('click', () => { sidebar.classList.add('translate-x-full'); settingsModal.classList.add('translate-x-full'); overlay.classList.add('hidden'); });
            tripHomeBtn.href = `trip.html?tripId=${tripId}`;
            itemDetailModal.addEventListener('click', (e) => { if (e.target === itemDetailModal) closeDetailModal(); });

            document.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.settings-nav-btn').forEach(b => { b.classList.remove('bg-slate-200'); b.classList.add('text-slate-500'); });
                    btn.classList.add('bg-slate-200'); btn.classList.remove('text-slate-500');
                    const panelId = `settings-panel-${btn.dataset.panel}`;
                    document.querySelectorAll('.settings-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                });
            });

            document.getElementById('apply-bg-settings').addEventListener('click', () => {
                const url = document.getElementById('bg-image-url').value;
                const color = document.getElementById('bg-color-picker').value;
                const brightness = document.getElementById('bg-brightness-slider').value;
                const bgSettings = { type: url ? 'image' : 'color', value: url || color, brightness: brightness };
                setBackground(bgSettings);
                saveStyleSetting('background', bgSettings, document.getElementById('bg-scope').value);
                toggleSettings();
            });

            document.getElementById('apply-layout-settings').addEventListener('click', () => {
                const newLayout = document.querySelector('input[name="timeline-layout"]:checked').value;
                setCurrentLayout(newLayout);
                saveStyleSetting('layout', newLayout, document.getElementById('layout-scope').value);
                toggleSettings();
            });
            
            const presetsContainer = document.getElementById('theme-presets-container');
            presetsContainer.innerHTML = Object.entries(themePresets).map(([key, theme]) => `
                <button data-theme="${key}" class="theme-preset-btn p-3 border rounded-lg text-center ${theme.style}">
                    <span class="font-bold themed-card-override">${theme.name}</span> <div class="text-xs themed-card-override">${theme.desc}</div>
                </button>
            `).join('');

            document.querySelectorAll('.theme-preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const themeKey = btn.dataset.theme;
                    const newTheme = themePresets[themeKey];
                    if (newTheme) {
                        setTheme(themeKey);
                        document.getElementById('card-bg-color-picker').value = newTheme.bgHex;
                        document.getElementById('card-opacity-slider').value = newTheme.opacity;
                        document.getElementById('card-text-color-picker').value = newTheme.cardText;
                    }
                });
            });

            document.getElementById('apply-theme-settings').addEventListener('click', () => {
                saveStyleSetting('theme', currentThemeKey, 'trip'); // For now, theme is trip-wide
                toggleSettings();
            });
        }

        // ---------- Init & Data Fetching ----------
        async function saveStyleSetting(settingType, value, scope) {
            const tripRef = doc(db, 'trips', tripId);
            let key;
            if (scope === 'date') {
                key = `styles.date_${dateISO}.${settingType}`;
            } else if (scope === 'destination') {
                key = `styles.destination_${destForDate.id}.${settingType}`;
            } else {
                key = `styles.trip.${settingType}`;
            }
            try {
                await updateDoc(tripRef, { [key]: value });
            } catch (e) {
                console.error("Error saving settings, trying setDoc with merge", e);
                await setDoc(tripRef, { styles: { [scope === 'date' ? `date_${dateISO}` : scope === 'destination' ? `destination_${destForDate.id}` : 'trip']: { [settingType]: value } } }, { merge: true });
            }
        }

        function loadAndApplyStyles() {
            const styles = tripData.styles || {};
            const tripStyle = styles.trip || {};
            const destStyle = destForDate ? (styles[`destination_${destForDate.id}`] || {}) : {};
            const dateStyle = dateISO ? (styles[`date_${dateISO}`] || {}) : {};
            
            const finalLayout = dateStyle.layout || destStyle.layout || tripStyle.layout || 'default';
            const finalTheme = dateStyle.theme || destStyle.theme || tripStyle.theme || 'light';
            const finalBg = dateStyle.background || destStyle.background || tripStyle.background || { type: 'image', value: destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg', brightness: 50 };
            
            setCurrentLayout(finalLayout);
            setTheme(finalTheme);
            setBackground(finalBg);
        }

        async function initPage() {
            const url = new URLSearchParams(window.location.search);
            tripId = url.get('tripId');
            dateStr = decodeURIComponent(url.get('date') || '').trim();
            const parsed = parseLocalDateFlexible(dateStr);
            if (parsed) { dateISO = toISODateUTC(parsed); dayNameHe = hebWeekdayUTC(parsed); }

            if (!tripId || !dateStr) { alert('כתובת שגויה: חסר tripId או date.'); location.href = 'index.html'; return; }

            attachEvents();

            onAuthStateChanged(auth, async (user) => {
                if (!user) { location.replace('login.html'); return; }
                currentUser = user;
                const displayName = user.displayName || user.email.split('@')[0];
                authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">שלום, ${displayName} 👋</span><button id="sign-out-btn" title="התנתק" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
                document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));

                const tripRef = doc(db, 'trips', tripId);
                const tripSnap = await getDoc(tripRef);
                if (!tripSnap.exists()) { alert('הטיול לא נמצא.'); location.href = 'index.html'; return; }
                tripData = tripSnap.data();
                if (tripData.ownerId && tripData.ownerId !== currentUser.uid) { alert('אין לך הרשאה לצפות בטיול זה.'); location.href = 'index.html'; return; }

                destForDate = findDestinationForDate(tripData, dateStr);
                loaderBg.style.backgroundImage = `url('${destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg'}')`;
                
                buildMenuFromTrip();
                loadAndApplyStyles();

                const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
                const editHref = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
                editBtn.href = editHref;
                createBtn.href = editHref;

                if (dateISO) {
                    const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
                    const schedSnap = await getDoc(schedDocRef);
                    const dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
                    renderHeadline(dayTitleFromDoc);

                    const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
                    const qItems = query(itemsCol);
                    onSnapshot(qItems, (snap) => { 
                        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                        arr.sort((a, b) => a.sort - b.sort);
                        renderTimelineFromItems(arr);
                    }, () => renderTimelineFromItems([]));

                    const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
                    const qNotes = query(notesCol);
                    onSnapshot(qNotes, (snap) => {
                        const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
                        if (arr.length > 0 && arr[0].createdAt) {
                            arr.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                        }
                        renderNotesList(arr);
                    }, (err) => {
                        console.error("Error fetching notes:", err);
                        renderNotesList([]);
                    });
                } else {
                    renderHeadline(null);
                    renderTimelineFromItems([]);
                    renderNotesList([]);
                }

                initialLoader.style.opacity = '0';
                mainContent.style.opacity = '1';
                setTimeout(() => { initialLoader.style.display = 'none'; }, 500);
            });
        }

        initPage();
    </script>
</body>
</html>
