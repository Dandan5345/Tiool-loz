<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>
    
    <!-- ×¡×¤×¨×™×•×ª ×—×™×¦×•× ×™×•×ª -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

    <!-- ×”×’×“×¨×•×ª Tailwind -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Assistant', 'sans-serif'],
                        rubik: ['Rubik', 'sans-serif'],
                    },
                    colors: {
                        primary: '#0ea5e9', // Sky 500
                        secondary: '#64748b', // Slate 500
                    }
                }
            }
        }
    </script>
    
    <style>
        /* ××©×ª× ×™× ×’×œ×•×‘×œ×™×™× ×œ×¢×¨×›×•×ª × ×•×©× */
        :root {
            --card-bg: rgba(255, 255, 255, 0.9);
            --card-text-color: #1e293b;
            --card-secondary-text-color: #475569;
            --card-border-color: rgba(203, 213, 225, 0.6);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* ×‘×¡×™×¡ */
        html, body {
            height: 100%;
            -webkit-tap-highlight-color: transparent;
            overscroll-behavior-y: none; /* ×× ×™×¢×ª ××©×™×›×” ×œ××¢×œ×”/×œ××˜×” */
        }
        
        body {
            background-color: #f8fafc;
            color: #334155;
            transition: background-color 0.3s ease;
        }

        /* --- ×× ×™××¦×™×•×ª ×ª×¤×¨×™×˜ ×¦×“ --- */
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .submenu.open { 
            max-height: 1000px; 
        }
        #sidebar {
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        body.modal-locked { overflow: hidden; }

        /* --- ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™×•×ª --- */
        .themed-card {
            background: var(--card-bg);
            color: var(--card-text-color);
            border: 1px solid var(--card-border-color);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        
        /* --- ×›×¨×˜×™×¡×™×•×ª Timeline --- */
        .timeline-item-wrapper { position: relative; }
        .timeline-time-outside {
            position: absolute; right: 0; top: 1rem;
            background: var(--card-bg); color: var(--card-text-color);
            padding: 0.25rem 0.5rem; border-radius: 99px;
            font-size: 0.75rem; font-weight: 700;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            z-index: 10; width: 4.5rem; text-align: center;
        }
        /* ×§×• ×¦×™×¨ ×”×–××Ÿ */
        .timeline.layout-line-style::before, 
        .timeline.layout-line-style-accordion-full::before, 
        .timeline.layout-line-style-accordion-summary::before { 
            content: ""; position: absolute; right: 2.25rem; top: 0; bottom: 0; 
            width: 2px; background: rgba(100, 116, 139, 0.2); 
            z-index: 0;
        }
        .timeline.layout-line-style .timeline-item-wrapper,
        .timeline.layout-line-style-accordion-full .timeline-item-wrapper,
        .timeline.layout-line-style-accordion-summary .timeline-item-wrapper {
             padding-right: 5.5rem; 
        }

        /* --- ××•×“×œ×™× (Popups) ××©×•×¤×¨×™× --- */
        .modal-backdrop {
            position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.6); 
            backdrop-filter: blur(4px); z-index: 100;
            opacity: 0; visibility: hidden; transition: all 0.3s ease;
        }
        .modal-backdrop.visible { opacity: 1; visibility: visible; }
        
        .modal-content-wrapper {
            background: var(--card-bg); color: var(--card-text-color);
            width: 100%; max-width: 600px;
            max-height: 85vh; 
            border-radius: 1.5rem 1.5rem 0 0; /* ××•×‘×™×™×œ: ×¤×™× ×•×ª ×¢×’×•×œ×•×ª ×œ××¢×œ×” */
            position: fixed; bottom: 0; left: 50%; transform: translateX(-50%) translateY(100%);
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            display: flex; flex-col; overflow: hidden;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 -10px 40px rgba(0,0,0,0.2);
        }
        @media (min-width: 640px) {
            .modal-content-wrapper {
                border-radius: 1.5rem;
                bottom: auto; top: 50%; 
                transform: translate(-50%, -50%) scale(0.95);
                opacity: 0;
            }
            .modal-backdrop.visible .modal-content-wrapper {
                transform: translate(-50%, -50%) scale(1);
                opacity: 1;
            }
        }
        @media (max-width: 639px) {
            .modal-backdrop.visible .modal-content-wrapper {
                transform: translateX(-50%) translateY(0);
            }
        }

        /* --- Nav Bar ×—×¦×™× ×•×¡×œ×§×˜ --- */
        .date-nav-bar {
            position: sticky; top: 4rem; z-index: 40;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 4px 20px -10px rgba(0,0,0,0.1);
            transition: top 0.3s;
        }
        .date-nav-btn {
            width: 40px; height: 40px; 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center;
            color: #475569; transition: all 0.2s;
        }
        .date-nav-btn:active { background: #e2e8f0; transform: scale(0.95); }
        .date-select-trigger {
            background: #f1f5f9; color: #334155;
            padding: 0.5rem 1rem; border-radius: 99px;
            font-weight: 700; font-size: 0.95rem;
            display: flex; items-center; gap: 0.5rem;
            box-shadow: inset 0 0 0 1px rgba(0,0,0,0.05);
        }
        
        /* Dropdown ×©×œ ×”×ª××¨×™×›×™× */
        .date-dropdown {
            position: absolute; top: 100%; left: 50%; transform: translateX(-50%) translateY(10px);
            width: 90vw; max-width: 320px;
            background: white; border-radius: 1rem;
            box-shadow: 0 10px 40px -5px rgba(0,0,0,0.2);
            padding: 0.5rem; z-index: 50;
            opacity: 0; visibility: hidden; transition: all 0.2s;
            max-height: 60vh; overflow-y: auto;
        }
        .date-dropdown.open { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(5px); }

        /* Loader */
        #initial-loader { position: fixed; inset: 0; z-index: 200; display: flex; align-items: center; justify-content: center; transition: opacity .5s; }
        .plane-spinner { animation: spin 3s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* ××§×•×¨×“×™×•×Ÿ */
        details > summary { list-style: none; cursor: pointer; }
        details > summary::-webkit-details-marker { display: none; }
        .chevron-icon { transition: transform 0.3s ease; }
        details[open] > summary .chevron-icon { transform: rotate(180deg); }
        
        /* ××¤×•×ª */
        .map-container { background: #e2e8f0; border-radius: 0.75rem; overflow: hidden; }
        
        /* ×›×¤×ª×•×¨×™× */
        .action-button {
            display: inline-flex; align-items: center; gap: 0.4rem;
            padding: 0.35rem 0.8rem; border-radius: 0.5rem;
            font-size: 0.85rem; font-weight: 600; color: white;
            transition: transform 0.1s; text-decoration: none;
        }
        .action-button:active { transform: scale(0.97); }
        .btn-waze { background: #33ccff; color: #0f172a; }
        .btn-google { background: #4285f4; }
        .btn-site { background: #6366f1; }
        .btn-details { background: #94a3b8; }
        .btn-ref { background: #8b5cf6; }

        /* Toggle Switch */
        .toggle-switch { position: relative; width: 44px; height: 24px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider { position: absolute; cursor: pointer; inset: 0; background-color: #cbd5e1; transition: .4s; border-radius: 34px; }
        .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        input:checked + .toggle-slider { background-color: #0ea5e9; }
        input:checked + .toggle-slider:before { transform: translateX(20px); }
        
        /* Theme Preset Button */
        .theme-preset-btn.selected-theme { ring: 2px solid #0ea5e9; ring-offset: 2px; }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <!-- Loading Screen -->
    <div id="initial-loader">
        <div class="fixed inset-0 bg-slate-900 z-0"></div>
        <div class="relative z-10 text-center text-white">
            <i class="fas fa-plane-departure fa-3x plane-spinner mb-4 text-sky-400"></i>
            <h2 class="text-2xl font-rubik font-bold">×˜×•×¢×Ÿ ××ª ×”××¡×¢...</h2>
        </div>
    </div>

    <!-- ×¨×§×¢ ×“×™× ×××™ -->
    <div id="page-bg" class="fixed inset-0 z-0 bg-cover bg-center transition-all duration-500" style="background-image:url('https://i.imgur.com/MjekTyd_d.webp');"></div>
    <div id="page-bg-overlay" class="fixed inset-0 z-0 bg-slate-900/60 transition-colors duration-500"></div>

    <!-- Sidebar Overlay -->
    <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300 opacity-0"></div>

    <!-- Sidebar Menu (New Design) -->
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform translate-x-full border-l border-white/20 flex flex-col">
        <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-l from-cyan-50 to-transparent shrink-0">
            <h2 class="text-2xl font-bold text-slate-800 font-rubik">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
            <button id="close-sidebar-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav id="main-menu" class="p-4 space-y-3 overflow-y-auto flex-grow pb-20 scroll-smooth">
            <!-- Dynamic Content -->
        </nav>
        <div class="p-4 border-t border-slate-100 bg-slate-50 shrink-0 text-center">
            <div id="auth-container" class="text-xs text-slate-500 mb-2"></div>
            <p class="text-[10px] text-slate-300">×ª×›× ×•×Ÿ ×˜×™×•×œ ×—×›×</p>
        </div>
    </aside>

    <!-- Settings Modal (New Design) -->
    <aside id="settings-modal" class="fixed inset-y-0 left-0 w-full sm:w-96 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform -translate-x-full transition-transform duration-300 flex flex-col">
        <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-r from-blue-50 to-transparent shrink-0">
            <h2 class="text-2xl font-bold text-slate-800 font-rubik">×¢×™×¦×•×‘ ××™×©×™ ğŸ¨</h2>
            <button id="close-settings-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 transition flex items-center justify-center">
                <i class="fas fa-times"></i>
            </button>
        </div>
        
        <div class="p-4 flex-grow overflow-y-auto">
            <!-- Tabs -->
            <div class="grid grid-cols-3 gap-1 bg-slate-100 p-1 rounded-xl mb-6">
                <button data-panel="bg" class="settings-nav-btn py-2 rounded-lg text-sm font-bold bg-white shadow-sm text-slate-800 transition-all">×¨×§×¢</button>
                <button data-panel="layout" class="settings-nav-btn py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 transition-all">×¤×¨×™×¡×”</button>
                <button data-panel="theme" class="settings-nav-btn py-2 rounded-lg text-sm font-bold text-slate-500 hover:text-slate-700 transition-all">× ×•×©×</button>
            </div>

            <!-- Panels -->
            <div id="settings-panel-bg" class="settings-panel space-y-5">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">×ª××•× ×ª ×¨×§×¢</label>
                    <div class="flex gap-2">
                        <button id="bg-image-upload-btn" class="flex-1 bg-blue-50 text-blue-600 font-bold py-3 px-4 rounded-xl hover:bg-blue-100 transition border border-blue-200">
                            <i class="fas fa-image mr-1"></i> ×”×¢×œ×” ×ª××•× ×”
                        </button>
                        <button id="bg-image-remove-btn" class="hidden w-12 bg-red-50 text-red-500 rounded-xl hover:bg-red-100 border border-red-200">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                    <input type="file" id="bg-image-upload-input" class="hidden" accept="image/*">
                    <input type="hidden" id="bg-image-url-storage">
                    <p id="bg-image-status" class="text-xs mt-1 text-center h-4"></p>
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">×‘×”×™×¨×•×ª ×¨×§×¢</label>
                    <input id="bg-brightness-slider" type="range" min="0" max="100" value="50" class="w-full accent-blue-500 h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                </div>
                <div class="pt-4 border-t">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">×”×—×œ ×¢×œ</label>
                    <select id="bg-scope" class="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold outline-none focus:border-blue-400">
                        <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×–×” (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="date">×¨×§ ×œ×ª××¨×™×š ×–×”</option>
                        <option value="trip">×›×œ ×”×˜×™×•×œ</option>
                    </select>
                </div>
                <button id="apply-bg-settings" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-700 active:scale-95 transition mt-4">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>

            <div id="settings-panel-layout" class="settings-panel space-y-4 hidden">
                <div class="space-y-3">
                    <!-- Layout Options -->
                    <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="timeline-layout" value="default" class="w-5 h-5 text-blue-600">
                        <div><span class="block font-bold text-sm">×›×¨×˜×™×¡×™×•×ª</span><span class="text-xs text-slate-500">×ª×¦×•×’×” ×§×œ××¡×™×ª ×•×‘×¨×•×¨×”</span></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="timeline-layout" value="line-style" class="w-5 h-5 text-blue-600">
                        <div><span class="block font-bold text-sm">×¦×™×¨ ×–××Ÿ</span><span class="text-xs text-slate-500">×§×• ×¨×¦×™×£ ×¢× ×›×¨×˜×™×¡×™×•×ª ×‘×¦×“</span></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="timeline-layout" value="accordion-full" class="w-5 h-5 text-blue-600">
                        <div><span class="block font-bold text-sm">××§×•×¨×“×™×•×Ÿ</span><span class="text-xs text-slate-500">×¨×©×™××” × ×¤×ª×—×ª ×œ×—×™×¡×›×•×Ÿ ×‘××§×•×</span></div>
                    </label>
                    <label class="flex items-center gap-3 p-3 border border-slate-200 rounded-xl cursor-pointer hover:bg-slate-50 has-[:checked]:border-blue-500 has-[:checked]:bg-blue-50 transition">
                        <input type="radio" name="timeline-layout" value="condensed-list" class="w-5 h-5 text-blue-600">
                        <div><span class="block font-bold text-sm">×¨×©×™××” ×“×—×•×¡×”</span><span class="text-xs text-slate-500">×˜×§×¡×˜ ×‘×œ×‘×“, ×œ×œ× ×ª××•× ×•×ª</span></div>
                    </label>
                </div>
                
                <div id="smart-accordion-controls" class="pt-4 border-t flex justify-between items-center hidden">
                    <div>
                        <span class="block font-bold text-sm text-slate-700">××§×•×¨×“×™×•×Ÿ ×—×›×</span>
                        <span class="text-xs text-slate-500">×¤×ª×— ××•×˜×•××˜×™×ª ×œ×¤×™ ×”×©×¢×” ×”× ×•×›×—×™×ª</span>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" id="smart-accordion-toggle">
                        <span class="toggle-slider"></span>
                    </label>
                </div>

                <div class="pt-4 border-t">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">×”×—×œ ×¢×œ</label>
                    <select id="layout-scope" class="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                        <option value="trip">×›×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="destination">×™×¢×“ ×–×” ×‘×œ×‘×“</option>
                    </select>
                </div>
                <button id="apply-layout-settings" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-700 active:scale-95 transition mt-4">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>

            <div id="settings-panel-theme" class="settings-panel space-y-4 hidden">
                <div class="grid grid-cols-2 gap-3" id="theme-presets-container">
                    <!-- Themes generated by JS -->
                </div>
                
                <!-- NEW: Scope for Theme -->
                <div class="pt-4 border-t">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">×”×—×œ ×¢×œ</label>
                    <select id="theme-scope" class="w-full mt-1 p-3 bg-slate-50 border border-slate-200 rounded-xl text-sm font-semibold">
                        <option value="trip">×›×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="destination">×™×¢×“ ×–×” ×‘×œ×‘×“</option>
                        <option value="date">×¨×§ ×œ×ª××¨×™×š ×–×”</option>
                    </select>
                </div>

                <button id="apply-theme-settings" class="w-full bg-slate-800 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-slate-700 active:scale-95 transition mt-4">×©××•×¨ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <div id="main-content" class="relative z-10 transition-all duration-300 opacity-0 pb-32">
        
        <!-- Top Header -->
        <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 shadow-sm border-b border-white/20">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-16">
                    <a id="trip-home-btn" href="#" class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition">
                        <i class="fas fa-home"></i>
                    </a>
                    
                    <h1 class="text-lg font-rubik font-bold text-slate-800 truncate px-2">×œ×•×´×– ×™×•××™</h1>

                    <div class="flex items-center gap-2">
                        <button id="settings-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-600 hover:bg-blue-50 hover:text-blue-600 transition flex items-center justify-center">
                            <i class="fas fa-paint-brush"></i>
                        </button>
                        <button id="hamburger-btn" class="w-10 h-10 rounded-full bg-slate-900 text-white shadow-lg hover:scale-105 transition flex items-center justify-center">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- New: Date Navigation Bar -->
        <div id="date-nav-bar" class="date-nav-bar container mx-auto px-4 py-2 flex justify-between items-center">
            <!-- Right Arrow = Prev Day (RTL Logic: Arrow points Right means go right in visual timeline, usually prev) -->
            <!-- Requested: Left arrow on left side, Right arrow on right side -->
            <!-- Logic: Prev Button is Right Side, Next Button is Left Side -->
            
            <button id="prev-day-btn" class="date-nav-btn hover:bg-slate-100">
                <i class="fas fa-chevron-right fa-lg"></i>
            </button>

            <div class="relative">
                <button id="date-select-trigger" class="date-select-trigger">
                    <i class="far fa-calendar-alt text-slate-400"></i>
                    <span id="current-date-display">×˜×•×¢×Ÿ...</span>
                    <i class="fas fa-caret-down text-xs ml-1 transition-transform" id="date-chevron"></i>
                </button>
                <!-- Dropdown -->
                <div id="date-dropdown" class="date-dropdown">
                    <!-- Populated by JS -->
                </div>
            </div>

            <button id="next-day-btn" class="date-nav-btn hover:bg-slate-100">
                <i class="fas fa-chevron-left fa-lg"></i>
            </button>
        </div>

        <div class="container mx-auto px-4 mt-6 max-w-4xl space-y-6">
            
            <!-- Title Section -->
            <section class="themed-card rounded-2xl p-6 shadow-sm relative overflow-hidden">
                <div class="absolute top-0 left-0 w-2 h-full bg-blue-500"></div>
                <div>
                    <h2 id="day-title" class="text-3xl font-rubik font-bold mb-1">...</h2>
                    <p id="trip-subtitle" class="text-lg opacity-80 flex items-center gap-2">
                        <i class="fas fa-map-marker-alt text-blue-500"></i> <span id="dest-name">...</span>
                    </p>
                </div>
            </section>

            <!-- Main Timeline -->
            <section id="timeline-section" class="min-h-[200px]">
                <div id="no-schedule" class="themed-card text-center p-10 rounded-2xl shadow-sm hidden">
                    <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4 text-slate-400">
                        <i class="fa-regular fa-calendar-plus fa-2x"></i>
                    </div>
                    <h3 class="text-xl font-bold mb-2">×™×•× ×–×” ×¤× ×•×™</h3>
                    <p class="text-sm opacity-70 mb-6">××™×Ÿ ×¢×“×™×™×Ÿ ×ª×•×›× ×™×•×ª ×œ×™×•× ×–×”. ×–×” ×”×–××Ÿ ×œ×ª×›× ×Ÿ!</p>
                    <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-slate-900 text-white font-bold py-3 px-6 rounded-xl hover:scale-105 transition">
                        <i class="fas fa-magic"></i> ×¦×•×¨ ×œ×•×´×–
                    </a>
                </div>
                
                <div id="timeline" class="timeline space-y-4"></div>
            </section>
            
            <a id="edit-schedule-btn" href="#" class="hidden w-full bg-white/50 backdrop-blur border border-white/40 text-slate-700 font-bold py-3 rounded-xl text-center hover:bg-white/80 transition shadow-sm">
                <i class="fas fa-pen mr-1"></i> ×¢×¨×•×š ×œ×•×´×–
            </a>

            <!-- Info Accordions -->
            <div class="grid gap-4">
                 <details id="notes-section" class="themed-card rounded-2xl shadow-sm overflow-hidden group">
                    <summary class="p-5 flex justify-between items-center font-bold text-lg cursor-pointer hover:bg-black/5 transition">
                        <span class="flex items-center gap-3"><i class="fas fa-lightbulb text-amber-400"></i> ×“×’×©×™× ×•×˜×™×¤×™×</span>
                        <i class="fas fa-chevron-down chevron-icon opacity-50"></i>
                    </summary>
                    <div class="p-5 pt-0 border-t border-black/5">
                        <div id="notes-list" class="grid gap-3 mt-4"></div>
                    </div>
                </details>

                <details id="map-container-section" class="themed-card rounded-2xl shadow-sm overflow-hidden hidden group">
                     <summary class="p-5 flex justify-between items-center font-bold text-lg cursor-pointer hover:bg-black/5 transition">
                        <span class="flex items-center gap-3"><i class="fas fa-map text-emerald-500"></i> ××¤×ª ×”×™×•×</span>
                        <i class="fas fa-chevron-down chevron-icon opacity-50"></i>
                    </summary>
                    <div class="p-4 pt-0">
                        <div id="route-map" class="h-64 rounded-xl mt-4 z-0"></div>
                        <div id="map-legend" class="mt-2 space-y-1 text-xs opacity-70"></div>
                    </div>
                </details>
            </div>
        </div>
    </div>

    <!-- Details Modal (Bottom Sheet style) -->
    <div id="item-detail-modal" class="modal-backdrop">
        <div class="modal-content-wrapper">
            <div class="p-5 border-b border-gray-100 flex justify-between items-start bg-white/50 backdrop-blur sticky top-0 z-10">
                <div class="pr-2">
                    <h3 id="modal-title" class="text-xl font-bold font-rubik leading-tight"></h3>
                    <p id="modal-subtitle" class="text-sm text-slate-500 mt-1 font-mono"></p>
                </div>
                <button id="close-detail-modal-btn" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center text-slate-500 hover:bg-red-50 hover:text-red-500 transition shrink-0">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="item-detail-modal-content" class="p-5 overflow-y-auto max-h-[70vh]"></div>
        </div>
    </div>

    <!-- Ref Modal (Bottom Sheet style) -->
    <div id="ref-detail-modal" class="modal-backdrop">
        <div class="modal-content-wrapper">
             <div class="p-4 border-b flex justify-between items-center sticky top-0 bg-white/90 backdrop-blur z-10">
                <span class="font-bold text-slate-500 text-xs uppercase">×¤×¨×˜×™× × ×•×¡×¤×™×</span>
                <button id="close-ref-modal-btn" class="w-8 h-8 rounded-full bg-slate-100 flex items-center justify-center"><i class="fas fa-times"></i></button>
            </div>
            <div id="ref-detail-modal-content" class="p-5 overflow-y-auto max-h-[70vh]"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, onSnapshot, query, updateDoc, setDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch(err => console.warn("Persistence disabled:", err.code));
        const IMAGE_WORKER_URL = "https://yellow-cloud-3f13.doronenakache.workers.dev/";

        // State
        let currentUser = null;
        let tripId, dateStr, dateISO, destForDate;
        let tripData = null;
        let currentScheduleItems = [];
        let allTripDates = []; // For Navigation
        let mapInstance = null, modalMapInstance = null;
        
        // Settings State
        let userSettings = {}; 
        let currentLayout = 'default';
        let isSmartAccordionActive = false;
        let smartAccordionInterval = null;

        // UI Refs
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const initialLoader = document.getElementById('initial-loader');
        const pageBg = document.getElementById('page-bg');
        const pageBgOverlay = document.getElementById('page-bg-overlay');
        const timelineBox = document.getElementById('timeline');
        const navDateDisplay = document.getElementById('current-date-display');
        const dateDropdown = document.getElementById('date-dropdown');
        const settingsModal = document.getElementById('settings-modal');

        // --- Helper: Dates ---
        function parseDDMMYYYY(s) { 
            if(!s) return null;
            const [d,m,y] = s.split('/').map(Number);
            return new Date(y, m-1, d);
        }
        function toISODateUTC(d) {
            return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
        }
        function getHebDay(d) {
            return d.toLocaleDateString('he-IL', { weekday: 'long' });
        }
        function generateDates(range) {
            const [s, e] = range.split(' - ');
            const start = parseDDMMYYYY(s), end = parseDDMMYYYY(e);
            const arr = [];
            for(let dt=new Date(start); dt<=end; dt.setDate(dt.getDate()+1)) {
                arr.push(new Date(dt));
            }
            return arr;
        }

        // --- Logic: Navigation & Data ---
        async function init() {
            const params = new URLSearchParams(location.search);
            tripId = params.get('tripId');
            dateStr = decodeURIComponent(params.get('date')||'');
            const destParam = decodeURIComponent(params.get('dest')||'');

            if(!tripId || !dateStr) { location.href = 'index.html'; return; }
            
            // UI Init
            document.getElementById('trip-home-btn').href = `trip.html?id=${tripId}`;
            setupEventListeners();

            onAuthStateChanged(auth, async (user) => {
                if(!user) { location.href = 'login.html'; return; }
                currentUser = user;
                document.getElementById('auth-container').innerHTML = `××—×•×‘×¨ ×›: <b>${user.displayName||'××©×ª××©'}</b>`;

                await loadTripData(destParam);
            });
        }

        async function loadTripData(destParam) {
            try {
                const docSnap = await getDoc(doc(db, 'trips', tripId));
                if(!docSnap.exists()) throw new Error("Trip not found");
                tripData = docSnap.data();
                
                // 1. Load User Settings
                if (tripData.userSettings && tripData.userSettings[currentUser.uid]) {
                    userSettings = tripData.userSettings[currentUser.uid];
                } else {
                    userSettings = {}; // Fallback to global or defaults
                }

                // 2. Identify Current Context
                findDestinationAndDate(destParam);
                
                // 3. Build Navigation Array
                buildAllDatesArray();
                updateNavUI();
                buildSidebarMenu();

                // 4. Apply Styles (User Specific)
                applyStyles();

                // 5. Load Schedule Content
                if (destForDate) {
                    const schedId = `${dateISO}_${destForDate.nameHe}`;
                    
                    // Listen to Items
                    onSnapshot(query(collection(db, 'trips', tripId, 'schedules', schedId, 'items')), sn => {
                        const items = sn.docs.map(d => ({id: d.id, ...d.data()})).sort((a,b) => a.sort - b.sort);
                        renderTimeline(items);
                    });
                    
                    // Listen to Notes
                    onSnapshot(query(collection(db, 'trips', tripId, 'schedules', schedId, 'notes')), sn => {
                         const notes = sn.docs.map(d => ({id:d.id, ...d.data()}));
                         renderNotes(notes);
                    });
                    
                    // Set Links
                    const editUrl = `create-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}&dest=${encodeURIComponent(destForDate.nameHe)}`;
                    document.getElementById('create-schedule-btn').href = editUrl;
                    document.getElementById('edit-schedule-btn').href = editUrl;

                    document.getElementById('day-title').textContent = getHebDay(parseDDMMYYYY(dateStr));
                    document.getElementById('dest-name').textContent = `${destForDate.nameHe} â€¢ ${dateStr}`;
                }

                initialLoader.style.opacity = '0';
                setTimeout(()=> initialLoader.style.display='none', 500);

            } catch (e) {
                console.error(e);
                alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”× ×ª×•× ×™×");
            }
        }

        function findDestinationAndDate(urlDestName) {
            // Find destination object logic
            const targetDate = parseDDMMYYYY(dateStr);
            if(!targetDate) return;
            dateISO = toISODateUTC(targetDate);
            
            // Try to match by name first
            if(urlDestName) {
                destForDate = tripData.destinations.find(d => (d.nameHe === urlDestName || d.name === urlDestName));
            }
            // Fallback: search by date range
            if(!destForDate) {
                destForDate = tripData.destinations.find(dest => {
                    const rangeDates = generateDates(dest.dates).map(toISODateUTC);
                    return rangeDates.includes(dateISO);
                });
            }
        }

        function buildAllDatesArray() {
            allTripDates = [];
            if(!tripData.destinations) return;
            
            // Sort destinations by start date
            const sortedDest = [...tripData.destinations].sort((a,b) => {
                const da = parseDDMMYYYY(a.dates.split(' - ')[0]);
                const db = parseDDMMYYYY(b.dates.split(' - ')[0]);
                return da - db;
            });

            sortedDest.forEach(dest => {
                const dates = generateDates(dest.dates);
                dates.forEach(d => {
                    allTripDates.push({
                        dateObj: d,
                        dateStr: `${d.getDate()}/${d.getMonth()+1}/${d.getFullYear()}`,
                        iso: toISODateUTC(d),
                        dest: dest,
                        dayName: getHebDay(d)
                    });
                });
            });
        }

        function updateNavUI() {
            const currIdx = allTripDates.findIndex(d => d.iso === dateISO && d.dest.nameHe === destForDate?.nameHe);
            
            // Nav Bar Logic
            navDateDisplay.textContent = `${dateStr} (${destForDate?.nameHe || '?'})`;
            
            // Arrows
            const prevBtn = document.getElementById('prev-day-btn');
            const nextBtn = document.getElementById('next-day-btn');
            
            // Prev (Right Arrow): Go to index - 1
            if(currIdx > 0) {
                prevBtn.onclick = () => goToDate(allTripDates[currIdx - 1]);
                prevBtn.disabled = false;
                prevBtn.classList.remove('opacity-30');
            } else {
                prevBtn.disabled = true;
                prevBtn.classList.add('opacity-30');
            }

            // Next (Left Arrow): Go to index + 1
            if(currIdx < allTripDates.length - 1 && currIdx !== -1) {
                nextBtn.onclick = () => goToDate(allTripDates[currIdx + 1]);
                nextBtn.disabled = false;
                nextBtn.classList.remove('opacity-30');
            } else {
                nextBtn.disabled = true;
                nextBtn.classList.add('opacity-30');
            }

            // Dropdown Build
            let lastDest = null;
            let html = '';
            allTripDates.forEach(item => {
                if(item.dest.nameHe !== lastDest) {
                    html += `<div class="px-3 py-1 mt-2 text-xs font-bold text-slate-400 uppercase tracking-wider sticky top-0 bg-white border-b">${item.dest.nameHe}</div>`;
                    lastDest = item.dest.nameHe;
                }
                const isCurrent = (item.iso === dateISO && item.dest.nameHe === destForDate?.nameHe);
                html += `
                    <button class="w-full text-right px-3 py-2 text-sm rounded-lg hover:bg-slate-50 flex justify-between items-center ${isCurrent ? 'bg-blue-50 text-blue-600 font-bold' : 'text-slate-600'}" 
                        onclick="window.location.href='?tripId=${tripId}&date=${encodeURIComponent(item.dateStr)}&dest=${encodeURIComponent(item.dest.nameHe)}'">
                        <span>${item.dayName}, ${item.dateStr}</span>
                        ${isCurrent ? '<i class="fas fa-check text-xs"></i>' : ''}
                    </button>
                `;
            });
            dateDropdown.innerHTML = html;
        }

        function goToDate(item) {
            location.href = `?tripId=${tripId}&date=${encodeURIComponent(item.dateStr)}&dest=${encodeURIComponent(item.dest.nameHe)}`;
        }

        // --- Sidebar Logic ---
        function buildSidebarMenu() {
            const menu = document.getElementById('main-menu');
            menu.innerHTML = '';

            // Quick Links
            const links = [
                {n:'××¨×›×– ×”×‘×§×¨×”', i:'fa-home', c:'text-blue-500', u:`trip.html?id=${tripId}`},
                {n:'×œ×•×’×™×¡×˜×™×§×”', i:'fa-suitcase', c:'text-orange-500', u:`summary.html?tripId=${tripId}`},
                {n:'××˜×¨×§×¦×™×•×ª', i:'fa-utensils', c:'text-cyan-500', u:`attractions.html?tripId=${tripId}`},
                {n:'×”×•×¦××•×ª', i:'fa-coins', c:'text-rose-500', u:`expenses.html?tripId=${tripId}`}
            ];
            
            const grid = document.createElement('div');
            grid.className = 'grid grid-cols-2 gap-2 mb-4';
            links.forEach(l => {
                grid.innerHTML += `
                    <a href="${l.u}" class="flex flex-col items-center justify-center p-3 bg-slate-50 rounded-xl hover:bg-slate-100 transition text-center">
                        <i class="fas ${l.i} ${l.c} text-xl mb-1"></i>
                        <span class="text-xs font-bold text-slate-600">${l.n}</span>
                    </a>
                `;
            });
            menu.appendChild(grid);
            menu.appendChild(document.createElement('hr')).className = "border-slate-100 my-2";

            // Destinations Tree
            const uniqueDests = [...new Set(allTripDates.map(i => i.dest))];
            uniqueDests.forEach(dest => {
                const div = document.createElement('div');
                div.className = "mb-1";
                const destDates = allTripDates.filter(d => d.dest === dest);
                
                div.innerHTML = `
                    <button class="w-full flex justify-between items-center p-3 rounded-xl hover:bg-slate-50 transition group" onclick="this.nextElementSibling.classList.toggle('open'); this.querySelector('.chevron-icon').classList.toggle('rotate-180')">
                        <span class="font-bold text-slate-700 text-sm"><i class="fas fa-map-marker-alt text-slate-300 ml-2 group-hover:text-blue-400"></i>${dest.nameHe}</span>
                        <i class="fas fa-chevron-down chevron-icon text-xs text-slate-300"></i>
                    </button>
                    <div class="submenu pl-4 space-y-1">
                        ${destDates.map(d => `
                            <a href="?tripId=${tripId}&date=${encodeURIComponent(d.dateStr)}&dest=${encodeURIComponent(d.dest.nameHe)}" class="block py-2 px-3 text-xs text-slate-500 hover:text-blue-600 hover:bg-blue-50 rounded-lg flex items-center justify-between ${d.iso===dateISO ? 'bg-blue-50 text-blue-700 font-bold' : ''}">
                                <span>${d.dayName}</span>
                                <span>${d.dateStr.split('/')[0]}.${d.dateStr.split('/')[1]}</span>
                            </a>
                        `).join('')}
                    </div>
                `;
                menu.appendChild(div);
            });
        }

        // --- Settings & Styles Logic (User Specific) ---
        function applyStyles() {
            // Priority: User Settings > Trip Global Settings > Defaults
            // 1. Theme
            const tripStyles = tripData.styles || {};
            const userSt = userSettings.styles || {};
            
            // Scope Keys
            const destKey = `destination_${destForDate?.id}`;
            const dateKey = `date_${dateISO}_${destForDate?.nameHe}`;

            // Resolve Background
            // Check User Specific Date -> User Dest -> User Trip -> Global Date -> Global Dest -> Global Trip -> Default
            let bgVal = 
                userSt[dateKey]?.background || 
                userSt[destKey]?.background || 
                userSt.trip?.background || 
                tripStyles[dateKey]?.background || 
                tripStyles[destKey]?.background || 
                tripStyles.trip?.background || 
                { type: 'image', value: destForDate?.bgUrl || 'https://i.imgur.com/MjekTyd.jpeg', brightness: 50 };
            
            // Resolve Layout
            let layoutVal = 
                userSt[destKey]?.layout || 
                userSt.trip?.layout || 
                tripStyles.trip?.layout || 
                { layout: 'default', smart: false };

            // Resolve Theme
            let themeVal = 
                userSt[dateKey]?.theme || 
                userSt[destKey]?.theme ||
                userSt.trip?.theme || 
                tripStyles.trip?.theme ||
                { key: 'light' };

            // Apply
            applyBackground(bgVal);
            applyLayout(layoutVal);
            applyTheme(themeVal);

            // Populate Settings UI
            document.getElementById('bg-brightness-slider').value = bgVal.brightness;
            document.getElementById('bg-image-url-storage').value = bgVal.type === 'image' ? bgVal.value : '';
            if(layoutVal.layout) document.querySelector(`input[name="timeline-layout"][value="${layoutVal.layout}"]`).checked = true;
            document.getElementById('smart-accordion-toggle').checked = layoutVal.smart;
        }

        function applyBackground(bg) {
            if(bg.type === 'image') {
                pageBg.style.backgroundImage = `url('${bg.value}')`;
                pageBg.style.backgroundColor = '';
            } else {
                pageBg.style.backgroundImage = 'none';
                pageBg.style.backgroundColor = bg.value;
            }
            pageBgOverlay.style.backgroundColor = `rgba(15, 23, 42, ${1 - (bg.brightness/100)})`;
        }

        const themePresets = {
            'light': { name: '×‘×”×™×¨', style: 'bg-white text-slate-800', css: { '--card-bg': 'rgba(255,255,255,0.9)', '--card-text-color': '#1e293b' }},
            'dark': { name: '×›×”×”', style: 'bg-slate-800 text-white', css: { '--card-bg': 'rgba(30,41,59,0.9)', '--card-text-color': '#f8fafc', '--card-secondary-text-color': '#cbd5e1' }},
            'glass': { name: '×–×›×•×›×™×ª', style: 'bg-white/20 backdrop-blur text-white', css: { '--card-bg': 'rgba(255,255,255,0.15)', '--card-text-color': '#fff', '--card-border-color': 'rgba(255,255,255,0.3)' }},
            'sunset': { name: '×©×§×™×¢×”', style: 'bg-orange-500 text-white', css: { '--card-bg': 'rgba(255,237,213,0.95)', '--card-text-color': '#7c2d12', '--card-border-color': '#fdba74' }},
            'ocean': { name: '××•×§×™×™× ×•×¡', style: 'bg-cyan-600 text-white', css: { '--card-bg': 'rgba(207,250,254,0.95)', '--card-text-color': '#164e63' }}
        };

        function applyTheme(themeObj) {
            const key = themeObj.key || 'light';
            const preset = themePresets[key];
            if(preset) {
                const root = document.documentElement;
                // Reset defaults
                root.style.setProperty('--card-secondary-text-color', '#475569');
                root.style.setProperty('--card-border-color', 'rgba(203, 213, 225, 0.6)');
                
                Object.entries(preset.css).forEach(([prop, val]) => root.style.setProperty(prop, val));
                
                // Highlight UI
                document.querySelectorAll('.theme-preset-btn').forEach(b => b.classList.remove('selected-theme'));
                const btn = document.querySelector(`.theme-preset-btn[data-theme="${key}"]`);
                if(btn) btn.classList.add('selected-theme');
            }
        }

        function applyLayout(settings) {
            const layout = settings.layout || 'default';
            currentLayout = layout;
            
            timelineBox.className = 'timeline space-y-4';
            timelineBox.classList.add(`layout-${layout}`);
            
            isSmartAccordionActive = settings.smart;
            document.getElementById('smart-accordion-controls').classList.toggle('hidden', !layout.includes('accordion'));
            
            if(currentScheduleItems.length) renderTimeline(currentScheduleItems);
        }

        async function saveUserSetting(type, value, scope) {
            // Scope: 'trip', 'destination', 'date'
            const tripRef = doc(db, 'trips', tripId);
            let key = '';
            
            if (scope === 'date') key = `date_${dateISO}_${destForDate.nameHe}`;
            else if (scope === 'destination') key = `destination_${destForDate.id}`;
            else key = 'trip';

            const fieldPath = `userSettings.${currentUser.uid}.styles.${key}.${type}`;
            
            // Note: Firestore nested update syntax requires dot notation in the key, 
            // but for dynamic Map updates inside a Map, it's safer to read-modify-write or use dot notation if keys are safe.
            // Since keys contain custom strings, dot notation in updateDoc might fail if keys have dots.
            // We'll use a safer Merge approach.
            
            const newData = { userSettings: { [currentUser.uid]: { styles: { [key]: { [type]: value } } } } };
            await setDoc(tripRef, newData, { merge: true });
            
            // Optimistic update
            if(!userSettings.styles) userSettings.styles = {};
            if(!userSettings.styles[key]) userSettings.styles[key] = {};
            userSettings.styles[key][type] = value;
        }

        // --- Timeline Rendering ---
        function renderTimeline(items) {
            currentScheduleItems = items;
            const container = document.getElementById('timeline');
            container.innerHTML = '';
            document.getElementById('no-schedule').classList.toggle('hidden', items.length > 0);
            document.getElementById('edit-schedule-btn').classList.toggle('hidden', items.length === 0);
            document.getElementById('map-container-section').parentElement.classList.toggle('hidden', items.length === 0);

            if(!items.length) return;

            if(currentLayout === 'condensed-list') {
                container.innerHTML = `<div class="themed-card rounded-xl overflow-hidden divide-y divide-gray-100/20">
                    ${items.map((it, idx) => `
                        <div class="p-3 flex gap-4 cursor-pointer hover:bg-black/5 transition" onclick="openDetailModal(${idx})">
                            <span class="font-bold text-sm w-12 text-right shrink-0">${it.startTime||'--:--'}</span>
                            <span class="truncate font-semibold">${it.title}</span>
                        </div>
                    `).join('')}
                </div>`;
            } else {
                items.forEach((it, idx) => {
                    const isAccordion = currentLayout.includes('accordion');
                    const isLine = currentLayout.includes('line');
                    const wrapper = document.createElement('div');
                    wrapper.className = 'timeline-item-wrapper';
                    
                    if(isLine) {
                         wrapper.innerHTML += `<div class="timeline-time-outside">${it.startTime || '--:--'}</div>`;
                    }

                    let contentHtml = '';
                    if(isAccordion) {
                        contentHtml = `
                        <details id="details-${idx}" class="themed-card rounded-xl shadow-sm group overflow-hidden">
                            <summary class="p-4 flex items-center justify-between cursor-pointer hover:bg-black/5 transition">
                                <div class="flex items-center gap-3">
                                    <span class="text-xl">${getItemIcon(it)}</span>
                                    <div>
                                        <div class="font-bold leading-tight">${it.title}</div>
                                        ${!isLine ? `<div class="text-xs opacity-70 mt-0.5 font-mono">${it.startTime||''} - ${it.endTime||''}</div>` : ''}
                                    </div>
                                </div>
                                <i class="fas fa-chevron-down chevron-icon opacity-40"></i>
                            </summary>
                            <div class="p-4 pt-0 border-t border-black/5 text-sm">
                                <div class="mt-3">${it.summary || ''}</div>
                                <button class="mt-3 text-blue-500 font-bold text-xs" onclick="openDetailModal(${idx})">×¤×¨×˜×™× ××œ××™×...</button>
                            </div>
                        </details>
                        `;
                    } else {
                        // Card Layout
                        contentHtml = `
                        <div class="themed-card rounded-xl shadow-sm p-4 cursor-pointer hover:scale-[1.01] transition relative overflow-hidden" onclick="openDetailModal(${idx})">
                             <div class="flex justify-between items-start">
                                 <div class="flex gap-3">
                                     <span class="text-2xl mt-1">${getItemIcon(it)}</span>
                                     <div>
                                         <h3 class="font-bold text-lg">${it.title}</h3>
                                         <div class="text-sm opacity-70 font-mono flex gap-2 items-center">
                                             <i class="far fa-clock"></i> ${it.startTime||'--:--'} ${it.endTime ? '- '+it.endTime : ''}
                                         </div>
                                     </div>
                                 </div>
                             </div>
                             ${it.summary ? `<p class="mt-2 text-sm opacity-90 line-clamp-2">${it.summary}</p>` : ''}
                             ${it.address?.label ? `<div class="mt-3 text-xs bg-black/5 inline-block px-2 py-1 rounded"><i class="fas fa-map-pin mr-1"></i>${it.address.label}</div>` : ''}
                        </div>
                        `;
                    }
                    wrapper.innerHTML += contentHtml;
                    container.appendChild(wrapper);
                });
            }
            
            updateSmartAccordion();
            renderMap(items);
        }

        function getItemIcon(it) {
            if(it.travel?.to?.label) return 'ğŸš—';
            if(it.type === 'food' || it.category === 'food') return 'ğŸ´';
            if(it.address?.label) return 'ğŸ“';
            return 'ğŸ“Œ';
        }

        function updateSmartAccordion() {
            if(!isSmartAccordionActive || !currentLayout.includes('accordion')) return;
            // Simple logic: open item matching current time
            const now = new Date();
            const min = now.getHours()*60 + now.getMinutes();
            currentScheduleItems.forEach((it, idx) => {
                if(!it.startTime) return;
                const [h,m] = it.startTime.split(':').map(Number);
                const startMin = h*60 + m;
                // Assume 1 hour duration if no end time for simplicity
                const endMin = it.endTime ? (it.endTime.split(':')[0]*60 + Number(it.endTime.split(':')[1])) : startMin + 60;
                
                const el = document.getElementById(`details-${idx}`);
                if(el && min >= startMin && min < endMin) {
                    el.open = true;
                    el.classList.add('ring-2', 'ring-blue-400');
                }
            });
        }

        // --- Modals Logic ---
        window.openDetailModal = (index) => {
            const it = currentScheduleItems[index];
            const modal = document.getElementById('item-detail-modal');
            document.getElementById('modal-title').textContent = it.title;
            document.getElementById('modal-subtitle').textContent = `${it.startTime || ''} - ${it.endTime || ''}`;
            
            const content = document.getElementById('item-detail-modal-content');
            content.innerHTML = `
                <div class="space-y-4">
                    ${it.summary ? `<div class="text-lg leading-relaxed">${it.summary}</div>` : ''}
                    ${it.description ? `<div class="p-3 bg-slate-50 rounded-xl text-sm whitespace-pre-wrap">${it.description}</div>` : ''}
                    
                    ${it.address?.label ? `
                    <div class="flex gap-2 flex-wrap">
                        <a href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button btn-waze"><i class="fab fa-waze"></i> Waze</a>
                        <a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button btn-google"><i class="fas fa-map"></i> Maps</a>
                    </div>
                    ` : ''}

                    ${it.links?.site ? `<a href="${it.links.site}" target="_blank" class="block w-full text-center py-2 bg-slate-100 rounded-lg font-bold text-slate-600 mt-2">××¢×‘×¨ ×œ××ª×¨</a>` : ''}
                    
                    ${(Array.isArray(it.refs) && it.refs.length) ? `
                    <div class="border-t pt-3 mt-3">
                        <p class="text-xs font-bold text-slate-400 uppercase mb-2">××§×•×©×¨ ×œ:</p>
                        <div class="flex flex-wrap gap-2">
                             ${it.refs.map(r => `<button onclick="openRefModal('${r.type}','${r.id}')" class="action-button btn-ref text-xs">${r.label}</button>`).join('')}
                        </div>
                    </div>` : ''}
                </div>
            `;
            
            modal.classList.add('visible');
            document.body.classList.add('modal-locked');
        };

        window.openRefModal = async (type, id) => {
            const modal = document.getElementById('ref-detail-modal');
            const content = document.getElementById('ref-detail-modal-content');
            content.innerHTML = '<div class="text-center py-10"><i class="fas fa-spinner fa-spin fa-2x text-slate-300"></i></div>';
            modal.classList.add('visible');

            // Fetch Data
            try {
                // Mapping generic types to collections
                const colMap = { place:'places', attraction:'places', restaurant:'places', logistic:'logistics', flight:'logistics', hotel:'logistics' };
                const col = colMap[type] || 'places'; // Default fallback
                const docSnap = await getDoc(doc(db, 'trips', tripId, col, id));
                
                if(docSnap.exists()) {
                    const data = docSnap.data();
                    content.innerHTML = `
                        <h3 class="text-2xl font-bold mb-2">${data.name || '×œ×œ× ×©×'}</h3>
                        <div class="space-y-3 text-sm">
                            ${data.description ? `<p>${data.description}</p>` : ''}
                            ${data.googleMapsLink ? `<a href="${data.googleMapsLink}" target="_blank" class="text-blue-600 underline">×”×¦×’ ×‘××¤×”</a>` : ''}
                        </div>
                    `;
                } else {
                    content.innerHTML = '<p class="text-center text-red-500">×”×¤×¨×™×˜ ×œ× × ××¦×.</p>';
                }
            } catch(e) {
                content.innerHTML = '<p class="text-center text-red-500">×©×’×™××” ×‘×˜×¢×™× ×ª ×¤×¨×˜×™×.</p>';
            }
        };

        // --- Render Map ---
        function renderMap(items) {
            const points = items.filter(i => i.address?.lat).map(i => i.address);
            if(points.length < 2) return;
            
            if(mapInstance) mapInstance.remove();
            document.getElementById('map-container-section').classList.remove('hidden');
            
            setTimeout(() => {
                mapInstance = L.map('route-map');
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(mapInstance);
                const markers = L.featureGroup(points.map((p,i) => L.marker([p.lat, p.lng]).bindPopup(`${i+1}. ${p.label}`))).addTo(mapInstance);
                mapInstance.fitBounds(markers.getBounds(), {padding: [50,50]});
                
                // Draw Line
                const latlngs = points.map(p => [p.lat, p.lng]);
                L.polyline(latlngs, {color: 'blue'}).addTo(mapInstance);
            }, 500);
        }

        function renderNotes(notes) {
            const cont = document.getElementById('notes-list');
            if(!notes.length) { 
                cont.innerHTML = '<p class="text-sm text-slate-400">××™×Ÿ ×“×’×©×™× ×œ×™×•× ×–×”.</p>'; 
                return; 
            }
            cont.innerHTML = notes.map(n => `
                <div class="bg-yellow-50 border-r-4 border-yellow-400 p-3 rounded text-sm">
                    <strong class="block text-slate-800">${n.title}</strong>
                    <span class="text-slate-600">${n.details||''}</span>
                </div>
            `).join('');
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            // Sidebar
            const toggleSidebar = () => {
                const isOpen = !sidebar.classList.contains('translate-x-full');
                sidebar.classList.toggle('translate-x-full', isOpen);
                overlay.classList.toggle('hidden', isOpen);
                setTimeout(() => overlay.classList.toggle('opacity-0', isOpen), 10);
                document.body.classList.toggle('modal-locked', !isOpen);
            };
            document.getElementById('hamburger-btn').onclick = toggleSidebar;
            document.getElementById('close-sidebar-btn').onclick = toggleSidebar;
            overlay.onclick = toggleSidebar;

            // Settings Modal
            const toggleSettings = () => {
                const modal = document.getElementById('settings-modal');
                const isOpen = !modal.classList.contains('-translate-x-full');
                modal.classList.toggle('-translate-x-full', isOpen);
                overlay.classList.toggle('hidden', isOpen);
                setTimeout(() => overlay.classList.toggle('opacity-0', isOpen), 10);
            };
            document.getElementById('settings-btn').onclick = toggleSettings;
            document.getElementById('close-settings-btn').onclick = toggleSettings;

            // Settings Tabs
            document.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.onclick = () => {
                    document.querySelectorAll('.settings-nav-btn').forEach(b => {
                        b.classList.remove('bg-white', 'shadow-sm', 'text-slate-800');
                        b.classList.add('text-slate-500');
                    });
                    btn.classList.add('bg-white', 'shadow-sm', 'text-slate-800');
                    btn.classList.remove('text-slate-500');
                    document.querySelectorAll('.settings-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(`settings-panel-${btn.dataset.panel}`).classList.remove('hidden');
                };
            });

            // Settings Actions
            document.getElementById('apply-bg-settings').onclick = async () => {
                const url = document.getElementById('bg-image-url-storage').value;
                const brightness = document.getElementById('bg-brightness-slider').value;
                const val = { type: url?'image':'color', value: url||'#f1f5f9', brightness };
                applyBackground(val);
                await saveUserSetting('background', val, document.getElementById('bg-scope').value);
                toggleSettings();
            };

            document.getElementById('apply-layout-settings').onclick = async () => {
                const layout = document.querySelector('input[name="timeline-layout"]:checked').value;
                const smart = document.getElementById('smart-accordion-toggle').checked;
                const val = { layout, smart };
                applyLayout(val);
                await saveUserSetting('layout', val, document.getElementById('layout-scope').value);
                toggleSettings();
            };

            // Build Theme Buttons
            const themeContainer = document.getElementById('theme-presets-container');
            themeContainer.innerHTML = Object.entries(themePresets).map(([k,v]) => `
                <button data-theme="${k}" class="theme-preset-btn p-3 rounded-xl border border-slate-200 text-center hover:bg-slate-50 transition ${v.style}">
                    <span class="font-bold text-sm block">${v.name}</span>
                </button>
            `).join('');
            
            document.querySelectorAll('.theme-preset-btn').forEach(btn => {
                btn.onclick = () => {
                    applyTheme({key: btn.dataset.theme});
                };
            });

            document.getElementById('apply-theme-settings').onclick = async () => {
                const selectedBtn = document.querySelector('.theme-preset-btn.selected-theme');
                if(selectedBtn) {
                    const val = { key: selectedBtn.dataset.theme };
                    await saveUserSetting('theme', val, document.getElementById('theme-scope').value);
                    toggleSettings();
                }
            };

            // BG Upload
            const bgInput = document.getElementById('bg-image-upload-input');
            document.getElementById('bg-image-upload-btn').onclick = () => bgInput.click();
            bgInput.onchange = async (e) => {
                const file = e.target.files[0];
                if(!file) return;
                const stat = document.getElementById('bg-image-status');
                stat.textContent = '××¢×œ×”...';
                const fd = new FormData(); fd.append('image', file);
                try {
                    const res = await fetch(IMAGE_WORKER_URL, {method:'POST', body:fd});
                    const data = await res.json();
                    if(data.data?.url) {
                        document.getElementById('bg-image-url-storage').value = data.data.url;
                        applyBackground({type:'image', value:data.data.url, brightness:50});
                        stat.textContent = '×”×•×¢×œ×” ×‘×”×¦×œ×—×”';
                    }
                } catch(e) { stat.textContent = '×©×’×™××” ×‘×”×¢×œ××”'; }
            };

            // Dropdown Toggle
            const dropTrigger = document.getElementById('date-select-trigger');
            dropTrigger.onclick = (e) => {
                e.stopPropagation();
                dateDropdown.classList.toggle('open');
                document.getElementById('date-chevron').classList.toggle('rotate-180');
            };
            window.onclick = () => {
                dateDropdown.classList.remove('open');
                document.getElementById('date-chevron').classList.remove('rotate-180');
            };

            // Modal Closes
            const closeDetail = () => {
                document.getElementById('item-detail-modal').classList.remove('visible');
                document.body.classList.remove('modal-locked');
            };
            document.getElementById('close-detail-modal-btn').onclick = closeDetail;
            document.getElementById('item-detail-modal').onclick = (e) => { if(e.target.id === 'item-detail-modal') closeDetail(); };
            
            document.getElementById('close-ref-modal-btn').onclick = () => document.getElementById('ref-detail-modal').classList.remove('visible');
        }

        // Init
        init();
    </script>
</body>
</html>

