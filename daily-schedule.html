<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>לוז יומי • מסע חלומות</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body { font-family: 'Assistant', sans-serif; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .leaf-badge { border-inline-start: 4px solid #38bdf8; }
    .timeline { position: relative; }
    .timeline.layout-4::before { content: ""; position: absolute; right: 20px; top: 0; bottom: 0; width: 2px; background: rgba(30,41,59,.15); }
    .timeline-item.layout-4 { position: relative; padding-right: 56px; }
    .timeline-dot { position: absolute; right: 12px; top: .75rem; width: 16px; height: 16px; border-radius: 9999px; background: white; box-shadow: 0 0 0 4px #e2e8f0 inset, 0 0 0 2px rgba(30,41,59,.1); }
    .bg-fixed-image { background-size: cover; background-position: center; background-attachment: fixed; }
    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity .5s ease-out; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }
    
    /* Modals */
    .modal-content { max-height: 80vh; }
    .modal-transition { transition: opacity 0.3s ease-out, transform 0.3s ease-out; }

    /* Map Styles */
    #route-map, #modal-item-map { height: 400px; border-radius: 1rem; background-color: #e2e8f0; }
    #modal-item-map { height: 250px; }
    
    /* Timeline Accordion */
    .timeline-accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; }
    .timeline-accordion-content.open { max-height: 1000px; padding-top: 1rem; padding-bottom: 1rem; }
    
    /* Fix for scrolling jump */
    html, body { height: 100%; }
    body { overflow-y: auto; }
  </style>
</head>
<body class="bg-slate-100">
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image transition-all duration-500" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');">
      <div id="bg-overlay" class="absolute inset-0 bg-black/50 transition-all duration-500"></div>
  </div>

  <div id="initial-loader">
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">טוען את הלוז...</p>
    </div>
  </div>

  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">תפריט המסע 🧭</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <button id="trip-home-btn" class="p-2 text-slate-600 hover:text-blue-600" title="חזרה לדף הטיול">
              <i class="fas fa-map-signs fa-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-slate-800">לוז יומי</h1>
          </div>
          <div class="flex items-center gap-2">
            <div id="auth-container" class="flex items-center"></div>
            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none" title="הגדרות עיצוב">
              <i class="fas fa-cog fa-lg"></i>
            </button>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">טוען פרטי תאריך...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <section class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 leaf-badge">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold text-slate-800">לוז ליום</h2>
              <p id="trip-subtitle" class="text-slate-500 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 text-slate-600">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
        </section>

        <section id="timeline-section" class="rounded-2xl">
          <div id="no-schedule" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-10 text-center">
            <i class="fa-regular fa-clock fa-3x text-slate-400 mb-4"></i>
            <h3 class="text-xl font-bold text-slate-700 mb-1">עדיין אין לוז ליום זה</h3>
            <p class="text-slate-500">לחץ “צור לוז” כדי להתחיל לתכנן את היום.</p>
          </div>
          <div id="timeline" class="timeline space-y-4"></div>
        </section>

        <section id="notes-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold text-slate-800 mb-3">דגשים וטיפים ליום זה</h3>
          <div id="notes-list" class="grid gap-3">
            <div class="text-slate-500">אין עדיין דגשים/טיפים.</div>
          </div>
        </section>

        <section id="map-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 hidden">
            <h3 class="text-lg font-bold text-slate-800 mb-4">מפת מסלול היום</h3>
            <div id="route-map-container">
                <div id="route-map"></div>
                <div id="map-legend" class="mt-4 space-y-2 text-sm"></div>
            </div>
            <div id="map-no-locations" class="text-center p-6 text-slate-500 hidden">
                <i class="fas fa-map-marker-slash fa-2x mb-2"></i>
                <p>לא נמצאו כתובות עם קואורדינטות בלו"ז כדי להציג את המפה.</p>
            </div>
        </section>

        <section id="cta-section" class="flex justify-center gap-3">
          <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            צור לוז
          </a>
           <a id="edit-schedule-btn" href="#" class="hidden items-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
              <i class="fa-solid fa-pen"></i> ערוך לוז
            </a>
        </section>

      </div>
    </main>
  </div>

  <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4">
      <div id="settings-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-transition opacity-0 transform -translate-y-4">
          <div class="p-4 flex justify-between items-center border-b">
              <h3 class="text-xl font-bold text-slate-800">הגדרות עיצוב</h3>
              <button data-close-modal="settings-modal" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
          </div>
          <div class="p-6 space-y-6 overflow-y-auto modal-content">
              <div class="p-4 border rounded-lg">
                  <h4 class="font-bold text-lg mb-3">🎨 עריכת רקע</h4>
                  <div class="space-y-4">
                      <div>
                          <label class="font-semibold text-slate-700 block mb-1">הדבק קישור לתמונת רקע (אופציונלי)</label>
                          <input type="url" id="bg-image-url" placeholder="https://example.com/image.jpg" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                      </div>
                      <div>
                          <label class="font-semibold text-slate-700 block mb-1">או בחר צבע רקע</label>
                          <input type="color" id="bg-color-picker" class="w-full h-10 p-1 border rounded-md">
                      </div>
                      <div>
                          <label for="bg-brightness-slider" class="font-semibold text-slate-700 block mb-1">בהירות הרקע (שכבה שחורה)</label>
                          <div class="flex items-center gap-2">
                              <span>0%</span>
                              <input type="range" id="bg-brightness-slider" min="0" max="90" value="50" class="w-full">
                              <span>90%</span>
                          </div>
                      </div>
                  </div>
              </div>
              <div class="p-4 border rounded-lg">
                  <h4 class="font-bold text-lg mb-3">📐 עריכת עיצוב הדף</h4>
                  <div class="grid grid-cols-2 gap-4">
                      <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="1" class="sr-only">
                          <span class="font-bold">כרטיסיות עם מודל</span>
                          <p class="text-sm text-slate-500">לחיצה פותחת חלון עם כל הפרטים.</p>
                      </label>
                       <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="2" class="sr-only">
                          <span class="font-bold">אקורדיון + מודל</span>
                          <p class="text-sm text-slate-500">הרחבה מהירה, ולחיצה נוספת למודל.</p>
                      </label>
                       <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="3" class="sr-only">
                          <span class="font-bold">אקורדיון מלא</span>
                          <p class="text-sm text-slate-500">כל הפרטים נפתחים מתחת לפריט.</p>
                      </label>
                       <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="4" class="sr-only">
                          <span class="font-bold">ציר זמן קלאסי</span>
                          <p class="text-sm text-slate-500">קו זמן אנכי עם כרטיסיות.</p>
                      </label>
                  </div>
              </div>
              <div class="p-4 border rounded-lg">
                  <h4 class="font-bold text-lg mb-3">✒️ עריכת כרטיסיות וטקסט</h4>
                   <div>
                      <label class="font-semibold text-slate-700 block mb-1">צבע רקע הכרטיסיות</label>
                      <input type="color" id="card-bg-color-picker" class="w-full h-10 p-1 border rounded-md">
                   </div>
                   <div class="mt-4">
                      <label class="font-semibold text-slate-700 block mb-1">צבע הטקסט</label>
                      <input type="color" id="card-text-color-picker" class="w-full h-10 p-1 border rounded-md">
                   </div>
                   <div class="mt-4">
                       <label class="font-semibold text-slate-700 block mb-1">עיצובים מוכנים</label>
                       <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                           <button data-preset="transparent" class="p-2 border rounded-lg text-white bg-black/50">שקוף</button>
                           <button data-preset="white" class="p-2 border rounded-lg text-black bg-white">קלאסי</button>
                           <button data-preset="dark" class="p-2 border rounded-lg text-white bg-slate-800">כהה</button>
                           <button data-preset="ocean" class="p-2 border rounded-lg text-white bg-blue-800">אוקיינוס</button>
                           <button data-preset="forest" class="p-2 border rounded-lg text-white bg-green-800">יער</button>
                           <button data-preset="sunset" class="p-2 border rounded-lg text-white bg-orange-700">שקיעה</button>
                           <button data-preset="sand" class="p-2 border rounded-lg text-yellow-900 bg-yellow-100">חול</button>
                           <button data-preset="sky" class="p-2 border rounded-lg text-sky-900 bg-sky-100">שמיים</button>
                       </div>
                   </div>
              </div>
          </div>
          <div class="p-4 bg-slate-50 border-t flex justify-end">
              <button id="save-settings-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">שמור הגדרות</button>
          </div>
      </div>
  </div>

  <div id="item-details-modal" data-close-modal="item-details-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4">
      <div id="item-details-modal-content" class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl modal-transition opacity-0 transform -translate-y-4">
          <div class="p-4 flex justify-between items-center border-b">
              <h3 id="modal-title" class="text-xl font-bold text-slate-800">פרטי הפריט</h3>
              <button data-close-modal="item-details-modal" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
          </div>
          <div class="p-6 space-y-4 overflow-y-auto modal-content">
              <p id="modal-time" class="text-slate-500 font-semibold"></p>
              <div id="modal-summary" class="text-slate-800 font-semibold text-lg"></div>
              <p id="modal-description" class="text-slate-700 whitespace-pre-wrap"></p>
              <div class="border-t pt-4 space-y-4">
                  <div id="modal-address-container">
                      <h4 class="font-bold mb-2">מיקום</h4>
                      <div id="modal-address" class="text-slate-600 mb-2"></div>
                      <div id="modal-item-map"></div>
                  </div>
                  <div id="modal-nav" class="flex gap-2 flex-wrap"></div>
                  <div id="modal-links" class="flex gap-4 flex-wrap text-sm"></div>
              </div>
          </div>
      </div>
  </div>


  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy, updateDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    // Leaflet JS for Map
    import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- State ----------
    let currentUser = null, tripId = null, tripData = null;
    let dateStr = null, dateISO = null, dayNameHe = "";
    let destForDate = null;
    let scheduleItems = [];
    let routeLeafletMap = null, itemLeafletMap = null;
    let currentSettings = {
        layout: '1',
        background: { type: 'default', value: 'https://i.imgur.com/MjekTyd.jpeg', brightness: 50 },
        cards: { bg: '#ffffff', text: '#1e293b' }
    };

    // ---------- UI Elements ----------
    const initialLoader = document.getElementById('initial-loader');
    const mainContent = document.getElementById('main-content');
    const pageBg = document.getElementById('page-bg');
    const bgOverlay = document.getElementById('bg-overlay');
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');
    const mainMenu = document.getElementById('main-menu');
    const authContainer = document.getElementById('auth-container');
    const tripHomeBtn = document.getElementById('trip-home-btn');
    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl = document.getElementById('day-title');
    const tripSubtitle = document.getElementById('trip-subtitle');
    const dateChip = document.getElementById('date-chip');
    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox = document.getElementById('timeline');
    const ctaSection = document.getElementById('cta-section');
    const createBtn = document.getElementById('create-schedule-btn');
    const editBtn = document.getElementById('edit-schedule-btn');
    const notesList = document.getElementById('notes-list');
    const mapSection = document.getElementById('map-section');
    const routeMapContainer = document.getElementById('route-map-container');
    const mapNoLocations = document.getElementById('map-no-locations');
    const mapLegend = document.getElementById('map-legend');
    
    // Settings Modal UI
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const bgImageUrlInput = document.getElementById('bg-image-url');
    const bgColorPicker = document.getElementById('bg-color-picker');
    const bgBrightnessSlider = document.getElementById('bg-brightness-slider');
    const cardBgColorPicker = document.getElementById('card-bg-color-picker');
    const cardTextColorPicker = document.getElementById('card-text-color-picker');
    const presetButtons = document.querySelectorAll('[data-preset]');

    // Item Details Modal UI
    const itemDetailsModal = document.getElementById('item-details-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalTime = document.getElementById('modal-time');
    const modalSummary = document.getElementById('modal-summary');
    const modalDescription = document.getElementById('modal-description');
    const modalAddressContainer = document.getElementById('modal-address-container');
    const modalAddress = document.getElementById('modal-address');
    const modalNav = document.getElementById('modal-nav');
    const modalLinks = document.getElementById('modal-links');


    // ---------- Helpers & Utils ----------
    const parseLocalDateFlexible = s => {
      if (!s) return null;
      const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/);
      if (!m) return null;
      let d = +m[1], mo = +m[2], y = +m[3];
      if (y < 100) y += 2000;
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    };
    const toISODateUTC = d => `${d.getUTCFullYear()}-${String(d.getUTCMonth()+1).padStart(2,'0')}-${String(d.getUTCDate()).padStart(2,'0')}`;
    const hebWeekdayUTC = d => ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'][d.getUTCDay()];

    function toggleSidebar() { sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }

    function openModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const content = modal.querySelector('.modal-transition');
        modal.classList.remove('hidden');
        setTimeout(() => {
            content.classList.remove('opacity-0', '-translate-y-4');
            content.classList.add('opacity-100', 'translate-y-0');
        }, 10);
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if (!modal) return;
        const content = modal.querySelector('.modal-transition');
        content.classList.add('opacity-0', '-translate-y-4');
        content.classList.remove('opacity-100', 'translate-y-0');
        setTimeout(() => modal.classList.add('hidden'), 300);
    }
    
    // ---------- Settings & Theming ----------
    function applySettings(settings) {
        if (settings.background.type === 'image') {
            pageBg.style.backgroundImage = `url('${settings.background.value}')`;
        } else {
            pageBg.style.backgroundImage = 'none';
            pageBg.style.backgroundColor = settings.background.value;
        }
        bgOverlay.style.backgroundColor = `rgba(0, 0, 0, ${settings.background.brightness / 100})`;
        currentSettings.layout = settings.layout || '1';
        currentSettings.cards = settings.cards || { bg: '#ffffff', text: '#1e293b' };
        renderTimelineFromItems(scheduleItems);
    }

    function loadAndApplySettings() {
        if (tripData.designSettings) {
            currentSettings = { ...currentSettings, ...tripData.designSettings };
        }
        applySettings(currentSettings);
        
        const bg = currentSettings.background;
        bgImageUrlInput.value = bg.type === 'image' ? bg.value : '';
        bgColorPicker.value = bg.type === 'color' ? bg.value : '#f1f5f9';
        bgBrightnessSlider.value = bg.brightness;
        document.querySelector(`input[name="layout-style"][value="${currentSettings.layout}"]`).checked = true;
        cardBgColorPicker.value = currentSettings.cards.bg;
        cardTextColorPicker.value = currentSettings.cards.text;
    }

    async function saveSettings() {
        const newSettings = {
            layout: document.querySelector('input[name="layout-style"]:checked').value,
            background: {
                type: bgImageUrlInput.value ? 'image' : 'color',
                value: bgImageUrlInput.value || bgColorPicker.value,
                brightness: bgBrightnessSlider.value
            },
            cards: { bg: cardBgColorPicker.value, text: cardTextColorPicker.value }
        };
        try {
            await updateDoc(doc(db, 'trips', tripId), { designSettings: newSettings });
            alert('ההגדרות נשמרו!');
            currentSettings = newSettings;
            applySettings(currentSettings);
            closeModal('settings-modal');
        } catch (error) { console.error("Error saving settings: ", error); alert('שגיאה בשמירת הגדרות.'); }
    }
    
    // ---------- Rendering ----------
    const timeText = it => [it.startTime || '', it.endTime ? `– ${it.endTime}` : ''].filter(Boolean).join(' ') || '--:--';

    function renderTimelineFromItems(items){
      scheduleItems = items;
      if (!items || items.length === 0) {
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        ctaSection.classList.remove('hidden');
        createBtn.classList.remove('hidden');
        editBtn.classList.add('hidden');
        mapSection.classList.add('hidden');
        return;
      }
      
      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      timelineBox.innerHTML = items.map((it, index) => createTimelineItemHtml(it, index, currentSettings.layout)).join('');
      timelineBox.className = `timeline space-y-4 layout-${currentSettings.layout}`;

      ctaSection.classList.remove('hidden');
      createBtn.classList.add('hidden');
      editBtn.classList.remove('hidden');
      editBtn.classList.add('inline-flex');
      
      if (currentSettings.layout === '2' || currentSettings.layout === '3') {
          timelineBox.querySelectorAll('.timeline-accordion-header').forEach(header => {
              header.addEventListener('click', () => header.nextElementSibling.classList.toggle('open'));
          });
      }
      renderRouteMap(items);
    }
    
    function createTimelineItemHtml(it, index, layout) {
        const cardStyle = `background-color: ${currentSettings.cards.bg}; color: ${currentSettings.cards.text};`;
        const navHtml = it.address?.label ? `
          <div class="flex gap-2 flex-wrap">
            <a class="px-2 py-1 rounded text-white text-xs" style="background-color: #00853f;" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}"><i class="fa-solid fa-location-dot"></i> Google Maps</a>
            <a class="px-2 py-1 rounded text-white text-xs" style="background-color: #33ccff;" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}"><i class="fa-brands fa-waze"></i> Waze</a>
          </div>` : '';
        const linksHtml = [
          it.links?.site ? `<a class="inline-flex items-center gap-1 hover:underline text-xs" style="color: #38bdf8;" href="${it.links.site}" target="_blank"><i class="fa-solid fa-link"></i> אתר</a>` : '',
          it.links?.booking ? `<a class="inline-flex items-center gap-1 hover:underline text-xs" style="color: #14b8a6;" href="${it.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> הזמנה</a>` : ''
        ].filter(Boolean).join(' ');

        const fullDetailsHtml = `
            ${it.description ? `<p class="mt-2 whitespace-pre-wrap">${it.description}</p>` : ''}
            ${it.address?.label ? `<div class="mt-2 text-sm"><i class="fa-solid fa-location-dot mr-1 opacity-70"></i>${it.address.label}</div>` : ''}
            <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 items-center">${linksHtml}</div>
            ${navHtml ? `<div class="mt-3">${navHtml}</div>` : ''}
        `;
        
        const clickableProps = (isClickable) => isClickable ? `data-item-index="${index}" class="cursor-pointer"` : '';

        switch(layout) {
            case '2': // Accordion + Modal
                return `<div class="bg-white/90 rounded-xl shadow p-4 timeline-accordion-header cursor-pointer" style="${cardStyle}">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold">${it.title || 'פריט ללא שם'}</h4>
                        <span class="text-sm font-bold shrink-0">${timeText(it)}</span>
                    </div>
                </div>
                <div class="timeline-accordion-content px-4">
                    ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
                    ${fullDetailsHtml}
                    <button ${clickableProps(true)} class="mt-4 text-sm font-bold text-blue-600 hover:underline">הצג פרטים מלאים במודל</button>
                </div>`;
            case '3': // Full Accordion
                return `<div class="bg-white/90 rounded-xl shadow p-4 timeline-accordion-header cursor-pointer" style="${cardStyle}">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold">${it.title || 'פריט ללא שם'}</h4>
                        <span class="text-sm font-bold shrink-0">${timeText(it)}</span>
                    </div>
                </div>
                <div class="timeline-accordion-content px-4">
                    ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
                    ${fullDetailsHtml}
                </div>`;
            case '4': // Classic Timeline
                 return `<div class="timeline-item layout-4">
                    <div ${clickableProps(true)} class="bg-white/90 rounded-xl shadow p-4 hover:shadow-lg transition-shadow" style="${cardStyle}">
                      <span class="timeline-dot"></span>
                      <div class="flex items-start gap-4">
                        <div class="shrink-0 text-center"><div class="text-sm font-bold">${timeText(it)}</div></div>
                        <div class="flex-1">
                          <h4 class="text-lg font-bold">${it.title || 'פריט ללא שם'}</h4>
                          ${it.summary ? `<div class="mt-1 text-sm">${it.summary}</div>` : ''}
                           <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 items-center">${linksHtml}</div>
                        </div>
                      </div>
                    </div></div>`;
            case '1': default: // Cards with Modal
                return `<div ${clickableProps(true)} class="bg-white/90 rounded-xl shadow p-4 hover:shadow-lg transition-shadow" style="${cardStyle}">
                     <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold">${it.title || 'פריט ללא שם'}</h4>
                            <p class="text-sm opacity-80 mt-1">${it.summary || 'אין פירוט קצר'}</p>
                        </div>
                        <div class="shrink-0 text-right"><div class="font-bold">${timeText(it)}</div></div>
                     </div>
                     <div class="mt-3 pt-3 border-t border-black/10 flex justify-between items-center">
                        ${navHtml}
                        <div class="flex gap-4">${linksHtml}</div>
                     </div>
                </div>`;
        }
    }

    function openItemDetailsModal(item) {
        modalTitle.textContent = item.title || 'פרטי הפריט';
        modalTime.textContent = timeText(item);
        modalSummary.innerHTML = item.summary || '';
        modalDescription.innerHTML = item.description || '';
        
        if(item.address?.label) {
            modalAddressContainer.classList.remove('hidden');
            modalAddress.textContent = item.address.label;
            modalNav.innerHTML = `<a class="px-2 py-1 rounded text-white text-xs" style="background-color: #00853f;" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address.label)}"><i class="fa-solid fa-location-dot"></i> Google Maps</a>
                                  <a class="px-2 py-1 rounded text-white text-xs" style="background-color: #33ccff;" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(item.address.label)}"><i class="fa-brands fa-waze"></i> Waze</a>`;
        } else {
            modalAddressContainer.classList.add('hidden');
            modalNav.innerHTML = '';
        }

        modalLinks.innerHTML = [
            item.links?.site ? `<a class="inline-flex items-center gap-1 hover:underline text-blue-600" href="${item.links.site}" target="_blank"><i class="fa-solid fa-link"></i> אתר אינטרנט</a>` : '',
            item.links?.booking ? `<a class="inline-flex items-center gap-1 hover:underline text-teal-600" href="${item.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> קישור להזמנה</a>` : ''
        ].filter(Boolean).join('');
        
        openModal('item-details-modal');

        // Render map inside modal
        if (itemLeafletMap) itemLeafletMap.remove();
        if (item.address?.lat && item.address?.lon) {
            document.getElementById('modal-item-map').classList.remove('hidden');
            itemLeafletMap = L.map('modal-item-map').setView([item.address.lat, item.address.lon], 15);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(itemLeafletMap);
            L.marker([item.address.lat, item.address.lon]).addTo(itemLeafletMap);
            setTimeout(() => itemLeafletMap.invalidateSize(), 200); // IMPORTANT: Fix map rendering in modal
        } else {
            document.getElementById('modal-item-map').classList.add('hidden');
        }
    }

    function renderRouteMap(items) {
        const locations = items.map(item => item.address).filter(addr => addr && addr.lat && addr.lon);
        if (locations.length < 1) {
            mapSection.classList.add('hidden');
            return;
        }
        mapSection.classList.remove('hidden');
        routeMapContainer.classList.remove('hidden');
        mapNoLocations.classList.add('hidden');

        if (routeLeafletMap) routeLeafletMap.remove();
        routeLeafletMap = L.map('route-map').setView([locations[0].lat, locations[0].lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeLeafletMap);

        const latLngs = [], routeColors = ['#3b82f6', '#ef4444', '#16a34a', '#f97316', '#8b5cf6', '#eab308'];
        mapLegend.innerHTML = '';

        locations.forEach((loc, index) => {
            L.marker([loc.lat, loc.lon]).addTo(routeLeafletMap).bindPopup(`<b>${loc.label}</b>`);
            latLngs.push([loc.lat, loc.lon]);

            if (index > 0) {
                const prevLoc = locations[index - 1];
                const color = routeColors[(index - 1) % routeColors.length];
                L.polyline([[prevLoc.lat, prevLoc.lon], [loc.lat, loc.lon]], { color }).addTo(routeLeafletMap);
                mapLegend.innerHTML += `<div class="flex items-center gap-2">
                    <div class="w-4 h-1" style="background-color: ${color};"></div>
                    <span>${prevLoc.label} <i class="fas fa-arrow-left fa-xs"></i> ${loc.label}</span></div>`;
            }
        });
        if (latLngs.length > 0) routeLeafletMap.fitBounds(latLngs, { padding: [50, 50] });
    }
    
    // ... (renderNotesList and other functions are the same as before) ...
    function renderNotesList(notes){ if(!notes||notes.length===0){notesList.innerHTML=`<div class="text-slate-500">אין עדיין דגשים/טיפים.</div>`;return}notesList.innerHTML=notes.map(n=>{const c={red:{b:"bg-red-50",bo:"border-red-300",t:"text-red-800"},green:{b:"bg-green-50",bo:"border-green-300",t:"text-green-800"},blue:{b:"bg-blue-50",bo:"border-blue-300",t:"text-blue-800"},yellow:{b:"bg-yellow-50",bo:"border-yellow-300",t:"text-yellow-800"},orange:{b:"bg-orange-50",bo:"border-orange-300",t:"text-orange-800"}},m=c[n.color]||c.yellow;return`<div class="border rounded-xl p-3 ${m.b} ${m.bo} ${m.t}"><div class="font-bold">${n.kind}: ${n.title||"—"}</div>${n.details?`<div class="mt-1 text-sm whitespace-pre-wrap">${n.details}</div>`:""}</div>`}).join("")}

    // ---------- Event Listeners ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);
      tripHomeBtn.addEventListener('click', () => window.location.href = `trip.html?tripId=${tripId}`);
      
      settingsBtn.addEventListener('click', () => openModal('settings-modal'));
      saveSettingsBtn.addEventListener('click', saveSettings);
      
      document.querySelectorAll('[data-close-modal]').forEach(btn => {
          btn.addEventListener('click', () => closeModal(btn.dataset.closeModal));
      });

      timelineBox.addEventListener('click', (e) => {
          const clickableItem = e.target.closest('[data-item-index]');
          if (clickableItem) {
              const index = parseInt(clickableItem.dataset.itemIndex, 10);
              if (!isNaN(index) && scheduleItems[index]) {
                  openItemDetailsModal(scheduleItems[index]);
              }
          }
      });
      
      presetButtons.forEach(btn => btn.addEventListener('click', () => {
        const presets = {transparent:{bg:"rgba(255,255,255,0.1)",text:"#ffffff"},white:{bg:"#ffffff",text:"#1e293b"},dark:{bg:"#1e293b",text:"#f1f5f9"},ocean:{bg:"#1e40af",text:"#dbeafe"},forest:{bg:"#14532d",text:"#dcfce7"},sunset:{bg:"#b45309",text:"#fef3c7"},sand:{bg:"#fef3c7",text:"#7c2d12"},sky:{bg:"#e0f2fe",text:"#0c4a6e"}};
        const p = presets[btn.dataset.preset];
        if (p) {
          cardBgColorPicker.value = p.bg.startsWith('rgba') ? '#ffffff' : p.bg; // Fallback for color input
          cardTextColorPicker.value = p.text;
        }
      }));
    }

    // ---------- Init ----------
    async function initPage() {
      const urlParams = new URLSearchParams(window.location.search);
      tripId = urlParams.get('tripId');
      dateStr = decodeURIComponent(urlParams.get('date') || '').trim();
      const parsedDate = parseLocalDateFlexible(dateStr);
      if (parsedDate) { dateISO = toISODateUTC(parsedDate); dayNameHe = hebWeekdayUTC(parsedDate); }

      if (!tripId || !dateStr) { location.href = 'index.html'; return; }
      attachEvents();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">שלום, ${displayName} 👋</span><button id="sign-out-btn" title="התנתק" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);
        if (!tripSnap.exists()) { alert('הטיול לא נמצא.'); location.href = 'index.html'; return; }
        tripData = tripSnap.data();

        destForDate = (tripData.destinations || []).find(d => (generateDatesFromRange(d.dates) || []).map(dt => toISODateUTC(dt)).includes(dateISO));
        
        // Build menu, load settings etc... same as before
        const generateDatesFromRange=r=>{if(!r||!r.includes(" - "))return[];const[s,e]=r.split(" - "),t=parseLocalDateFlexible(s),a=parseLocalDateFlexible(e);if(!t||!a)return[];const o=[];for(let n=new Date(t);n<=a;n.setUTCDate(n.getUTCDate()+1))o.push(new Date(n.getTime()));return o};
        const buildMenuFromTrip=()=>{mainMenu.innerHTML="",tripData?.destinations?.forEach(d=>{const e=document.createElement("div"),t=document.createElement("button");t.className="w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center",t.innerHTML=`<span>${d.nameHe||d.name}</span> <i class="fas fa-chevron-down"></i>`;const n=document.createElement("div");n.className="submenu mt-1 mr-2 border-r-2 border-slate-200",generateDatesFromRange(d.dates).forEach(s=>{const a=`${s.getUTCDate()}/${s.getUTCMonth()+1}/${s.getUTCFullYear()}`,i=document.createElement("a");i.href=`?tripId=${tripId}&date=${encodeURIComponent(a)}`,i.className="block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md",i.textContent=`לו"ז ליום ${a}`,n.appendChild(i)}),t.addEventListener("click",()=>{n.classList.toggle("open"),t.querySelector("i").classList.toggle("rotate-180")}),e.append(t,n),mainMenu.appendChild(e)})};
        const renderHeadline=(d=null)=>{const e=destForDate?.nameHe||destForDate?.name||"היעד",t=dayNameHe?` יום ${dayNameHe}`:"";scheduleHeadline.textContent=`הלוז של ${e} לתאריך ${dateStr}${t}`,dayTitleEl.textContent=d?`${d} • ${dateStr}`:`לוז ליום ${dateStr}`,tripSubtitle.textContent=`${e}${t?" •"+t:""}`,dateChip.textContent=dateStr};
        
        buildMenuFromTrip();
        loadAndApplySettings();

        const destNameParam = encodeURIComponent(destForDate?.nameHe || '');
        const editHref = `create-schedule.html?tripId=${tripId}&date=${dateStr}&dest=${destNameParam}`;
        editBtn.href = createBtn.href = editHref;

        if (dateISO){
          const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
          const schedSnap = await getDoc(schedDocRef);
          renderHeadline(schedSnap.exists() ? (schedSnap.data().title || null) : null);
          
          const itemsQuery = query(collection(db, 'trips', tripId, 'schedules', dateISO, 'items'), orderBy('sort','asc'));
          onSnapshot(itemsQuery, snap => {
              const items = snap.docs.map(d => ({id:d.id, ...d.data()}));
              // MOCK lat/lon for demo
              items.forEach(item => { if (item.address && !item.address.lat) { if (item.title.includes("ירושלים")) { item.address.lat=31.771959; item.address.lon=35.217018; } if (item.title.includes("תל אביב")) { item.address.lat=32.085300; item.address.lon=34.781769; } if (item.title.includes("נתניה")) { item.address.lat=32.321450; item.address.lon=34.853191; } }});
              renderTimelineFromItems(items);
          });

          const notesQuery = query(collection(db, 'trips', tripId, 'schedules', dateISO, 'notes'), orderBy('createdAt','asc'));
          onSnapshot(notesQuery, snap => renderNotesList(snap.docs.map(d => d.data())));
        } else {
          renderHeadline(); renderTimelineFromItems([]); renderNotesList([]);
        }

        initialLoader.style.opacity = '0';
        mainContent.style.opacity = '1';
        setTimeout(()=> initialLoader.style.display='none', 500);
      });
    }

    initPage();
  </script>
</body>
</html>
