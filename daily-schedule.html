<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
Â  Â  <meta charset="UTF-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  Â  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
Â  Â Â 
Â  Â  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
Â  Â Â 
Â  Â  <style>
Â  Â  Â  Â  :root {
Â  Â  Â  Â  Â  Â  --card-bg: rgba(255, 255, 255, 0.85);
Â  Â  Â  Â  Â  Â  --card-text-color: #1e293b; /* slate-800 */
Â  Â  Â  Â  Â  Â  --card-secondary-text-color: #475569; /* slate-600 */
Â  Â  Â  Â  Â  Â  --card-border-color: rgba(203, 213, 225, 0.5); /* slate-300 with opacity */
Â  Â  Â  Â  }

Â  Â  Â  Â  body {Â 
Â  Â  Â  Â  Â  Â  font-family: 'Assistant', sans-serif;Â 
Â  Â  Â  Â  Â  Â  background-color: #f1f5f9; /* slate-100 */
Â  Â  Â  Â  }
Â  Â  Â  Â  #sidebar, #settings-modal {Â 
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-in-out;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #main-content {
Â  Â  Â  Â  Â  Â  transition: opacity 0.5s, filter 0.3s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu {Â 
Â  Â  Â  Â  Â  Â  max-height: 0;Â 
Â  Â  Â  Â  Â  Â  overflow: hidden;Â 
Â  Â  Â  Â  Â  Â  transition: max-height 0.5s ease-in-out;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .submenu.open {Â 
Â  Â  Â  Â  Â  Â  max-height: 1200px;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Themed Card Style */
Â  Â  Â  Â  .themed-card {
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  color: var(--card-text-color);
Â  Â  Â  Â  Â  Â  border: 1px solid var(--card-border-color);
Â  Â  Â  Â  Â  Â  backdrop-filter: blur(10px);
Â  Â  Â  Â  Â  Â  -webkit-backdrop-filter: blur(10px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .themed-card h1, .themed-card h2, .themed-card h3, .themed-card h4 {
Â  Â  Â  Â  Â  Â  Â color: var(--card-text-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .themed-card p, .themed-card span, .themed-card div:not([class*="override"]), .themed-card a:not([class*="override"]) {
Â  Â  Â  Â  Â  Â  color: var(--card-secondary-text-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .themed-card h2, .themed-card .font-extrabold, .themed-card .font-bold {
Â  Â  Â  Â  Â  Â  color: var(--card-text-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .themed-card .text-slate-700 { color: var(--card-text-color); }
Â  Â  Â  Â  .themed-card .text-slate-800 { color: var(--card-text-color); }
Â  Â  Â  Â  .themed-card .text-slate-500 { color: var(--card-secondary-text-color); }
Â  Â  Â  Â  .themed-card .text-slate-600 { color: var(--card-secondary-text-color); }

Â  Â  Â  Â  /* Timeline Styles */
Â  Â  Â  Â  .timeline { position: relative; }
Â  Â  Â  Â  .timeline.layout-line-style::before,Â 
Â  Â  Â  Â  .timeline.layout-line-style-accordion-full::before,Â 
Â  Â  Â  Â  .timeline.layout-line-style-accordion-summary::before {Â 
Â  Â  Â  Â  Â  Â  content: "";Â 
Â  Â  Â  Â  Â  Â  position: absolute;Â 
Â  Â  Â  Â  Â  Â  right: 2.5rem;
Â  Â  Â  Â  Â  Â  top: 0;Â 
Â  Â  Â  Â  Â  Â  bottom: 0;Â 
Â  Â  Â  Â  Â  Â  width: 2px;Â 
Â  Â  Â  Â  Â  Â  background: rgba(30,41,59,.15);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline-item-wrapper {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-line-style .timeline-item-wrapper,Â 
Â  Â  Â  Â  .timeline.layout-line-style-accordion-full .timeline-item-wrapper,
Â  Â  Â  Â  .timeline.layout-line-style-accordion-summary .timeline-item-wrapper {
Â  Â  Â  Â  Â  Â  padding-right: 6rem; /* Make space for the time */
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline-time-outside {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  top: 1rem;
Â  Â  Â  Â  Â  Â  background: var(--card-bg);
Â  Â  Â  Â  Â  Â  padding: 0.25rem 0.5rem;
Â  Â  Â  Â  Â  Â  border-radius: 9999px;
Â  Â  Â  Â  Â  Â  font-size: 0.75rem;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  border: 1px solid var(--card-border-color);
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  z-index: 10;
Â  Â  Â  Â  Â  Â  width: 5rem;
Â  Â  Â  Â  Â  Â  text-align: center;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Table Layout */
Â  Â  Â  Â  .timeline.layout-table .themed-card {
Â  Â  Â  Â  Â  Â  overflow: hidden;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-table table {
Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  border-collapse: collapse;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-table th, .timeline.layout-table td {
Â  Â  Â  Â  Â  Â  padding: 0.75rem 1rem;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid var(--card-border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-table th {
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  background-color: rgba(0,0,0,0.05);
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-table tr:last-child td {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-table td:nth-child(1) { width: 15%; font-weight: 600; }
Â  Â  Â  Â  .timeline.layout-table td:nth-child(2) { width: 60%; }
Â  Â  Â  Â  .timeline.layout-table td:nth-child(3) { width: 25%; text-align: left; }

Â  Â  Â  Â  /* Condensed List Layout */
Â  Â  Â  Â  .timeline.layout-condensed-list .timeline-item-wrapper {
Â  Â  Â  Â  Â  Â  Â display: flex;
Â  Â  Â  Â  Â  Â  Â gap: 1rem;
Â  Â  Â  Â  Â  Â  Â padding: 0.75rem;
Â  Â  Â  Â  Â  Â  Â border-bottom: 1px solid var(--card-border-color);
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-condensed-list .timeline-item-wrapper:last-child {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-condensed-list .time-block {
Â  Â  Â  Â  Â  Â  flex-shrink: 0;
Â  Â  Â  Â  Â  Â  font-weight: 600;
Â  Â  Â  Â  Â  Â  width: 5rem;
Â  Â  Â  Â  Â  Â  text-align: right;
Â  Â  Â  Â  }
Â  Â  Â  Â  .timeline.layout-condensed-list .details-block {
Â  Â  Â  Â  Â  Â  flex-grow: 1;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Smart Accordion Highlight */
Â  Â  Â  Â  .smart-accordion-active {
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px #10b981; /* Green ring */
Â  Â  Â  Â  Â  Â  border-color: #10b981 !important;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Fix for scroll jitter */
Â  Â  Â  Â  .bg-fixed-image, header {
Â  Â  Â  Â  Â  Â  transform: translateZ(0);
Â  Â  Â  Â  }
Â  Â  Â  Â  .bg-fixed-image {Â 
Â  Â  Â  Â  Â  Â  background-size: cover;Â 
Â  Â  Â  Â  Â  Â  background-position: center;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  #initial-loader {Â 
Â  Â  Â  Â  Â  Â  position: fixed;Â 
Â  Â  Â  Â  Â  Â  inset: 0;Â 
Â  Â  Â  Â  Â  Â  z-index: 100;Â 
Â  Â  Â  Â  Â  Â  display: flex;Â 
Â  Â  Â  Â  Â  Â  align-items: center;Â 
Â  Â  Â  Â  Â  Â  justify-content: center;Â 
Â  Â  Â  Â  Â  Â  transition: opacity .5s ease-out;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes spin {Â 
Â  Â  Â  Â  Â  Â  from { transform: rotate(0); }Â 
Â  Â  Â  Â  Â  Â  to { transform: rotate(360deg); }Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .plane-spinner {Â 
Â  Â  Â  Â  Â  Â  animation: spin 2s linear infinite;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Map Styles */
Â  Â  Â  Â  #route-map, .accordion-map-container, #modal-map, #ref-modal-map {
Â  Â  Â  Â  Â  Â  height: 450px;
Â  Â  Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
Â  Â  Â  Â  Â  Â  background-color: #e2e8f0; /* Placeholder background */
Â  Â  Â  Â  }
Â  Â  Â  Â  #modal-map, .accordion-map-container, #ref-modal-map {
Â  Â  Â  Â  Â  Â  height: 250px; /* Smaller map for modals and accordions */
Â  Â  Â  Â  }
Â  Â  Â  Â  .leaflet-container {
Â  Â  Â  Â  Â  Â  Â font-family: 'Assistant', sans-serif;
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Accordion styles */
Â  Â  Â  Â  details > summary {Â 
Â  Â  Â  Â  Â  Â  list-style: none; /* Remove default marker */
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  }
Â  Â  Â  Â  details > summary::-webkit-details-marker {Â 
Â  Â  Â  Â  Â  Â  display: none; /* Remove default marker for Chrome */
Â  Â  Â  Â  }
Â  Â  Â  Â  .chevron-icon {Â 
Â  Â  Â  Â  Â  Â  transition: transform 0.3s ease-out;Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  details[open] > summary .chevron-icon {Â 
Â  Â  Â  Â  Â  Â  transform: rotate(180deg);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Custom modal for item details */
Â  Â  Â  Â  .item-detail-modal, #ref-detail-modal {
Â  Â  Â  Â  Â  Â  position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 100;
Â  Â  Â  Â  Â  Â  display: flex; align-items: center; justify-content: center;
Â  Â  Â  Â  Â  Â  opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .item-detail-modal.visible, #ref-detail-modal.visible { opacity: 1; visibility: visible; }
Â  Â  Â  Â Â 
Â  Â  Â  Â  .item-detail-modal-content, #ref-detail-modal-content {
Â  Â  Â  Â  Â  Â  background: var(--card-bg); color: var(--card-text-color);
Â  Â  Â  Â  Â  Â  padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 600px;
Â  Â  Â  Â  Â  Â  max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .item-detail-modal.visible .item-detail-modal-content, #ref-detail-modal.visible #ref-detail-modal-content { transform: scale(1); }

Â  Â  Â  Â  /* Selected Theme Button */
Â  Â  Â  Â  .theme-preset-btn.selected-theme {
Â  Â  Â  Â  Â  Â  box-shadow: 0 0 0 3px #3b82f6; /* Ring effect */
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /* Action buttons in cards */
Â  Â  Â  Â  .action-button {
Â  Â  Â  Â  Â  Â  display: inline-flex; align-items: center; gap: 0.5rem;
Â  Â  Â  Â  Â  Â  padding: 0.4rem 0.9rem; border-radius: 9999px;
Â  Â  Â  Â  Â  Â  font-size: 0.8rem; font-weight: 700; color: white;
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease-out; text-decoration: none;
Â  Â  Â  Â  Â  Â  box-shadow: 0 1px 3px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
Â  Â  Â  Â  Â  Â  border: none;
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-button:hover {Â 
Â  Â  Â  Â  Â  Â  opacity: 0.9;Â 
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
Â  Â  Â  Â  Â  Â  transform: translateY(-1px);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  .action-button.gmaps { background-color: #34A853; } /* Google Green */
Â  Â  Â  Â  .action-button.waze { background-color: #33CCFF; color: #1e293b; } /* Waze Blue with dark text */
Â  Â  Â  Â  .action-button.site { background-color: #4285F4; } /* Google Blue */
Â  Â  Â  Â  .action-button.booking { background-color: #003580; } /* Booking.com Blue */
Â  Â  Â  Â  .action-button.ref { background-color: #6366f1; } /* Indigo-500 */
Â  Â  Â  Â  .action-button.details { background-color: #64748b; } /* Slate-500 */

Â  Â  Â  Â  /* Force black text for notes */
Â  Â  Â  Â  .force-black-text { color: #1e293b !important; }
Â  Â  Â  Â  .force-black-text-secondary { color: #334155 !important; }

Â  Â  Â  Â  /* Smart Accordion Toggle Switch */
Â  Â  Â  Â  .toggle-switch {
Â  Â  Â  Â  Â  Â  position: relative;
Â  Â  Â  Â  Â  Â  display: inline-block;
Â  Â  Â  Â  Â  Â  width: 50px;
Â  Â  Â  Â  Â  Â  height: 28px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .toggle-switch input {
Â  Â  Â  Â  Â  Â  opacity: 0;
Â  Â  Â  Â  Â  Â  width: 0;
Â  Â  Â  Â  Â  Â  height: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .toggle-slider {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  top: 0;
Â  Â  Â  Â  Â  Â  left: 0;
Â  Â  Â  Â  Â  Â  right: 0;
Â  Â  Â  Â  Â  Â  bottom: 0;
Â  Â  Â  Â  Â  Â  background-color: #ccc;
Â  Â  Â  Â  Â  Â  transition: .4s;
Â  Â  Â  Â  Â  Â  border-radius: 28px;
Â  Â  Â  Â  }
Â  Â  Â  Â  .toggle-slider:before {
Â  Â  Â  Â  Â  Â  position: absolute;
Â  Â  Â  Â  Â  Â  content: "";
Â  Â  Â  Â  Â  Â  height: 20px;
Â  Â  Â  Â  Â  Â  width: 20px;
Â  Â  Â  Â  Â  Â  left: 4px;
Â  Â  Â  Â  Â  Â  bottom: 4px;
Â  Â  Â  Â  Â  Â  background-color: white;
Â  Â  Â  Â  Â  Â  transition: .4s;
Â  Â  Â  Â  Â  Â  border-radius: 50%;
Â  Â  Â  Â  }
Â  Â  Â  Â  input:checked + .toggle-slider {
Â  Â  Â  Â  Â  Â  background-color: #25a25a;
Â  Â  Â  Â  }
Â  Â  Â  Â  input:checked + .toggle-slider:before {
Â  Â  Â  Â  Â  Â  transform: translateX(22px);
Â  Â  Â  Â  }
Â  Â  Â  Â  .status-text.ok { color: #10b981; }
Â  Â  Â  Â  .status-text.err { color: #ef4444; }
Â  Â  </style>
</head>
<body class="bg-slate-100">
Â  Â  <div id="initial-loader">
Â  Â  Â  Â  <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd_d.webp?maxwidth=760&fidelity=grand');"></div>
Â  Â  Â  Â  <div class="fixed inset-0 z-0 bg-black/50"></div>
Â  Â  Â  Â  <div class="text-white text-center relative z-10">
Â  Â  Â  Â  Â  Â  <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
Â  Â  Â  Â  Â  Â  <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd_d.webp?maxwidth=760&fidelity=grand');"></div>
Â  Â  <div id="page-bg-overlay" class="fixed inset-0 z-0 bg-black/50"></div>

Â  Â  <aside id="sidebar" class="fixed top-0 right-0 h-full w-full max-w-sm sm:max-w-md bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
Â  Â  Â  Â  <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
Â  Â  Â  Â  Â  Â  <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <nav id="main-menu" class="p-4 space-y-2"></nav>
Â  Â  </aside>
Â  Â Â 
Â  Â  <aside id="settings-modal" class="fixed top-0 right-0 h-full w-full max-w-sm sm:w-96 bg-white shadow-2xl z-[80] transform translate-x-full">
Â  Â  Â  Â  <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold text-slate-800">×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ğŸ¨</h2>
Â  Â  Â  Â  Â  Â  <button id="close-settings-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-4.5rem)]">
Â  Â  Â  Â  Â  Â  <div class="grid grid-cols-3 gap-2 border border-slate-200 rounded-lg p-1">
Â  Â  Â  Â  Â  Â  Â  Â  <button data-panel="bg" class="settings-nav-btn bg-slate-200 p-2 rounded-md text-sm font-bold">×¨×§×¢</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-panel="layout" class="settings-nav-btn p-2 rounded-md text-sm font-bold text-slate-500">×¤×¨×™×¡×”</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button data-panel="theme" class="settings-nav-btn p-2 rounded-md text-sm font-bold text-slate-500">×¢×¨×›×ª × ×•×©×</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="settings-panel-bg" class="settings-panel space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-700">×ª××•× ×ª ×¨×§×¢</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3 mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="bg-image-upload-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition whitespace-nowrap">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-upload mr-1"></i> ×”×¢×œ×” ×ª××•× ×”
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="bg-image-remove-btn" class="hidden bg-red-600/80 hover:bg-red-700/80 text-white font-bold py-2 px-3 rounded-lg transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-times"></i> ×”×¡×¨
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="file" id="bg-image-upload-input" class="hidden" accept="image/*">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="hidden" id="bg-image-url-storage">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="bg-image-status" class="text-sm mt-2 text-slate-400 h-5"></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-700">××• ×‘×—×¨ ×¦×‘×¢ ×¨×§×¢</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="bg-color-picker" type="color" value="#f1f5f9" class="w-full h-10 mt-1 border-none cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="bg-brightness-slider" class="font-bold text-slate-700">×‘×”×™×¨×•×ª ×¨×§×¢</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="bg-brightness-slider" type="range" min="0" max="100" value="50" class="w-full mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pt-4 border-t">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-700">×”×—×œ ×”×’×“×¨×•×ª ×¢×œ:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="bg-scope" class="w-full mt-1 p-2 border rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×–×” (×‘×¨×™×¨×ª ××—×“×œ)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ ×”×–×”</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="trip">×›×œ ×”×œ×•"×–×™× ×©×œ ×”×˜×™×•×œ</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="apply-bg-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="settings-panel-layout" class="settings-panel space-y-4 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="font-bold text-slate-700">×¡×’× ×•×Ÿ ×ª×¦×•×’×ª ×”×œ×•"×–:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="space-y-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="default">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">×›×¨×˜×™×¡×™×•×ª (×‘×¨×™×¨×ª ××—×“×œ)</span><p class="text-sm text-slate-500">×›×¨×˜×™×¡×™×” ×¢× ×¤×¨×˜×™× ×¢×™×§×¨×™×™×. ×œ×—×™×¦×” ×¤×•×ª×—×ª ×—×œ×•×Ÿ ×¢× ×›×œ ×”××™×“×¢.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="accordion-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">××§×•×¨×“×™×•×Ÿ ×—×œ×§×™</span><p class="text-sm text-slate-500">×›×¨×˜×™×¡×™×” ×¢× ×›×•×ª×¨×ª ×•×©×¢×”. ×œ×—×™×¦×” ××¨×—×™×‘×” ×œ×¤×™×¨×•×˜.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="accordion-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">××§×•×¨×“×™×•×Ÿ ××œ×</span><p class="text-sm text-slate-500">×›×¨×˜×™×¡×™×” ×¢× ×›×•×ª×¨×ª ×•×©×¢×”. ×œ×—×™×¦×” ××¨×—×™×‘×” ×•×—×•×©×¤×ª ××ª ×›×œ ×”×¤×¨×˜×™×.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="line-style">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">×¦×™×¨ ×–××Ÿ</span><p class="text-sm text-slate-500">×§×• ×× ×›×™ ×¢× ×›×¨×˜×™×¡×™×•×ª ×‘×¦×“. ×œ×—×™×¦×” ×¤×•×ª×—×ª ×—×œ×•×Ÿ ×¢× ×›×œ ×”××™×“×¢.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="line-style-accordion-summary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">×¦×™×¨ ×–××Ÿ ××§×•×¨×“×™×•×Ÿ ×—×œ×§×™</span><p class="text-sm text-slate-500">×©×™×œ×•×‘ ×©×œ ×¦×™×¨ ×–××Ÿ ×¢× ××§×•×¨×“×™×•×Ÿ × ×¤×ª×— ×œ×ª×§×¦×™×¨.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="line-style-accordion-full">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">×¦×™×¨ ×–××Ÿ ××§×•×¨×“×™×•×Ÿ ××œ×</span><p class="text-sm text-slate-500">×©×™×œ×•×‘ ×©×œ ×¦×™×¨ ×–××Ÿ ×¢× ××§×•×¨×“×™×•×Ÿ × ×¤×ª×— ×œ×›×œ ×”×¤×¨×˜×™×.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="table">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">×˜×‘×œ×”</span><p class="text-sm text-slate-500">××¦×™×’ ××ª ×¤×¨×™×˜×™ ×”×™×•× ×‘×˜×‘×œ×” ××¡×•×“×¨×ª ×•×§×•××¤×§×˜×™×ª.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="radio" name="timeline-layout" value="condensed-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div><span class="font-bold">×¨×©×™××” ×“×—×•×¡×”</span><p class="text-sm text-slate-500">×¨×©×™××” ×¤×©×•×˜×” ×•× ×§×™×™×”, ××ª××™××” ×œ×”×“×¤×¡×”.</p></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="smart-accordion-controls" class="pt-4 border-t space-y-3 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="smart-accordion-toggle" class="font-bold text-slate-700">××¦×‘ ××§×•×¨×“×™×•×Ÿ ×—×›×</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="toggle-switch">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="checkbox" id="smart-accordion-toggle">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="toggle-slider"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-slate-500">××¤×¢×™×œ ×¤×ª×™×—×” ××•×˜×•××˜×™×ª ×©×œ ×”×¤×¨×™×˜ ×”× ×•×›×—×™ ×œ×¤×™ ×”×©×¢×”.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="pt-4 border-t">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-700">×”×—×œ ×”×’×“×¨×•×ª ×¢×œ:</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="layout-scope" class="w-full mt-1 p-2 border rounded-md">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="trip">×›×œ ×”×œ×•"×–×™× ×©×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×–×”</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ ×”×–×”</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="apply-layout-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <div id="settings-panel-theme" class="settings-panel space-y-4 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="custom-theme-controls" class="space-y-4 p-4 border rounded-lg bg-slate-50 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-slate-700">×”×ª×××” ××™×©×™×ª</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-700 text-sm">×¦×‘×¢ ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="card-bg-color-picker" type="color" value="#ffffff" class="w-full h-8 mt-1 border-none cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="card-opacity-slider" class="font-bold text-slate-700 text-sm">×©×§×™×¤×•×ª ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="card-opacity-slider" type="range" min="0" max="100" value="85" class="w-full mt-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label class="font-bold text-slate-700 text-sm">×¦×‘×¢ ×˜×§×¡×˜</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="card-text-color-picker" type="color" value="#1e293b" class="w-full h-8 mt-1 border-none cursor-pointer">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="pt-4 border-t">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p class="font-bold text-slate-700">×‘×—×¨ ×¢×¨×›×ª × ×•×©× ××•×›× ×”:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div id="theme-presets-container" class="grid grid-cols-2 gap-2 mt-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="apply-theme-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </aside>

Â  Â  <div id="overlay" class="fixed inset-0 bg-black/40 cursor-pointer z-50 hidden"></div>

Â  Â  <div id="main-content" class="relative z-10 opacity-0">
Â  Â  Â  Â  <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
Â  Â  Â  Â  Â  Â  <div class="container mx-auto px-4 sm:px-6 lg:px-8">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between h-16">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a id="trip-home-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-map-signs fa-lg"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="auth-container" class="flex items-center"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none" title="×”×’×“×¨×•×ª ×¢×™×¦×•×‘">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fas fa-cog fa-lg"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <div class="bg-white/70 backdrop-blur-md border-b">
Â  Â  Â  Â  Â  Â  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
Â  Â  Â  Â  Â  Â  Â  Â  <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <main class="p-4 sm:p-6 lg:p-8">
Â  Â  Â  Â  Â  Â  <div class="max-w-5xl mx-auto space-y-8">

Â  Â  Â  Â  Â  Â  Â  Â  <section id="title-card" class="themed-card rounded-2xl shadow-lg p-5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold">×œ×•×– ×œ×™×•×</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="trip-subtitle" class="mt-1"></p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-regular fa-calendar"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span id="date-chip" class="font-semibold">--/--/----</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  Â  Â  <section id="timeline-section">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="no-schedule" class="themed-card text-center p-10 rounded-2xl shadow-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-regular fa-clock fa-3x mb-4"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="timeline" class="timeline space-y-4 hidden"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  Â  Â  <section id="notes-section" class="themed-card rounded-2xl shadow-lg p-5">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="notes-list" class="grid gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  <section id="map-container-section" class="themed-card rounded-2xl shadow-lg p-5 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-lg font-bold mb-3">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="route-map"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="map-legend" class="mt-4 space-y-2 text-sm"></div>
Â  Â  Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  Â  Â  <section class="flex justify-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-wand-magic-sparkles"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ×¦×•×¨ ×œ×•×–
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a id="edit-schedule-btn" href="#" class="hidden items-center gap-2 bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <i class="fa-solid fa-pen"></i>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ×¢×¨×•×š ×œ×•×–
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </a>
Â  Â  Â  Â  Â  Â  Â  Â  </section>

Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </main>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="item-detail-modal" class="item-detail-modal">
Â  Â  Â  Â  <div id="item-detail-modal-content" class="item-detail-modal-content">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â Â 
Â  Â  <div id="ref-detail-modal" class="item-detail-modal">
Â  Â  Â  Â  <div id="ref-detail-modal-content" class="item-detail-modal-content">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>


Â  Â  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
Â  Â  <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
Â  Â  <script type="module">
Â  Â  Â  Â  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
Â  Â  Â  Â  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
Â  Â  Â  Â  import {
Â  Â  getFirestore, doc, getDoc, collection, onSnapshot, query, updateDoc, setDoc,
Â  Â  enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

Â  Â  Â  Â  // ---------- Firebase & Constants ----------
Â  Â  Â  Â  const firebaseConfig = {
Â  Â  Â  Â  Â  Â  apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
Â  Â  Â  Â  Â  Â  authDomain: "tiool-loz.firebaseapp.com",
Â  Â  Â  Â  Â  Â  projectId: "tiool-loz",
Â  Â  Â  Â  Â  Â  storageBucket: "tiool-loz.appspot.com",
Â  Â  Â  Â  Â  Â  messagingSenderId: "226069823505",
Â  Â  Â  Â  Â  Â  appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
Â  Â  Â  Â  };
Â  Â  Â  Â  const app = initializeApp(firebaseConfig);
Â  Â  Â  Â  const auth = getAuth(app);
Â  Â  Â  Â  const db = getFirestore(app);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- ×”×•×¡×¤×ª ×™×›×•×œ×•×ª ××•×¤×œ×™×™×Ÿ ---
enableIndexedDbPersistence(db).catch((err) => {
Â  if (err.code === 'failed-precondition') {
Â  Â  console.warn("Persistence × ×›×©×œ â€“ ×™×© ×™×•×ª×¨ ××“×™ ×˜××‘×™× ×¤×ª×•×—×™×.");
Â  } else if (err.code === 'unimplemented') {
Â  Â  console.warn("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘Ö¾Persistence.");
Â  }
});
Â  Â  Â  Â Â 
Â  Â  Â  Â  const IMAGE_WORKER_URL = "https://yellow-cloud-3f13.doronenakache.workers.dev/";

Â  Â  Â  Â  // ---------- State ----------
Â  Â  Â  Â  let currentUser = null;
Â  Â  Â  Â  let tripId = null;
Â  Â  Â  Â  let tripData = null;
Â  Â  Â  Â  let dateStr = null;
Â  Â  Â  Â  let dateISO = null;
Â  Â  Â  Â  let dayNameHe = "";
Â  Â  Â  Â  let destForDate = null;
Â  Â  Â  Â  let currentScheduleItems = [];
Â  Â  Â  Â  let mapInstance = null;
Â  Â  Â  Â  let modalMapInstance = null;
Â  Â  Â  Â  let refModalMapInstance = null;
Â  Â  Â  Â  let currentLayout = 'default';
Â  Â  Â  Â  let currentThemeKey = 'light';
Â  Â  Â  Â  let currentCustomTheme = {};
Â  Â  Â  Â  let isSmartAccordionActive = false;
Â  Â  Â  Â  const accordionMaps = {};
Â  Â  Â  Â  let smartAccordionInterval = null;
Â  Â  Â  Â  let currentRouteLayer = null;

Â  Â  Â  Â  // ---------- UI Elements ----------
Â  Â  Â  Â  const initialLoader = document.getElementById('initial-loader');
Â  Â  Â  Â  const mainContent = document.getElementById('main-content');
Â  Â  Â  Â  const pageBg = document.getElementById('page-bg');
Â  Â  Â  Â  const pageBgOverlay = document.getElementById('page-bg-overlay');
Â  Â  Â  Â  const loaderBg = document.getElementById('loader-bg');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const sidebar = document.getElementById('sidebar');
Â  Â  Â  Â  const hamburgerBtn = document.getElementById('hamburger-btn');
Â  Â  Â  Â  const closeSidebarBtn = document.getElementById('close-sidebar-btn');
Â  Â  Â  Â  const overlay = document.getElementById('overlay');
Â  Â  Â  Â  const mainMenu = document.getElementById('main-menu');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const settingsModal = document.getElementById('settings-modal');
Â  Â  Â  Â  const settingsBtn = document.getElementById('settings-btn');
Â  Â  Â  Â  const closeSettingsBtn = document.getElementById('close-settings-btn');
Â  Â  Â  Â  const customThemeControls = document.getElementById('custom-theme-controls');
Â  Â  Â  Â  const smartAccordionControls = document.getElementById('smart-accordion-controls');
Â  Â  Â  Â  const smartAccordionToggle = document.getElementById('smart-accordion-toggle');

Â  Â  Â  Â  // BG Image uploader elements
Â  Â  Â  Â  const bgImageUploadBtn = document.getElementById('bg-image-upload-btn');
Â  Â  Â  Â  const bgImageRemoveBtn = document.getElementById('bg-image-remove-btn');
Â  Â  Â  Â  const bgImageUploadInput = document.getElementById('bg-image-upload-input');
Â  Â  Â  Â  const bgImageUrlStorage = document.getElementById('bg-image-url-storage');
Â  Â  Â  Â  const bgImageStatus = document.getElementById('bg-image-status');
Â  Â  Â  Â  const bgColorPicker = document.getElementById('bg-color-picker');

Â  Â  Â  Â  const authContainer = document.getElementById('auth-container');
Â  Â  Â  Â  const tripHomeBtn = document.getElementById('trip-home-btn');
Â  Â  Â  Â  const scheduleHeadline = document.getElementById('schedule-headline');
Â  Â  Â  Â  const dayTitleEl = document.getElementById('day-title');
Â  Â  Â  Â  const tripSubtitle = document.getElementById('trip-subtitle');
Â  Â  Â  Â  const dateChip = document.getElementById('date-chip');

Â  Â  Â  Â  const noScheduleBox = document.getElementById('no-schedule');
Â  Â  Â  Â  const timelineBox = document.getElementById('timeline');
Â  Â  Â  Â  const createBtn = document.getElementById('create-schedule-btn');
Â  Â  Â  Â  const editBtn = document.getElementById('edit-schedule-btn');
Â  Â  Â  Â Â 
Â  Â  Â  Â  const notesList = document.getElementById('notes-list');
Â  Â  Â  Â  const mapContainerSection = document.getElementById('map-container-section');
Â  Â  Â  Â  const mapLegend = document.getElementById('map-legend');

Â  Â  Â  Â  const itemDetailModal = document.getElementById('item-detail-modal');
Â  Â  Â  Â  const itemDetailModalContent = document.getElementById('item-detail-modal-content');
Â  Â  Â  Â  const refDetailModal = document.getElementById('ref-detail-modal');
Â  Â  Â  Â  const refDetailModalContent = document.getElementById('ref-detail-modal-content');

Â  Â  Â  Â  // ---------- Helpers ----------
Â  Â  Â  Â  function toggleSidebar() {Â 
Â  Â  Â  Â  Â  Â  sidebar.classList.toggle('translate-x-full');Â 
Â  Â  Â  Â  Â  Â  overlay.classList.toggle('hidden');Â 
Â  Â  Â  Â  Â  Â  settingsModal.classList.add('translate-x-full');
Â  Â  Â  Â  }
Â  Â  Â  Â  function toggleSettings() {Â 
Â  Â  Â  Â  Â  Â  settingsModal.classList.toggle('translate-x-full');Â 
Â  Â  Â  Â  Â  Â  overlay.classList.toggle('hidden');Â 
Â  Â  Â  Â  Â  Â  sidebar.classList.add('translate-x-full');
Â  Â  Â  Â  Â  Â  configureBgSettingsUI();
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function parseLocalDateFlexible(s) { if (!s) return null; const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/); if (!m) return null; let d = +m[1], mo = +m[2], y = +m[3]; if (y < 100) y += 2000; const dt = new Date(Date.UTC(y, mo-1, d)); return isNaN(dt.getTime()) ? null : dt; }
Â  Â  Â  Â  function toISODateUTC(d) { const yyyy = d.getUTCFullYear(); const mm = String(d.getUTCMonth()+1).padStart(2,'0'); const dd = String(d.getUTCDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
Â  Â  Â  Â  function hebWeekdayUTC(d) { const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª']; return names[d.getUTCDay()]; }
Â  Â  Â  Â  function generateDatesFromRange(rangeStr) { if (!rangeStr || !rangeStr.includes(' - ')) return []; const [startStr, endStr] = rangeStr.split(' - '); const start = parseLocalDateFlexible(startStr); const end = parseLocalDateFlexible(endStr); if (!start || !end) return []; const out = []; for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) { out.push(new Date(t.getTime())); } return out; }
Â  Â  Â  Â  function findDestinationForDate(trip, rawDDMMYYYY) { const target = parseLocalDateFlexible(rawDDMMYYYY); if (!target) return null; const targetISO = toISODateUTC(target); return (trip.destinations || []).find(dest => { const days = generateDatesFromRange(dest.dates); const isoList = days.map(d => toISODateUTC(d)); return isoList.includes(targetISO); }) || null; }
Â  Â  Â  Â  function hexToRgb(hex) {
Â  Â  Â  Â  Â  Â  let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
Â  Â  Â  Â  Â  Â  return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
Â  Â  Â  Â  }
Â  Â  Â  Â  function calculateDistance(lat1, lon1, lat2, lon2) {
Â  Â  Â  Â  Â  Â  const R = 6371; // Radius of the earth in km
Â  Â  Â  Â  Â  Â  const dLat = (lat2 - lat1) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  const dLon = (lon2 - lon1) * Math.PI / 180;
Â  Â  Â  Â  Â  Â  const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
Â  Â  Â  Â  Â  Â  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
Â  Â  Â  Â  Â  Â  return R * c; // Distance in km
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------- Styling & Layout Functions ----------
Â  Â  Â  Â  function setBackground(bg) {Â 
Â  Â  Â  Â  Â  Â  if (bg.type === 'image') {Â 
Â  Â  Â  Â  Â  Â  Â  Â  pageBg.style.backgroundImage = `url('${bg.value}')`;Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.body.style.backgroundColor = '';Â 
Â  Â  Â  Â  Â  Â  } else {Â 
Â  Â  Â  Â  Â  Â  Â  Â  pageBg.style.backgroundImage = 'none';Â 
Â  Â  Â  Â  Â  Â  Â  Â  document.body.style.backgroundColor = bg.value;Â 
Â  Â  Â  Â  Â  Â  }Â 
Â  Â  Â  Â  Â  Â  const overlayOpacity = 1 - (bg.brightness / 100);Â 
Â  Â  Â  Â  Â  Â  pageBgOverlay.style.backgroundColor = `rgba(0, 0, 0, ${overlayOpacity})`;Â 
Â  Â  Â  Â  }

Â  Â  Â  Â  function setTheme(themeKey, customThemeData = null) {Â 
Â  Â  Â  Â  Â  Â  const theme = themePresets[themeKey];Â 
Â  Â  Â  Â  Â  Â  if(!theme) return;Â 
Â  Â  Â  Â  Â  Â  currentThemeKey = themeKey;Â 

Â  Â  Â  Â  Â  Â  let finalTheme = theme;
Â  Â  Â  Â  Â  Â  if (themeKey === 'custom' && customThemeData) {
Â  Â  Â  Â  Â  Â  Â  Â  finalTheme = { ...theme, ...customThemeData };
Â  Â  Â  Â  Â  Â  } else if (themeKey === 'custom') {
Â  Â  Â  Â  Â  Â  Â  Â  Â finalTheme = { ...theme, ...currentCustomTheme };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--card-bg', finalTheme.cardBg);Â 
Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--card-text-color', finalTheme.cardText);Â 
Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--card-secondary-text-color', finalTheme.cardSecondaryText);Â 
Â  Â  Â  Â  Â  Â  document.documentElement.style.setProperty('--card-border-color', finalTheme.cardBorder);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.theme-preset-btn').forEach(btn => btn.classList.remove('selected-theme'));Â 
Â  Â  Â  Â  Â  Â  const selectedBtn = document.querySelector(`.theme-preset-btn[data-theme="${themeKey}"]`);
Â  Â  Â  Â  Â  Â  if (selectedBtn) selectedBtn.classList.add('selected-theme');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  customThemeControls.classList.toggle('hidden', themeKey !== 'custom');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderTimelineFromItems(currentScheduleItems);Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  setTimeout(() => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (mapInstance) mapInstance.invalidateSize();Â 
Â  Â  Â  Â  Â  Â  Â  Â  if(modalMapInstance) modalMapInstance.invalidateSize();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Object.values(accordionMaps).forEach(m => m.invalidateSize());Â 
Â  Â  Â  Â  Â  Â  }, 300);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â  function setCurrentLayout(layout, smartAccordion = false) {Â 
Â  Â  Â  Â  Â  Â  currentLayout = layout;Â 
Â  Â  Â  Â  Â  Â  isSmartAccordionActive = smartAccordion;

Â  Â  Â  Â  Â  Â  const showSmartControls = layout.includes('accordion');
Â  Â  Â  Â  Â  Â  smartAccordionControls.classList.toggle('hidden', !showSmartControls);
Â  Â  Â  Â  Â  Â  if (showSmartControls) {
Â  Â  Â  Â  Â  Â  Â  Â  smartAccordionToggle.checked = isSmartAccordionActive;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  isSmartAccordionActive = false;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (smartAccordionInterval) {
Â  Â  Â  Â  Â  Â  Â  Â  clearInterval(smartAccordionInterval);
Â  Â  Â  Â  Â  Â  Â  Â  smartAccordionInterval = null;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (isSmartAccordionActive) {
Â  Â  Â  Â  Â  Â  Â  Â  updateSmartAccordionState();
Â  Â  Â  Â  Â  Â  Â  Â  smartAccordionInterval = setInterval(updateSmartAccordionState, 30000);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  timelineBox.className = `timeline`; // Reset classes
Â  Â  Â  Â  Â  Â  if (!['table', 'condensed-list'].includes(layout)) {
Â  Â  Â  Â  Â  Â  Â  Â  timelineBox.classList.add('space-y-4');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  timelineBox.classList.add(`layout-${layout}`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const radio = document.querySelector(`input[name="timeline-layout"][value="${layout}"]`);
Â  Â  Â  Â  Â  Â  if(radio) radio.checked = true;Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  renderTimelineFromItems(currentScheduleItems);Â 
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // ---------- Image Upload Logic ----------
Â  Â  Â  Â  async function handleImageUpload(file, urlStorageElement, statusElement, onCompleteCallback) {
Â  Â  Â  Â  Â  Â  if (!file) return;

Â  Â  Â  Â  Â  Â  statusElement.textContent = '';
Â  Â  Â  Â  Â  Â  statusElement.className = 'status-text text-sm mt-2 text-slate-400 h-5';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (!file.type.startsWith('image/')) {
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = '×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×” ×‘×œ×‘×“.';
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.classList.add('err');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  if (file.size > 5 * 1024 * 1024) { // 5MB limit
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = '×”×§×•×‘×¥ ×’×“×•×œ ××“×™ (×¢×“ 5MB).';
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.classList.add('err');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  statusElement.textContent = '××¢×œ×” ×ª××•× ×”...';
Â  Â  Â  Â  Â  Â  const formData = new FormData();
Â  Â  Â  Â  Â  Â  formData.append('image', file);

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(IMAGE_WORKER_URL, { method: 'POST', body: formData });
Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok || !result.data?.url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error(result.error?.message || '×©×’×™××” ×œ× ×™×“×•×¢×” ××”×©×¨×ª');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const imageUrl = result.data.url;
Â  Â  Â  Â  Â  Â  Â  Â  urlStorageElement.value = imageUrl;
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = '×”×”×¢×œ××” ×”×•×©×œ××”!';
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.classList.add('ok');

Â  Â  Â  Â  Â  Â  Â  Â  if (onCompleteCallback) onCompleteCallback(imageUrl);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { statusElement.textContent = ''; statusElement.className = 'status-text text-sm mt-2 text-slate-400 h-5'; }, 3000);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Image upload failed:', error);
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.textContent = `×©×’×™××”: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  statusElement.classList.add('err');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function configureBgSettingsUI() {
Â  Â  Â  Â  Â  Â  const hasBgImage = !!bgImageUrlStorage.value;
Â  Â  Â  Â  Â  Â  bgImageUploadBtn.innerHTML = hasBgImageÂ 
Â  Â  Â  Â  Â  Â  Â  Â  ? '<i class="fas fa-sync-alt mr-1"></i> ×©× ×” ×ª××•× ×”'Â 
Â  Â  Â  Â  Â  Â  Â  Â  : '<i class="fas fa-upload mr-1"></i> ×”×¢×œ×” ×ª××•× ×”';
Â  Â  Â  Â  Â  Â  bgImageRemoveBtn.classList.toggle('hidden', !hasBgImage);
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------- Rendering Functions ----------
Â  Â  Â  Â  function buildMenuFromTrip() {
Â  Â  Â  Â  Â  Â  mainMenu.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (!tripData?.destinations) return;
Â  Â  Â  Â  Â  Â  tripData.destinations.forEach(dest => {
Â  Â  Â  Â  Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
Â  Â  Â  Â  Â  Â  Â  Â  btn.innerHTML = `<span>${dest.nameHe || dest.name} ${dest.emoji || ''}</span> <i class="fas fa-chevron-down transition-transform"></i>`;
Â  Â  Â  Â  Â  Â  Â  Â  const submenu = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
Â  Â  Â  Â  Â  Â  Â  Â  const dates = generateDatesFromRange(dest.dates);
Â  Â  Â  Â  Â  Â  Â  Â  dates.forEach(dObj => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const day = hebWeekdayUTC(dObj);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const date = `${dObj.getUTCDate()}.${dObj.getUTCMonth()+1}.${dObj.getUTCFullYear()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const a = document.createElement('a');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // BUG FIX: Add destination ID to the URL to differentiate between destinations on the same date.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.href = `?tripId=${tripId}&date=${encodeURIComponent(nice)}&destId=${dest.id}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  a.textContent = `${day} ${date} (${dest.nameHe} ${dest.emoji || ''})`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  submenu.appendChild(a);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => { submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); });
Â  Â  Â  Â  Â  Â  Â  Â  div.append(btn, submenu);
Â  Â  Â  Â  Â  Â  Â  Â  mainMenu.appendChild(div);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderHeadline(dayTitleFromDoc = null) {
Â  Â  Â  Â  Â  Â  const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
Â  Â  Â  Â  Â  Â  const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
Â  Â  Â  Â  Â  Â  scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
Â  Â  Â  Â  Â  Â  dayTitleEl.textContent = dayTitleFromDoc ? `${dayTitleFromDoc} â€¢ ${dateStr}` : `×œ×•×– ×œ×™×•× ${dateStr}`;
Â  Â  Â  Â  Â  Â  tripSubtitle.textContent = `${destName}${dayPart ? ' â€¢' + dayPart : ''}`;
Â  Â  Â  Â  Â  Â  dateChip.textContent = dateStr;
Â  Â  Â  Â  }

Â  Â  Â  Â  function itemEmoji(it) {Â 
Â  Â  Â  Â  Â  Â  if (it.travel?.from?.label || it.travel?.to?.label) return 'ğŸ—ºï¸';
Â  Â  Â  Â  Â  Â  if (it.address?.label) return 'ğŸ“';
Â  Â  Â  Â  Â  Â  return 'ğŸš¶â€â™‚ï¸';
Â  Â  Â  Â  }
Â  Â  Â  Â  function timeText(it) { if (!it?.startTime && !it?.endTime) return '--:--'; return [it.startTime || '', it.endTime ? 'â€“ '+it.endTime : ''].filter(Boolean).join(' '); }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function getFullItemDetailsHTML(it, index) {
Â  Â  Â  Â  Â  Â  const hasAddr = !!it.address?.label;
Â  Â  Â  Â  Â  Â  const hasTravel = !!(it.travel?.from?.lat && it.travel?.from?.lng && it.travel?.to?.lat && it.travel?.to?.lng);
Â  Â  Â  Â  Â  Â  const hasSite = !!it.links?.site;
Â  Â  Â  Â  Â  Â  const hasBook = !!it.links?.booking;
Â  Â  Â  Â  Â  Â  const refs = Array.isArray(it.refs)? it.refs : [];

Â  Â  Â  Â  Â  Â  const refsHtml = refs.map(r=>{Â 
Â  Â  Â  Â  Â  Â  Â  Â  const icon = r.type==='logistics' ? (r.subType==='hotel'?'ğŸ¨':r.subType==='flight'?'âœˆï¸':r.subType==='train'?'ğŸš†':r.subType==='car_rental'?'ğŸš—':r.subType==='ferry'?'â›´ï¸':'â¬…ï¸') : 'ğŸ“';Â 
Â  Â  Â  Â  Â  Â  Â  Â  return `<button class="action-button ref open-ref-modal-btn" data-ref-type="${r.type}" data-ref-id="${r.id}">${icon} ${r.label}</button>`;Â 
Â  Â  Â  Â  Â  Â  }).join(' ');

Â  Â  Â  Â  Â  Â  const linksHtml = [Â 
Â  Â  Â  Â  Â  Â  Â  Â  hasSite ? `<a href="${it.links.site}" target="_blank" class="action-button site"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',Â 
Â  Â  Â  Â  Â  Â  Â  Â  hasBook ? `<a href="${it.links.booking}" target="_blank" class="action-button booking"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',Â 
Â  Â  Â  Â  Â  Â  Â  Â  refsHtmlÂ 
Â  Â  Â  Â  Â  Â  ].filter(Boolean).join(' ');

Â  Â  Â  Â  Â  Â  const navHtml = hasAddr ? `<div class="flex gap-2"><a href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button waze"><i class="fa-brands fa-waze"></i> Waze</a><a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a></div>` : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let travelHtml = '';
Â  Â  Â  Â  Â  Â  if (it.travel?.from?.label || it.travel?.to?.label) {
Â  Â  Â  Â  Â  Â  Â  Â  let airDistanceHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  if(hasTravel) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dist = calculateDistance(it.travel.from.lat, it.travel.from.lng, it.travel.to.lat, it.travel.to.lng);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  airDistanceHtml = ` â€¢ ××¨×—×§ ××•×•×™×¨×™: ${dist.toFixed(1)} ×§"×`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  travelHtml = `<div class="mt-2 text-sm" style="color: var(--card-secondary-text-color)"><i class="fa-solid fa-route text-slate-400"></i> ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''} ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''} ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}${airDistanceHtml}</div>`;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const mapHtml = (currentLayout.includes('accordion-full') && (hasAddr || hasTravel)) ? `<div id="accordion-map-${index}" class="accordion-map-container h-64 w-full mt-4 rounded-lg z-0 border"></div>` : '';

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  ${it.description ? `<p class="mt-2 whitespace-pre-wrap">${it.description}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  ${hasAddr ? `<div class="mt-2 text-sm"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  ${travelHtml}
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-3 flex flex-wrap gap-2">${linksHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-2">${navHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  ${mapHtml}
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderTimelineFromItems(items) {
Â  Â  Â  Â  Â  Â  Object.values(accordionMaps).forEach(map => {
Â  Â  Â  Â  Â  Â  Â  Â  if (map) map.remove();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  for (const key in accordionMaps) {
Â  Â  Â  Â  Â  Â  Â  Â  delete accordionMaps[key];
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  currentScheduleItems = items;
Â  Â  Â  Â  Â  Â  if (!items || items.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  noScheduleBox.parentElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  noScheduleBox.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  timelineBox.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  createBtn.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  editBtn.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  mapContainerSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  noScheduleBox.parentElement.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  noScheduleBox.classList.add('hidden');
Â  Â  Â  Â  Â  Â  timelineBox.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  timelineBox.innerHTML = '';
Â  Â  Â  Â  Â  Â  createBtn.classList.add('hidden');
Â  Â  Â  Â  Â  Â  editBtn.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  editBtn.classList.add('inline-flex');

Â  Â  Â  Â  Â  Â  if (currentLayout === 'table') {
Â  Â  Â  Â  Â  Â  Â  Â  const tableHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="themed-card rounded-lg shadow">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>×©×¢×”</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>×¤×¢×™×œ×•×ª</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th>×¤×¢×•×œ×•×ª</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${items.map((it, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>${timeText(it)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.summary ? `<p class="text-sm">${it.summary}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-end gap-2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.address?.label ? `<a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps" title="× ×™×•×•×˜ ×‘-Google Maps"><i class="fa-solid fa-map-location-dot"></i></a>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.links?.site ? `<a href="${it.links.site}" target="_blank" class="action-button site" title="×§×™×©×•×¨ ×œ××ª×¨"><i class="fa-solid fa-link"></i></a>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="action-button details open-modal-btn" data-index="${index}" title="×¤×¨×˜×™× ××œ××™×"><i class="fa-solid fa-info-circle"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `).join('')}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  timelineBox.innerHTML = tableHtml;
Â  Â  Â  Â  Â  Â  } else if (currentLayout === 'condensed-list') {
Â  Â  Â  Â  Â  Â  Â  Â  const listContainer = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  listContainer.className = 'themed-card rounded-lg shadow p-2';
Â  Â  Â  Â  Â  Â  Â  Â  listContainer.innerHTML = items.map((it, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timeline-item-wrapper open-modal-btn cursor-pointer hover:bg-slate-50" data-index="${index}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="time-block">${timeText(it)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="details-block">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.summary ? `<p class="text-sm">${it.summary}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â  Â  Â  timelineBox.appendChild(listContainer);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  items.forEach((it, index) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemWrapper = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemWrapper.className = 'timeline-item-wrapper';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemWrapper.id = `timeline-item-${index}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let itemHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isLineStyle = currentLayout.startsWith('line-style');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isLineStyle) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isAccordion = currentLayout.includes('accordion');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isAccordion) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const isFullAccordion = currentLayout.includes('full');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const summaryContent = `<div class="flex items-center justify-between p-4"><div class="flex items-center gap-3"><span class="text-xl">${itemEmoji(it)}</span><h4 class="font-bold text-lg break-words">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4></div><i class="fas fa-chevron-down chevron-icon"></i></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â const detailsContent = isFullAccordion
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? getFullItemDetailsHTML(it, index)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : `${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal-btn" data-index="${index}">×¤×¨×˜×™× ××œ××™×...</button>`;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timeline-time-outside">${timeText(it)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <details id="details-${index}" class="group accordion-item themed-card rounded-lg shadow-sm" style="padding-right: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <summary>${summaryContent}</summary>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 pt-0 pr-12"><div class="border-t pt-3" style="border-color: var(--card-border-color);">${detailsContent}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </details>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { // line-style default
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="timeline-time-outside">${timeText(it)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal-btn" data-index="${index}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="text-xl">${itemEmoji(it)}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="font-bold text-lg break-words">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (currentLayout.startsWith('accordion')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const summaryContent = `<div class="flex items-center justify-between p-4"><div class="flex items-center gap-4"><span class="text-2xl">${itemEmoji(it)}</span><div><h4 class="font-bold text-lg">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4><p class="text-sm font-mono" style="color: var(--card-secondary-text-color);">${timeText(it)}</p></div></div><i class="fas fa-chevron-down chevron-icon"></i></div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const detailsContent = currentLayout === 'accordion-summary'Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ? `${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal-btn" data-index="${index}">×¤×¨×˜×™× ××œ××™×...</button>`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  : getFullItemDetailsHTML(it, index);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <details id="details-${index}" class="group accordion-item themed-card rounded-lg shadow-sm" style="padding-right: 0;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <summary>${summaryContent}</summary>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-4 pt-0 pr-12"><div class="border-t pt-3" style="border-color: var(--card-border-color);">${detailsContent}</div></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </details>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { // default layout
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const navLink = it.address?.label ? `<a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps"><i class="fa-solid fa-map-location-dot"></i></a>` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const siteLink = it.links?.site ? `<a href="${it.links.site}" target="_blank" class="action-button site"><i class="fa-solid fa-link"></i></a>` : '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal-btn" data-index="${index}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm font-bold" style="color: var(--card-secondary-text-color);">${timeText(it)}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h4 class="text-lg font-bold mt-1">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex gap-2 mt-2 pt-2 border-t" style="border-color: var(--card-border-color);">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${navLink} ${siteLink}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  itemWrapper.innerHTML = itemHtml;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  timelineBox.appendChild(itemWrapper);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Attach all event listeners after HTML is in the DOM
Â  Â  Â  Â  Â  Â  timelineBox.querySelectorAll('.open-modal-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  const index = btn.dataset.index;
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', (e) => { e.stopPropagation(); showItemDetailModal(items[index]); });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  timelineBox.querySelectorAll('.open-ref-modal-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', (e) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showRefDetailModal(btn.dataset.refType, btn.dataset.refId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.querySelectorAll('details.accordion-item').forEach((detailsEl) => {
Â  Â  Â  Â  Â  Â  Â  Â  const index = detailsEl.id.split('-')[1];
Â  Â  Â  Â  Â  Â  Â  Â  const item = items[index];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  detailsEl.addEventListener('toggle', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mapContainerId = `accordion-map-${index}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (detailsEl.open && !accordionMaps[mapContainerId] && (item.address?.lat || (item.travel?.from?.lat && item.travel?.to?.lat))) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mapContainer = detailsEl.querySelector(`#${mapContainerId}`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (mapContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const accordionMap = L.map(mapContainerId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(accordionMap);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupRouteOnMap(accordionMap, item);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  accordionMaps[mapContainerId] = accordionMap;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if(isSmartAccordionActive) updateSmartAccordionState();
Â  Â  Â  Â  Â  Â  renderRouteMap(items);
Â  Â  Â  Â  }

Â  Â  Â  Â  function updateSmartAccordionState() {
Â  Â  Â  Â  Â  Â  if (!isSmartAccordionActive || currentScheduleItems.length === 0) return;

Â  Â  Â  Â  Â  Â  const now = new Date();
Â  Â  Â  Â  Â  Â  const nowMinutes = now.getHours() * 60 + now.getMinutes();
Â  Â  Â  Â  Â  Â  let activeIndex = -1;

Â  Â  Â  Â  Â  Â  for (let i = 0; i < currentScheduleItems.length; i++) {
Â  Â  Â  Â  Â  Â  Â  Â  const item = currentScheduleItems[i];
Â  Â  Â  -Â  Â  Â  Â  Â  Â  if (!item.startTime) continue;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const startMinutes = parseInt(item.startTime.split(':')[0]) * 60 + parseInt(item.startTime.split(':')[1]);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  let endMinutes;
Â  Â  Â  Â  Â  Â  Â  Â  if (item.endTime) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endMinutes = parseInt(item.endTime.split(':')[0]) * 60 + parseInt(item.endTime.split(':')[1]);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const currentItemSort = item.sort;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const nextItem = currentScheduleItems.slice().sort((a,b) => a.sort - b.sort).find(it => it.sort > currentItemSort && it.startTime);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (nextItem) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endMinutes = parseInt(nextItem.startTime.split(':')[0]) * 60 + parseInt(nextItem.startTime.split(':')[1]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  endMinutes = 24 * 60; // End of day
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (nowMinutes >= startMinutes && nowMinutes < endMinutes) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeIndex = i;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  break;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.querySelectorAll('.smart-accordion-active').forEach(el => el.classList.remove('smart-accordion-active'));

Â  Â  Â  Â  Â  Â  if (activeIndex !== -1) {
Â  Â  Â  Â  Â  Â  Â  Â  const activeDetails = document.getElementById(`details-${activeIndex}`);
Â  Â  Â  Â  Â  Â  Â  Â  if (activeDetails) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!activeDetails.hasAttribute('data-user-opened')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('details.accordion-item').forEach(d => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (d.id !== `details-${activeIndex}` && !d.hasAttribute('data-user-opened')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  d.open = false;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!activeDetails.open) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â activeDetails.open = true;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  activeDetails.classList.add('smart-accordion-active');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function openModal() {
Â  Â  Â  Â  Â  Â  mainContent.style.filter = 'blur(4px)';
Â  Â  Â  Â  Â  Â  mainContent.style.pointerEvents = 'none';
Â  Â  Â  Â  }
Â  Â  Â  Â  function closeModal() {
Â  Â  Â  Â  Â  Â  mainContent.style.filter = 'none';
Â  Â  Â  Â  Â  Â  mainContent.style.pointerEvents = 'auto';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeDetailModal() {
Â  Â  Â  Â  Â  Â  if (modalMapInstance) {Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (currentRouteLayer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMapInstance.removeLayer(currentRouteLayer);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRouteLayer = null;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  modalMapInstance.remove();Â 
Â  Â  Â  Â  Â  Â  Â  Â  modalMapInstance = null;Â 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  itemDetailModal.classList.remove('visible');
Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function setupRouteOnMap(map, item) {
Â  Â  Â  Â  Â  Â  const hasAddr = !!(item.address?.lat && item.address?.lng);
Â  Â  Â  Â  Â  Â  const hasTravel = !!(item.travel?.from?.lat && item.travel?.from?.lng && item.travel?.to?.lat && item.travel?.to?.lng);

Â  Â  Â  Â  Â  Â  if (currentRouteLayer && map.hasLayer(currentRouteLayer)) {
Â  Â  Â  Â  Â  Â  Â  Â  map.removeLayer(currentRouteLayer);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (hasTravel) {
Â  Â  Â  Â  Â  Â  Â  Â  const a = item.travel.from;
Â  Â  Â  Â  Â  Â  Â  Â  const b = item.travel.to;
Â  Â  Â  Â  Â  Â  Â  Â  const profile = (item.travel.mode === 'foot') ? 'foot' : 'driving';
Â  Â  Â  Â  Â  Â  Â  Â  const url = `https://router.project-osrm.org/route/v1/${profile}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const res = await fetch(url);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const data = await res.json();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (data?.routes?.[0]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const r = data.routes[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRouteLayer = L.geoJSON(r.geometry, { style: { color: 'blue', weight: 5 } }).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.fitBounds(currentRouteLayer.getBounds(), { padding: [40, 40] });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Could not fetch route from OSRM", e);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback to straight line
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  currentRouteLayer = L.polyline([[a.lat, a.lng], [b.lat, b.lng]], {color: 'red', dashArray: '5, 10'}).addTo(map);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  map.fitBounds([[a.lat, a.lng], [b.lat, b.lng]], {padding: [40, 40]});
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  L.marker([a.lat, a.lng]).addTo(map).bindPopup(`×: ${item.travel.from.label}`);
Â  Â  Â  Â  Â  Â  Â  Â  L.marker([b.lat, b.lng]).addTo(map).bindPopup(`××œ: ${item.travel.to.label}`);

Â  Â  Â  Â  Â  Â  } else if (hasAddr) {
Â  Â  Â  Â  Â  Â  Â  Â  map.setView([item.address.lat, item.address.lng], 15);
Â  Â  Â  Â  Â  Â  Â  Â  L.marker([item.address.lat, item.address.lng]).addTo(map);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function showItemDetailModal(it) {
Â  Â  Â  Â  Â  Â  openModal();
Â  Â  Â  Â  Â  Â  const hasAddr = !!(it.address?.lat && it.address?.lng);
Â  Â  Â  Â  Â  Â  const hasTravel = !!(it.travel?.from?.lat && it.travel?.from?.lng && it.travel?.to?.lat && it.travel?.to?.lng);

Â  Â  Â  Â  Â  Â  const headerHtml = `<div class="flex justify-between items-start"><div><div class="flex items-center gap-3"><span class="text-2xl">${itemEmoji(it)}</span><h3 class="text-2xl font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h3></div><div class="text-md font-semibold mt-1" style="color: var(--card-secondary-text-color)">${timeText(it)}</div></div><button id="close-detail-modal-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button></div>`;
Â  Â  Â  Â  Â  Â  const fullDetailsHtml = getFullItemDetailsHTML(it);
Â  Â  Â  Â  Â  Â  const mapHtml = (hasAddr || hasTravel) ? `<div id="modal-map" class="h-64 w-full mt-4 rounded-lg z-0 border"></div>` : '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  itemDetailModalContent.innerHTML = `<div class="space-y-4">${headerHtml}<div class="border-t pt-4 space-y-3" style="border-color: var(--card-border-color);">${it.summary ? `<p class="text-lg italic" style="color: var(--card-secondary-text-color)">${it.summary}</p>` : ''}${fullDetailsHtml}</div>${mapHtml}</div>`;
Â  Â  Â  Â  Â  Â  itemDetailModal.classList.add('visible');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (hasAddr || hasTravel) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const mapContainer = document.getElementById('modal-map');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (mapContainer) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalMapInstance = L.map('modal-map');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(modalMapInstance);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupRouteOnMap(modalMapInstance, it);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  document.getElementById('close-detail-modal-btn').addEventListener('click', closeDetailModal);
Â  Â  Â  Â  Â  Â  itemDetailModalContent.querySelectorAll('.open-ref-modal-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', (e) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showRefDetailModal(btn.dataset.refType, btn.dataset.refId);Â 
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const noteColorMap = { red: 'bg-red-200 border-red-300', green: 'bg-green-200 border-green-300', blue: 'bg-blue-200 border-blue-300', yellow: 'bg-yellow-200 border-yellow-300', orange: 'bg-orange-200 border-orange-300' };
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderNotesList(notes){
Â  Â  Â  Â  Â  Â  if (!notes || notes.length===0){
Â  Â  Â  Â  Â  Â  Â  Â  notesList.innerHTML = `<div style="color: var(--card-secondary-text-color);">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  notesList.innerHTML = notes.map(n=>{
Â  Â  Â  Â  Â  Â  Â  Â  const cls = noteColorMap[n.color] || noteColorMap.yellow;
Â  Â  Â  Â  Â  Â  Â  Â  return `<div class="border rounded-xl p-3 ${cls}"><div class="font-bold force-black-text">${n.kind}: ${n.title || 'â€”'}</div>${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap force-black-text-secondary">${n.details}</div>` : ''}</div>`;
Â  Â  Â  Â  Â  Â  }).join('');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  function renderRouteMap(items) {
Â  Â  Â  Â  Â  Â  const allPoints = [];
Â  Â  Â  Â  Â  Â  const pointLabels = new Set();Â 

Â  Â  Â  Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  if (item.address && item.address.lat && item.address.lng) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = `${item.address.lat},${item.address.lng}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!pointLabels.has(label)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allPoints.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...item.address,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: item.titleÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointLabels.add(label);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (item.travel && item.travel.to && item.travel.to.lat && item.travel.to.lng) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const label = `${item.travel.to.lat},${item.travel.to.lng}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â if (!pointLabels.has(label)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  allPoints.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...item.travel.to,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  title: item.titleÂ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  pointLabels.add(label);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (allPoints.length < 2) {
Â  Â  Â  Â  Â  Â  Â  Â  mapContainerSection.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  mapContainerSection.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  if (mapInstance) { mapInstance.remove(); }
Â  Â  Â  Â  Â  Â  mapInstance = L.map('route-map');
Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(mapInstance);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const markers = [];
Â  Â  Â  Â  Â  Â  const routeColors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6', '#d946ef'];
Â  Â  Â  Â  Â  Â  mapLegend.innerHTML = '<p class="font-bold">××§×¨× ××¡×œ×•×œ:</p>';

Â  Â  Â  Â  Â  Â  allPoints.forEach((point, i) => {
Â  Â  Â  Â  Â  Â  Â  Â  markers.push(L.marker([point.lat, point.lng]).addTo(mapInstance).bindPopup(`<b>${i + 1}. ${point.title}</b><br>${point.label}`));
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (i > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const prevPoint = allPoints[i - 1];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const color = routeColors[(i - 1) % routeColors.length];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.polyline([[prevPoint.lat, prevPoint.lng], [point.lat, point.lng]], { color: color }).addTo(mapInstance);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const legendItem = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legendItem.className = 'flex items-center gap-2';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  legendItem.innerHTML = `<span class="w-4 h-1 inline-block" style="background-color: ${color};"></span><span>×: ${prevPoint.label} <i class="fa-solid fa-arrow-left fa-xs"></i> ×œ: ${point.label}</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  mapLegend.appendChild(legendItem);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (markers.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  mapInstance.fitBounds(new L.featureGroup(markers).getBounds().pad(0.2));
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------- Event Listeners & Settings ----------
Â  Â  Â  Â  const themePresets = {
Â  Â  Â  Â  Â  Â  'custom': { name: '×”×ª×××” ××™×©×™×ª', desc: '×©× ×” ×œ×¤×™ ×‘×—×™×¨×ª×š', style: 'bg-slate-200 text-slate-800', cardBg: 'rgba(255, 255, 255, 0.85)', cardText: '#1e293b', cardSecondaryText: '#475569', cardBorder: 'rgba(226, 232, 240, 0.7)', bgHex: '#ffffff', opacity: 85 },
Â  Â  Â  Â  Â  Â  'light': { name: '×‘×”×™×¨', desc: '×œ×‘×Ÿ, ×˜×§×¡×˜ ×©×—×•×¨', style: 'bg-white text-slate-800', cardBg: 'rgba(255, 255, 255, 0.9)', cardText: '#1e293b', cardSecondaryText: '#475569', cardBorder: 'rgba(226, 232, 240, 0.7)', bgHex: '#ffffff', opacity: 90 },
Â  Â  Â  Â  Â  Â  'dark': { name: '×›×”×”', desc: '×›×”×”, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-slate-800 text-white', cardBg: 'rgba(30, 41, 59, 0.9)', cardText: '#f1f5f9', cardSecondaryText: '#94a3b8', cardBorder: 'rgba(51, 65, 85, 0.8)', bgHex: '#1e293b', opacity: 90 },
Â  Â  Â  Â  Â  Â  'glass': { name: '×–×›×•×›×™×ª', desc: '×©×§×•×£, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-slate-700/50 text-white', cardBg: 'rgba(255, 255, 255, 0.2)', cardText: '#ffffff', cardSecondaryText: 'rgba(226, 232, 240, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#ffffff', opacity: 20 },
Â  Â  Â  Â  Â  Â  'ocean': { name: '××•×§×™×™× ×•×¡', desc: '×›×—×•×œ, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-cyan-700 text-white', cardBg: 'rgba(14, 116, 144, 0.9)', cardText: '#f0f9ff', cardSecondaryText: '#a5f3fc', cardBorder: 'rgba(103, 232, 249, 0.3)', bgHex: '#0e7490', opacity: 90 },
Â  Â  Â  Â  Â  Â  'sunset': { name: '×©×§×™×¢×”', desc: '×›×ª×•×, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-orange-500 text-white', cardBg: 'rgba(234, 88, 12, 0.9)', cardText: '#fff7ed', cardSecondaryText: '#fed7aa', cardBorder: 'rgba(251, 146, 60, 0.4)', bgHex: '#ea580c', opacity: 90 },
Â  Â  Â  Â  Â  Â  'forest': { name: '×™×¢×¨', desc: '×™×¨×•×§, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-green-800 text-white', cardBg: 'rgba(22, 101, 52, 0.9)', cardText: '#f0fdf4', cardSecondaryText: '#bbf7d0', cardBorder: 'rgba(74, 222, 128, 0.3)', bgHex: '#166534', opacity: 90 },
Â  Â  Â  Â  Â  Â  'lavender': { name: '×œ×‘× ×“×¨', desc: '×¡×’×•×œ ×‘×”×™×¨, ×˜×§×¡×˜ ×›×”×”', style: 'bg-violet-200 text-violet-900', cardBg: 'rgba(237, 233, 254, 0.9)', cardText: '#4c1d95', cardSecondaryText: '#6d28d9', cardBorder: 'rgba(196, 181, 253, 0.8)', bgHex: '#ede9fe', opacity: 90 },
Â  Â  Â  Â  Â  Â  'sand': { name: '×—×•×œ', desc: '×¦×”×‘×”×‘, ×˜×§×¡×˜ ×—×•×', style: 'bg-amber-100 text-amber-900', cardBg: 'rgba(254, 243, 199, 0.9)', cardText: '#78350f', cardSecondaryText: '#92400e', cardBorder: 'rgba(252, 211, 77, 0.7)', bgHex: '#fef3c7', opacity: 90 },
Â  Â  Â  Â  Â  Â  'sunrise': { name: '×–×¨×™×—×”', desc: '×’×¨×“×™×× ×˜ ×›×ª×•×-×•×¨×•×“', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #FFD3A5 0%, #FD6585 100%)', cardText: '#431c4f', cardSecondaryText: 'rgba(67, 28, 79, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#FFD3A5', opacity: 100 },
Â  Â  Â  Â  Â  Â  'twilight': { name: '×“××“×•××™×', desc: '×’×¨×“×™×× ×˜ ×¡×’×•×œ-×›×—×•×œ', style: 'text-white', cardBg: 'linear-gradient(135deg, #3023AE 0%, #c86dd7 100%)', cardText: '#ffffff', cardSecondaryText: 'rgba(230, 230, 255, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#3023AE', opacity: 100 },
Â  Â  Â  Â  Â  Â  'minty': { name: '×× ×˜×”', desc: '×’×¨×“×™×× ×˜ ×™×¨×•×§-×¦×”×•×‘', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #96fbc4 0%, #f9f586 100%)', cardText: '#044343', cardSecondaryText: 'rgba(4, 67, 67, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.5)', bgHex: '#96fbc4', opacity: 100 },
Â  Â  Â  Â  Â  Â  'rose_gold': { name: '×¨×•×– ×’×•×œ×“', desc: '×’×¨×“×™×× ×˜ ×•×¨×•×“-×–×”×‘', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #f0c793 0%, #d9a7c7 100%)', cardText: '#5d4157', cardSecondaryText: 'rgba(93, 65, 87, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.4)', bgHex: '#f0c793', opacity: 100 },
Â  Â  Â  Â  Â  Â  'paper': { name: '× ×™×™×¨', desc: '×§×¨×, ×˜×§×¡×˜ ×—×•×', style: 'bg-amber-50 text-amber-900', cardBg: 'rgba(254, 252, 247, 0.9)', cardText: '#583c27', cardSecondaryText: '#8a6e59', cardBorder: 'rgba(214, 203, 189, 0.8)', bgHex: '#fefcf7', opacity: 90 },
Â  Â  Â  Â  Â  Â  'deep_space': { name: '×—×œ×œ ×¢××•×§', desc: '×©×—×•×¨, ×˜×§×¡×˜ ×–×•×”×¨', style: 'text-gray-200', cardBg: 'linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)', cardText: '#e0e0e0', cardSecondaryText: '#a0a0c0', cardBorder: '#3d3470', bgHex: '#0f0c29', opacity: 100 },
Â  Â  Â  Â  Â  Â  'tropical': { name: '×˜×¨×•×¤×™', desc: '×’×¨×“×™×× ×˜ ×™×¨×•×§-×›×—×•×œ', style: 'text-white', cardBg: 'linear-gradient(135deg, #00F260 0%, #0575E6 100%)', cardText: '#ffffff', cardSecondaryText: 'rgba(230, 255, 255, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#00F260', opacity: 100 },
Â  Â  Â  Â  Â  Â  'coral_reef': { name: '×©×•× ×™×ª ××œ××•×’×™×', desc: '×’×¨×“×™×× ×˜ ×•×¨×•×“-×›×ª×•×', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)', cardText: '#8a2326', cardSecondaryText: 'rgba(138, 35, 38, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.4)', bgHex: '#ff9a9e', opacity: 100 }
Â  Â  Â  Â  };

Â  Â  Â  Â  function attachEvents() {
Â  Â  Â  Â  Â  Â  hamburgerBtn.addEventListener('click', toggleSidebar);
Â  Â  Â  Â  Â  Â  closeSidebarBtn.addEventListener('click', toggleSidebar);
Â  Â  Â  Â  Â  Â  settingsBtn.addEventListener('click', toggleSettings);
Â  Â  Â  Â  Â  Â  closeSettingsBtn.addEventListener('click', toggleSettings);
Â  Â  Â  Â  Â  Â  overlay.addEventListener('click', () => { sidebar.classList.add('translate-x-full'); settingsModal.classList.add('translate-x-full'); overlay.classList.add('hidden'); });
Â  Â  Â  Â  Â  Â  tripHomeBtn.href = 'index.html';
Â  Â  Â  Â  Â  Â  itemDetailModal.addEventListener('click', (e) => { if (e.target === itemDetailModal) closeDetailModal(); });
Â  Â  Â  Â  Â  Â  refDetailModal.addEventListener('click', (e) => { if (e.target === refDetailModal) closeRefDetailModal(); });

Â  Â  Â  Â  Â  Â  document.querySelectorAll('.settings-nav-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.settings-nav-btn').forEach(b => { b.classList.remove('bg-slate-200'); b.classList.add('text-slate-500'); });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.classList.add('bg-slate-200'); btn.classList.remove('text-slate-500');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const panelId = `settings-panel-${btn.dataset.panel}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.settings-panel').forEach(p => p.classList.add('hidden'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById(panelId).classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // BG Settings Events
Â  Â  Â  Â  Â  Â  bgImageUploadBtn.addEventListener('click', () => bgImageUploadInput.click());
Â  Â  Â  Â  Â  Â  bgImageUploadInput.addEventListener('change', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const file = e.target.files?.[0];
Â  Â  Â  Â  Â  Â  Â  Â  if (file) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  handleImageUpload(file, bgImageUrlStorage, bgImageStatus, (url) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setBackground({ type: 'image', value: url, brightness: document.getElementById('bg-brightness-slider').value });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  configureBgSettingsUI();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  e.target.value = null;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  bgImageRemoveBtn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  bgImageUrlStorage.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  setBackground({ type: 'color', value: bgColorPicker.value, brightness: document.getElementById('bg-brightness-slider').value });
Â  Â  Â  Â  Â  Â  Â  Â  configureBgSettingsUI();
Â  Â  Â  Â  Â  Â  Â  Â  bgImageStatus.textContent = '×”×ª××•× ×” ×”×•×¡×¨×”.';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => bgImageStatus.textContent = '', 2000);
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  document.getElementById('apply-bg-settings').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const url = bgImageUrlStorage.value;
Â  Â  Â  Â  Â  Â  Â  Â  const color = bgColorPicker.value;
Â  Â  Â  Â  Â  Â  Â  Â  const brightness = document.getElementById('bg-brightness-slider').value;
Â  Â  Â  Â  Â  Â  Â  Â  const bgSettings = { type: url ? 'image' : 'color', value: url || color, brightness: brightness };
Â  Â  Â  Â  Â  Â  Â  Â  setBackground(bgSettings);
Â  Â  Â  Â  Â  Â  Â  Â  saveStyleSetting('background', bgSettings, document.getElementById('bg-scope').value);
Â  Â  Â  Â  Â  Â  Â  Â  toggleSettings();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  document.getElementById('apply-layout-settings').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  const newLayout = document.querySelector('input[name="timeline-layout"]:checked').value;
Â  Â  Â  Â  Â  Â  Â  Â  const smartAccordion = smartAccordionToggle.checked;
Â  Â  Â  Â  Â  Â  Â  Â  setCurrentLayout(newLayout, smartAccordion);
Â  Â  Â  Â  Â  Â  Â  Â  saveStyleSetting('layout', { layout: newLayout, smart: smartAccordion }, document.getElementById('layout-scope').value);
Â  Â  Â  Â  Â  Â  Â  Â  toggleSettings();
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  document.querySelectorAll('input[name="timeline-layout"]').forEach(radio => {
Â  Â  Â  Â  Â  Â  Â  Â  radio.addEventListener('change', (event) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const showSmartControls = event.target.value.includes('accordion');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  smartAccordionControls.classList.toggle('hidden', !showSmartControls);
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  smartAccordionToggle.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  Â  Â  isSmartAccordionActive = smartAccordionToggle.checked;
Â  Â  Â  Â  Â  Â  Â  Â  const currentlySelectedLayout = document.querySelector('input[name="timeline-layout"]:checked').value;
Â  Â  Â  Â  Â  Â  Â  Â  setCurrentLayout(currentlySelectedLayout, isSmartAccordionActive);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const presetsContainer = document.getElementById('theme-presets-container');
Â  Â  Â  Â  Â  Â  presetsContainer.innerHTML = Object.entries(themePresets).map(([key, theme]) => {
Â  Â  Â  Â  Â  Â  Â  Â  const bgStyle = theme.cardBg.includes('gradient') ? `background: ${theme.cardBg}; border-color: transparent;` : '';
Â  Â  Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <button data-theme="${key}" id="theme-btn-${key}" class="theme-preset-btn p-3 border rounded-lg text-center ${theme.style}" style="${bgStyle}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="font-bold text-sm override-text-color">${theme.name}</span>Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-xs override-text-color">${theme.desc}</div>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  `
Â  Â  Â  Â  Â  Â  }).join('');

Â  Â  Â  Â  Â  Â  document.querySelectorAll('.theme-preset-btn').forEach(btn => {
Â  Â  Â  Â  Â  Â  Â  Â  btn.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const themeKey = btn.dataset.theme;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const newTheme = themePresets[themeKey];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (newTheme) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTheme(themeKey);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('card-bg-color-picker').value = newTheme.bgHex;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('card-opacity-slider').value = newTheme.opacity;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('card-text-color-picker').value = newTheme.cardText;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  function updateCustomThemePreview() {
Â  Â  Â  Â  Â  Â  Â  Â  const bgColor = document.getElementById('card-bg-color-picker').value;
Â  Â  Â  Â  Â  Â  Â  Â  const opacity = document.getElementById('card-opacity-slider').value;
Â  Â  Â  Â  Â  Â  Â  Â  const textColor = document.getElementById('card-text-color-picker').value;
Â  Â  Â  Â  Â  Â  Â  Â  const rgb = hexToRgb(bgColor);
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const cardBg = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity / 100})`;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  currentCustomTheme = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardBg: cardBg,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardText: textColor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardSecondaryText: textColor, // Simplified for preview
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  cardBorder: `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${(opacity / 100) * 0.8})`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  bgHex: bgColor,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  opacity: opacity
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  const previewBtn = document.getElementById('theme-btn-custom');
Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.style.background = cardBg;
Â  Â  Â  Â  Â  Â  Â  Â  previewBtn.querySelectorAll('.override-text-color').forEach(el => el.style.color = textColor);

Â  Â  Â  Â  Â  Â  Â  Â  setTheme('custom');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  document.getElementById('card-bg-color-picker').addEventListener('input', updateCustomThemePreview);
Â  Â  Â  Â  Â  Â  document.getElementById('card-opacity-slider').addEventListener('input', updateCustomThemePreview);
Â  Â  Â  Â  Â  Â  document.getElementById('card-text-color-picker').addEventListener('input', updateCustomThemePreview);


Â  Â  Â  Â  Â  Â  document.getElementById('apply-theme-settings').addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  Â  Â  if (currentThemeKey === 'custom') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveStyleSetting('theme', { key: 'custom', values: currentCustomTheme }, 'trip');
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  saveStyleSetting('theme', { key: currentThemeKey }, 'trip');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  toggleSettings();
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  timelineBox.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const details = e.target.closest('details.accordion-item');
Â  Â  Â  Â  Â  Â  Â  Â  if (details && details.open) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  details.setAttribute('data-user-opened', 'true');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  // ---------- Init & Data Fetching ----------
Â  Â  Â  Â  async function saveStyleSetting(settingType, value, scope) {
Â  Â  Â  Â  Â  Â  const tripRef = doc(db, 'trips', tripId);
Â  Â  Â  Â  Â  Â  let key;
Â  Â  Â  Â  Â  Â  if (scope === 'date') {
Â  Â  Â  Â  Â  Â  Â  Â  key = `styles.date_${dateISO}.${settingType}`;
Â  Â  Â  Â  Â  Â  } else if (scope === 'destination') {
Â  Â  Â  Â  Â  Â  Â  Â  key = `styles.destination_${destForDate.id}.${settingType}`;
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  key = `styles.trip.${settingType}`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await updateDoc(tripRef, { [key]: value });
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error saving settings, trying setDoc with merge", e);
Â  Â  Â  Â  Â  Â  Â  Â  await setDoc(tripRef, { styles: { [scope === 'date' ? `date_${dateISO}` : scope === 'destination' ? `destination_${destForDate.id}` : 'trip']: { [settingType]: value } } }, { merge: true });
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function loadAndApplyStyles() {
Â  Â  Â  Â  Â  Â  const styles = tripData.styles || {};
Â  Â  Â  Â  Â  Â  const tripStyle = styles.trip || {};
Â  Â  Â  Â  Â  Â  const destStyle = destForDate ? (styles[`destination_${destForDate.id}`] || {}) : {};
Â  Â  Â  Â  Â  Â  const dateStyle = dateISO ? (styles[`date_${dateISO}`] || {}) : {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const finalLayoutSetting = dateStyle.layout || destStyle.layout || tripStyle.layout || { layout: 'default', smart: false };
Â  Â  Â  Â  Â  Â  const finalLayout = typeof finalLayoutSetting === 'string' ? finalLayoutSetting : finalLayoutSetting.layout;
Â  Â  Â  Â  Â  Â  const finalSmartAccordion = typeof finalLayoutSetting === 'string' ? false : finalLayoutSetting.smart;

Â  Â  Â  Â  Â  Â  const finalThemeSetting = dateStyle.theme || destStyle.theme || tripStyle.theme || { key: 'light' };
Â  Â  Â  Â  Â  Â  const finalBg = dateStyle.background || destStyle.background || tripStyle.background || { type: 'image', value: destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg', brightness: 50 };
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  setCurrentLayout(finalLayout, finalSmartAccordion);
Â  Â  Â  Â  Â  Â  if (finalThemeSetting.key === 'custom') {
Â  Â  Â  Â  Â  Â  Â  Â  currentCustomTheme = finalThemeSetting.values;
Â  Â  Â  Â  Â  Â  Â  Â  setTheme('custom', finalThemeSetting.values);
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  setTheme(finalThemeSetting.key || 'light');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  setBackground(finalBg);

Â  Â  Â  Â  Â  Â  // Set initial values in settings panel
Â  Â  Â  Â  Â  Â  bgImageUrlStorage.value = finalBg.type === 'image' ? finalBg.value : '';
Â  Â  Â  Â  Â  Â  bgColorPicker.value = finalBg.type === 'color' ? finalBg.value : '#f1f5f9';
Â  Â  Â  Â  Â  Â  document.getElementById('bg-brightness-slider').value = finalBg.brightness;
Â  Â  Â  Â  }

Â  Â  Â  Â  async function initPage() {
Â  Â  Â  Â  Â  Â  const url = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  tripId = url.get('tripId');
Â  Â  Â  Â  Â  Â  dateStr = decodeURIComponent(url.get('date') || '').trim();
Â  Â  Â  Â  Â  Â  const destId = url.get('destId'); // BUG FIX: Get destId from URL
Â  Â  Â  Â  Â  Â  const parsed = parseLocalDateFlexible(dateStr);
Â  Â  Â  Â  Â  Â  if (parsed) { dateISO = toISODateUTC(parsed); dayNameHe = hebWeekdayUTC(parsed); }

Â  Â  Â  Â  Â  Â  if (!tripId || !dateStr) { alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.'); location.href = 'index.html'; return; }

Â  Â  Â  Â  Â  Â  tripHomeBtn.href = `trip.html?id=${tripId}`;

Â  Â  Â  Â  Â  Â  attachEvents();

Â  Â  Â  Â  Â  Â  onAuthStateChanged(auth, async (user) => {
Â  Â  Â  Â  Â  Â  Â  Â  if (!user) { location.replace('login.html'); return; }
Â  Â  Â  Â  Â  Â  Â  Â  currentUser = user;
Â  Â  Â  Â  Â  Â  Â  Â  const displayName = user.displayName || user.email.split('@')[0];
Â  Â  Â  Â  Â  Â  Â  Â  authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));

Â  Â  Â  Â  Â  Â  Â  Â  const tripRef = doc(db, 'trips', tripId);
Â  Â  Â  Â  Â  Â  Â  Â  const tripSnap = await getDoc(tripRef);

Â  Â  Â  Â  Â  Â  Â  Â  if (tripSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const loadedTripData = tripSnap.data();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const canAccess = loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (canAccess) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tripData = loadedTripData;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // BUG FIX: Use destId from URL if available to find the correct destination.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (destId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destForDate = (tripData.destinations || []).find(d => d.id === destId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Optional safety check: verify date is within this destination's range
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (destForDate) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const days = generateDatesFromRange(destForDate.dates);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isoList = days.map(d => toISODateUTC(d));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (!isoList.includes(dateISO)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.warn(`Destination ID ${destId} found, but date ${dateStr} is not in its range. Falling back.`);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destForDate = findDestinationForDate(tripData, dateStr); // Fallback to original method
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // If destId from URL is invalid, fall back
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destForDate = findDestinationForDate(tripData, dateStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Fallback for old links without destId
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  destForDate = findDestinationForDate(tripData, dateStr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const defaultBgUrl = 'https://i.imgur.com/MjekTyd_d.webp?maxwidth=760&fidelity=grand';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loaderBg.style.backgroundImage = `url('${destForDate?.bgUrl || destForDate?.imageUrl || defaultBgUrl}')`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  buildMenuFromTrip();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  loadAndApplyStyles();

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // BUG FIX: Pass destId to the edit/create page as well to maintain context.
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const destIdParam = encodeURIComponent(destForDate?.id || '');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const editHref = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}&destId=${destIdParam}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  editBtn.href = editHref;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  createBtn.href = editHref;

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (dateISO) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const schedSnap = await getDoc(schedDocRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderHeadline(dayTitleFromDoc);

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const qItems = query(itemsCol);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onSnapshot(qItems, (snap) => {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  arr.sort((a, b) => a.sort - b.sort);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderTimelineFromItems(arr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, () => renderTimelineFromItems([]));

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const qNotes = query(notesCol);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  onSnapshot(qNotes, (snap) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (arr.length > 0 && arr[0].createdAt) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  arr.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderNotesList(arr);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, (err) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching notes:", err);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderNotesList([]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderHeadline(null);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderTimelineFromItems([]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderNotesList([]);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.href = 'index.html';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  alert('×”×˜×™×•×œ ×œ× × ××¦×.');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  location.href = 'index.html';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  initialLoader.style.opacity = '0';
Â  Â  Â  Â  Â  Â  Â  Â  mainContent.style.opacity = '1';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => { initialLoader.style.display = 'none'; }, 500);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  // --- Referenced Item Modal Logic ---
Â  Â  Â  Â  function closeRefDetailModal() {
Â  Â  Â  Â  Â  Â  if (refModalMapInstance) { refModalMapInstance.remove(); refModalMapInstance = null; }
Â  Â  Â  Â  Â  Â  refDetailModal.classList.remove('visible');
Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  }

Â  Â  Â  Â  async function showRefDetailModal(refType, refId) {
Â  Â  Â  Â  Â  Â  openModal();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  refDetailModalContent.innerHTML = `<div class="flex justify-center items-center h-48"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
Â  Â  Â  Â  Â  Â  refDetailModal.classList.add('visible');

Â  Â  Â  Â  Â  Â  const itemDocRef = doc(db, 'trips', tripId, refType, refId);
Â  Â  Â  Â  Â  Â  const itemSnap = await getDoc(itemDocRef);

Â  Â  Â  Â  Â  Â  if (!itemSnap.exists()) {
Â  Â  Â  Â  Â  Â  Â  Â  refDetailModalContent.innerHTML = `<p>×©×’×™××”: ×”×¤×¨×™×˜ ×”××§×•×©×¨ ×œ× × ××¦×.</p><button id="close-ref-modal-btn" class="absolute top-2 left-2 p-2"><i class="fas fa-times"></i></button>`;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('close-ref-modal-btn').onclick = closeRefDetailModal;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  const itemData = itemSnap.data();
Â  Â  Â  Â  Â  Â  let contentHtml = '';

Â  Â  Â  Â  Â  Â  if (refType === 'places') {
Â  Â  Â  Â  Â  Â  Â  Â  contentHtml = renderPlaceDetailsHTML(itemData);
Â  Â  Â  Â  Â  Â  } else if (refType === 'logistics') {
Â  Â  Â  Â  Â  Â  Â  Â  contentHtml = renderLogisticsDetailsHTML(itemData);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  refDetailModalContent.innerHTML = contentHtml;
Â  Â  Â  Â  Â  Â  document.getElementById('close-ref-modal-btn').onclick = closeRefDetailModal;

Â  Â  Â  Â  Â  Â  const mapContainer = refDetailModalContent.querySelector('#ref-modal-map');
Â  Â  Â  Â  Â  Â  if (mapContainer && itemData.coords) {
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  refModalMapInstance = L.map('ref-modal-map').setView([itemData.coords.lat, itemData.coords.lng], 15);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(refModalMapInstance);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  L.marker([itemData.coords.lat, itemData.coords.lng]).addTo(refModalMapInstance);
Â  Â  Â  Â  Â  Â  Â  Â  }, 50);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderPlaceDetailsHTML(item) {
Â  Â  Â  Â  Â  Â  const tags = [
Â  Â  Â  Â  Â  Â  Â  Â  item.isKosher === '×›×Ÿ' ? `<span class="text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full">×›×©×¨</span>` : '',
Â  Â  Â  Â  Â  Â  Â  Â  item.foodType ? `<span class="text-sm font-bold text-sky-700 bg-sky-100 px-3 py-1 rounded-full">${item.foodType}</span>` : '',
Â  Â  Â  Â  Â  Â  Â  Â  item.reservation && item.reservation !== '×œ×' ? `<span class="text-sm font-bold text-amber-700 bg-amber-100 px-3 py-1 rounded-full">×”×–×× ×”: ${item.reservation}</span>` : ''
Â  Â  Â  Â  Â  Â  ].filter(Boolean).join('');

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <button id="close-ref-modal-btn" class="absolute top-3 left-3 w-8 h-8 bg-slate-100/50 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 z-10 transition-colors"><i class="fas fa-times"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="p-0 space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-2xl font-bold border-b pb-3">${item.name}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tags ? `<div class="flex flex-wrap gap-3 items-center">${tags}</div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.shortDescription ? `<div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded"><p class="text-slate-700 font-semibold">${item.shortDescription}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.description ? `<div class="bg-white p-3 rounded-lg shadow-inner"><p class="text-slate-700 whitespace-pre-wrap">${item.description}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.location ? `<div class="flex items-start gap-3"><i class="fa-solid fa-location-dot fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 font-semibold">${item.location}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.hours ? `<div class="flex items-start gap-3"><i class="fa-regular fa-clock fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 whitespace-pre-wrap">${item.hours}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${item.coords ? `<div id="ref-modal-map" class="w-full h-48 rounded-lg shadow-md"></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }

Â  Â  Â  Â  function renderLogisticsDetailsHTML(item) {
Â  Â  Â  Â  Â  Â  Â let detailsHtml = '';
Â  Â  Â  Â  Â  Â  Â switch(item.subType) {
Â  Â  Â  Â  Â  Â  Â  Â  Â case 'hotel':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â detailsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×™×¢×“:</strong> ${item.destination}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×ª××¨×™×›×™×:</strong> ${item.dates}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>××—×™×¨:</strong> ${item.price ? `$${item.price.toLocaleString()}`: '×œ× ×¦×•×™×Ÿ'}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×”×•×–××Ÿ ×“×¨×š:</strong> ${item.booked_via}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${item.address ? `<p><strong>×›×ª×•×‘×ª:</strong> ${item.address}</p>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  Â  Â  Â case 'flight':
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â detailsHtml = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×—×‘×¨×ª ×ª×¢×•×¤×”:</strong> ${item.airline}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>××¡×¤×¨ ×˜×™×¡×”:</strong> ${item.flight_number}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×ª××¨×™×š:</strong> ${item.dates}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×:</strong> ${item.from?.destination} (${item.from?.airport_name}) <strong>××œ:</strong> ${item.to?.destination} (${item.to?.airport_name})</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <p><strong>×”××¨××”:</strong> ${item.departure_time}, <strong>× ×—×™×ª×”:</strong> ${item.arrival_time}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â break;
Â  Â  Â  Â  Â  Â  Â  Â  Â default:
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â detailsHtml = `<p>××™×Ÿ ×¤×¨×˜×™× × ×•×¡×¤×™× ×œ×”×¦×’×”.</p>`;
Â  Â  Â  Â  Â  Â  Â }

Â  Â  Â  Â  Â  Â  Â return `
Â  Â  Â  Â  Â  Â  Â  Â  Â <button id="close-ref-modal-btn" class="absolute top-3 left-3 w-8 h-8 bg-slate-100/50 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 z-10 transition-colors"><i class="fas fa-times"></i></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="p-0 space-y-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <h3 class="text-2xl font-bold border-b pb-3">${item.name || item.subType}</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <div class="text-sm space-y-2">${detailsHtml}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ${item.additional_details ? `<div class="mt-2 p-3 bg-slate-100 rounded-lg text-sm text-slate-700"><p class="font-bold mb-1">×¤×¨×˜×™× × ×•×¡×¤×™×:</p><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
Â  Â  Â  Â  Â  Â  Â  Â  Â </div>
Â  Â  Â  Â  Â  Â  Â `;
Â  Â  Â  Â  }

Â  Â  Â  Â  initPage();
Â  Â  </script>
</body>
</html>
