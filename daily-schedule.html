<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    
    <style>
        :root {
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-text-color: #1e293b; /* slate-800 */
            --card-secondary-text-color: #475569; /* slate-600 */
            --card-border-color: rgba(203, 213, 225, 0.5); /* slate-300 with opacity */
        }

        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: #f1f5f9; /* slate-100 */
        }
        #sidebar, #settings-modal { 
            transition: transform 0.3s ease-in-out; 
        }
        #main-content {
            transition: opacity 0.5s, filter 0.3s ease-in-out;
        }
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s ease-in-out; 
        }
        .submenu.open { 
            max-height: 1200px; 
        }
        
        /* Themed Card Style */
        .themed-card {
            background: var(--card-bg);
            color: var(--card-text-color);
            border: 1px solid var(--card-border-color);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }
        .themed-card h1, .themed-card h2, .themed-card h3, .themed-card h4 {
             color: var(--card-text-color);
        }
        .themed-card p, .themed-card span, .themed-card div:not([class*="override"]), .themed-card a:not([class*="override"]) {
            color: var(--card-secondary-text-color);
        }
        .themed-card h2, .themed-card .font-extrabold, .themed-card .font-bold {
            color: var(--card-text-color);
        }
        .themed-card .text-slate-700 { color: var(--card-text-color); }
        .themed-card .text-slate-800 { color: var(--card-text-color); }
        .themed-card .text-slate-500 { color: var(--card-secondary-text-color); }
        .themed-card .text-slate-600 { color: var(--card-secondary-text-color); }

        /* Timeline Styles */
        .timeline { position: relative; }
        .timeline.layout-line-style::before, 
        .timeline.layout-line-style-accordion-full::before, 
        .timeline.layout-line-style-accordion-summary::before { 
            content: ""; 
            position: absolute; 
            right: 2.5rem;
            top: 0; 
            bottom: 0; 
            width: 2px; 
            background: rgba(30,41,59,.15); 
        }
        .timeline-item-wrapper {
            position: relative;
        }
        .timeline.layout-line-style .timeline-item-wrapper, 
        .timeline.layout-line-style-accordion-full .timeline-item-wrapper,
        .timeline.layout-line-style-accordion-summary .timeline-item-wrapper {
            padding-right: 6rem; /* Make space for the time */
        }
        .timeline-time-outside {
            position: absolute;
            right: 0;
            top: 1rem;
            background: var(--card-bg);
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            border: 1px solid var(--card-border-color);
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
            width: 5rem;
            text-align: center;
        }
        
        /* Table Layout */
        .timeline.layout-table .themed-card {
            overflow: hidden;
        }
        .timeline.layout-table table {
            width: 100%;
            border-collapse: collapse;
        }
        .timeline.layout-table th, .timeline.layout-table td {
            padding: 0.75rem 1rem;
            text-align: right;
            border-bottom: 1px solid var(--card-border-color);
        }
        .timeline.layout-table th {
            font-weight: 700;
            background-color: rgba(0,0,0,0.05);
        }
        .timeline.layout-table tr:last-child td {
            border-bottom: none;
        }
        .timeline.layout-table td:nth-child(1) { width: 15%; font-weight: 600; }
        .timeline.layout-table td:nth-child(2) { width: 60%; }
        .timeline.layout-table td:nth-child(3) { width: 25%; text-align: left; }

        /* Condensed List Layout */
        .timeline.layout-condensed-list .timeline-item-wrapper {
             display: flex;
             gap: 1rem;
             padding: 0.75rem;
             border-bottom: 1px solid var(--card-border-color);
        }
        .timeline.layout-condensed-list .timeline-item-wrapper:last-child {
            border-bottom: none;
        }
        .timeline.layout-condensed-list .time-block {
            flex-shrink: 0;
            font-weight: 600;
            width: 5rem;
            text-align: right;
        }
        .timeline.layout-condensed-list .details-block {
            flex-grow: 1;
        }

        /* Smart Accordion Highlight */
        .smart-accordion-active {
            box-shadow: 0 0 0 3px #10b981; /* Green ring */
            border-color: #10b981 !important;
        }

        /* Fix for scroll jitter */
        .bg-fixed-image, header {
            transform: translateZ(0);
        }
        .bg-fixed-image { 
            background-size: cover; 
            background-position: center; 
        }
        #initial-loader { 
            position: fixed; 
            inset: 0; 
            z-index: 100; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            transition: opacity .5s ease-out; 
        }
        @keyframes spin { 
            from { transform: rotate(0); } 
            to { transform: rotate(360deg); } 
        }
        .plane-spinner { 
            animation: spin 2s linear infinite; 
        }

        /* Map Styles */
        #route-map, .accordion-map-container, #modal-map, #ref-modal-map {
            height: 450px;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            background-color: #e2e8f0; /* Placeholder background */
        }
        #modal-map, .accordion-map-container, #ref-modal-map {
            height: 250px; /* Smaller map for modals and accordions */
        }
        .leaflet-container {
             font-family: 'Assistant', sans-serif;
        }

        /* Accordion styles */
        details > summary { 
            list-style: none; /* Remove default marker */
            cursor: pointer;
        }
        details > summary::-webkit-details-marker { 
            display: none; /* Remove default marker for Chrome */
        }
        .chevron-icon { 
            transition: transform 0.3s ease-out; 
        }
        details[open] > summary .chevron-icon { 
            transform: rotate(180deg); 
        }
        
        /* Custom modal for item details */
        .item-detail-modal, #ref-detail-modal {
            position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 100;
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s;
        }
        .item-detail-modal.visible, #ref-detail-modal.visible { opacity: 1; visibility: visible; }
        
        .item-detail-modal-content, #ref-detail-modal-content {
            background: var(--card-bg); color: var(--card-text-color);
            padding: 1.5rem; border-radius: 1rem; width: 90%; max-width: 600px;
            max-height: 90vh; overflow-y: auto; transform: scale(0.95); transition: transform 0.3s;
        }
        .item-detail-modal.visible .item-detail-modal-content, #ref-detail-modal.visible #ref-detail-modal-content { transform: scale(1); }

        /* Selected Theme Button */
        .theme-preset-btn.selected-theme {
            box-shadow: 0 0 0 3px #3b82f6; /* Ring effect */
        }
        
        /* Action buttons in cards */
        .action-button {
            display: inline-flex; align-items: center; gap: 0.5rem;
            padding: 0.4rem 0.9rem; border-radius: 9999px;
            font-size: 0.8rem; font-weight: 700; color: white;
            transition: all 0.2s ease-out; text-decoration: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2), 0 1px 2px rgba(0,0,0,0.1);
            text-shadow: 1px 1px 1px rgba(0,0,0,0.2);
            border: none;
        }
        .action-button:hover { 
            opacity: 0.9; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 2px 4px rgba(0,0,0,0.1);
            transform: translateY(-1px); 
        }
        .action-button.gmaps { background-color: #34A853; } /* Google Green */
        .action-button.waze { background-color: #33CCFF; color: #1e293b; } /* Waze Blue with dark text */
        .action-button.site { background-color: #4285F4; } /* Google Blue */
        .action-button.booking { background-color: #003580; } /* Booking.com Blue */
        .action-button.ref { background-color: #6366f1; } /* Indigo-500 */
        .action-button.details { background-color: #64748b; } /* Slate-500 */

        /* Force black text for notes */
        .force-black-text { color: #1e293b !important; }
        .force-black-text-secondary { color: #334155 !important; }

        /* Smart Accordion Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 28px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 28px;
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 20px;
            width: 20px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider {
            background-color: #25a25a;
        }
        input:checked + .toggle-slider:before {
            transform: translateX(22px);
        }
        .status-text.ok { color: #10b981; }
        .status-text.err { color: #ef4444; }
    </style>
</head>
<body class="bg-slate-100">
    <div id="initial-loader">
        <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd_d.webp?maxwidth=760&fidelity=grand');"></div>
        <div class="fixed inset-0 z-0 bg-black/50"></div>
        <div class="text-white text-center relative z-10">
            <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
            <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
        </div>
    </div>

    <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd_d.webp?maxwidth=760&fidelity=grand');"></div>
    <div id="page-bg-overlay" class="fixed inset-0 z-0 bg-black/50"></div>

    <aside id="sidebar" class="fixed top-0 right-0 h-full w-full max-w-sm sm:max-w-md bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
            <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <nav id="main-menu" class="p-4 space-y-2"></nav>
    </aside>
    
    <aside id="settings-modal" class="fixed top-0 right-0 h-full w-full max-w-sm sm:w-96 bg-white shadow-2xl z-[80] transform translate-x-full">
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-slate-800">×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ğŸ¨</h2>
            <button id="close-settings-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="p-4 space-y-6 overflow-y-auto h-[calc(100%-4.5rem)]">
            <div class="grid grid-cols-3 gap-2 border border-slate-200 rounded-lg p-1">
                <button data-panel="bg" class="settings-nav-btn bg-slate-200 p-2 rounded-md text-sm font-bold">×¨×§×¢</button>
                <button data-panel="layout" class="settings-nav-btn p-2 rounded-md text-sm font-bold text-slate-500">×¤×¨×™×¡×”</button>
                <button data-panel="theme" class="settings-nav-btn p-2 rounded-md text-sm font-bold text-slate-500">×¢×¨×›×ª × ×•×©×</button>
            </div>

            <div id="settings-panel-bg" class="settings-panel space-y-4">
                <div>
                    <label class="font-bold text-slate-700">×ª××•× ×ª ×¨×§×¢</label>
                    <div class="flex items-center gap-3 mt-1">
                        <button id="bg-image-upload-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition whitespace-nowrap">
                            <i class="fas fa-upload mr-1"></i> ×”×¢×œ×” ×ª××•× ×”
                        </button>
                        <button id="bg-image-remove-btn" class="hidden bg-red-600/80 hover:bg-red-700/80 text-white font-bold py-2 px-3 rounded-lg transition">
                            <i class="fas fa-times"></i> ×”×¡×¨
                        </button>
                    </div>
                    <input type="file" id="bg-image-upload-input" class="hidden" accept="image/*">
                    <input type="hidden" id="bg-image-url-storage">
                    <p id="bg-image-status" class="text-sm mt-2 text-slate-400 h-5"></p>
                </div>
                <div>
                    <label class="font-bold text-slate-700">××• ×‘×—×¨ ×¦×‘×¢ ×¨×§×¢</label>
                    <input id="bg-color-picker" type="color" value="#f1f5f9" class="w-full h-10 mt-1 border-none cursor-pointer">
                </div>
                 <div>
                    <label for="bg-brightness-slider" class="font-bold text-slate-700">×‘×”×™×¨×•×ª ×¨×§×¢</label>
                    <input id="bg-brightness-slider" type="range" min="0" max="100" value="50" class="w-full mt-1">
                </div>
                <div class="pt-4 border-t">
                    <label class="font-bold text-slate-700">×”×—×œ ×”×’×“×¨×•×ª ×¢×œ:</label>
                    <select id="bg-scope" class="w-full mt-1 p-2 border rounded-md">
                        <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×–×” (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ ×”×–×”</option>
                        <option value="trip">×›×œ ×”×œ×•"×–×™× ×©×œ ×”×˜×™×•×œ</option>
                    </select>
                </div>
                <button id="apply-bg-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
            </div>

            <div id="settings-panel-layout" class="settings-panel space-y-4 hidden">
                 <p class="font-bold text-slate-700">×¡×’× ×•×Ÿ ×ª×¦×•×’×ª ×”×œ×•"×–:</p>
                 <div class="space-y-2">
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="default">
                        <div><span class="font-bold">×›×¨×˜×™×¡×™×•×ª (×‘×¨×™×¨×ª ××—×“×œ)</span><p class="text-sm text-slate-500">×›×¨×˜×™×¡×™×” ×¢× ×¤×¨×˜×™× ×¢×™×§×¨×™×™×. ×œ×—×™×¦×” ×¤×•×ª×—×ª ×—×œ×•×Ÿ ×¢× ×›×œ ×”××™×“×¢.</p></div>
                    </label>
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="accordion-summary">
                        <div><span class="font-bold">××§×•×¨×“×™×•×Ÿ ×—×œ×§×™</span><p class="text-sm text-slate-500">×›×¨×˜×™×¡×™×” ×¢× ×›×•×ª×¨×ª ×•×©×¢×”. ×œ×—×™×¦×” ××¨×—×™×‘×” ×œ×¤×™×¨×•×˜.</p></div>
                    </label>
                     <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="accordion-full">
                        <div><span class="font-bold">××§×•×¨×“×™×•×Ÿ ××œ×</span><p class="text-sm text-slate-500">×›×¨×˜×™×¡×™×” ×¢× ×›×•×ª×¨×ª ×•×©×¢×”. ×œ×—×™×¦×” ××¨×—×™×‘×” ×•×—×•×©×¤×ª ××ª ×›×œ ×”×¤×¨×˜×™×.</p></div>
                    </label>
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="line-style">
                        <div><span class="font-bold">×¦×™×¨ ×–××Ÿ</span><p class="text-sm text-slate-500">×§×• ×× ×›×™ ×¢× ×›×¨×˜×™×¡×™×•×ª ×‘×¦×“. ×œ×—×™×¦×” ×¤×•×ª×—×ª ×—×œ×•×Ÿ ×¢× ×›×œ ×”××™×“×¢.</p></div>
                    </label>
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="line-style-accordion-summary">
                        <div><span class="font-bold">×¦×™×¨ ×–××Ÿ ××§×•×¨×“×™×•×Ÿ ×—×œ×§×™</span><p class="text-sm text-slate-500">×©×™×œ×•×‘ ×©×œ ×¦×™×¨ ×–××Ÿ ×¢× ××§×•×¨×“×™×•×Ÿ × ×¤×ª×— ×œ×ª×§×¦×™×¨.</p></div>
                    </label>
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="line-style-accordion-full">
                        <div><span class="font-bold">×¦×™×¨ ×–××Ÿ ××§×•×¨×“×™×•×Ÿ ××œ×</span><p class="text-sm text-slate-500">×©×™×œ×•×‘ ×©×œ ×¦×™×¨ ×–××Ÿ ×¢× ××§×•×¨×“×™×•×Ÿ × ×¤×ª×— ×œ×›×œ ×”×¤×¨×˜×™×.</p></div>
                    </label>
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="table">
                        <div><span class="font-bold">×˜×‘×œ×”</span><p class="text-sm text-slate-500">××¦×™×’ ××ª ×¤×¨×™×˜×™ ×”×™×•× ×‘×˜×‘×œ×” ××¡×•×“×¨×ª ×•×§×•××¤×§×˜×™×ª.</p></div>
                    </label>
                   <label class="flex items-center gap-3 p-3 border rounded-lg has-[:checked]:bg-sky-50 has-[:checked]:border-sky-400">
                        <input type="radio" name="timeline-layout" value="condensed-list">
                        <div><span class="font-bold">×¨×©×™××” ×“×—×•×¡×”</span><p class="text-sm text-slate-500">×¨×©×™××” ×¤×©×•×˜×” ×•× ×§×™×™×”, ××ª××™××” ×œ×”×“×¤×¡×”.</p></div>
                    </label>
                 </div>
                 <div id="smart-accordion-controls" class="pt-4 border-t space-y-3 hidden">
                    <div class="flex justify-between items-center">
                        <label for="smart-accordion-toggle" class="font-bold text-slate-700">××¦×‘ ××§×•×¨×“×™×•×Ÿ ×—×›×</label>
                        <label class="toggle-switch">
                            <input type="checkbox" id="smart-accordion-toggle">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                    <p class="text-sm text-slate-500">××¤×¢×™×œ ×¤×ª×™×—×” ××•×˜×•××˜×™×ª ×©×œ ×”×¤×¨×™×˜ ×”× ×•×›×—×™ ×œ×¤×™ ×”×©×¢×”.</p>
                 </div>
                 <div class="pt-4 border-t">
                    <label class="font-bold text-slate-700">×”×—×œ ×”×’×“×¨×•×ª ×¢×œ:</label>
                    <select id="layout-scope" class="w-full mt-1 p-2 border rounded-md">
                        <option value="trip">×›×œ ×”×œ×•"×–×™× ×©×œ ×”×˜×™×•×œ (×‘×¨×™×¨×ª ××—×“×œ)</option>
                        <option value="destination">×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×–×”</option>
                        <option value="date">×¨×§ ×‘×ª××¨×™×š ×”×¡×¤×¦×™×¤×™ ×”×–×”</option>
                    </select>
                </div>
                 <button id="apply-layout-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
            </div>

            <div id="settings-panel-theme" class="settings-panel space-y-4 hidden">
                <div id="custom-theme-controls" class="space-y-4 p-4 border rounded-lg bg-slate-50 hidden">
                    <h4 class="font-bold text-slate-700">×”×ª×××” ××™×©×™×ª</h4>
                    <div>
                        <label class="font-bold text-slate-700 text-sm">×¦×‘×¢ ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª</label>
                        <input id="card-bg-color-picker" type="color" value="#ffffff" class="w-full h-8 mt-1 border-none cursor-pointer">
                    </div>
                    <div>
                        <label for="card-opacity-slider" class="font-bold text-slate-700 text-sm">×©×§×™×¤×•×ª ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª</label>
                        <input id="card-opacity-slider" type="range" min="0" max="100" value="85" class="w-full mt-1">
                    </div>
                    <div>
                        <label class="font-bold text-slate-700 text-sm">×¦×‘×¢ ×˜×§×¡×˜</label>
                        <input id="card-text-color-picker" type="color" value="#1e293b" class="w-full h-8 mt-1 border-none cursor-pointer">
                    </div>
                </div>
                <div class="pt-4 border-t">
                     <p class="font-bold text-slate-700">×‘×—×¨ ×¢×¨×›×ª × ×•×©× ××•×›× ×”:</p>
                     <div id="theme-presets-container" class="grid grid-cols-2 gap-2 mt-2">
                          </div>
                </div>
                 <button id="apply-theme-settings" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">×”×—×œ ×©×™× ×•×™×™×</button>
            </div>
        </div>
    </aside>

    <div id="overlay" class="fixed inset-0 bg-black/40 cursor-pointer z-50 hidden"></div>

    <div id="main-content" class="relative z-10 opacity-0">
        <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <div class="flex items-center gap-4">
                        <a id="trip-home-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ">
                            <i class="fas fa-map-signs fa-lg"></i>
                        </a>
                        <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
                    </div>
                    <div class="flex items-center gap-2">
                        <div id="auth-container" class="flex items-center"></div>
                        <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none" title="×”×’×“×¨×•×ª ×¢×™×¦×•×‘">
                            <i class="fas fa-cog fa-lg"></i>
                        </button>
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <div class="bg-white/70 backdrop-blur-md border-b">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
                <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
            </div>
        </div>

        <main class="p-4 sm:p-6 lg:p-8">
            <div class="max-w-5xl mx-auto space-y-8">

                <section id="title-card" class="themed-card rounded-2xl shadow-lg p-5">
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                        <div>
                            <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold">×œ×•×– ×œ×™×•×</h2>
                            <p id="trip-subtitle" class="mt-1"></p>
                        </div>
                        <div class="flex items-center gap-2">
                            <i class="fa-regular fa-calendar"></i>
                            <span id="date-chip" class="font-semibold">--/--/----</span>
                        </div>
                    </div>
                </section>

                <section id="timeline-section">
                    <div id="no-schedule" class="themed-card text-center p-10 rounded-2xl shadow-lg">
                        <i class="fa-regular fa-clock fa-3x mb-4"></i>
                        <h3 class="text-xl font-bold mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
                        <p>×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
                    </div>
                    <div id="timeline" class="timeline space-y-4 hidden"></div>
                </section>

                <section id="notes-section" class="themed-card rounded-2xl shadow-lg p-5">
                    <h3 class="text-lg font-bold mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
                    <div id="notes-list" class="grid gap-3">
                        <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
                    </div>
                </section>
                
                <section id="map-container-section" class="themed-card rounded-2xl shadow-lg p-5 hidden">
                    <h3 class="text-lg font-bold mb-3">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
                    <div id="route-map"></div>
                    <div id="map-legend" class="mt-4 space-y-2 text-sm"></div>
                </section>

                <section class="flex justify-center gap-3">
                    <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fa-solid fa-wand-magic-sparkles"></i>
                        ×¦×•×¨ ×œ×•×–
                    </a>
                    <a id="edit-schedule-btn" href="#" class="hidden items-center gap-2 bg-gradient-to-r from-green-500 to-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fa-solid fa-pen"></i>
                        ×¢×¨×•×š ×œ×•×–
                    </a>
                </section>

            </div>
        </main>
    </div>
    
    <div id="item-detail-modal" class="item-detail-modal">
        <div id="item-detail-modal-content" class="item-detail-modal-content">
            </div>
    </div>
    
    <div id="ref-detail-modal" class="item-detail-modal">
        <div id="ref-detail-modal-content" class="item-detail-modal-content">
            </div>
    </div>


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import {
    getFirestore, doc, getDoc, collection, onSnapshot, query, updateDoc, setDoc,
    enableIndexedDbPersistence
} from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // ---------- Firebase & Constants ----------
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // --- ×”×•×¡×¤×ª ×™×›×•×œ×•×ª ××•×¤×œ×™×™×Ÿ ---
        enableIndexedDbPersistence(db).catch((err) => {
          if (err.code === 'failed-precondition') {
            console.warn("Persistence × ×›×©×œ â€“ ×™×© ×™×•×ª×¨ ××“×™ ×˜××‘×™× ×¤×ª×•×—×™×.");
          } else if (err.code === 'unimplemented') {
            console.warn("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘Ö¾Persistence.");
          }
        });
        
        const IMAGE_WORKER_URL = "https://yellow-cloud-3f13.doronenakache.workers.dev/";

        // ---------- State ----------
        let currentUser = null;
        let tripId = null;
        let tripData = null;
        let dateStr = null;
        let dateISO = null;
        let dayNameHe = "";
        let destForDate = null;
        let destId = null; // ---× ×•×¡×£--- ××©×ª× ×” ×œ×©××™×¨×ª ××–×”×” ×”×™×¢×“ ××”-URL
        let currentScheduleItems = [];
        let mapInstance = null;
        let modalMapInstance = null;
        let refModalMapInstance = null;
        let currentLayout = 'default';
        let currentThemeKey = 'light';
        let currentCustomTheme = {};
        let isSmartAccordionActive = false;
        const accordionMaps = {};
        let smartAccordionInterval = null;
        let currentRouteLayer = null;

        // ---------- UI Elements ----------
        const initialLoader = document.getElementById('initial-loader');
        const mainContent = document.getElementById('main-content');
        const pageBg = document.getElementById('page-bg');
        const pageBgOverlay = document.getElementById('page-bg-overlay');
        const loaderBg = document.getElementById('loader-bg');
        
        const sidebar = document.getElementById('sidebar');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const overlay = document.getElementById('overlay');
        const mainMenu = document.getElementById('main-menu');
        
        const settingsModal = document.getElementById('settings-modal');
        const settingsBtn = document.getElementById('settings-btn');
        const closeSettingsBtn = document.getElementById('close-settings-btn');
        const customThemeControls = document.getElementById('custom-theme-controls');
        const smartAccordionControls = document.getElementById('smart-accordion-controls');
        const smartAccordionToggle = document.getElementById('smart-accordion-toggle');

        // BG Image uploader elements
        const bgImageUploadBtn = document.getElementById('bg-image-upload-btn');
        const bgImageRemoveBtn = document.getElementById('bg-image-remove-btn');
        const bgImageUploadInput = document.getElementById('bg-image-upload-input');
        const bgImageUrlStorage = document.getElementById('bg-image-url-storage');
        const bgImageStatus = document.getElementById('bg-image-status');
        const bgColorPicker = document.getElementById('bg-color-picker');

        const authContainer = document.getElementById('auth-container');
        const tripHomeBtn = document.getElementById('trip-home-btn');
        const scheduleHeadline = document.getElementById('schedule-headline');
        const dayTitleEl = document.getElementById('day-title');
        const tripSubtitle = document.getElementById('trip-subtitle');
        const dateChip = document.getElementById('date-chip');

        const noScheduleBox = document.getElementById('no-schedule');
        const timelineBox = document.getElementById('timeline');
        const createBtn = document.getElementById('create-schedule-btn');
        const editBtn = document.getElementById('edit-schedule-btn');
        
        const notesList = document.getElementById('notes-list');
        const mapContainerSection = document.getElementById('map-container-section');
        const mapLegend = document.getElementById('map-legend');

        const itemDetailModal = document.getElementById('item-detail-modal');
        const itemDetailModalContent = document.getElementById('item-detail-modal-content');
        const refDetailModal = document.getElementById('ref-detail-modal');
        const refDetailModalContent = document.getElementById('ref-detail-modal-content');

        // ---------- Helpers ----------
        function toggleSidebar() { 
            sidebar.classList.toggle('translate-x-full'); 
            overlay.classList.toggle('hidden'); 
            settingsModal.classList.add('translate-x-full');
        }
        function toggleSettings() { 
            settingsModal.classList.toggle('translate-x-full'); 
            overlay.classList.toggle('hidden'); 
            sidebar.classList.add('translate-x-full');
            configureBgSettingsUI();
        }
        
        function parseLocalDateFlexible(s) { if (!s) return null; const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/); if (!m) return null; let d = +m[1], mo = +m[2], y = +m[3]; if (y < 100) y += 2000; const dt = new Date(Date.UTC(y, mo-1, d)); return isNaN(dt.getTime()) ? null : dt; }
        function toISODateUTC(d) { const yyyy = d.getUTCFullYear(); const mm = String(d.getUTCMonth()+1).padStart(2,'0'); const dd = String(d.getUTCDate()).padStart(2,'0'); return `${yyyy}-${mm}-${dd}`; }
        function hebWeekdayUTC(d) { const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª']; return names[d.getUTCDay()]; }
        function generateDatesFromRange(rangeStr) { if (!rangeStr || !rangeStr.includes(' - ')) return []; const [startStr, endStr] = rangeStr.split(' - '); const start = parseLocalDateFlexible(startStr); const end = parseLocalDateFlexible(endStr); if (!start || !end) return []; const out = []; for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) { out.push(new Date(t.getTime())); } return out; }
        
        // ---× ××—×§--- ×”×¤×•× ×§×¦×™×” ×”×™×©× ×” ×›×‘×¨ ×œ× × ×—×•×¦×” ×›×™ ×”×™× ×’×¨××” ×œ×‘××’
        // function findDestinationForDate(trip, rawDDMMYYYY) { ... }

        function hexToRgb(hex) {
            let result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
            return result ? { r: parseInt(result[1], 16), g: parseInt(result[2], 16), b: parseInt(result[3], 16) } : null;
        }
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Radius of the earth in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c; // Distance in km
        }

        // ---------- Styling & Layout Functions ----------
        function setBackground(bg) { 
            if (bg.type === 'image') { 
                pageBg.style.backgroundImage = `url('${bg.value}')`; 
                document.body.style.backgroundColor = ''; 
            } else { 
                pageBg.style.backgroundImage = 'none'; 
                document.body.style.backgroundColor = bg.value; 
            } 
            const overlayOpacity = 1 - (bg.brightness / 100); 
            pageBgOverlay.style.backgroundColor = `rgba(0, 0, 0, ${overlayOpacity})`; 
        }

        function setTheme(themeKey, customThemeData = null) { 
            const theme = themePresets[themeKey]; 
            if(!theme) return; 
            currentThemeKey = themeKey; 

            let finalTheme = theme;
            if (themeKey === 'custom' && customThemeData) {
                finalTheme = { ...theme, ...customThemeData };
            } else if (themeKey === 'custom') {
                 finalTheme = { ...theme, ...currentCustomTheme };
            }

            document.documentElement.style.setProperty('--card-bg', finalTheme.cardBg); 
            document.documentElement.style.setProperty('--card-text-color', finalTheme.cardText); 
            document.documentElement.style.setProperty('--card-secondary-text-color', finalTheme.cardSecondaryText); 
            document.documentElement.style.setProperty('--card-border-color', finalTheme.cardBorder); 
            
            document.querySelectorAll('.theme-preset-btn').forEach(btn => btn.classList.remove('selected-theme')); 
            const selectedBtn = document.querySelector(`.theme-preset-btn[data-theme="${themeKey}"]`);
            if (selectedBtn) selectedBtn.classList.add('selected-theme');
            
            customThemeControls.classList.toggle('hidden', themeKey !== 'custom');
            
            renderTimelineFromItems(currentScheduleItems); 
            
            setTimeout(() => { 
                if (mapInstance) mapInstance.invalidateSize(); 
                if(modalMapInstance) modalMapInstance.invalidateSize(); 
                Object.values(accordionMaps).forEach(m => m.invalidateSize()); 
            }, 300); 
        }
        function setCurrentLayout(layout, smartAccordion = false) { 
            currentLayout = layout; 
            isSmartAccordionActive = smartAccordion;

            const showSmartControls = layout.includes('accordion');
            smartAccordionControls.classList.toggle('hidden', !showSmartControls);
            if (showSmartControls) {
                smartAccordionToggle.checked = isSmartAccordionActive;
            } else {
                isSmartAccordionActive = false;
            }

            if (smartAccordionInterval) {
                clearInterval(smartAccordionInterval);
                smartAccordionInterval = null;
            }
            if (isSmartAccordionActive) {
                updateSmartAccordionState();
                smartAccordionInterval = setInterval(updateSmartAccordionState, 30000);
            }

            timelineBox.className = `timeline`; // Reset classes
            if (!['table', 'condensed-list'].includes(layout)) {
                timelineBox.classList.add('space-y-4');
            }
            timelineBox.classList.add(`layout-${layout}`);
            
            const radio = document.querySelector(`input[name="timeline-layout"][value="${layout}"]`);
            if(radio) radio.checked = true; 
            
            renderTimelineFromItems(currentScheduleItems); 
        }
        
        // ---------- Image Upload Logic ----------
        async function handleImageUpload(file, urlStorageElement, statusElement, onCompleteCallback) {
            if (!file) return;

            statusElement.textContent = '';
            statusElement.className = 'status-text text-sm mt-2 text-slate-400 h-5';
            
            if (!file.type.startsWith('image/')) {
                statusElement.textContent = '×™×© ×œ×‘×—×•×¨ ×§×•×‘×¥ ×ª××•× ×” ×‘×œ×‘×“.';
                statusElement.classList.add('err');
                return;
            }
            if (file.size > 5 * 1024 * 1024) { // 5MB limit
                statusElement.textContent = '×”×§×•×‘×¥ ×’×“×•×œ ××“×™ (×¢×“ 5MB).';
                statusElement.classList.add('err');
                return;
            }

            statusElement.textContent = '××¢×œ×” ×ª××•× ×”...';
            const formData = new FormData();
            formData.append('image', file);

            try {
                const response = await fetch(IMAGE_WORKER_URL, { method: 'POST', body: formData });
                const result = await response.json();

                if (!response.ok || !result.data?.url) {
                    throw new Error(result.error?.message || '×©×’×™××” ×œ× ×™×“×•×¢×” ××”×©×¨×ª');
                }

                const imageUrl = result.data.url;
                urlStorageElement.value = imageUrl;
                statusElement.textContent = '×”×”×¢×œ××” ×”×•×©×œ××”!';
                statusElement.classList.add('ok');

                if (onCompleteCallback) onCompleteCallback(imageUrl);
                
                setTimeout(() => { statusElement.textContent = ''; statusElement.className = 'status-text text-sm mt-2 text-slate-400 h-5'; }, 3000);

            } catch (error) {
                console.error('Image upload failed:', error);
                statusElement.textContent = `×©×’×™××”: ${error.message}`;
                statusElement.classList.add('err');
            }
        }

        function configureBgSettingsUI() {
            const hasBgImage = !!bgImageUrlStorage.value;
            bgImageUploadBtn.innerHTML = hasBgImage 
                ? '<i class="fas fa-sync-alt mr-1"></i> ×©× ×” ×ª××•× ×”' 
                : '<i class="fas fa-upload mr-1"></i> ×”×¢×œ×” ×ª××•× ×”';
            bgImageRemoveBtn.classList.toggle('hidden', !hasBgImage);
        }

        // ---------- Rendering Functions ----------
        function buildMenuFromTrip() {
            mainMenu.innerHTML = '';
            if (!tripData?.destinations) return;
            tripData.destinations.forEach(dest => {
                const div = document.createElement('div');
                const btn = document.createElement('button');
                btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
                btn.innerHTML = `<span>${dest.nameHe || dest.name} ${dest.emoji || ''}</span> <i class="fas fa-chevron-down transition-transform"></i>`;
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dObj => {
                    const day = hebWeekdayUTC(dObj);
                    const date = `${dObj.getUTCDate()}.${dObj.getUTCMonth()+1}.${dObj.getUTCFullYear()}`;
                    const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
                    const a = document.createElement('a');
                    // ---×ª×™×§×•×Ÿ---: ×”×•×¡×¤×ª destId ×œ×›×ª×•×‘×ª ×”-URL
                    a.href = `?tripId=${tripId}&date=${encodeURIComponent(nice)}&destId=${dest.id}`;
                    a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
                    a.textContent = `${day} ${date} (${dest.nameHe} ${dest.emoji || ''})`;
                    submenu.appendChild(a);
                });
                btn.addEventListener('click', () => { submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); });
                div.append(btn, submenu);
                mainMenu.appendChild(div);
            });
        }

        function renderHeadline(dayTitleFromDoc = null) {
            const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
            const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
            scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
            dayTitleEl.textContent = dayTitleFromDoc ? `${dayTitleFromDoc} â€¢ ${dateStr}` : `×œ×•×– ×œ×™×•× ${dateStr}`;
            tripSubtitle.textContent = `${destName}${dayPart ? ' â€¢' + dayPart : ''}`;
            dateChip.textContent = dateStr;
        }

        function itemEmoji(it) { 
            if (it.travel?.from?.label || it.travel?.to?.label) return 'ğŸ—ºï¸';
            if (it.address?.label) return 'ğŸ“';
            return 'ğŸš¶â€â™‚ï¸';
        }
        function timeText(it) { if (!it?.startTime && !it?.endTime) return '--:--'; return [it.startTime || '', it.endTime ? 'â€“ '+it.endTime : ''].filter(Boolean).join(' '); }
        
        function getFullItemDetailsHTML(it, index) {
            const hasAddr = !!it.address?.label;
            const hasTravel = !!(it.travel?.from?.lat && it.travel?.from?.lng && it.travel?.to?.lat && it.travel?.to?.lng);
            const hasSite = !!it.links?.site;
            const hasBook = !!it.links?.booking;
            const refs = Array.isArray(it.refs)? it.refs : [];

            const refsHtml = refs.map(r=>{ 
                const icon = r.type==='logistics' ? (r.subType==='hotel'?'ğŸ¨':r.subType==='flight'?'âœˆï¸':r.subType==='train'?'ğŸš†':r.subType==='car_rental'?'ğŸš—':r.subType==='ferry'?'â›´ï¸':'â¬…ï¸') : 'ğŸ“'; 
                return `<button class="action-button ref open-ref-modal-btn" data-ref-type="${r.type}" data-ref-id="${r.id}">${icon} ${r.label}</button>`; 
            }).join(' ');

            const linksHtml = [ 
                hasSite ? `<a href="${it.links.site}" target="_blank" class="action-button site"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '', 
                hasBook ? `<a href="${it.links.booking}" target="_blank" class="action-button booking"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '', 
                refsHtml 
            ].filter(Boolean).join(' ');

            const navHtml = hasAddr ? `<div class="flex gap-2"><a href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button waze"><i class="fa-brands fa-waze"></i> Waze</a><a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a></div>` : '';
            
            let travelHtml = '';
            if (it.travel?.from?.label || it.travel?.to?.label) {
                let airDistanceHtml = '';
                if(hasTravel) {
                    const dist = calculateDistance(it.travel.from.lat, it.travel.from.lng, it.travel.to.lat, it.travel.to.lng);
                    airDistanceHtml = ` â€¢ ××¨×—×§ ××•×•×™×¨×™: ${dist.toFixed(1)} ×§"×`;
                }
                travelHtml = `<div class="mt-2 text-sm" style="color: var(--card-secondary-text-color)"><i class="fa-solid fa-route text-slate-400"></i> ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''} ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''} ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}${airDistanceHtml}</div>`;
            }

            const mapHtml = (currentLayout.includes('accordion-full') && (hasAddr || hasTravel)) ? `<div id="accordion-map-${index}" class="accordion-map-container h-64 w-full mt-4 rounded-lg z-0 border"></div>` : '';

            return `
                ${it.description ? `<p class="mt-2 whitespace-pre-wrap">${it.description}</p>` : ''}
                ${hasAddr ? `<div class="mt-2 text-sm"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>` : ''}
                ${travelHtml}
                <div class="mt-3 flex flex-wrap gap-2">${linksHtml}</div>
                <div class="mt-2">${navHtml}</div>
                ${mapHtml}
            `;
        }
        
        function renderTimelineFromItems(items) {
            Object.values(accordionMaps).forEach(map => {
                if (map) map.remove();
            });
            for (const key in accordionMaps) {
                delete accordionMaps[key];
            }

            currentScheduleItems = items;
            if (!items || items.length === 0) {
                noScheduleBox.parentElement.classList.remove('hidden');
                noScheduleBox.classList.remove('hidden');
                timelineBox.classList.add('hidden');
                createBtn.classList.remove('hidden');
                editBtn.classList.add('hidden');
                mapContainerSection.classList.add('hidden');
                return;
            }
            noScheduleBox.parentElement.classList.remove('hidden');
            noScheduleBox.classList.add('hidden');
            timelineBox.classList.remove('hidden');
            timelineBox.innerHTML = '';
            createBtn.classList.add('hidden');
            editBtn.classList.remove('hidden');
            editBtn.classList.add('inline-flex');

            if (currentLayout === 'table') {
                const tableHtml = `
                    <div class="themed-card rounded-lg shadow">
                        <table>
                            <thead>
                                <tr>
                                    <th>×©×¢×”</th>
                                    <th>×¤×¢×™×œ×•×ª</th>
                                    <th>×¤×¢×•×œ×•×ª</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${items.map((it, index) => `
                                    <tr>
                                        <td>${timeText(it)}</td>
                                        <td>
                                            <p class="font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</p>
                                            ${it.summary ? `<p class="text-sm">${it.summary}</p>` : ''}
                                        </td>
                                        <td>
                                            <div class="flex items-center justify-end gap-2">
                                                ${it.address?.label ? `<a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps" title="× ×™×•×•×˜ ×‘-Google Maps"><i class="fa-solid fa-map-location-dot"></i></a>` : ''}
                                                ${it.links?.site ? `<a href="${it.links.site}" target="_blank" class="action-button site" title="×§×™×©×•×¨ ×œ××ª×¨"><i class="fa-solid fa-link"></i></a>` : ''}
                                                <button class="action-button details open-modal-btn" data-index="${index}" title="×¤×¨×˜×™× ××œ××™×"><i class="fa-solid fa-info-circle"></i></button>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                timelineBox.innerHTML = tableHtml;
            } else if (currentLayout === 'condensed-list') {
                const listContainer = document.createElement('div');
                listContainer.className = 'themed-card rounded-lg shadow p-2';
                listContainer.innerHTML = items.map((it, index) => `
                    <div class="timeline-item-wrapper open-modal-btn cursor-pointer hover:bg-slate-50" data-index="${index}">
                        <div class="time-block">${timeText(it)}</div>
                        <div class="details-block">
                            <p class="font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</p>
                            ${it.summary ? `<p class="text-sm">${it.summary}</p>` : ''}
                        </div>
                    </div>
                `).join('');
                timelineBox.appendChild(listContainer);
            } else {
                items.forEach((it, index) => {
                    const itemWrapper = document.createElement('div');
                    itemWrapper.className = 'timeline-item-wrapper';
                    itemWrapper.id = `timeline-item-${index}`;
                    let itemHtml;
                    const isLineStyle = currentLayout.startsWith('line-style');

                    if (isLineStyle) {
                        const isAccordion = currentLayout.includes('accordion');
                        if (isAccordion) {
                             const isFullAccordion = currentLayout.includes('full');
                             const summaryContent = `<div class="flex items-center justify-between p-4"><div class="flex items-center gap-3"><span class="text-xl">${itemEmoji(it)}</span><h4 class="font-bold text-lg break-words">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4></div><i class="fas fa-chevron-down chevron-icon"></i></div>`;
                             const detailsContent = isFullAccordion
                                ? getFullItemDetailsHTML(it, index)
                                : `${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal-btn" data-index="${index}">×¤×¨×˜×™× ××œ××™×...</button>`;

                            itemHtml = `
                                <div class="timeline-time-outside">${timeText(it)}</div>
                                <details id="details-${index}" class="group accordion-item themed-card rounded-lg shadow-sm" style="padding-right: 0;">
                                    <summary>${summaryContent}</summary>
                                    <div class="p-4 pt-0 pr-12"><div class="border-t pt-3" style="border-color: var(--card-border-color);">${detailsContent}</div></div>
                                </details>`;
                        } else { // line-style default
                            itemHtml = `
                                <div class="timeline-time-outside">${timeText(it)}</div>
                                <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal-btn" data-index="${index}">
                                    <div class="flex items-center gap-3">
                                        <span class="text-xl">${itemEmoji(it)}</span>
                                        <h4 class="font-bold text-lg break-words">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                                    </div>
                                </div>`;
                        }
                    } else if (currentLayout.startsWith('accordion')) {
                        const summaryContent = `<div class="flex items-center justify-between p-4"><div class="flex items-center gap-4"><span class="text-2xl">${itemEmoji(it)}</span><div><h4 class="font-bold text-lg">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4><p class="text-sm font-mono" style="color: var(--card-secondary-text-color);">${timeText(it)}</p></div></div><i class="fas fa-chevron-down chevron-icon"></i></div>`;
                        const detailsContent = currentLayout === 'accordion-summary' 
                            ? `${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}<button class="text-blue-600 font-bold mt-2 text-sm open-modal-btn" data-index="${index}">×¤×¨×˜×™× ××œ××™×...</button>`
                            : getFullItemDetailsHTML(it, index);
                        itemHtml = `
                            <details id="details-${index}" class="group accordion-item themed-card rounded-lg shadow-sm" style="padding-right: 0;">
                                <summary>${summaryContent}</summary>
                                <div class="p-4 pt-0 pr-12"><div class="border-t pt-3" style="border-color: var(--card-border-color);">${detailsContent}</div></div>
                            </details>`;
                    } else { // default layout
                        const navLink = it.address?.label ? `<a href="https://maps.google.com/maps?q=${encodeURIComponent(it.address.label)}" target="_blank" class="action-button gmaps"><i class="fa-solid fa-map-location-dot"></i></a>` : '';
                        const siteLink = it.links?.site ? `<a href="${it.links.site}" target="_blank" class="action-button site"><i class="fa-solid fa-link"></i></a>` : '';
                        itemHtml = `
                            <div class="themed-card rounded-lg shadow p-4 cursor-pointer open-modal-btn" data-index="${index}">
                                <div class="text-sm font-bold" style="color: var(--card-secondary-text-color);">${timeText(it)}</div>
                                <h4 class="text-lg font-bold mt-1">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                                ${it.summary ? `<p class="mt-1 text-sm">${it.summary}</p>` : ''}
                                <div class="flex gap-2 mt-2 pt-2 border-t" style="border-color: var(--card-border-color);">
                                    ${navLink} ${siteLink}
                                </div>
                            </div>`;
                    }
                    
                    itemWrapper.innerHTML = itemHtml;
                    timelineBox.appendChild(itemWrapper);
                });
            }
            
            // Attach all event listeners after HTML is in the DOM
            timelineBox.querySelectorAll('.open-modal-btn').forEach(btn => {
                const index = btn.dataset.index;
                btn.addEventListener('click', (e) => { e.stopPropagation(); showItemDetailModal(items[index]); });
            });
            timelineBox.querySelectorAll('.open-ref-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    showRefDetailModal(btn.dataset.refType, btn.dataset.refId); 
                });
            });
            
            document.querySelectorAll('details.accordion-item').forEach((detailsEl) => {
                const index = detailsEl.id.split('-')[1];
                const item = items[index];
                
                detailsEl.addEventListener('toggle', () => {
                    const mapContainerId = `accordion-map-${index}`;
                    if (detailsEl.open && !accordionMaps[mapContainerId] && (item.address?.lat || (item.travel?.from?.lat && item.travel?.to?.lat))) {
                        const mapContainer = detailsEl.querySelector(`#${mapContainerId}`);
                        if (mapContainer) {
                            setTimeout(() => {
                                const accordionMap = L.map(mapContainerId);
                                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(accordionMap);
                                
                                setupRouteOnMap(accordionMap, item);
                                
                                accordionMaps[mapContainerId] = accordionMap;
                            }, 50);
                        }
                    }
                });
            });

            if(isSmartAccordionActive) updateSmartAccordionState();
            renderRouteMap(items);
        }

        function updateSmartAccordionState() {
            if (!isSmartAccordionActive || currentScheduleItems.length === 0) return;

            const now = new Date();
            const nowMinutes = now.getHours() * 60 + now.getMinutes();
            let activeIndex = -1;

            for (let i = 0; i < currentScheduleItems.length; i++) {
                const item = currentScheduleItems[i];
                if (!item.startTime) continue;
                
                const startMinutes = parseInt(item.startTime.split(':')[0]) * 60 + parseInt(item.startTime.split(':')[1]);
                
                let endMinutes;
                if (item.endTime) {
                    endMinutes = parseInt(item.endTime.split(':')[0]) * 60 + parseInt(item.endTime.split(':')[1]);
                } else {
                    const currentItemSort = item.sort;
                    const nextItem = currentScheduleItems.slice().sort((a,b) => a.sort - b.sort).find(it => it.sort > currentItemSort && it.startTime);
                    if (nextItem) {
                        endMinutes = parseInt(nextItem.startTime.split(':')[0]) * 60 + parseInt(nextItem.startTime.split(':')[1]);
                    } else {
                        endMinutes = 24 * 60; // End of day
                    }
                }

                if (nowMinutes >= startMinutes && nowMinutes < endMinutes) {
                    activeIndex = i;
                    break;
                }
            }

            document.querySelectorAll('.smart-accordion-active').forEach(el => el.classList.remove('smart-accordion-active'));

            if (activeIndex !== -1) {
                const activeDetails = document.getElementById(`details-${activeIndex}`);
                if (activeDetails) {
                    if (!activeDetails.hasAttribute('data-user-opened')) {
                        document.querySelectorAll('details.accordion-item').forEach(d => {
                            if (d.id !== `details-${activeIndex}` && !d.hasAttribute('data-user-opened')) {
                                d.open = false;
                            }
                        });
                        if (!activeDetails.open) {
                           activeDetails.open = true;
                        }
                    }
                    activeDetails.classList.add('smart-accordion-active');
                }
            }
        }

        function openModal() {
            mainContent.style.filter = 'blur(4px)';
            mainContent.style.pointerEvents = 'none';
        }
        function closeModal() {
            mainContent.style.filter = 'none';
            mainContent.style.pointerEvents = 'auto';
        }

        function closeDetailModal() {
            if (modalMapInstance) { 
                if (currentRouteLayer) {
                    modalMapInstance.removeLayer(currentRouteLayer);
                    currentRouteLayer = null;
                }
                modalMapInstance.remove(); 
                modalMapInstance = null; 
            }
            itemDetailModal.classList.remove('visible');
            closeModal();
        }

        async function setupRouteOnMap(map, item) {
            const hasAddr = !!(item.address?.lat && item.address?.lng);
            const hasTravel = !!(item.travel?.from?.lat && item.travel?.from?.lng && item.travel?.to?.lat && item.travel?.to?.lng);

            if (currentRouteLayer && map.hasLayer(currentRouteLayer)) {
                map.removeLayer(currentRouteLayer);
            }

            if (hasTravel) {
                const a = item.travel.from;
                const b = item.travel.to;
                const profile = (item.travel.mode === 'foot') ? 'foot' : 'driving';
                const url = `https://router.project-osrm.org/route/v1/${profile}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
                
                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data?.routes?.[0]) {
                        const r = data.routes[0];
                        currentRouteLayer = L.geoJSON(r.geometry, { style: { color: 'blue', weight: 5 } }).addTo(map);
                        map.fitBounds(currentRouteLayer.getBounds(), { padding: [40, 40] });
                    }
                } catch (e) {
                    console.error("Could not fetch route from OSRM", e);
                    // Fallback to straight line
                    currentRouteLayer = L.polyline([[a.lat, a.lng], [b.lat, b.lng]], {color: 'red', dashArray: '5, 10'}).addTo(map);
                    map.fitBounds([[a.lat, a.lng], [b.lat, b.lng]], {padding: [40, 40]});
                }
                L.marker([a.lat, a.lng]).addTo(map).bindPopup(`×: ${item.travel.from.label}`);
                L.marker([b.lat, b.lng]).addTo(map).bindPopup(`××œ: ${item.travel.to.label}`);

            } else if (hasAddr) {
                map.setView([item.address.lat, item.address.lng], 15);
                L.marker([item.address.lat, item.address.lng]).addTo(map);
            }
        }

        function showItemDetailModal(it) {
            openModal();
            const hasAddr = !!(it.address?.lat && it.address?.lng);
            const hasTravel = !!(it.travel?.from?.lat && it.travel?.from?.lng && it.travel?.to?.lat && it.travel?.to?.lng);

            const headerHtml = `<div class="flex justify-between items-start"><div><div class="flex items-center gap-3"><span class="text-2xl">${itemEmoji(it)}</span><h3 class="text-2xl font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h3></div><div class="text-md font-semibold mt-1" style="color: var(--card-secondary-text-color)">${timeText(it)}</div></div><button id="close-detail-modal-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button></div>`;
            const fullDetailsHtml = getFullItemDetailsHTML(it);
            const mapHtml = (hasAddr || hasTravel) ? `<div id="modal-map" class="h-64 w-full mt-4 rounded-lg z-0 border"></div>` : '';
            
            itemDetailModalContent.innerHTML = `<div class="space-y-4">${headerHtml}<div class="border-t pt-4 space-y-3" style="border-color: var(--card-border-color);">${it.summary ? `<p class="text-lg italic" style="color: var(--card-secondary-text-color)">${it.summary}</p>` : ''}${fullDetailsHtml}</div>${mapHtml}</div>`;
            itemDetailModal.classList.add('visible');
            
            if (hasAddr || hasTravel) {
                setTimeout(() => {
                    const mapContainer = document.getElementById('modal-map');
                    if (mapContainer) {
                        modalMapInstance = L.map('modal-map');
                        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(modalMapInstance);
                        setupRouteOnMap(modalMapInstance, it);
                    }
                }, 50);
            }
            
            document.getElementById('close-detail-modal-btn').addEventListener('click', closeDetailModal);
            itemDetailModalContent.querySelectorAll('.open-ref-modal-btn').forEach(btn => {
                btn.addEventListener('click', (e) => { 
                    e.stopPropagation(); 
                    showRefDetailModal(btn.dataset.refType, btn.dataset.refId); 
                });
            });
        }

        const noteColorMap = { red: 'bg-red-200 border-red-300', green: 'bg-green-200 border-green-300', blue: 'bg-blue-200 border-blue-300', yellow: 'bg-yellow-200 border-yellow-300', orange: 'bg-orange-200 border-orange-300' };
        
        function renderNotesList(notes){
            if (!notes || notes.length===0){
                notesList.innerHTML = `<div style="color: var(--card-secondary-text-color);">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
                return;
            }
            notesList.innerHTML = notes.map(n=>{
                const cls = noteColorMap[n.color] || noteColorMap.yellow;
                return `<div class="border rounded-xl p-3 ${cls}"><div class="font-bold force-black-text">${n.kind}: ${n.title || 'â€”'}</div>${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap force-black-text-secondary">${n.details}</div>` : ''}</div>`;
            }).join('');
        }
        
        function renderRouteMap(items) {
            const allPoints = [];
            const pointLabels = new Set(); 

            items.forEach(item => {
                if (item.address && item.address.lat && item.address.lng) {
                    const label = `${item.address.lat},${item.address.lng}`;
                    if (!pointLabels.has(label)) {
                        allPoints.push({
                            ...item.address,
                            title: item.title 
                        });
                        pointLabels.add(label);
                    }
                }
                if (item.travel && item.travel.to && item.travel.to.lat && item.travel.to.lng) {
                    const label = `${item.travel.to.lat},${item.travel.to.lng}`;
                     if (!pointLabels.has(label)) {
                        allPoints.push({
                            ...item.travel.to,
                            title: item.title 
                        });
                        pointLabels.add(label);
                    }
                }
            });

            if (allPoints.length < 2) {
                mapContainerSection.classList.add('hidden');
                return;
            }

            mapContainerSection.classList.remove('hidden');
            if (mapInstance) { mapInstance.remove(); }
            mapInstance = L.map('route-map');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'Â© OpenStreetMap' }).addTo(mapInstance);
            
            const markers = [];
            const routeColors = ['#3b82f6', '#ef4444', '#10b981', '#f97316', '#8b5cf6', '#d946ef'];
            mapLegend.innerHTML = '<p class="font-bold">××§×¨× ××¡×œ×•×œ:</p>';

            allPoints.forEach((point, i) => {
                markers.push(L.marker([point.lat, point.lng]).addTo(mapInstance).bindPopup(`<b>${i + 1}. ${point.title}</b><br>${point.label}`));
                
                if (i > 0) {
                    const prevPoint = allPoints[i - 1];
                    const color = routeColors[(i - 1) % routeColors.length];
                    L.polyline([[prevPoint.lat, prevPoint.lng], [point.lat, point.lng]], { color: color }).addTo(mapInstance);
                    
                    const legendItem = document.createElement('div');
                    legendItem.className = 'flex items-center gap-2';
                    legendItem.innerHTML = `<span class="w-4 h-1 inline-block" style="background-color: ${color};"></span><span>×: ${prevPoint.label} <i class="fa-solid fa-arrow-left fa-xs"></i> ×œ: ${point.label}</span>`;
                    mapLegend.appendChild(legendItem);
                }
            });

            if (markers.length > 0) {
                mapInstance.fitBounds(new L.featureGroup(markers).getBounds().pad(0.2));
            }
        }

        // ---------- Event Listeners & Settings ----------
        const themePresets = {
            'custom': { name: '×”×ª×××” ××™×©×™×ª', desc: '×©× ×” ×œ×¤×™ ×‘×—×™×¨×ª×š', style: 'bg-slate-200 text-slate-800', cardBg: 'rgba(255, 255, 255, 0.85)', cardText: '#1e293b', cardSecondaryText: '#475569', cardBorder: 'rgba(226, 232, 240, 0.7)', bgHex: '#ffffff', opacity: 85 },
            'light': { name: '×‘×”×™×¨', desc: '×œ×‘×Ÿ, ×˜×§×¡×˜ ×©×—×•×¨', style: 'bg-white text-slate-800', cardBg: 'rgba(255, 255, 255, 0.9)', cardText: '#1e293b', cardSecondaryText: '#475569', cardBorder: 'rgba(226, 232, 240, 0.7)', bgHex: '#ffffff', opacity: 90 },
            'dark': { name: '×›×”×”', desc: '×›×”×”, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-slate-800 text-white', cardBg: 'rgba(30, 41, 59, 0.9)', cardText: '#f1f5f9', cardSecondaryText: '#94a3b8', cardBorder: 'rgba(51, 65, 85, 0.8)', bgHex: '#1e293b', opacity: 90 },
            'glass': { name: '×–×›×•×›×™×ª', desc: '×©×§×•×£, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-slate-700/50 text-white', cardBg: 'rgba(255, 255, 255, 0.2)', cardText: '#ffffff', cardSecondaryText: 'rgba(226, 232, 240, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#ffffff', opacity: 20 },
            'ocean': { name: '××•×§×™×™× ×•×¡', desc: '×›×—×•×œ, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-cyan-700 text-white', cardBg: 'rgba(14, 116, 144, 0.9)', cardText: '#f0f9ff', cardSecondaryText: '#a5f3fc', cardBorder: 'rgba(103, 232, 249, 0.3)', bgHex: '#0e7490', opacity: 90 },
            'sunset': { name: '×©×§×™×¢×”', desc: '×›×ª×•×, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-orange-500 text-white', cardBg: 'rgba(234, 88, 12, 0.9)', cardText: '#fff7ed', cardSecondaryText: '#fed7aa', cardBorder: 'rgba(251, 146, 60, 0.4)', bgHex: '#ea580c', opacity: 90 },
            'forest': { name: '×™×¢×¨', desc: '×™×¨×•×§, ×˜×§×¡×˜ ×œ×‘×Ÿ', style: 'bg-green-800 text-white', cardBg: 'rgba(22, 101, 52, 0.9)', cardText: '#f0fdf4', cardSecondaryText: '#bbf7d0', cardBorder: 'rgba(74, 222, 128, 0.3)', bgHex: '#166534', opacity: 90 },
            'lavender': { name: '×œ×‘× ×“×¨', desc: '×¡×’×•×œ ×‘×”×™×¨, ×˜×§×¡×˜ ×›×”×”', style: 'bg-violet-200 text-violet-900', cardBg: 'rgba(237, 233, 254, 0.9)', cardText: '#4c1d95', cardSecondaryText: '#6d28d9', cardBorder: 'rgba(196, 181, 253, 0.8)', bgHex: '#ede9fe', opacity: 90 },
            'sand': { name: '×—×•×œ', desc: '×¦×”×‘×”×‘, ×˜×§×¡×˜ ×—×•×', style: 'bg-amber-100 text-amber-900', cardBg: 'rgba(254, 243, 199, 0.9)', cardText: '#78350f', cardSecondaryText: '#92400e', cardBorder: 'rgba(252, 211, 77, 0.7)', bgHex: '#fef3c7', opacity: 90 },
            'sunrise': { name: '×–×¨×™×—×”', desc: '×’×¨×“×™×× ×˜ ×›×ª×•×-×•×¨×•×“', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #FFD3A5 0%, #FD6585 100%)', cardText: '#431c4f', cardSecondaryText: 'rgba(67, 28, 79, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#FFD3A5', opacity: 100 },
            'twilight': { name: '×“××“×•××™×', desc: '×’×¨×“×™×× ×˜ ×¡×’×•×œ-×›×—×•×œ', style: 'text-white', cardBg: 'linear-gradient(135deg, #3023AE 0%, #c86dd7 100%)', cardText: '#ffffff', cardSecondaryText: 'rgba(230, 230, 255, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#3023AE', opacity: 100 },
            'minty': { name: '×× ×˜×”', desc: '×’×¨×“×™×× ×˜ ×™×¨×•×§-×¦×”×•×‘', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #96fbc4 0%, #f9f586 100%)', cardText: '#044343', cardSecondaryText: 'rgba(4, 67, 67, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.5)', bgHex: '#96fbc4', opacity: 100 },
            'rose_gold': { name: '×¨×•×– ×’×•×œ×“', desc: '×’×¨×“×™×× ×˜ ×•×¨×•×“-×–×”×‘', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #f0c793 0%, #d9a7c7 100%)', cardText: '#5d4157', cardSecondaryText: 'rgba(93, 65, 87, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.4)', bgHex: '#f0c793', opacity: 100 },
            'paper': { name: '× ×™×™×¨', desc: '×§×¨×, ×˜×§×¡×˜ ×—×•×', style: 'bg-amber-50 text-amber-900', cardBg: 'rgba(254, 252, 247, 0.9)', cardText: '#583c27', cardSecondaryText: '#8a6e59', cardBorder: 'rgba(214, 203, 189, 0.8)', bgHex: '#fefcf7', opacity: 90 },
            'deep_space': { name: '×—×œ×œ ×¢××•×§', desc: '×©×—×•×¨, ×˜×§×¡×˜ ×–×•×”×¨', style: 'text-gray-200', cardBg: 'linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%)', cardText: '#e0e0e0', cardSecondaryText: '#a0a0c0', cardBorder: '#3d3470', bgHex: '#0f0c29', opacity: 100 },
            'tropical': { name: '×˜×¨×•×¤×™', desc: '×’×¨×“×™×× ×˜ ×™×¨×•×§-×›×—×•×œ', style: 'text-white', cardBg: 'linear-gradient(135deg, #00F260 0%, #0575E6 100%)', cardText: '#ffffff', cardSecondaryText: 'rgba(230, 255, 255, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.3)', bgHex: '#00F260', opacity: 100 },
            'coral_reef': { name: '×©×•× ×™×ª ××œ××•×’×™×', desc: '×’×¨×“×™×× ×˜ ×•×¨×•×“-×›×ª×•×', style: 'text-slate-800', cardBg: 'linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%)', cardText: '#8a2326', cardSecondaryText: 'rgba(138, 35, 38, 0.8)', cardBorder: 'rgba(255, 255, 255, 0.4)', bgHex: '#ff9a9e', opacity: 100 }
        };

        function attachEvents() {
            hamburgerBtn.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', toggleSidebar);
            settingsBtn.addEventListener('click', toggleSettings);
            closeSettingsBtn.addEventListener('click', toggleSettings);
            overlay.addEventListener('click', () => { sidebar.classList.add('translate-x-full'); settingsModal.classList.add('translate-x-full'); overlay.classList.add('hidden'); });
            tripHomeBtn.href = 'index.html';
            itemDetailModal.addEventListener('click', (e) => { if (e.target === itemDetailModal) closeDetailModal(); });
            refDetailModal.addEventListener('click', (e) => { if (e.target === refDetailModal) closeRefDetailModal(); });

            document.querySelectorAll('.settings-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.settings-nav-btn').forEach(b => { b.classList.remove('bg-slate-200'); b.classList.add('text-slate-500'); });
                    btn.classList.add('bg-slate-200'); btn.classList.remove('text-slate-500');
                    const panelId = `settings-panel-${btn.dataset.panel}`;
                    document.querySelectorAll('.settings-panel').forEach(p => p.classList.add('hidden'));
                    document.getElementById(panelId).classList.remove('hidden');
                });
            });

            // BG Settings Events
            bgImageUploadBtn.addEventListener('click', () => bgImageUploadInput.click());
            bgImageUploadInput.addEventListener('change', (e) => {
                const file = e.target.files?.[0];
                if (file) {
                    handleImageUpload(file, bgImageUrlStorage, bgImageStatus, (url) => {
                        setBackground({ type: 'image', value: url, brightness: document.getElementById('bg-brightness-slider').value });
                        configureBgSettingsUI();
                    });
                }
                e.target.value = null;
            });
            bgImageRemoveBtn.addEventListener('click', () => {
                bgImageUrlStorage.value = '';
                setBackground({ type: 'color', value: bgColorPicker.value, brightness: document.getElementById('bg-brightness-slider').value });
                configureBgSettingsUI();
                bgImageStatus.textContent = '×”×ª××•× ×” ×”×•×¡×¨×”.';
                setTimeout(() => bgImageStatus.textContent = '', 2000);
            });

            document.getElementById('apply-bg-settings').addEventListener('click', () => {
                const url = bgImageUrlStorage.value;
                const color = bgColorPicker.value;
                const brightness = document.getElementById('bg-brightness-slider').value;
                const bgSettings = { type: url ? 'image' : 'color', value: url || color, brightness: brightness };
                setBackground(bgSettings);
                saveStyleSetting('background', bgSettings, document.getElementById('bg-scope').value);
                toggleSettings();
            });

            document.getElementById('apply-layout-settings').addEventListener('click', () => {
                const newLayout = document.querySelector('input[name="timeline-layout"]:checked').value;
                const smartAccordion = smartAccordionToggle.checked;
                setCurrentLayout(newLayout, smartAccordion);
                saveStyleSetting('layout', { layout: newLayout, smart: smartAccordion }, document.getElementById('layout-scope').value);
                toggleSettings();
            });

            document.querySelectorAll('input[name="timeline-layout"]').forEach(radio => {
                radio.addEventListener('change', (event) => {
                    const showSmartControls = event.target.value.includes('accordion');
                    smartAccordionControls.classList.toggle('hidden', !showSmartControls);
                });
            });

            smartAccordionToggle.addEventListener('change', () => {
                isSmartAccordionActive = smartAccordionToggle.checked;
                const currentlySelectedLayout = document.querySelector('input[name="timeline-layout"]:checked').value;
                setCurrentLayout(currentlySelectedLayout, isSmartAccordionActive);
            });
            
            const presetsContainer = document.getElementById('theme-presets-container');
            presetsContainer.innerHTML = Object.entries(themePresets).map(([key, theme]) => {
                const bgStyle = theme.cardBg.includes('gradient') ? `background: ${theme.cardBg}; border-color: transparent;` : '';
                return `
                <button data-theme="${key}" id="theme-btn-${key}" class="theme-preset-btn p-3 border rounded-lg text-center ${theme.style}" style="${bgStyle}">
                    <span class="font-bold text-sm override-text-color">${theme.name}</span> 
                    <div class="text-xs override-text-color">${theme.desc}</div>
                </button>
                `
            }).join('');

            document.querySelectorAll('.theme-preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const themeKey = btn.dataset.theme;
                    const newTheme = themePresets[themeKey];
                    if (newTheme) {
                        setTheme(themeKey);
                        document.getElementById('card-bg-color-picker').value = newTheme.bgHex;
                        document.getElementById('card-opacity-slider').value = newTheme.opacity;
                        document.getElementById('card-text-color-picker').value = newTheme.cardText;
                    }
                });
            });

            function updateCustomThemePreview() {
                const bgColor = document.getElementById('card-bg-color-picker').value;
                const opacity = document.getElementById('card-opacity-slider').value;
                const textColor = document.getElementById('card-text-color-picker').value;
                const rgb = hexToRgb(bgColor);
                
                const cardBg = `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${opacity / 100})`;
                
                currentCustomTheme = {
                    cardBg: cardBg,
                    cardText: textColor,
                    cardSecondaryText: textColor, // Simplified for preview
                    cardBorder: `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, ${(opacity / 100) * 0.8})`,
                    bgHex: bgColor,
                    opacity: opacity
                };

                const previewBtn = document.getElementById('theme-btn-custom');
                previewBtn.style.background = cardBg;
                previewBtn.querySelectorAll('.override-text-color').forEach(el => el.style.color = textColor);

                setTheme('custom');
            }
            document.getElementById('card-bg-color-picker').addEventListener('input', updateCustomThemePreview);
            document.getElementById('card-opacity-slider').addEventListener('input', updateCustomThemePreview);
            document.getElementById('card-text-color-picker').addEventListener('input', updateCustomThemePreview);


            document.getElementById('apply-theme-settings').addEventListener('click', () => {
                if (currentThemeKey === 'custom') {
                    saveStyleSetting('theme', { key: 'custom', values: currentCustomTheme }, 'trip');
                } else {
                    saveStyleSetting('theme', { key: currentThemeKey }, 'trip');
                }
                toggleSettings();
            });
            
            timelineBox.addEventListener('click', (e) => {
                const details = e.target.closest('details.accordion-item');
                if (details && details.open) {
                    details.setAttribute('data-user-opened', 'true');
                }
            });
        }

        // ---------- Init & Data Fetching ----------
        async function saveStyleSetting(settingType, value, scope) {
            const tripRef = doc(db, 'trips', tripId);
            let key;
            if (scope === 'date') {
                key = `styles.date_${dateISO}.${settingType}`;
            } else if (scope === 'destination') {
                key = `styles.destination_${destForDate.id}.${settingType}`;
            } else {
                key = `styles.trip.${settingType}`;
            }
            try {
                await updateDoc(tripRef, { [key]: value });
            } catch (e) {
                console.error("Error saving settings, trying setDoc with merge", e);
                await setDoc(tripRef, { styles: { [scope === 'date' ? `date_${dateISO}` : scope === 'destination' ? `destination_${destForDate.id}` : 'trip']: { [settingType]: value } } }, { merge: true });
            }
        }

        function loadAndApplyStyles() {
            const styles = tripData.styles || {};
            const tripStyle = styles.trip || {};
            const destStyle = destForDate ? (styles[`destination_${destForDate.id}`] || {}) : {};
            const dateStyle = dateISO ? (styles[`date_${dateISO}`] || {}) : {};
            
            const finalLayoutSetting = dateStyle.layout || destStyle.layout || tripStyle.layout || { layout: 'default', smart: false };
            const finalLayout = typeof finalLayoutSetting === 'string' ? finalLayoutSetting : finalLayoutSetting.layout;
            const finalSmartAccordion = typeof finalLayoutSetting === 'string' ? false : finalLayoutSetting.smart;

            const finalThemeSetting = dateStyle.theme || destStyle.theme || tripStyle.theme || { key: 'light' };
            const finalBg = dateStyle.background || destStyle.background || tripStyle.background || { type: 'image', value: destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg', brightness: 50 };
            
            setCurrentLayout(finalLayout, finalSmartAccordion);
            if (finalThemeSetting.key === 'custom') {
                currentCustomTheme = finalThemeSetting.values;
                setTheme('custom', finalThemeSetting.values);
            } else {
                setTheme(finalThemeSetting.key || 'light');
            }
            setBackground(finalBg);

            // Set initial values in settings panel
            bgImageUrlStorage.value = finalBg.type === 'image' ? finalBg.value : '';
            bgColorPicker.value = finalBg.type === 'color' ? finalBg.value : '#f1f5f9';
            document.getElementById('bg-brightness-slider').value = finalBg.brightness;
        }

        async function initPage() {
            const url = new URLSearchParams(window.location.search);
            tripId = url.get('tripId');
            dateStr = decodeURIComponent(url.get('date') || '').trim();
            destId = url.get('destId'); // ---×ª×™×§×•×Ÿ---: ×§×¨×™××ª ××–×”×” ×”×™×¢×“ ××”-URL
            
            const parsed = parseLocalDateFlexible(dateStr);
            if (parsed) { dateISO = toISODateUTC(parsed); dayNameHe = hebWeekdayUTC(parsed); }

            // ---×ª×™×§×•×Ÿ---: ×•×™×“×•× ×©×›×œ ×”×¤×¨××˜×¨×™× ×”× ×—×•×¦×™× ×§×™×™××™×
            if (!tripId || !dateStr || !destId) { 
                alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId, date, ××• destId.'); 
                location.href = 'index.html'; 
                return; 
            }

            tripHomeBtn.href = `trip.html?id=${tripId}`;

            attachEvents();

            onAuthStateChanged(auth, async (user) => {
                if (!user) { location.replace('login.html'); return; }
                currentUser = user;
                const displayName = user.displayName || user.email.split('@')[0];
                authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
                document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));

                const tripRef = doc(db, 'trips', tripId);
                const tripSnap = await getDoc(tripRef);

                if (tripSnap.exists()) {
                    const loadedTripData = tripSnap.data();
                    const canAccess = loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid);

                    if (canAccess) {
                        tripData = loadedTripData;

                        // ---×ª×™×§×•×Ÿ---: ××¦×™××ª ×”×™×¢×“ ×œ×¤×™ ×”-ID ××”-URL ×‘××§×•× ×œ×¤×™ ×”×ª××¨×™×š
                        destForDate = (tripData.destinations || []).find(d => d.id === destId);
                        
                        // ×‘×“×™×§×” × ×•×¡×¤×ª ×©×”×™×¢×“ ×©× ××¦× ×‘×××ª ××›×™×œ ××ª ×”×ª××¨×™×š ×”××‘×•×§×©
                        if (destForDate) {
                            const datesForDest = generateDatesFromRange(destForDate.dates).map(d => toISODateUTC(d));
                            if (!datesForDest.includes(dateISO)) {
                                alert('×©×’×™××”: ×”×ª××¨×™×š ×”××‘×•×§×© ××™× ×• ×©×™×™×š ×œ×™×¢×“ ×©× ×‘×—×¨.');
                                destForDate = null; // ××¤×¡ ××ª ×”×™×¢×“ ×›×“×™ ×œ×× ×•×¢ ×˜×¢×™× ×ª × ×ª×•× ×™× ×©×’×•×™×™×
                            }
                        }

                        if (!destForDate) {
                             alert('×”×™×¢×“ ×”××‘×•×§×© ×œ× × ××¦× ××• ×©×”×ª××¨×™×š ×œ× ×ª×•×× ×œ×™×¢×“.');
                             location.href = `trip.html?id=${tripId}`;
                             return;
                        }

                        const defaultBgUrl = 'https://i.imgur.com/MjekTyd_d.webp?maxwidth=760&fidelity=grand';
                        loaderBg.style.backgroundImage = `url('${destForDate?.bgUrl || destForDate?.imageUrl || defaultBgUrl}')`;
                        
                        buildMenuFromTrip();
                        loadAndApplyStyles();

                        const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
                        const editHref = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
                        editBtn.href = editHref;
                        createBtn.href = editHref;

                        if (dateISO) {
                            const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
                            const schedSnap = await getDoc(schedDocRef);
                            const dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
                            renderHeadline(dayTitleFromDoc);

                            const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
                            const qItems = query(itemsCol);
                            onSnapshot(qItems, (snap) => { 
                                const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
                                arr.sort((a, b) => a.sort - b.sort);
                                renderTimelineFromItems(arr);
                            }, () => renderTimelineFromItems([]));

                            const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
                            const qNotes = query(notesCol);
                            onSnapshot(qNotes, (snap) => {
                                const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
                                if (arr.length > 0 && arr[0].createdAt) {
                                    arr.sort((a, b) => a.createdAt.toMillis() - b.createdAt.toMillis());
                                }
                                renderNotesList(arr);
                            }, (err) => {
                                console.error("Error fetching notes:", err);
                                renderNotesList([]);
                            });
                        } else {
                            renderHeadline(null);
                            renderTimelineFromItems([]);
                            renderNotesList([]);
                        }
                    } else {
                        alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.');
                        location.href = 'index.html';
                        return;
                    }
                } else {
                    alert('×”×˜×™×•×œ ×œ× × ××¦×.');
                    location.href = 'index.html';
                    return;
                }

                initialLoader.style.opacity = '0';
                mainContent.style.opacity = '1';
                setTimeout(() => { initialLoader.style.display = 'none'; }, 500);
            });
        }
        
        // --- Referenced Item Modal Logic ---
        function closeRefDetailModal() {
            if (refModalMapInstance) { refModalMapInstance.remove(); refModalMapInstance = null; }
            refDetailModal.classList.remove('visible');
            closeModal();
        }

        async function showRefDetailModal(refType, refId) {
            openModal();
            
            refDetailModalContent.innerHTML = `<div class="flex justify-center items-center h-48"><i class="fas fa-spinner fa-spin fa-2x"></i></div>`;
            refDetailModal.classList.add('visible');

            const itemDocRef = doc(db, 'trips', tripId, refType, refId);
            const itemSnap = await getDoc(itemDocRef);

            if (!itemSnap.exists()) {
                refDetailModalContent.innerHTML = `<p>×©×’×™××”: ×”×¤×¨×™×˜ ×”××§×•×©×¨ ×œ× × ××¦×.</p><button id="close-ref-modal-btn" class="absolute top-2 left-2 p-2"><i class="fas fa-times"></i></button>`;
                document.getElementById('close-ref-modal-btn').onclick = closeRefDetailModal;
                return;
            }
            
            const itemData = itemSnap.data();
            let contentHtml = '';

            if (refType === 'places') {
                contentHtml = renderPlaceDetailsHTML(itemData);
            } else if (refType === 'logistics') {
                contentHtml = renderLogisticsDetailsHTML(itemData);
            }
            
            refDetailModalContent.innerHTML = contentHtml;
            document.getElementById('close-ref-modal-btn').onclick = closeRefDetailModal;

            const mapContainer = refDetailModalContent.querySelector('#ref-modal-map');
            if (mapContainer && itemData.coords) {
                setTimeout(() => {
                    refModalMapInstance = L.map('ref-modal-map').setView([itemData.coords.lat, itemData.coords.lng], 15);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(refModalMapInstance);
                    L.marker([itemData.coords.lat, itemData.coords.lng]).addTo(refModalMapInstance);
                }, 50);
            }
        }

        function renderPlaceDetailsHTML(item) {
            const tags = [
                item.isKosher === '×›×Ÿ' ? `<span class="text-sm font-bold text-green-700 bg-green-100 px-3 py-1 rounded-full">×›×©×¨</span>` : '',
                item.foodType ? `<span class="text-sm font-bold text-sky-700 bg-sky-100 px-3 py-1 rounded-full">${item.foodType}</span>` : '',
                item.reservation && item.reservation !== '×œ×' ? `<span class="text-sm font-bold text-amber-700 bg-amber-100 px-3 py-1 rounded-full">×”×–×× ×”: ${item.reservation}</span>` : ''
            ].filter(Boolean).join('');

            return `
                <button id="close-ref-modal-btn" class="absolute top-3 left-3 w-8 h-8 bg-slate-100/50 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 z-10 transition-colors"><i class="fas fa-times"></i></button>
                <div class="p-0 space-y-4">
                    <h3 class="text-2xl font-bold border-b pb-3">${item.name}</h3>
                    <div class="space-y-3">
                        ${tags ? `<div class="flex flex-wrap gap-3 items-center">${tags}</div>` : ''}
                        ${item.shortDescription ? `<div class="bg-blue-50 border-l-4 border-blue-400 p-3 rounded"><p class="text-slate-700 font-semibold">${item.shortDescription}</p></div>` : ''}
                        ${item.description ? `<div class="bg-white p-3 rounded-lg shadow-inner"><p class="text-slate-700 whitespace-pre-wrap">${item.description}</p></div>` : ''}
                        ${item.location ? `<div class="flex items-start gap-3"><i class="fa-solid fa-location-dot fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 font-semibold">${item.location}</p></div>` : ''}
                        ${item.hours ? `<div class="flex items-start gap-3"><i class="fa-regular fa-clock fa-fw text-slate-400 mt-1"></i><p class="text-slate-700 whitespace-pre-wrap">${item.hours}</p></div>` : ''}
                        ${item.coords ? `<div id="ref-modal-map" class="w-full h-48 rounded-lg shadow-md"></div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderLogisticsDetailsHTML(item) {
             let detailsHtml = '';
             switch(item.subType) {
                 case 'hotel':
                     detailsHtml = `
                         <p><strong>×™×¢×“:</strong> ${item.destination}</p>
                         <p><strong>×ª××¨×™×›×™×:</strong> ${item.dates}</p>
                         <p><strong>××—×™×¨:</strong> ${item.price ? `$${item.price.toLocaleString()}`: '×œ× ×¦×•×™×Ÿ'}</p>
                         <p><strong>×”×•×–××Ÿ ×“×¨×š:</strong> ${item.booked_via}</p>
                         ${item.address ? `<p><strong>×›×ª×•×‘×ª:</strong> ${item.address}</p>` : ''}
                     `;
                     break;
                 case 'flight':
                     detailsHtml = `
                         <p><strong>×—×‘×¨×ª ×ª×¢×•×¤×”:</strong> ${item.airline}</p>
                         <p><strong>××¡×¤×¨ ×˜×™×¡×”:</strong> ${item.flight_number}</p>
                         <p><strong>×ª××¨×™×š:</strong> ${item.dates}</p>
                         <p><strong>×:</strong> ${item.from?.destination} (${item.from?.airport_name}) <strong>××œ:</strong> ${item.to?.destination} (${item.to?.airport_name})</p>
                         <p><strong>×”××¨××”:</strong> ${item.departure_time}, <strong>× ×—×™×ª×”:</strong> ${item.arrival_time}</p>
                     `;
                     break;
                 default:
                     detailsHtml = `<p>××™×Ÿ ×¤×¨×˜×™× × ×•×¡×¤×™× ×œ×”×¦×’×”.</p>`;
             }

             return `
                 <button id="close-ref-modal-btn" class="absolute top-3 left-3 w-8 h-8 bg-slate-100/50 rounded-full text-slate-500 hover:text-red-500 hover:bg-red-100 z-10 transition-colors"><i class="fas fa-times"></i></button>
                 <div class="p-0 space-y-4">
                     <h3 class="text-2xl font-bold border-b pb-3">${item.name || item.subType}</h3>
                     <div class="text-sm space-y-2">${detailsHtml}</div>
                     ${item.additional_details ? `<div class="mt-2 p-3 bg-slate-100 rounded-lg text-sm text-slate-700"><p class="font-bold mb-1">×¤×¨×˜×™× × ×•×¡×¤×™×:</p><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                 </div>
             `;
        }

        initPage();
    </script>
</body>
</html>

