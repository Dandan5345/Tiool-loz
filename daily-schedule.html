<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">
  <!-- Leaflet CSS for Map -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
  <style>
    body { font-family: 'Assistant', sans-serif; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .leaf-badge { border-inline-start: 4px solid #38bdf8; }
    .timeline { position: relative; }
    .timeline::before { content: ""; position: absolute; right: 20px; top: 0; bottom: 0; width: 2px; background: rgba(30,41,59,.15); }
    .timeline-item { position: relative; padding-right: 56px; }
    .timeline-dot { position: absolute; right: 12px; top: .75rem; width: 16px; height: 16px; border-radius: 9999px; background: white; box-shadow: 0 0 0 4px #e2e8f0 inset, 0 0 0 2px rgba(30,41,59,.1); }
    .bg-fixed-image { background-size: cover; background-position: center; background-attachment: fixed; }
    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity .5s ease-out; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }
    
    /* Settings Modal */
    .settings-modal-content { max-height: 80vh; }

    /* Custom Color Slider */
    .color-slider {
        height: 20px;
        border-radius: 10px;
        cursor: pointer;
        background: linear-gradient(to left, #ff0000, #ff7f00, #ffff00, #00ff00, #0000ff, #4b0082, #8b00ff);
        position: relative;
    }

    /* Map Styles */
    #route-map { height: 400px; border-radius: 1rem; }
    
    /* Timeline Accordion */
    .timeline-accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-out, padding 0.5s ease-out; }
    .timeline-accordion-content.open { max-height: 1000px; padding-top: 1rem; padding-bottom: 1rem; }
    
    /* Fix for scrolling jump */
    html, body { height: 100%; }
    body { overflow-y: auto; }
  </style>
</head>
<body class="bg-slate-100">
  <!-- Background - Consolidated to one element to prevent jumping bug -->
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image transition-all duration-500" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');">
      <div id="bg-overlay" class="absolute inset-0 bg-black/50 transition-all duration-500"></div>
  </div>

  <!-- Loader -->
  <div id="initial-loader">
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
    </div>
  </div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <!-- Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <button id="trip-home-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ">
              <i class="fas fa-map-signs fa-lg"></i>
            </button>
            <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
          </div>
          <div class="flex items-center gap-2">
            <div id="auth-container" class="flex items-center"></div>
            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none" title="×”×’×“×¨×•×ª ×¢×™×¦×•×‘">
              <i class="fas fa-cog fa-lg"></i>
            </button>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <section class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 leaf-badge">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold text-slate-800">×œ×•×– ×œ×™×•×</h2>
              <p id="trip-subtitle" class="text-slate-500 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 text-slate-600">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
        </section>

        <section id="timeline-section" class="rounded-2xl">
          <div id="no-schedule" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-10 text-center">
            <i class="fa-regular fa-clock fa-3x text-slate-400 mb-4"></i>
            <h3 class="text-xl font-bold text-slate-700 mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
            <p class="text-slate-500">×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
          </div>
          <div id="timeline" class="timeline space-y-4 hidden"></div>
        </section>

        <section id="notes-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold text-slate-800 mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
          <div id="notes-list" class="grid gap-3">
            <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
          </div>
        </section>

        <section id="map-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 hidden">
            <h3 class="text-lg font-bold text-slate-800 mb-4">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
            <div id="route-map-container">
                <div id="route-map"></div>
                <div id="map-legend" class="mt-4 space-y-2 text-sm"></div>
            </div>
            <div id="map-no-locations" class="text-center p-6 text-slate-500 hidden">
                <i class="fas fa-map-marker-slash fa-2x mb-2"></i>
                <p>×œ× × ××¦××• ×›×ª×•×‘×•×ª ×¢× ×§×•××•×¨×“×™× ×˜×•×ª ×‘×œ×•"×– ×›×“×™ ×œ×”×¦×™×’ ××ª ×”××¤×”.</p>
            </div>
        </section>

        <section id="cta-section" class="flex justify-center gap-3">
          <a id="create-schedule-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            ×¦×•×¨ ×œ×•×–
          </a>
           <a id="edit-schedule-btn" href="#" class="hidden items-center gap-2 bg-gradient-to-r from-amber-500 to-orange-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
              <i class="fa-solid fa-pen"></i> ×¢×¨×•×š ×œ×•×–
            </a>
        </section>

      </div>
    </main>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="fixed inset-0 bg-black/60 z-[70] hidden flex items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl transform transition-all opacity-0 -translate-y-4">
          <div class="p-4 flex justify-between items-center border-b">
              <h3 class="text-xl font-bold text-slate-800">×”×’×“×¨×•×ª ×¢×™×¦×•×‘</h3>
              <button id="close-settings-modal" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
          </div>
          <div class="p-6 space-y-6 overflow-y-auto settings-modal-content">
              <!-- Background Settings -->
              <div class="p-4 border rounded-lg">
                  <h4 class="font-bold text-lg mb-3">ğŸ¨ ×¢×¨×™×›×ª ×¨×§×¢</h4>
                  <div class="space-y-4">
                      <div>
                          <label class="font-semibold text-slate-700 block mb-1">×”×“×‘×§ ×§×™×©×•×¨ ×œ×ª××•× ×ª ×¨×§×¢ (××•×¤×¦×™×•× ×œ×™)</label>
                          <input type="url" id="bg-image-url" placeholder="https://example.com/image.jpg" class="w-full p-2 border rounded-md focus:ring-2 focus:ring-blue-500">
                      </div>
                      <div>
                          <label class="font-semibold text-slate-700 block mb-1">××• ×‘×—×¨ ×¦×‘×¢ ×¨×§×¢</label>
                          <input type="color" id="bg-color-picker" class="w-full h-10 p-1 border rounded-md">
                      </div>
                      <div>
                          <label for="bg-brightness-slider" class="font-semibold text-slate-700 block mb-1">×‘×”×™×¨×•×ª ×”×¨×§×¢ (×©×›×‘×” ×©×—×•×¨×”)</label>
                          <div class="flex items-center gap-2">
                              <span>0%</span>
                              <input type="range" id="bg-brightness-slider" min="0" max="90" value="50" class="w-full">
                              <span>90%</span>
                          </div>
                      </div>
                  </div>
              </div>
              <!-- Layout Settings -->
              <div class="p-4 border rounded-lg">
                  <h4 class="font-bold text-lg mb-3">ğŸ“ ×¢×¨×™×›×ª ×¢×™×¦×•×‘ ×”×“×£</h4>
                  <div class="grid grid-cols-2 gap-4">
                      <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="1" class="sr-only">
                          <span class="font-bold">×›×¨×˜×™×¡×™×•×ª ×¢× ××•×“×œ</span>
                          <p class="text-sm text-slate-500">×œ×—×™×¦×” ×¤×•×ª×—×ª ×—×œ×•×Ÿ ×¢× ×›×œ ×”×¤×¨×˜×™×.</p>
                      </label>
                       <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="2" class="sr-only">
                          <span class="font-bold">××§×•×¨×“×™×•×Ÿ + ××•×“×œ</span>
                          <p class="text-sm text-slate-500">×”×¨×—×‘×” ××”×™×¨×”, ×•×œ×—×™×¦×” × ×•×¡×¤×ª ×œ××•×“×œ.</p>
                      </label>
                       <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="3" class="sr-only">
                          <span class="font-bold">××§×•×¨×“×™×•×Ÿ ××œ×</span>
                          <p class="text-sm text-slate-500">×›×œ ×”×¤×¨×˜×™× × ×¤×ª×—×™× ××ª×—×ª ×œ×¤×¨×™×˜.</p>
                      </label>
                       <label class="p-3 border rounded-lg cursor-pointer has-[:checked]:bg-blue-50 has-[:checked]:border-blue-500">
                          <input type="radio" name="layout-style" value="4" class="sr-only">
                          <span class="font-bold">×¦×™×¨ ×–××Ÿ ×§×œ××¡×™</span>
                          <p class="text-sm text-slate-500">×§×• ×–××Ÿ ×× ×›×™ ×¢× ×›×¨×˜×™×¡×™×•×ª.</p>
                      </label>
                  </div>
              </div>
              <!-- Cards & Text Color -->
              <div class="p-4 border rounded-lg">
                  <h4 class="font-bold text-lg mb-3">âœ’ï¸ ×¢×¨×™×›×ª ×›×¨×˜×™×¡×™×•×ª ×•×˜×§×¡×˜</h4>
                   <div>
                      <label class="font-semibold text-slate-700 block mb-1">×¦×‘×¢ ×¨×§×¢ ×”×›×¨×˜×™×¡×™×•×ª</label>
                      <input type="color" id="card-bg-color-picker" class="w-full h-10 p-1 border rounded-md">
                   </div>
                   <div class="mt-4">
                      <label class="font-semibold text-slate-700 block mb-1">×¦×‘×¢ ×”×˜×§×¡×˜</label>
                      <input type="color" id="card-text-color-picker" class="w-full h-10 p-1 border rounded-md">
                   </div>
                   <div class="mt-4">
                       <label class="font-semibold text-slate-700 block mb-1">×¢×™×¦×•×‘×™× ××•×›× ×™×</label>
                       <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                           <button data-preset="transparent" class="p-2 border rounded-lg text-white bg-black/50">×©×§×•×£</button>
                           <button data-preset="white" class="p-2 border rounded-lg text-black bg-white">×§×œ××¡×™</button>
                           <button data-preset="dark" class="p-2 border rounded-lg text-white bg-slate-800">×›×”×”</button>
                           <button data-preset="ocean" class="p-2 border rounded-lg text-white bg-blue-800">××•×§×™×™× ×•×¡</button>
                           <button data-preset="forest" class="p-2 border rounded-lg text-white bg-green-800">×™×¢×¨</button>
                           <button data-preset="sunset" class="p-2 border rounded-lg text-white bg-orange-700">×©×§×™×¢×”</button>
                           <button data-preset="sand" class="p-2 border rounded-lg text-yellow-900 bg-yellow-100">×—×•×œ</button>
                           <button data-preset="sky" class="p-2 border rounded-lg text-sky-900 bg-sky-100">×©××™×™×</button>
                       </div>
                   </div>
              </div>
          </div>
          <div class="p-4 bg-slate-50 border-t flex justify-end">
              <button id="save-settings-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700">×©××•×¨ ×”×’×“×¨×•×ª</button>
          </div>
      </div>
  </div>


  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy, updateDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    // Leaflet JS for Map
    import "https://unpkg.com/leaflet@1.9.4/dist/leaflet.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- State ----------
    let currentUser = null;
    let tripId = null;
    let tripData = null;
    let dateStr = null;
    let dateISO = null;
    let dayNameHe = "";
    let destForDate = null;
    let scheduleItems = [];
    let leafletMap = null;
    let currentSettings = {
        layout: '1', // 1: modal, 2: accordion+modal, 3: full-accordion, 4: classic-timeline
        background: { type: 'default', value: 'https://i.imgur.com/MjekTyd.jpeg', brightness: 50 },
        cards: { bg: '#ffffff', text: '#1e293b', preset: 'white' }
    };

    // ---------- UI Elements ----------
    const initialLoader   = document.getElementById('initial-loader');
    const mainContent     = document.getElementById('main-content');
    const pageBg          = document.getElementById('page-bg');
    const bgOverlay       = document.getElementById('bg-overlay');
    const sidebar         = document.getElementById('sidebar');
    const hamburgerBtn    = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay         = document.getElementById('overlay');
    const mainMenu        = document.getElementById('main-menu');
    const authContainer   = document.getElementById('auth-container');
    const tripHomeBtn     = document.getElementById('trip-home-btn');
    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl       = document.getElementById('day-title');
    const tripSubtitle     = document.getElementById('trip-subtitle');
    const dateChip         = document.getElementById('date-chip');
    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox   = document.getElementById('timeline');
    const ctaSection    = document.getElementById('cta-section');
    const createBtn     = document.getElementById('create-schedule-btn');
    const editBtn       = document.getElementById('edit-schedule-btn');
    const notesList     = document.getElementById('notes-list');
    const notesSection  = document.getElementById('notes-section');
    const mapSection    = document.getElementById('map-section');
    const routeMapContainer = document.getElementById('route-map-container');
    const mapNoLocations = document.getElementById('map-no-locations');
    const routeMapEl    = document.getElementById('route-map');
    const mapLegend     = document.getElementById('map-legend');
    
    // Settings Modal UI
    const settingsBtn = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const closeSettingsModalBtn = document.getElementById('close-settings-modal');
    const saveSettingsBtn = document.getElementById('save-settings-btn');
    const bgImageUrlInput = document.getElementById('bg-image-url');
    const bgColorPicker = document.getElementById('bg-color-picker');
    const bgBrightnessSlider = document.getElementById('bg-brightness-slider');
    const layoutStyleRadios = document.querySelectorAll('input[name="layout-style"]');
    const cardBgColorPicker = document.getElementById('card-bg-color-picker');
    const cardTextColorPicker = document.getElementById('card-text-color-picker');
    const presetButtons = document.querySelectorAll('[data-preset]');


    // ---------- Helpers ----------
    function toggleSidebar(){ sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }

    function parseLocalDateFlexible(s) {
      if (!s) return null;
      const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/);
      if (!m) return null;
      let d = +m[1], mo = +m[2], y = +m[3];
      if (y < 100) y += 2000;
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
    function toISODateUTC(d) {
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function hebWeekdayUTC(d) {
      const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª'];
      return names[d.getUTCDay()];
    }

    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const start = parseLocalDateFlexible(startStr);
      const end = parseLocalDateFlexible(endStr);
      if (!start || !end) return [];
      const out = [];
      for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) {
        out.push(new Date(t.getTime()));
      }
      return out;
    }

    function findDestinationForDate(trip, rawDDMMYYYY) {
      const target = parseLocalDateFlexible(rawDDMMYYYY);
      if (!target) return null;
      const targetISO = toISODateUTC(target);
      return (trip.destinations || []).find(dest => {
        const days = generateDatesFromRange(dest.dates);
        const isoList = days.map(d => toISODateUTC(d));
        return isoList.includes(targetISO);
      }) || null;
    }

    // ---------- Settings & Theming ----------
    
    function applySettings(settings) {
        // Background
        if (settings.background.type === 'image') {
            pageBg.style.backgroundImage = `url('${settings.background.value}')`;
        } else if (settings.background.type === 'color') {
            pageBg.style.backgroundImage = 'none';
            pageBg.style.backgroundColor = settings.background.value;
        } else { // default
            pageBg.style.backgroundImage = `url('${settings.background.value}')`;
        }
        bgOverlay.style.backgroundColor = `rgba(0, 0, 0, ${settings.background.brightness / 100})`;

        // Layout - will be used in renderTimelineFromItems
        currentSettings.layout = settings.layout || '1';
        
        // Cards - will be used in renderTimelineFromItems
        currentSettings.cards = settings.cards || { bg: '#ffffff', text: '#1e293b', preset: 'white' };

        // Re-render timeline with new settings
        renderTimelineFromItems(scheduleItems);
    }

    function loadAndApplySettings() {
        // Simple load from tripData. In a real app, this would be more complex
        // (checking date-specific, then destination-specific, then trip-wide)
        if (tripData.designSettings) {
            currentSettings = { ...currentSettings, ...tripData.designSettings };
        }
        applySettings(currentSettings);
        
        // Update modal controls to reflect current settings
        const bg = currentSettings.background;
        if (bg.type === 'image') bgImageUrlInput.value = bg.value;
        if (bg.type === 'color') bgColorPicker.value = bg.value;
        bgBrightnessSlider.value = bg.brightness;
        
        document.querySelector(`input[name="layout-style"][value="${currentSettings.layout}"]`).checked = true;
        
        cardBgColorPicker.value = currentSettings.cards.bg;
        cardTextColorPicker.value = currentSettings.cards.text;
    }

    async function saveSettings() {
        const newSettings = {
            layout: document.querySelector('input[name="layout-style"]:checked').value,
            background: {
                type: bgImageUrlInput.value ? 'image' : 'color',
                value: bgImageUrlInput.value || bgColorPicker.value,
                brightness: bgBrightnessSlider.value
            },
            cards: {
                bg: cardBgColorPicker.value,
                text: cardTextColorPicker.value,
            }
        };
        
        try {
            const tripRef = doc(db, 'trips', tripId);
            await updateDoc(tripRef, { designSettings: newSettings });
            alert('×”×”×’×“×¨×•×ª × ×©××¨×• ×‘×”×¦×œ×—×”!');
            currentSettings = newSettings;
            applySettings(currentSettings);
            toggleSettingsModal();
        } catch (error) {
            console.error("Error saving settings: ", error);
            alert('××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×ª ×”×”×’×“×¨×•×ª.');
        }
    }

    function toggleSettingsModal() {
        const modal = settingsModal;
        const content = modal.querySelector('.transform');
        if (modal.classList.contains('hidden')) {
            modal.classList.remove('hidden');
            setTimeout(() => {
                content.classList.remove('opacity-0', '-translate-y-4');
                content.classList.add('opacity-100', 'translate-y-0');
            }, 10);
        } else {
            content.classList.add('opacity-0', '-translate-y-4');
            content.classList.remove('opacity-100', 'translate-y-0');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
    }

    // ---------- Rendering ----------

    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        const dates = generateDatesFromRange(dest.dates);
        dates.forEach(dObj => {
          const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
          const a = document.createElement('a');
          a.href = `?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
          a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
          a.textContent = `×œ×•"×– ×œ×™×•× ${nice}`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', () => {
          submenu.classList.toggle('open');
          btn.querySelector('i').classList.toggle('rotate-180');
        });
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function renderHeadline(dayTitleFromDoc = null) {
      const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
      const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
      scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
      dayTitleEl.textContent = dayTitleFromDoc
        ? `${dayTitleFromDoc} â€¢ ${dateStr}`
        : `×œ×•×– ×œ×™×•× ${dateStr}`;
      tripSubtitle.textContent = `${destName}${dayPart ? ' â€¢' + dayPart : ''}`;
      dateChip.textContent = dateStr;
    }

    function timeText(it){
      if (!it?.startTime && !it?.endTime) return '--:--';
      return [it.startTime || '', it.endTime ? 'â€“ '+it.endTime : ''].filter(Boolean).join(' ');
    }

    function renderTimelineFromItems(items){
      scheduleItems = items; // Cache for re-rendering
      if (!items || items.length === 0) {
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        timelineBox.innerHTML = '';
        ctaSection.classList.remove('hidden');
        createBtn.classList.remove('hidden');
        editBtn.classList.add('hidden');
        mapSection.classList.add('hidden');
        return;
      }
      
      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      timelineBox.innerHTML = '';
      ctaSection.classList.remove('hidden');
      createBtn.classList.add('hidden');
      editBtn.classList.remove('hidden');
      editBtn.classList.add('inline-flex');

      items.forEach((it, index) => {
        const itemHtml = createTimelineItemHtml(it, index, currentSettings.layout);
        const itemEl = document.createElement('div');
        // Apply layout-specific classes
        if (currentSettings.layout === '4') {
            itemEl.className = 'timeline-item';
        } else {
            itemEl.className = ''; // No timeline-item class for card layouts
        }
        itemEl.innerHTML = itemHtml;
        timelineBox.appendChild(itemEl);
      });
      
      // Add event listeners for accordion layouts
      if (currentSettings.layout === '2' || currentSettings.layout === '3') {
          document.querySelectorAll('.timeline-accordion-header').forEach(header => {
              header.addEventListener('click', () => {
                  const content = header.nextElementSibling;
                  content.classList.toggle('open');
              });
          });
      }
      renderMap(items);
    }
    
    function createTimelineItemHtml(it, index, layout) {
        // Shared data extraction
        const hasAddr = !!it.address?.label;
        const hasSite = !!it.links?.site;
        const hasBook = !!it.links?.booking;
        const cardStyle = `background-color: ${currentSettings.cards.bg}; color: ${currentSettings.cards.text};`;
        
        const navHtml = hasAddr ? `
          <div class="flex gap-2 flex-wrap">
            <a class="px-2 py-1 rounded text-white text-xs" style="background-color: #00853f;" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}"><i class="fa-solid fa-location-dot"></i> Google Maps</a>
            <a class="px-2 py-1 rounded text-white text-xs" style="background-color: #33ccff;" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}"><i class="fa-brands fa-waze"></i> Waze</a>
          </div>
        ` : '';

        const linksHtml = [
          hasSite ? `<a class="inline-flex items-center gap-1 hover:underline text-xs" style="color: #38bdf8;" href="${it.links.site}" target="_blank"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
          hasBook ? `<a class="inline-flex items-center gap-1 hover:underline text-xs" style="color: #14b8a6;" href="${it.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
        ].filter(Boolean).join(' ');

        const fullDetailsHtml = `
            ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
            ${it.description ? `<p class="mt-2 whitespace-pre-wrap">${it.description}</p>` : ''}
            ${hasAddr ? `<div class="mt-2 text-sm"><i class="fa-solid fa-location-dot mr-1 opacity-70"></i>${it.address.label}</div>` : ''}
            <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 items-center">${linksHtml}</div>
            ${navHtml ? `<div class="mt-3">${navHtml}</div>` : ''}
        `;

        // Layout-specific HTML
        switch(layout) {
            case '2': // Accordion + Modal
            case '3': // Full Accordion
                return `
                <div class="bg-white/90 rounded-xl shadow p-4 timeline-accordion-header cursor-pointer" style="${cardStyle}">
                    <div class="flex justify-between items-center">
                        <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                        <span class="text-sm font-bold shrink-0">${timeText(it)}</span>
                    </div>
                </div>
                <div class="timeline-accordion-content px-4">
                    ${fullDetailsHtml}
                </div>
                `;
            case '4': // Classic Timeline
                 return `
                    <div class="bg-white/90 rounded-xl shadow p-4" style="${cardStyle}">
                      <span class="timeline-dot"></span>
                      <div class="flex items-start gap-4">
                        <div class="shrink-0 text-center">
                          <div class="text-sm font-bold">${timeText(it)}</div>
                        </div>
                        <div class="flex-1">
                          <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                          ${it.summary ? `<div class="mt-1 text-sm">${it.summary}</div>` : ''}
                           <div class="mt-3 flex flex-wrap gap-x-4 gap-y-2 items-center">${linksHtml}</div>
                           ${navHtml ? `<div class="mt-2">${navHtml}</div>` : ''}
                        </div>
                      </div>
                    </div>`;
            case '1': // Cards with Modal (Default)
            default:
                return `
                <div class="bg-white/90 rounded-xl shadow p-4 cursor-pointer hover:shadow-lg transition-shadow" style="${cardStyle}" onclick="alert('×¤×ª×™×—×ª ××•×“×œ ×¢× ×¤×¨×˜×™× ××œ××™× ×¢×‘×•×¨: ${it.title.replace(/'/g, "\\'")}')">
                     <div class="flex justify-between items-start gap-4">
                        <div class="flex-1">
                            <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                            <p class="text-sm opacity-80 mt-1">${it.summary || '××™×Ÿ ×¤×™×¨×•×˜ ×§×¦×¨'}</p>
                        </div>
                        <div class="shrink-0 text-right">
                            <div class="font-bold">${timeText(it)}</div>
                        </div>
                     </div>
                     <div class="mt-3 pt-3 border-t border-black/10 flex justify-between items-center">
                        ${navHtml}
                        <div class="flex gap-4">${linksHtml}</div>
                     </div>
                </div>
                `;
        }
    }

    function renderMap(items) {
        const locations = items
            .map(item => item.address)
            .filter(addr => addr && addr.lat && addr.lon);

        if (locations.length < 1) {
            mapSection.classList.remove('hidden');
            routeMapContainer.classList.add('hidden');
            mapNoLocations.classList.remove('hidden');
            return;
        }

        mapSection.classList.remove('hidden');
        routeMapContainer.classList.remove('hidden');
        mapNoLocations.classList.add('hidden');

        if (leafletMap) {
            leafletMap.remove();
        }
        leafletMap = L.map('route-map').setView([locations[0].lat, locations[0].lon], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(leafletMap);

        const latLngs = [];
        const routeColors = ['#3b82f6', '#ef4444', '#16a34a', '#f97316', '#8b5cf6', '#eab308'];
        mapLegend.innerHTML = '';

        locations.forEach((loc, index) => {
            L.marker([loc.lat, loc.lon]).addTo(leafletMap)
                .bindPopup(`<b>${loc.label}</b>`)
                .openPopup();
            latLngs.push([loc.lat, loc.lon]);

            if (index > 0) {
                const prevLoc = locations[index - 1];
                const color = routeColors[(index - 1) % routeColors.length];
                const polyline = L.polyline([[prevLoc.lat, prevLoc.lon], [loc.lat, loc.lon]], { color: color }).addTo(leafletMap);
                
                const legendItem = document.createElement('div');
                legendItem.className = 'flex items-center gap-2';
                legendItem.innerHTML = `
                    <div class="w-4 h-1" style="background-color: ${color};"></div>
                    <span>${prevLoc.label} <i class="fas fa-arrow-left fa-xs"></i> ${loc.label}</span>
                `;
                mapLegend.appendChild(legendItem);
            }
        });
        
        if (latLngs.length > 0) {
            leafletMap.fitBounds(latLngs, { padding: [50, 50] });
        }
    }


    function renderNotesList(notes){
      if (!notes || notes.length===0){
        notesList.innerHTML = `<div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const colorMap = {
            red:    {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
            green:  {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
            blue:   {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
            yellow: {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
            orange: {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
        };
        const m = colorMap[n.color] || colorMap.yellow;
        const cls = `${m.bg} ${m.border} ${m.text}`;
        return `
          <div class="border rounded-xl p-3 ${cls}">
            <div class="font-bold">${n.kind}: ${n.title || 'â€”'}</div>
            ${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap">${n.details}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ---------- Event Listeners ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);
      
      tripHomeBtn.addEventListener('click', () => {
          window.location.href = `trip.html?tripId=${tripId}`;
      });
      
      settingsBtn.addEventListener('click', toggleSettingsModal);
      closeSettingsModalBtn.addEventListener('click', toggleSettingsModal);
      saveSettingsBtn.addEventListener('click', saveSettings);
      
      presetButtons.forEach(btn => {
          btn.addEventListener('click', () => {
              const preset = btn.dataset.preset;
              const presets = {
                  transparent: { bg: 'rgba(255, 255, 255, 0.1)', text: '#ffffff' },
                  white: { bg: '#ffffff', text: '#1e293b' },
                  dark: { bg: '#1e293b', text: '#f1f5f9' },
                  ocean: { bg: '#1e40af', text: '#dbeafe' },
                  forest: { bg: '#14532d', text: '#dcfce7' },
                  sunset: { bg: '#b45309', text: '#fef3c7' },
                  sand: { bg: '#fef3c7', text: '#7c2d12' },
                  sky: { bg: '#e0f2fe', text: '#0c4a6e' }
              };
              if (presets[preset]) {
                  cardBgColorPicker.value = presets[preset].bg; // Note: type="color" might not support rgba well
                  cardTextColorPicker.value = presets[preset].text;
              }
          });
      });
    }

    // ---------- Init ----------
    async function initPage() {
      const url = new URLSearchParams(window.location.search);
      tripId = url.get('tripId');
      dateStr = decodeURIComponent(url.get('date') || '').trim();

      const parsed = parseLocalDateFlexible(dateStr);
      if (parsed) {
        dateISO = toISODateUTC(parsed);
        dayNameHe = hebWeekdayUTC(parsed);
      } else {
        dateISO = null; dayNameHe = "";
      }

      if (!tripId || !dateStr) {
        alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.');
        location.href = 'index.html'; return;
      }

      attachEvents();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);
        if (!tripSnap.exists()) { alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href = 'index.html'; return; }
        tripData = tripSnap.data();
        if (tripData.ownerId && tripData.ownerId !== currentUser.uid) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.'); location.href = 'index.html'; return;
        }

        destForDate = findDestinationForDate(tripData, dateStr);
        buildMenuFromTrip();
        loadAndApplySettings();

        const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
        const editHref   = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
        editBtn.href   = editHref;
        createBtn.href = editHref;

        if (dateISO){
          const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
          const schedSnap = await getDoc(schedDocRef);
          const dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
          renderHeadline(dayTitleFromDoc);

          const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
          const qItems = query(itemsCol, orderBy('sort','asc'));
          onSnapshot(qItems, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            // MOCK: Add lat/lon to addresses for map functionality
            arr.forEach(item => {
                if (item.address && !item.address.lat) {
                    if (item.title.includes("×™×¨×•×©×œ×™×")) { item.address.lat = 31.771959; item.address.lon = 35.217018; }
                    if (item.title.includes("×ª×œ ××‘×™×‘")) { item.address.lat = 32.085300; item.address.lon = 34.781769; }
                    if (item.title.includes("× ×ª× ×™×”")) { item.address.lat = 32.321450; item.address.lon = 34.853191; }
                }
            });
            renderTimelineFromItems(arr);
          }, ()=> renderTimelineFromItems([]));

          const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
          const qNotes = query(notesCol, orderBy('createdAt','asc'));
          onSnapshot(qNotes, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderNotesList(arr);
          }, ()=> renderNotesList([]));
        } else {
          renderHeadline(null);
          renderTimelineFromItems([]);
          renderNotesList([]);
        }

        initialLoader.style.opacity = '0';
        mainContent.style.opacity = '1';
        setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
      });
    }

    initPage();
  </script>
</body>
</html>
