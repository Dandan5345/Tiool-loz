<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <!-- Font -->
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet (OSM) -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --card-bg: rgba(255,255,255,0.9);
      --card-text: #0f172a;
      --modal-bg: rgba(255,255,255,1);
      --modal-text: #0f172a;
      --bg-dim: 0.50; /* 0=×‘×œ×™ ×”×—×©×›×”, 1=×—×©×•×š ×××•×“ */
    }
    html{ scrollbar-gutter: stable; }
    body { font-family: 'Assistant', sans-serif; overscroll-behavior-y: none; background: #f1f5f9; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .leaf-badge { border-inline-start: 4px solid #38bdf8; }
    .timeline { position: relative; }
    .timeline::before { content: ""; position: absolute; right: 20px; top: 0; bottom: 0; width: 2px; background: rgba(30,41,59,.15); }
    .timeline-item { position: relative; padding-right: 56px; background: var(--card-bg); color: var(--card-text); }
    .timeline-dot { position: absolute; right: 12px; top: .75rem; width: 16px; height: 16px; border-radius: 9999px; background: white; box-shadow: 0 0 0 4px #e2e8f0 inset, 0 0 0 2px rgba(30,41,59,.1); }
    .bg-fixed-image { background-size: cover; background-position: center; }
    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity .5s ease-out; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }

    /* ××•×“×œ×™× */
    .modal-overlay{ position: fixed; inset:0; background: rgba(0,0,0,0.45); display:none; z-index:70; }
    .modal{ position: fixed; inset-inline: 0; top: 6%; margin-inline:auto; width:min(980px,95%); max-height:88vh; overflow:auto; z-index: 80; display:none; }
    .modal-card{ background: var(--modal-bg); color: var(--modal-text); border-radius: 1rem; box-shadow: 0 20px 60px rgba(0,0,0,.25); }
    .no-shift-img { display:block; width:100%; height:240px; object-fit:cover; }

    /* ×›×¨×˜×™×¡×™×•×ª × ×¤×ª×—×•×ª ×‘×¡×’× ×•×Ÿ ×”×“×•×’××” */
    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
    .chevron-icon { transition: transform 0.25s ease; }
    details[open] > summary .chevron-icon { transform: rotate(180deg); }

    /* ×’×œ×™×œ×” ×™×¦×™×‘×” + ××¤×” */
    #route-map { height: 360px; }
    #item-modal-map { height: 260px; border-radius: .75rem; }
  </style>
</head>
<body class="bg-slate-100">
  <!-- Loader -->
  <div id="initial-loader">
    <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div id="page-dim-loader" class="fixed inset-0 z-0" style="background-color: rgba(0,0,0,var(--bg-dim));"></div>
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
    </div>
  </div>

  <!-- Background -->
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
  <div id="page-dim" class="fixed inset-0 z-0" style="background-color: rgba(0,0,0,var(--bg-dim));"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <!-- Modals -->
  <div id="modal-overlay" class="modal-overlay"></div>

  <!-- Settings Modal (×›××• ×‘×’×¨×¡×” ×”×§×•×“××ª â€“ × ×©××¨, ×œ× × ×’×¢×ª×™ ×‘×˜×§×¡×˜×™×) -->
  <div id="settings-modal" class="modal">
    <div class="modal-card p-4 sm:p-6">
      <div class="flex items-center justify-between gap-4 border-b pb-3">
        <h3 class="text-xl font-bold">×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ×”×“×£</h3>
        <button id="settings-close" class="p-2 text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </div>

      <div class="mt-4 grid sm:grid-cols-3 gap-3">
        <button data-tab="bg" class="settings-tab px-3 py-2 rounded-lg border font-bold bg-sky-50 text-sky-700">×¢×¨×™×›×ª ×¨×§×¢</button>
        <button data-tab="layout" class="settings-tab px-3 py-2 rounded-lg border font-bold">×¢×™×¦×•×‘ ×”×“×£</button>
        <button data-tab="cards" class="settings-tab px-3 py-2 rounded-lg border font-bold">×›×¨×˜×™×¡×™×•×ª/×—×œ×•× ×•×ª/×˜×§×¡×˜</button>
      </div>

      <!-- Scope -->
      <div class="mt-4">
        <label class="block font-bold mb-1">×”×—×œ×” ×¢×œ:</label>
        <div class="flex flex-wrap gap-4 text-sm">
          <label class="inline-flex items-center gap-2"><input type="radio" name="apply-scope" value="day"> ×¨×§ ×”×ª××¨×™×š ×”×–×”</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="apply-scope" value="dest" checked> ×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×”×–×”</label>
          <label class="inline-flex items-center gap-2"><input type="radio" name="apply-scope" value="trip"> ×›×œ ×œ×•×–×™ ×”×˜×™×•×œ</label>
        </div>
      </div>

      <!-- Tabs content -->
      <div id="tab-bg" class="mt-6 space-y-4">
        <div class="flex flex-col gap-3">
          <label class="font-bold">××¦×‘ ×¨×§×¢:</label>
          <div class="flex flex-wrap gap-4 text-sm">
            <label class="inline-flex items-center gap-2"><input type="radio" name="bg-mode" value="image" checked> ×ª××•× ×ª ×¨×§×¢</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="bg-mode" value="color"> ×¦×‘×¢ ×¨×§×¢</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="bg-mode" value="none"> ×œ×œ× ×¨×§×¢</label>
          </div>
        </div>

        <!-- Image -->
        <div id="bg-image-fields" class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-bold mb-1">×§×™×©×•×¨ ×œ×ª××•× ×”:</label>
            <input id="bg-image-url" type="url" placeholder="https://example.com/image.jpg" class="w-full border rounded-lg px-3 py-2">
          </div>
          <div>
            <label class="block font-bold mb-1">×‘×”×™×¨×•×ª (0â€“100):</label>
            <input id="bg-brightness" type="range" min="0" max="100" value="50" class="w-full">
          </div>
        </div>

        <!-- Color -->
        <div id="bg-color-fields" class="grid sm:grid-cols-2 gap-4 hidden">
          <div>
            <label class="block font-bold mb-1">×‘×—×¨ ×¦×‘×¢ ×¨×§×¢:</label>
            <input id="bg-color" type="color" value="#0ea5e9" class="w-24 h-10 border rounded">
          </div>
          <div>
            <label class="block font-bold mb-1">×‘×”×™×¨×•×ª (0â€“100):</label>
            <input id="bg-color-brightness" type="range" min="0" max="100" value="50" class="w-full">
          </div>
        </div>
      </div>

      <div id="tab-layout" class="mt-6 space-y-4 hidden">
        <label class="block font-bold">×¡×’× ×•×Ÿ ×¢×™×¦×•×‘ ×”×œ×•×–:</label>
        <div class="grid sm:grid-cols-2 gap-3">
          <label class="flex items-start gap-2 p-3 border rounded-lg">
            <input type="radio" name="layout-style" value="cards-modal" checked>
            <div><div class="font-bold">1) ×›×¨×˜×™×¡×™×•×ª + ×—×œ×•×Ÿ ××œ×</div><div class="text-sm text-slate-600">×›×•×ª×¨×ª, ×©×¢×•×ª, ×ª×§×¦×™×¨ ×§×¦×¨; ×¤×¨×˜×™× ××œ××™× ×‘×—×œ×•×Ÿ.</div></div>
          </label>
          <label class="flex items-start gap-2 p-3 border rounded-lg">
            <input type="radio" name="layout-style" value="cards-collapse-short">
            <div><div class="font-bold">2) ×›×¨×˜×™×¡×™×•×ª × ×¤×ª×—×•×ª (×§×¦×¨)</div><div class="text-sm text-slate-600">×›××• ×‘×“×•×’××” ×©×œ×š â€“ × ×¤×ª×— ×ª×§×¦×™×¨/×§×™×©×•×¨×™×.</div></div>
          </label>
          <label class="flex items-start gap-2 p-3 border rounded-lg">
            <input type="radio" name="layout-style" value="cards-collapse-full">
            <div><div class="font-bold">3) ×›×¨×˜×™×¡×™×•×ª × ×¤×ª×—×•×ª (××œ×)</div><div class="text-sm text-slate-600">× ×¤×ª×— ×›×œ ×”×¤×™×¨×•×˜, ×›×•×œ×œ ×›×ª×•×‘×ª/××¤×”/×§×™×©×•×¨×™×.</div></div>
          </label>
          <label class="flex items-start gap-2 p-3 border rounded-lg">
            <input type="radio" name="layout-style" value="cards-timeline">
            <div><div class="font-bold">4) ×§×• ×–××Ÿ ××•×“×’×©</div><div class="text-sm text-slate-600">×§×• ×× ×›×™ ××•×“×’×© ×•×©×¢×•×ª ×œ×¦×“ ×”×§×•.</div></div>
          </label>
        </div>
      </div>

      <div id="tab-cards" class="mt-6 space-y-4 hidden">
        <div class="grid sm:grid-cols-2 gap-4">
          <div>
            <label class="block font-bold mb-1">×¦×‘×¢ ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª/××•×“×œ:</label>
            <input id="card-bg" type="color" value="#ffffff" class="w-24 h-10 border rounded">
            <div class="mt-2">
              <label class="block text-sm">×‘×”×™×¨×•×ª (×©×§×™×¤×•×ª) 0â€“100:</label>
              <input id="card-bg-alpha" type="range" min="0" max="100" value="90" class="w-full">
            </div>
          </div>
          <div>
            <label class="block font-bold mb-1">×¦×‘×¢ ×˜×§×¡×˜ ×›×¨×˜×™×¡×™×•×ª/××•×“×œ:</label>
            <input id="card-text" type="color" value="#0f172a" class="w-24 h-10 border rounded">
          </div>
        </div>

        <div class="mt-4">
          <label class="block font-bold mb-2">×¤×¨×™×¡×˜×™× ××•×›× ×™×:</label>
          <div id="preset-themes" class="grid sm:grid-cols-2 gap-3 text-sm">
            <button data-theme="glass-white" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              ×) ×›×¨×˜×™×¡×™×•×ª ×©×§×•×¤×•×ª â€“ ×›×™×ª×•×‘ ×œ×‘×Ÿ
            </button>
            <button data-theme="plain-white" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              ×‘) ×›×¨×˜×™×¡×™×” ×œ×‘× ×”, ×›×™×ª×•×‘ ×©×—×•×¨
            </button>
            <button data-theme="dark-slate" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              1) ×›×”×” ××œ×’× ×˜×™
            </button>
            <button data-theme="cream" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              2) ×©×× ×ª ×¢×“×™×Ÿ
            </button>
            <button data-theme="sea" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              3) ×ª×›×•×œ ×™×
            </button>
            <button data-theme="sage" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              4) ×™×¨×•×§ ××¨×•×•×”
            </button>
            <button data-theme="glass-gray" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              5) ×–×›×•×›×™×ª 70%
            </button>
            <button data-theme="soft-purple" class="px-3 py-2 border rounded-lg hover:bg-slate-50 text-left">
              6) ×¡×’×•×œ ×¢×“×™×Ÿ
            </button>
          </div>
        </div>
      </div>

      <div class="mt-6 flex justify-end gap-3">
        <button id="settings-cancel" class="px-4 py-2 rounded-lg border">×‘×™×˜×•×œ</button>
        <button id="settings-apply" class="px-4 py-2 rounded-lg bg-blue-600 text-white font-bold">×©××™×¨×”</button>
      </div>
    </div>
  </div>

  <!-- Item Modal -->
  <div id="item-modal" class="modal">
    <div class="modal-card overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <h3 id="item-modal-title" class="text-xl font-bold"></h3>
        <button id="item-close" class="p-2 text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div id="item-modal-body" class="p-4"></div>
      <div class="p-4 pt-0">
        <!-- ××¤×” ×‘×ª×•×š ×”××•×“×œ (OSM) -->
        <div id="item-modal-map" class="mt-3"></div>
      </div>
    </div>
  </div>

  <!-- Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-3">
            <!-- ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ -->
            <button id="trip-btn" class="px-3 py-2 rounded-lg border text-slate-700 hover:bg-slate-50" title="×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ">
              <i class="fa-solid fa-arrow-right"></i> ×œ×“×£ ×”×˜×™×•×œ
            </button>
            <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
          </div>
          <div class="flex items-center gap-2">
            <div id="auth-container" class="flex items-center"></div>
            <!-- ×›×¤×ª×•×¨ ×”×’×“×¨×•×ª -->
            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×”×’×“×¨×•×ª ×¢×™×¦×•×‘"><i class="fa-solid fa-sliders"></i></button>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <!-- Trip/title banner -->
    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <!-- Summary card -->
        <section class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 leaf-badge">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold text-slate-800">×œ×•×– ×œ×™×•×</h2>
              <p id="trip-subtitle" class="text-slate-500 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 text-slate-600">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
        </section>

        <!-- Timeline -->
        <section id="timeline-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5">
          <div id="no-schedule" class="text-center p-10">
            <i class="fa-regular fa-clock fa-3x text-slate-400 mb-4"></i>
            <h3 class="text-xl font-bold text-slate-700 mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
            <p class="text-slate-500">×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
          </div>
          <div id="timeline" class="timeline space-y-4 hidden"></div>
        </section>

        <!-- Notes/Tips -->
        <section id="notes-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5">
          <h3 class="text-lg font-bold text-slate-800 mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
          <div id="notes-list" class="grid gap-3">
            <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
          </div>
        </section>

        <!-- Route Map -->
        <section id="route-map-section" class="bg-white/80 backdrop-blur-md rounded-2xl shadow-lg p-5 hidden">
          <h3 class="text-lg font-bold text-slate-800 mb-3">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
          <div id="route-map" class="rounded-xl"></div>
          <div id="route-legend" class="mt-3 text-sm grid gap-1"></div>
        </section>

        <!-- CTA ("×¦×•×¨ ×œ×•×–" / "×¢×¨×•×š ×œ×•×–") -->
        <section class="flex justify-center">
          <a id="action-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            ×¦×•×¨ ×œ×•×–
          </a>
        </section>

      </div>
    </main>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, where, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- State ----------
    let currentUser = null;
    let tripId = null;
    let tripData = null;

    let dateStr = null;   // ××”-URL
    let dateISO = null;   // yyyy-mm-dd
    let dayNameHe = "";

    let destForDate = null;
    let destKey = null;

    // ×¢×™×¦×•×‘
    let layoutStyle = 'cards-modal'; // ×‘×¨×™×¨×ª ××—×“×œ

    // UI
    const initialLoader   = document.getElementById('initial-loader');
    const mainContent     = document.getElementById('main-content');
    const pageBg          = document.getElementById('page-bg');
    const pageDim         = document.getElementById('page-dim');
    const loaderBg        = document.getElementById('loader-bg');
    const pageDimLoader   = document.getElementById('page-dim-loader');

    const sidebar         = document.getElementById('sidebar');
    const hamburgerBtn    = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay         = document.getElementById('overlay');
    const mainMenu        = document.getElementById('main-menu');
    const authContainer   = document.getElementById('auth-container');

    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl       = document.getElementById('day-title');
    const tripSubtitle     = document.getElementById('trip-subtitle');
    const dateChip         = document.getElementById('date-chip');

    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox   = document.getElementById('timeline');
    const actionBtn     = document.getElementById('action-btn');

    const notesList     = document.getElementById('notes-list');

    const routeMapSection = document.getElementById('route-map-section');
    const routeMapDiv    = document.getElementById('route-map');
    const routeLegend    = document.getElementById('route-legend');

    const tripBtn        = document.getElementById('trip-btn');
    const settingsBtn    = document.getElementById('settings-btn');

    // Settings modal elems
    const modalOverlay   = document.getElementById('modal-overlay');
    const settingsModal  = document.getElementById('settings-modal');
    const settingsClose  = document.getElementById('settings-close');
    const settingsCancel = document.getElementById('settings-cancel');
    const settingsApply  = document.getElementById('settings-apply');
    const settingsTabs   = [...document.querySelectorAll('.settings-tab')];

    function showModal(el){ modalOverlay.style.display='block'; el.style.display='block'; }
    function hideModal(el){ modalOverlay.style.display='none'; el.style.display='none'; }

    // ---------- Helpers ----------
    function toggleSidebar(){ sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }

    function parseLocalDateFlexible(s) {
      if (!s) return null;
      const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/);
      if (!m) return null;
      let d = +m[1], mo = +m[2], y = +m[3];
      if (y < 100) y += 2000;
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
    function toISODateUTC(d) {
      const yyyy = d.getUTCFullYear();
      const mm = String(d.getUTCMonth()+1).padStart(2,'0');
      const dd = String(d.getUTCDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`;
    }
    function hebWeekdayUTC(d) {
      const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª'];
      return names[d.getUTCDay()];
    }

    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const start = parseLocalDateFlexible(startStr);
      const end = parseLocalDateFlexible(endStr);
      if (!start || !end) return [];
      const out = [];
      for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) {
        out.push(new Date(t.getTime()));
      }
      return out;
    }

    function normKey(str){
      if (!str) return '';
      return String(str).toLowerCase().trim().replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    }

    function findDestinationForDate(trip, rawDDMMYYYY) {
      const target = parseLocalDateFlexible(rawDDMMYYYY);
      if (!target) return null;
      const targetISO = toISODateUTC(target);
      return (trip.destinations || []).find(dest => {
        const days = generateDatesFromRange(dest.dates);
        const isoList = days.map(d => toISODateUTC(d));
        return isoList.includes(targetISO);
      }) || null;
    }

    function setBackgroundForDestOrDesign(bg){
      const dim = (bg?.brightness!=null) ? (1 - Math.max(0,Math.min(100,bg.brightness))/100) : 0.5;
      pageDim.style.backgroundColor = `rgba(0,0,0,${dim})`;
      pageDimLoader.style.backgroundColor = `rgba(0,0,0,${dim})`;

      if (bg?.mode === 'color') {
        pageBg.style.backgroundImage = 'none';
        pageBg.style.backgroundColor = bg.color || '#0ea5e9';
        loaderBg.style.backgroundImage = 'none';
        loaderBg.style.backgroundColor = bg.color || '#0ea5e9';
      } else if (bg?.mode === 'none') {
        pageBg.style.backgroundImage = 'none';
        pageBg.style.backgroundColor = '#0b1220';
        loaderBg.style.backgroundImage = 'none';
        loaderBg.style.backgroundColor = '#0b1220';
      } else {
        const url = bg?.imageUrl || destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg';
        pageBg.style.backgroundImage = `url('${url}')`;
        pageBg.style.backgroundColor = '';
        loaderBg.style.backgroundImage = `url('${url}')`;
        loaderBg.style.backgroundColor = '';
      }
    }

    function applyTheme(theme){
      const alpha = (v)=> Math.max(0,Math.min(100, v ?? 100))/100;
      const toRGBA = (hex, a=1)=>{
        if (!hex) return `rgba(255,255,255,${a})`;
        const m = hex.replace('#','');
        const r = parseInt(m.substring(0,2),16);
        const g = parseInt(m.substring(2,4),16);
        const b = parseInt(m.substring(4,6),16);
        return `rgba(${r},${g},${b},${a})`;
      };
      document.documentElement.style.setProperty('--card-bg',  toRGBA(theme.cardBg || '#ffffff', alpha(theme.cardAlpha ?? 90)));
      document.documentElement.style.setProperty('--card-text', theme.cardText || '#0f172a');
      document.documentElement.style.setProperty('--modal-bg', toRGBA(theme.modalBg || theme.cardBg || '#ffffff', alpha(theme.modalAlpha ?? 100)));
      document.documentElement.style.setProperty('--modal-text', theme.modalText || theme.cardText || '#0f172a');
    }

    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        const dates = generateDatesFromRange(dest.dates);
        dates.forEach(dObj => {
          const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
          const a = document.createElement('a');
          a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
          a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
          a.textContent = `×œ×•"×– ×œ×™×•× ${nice}`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', () => {
          submenu.classList.toggle('open');
          btn.querySelector('i').classList.toggle('rotate-180');
        });
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function renderHeadline(dayTitleFromDoc = null) {
      const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
      const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
      scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
      dayTitleEl.textContent = dayTitleFromDoc
        ? `${dayTitleFromDoc} â€¢ ${dateStr}`
        : `×œ×•×– ×œ×™×•× ${dateStr}`;
      tripSubtitle.textContent = dayPart ? `${destName} â€¢ ${dayPart}` : destName;
      dateChip.textContent = dayPart ? `${dateStr} â€¢ ${dayNameHe}` : dateStr;
    }

    // ×§×™×©×•×¨×™×/× ×™×•×•×˜ â€“ ×¦×‘×¢×™× ×§×‘×•×¢×™×: ××¤×•×ª=×™×¨×•×§, ×•×™×™×–=×›×—×•×œ, ××ª×¨=×ª×›×œ×ª, ×”×–×× ×”=×˜×•×¨×§×™×–
    function linkButtons(it, compact=false){
      const hasAddr = !!it.address?.label;
      const hasSite = !!it.links?.site;
      const hasBook = !!it.links?.booking;
      const refs = Array.isArray(it.refs)? it.refs : [];

      const refsHtml = refs.map(r=>{
        const href = `${r.page==='summary'?'summary':'attractions'}.html?tripId=${encodeURIComponent(tripId)}&open=${r.type==='logistics'?'logistics':'attraction'}&id=${encodeURIComponent(r.id)}`;
        const icon = r.type==='logistics' ? (r.subType==='hotel'?'ğŸ¨':r.subType==='flight'?'âœˆï¸':r.subType==='train'?'ğŸš†':r.subType==='car_rental'?'ğŸš—':r.subType==='ferry'?'â›´ï¸':'â¬…ï¸') : 'ğŸ“';
        return `<a class="px-2 py-1 rounded bg-indigo-600/90 text-white text-xs" target="_blank" href="${href}">${icon} ${r.label}</a>`;
      }).join(' ');

      const linksHtml = [
        hasSite ? `<a class="inline-flex items-center gap-1 text-sky-600 hover:underline" href="${it.links.site}" target="_blank"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
        hasBook ? `<a class="inline-flex items-center gap-1 text-teal-600 hover:underline" href="${it.links.booking}" target="_blank"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
        refsHtml
      ].filter(Boolean).join(' ');

      const navHtml = hasAddr ? `
        <div class="flex gap-2">
          <a class="px-2 py-1 rounded bg-blue-600 text-white text-xs" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(it.address.label)}"><i class="fa-brands fa-waze"></i> ×•×™×™×–</a>
          <a class="px-2 py-1 rounded bg-green-600 text-white text-xs" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}"><i class="fa-solid fa-location-dot"></i> ××¤×•×ª</a>
        </div>
      ` : '';

      if (compact){
        return { linksHtml, navHtml };
      }
      return linksHtml + (navHtml ? `<div class="mt-2">${navHtml}</div>` : '');
    }

    function itemIcon(it){
      if (it.isBackToHotel) return 'fa-bed';
      return (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs) ? 'fa-triangle-exclamation' : 'fa-location-dot';
    }
    function timeText(it){
      if (!it?.startTime && !it?.endTime) return '--:--';
      return [it.startTime || '', it.endTime ? 'â€“ '+it.endTime : ''].filter(Boolean).join(' ');
    }
    function distanceText(m){
      if (m==null) return '';
      const km = (m/1000).toFixed(2);
      return `<span class="text-xs text-slate-500"> â€¢ ××¨×—×§ ×§×•×“×: ${km} ×§×´×</span>`;
    }
    function verifyBadge(it){
      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      if (!needs) return '';
      const list = [
        it.needsVerifyAddress?'×›×ª×•×‘×ª':null,
        it.needsVerifyRoute?'××¡×œ×•×œ':null,
        it.needsVerifyRefs?'×§×™×©×•×¨':null
      ].filter(Boolean).join(' / ');
      return `<span class="inline-flex items-center gap-1 text-[12px] px-2 py-0.5 rounded-full bg-red-100 text-red-800 border border-red-300"><i class="fa-solid fa-circle-exclamation"></i> ×“×¨×•×© ××™××•×ª${list?': '+list:''}</span>`;
    }

    // ---------- ITEM MODAL MAP ----------
    let itemModalMap = null;
    function destroyItemMap(){
      try { if (itemModalMap) { itemModalMap.remove(); itemModalMap = null; } } catch {}
    }

    async function geocodeAddress(label){
      if (!label) return null;
      const key = 'geo__' + label.trim().toLowerCase();
      try {
        const cached = sessionStorage.getItem(key);
        if (cached) return JSON.parse(cached);
      } catch {}
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(label)}&limit=1&addressdetails=0`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
      const data = await res.json();
      if (Array.isArray(data) && data[0]) {
        const obj = { lat: +data[0].lat, lng: +data[0].lon, label };
        try { sessionStorage.setItem(key, JSON.stringify(obj)); } catch {}
        return obj;
      }
      return null;
    }

    async function mountItemMapFor(it){
      destroyItemMap();
      const holder = document.getElementById('item-modal-map');
      holder.innerHTML = '';
      const addr = it.address?.label;
      const hasLatLng = it.address?.lat!=null && it.address?.lng!=null;
      let pos = null;
      if (hasLatLng) pos = { lat:+it.address.lat, lng:+it.address.lng, label: addr || '' };
      else if (addr) pos = await geocodeAddress(addr);

      if (!pos) { holder.innerHTML = '<div class="bg-slate-100 text-slate-500 rounded-lg h-full flex items-center justify-center">×œ× × ××¦××” ×›×ª×•×‘×ª ×œ×”×¦×’×” ×‘××¤×”.</div>'; return; }

      itemModalMap = L.map('item-modal-map');
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19, attribution: '&copy; OpenStreetMap'
      }).addTo(itemModalMap);

      L.marker([pos.lat, pos.lng]).addTo(itemModalMap).bindPopup(pos.label || '××™×§×•×');
      itemModalMap.setView([pos.lat, pos.lng], 14);
      // ×× ×™×© ×’× ×™×¢×“/××§×•×¨ ×‘-travel â€“ × ×¦×™×™×¨ ×§×•
      const from = it.travel?.from?.lat && it.travel?.from?.lng ? {lat:it.travel.from.lat, lng:it.travel.from.lng, label: it.travel.from.label||''} : null;
      const to   = it.travel?.to?.lat   && it.travel?.to?.lng   ? {lat:it.travel.to.lat, lng:it.travel.to.lng, label: it.travel.to.label||''} : null;
      const points = [];
      if (from) { points.push([from.lat, from.lng]); L.marker([from.lat, from.lng]).addTo(itemModalMap).bindPopup(from.label||'××•×¦×'); }
      points.push([pos.lat, pos.lng]);
      if (to) { points.push([to.lat, to.lng]); L.marker([to.lat, to.lng]).addTo(itemModalMap).bindPopup(to.label||'×™×¢×“'); }
      if (points.length>1){
        L.polyline(points, { color:'#2563eb', weight:4, opacity:.9 }).addTo(itemModalMap);
        itemModalMap.fitBounds(points, { padding:[30,30] });
      }
    }

    function openItemModal(it){
      const title = it.title || '×¤×¨×™×˜ ×œ×œ× ×©×';
      const { linksHtml, navHtml } = linkButtons(it,true);
      document.getElementById('item-modal-title').textContent = title;
      document.getElementById('item-modal-body').innerHTML = `
        ${it.image ? `<img src="${it.image}" alt="" class="no-shift-img">` : ''}
        <div class="mt-3 space-y-2">
          <div class="text-slate-600 text-sm">${timeText(it)} ${distanceText(it.distanceFromPreviousMeters)}</div>
          ${it.summary ? `<div class="text-slate-700">${it.summary}</div>` : ''}
          ${it.description ? `<div class="text-slate-700 whitespace-pre-wrap">${it.description}</div>` : ''}
          ${it.address?.label ? `<div class="text-sm text-slate-600"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>` : ''}
          ${it.travel?.from?.label || it.travel?.to?.label ? `
            <div class="text-xs text-slate-600">
              <i class="fa-solid fa-route text-slate-400"></i>
              ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''}
              ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''}
              ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}
            </div>`:''}
          ${linksHtml ? `<div class="flex flex-wrap gap-2">${linksHtml}</div>` : ''}
          ${navHtml ? `<div class="mt-2">${navHtml}</div>` : ''}
        </div>
      `;
      showModal(document.getElementById('item-modal'));
      // ×”×¨ ×›×¨×˜×™×¡ ××¤×”
      mountItemMapFor(it).catch(()=>{});
    }

    function renderItemCard(it, idx){
      // ×©×œ×“ ×¨××©×™ ×–×”×” â€“ ×‘×ª×•×š ×”×’×•×£ ××©×ª× ×” ×œ×¤×™ layout
      const container = document.createElement('div');
      container.className = 'timeline-item rounded-xl shadow p-4';
      const head = `
        <span class="timeline-dot"></span>
        <div class="flex items-start gap-4">
          <div class="shrink-0 text-center">
            <div class="text-sm font-bold text-slate-700">${timeText(it)}</div>
            <div class="text-xs text-slate-500">×¤×¨×™×˜</div>
          </div>
          <div class="flex-1">
            <div class="flex items-center gap-2 flex-wrap">
              <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
              <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
              ${verifyBadge(it)}
              ${distanceText(it.distanceFromPreviousMeters)}
            </div>
            <div class="item-body mt-2"></div>
          </div>
        </div>
      `;
      container.innerHTML = head;
      const body = container.querySelector('.item-body');

      if (layoutStyle === 'cards-modal'){
        // ×ª×¦×•×’×ª ×ª×§×¦×™×¨ + ×›×¤×ª×•×¨ "×¤×¨×˜×™× ××œ××™×"; ×›×œ ×”×›×¨×˜×™×¡×™×” ×¤×•×ª×—×ª ××•×“×œ
        if (it.summary) body.innerHTML = `<div class="text-slate-700">${it.summary}</div>`;
        const { linksHtml, navHtml } = linkButtons(it,true);
        const actions = document.createElement('div');
        actions.className = 'mt-3 flex flex-wrap gap-2';
        actions.innerHTML = (linksHtml?linksHtml:'') + (navHtml?`<div class="mt-2 w-full">${navHtml}</div>`:'');
        const detailsBtn = document.createElement('button');
        detailsBtn.className = 'mt-2 inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border';
        detailsBtn.innerHTML = '<i class="fa-regular fa-rectangle-list"></i> ×¤×¨×˜×™× ××œ××™×';
        detailsBtn.addEventListener('click', (e)=>{ e.stopPropagation(); openItemModal(it); });
        body.appendChild(detailsBtn);
        body.appendChild(actions);
        container.addEventListener('click', (e)=>{
          if (e.target.closest('a,button')) return;
          openItemModal(it);
        });

      } else if (layoutStyle === 'cards-collapse-short' || layoutStyle === 'cards-collapse-full'){
        // ×›×¨×˜×™×¡×™×” × ×¤×ª×—×ª â€“ ×‘×¡×’× ×•×Ÿ ×”×“×•×’××” ×©×œ×š (details/summary + ×¦'×‘×¨×•×Ÿ ××¡×ª×•×‘×‘)
        const minimal = `
          <details class="group bg-white/40 backdrop-blur-[2px] rounded-lg border border-slate-200">
            <summary class="flex items-center justify-between p-3">
              <div class="text-sm text-slate-600">
                ${it.summary ? `<div class="text-slate-700">${it.summary}</div>` : '<div class="text-slate-400">×œ×—×¥ ×œ×”×¦×’×ª ×¤×¨×˜×™×</div>'}
              </div>
              <i class="fas fa-chevron-down chevron-icon text-slate-500"></i>
            </summary>
            <div class="px-3 pb-3 space-y-2">
              ${layoutStyle==='cards-collapse-full' && it.description ? `<div class="text-slate-700 whitespace-pre-wrap">${it.description}</div>` : ''}
              ${it.address?.label ? `<div class="text-sm text-slate-600"><i class="fa-solid fa-location-dot mr-1 text-slate-400"></i>${it.address.label}</div>` : ''}
              ${it.travel?.from?.label || it.travel?.to?.label ? `
                <div class="text-xs text-slate-600">
                  <i class="fa-solid fa-route text-slate-400"></i>
                  ${it.travel?.from?.label ? `×Ö¾${it.travel.from.label}`:''}
                  ${it.travel?.to?.label ? ` ××œ ${it.travel.to.label}`:''}
                  ${it.travel?.timeText ? ` â€¢ ${it.travel.timeText}` : ''}
                </div>`:''}
              <div class="flex flex-wrap gap-2">
                ${linkButtons(it,true).linksHtml || ''}
              </div>
              ${linkButtons(it,true).navHtml ? `<div class="">${linkButtons(it,true).navHtml}</div>` : ''}
              <div>
                <button class="mt-1 inline-flex items-center gap-2 px-3 py-1.5 rounded-lg border open-full-btn">
                  <i class="fa-regular fa-rectangle-list"></i> ×¤×¨×˜×™× ××œ××™×
                </button>
              </div>
            </div>
          </details>
        `;
        body.innerHTML = minimal;
        body.querySelector('.open-full-btn')?.addEventListener('click', (e)=>{ e.stopPropagation(); openItemModal(it); });

      } else { // 'cards-timeline'
        if (it.description) body.innerHTML = `<div class="text-slate-700 whitespace-pre-wrap">${it.description}</div>`;
        const { linksHtml, navHtml } = linkButtons(it,true);
        const actions = document.createElement('div');
        actions.className = 'mt-3 flex flex-wrap gap-2';
        actions.innerHTML = (linksHtml?linksHtml:'') + (navHtml?`<div class="mt-2 w-full">${navHtml}</div>`:'');
        body.appendChild(actions);
      }

      return container;
    }

    function renderTimelineFromItems(items){
      if (!items || items.length === 0) {
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        timelineBox.innerHTML = '';
        actionBtn.innerHTML = `<i class="fa-solid fa-wand-magic-sparkles"></i> ×¦×•×¨ ×œ×•×–`;
        routeMapSection.classList.add('hidden');
        return;
      }
      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      timelineBox.innerHTML = '';

      items.forEach((it, idx)=>{
        const el = renderItemCard(it, idx);
        timelineBox.appendChild(el);
      });

      // CTA: ×™×© ×¤×¨×™×˜×™× -> "×¢×¨×•×š ×œ×•×–" ×‘×œ×‘×“ (×œ××˜×”)
      actionBtn.innerHTML = `<i class="fa-solid fa-pen"></i> ×¢×¨×•×š ×œ×•×–`;

      // ××¤×” ×™×•××™×ª
      buildRouteMap(items).catch(()=>{ /* ×©×§×˜ */ });
    }

    const colorMap = {
      red:    {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:  {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:   {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow: {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange: {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    function classesForColor(c){
      const m = colorMap[c] || colorMap.yellow;
      return `${m.bg} ${m.border} ${m.text}`;
    }
    function renderNotesList(notes){
      const notesList = document.getElementById('notes-list');
      if (!notes || notes.length===0){
        notesList.innerHTML = `<div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const cls = classesForColor(n.color);
        return `
          <div class="border rounded-xl p-3 ${cls}">
            <div class="font-bold">${n.kind}: ${n.title || 'â€”'}</div>
            ${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap">${n.details}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ---------- Route Map (Leaflet + ×’×³×™××•×§×•×“ ×¤×©×•×˜) ----------
    let routeMap = null;
    const segmentColors = ['#2563eb','#dc2626','#10b981','#a855f7','#f59e0b','#06b6d4','#ef4444','#22c55e'];
    const geocodeCacheKey = 'geocodeCache_v1';
    let geocodeCache = {};
    try { geocodeCache = JSON.parse(localStorage.getItem(geocodeCacheKey) || '{}'); } catch {}

    async function geocodeForRoute(label){
      if (!label) return null;
      const key = label.trim().toLowerCase();
      if (geocodeCache[key]) return geocodeCache[key];
      const url = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(label)}&limit=1&addressdetails=0`;
      const res = await fetch(url, { headers: { 'Accept': 'application/json' } });
      if (!res.ok) return null;
      const data = await res.json();
      if (Array.isArray(data) && data[0]) {
        const obj = { lat: +data[0].lat, lng: +data[0].lon, label };
        geocodeCache[key] = obj;
        try { localStorage.setItem(geocodeCacheKey, JSON.stringify(geocodeCache)); } catch {}
        return obj;
      }
      return null;
    }

    function approxArrow(bearing){
      const dirs = ['â†‘','â†—','â†’','â†˜','â†“','â†™','â†','â†–'];
      const idx = Math.round(((bearing%360)+360)%360 / 45) % 8;
      return dirs[idx];
    }
    function bearingBetween(a,b){
      const toRad = d=> d*Math.PI/180;
      const toDeg = r=> r*180/Math.PI;
      const Ï†1 = toRad(a.lat), Ï†2 = toRad(b.lat);
      const Î”Î» = toRad(b.lng - a.lng);
      const y = Math.sin(Î”Î») * Math.cos(Ï†2);
      const x = Math.cos(Ï†1)*Math.cos(Ï†2) - Math.sin(Ï†1)*Math.sin(Ï†2)*Math.cos(Î”Î»);
      return (toDeg(Math.atan2(y,x)) + 360) % 360;
    }

    async function buildRouteMap(items){
      const placesRaw = items
        .map(it => it.address?.label ? ({ label: it.address.label, lat: it.address.lat, lng: it.address.lng }) : null)
        .filter(Boolean);

      if (placesRaw.length === 0){
        routeMapSection.classList.add('hidden');
        return;
      }

      const places = [];
      for (let p of placesRaw){
        if (p.lat!=null && p.lng!=null){
          places.push({ lat:+p.lat, lng:+p.lng, label:p.label });
        } else {
          const g = await geocodeForRoute(p.label);
          if (g) places.push(g);
          await new Promise(r=>setTimeout(r, 550));
        }
      }

      if (places.length < 1){
        routeMapSection.classList.add('hidden');
        return;
      }

      routeMapSection.classList.remove('hidden');

      if (!routeMap){
        routeMap = L.map('route-map', { zoomSnap: 0.25, scrollWheelZoom: true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(routeMap);
      }

      // × ×§×” ×©×›×‘×•×ª ×™×©× ×•×ª ×©×œ ×§×•×•×™×/×¡×× ×™×
      routeMap.eachLayer(l=>{ if (l instanceof L.Polyline || l instanceof L.Marker) { try{ routeMap.removeLayer(l);}catch{} } });

      const bounds = [];
      const legendRows = [];

      // ××¨×§×¨×™×
      places.forEach((p, idx)=>{
        L.marker([p.lat, p.lng]).addTo(routeMap).bindPopup(`${idx+1}. ${p.label}`);
        bounds.push([p.lat, p.lng]);
      });

      // ×§×˜×¢×™× ×¢× ×¦×‘×¢×™× ×•×—×¥ ×˜×§×¡×˜×•××œ×™ ×‘××¨×›×–
      for (let i=1;i<places.length;i++){
        const a = places[i-1], b = places[i];
        const color = segmentColors[(i-1) % segmentColors.length];
        L.polyline([[a.lat,a.lng],[b.lat,b.lng]], { color, weight: 4, opacity: 0.9 }).addTo(routeMap);

        const mid = { lat: (a.lat+b.lat)/2, lng: (a.lng+b.lng)/2 };
        const brg = bearingBetween(a,b);
        const arr = approxArrow(brg);
        L.marker([mid.lat, mid.lng], {
          icon: L.divIcon({ className: 'text-lg', html: `<div style="transform: translate(-50%,-50%); color:${color}; font-weight:700">${arr}</div>` })
        }).addTo(routeMap);

        legendRows.push(`<div class="inline-flex items-center gap-2">
          <span class="inline-block w-3 h-3 rounded-full" style="background:${color}"></span>
          <span>${a.label} &gt; ${b.label}</span>
        </div>`);
      }

      if (bounds.length){
        routeMap.fitBounds(bounds, { padding:[30,30] });
      }

      routeLegend.innerHTML = legendRows.join('<br>');
    }

    // ---------- Events ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);

      // ×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ (×¢×•×“×›× ×” ×œ-trip.html)
      tripBtn.addEventListener('click', ()=>{
        if (tripId) window.location.href = `trip.html?tripId=${encodeURIComponent(tripId)}`;
        else window.location.href = 'index.html';
      });

      // ×”×’×“×¨×•×ª
      settingsBtn.addEventListener('click', ()=> showModal(settingsModal));
      settingsClose.addEventListener('click', ()=> hideModal(settingsModal));
      settingsCancel.addEventListener('click', ()=> hideModal(settingsModal));
      modalOverlay.addEventListener('click', ()=> { hideModal(settingsModal); hideModal(document.getElementById('item-modal')); destroyItemMap(); });
      document.getElementById('item-close').addEventListener('click', ()=> { hideModal(document.getElementById('item-modal')); destroyItemMap(); });

      // Tabs
      settingsTabs.forEach(btn=>{
        btn.addEventListener('click', ()=>{
          settingsTabs.forEach(b=> b.classList.remove('bg-sky-50','text-sky-700'));
          btn.classList.add('bg-sky-50','text-sky-700');
          ['bg','layout','cards'].forEach(tab=>{
            document.getElementById('tab-'+tab).classList.toggle('hidden', btn.dataset.tab!==tab);
          });
        });
      });

      // ××¦×‘ ×¨×§×¢ - ×”×¦×’×ª ×©×“×•×ª
      const bgModeRadios = document.querySelectorAll('input[name="bg-mode"]');
      bgModeRadios.forEach(r=>{
        r.addEventListener('change', ()=>{
          const mode = document.querySelector('input[name="bg-mode"]:checked').value;
          document.getElementById('bg-image-fields').classList.toggle('hidden', mode!=='image');
          document.getElementById('bg-color-fields').classList.toggle('hidden', mode!=='color');
        });
      });

      // ×¤×¨×™×¡×˜×™×
      document.getElementById('preset-themes').addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-theme]');
        if (!btn) return;
        const t = btn.dataset.theme;
        const map = {
          'glass-white': { cardBg:'#ffffff', cardAlpha:30, cardText:'#ffffff', modalBg:'#111827', modalAlpha:95, modalText:'#ffffff' },
          'plain-white': { cardBg:'#ffffff', cardAlpha:95, cardText:'#0f172a', modalBg:'#ffffff', modalAlpha:100, modalText:'#0f172a' },
          'dark-slate' : { cardBg:'#0f172a', cardAlpha:95, cardText:'#ffffff', modalBg:'#0b1220', modalAlpha:98, modalText:'#ffffff' },
          'cream'      : { cardBg:'#fffaf0', cardAlpha:95, cardText:'#1f2937', modalBg:'#fffaf0', modalAlpha:98, modalText:'#111827' },
          'sea'        : { cardBg:'#e0f2fe', cardAlpha:95, cardText:'#0c4a6e', modalBg:'#e0f2fe', modalAlpha:98, modalText:'#082f49' },
          'sage'       : { cardBg:'#ecfdf5', cardAlpha:95, cardText:'#064e3b', modalBg:'#ecfdf5', modalAlpha:98, modalText:'#022c22' },
          'glass-gray' : { cardBg:'#ffffff', cardAlpha:70, cardText:'#111827', modalBg:'#ffffff', modalAlpha:92, modalText:'#111827' },
          'soft-purple': { cardBg:'#f5f3ff', cardAlpha:95, cardText:'#4c1d95', modalBg:'#ede9fe', modalAlpha:98, modalText:'#3730a3' },
        };
        const th = map[t];
        if (!th) return;
        document.getElementById('card-bg').value = th.cardBg;
        document.getElementById('card-bg-alpha').value = th.cardAlpha;
        document.getElementById('card-text').value = th.cardText;
        applyTheme(th);
      });

      // ×©××™×¨×”
      settingsApply.addEventListener('click', saveSettingsFromModal);
    }

    // ---------- Design persistence (Firestore) ----------
    async function loadDesign(){
      const globalRef = doc(db, 'trips', tripId, 'design', 'global');
      const destRef   = doc(db, 'trips', tripId, 'design', `dest__${destKey}`);
      let dayDoc = null, globalDoc=null, destDoc=null;

      if (dateISO){
        const schedRef = doc(db, 'trips', tripId, 'schedules', dateISO);
        const s = await getDoc(schedRef);
        if (s.exists()){
          const d = s.data()?.design;
          if (d) dayDoc = d;
        }
      }
      const g = await getDoc(globalRef);
      if (g.exists()) globalDoc = g.data();
      const d = await getDoc(destRef);
      if (d.exists()) destDoc = d.data();

      const merged = {
        bg:   dayDoc?.bg   ?? destDoc?.bg   ?? globalDoc?.bg   ?? null,
        theme:dayDoc?.theme?? destDoc?.theme?? globalDoc?.theme?? null,
        layout:dayDoc?.layout?? destDoc?.layout?? globalDoc?.layout?? null,
      };
      if (merged.bg) setBackgroundForDestOrDesign(merged.bg);
      if (merged.theme) applyTheme(merged.theme);
      if (merged.layout) layoutStyle = merged.layout;
      hydrateSettingsModal(merged);
    }

    function hydrateSettingsModal(merged){
      const bg = merged.bg || { mode:'image', imageUrl:'', color:'#0ea5e9', brightness:50 };
      document.querySelector(`input[name="bg-mode"][value="${bg.mode||'image'}"]`)?.click();
      if (bg.mode==='image'){
        document.getElementById('bg-image-url').value = bg.imageUrl || '';
        document.getElementById('bg-brightness').value = bg.brightness ?? 50;
      } else if (bg.mode==='color'){
        document.getElementById('bg-color').value = bg.color || '#0ea5e9';
        document.getElementById('bg-color-brightness').value = bg.brightness ?? 50;
      }
      const lay = merged.layout || 'cards-modal';
      document.querySelector(`input[name="layout-style"][value="${lay}"]`)?.click();
      const th = merged.theme || { cardBg:'#ffffff', cardAlpha:90, cardText:'#0f172a', modalBg:'#ffffff', modalAlpha:100, modalText:'#0f172a' };
      document.getElementById('card-bg').value = th.cardBg || '#ffffff';
      document.getElementById('card-bg-alpha').value = th.cardAlpha ?? 90;
      document.getElementById('card-text').value = th.cardText || '#0f172a';
    }

    async function saveSettingsFromModal(){
      const scope = (document.querySelector('input[name="apply-scope"]:checked')?.value) || 'dest';

      // ×¨×§×¢
      const bgMode = document.querySelector('input[name="bg-mode"]:checked')?.value || 'image';
      let bg = { mode:bgMode, brightness:50 };
      if (bgMode === 'image'){
        bg.imageUrl = String(document.getElementById('bg-image-url').value || '').trim();
        bg.brightness = +document.getElementById('bg-brightness').value;
      } else if (bgMode === 'color'){
        bg.color = document.getElementById('bg-color').value || '#0ea5e9';
        bg.brightness = +document.getElementById('bg-color-brightness').value;
      }

      // Layout
      const lay = (document.querySelector('input[name="layout-style"]:checked')?.value) || 'cards-modal';

      // Theme
      const th = {
        cardBg: document.getElementById('card-bg').value || '#ffffff',
        cardAlpha: +document.getElementById('card-bg-alpha').value || 90,
        cardText: document.getElementById('card-text').value || '#0f172a',
        modalBg: document.getElementById('card-bg').value || '#ffffff',
        modalAlpha: 98,
        modalText: document.getElementById('card-text').value || '#0f172a',
      };

      // ×”×—×œ×” ××™×™×“×™×ª
      setBackgroundForDestOrDesign(bg);
      applyTheme(th);
      layoutStyle = lay;

      // ×©××™×¨×” ×œ×¤×™ scope
      if (scope === 'day' && dateISO){
        const schedRef = doc(db, 'trips', tripId, 'schedules', dateISO);
        await setDoc(schedRef, { design: { bg, theme: th, layout: lay } }, { merge:true });
      } else if (scope === 'dest'){
        const destRef = doc(db, 'trips', tripId, 'design', `dest__${destKey}`);
        await setDoc(destRef, { bg, theme: th, layout: lay }, { merge:true });
      } else {
        const globalRef = doc(db, 'trips', tripId, 'design', 'global');
        await setDoc(globalRef, { bg, theme: th, layout: lay }, { merge:true });
      }

      hideModal(settingsModal);
    }

    // ---------- Init ----------
    async function initPage() {
      const url = new URLSearchParams(window.location.search);
      tripId = url.get('tripId');
      dateStr = decodeURIComponent(url.get('date') || '').trim();

      const parsed = parseLocalDateFlexible(dateStr);
      if (parsed) {
        dateISO = toISODateUTC(parsed);
        dayNameHe = hebWeekdayUTC(parsed);
      } else {
        dateISO = null;
        dayNameHe = "";
      }

      if (!tripId || !dateStr) {
        alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.');
        location.href = 'index.html'; return;
      }

      attachEvents();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        // Load trip
        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);
        if (!tripSnap.exists()) { alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href = 'index.html'; return; }
        tripData = tripSnap.data();
        if (tripData.ownerId && tripData.ownerId !== currentUser.uid) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.'); location.href = 'index.html'; return;
        }

        // ×™×¢×“ ×œ××•×ª×• ×ª××¨×™×š
        destForDate = findDestinationForDate(tripData, dateStr);
        destKey = normKey(destForDate?.nameHe || destForDate?.name || 'dest');

        // ×¢×™×¦×•×‘ (×× × ×©××¨)
        await loadDesign();

        // ×¨×§×¢ ×™×¢×“ ×›×‘×¨×™×¨×ª ××—×“×œ ×× ××™×Ÿ ×¢×™×¦×•×‘ ×©××•×¨
        if (!pageBg.style.backgroundImage){
          const url = destForDate?.bgUrl || destForDate?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg';
          pageBg.style.backgroundImage = `url('${url}')`;
          loaderBg.style.backgroundImage = `url('${url}')`;
        }

        buildMenuFromTrip();

        // ×§×™×©×•×¨ ×¤×¢×•×œ×” ("×¦×•×¨/×¢×¨×•×š ×œ×•×–")
        const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
        const editHref   = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
        actionBtn.href = editHref;

        // ×›×•×ª×¨×ª + ×”×–× ×•×ª realtime ×œ×¤×¨×™×˜×™×/×“×’×©×™×
        if (dateISO){
          const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
          const schedSnap = await getDoc(schedDocRef);
          const dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
          renderHeadline(dayTitleFromDoc);

          // items
          const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
          const qItems = query(itemsCol, orderBy('sort','asc'));
          onSnapshot(qItems, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderTimelineFromItems(arr);
          }, ()=> renderTimelineFromItems([]));

          // notes
          const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
          const qNotes = query(notesCol, orderBy('createdAt','asc'));
          onSnapshot(qNotes, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderNotesList(arr);
          }, ()=> renderNotesList([]));
        } else {
          // fallback (events ×œ×¤×™ ××—×¨×•×–×ª)
          renderHeadline(null);
          const eventsCol = collection(db, 'trips', tripId, 'events');
          const q2 = query(eventsCol, where('date','==', dateStr), orderBy('time'));
          onSnapshot(q2, (snap) => {
            const items = snap.docs.map(d => d.data()).map(e=>({
              title: e.title,
              startTime: e.time, endTime:null,
              description: e.notes || null,
              address: e.location ? {label:e.location} : null,
              links: {site: e.link || null, booking: null},
            }));
            renderTimelineFromItems(items);
          }, () => renderTimelineFromItems([]));
          renderNotesList([]);
        }

        // Reveal UI
        initialLoader.style.opacity = '0';
        mainContent.style.opacity = '1';
        setTimeout(()=>{ initialLoader.style.display='none'; }, 500);
      });
    }

    initPage();
  </script>
</body>
</html>