<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>×œ×•×– ×™×•××™ â€¢ ××¡×¢ ×—×œ×•××•×ª</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet + PolylineDecorator -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-polylinedecorator@1.7.0/dist/leaflet.polylineDecorator.min.js"></script>

  <style>
    :root{
      /* ×‘×¨×™×¨×•×ª ××—×“×œ ×œ×ª××” (× ×™×ª×Ÿ ×œ×©×™× ×•×™ ×¢"×™ ×”×’×“×¨×•×ª) */
      --card-bg: rgba(255,255,255,0.9);
      --card-text: #0f172a;
      --modal-bg: #ffffff;
      --modal-text: #0f172a;
    }
    html, body { height: 100%; }
    body { font-family: 'Assistant', sans-serif; overflow-y: scroll; overscroll-behavior: none; scrollbar-gutter: stable both-edges; }
    #sidebar { transition: transform 0.3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    .leaf-badge { border-inline-start: 4px solid #38bdf8; }
    .timeline { position: relative; }
    .timeline::before { content: ""; position: absolute; right: 20px; top: 0; bottom: 0; width: 2px; background: rgba(30,41,59,.15); }
    .timeline-item { position: relative; padding-right: 56px; background: var(--card-bg); color: var(--card-text); }
    .timeline-dot { position: absolute; right: 12px; top: .75rem; width: 16px; height: 16px; border-radius: 9999px; background: white; box-shadow: 0 0 0 4px #e2e8f0 inset, 0 0 0 2px rgba(30,41,59,.1); }
    .bg-fixed-image { background-size: cover; background-position: center; filter: brightness(100%); }
    #initial-loader { position: fixed; inset: 0; z-index: 100; display: flex; align-items: center; justify-content: center; transition: opacity .4s ease-out; }
    @keyframes spin { from { transform: rotate(0); } to { transform: rotate(360deg); } }
    .plane-spinner { animation: spin 2s linear infinite; }

    /* ××•×“×œ ×”×’×“×¨×•×ª */
    .modal { display: none; }
    .modal.show { display: flex; }
    .modal-card { background: var(--modal-bg); color: var(--modal-text); }

    /* ××¤×ª ××¡×œ×•×œ â€“ ×©××™×¨×ª ×’×•×‘×” ×›×“×™ ×œ×× ×•×¢ "×§×¤×™×¦×•×ª" */
    #route-map-wrap { min-height: 380px; }
    #route-map { width: 100%; height: 360px; border-radius: 12px; }

    /* ×›×¤×ª×•×¨×™ ×§×™×©×•×¨×™× ×§×‘×•×¢×™-×¦×‘×¢ */
    .btn-waze   { background:#1E90FF !important; color:#fff !important; }
    .btn-gmaps  { background:#34A853 !important; color:#fff !important; }
    .btn-site   { background:#60A5FA !important; color:#fff !important; }   /* ×ª×›×œ×ª */
    .btn-book   { background:#14B8A6 !important; color:#fff !important; }   /* ×˜×•×¨×§×™×– */
  </style>
</head>
<body class="bg-slate-100">
  <!-- Loader -->
  <div id="initial-loader">
    <div id="loader-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50" id="loader-dim"></div>
    <div class="text-white text-center relative z-10">
      <i class="fas fa-calendar-day fa-4x plane-spinner mb-4"></i>
      <p class="text-2xl font-bold">×˜×•×¢×Ÿ ××ª ×”×œ×•×–...</p>
    </div>
  </div>

  <!-- Background -->
  <div id="page-bg" class="fixed inset-0 z-0 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg');"></div>
  <div class="fixed inset-0 z-0 bg-black/50" id="page-dim"></div>

  <!-- Sidebar -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-[60] transform translate-x-full overflow-y-auto">
    <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
      <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
      <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
    </div>
    <nav id="main-menu" class="p-4 space-y-2"></nav>
  </aside>
  <div id="overlay" class="fixed inset-0 bg-black/60 z-50 hidden"></div>

  <!-- Content -->
  <div id="main-content" class="relative z-10 opacity-0 transition-opacity duration-500">
    <header class="bg-white/70 backdrop-blur-md sticky top-0 z-30 shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
          <div class="flex items-center gap-4">
            <!-- ×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ -->
            <a id="trip-btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border text-slate-700 hover:bg-slate-50" href="#">
              <i class="fa-solid fa-suitcase-rolling"></i>
              ×—×–×¨×” ×œ×˜×™×•×œ
            </a>
            <h1 class="text-xl font-bold text-slate-800">×œ×•×– ×™×•××™</h1>
          </div>
          <div class="flex items-center gap-2">
            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" title="×”×’×“×¨×•×ª"><i class="fa-solid fa-gear fa-lg"></i></button>
            <div id="auth-container" class="flex items-center"></div>
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
          </div>
        </div>
      </div>
    </header>

    <!-- Trip/title banner -->
    <div class="bg-white/70 backdrop-blur-md border-b">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-3">
        <p id="schedule-headline" class="text-center text-slate-700 font-bold">×˜×•×¢×Ÿ ×¤×¨×˜×™ ×ª××¨×™×š...</p>
      </div>
    </div>

    <main class="p-4 sm:p-6 lg:p-8">
      <div class="max-w-5xl mx-auto space-y-8">

        <!-- Summary card -->
        <section class="rounded-2xl shadow-lg p-5 leaf-badge" style="background:var(--card-bg); color:var(--card-text);">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 id="day-title" class="text-2xl md:text-3xl font-extrabold">×œ×•×– ×œ×™×•×</h2>
              <p id="trip-subtitle" class="text-slate-700/80 mt-1"></p>
            </div>
            <div class="flex items-center gap-2 text-slate-700">
              <i class="fa-regular fa-calendar"></i>
              <span id="date-chip" class="font-semibold">--/--/----</span>
            </div>
          </div>
        </section>

        <!-- Timeline -->
        <section id="timeline-section" class="rounded-2xl shadow-lg p-5" style="background:var(--card-bg); color:var(--card-text);">
          <div id="no-schedule" class="text-center p-10">
            <i class="fa-regular fa-clock fa-3x text-slate-400 mb-4"></i>
            <h3 class="text-xl font-bold mb-1">×¢×“×™×™×Ÿ ××™×Ÿ ×œ×•×– ×œ×™×•× ×–×”</h3>
            <p class="text-slate-600">×œ×—×¥ â€œ×¦×•×¨ ×œ×•×–â€ ×›×“×™ ×œ×”×ª×—×™×œ ×œ×ª×›× ×Ÿ ××ª ×”×™×•×.</p>
          </div>
          <div id="timeline" class="timeline space-y-4 hidden"></div>
        </section>

        <!-- Notes/Tips -->
        <section id="notes-section" class="rounded-2xl shadow-lg p-5" style="background:var(--card-bg); color:var(--card-text);">
          <h3 class="text-lg font-bold mb-3">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h3>
          <div id="notes-list" class="grid gap-3">
            <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
          </div>
        </section>

        <!-- Day Route Map -->
        <section id="route-map-section" class="rounded-2xl shadow-lg p-5" style="background:var(--card-bg); color:var(--card-text);">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-bold">××¤×ª ××¡×œ×•×œ ×”×™×•×</h3>
            <div id="route-hint" class="text-sm text-slate-600">××©×¨×˜×˜ ×œ×¤×™ ×”×›×ª×•×‘×•×ª ×©×œ ×”×¤×¨×™×˜×™× ×‘×¢×œ×™ ××™×§×•×.</div>
          </div>
          <div id="route-map-wrap">
            <div id="route-map" class="w-full"></div>
          </div>
          <div id="route-legend" class="mt-3 text-sm grid gap-1"></div>
        </section>

        <!-- CTA (×¨×§ ×œ××˜×”) -->
        <section class="flex justify-center">
          <a id="create-or-edit-btn" href="#" class="inline-flex items-center gap-2 bg-gradient-to-r from-sky-500 to-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
            <i class="fa-solid fa-wand-magic-sparkles"></i>
            <span id="cta-text">×¦×•×¨ ×œ×•×–</span>
          </a>
        </section>

      </div>
    </main>
  </div>

  <!-- SETTINGS MODAL -->
  <div id="settings-modal" class="modal fixed inset-0 z-[80] items-center justify-center p-4 bg-black/60">
    <div class="modal-card rounded-2xl w-full max-w-4xl max-h-[92vh] flex flex-col shadow-2xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 class="text-lg font-bold"><i class="fa-solid fa-gear"></i> ×”×’×“×¨×•×ª ×¢×™×¦×•×‘ ×”×“×£</h4>
        <button id="settings-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 overflow-y-auto space-y-6">
        <!-- Scope -->
        <section class="rounded-xl border p-3">
          <div class="font-bold mb-2">××™×¤×” ×œ×”×—×™×œ ××ª ×”×”×’×“×¨×•×ª?</div>
          <div class="flex flex-wrap gap-4">
            <label class="inline-flex items-center gap-2"><input type="radio" name="ui-scope" value="date"> ×œ×ª××¨×™×š ×”×–×” ×‘×œ×‘×“</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="ui-scope" value="dest" checked> ×œ×›×œ ×”×ª××¨×™×›×™× ×‘×™×¢×“ ×”×–×” (×‘×¨×™×¨×ª ××—×“×œ)</label>
            <label class="inline-flex items-center gap-2"><input type="radio" name="ui-scope" value="trip"> ×œ×›×œ ×œ×•×—×•×ª ×”×–×× ×™× ×‘×˜×™×•×œ</label>
          </div>
        </section>

        <!-- 1) ×¨×§×¢ -->
        <section class="rounded-xl border p-3 space-y-3">
          <div class="flex items-center justify-between">
            <h5 class="font-bold"><i class="fa-solid fa-image"></i> ×¢×¨×™×›×ª ×¨×§×¢</h5>
            <button id="save-bg" class="px-3 py-1.5 rounded bg-sky-600 text-white">×©××•×¨ ×¨×§×¢</button>
          </div>
          <div class="flex flex-col lg:flex-row gap-4">
            <div class="flex-1 space-y-3">
              <div class="flex gap-3 items-center">
                <label class="inline-flex items-center gap-2"><input type="radio" name="bg-mode" value="image" checked> ×ª××•× ×” ×œ×¤×™ ×§×™×©×•×¨</label>
                <label class="inline-flex items-center gap-2"><input type="radio" name="bg-mode" value="color"> ×¦×‘×¢ ××—×™×“</label>
              </div>
              <div id="bg-image-row" class="space-y-2">
                <label class="text-sm">×§×™×©×•×¨ ×œ×ª××•× ×ª ×¨×§×¢</label>
                <input id="bg-image-url" class="w-full p-2 border rounded-lg" placeholder="https://...">
              </div>
              <div id="bg-color-row" class="space-y-2 hidden">
                <label class="text-sm">×‘×—×¨ ×¦×‘×¢ ×¨×§×¢</label>
                <input id="bg-color" type="color" value="#0ea5e9" class="w-24 h-10 p-1 border rounded">
              </div>

              <div class="space-y-1">
                <label class="text-sm">×‘×”×™×¨×•×ª (0% ×›×”×” â€“ 100% ×‘×”×™×¨)</label>
                <input id="bg-brightness" type="range" min="0" max="100" value="100" class="w-full">
              </div>
            </div>
            <div class="w-full lg:w-80 rounded-xl overflow-hidden border">
              <div id="bg-preview" class="h-48 bg-fixed-image" style="background-image:url('https://i.imgur.com/MjekTyd.jpeg'); filter:brightness(100%);"></div>
            </div>
          </div>
        </section>

        <!-- 2) ×¡×’× ×•×Ÿ ×“×£ -->
        <section class="rounded-xl border p-3 space-y-3">
          <div class="flex items-center justify-between">
            <h5 class="font-bold"><i class="fa-solid fa-layer-group"></i> ×¢×¨×™×›×ª ×¡×’× ×•×Ÿ ×”×“×£</h5>
            <button id="save-style" class="px-3 py-1.5 rounded bg-sky-600 text-white">×©××•×¨ ×¡×’× ×•×Ÿ</button>
          </div>
          <div class="grid sm:grid-cols-2 gap-3">
            <label class="p-3 border rounded-lg flex items-start gap-3">
              <input type="radio" name="style-mode" value="modal-first" checked>
              <span><b>1. ×›×¨×˜×™×¡×™×•×ª + ××•×“×œ ××œ×</b> (×‘×¨×™×¨×ª ××—×“×œ)</span>
            </label>
            <label class="p-3 border rounded-lg flex items-start gap-3">
              <input type="radio" name="style-mode" value="expand-then-modal">
              <span><b>2. ×¤×ª×™×—×” ××ª×—×ª ×œ×›×•×ª×¨×ª</b> + ××•×“×œ ××œ× ×¢â€×™ ×œ×—×™×¦×” ×—×•×–×¨×ª/×›×¤×ª×•×¨</span>
            </label>
            <label class="p-3 border rounded-lg flex items-start gap-3">
              <input type="radio" name="style-mode" value="expand-full">
              <span><b>3. ×¤×ª×™×—×” ××ª×—×ª ×œ×›×•×ª×¨×ª (××œ×)</b> ×›×•×œ×œ ××¤×” ×•×§×™×©×•×¨×™×</span>
            </label>
            <label class="p-3 border rounded-lg flex items-start gap-3">
              <input type="radio" name="style-mode" value="timeline-line">
              <span><b>4. ×¦×™×¨ ×–××Ÿ ×¢× ×§×• ×•××™× ×“×™×§×¦×™×™×ª ×©×¢×”</b> + ××•×“×œ ××œ×</span>
            </label>
          </div>
        </section>

        <!-- 3) ×›×¨×˜×™×¡×™×•×ª/×—×œ×•× ×•×ª/×˜×§×¡×˜ -->
        <section class="rounded-xl border p-3 space-y-3">
          <div class="flex items-center justify-between">
            <h5 class="font-bold"><i class="fa-solid fa-palette"></i> ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™×•×ª ×•×—×œ×•× ×•×ª ×•×˜×§×¡×˜</h5>
            <button id="save-theme" class="px-3 py-1.5 rounded bg-sky-600 text-white">×©××•×¨ ×¢×™×¦×•×‘</button>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="space-y-2">
              <label class="text-sm">×¦×‘×¢ ×¨×§×¢ ×›×¨×˜×™×¡×™×•×ª/××•×“×œ×™×</label>
              <input id="theme-card-color" type="color" value="#ffffff" class="w-24 h-10 p-1 border rounded">
              <label class="text-sm">×‘×”×™×¨×•×ª/××˜×™××•×ª (20%â€“100%)</label>
              <input id="theme-card-alpha" type="range" min="20" max="100" value="90" class="w-full">
            </div>
            <div class="space-y-2">
              <label class="text-sm">×¦×‘×¢ ×˜×§×¡×˜</label>
              <input id="theme-text-color" type="color" value="#0f172a" class="w-24 h-10 p-1 border rounded">
            </div>
          </div>
          <div class="mt-3">
            <div class="text-sm font-bold mb-1">×¡×˜×™× ××•×›× ×™× (×œ×—×™×¦×” ××—×™×œ×”):</div>
            <div class="grid sm:grid-cols-4 gap-2">
              <button data-preset="glass" class="px-3 py-2 rounded border">×‘×•×¢×•×ª ×©×§×•×¤×•×ª (×˜×§×¡×˜ ×œ×‘×Ÿ)</button>
              <button data-preset="classic" class="px-3 py-2 rounded border">×œ×‘×Ÿ/×©×—×•×¨ (×§×œ××¡×™)</button>
              <button data-preset="sky" class="px-3 py-2 rounded border">×©××™×™× ×¨×›×™×</button>
              <button data-preset="forest" class="px-3 py-2 rounded border">×™×¢×¨ ×›×”×”</button>
              <button data-preset="sunset" class="px-3 py-2 rounded border">×©×§×™×¢×” ×—××™××”</button>
              <button data-preset="mint" class="px-3 py-2 rounded border">×× ×˜×”</button>
              <button data-preset="lavender" class="px-3 py-2 rounded border">×œ×‘× ×“×¨</button>
              <button data-preset="slate" class="px-3 py-2 rounded border">×¡×œ×™×™×˜ ××œ×’× ×˜×™</button>
            </div>
          </div>
        </section>
      </main>
    </div>
  </div>

  <!-- Firebase + App -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, collection, onSnapshot, query, where, orderBy, updateDoc, setDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // ---------- Firebase ----------
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // ---------- State ----------
    let currentUser = null;
    let tripId = null;
    let tripData = null;

    let dateStr = null;   // ×›×¤×™ ×©×‘-URL
    let dateISO = null;   // yyyy-mm-dd
    let dayNameHe = "";

    let destForDate = null;
    let itemsForMap = []; // ×œ×©×™××•×© ××¤×ª ×”××¡×œ×•×œ
    let styleMode = 'modal-first'; // ×‘×¨×™×¨×ª ××—×“×œ â€“ × ×™×ª×Ÿ ×œ×©×™× ×•×™ ××”-UI

    // UI refs
    const initialLoader   = document.getElementById('initial-loader');
    const mainContent     = document.getElementById('main-content');
    const pageBg          = document.getElementById('page-bg');
    const pageDim         = document.getElementById('page-dim');
    const loaderBg        = document.getElementById('loader-bg');
    const loaderDim       = document.getElementById('loader-dim');
    const sidebar         = document.getElementById('sidebar');
    const hamburgerBtn    = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay         = document.getElementById('overlay');
    const mainMenu        = document.getElementById('main-menu');
    const authContainer   = document.getElementById('auth-container');
    const tripBtn         = document.getElementById('trip-btn');

    const settingsBtn   = document.getElementById('settings-btn');
    const settingsModal = document.getElementById('settings-modal');
    const settingsClose = document.getElementById('settings-close');

    const scheduleHeadline = document.getElementById('schedule-headline');
    const dayTitleEl       = document.getElementById('day-title');
    const tripSubtitle     = document.getElementById('trip-subtitle');
    const dateChip         = document.getElementById('date-chip');

    const noScheduleBox = document.getElementById('no-schedule');
    const timelineBox   = document.getElementById('timeline');
    const timelineWrap  = document.getElementById('timeline-section');
    const notesList     = document.getElementById('notes-list');
    const createOrEditBtn = document.getElementById('create-or-edit-btn');
    const ctaText       = document.getElementById('cta-text');

    const routeMapEl    = document.getElementById('route-map');
    const routeLegend   = document.getElementById('route-legend');

    // Settings controls
    const scopeRadios = document.querySelectorAll('input[name="ui-scope"]');
    const bgModeRadios= document.querySelectorAll('input[name="bg-mode"]');
    const bgImageRow  = document.getElementById('bg-image-row');
    const bgColorRow  = document.getElementById('bg-color-row');
    const bgImageUrl  = document.getElementById('bg-image-url');
    const bgColor     = document.getElementById('bg-color');
    const bgBrightness= document.getElementById('bg-brightness');
    const bgPreview   = document.getElementById('bg-preview');

    const styleRadios  = document.querySelectorAll('input[name="style-mode"]');

    const themeCardColor = document.getElementById('theme-card-color');
    const themeCardAlpha = document.getElementById('theme-card-alpha');
    const themeTextColor = document.getElementById('theme-text-color');
    const presetBtns     = document.querySelectorAll('[data-preset]');

    const saveBgBtn    = document.getElementById('save-bg');
    const saveStyleBtn = document.getElementById('save-style');
    const saveThemeBtn = document.getElementById('save-theme');

    // ---------- Helpers ----------
    function toggleSidebar(){ sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); }
    const pad2 = n => (''+n).padStart(2,'0');

    function parseLocalDateFlexible(s) {
      if (!s) return null;
      const m = s.trim().match(/^(\d{1,2})[\/.\-](\d{1,2})[\/.\-](\d{2}|\d{4})$/);
      if (!m) return null;
      let d = +m[1], mo = +m[2], y = +m[3]; if (y < 100) y += 2000;
      const dt = new Date(Date.UTC(y, mo-1, d));
      return isNaN(dt.getTime()) ? null : dt;
    }
    function toISODateUTC(d) {
      return `${d.getUTCFullYear()}-${pad2(d.getUTCMonth()+1)}-${pad2(d.getUTCDate())}`;
    }
    function hebWeekdayUTC(d) {
      const names = ['×™×•× ×¨××©×•×Ÿ','×™×•× ×©× ×™','×™×•× ×©×œ×™×©×™','×™×•× ×¨×‘×™×¢×™','×™×•× ×—××™×©×™','×™×•× ×©×™×©×™','×™×•× ×©×‘×ª'];
      return names[d.getUTCDay()];
    }
    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const start = parseLocalDateFlexible(startStr);
      const end = parseLocalDateFlexible(endStr);
      if (!start || !end) return [];
      const out = [];
      for (let t = new Date(start); t <= end; t.setUTCDate(t.getUTCDate()+1)) out.push(new Date(t.getTime()));
      return out;
    }
    function findDestinationForDate(trip, rawDDMMYYYY) {
      const target = parseLocalDateFlexible(rawDDMMYYYY); if (!target) return null;
      const targetISO = toISODateUTC(target);
      return (trip.destinations || []).find(dest => {
        const isoList = generateDatesFromRange(dest.dates).map(d => toISODateUTC(d));
        return isoList.includes(targetISO);
      }) || null;
    }

    function setBackgroundPreview(mode, urlOrColor, brightness){
      if (mode==='image'){
        bgPreview.style.backgroundImage = urlOrColor ? `url('${urlOrColor}')` : 'none';
        bgPreview.style.backgroundColor = 'transparent';
      } else {
        bgPreview.style.backgroundImage = 'none';
        bgPreview.style.backgroundColor = urlOrColor || '#0ea5e9';
      }
      bgPreview.style.filter = `brightness(${brightness}%)`;
    }
    function applyPageBackground(cfg){
      // cfg = {mode:'image'|'color', imageUrl?, color?, brightness 0-100}
      const bright = (cfg?.brightness ?? 100);
      if (cfg?.mode === 'color'){
        pageBg.style.backgroundImage = 'none';
        loaderBg.style.backgroundImage = 'none';
        pageBg.style.backgroundColor = cfg?.color || '#0ea5e9';
        loaderBg.style.backgroundColor = cfg?.color || '#0ea5e9';
      } else {
        const url = cfg?.imageUrl || 'https://i.imgur.com/MjekTyd.jpeg';
        pageBg.style.backgroundImage = `url('${url}')`;
        loaderBg.style.backgroundImage = `url('${url}')`;
        pageBg.style.backgroundColor = 'transparent';
        loaderBg.style.backgroundColor = 'transparent';
      }
      pageBg.style.filter = `brightness(${bright}%)`;
      loaderBg.style.filter = `brightness(${bright}%)`;
    }
    function applyTheme(theme){
      // theme = {cardBgRGBA, textColor, modalBg, modalText}
      if (theme?.cardBgRGBA) document.documentElement.style.setProperty('--card-bg', theme.cardBgRGBA);
      if (theme?.textColor)  document.documentElement.style.setProperty('--card-text', theme.textColor);
      if (theme?.modalBg)    document.documentElement.style.setProperty('--modal-bg', theme.modalBg);
      if (theme?.modalText)  document.documentElement.style.setProperty('--modal-text', theme.modalText);
    }

    function buildMenuFromTrip() {
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;
      tripData.destinations.forEach(dest => {
        const div = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe || dest.name}</span> <i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        const dates = generateDatesFromRange(dest.dates);
        dates.forEach(dObj => {
          const nice = `${dObj.getUTCDate()}/${dObj.getUTCMonth()+1}/${dObj.getUTCFullYear()}`;
          const a = document.createElement('a');
          a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(nice)}`;
          a.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md';
          a.textContent = `×œ×•"×– ×œ×™×•× ${nice}`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', () => {
          submenu.classList.toggle('open');
          btn.querySelector('i').classList.toggle('rotate-180');
        });
        div.append(btn, submenu);
        mainMenu.appendChild(div);
      });
    }

    function renderHeadline(dayTitleFromDoc = null) {
      const destName = destForDate?.nameHe || destForDate?.name || '×”×™×¢×“';
      const dayPart = dayNameHe ? ` ${dayNameHe}` : '';
      scheduleHeadline.textContent = `×”×œ×•×– ×©×œ ${destName} ×œ×ª××¨×™×š ${dateStr}${dayPart}`;
      dayTitleEl.textContent = dayTitleFromDoc ? `${dayTitleFromDoc} â€¢ ${dateStr}` : `×œ×•×– ×œ×™×•× ${dateStr}`;
      tripSubtitle.textContent = `${destName}${dayPart ? ' â€¢' + dayPart : ''}`;
      dateChip.textContent = dateStr;
    }

    // ---------- TIMELINE RENDERING (4 ××¦×‘×™×) ----------
    function verifyBadge(it){
      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      if (!needs) return '';
      const list = [
        it.needsVerifyAddress?'×›×ª×•×‘×ª':null,
        it.needsVerifyRoute?'××¡×œ×•×œ':null,
        it.needsVerifyRefs?'×§×™×©×•×¨':null
      ].filter(Boolean).join(' / ');
      return `<span class="inline-flex items-center gap-1 text-[12px] px-2 py-0.5 rounded-full bg-red-100 text-red-800 border border-red-300"><i class="fa-solid fa-circle-exclamation"></i> ×“×¨×•×© ××™××•×ª${list?': '+list:''}</span>`;
    }
    const itemIcon = (it)=> it.isBackToHotel ? 'fa-bed' : ((it.needsVerifyAddress||it.needsVerifyRoute||it.needsVerifyRefs)?'fa-triangle-exclamation':'fa-location-dot');
    const timeText = (it)=> (!it?.startTime && !it?.endTime) ? '--:--' : [it.startTime||'', it.endTime?('â€“ '+it.endTime):''].filter(Boolean).join(' ');
    const distanceText = (m)=> (m==null)? '' : `<span class="text-xs text-slate-500"> â€¢ ××¨×—×§ ×§×•×“×: ${(m/1000).toFixed(2)} ×§×´×</span>`;

    function linksHtmlOf(it){
      const refs = Array.isArray(it.refs)? it.refs : [];
      const refsHtml = refs.map(r=>{
        const href = `${r.page==='summary'?'summary':'attractions'}.html?tripId=${encodeURIComponent(tripId)}&open=${r.type==='logistics'?'logistics':'attraction'}&id=${encodeURIComponent(r.id)}`;
        const icon = r.type==='logistics' ? (r.subType==='hotel'?'ğŸ¨':r.subType==='flight'?'âœˆï¸':r.subType==='train'?'ğŸš†':r.subType==='car_rental'?'ğŸš—':r.subType==='ferry'?'â›´ï¸':'â¬…ï¸') : 'ğŸ“';
        return `<a class="px-2 py-1 rounded bg-indigo-600/90 text-white text-xs" target="_blank" href="${href}">${icon} ${r.label}</a>`;
      }).join(' ');
      const siteBtn = it.links?.site ? `<a class="px-2 py-1 rounded btn-site text-xs" target="_blank" href="${it.links.site}"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '';
      const bookBtn = it.links?.booking ? `<a class="px-2 py-1 rounded btn-book text-xs" target="_blank" href="${it.links.booking}"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '';
      return [siteBtn, bookBtn, refsHtml].filter(Boolean).join(' ');
    }
    const navBtns = (addr)=> addr ? `
      <div class="flex gap-2">
        <a class="px-2 py-1 rounded btn-waze text-xs" target="_blank" href="https://waze.com/ul?q=${encodeURIComponent(addr)}"><i class="fa-brands fa-waze"></i> ×•×™×™×–</a>
        <a class="px-2 py-1 rounded btn-gmaps text-xs" target="_blank" href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}"><i class="fa-solid fa-location-dot"></i> ××¤×•×ª</a>
      </div>` : '';

    // ××¦×‘ 1: ×›×¨×˜×™×¡×™×” ×§×¦×¨×” + ××•×“×œ (×›××Ÿ × ×¤×ª×— inline-×¤×¨×™×•×•×™×• ×××•×“ ×§×¦×¨, ×•××•×“×œ ××œ× ××¤×©×¨×™ ×‘×”×¨×—×‘×” ×¢×ª×™×“×™×ª)
    function renderModeModalFirst(items){
      timelineBox.innerHTML = '';
      items.forEach(it=>{
        const el = document.createElement('div');
        el.className = 'timeline-item rounded-xl shadow p-4';
        el.innerHTML = `
          <span class="timeline-dot"></span>
          <div class="flex items-start gap-4">
            <div class="shrink-0 text-center">
              <div class="text-sm font-bold">${timeText(it)}</div>
              <div class="text-xs opacity-70">×¤×¨×™×˜</div>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 flex-wrap">
                <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
                <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                ${verifyBadge(it)}
                ${distanceText(it.distanceFromPreviousMeters)}
              </div>
              ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
              ${it.address?.label ? `<div class="mt-1 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
              ${it.links?.site || it.links?.booking || (it.refs?.length) ? `<div class="mt-2 flex flex-wrap gap-2">${linksHtmlOf(it)}</div>`:''}
              ${it.address?.label ? `<div class="mt-2">${navBtns(it.address.label)}</div>`:''}
            </div>
          </div>`;
        timelineBox.appendChild(el);
      });
    }

    // ××¦×‘ 2: ×¤×ª×™×—×” ×§×¦×¨×” ××ª×—×ª ×œ×›×•×ª×¨×ª
    function renderModeExpandThenModal(items){
      timelineBox.innerHTML = '';
      items.forEach((it,idx)=>{
        const el = document.createElement('div');
        el.className = 'timeline-item rounded-xl shadow p-4';
        const detailsId = `det-${idx}`;
        el.innerHTML = `
          <span class="timeline-dot"></span>
          <button class="w-full text-right">
            <div class="flex items-start gap-4">
              <div class="shrink-0 text-center">
                <div class="text-sm font-bold">${timeText(it)}</div>
                <div class="text-xs opacity-70">×¤×¨×™×˜</div>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 flex-wrap">
                  <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
                  <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                  ${verifyBadge(it)}
                  ${distanceText(it.distanceFromPreviousMeters)}
                </div>
                ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
                <div id="${detailsId}" class="hidden mt-3">
                  ${it.description ? `<p class="whitespace-pre-wrap">${it.description}</p>`:''}
                  ${it.address?.label ? `<div class="mt-2 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
                  ${it.travel?.from?.label || it.travel?.to?.label ? `<div class="mt-2 text-xs opacity-80"><i class="fa-solid fa-route opacity-60"></i> ${it.travel?.from?.label?`×Ö¾${it.travel.from.label}`:''} ${it.travel?.to?.label?` ××œ ${it.travel.to.label}`:''} ${it.travel?.timeText?` â€¢ ${it.travel.timeText}`:''}</div>`:''}
                  ${it.links?.site || it.links?.booking || (it.refs?.length) ? `<div class="mt-2 flex flex-wrap gap-2">${linksHtmlOf(it)}</div>`:''}
                  ${it.address?.label ? `<div class="mt-2">${navBtns(it.address.label)}</div>`:''}
                </div>
              </div>
            </div>
          </button>`;
        el.querySelector('button').addEventListener('click', ()=>{
          const d = el.querySelector('#'+detailsId);
          d.classList.toggle('hidden');
        });
        timelineBox.appendChild(el);
      });
    }

    // ××¦×‘ 3: ×¤×ª×™×—×” ××œ××” ××ª×—×ª ×œ×›×•×ª×¨×ª
    function renderModeExpandFull(items){
      timelineBox.innerHTML = '';
      items.forEach((it,idx)=>{
        const el = document.createElement('div');
        el.className = 'timeline-item rounded-xl shadow p-4';
        const detailsId = `full-${idx}`;
        el.innerHTML = `
          <span class="timeline-dot"></span>
          <button class="w-full text-right">
            <div class="flex items-start gap-4">
              <div class="shrink-0 text-center">
                <div class="text-sm font-bold">${timeText(it)}</div>
                <div class="text-xs opacity-70">×¤×¨×™×˜</div>
              </div>
              <div class="flex-1">
                <div class="flex items-center gap-2 flex-wrap">
                  <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
                  <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                  ${verifyBadge(it)}
                  ${distanceText(it.distanceFromPreviousMeters)}
                </div>
                ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
                <div id="${detailsId}" class="hidden mt-3">
                  ${it.description ? `<p class="whitespace-pre-wrap">${it.description}</p>`:''}
                  ${it.address?.label ? `<div class="mt-2 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
                  ${it.travel?.from?.label || it.travel?.to?.label ? `<div class="mt-2 text-xs opacity-80"><i class="fa-solid fa-route opacity-60"></i> ${it.travel?.from?.label?`×Ö¾${it.travel.from.label}`:''} ${it.travel?.to?.label?` ××œ ${it.travel.to.label}`:''} ${it.travel?.timeText?` â€¢ ${it.travel.timeText}`:''}</div>`:''}
                  ${it.links?.site || it.links?.booking || (it.refs?.length) ? `<div class="mt-2 flex flex-wrap gap-2">${linksHtmlOf(it)}</div>`:''}
                  ${it.address?.label ? `<div class="mt-2">${navBtns(it.address.label)}</div>`:''}
                </div>
              </div>
            </div>
          </button>`;
        el.querySelector('button').addEventListener('click', ()=>{
          const d = el.querySelector('#'+detailsId);
          d.classList.toggle('hidden');
        });
        timelineBox.appendChild(el);
      });
    }

    // ××¦×‘ 4: ×¦×™×¨ ×–××Ÿ ××•×“×’×©
    function renderModeTimeline(items){
      timelineBox.innerHTML = '';
      items.forEach(it=>{
        const el = document.createElement('div');
        el.className = 'timeline-item rounded-xl shadow p-4';
        el.innerHTML = `
          <span class="timeline-dot"></span>
          <div class="flex items-start gap-4">
            <div class="shrink-0 text-center">
              <div class="text-sm font-extrabold">${timeText(it)}</div>
              <div class="text-[11px] opacity-70">×©×¢×”</div>
            </div>
            <div class="flex-1">
              <div class="flex items-center gap-2 flex-wrap">
                <i class="fa-solid ${itemIcon(it)} text-sky-500"></i>
                <h4 class="text-lg font-bold">${it.title || '×¤×¨×™×˜ ×œ×œ× ×©×'}</h4>
                ${verifyBadge(it)}
                ${distanceText(it.distanceFromPreviousMeters)}
              </div>
              ${it.summary ? `<div class="mt-1">${it.summary}</div>` : ''}
              ${it.address?.label ? `<div class="mt-1 text-sm opacity-80"><i class="fa-solid fa-location-dot mr-1 opacity-60"></i>${it.address.label}</div>` : ''}
            </div>
          </div>`;
        timelineBox.appendChild(el);
      });
    }

    function renderTimelineFromItems(items){
      itemsForMap = items.slice(); // ×œ×©×™××•×© ×××•×—×¨ ×œ××¤×”
      if (!items || items.length === 0) {
        noScheduleBox.classList.remove('hidden');
        timelineBox.classList.add('hidden');
        timelineBox.innerHTML = '';
        ctaText.textContent = '×¦×•×¨ ×œ×•×–';
        createOrEditBtn.classList.remove('from-emerald-500','to-emerald-600');
        createOrEditBtn.classList.add('from-sky-500','to-blue-600');
        return;
      }
      noScheduleBox.classList.add('hidden');
      timelineBox.classList.remove('hidden');
      // CTA -> ×¢×¨×•×š ×œ×•×–
      ctaText.textContent = '×¢×¨×•×š ×œ×•×–';
      createOrEditBtn.classList.remove('from-sky-500','to-blue-600');
      createOrEditBtn.classList.add('from-emerald-500','to-emerald-600');

      // ×¨× ×“×¨ ×œ×¤×™ ×¡×’× ×•×Ÿ × ×‘×—×¨
      switch (styleMode){
        case 'expand-then-modal': renderModeExpandThenModal(items); break;
        case 'expand-full':       renderModeExpandFull(items); break;
        case 'timeline-line':     renderModeTimeline(items); break;
        default:                  renderModeModalFirst(items); break;
      }

      // ×œ××—×¨ ×¨× ×“×¨ â€“ ×‘× ×” ××ª ××¤×ª ×”××¡×œ×•×œ
      buildDayRouteMap(itemsForMap);
    }

    // ---------- Notes ----------
    const colorMap = {
      red:    {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:  {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:   {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow: {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange: {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    function classesForColor(c){ const m = colorMap[c] || colorMap.yellow; return `${m.bg} ${m.border} ${m.text}`; }
    function renderNotesList(notes){
      if (!notes || notes.length===0){
        notesList.innerHTML = `<div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const cls = classesForColor(n.color);
        return `
          <div class="border rounded-xl p-3 ${cls}">
            <div class="font-bold">${n.kind}: ${n.title || 'â€”'}</div>
            ${n.details ? `<div class="mt-1 text-sm whitespace-pre-wrap">${n.details}</div>` : ''}
          </div>
        `;
      }).join('');
    }

    // ---------- Day Route Map ----------
    let map=null, routeLayers=[];
    const segColors = ['#2563eb','#ef4444','#10b981','#f59e0b','#a855f7','#06b6d4','#fb7185','#84cc16'];
    async function buildDayRouteMap(items){
      // ××¡×•×£ × ×§×•×“×•×ª ×œ×¤×™ ×¡×“×¨ â€“ ×›×ª×•×‘×•×ª ×¢× lat/lng; ×× ×—×¡×¨ ×§×•××•×¨×“×™× ×˜×•×ª × × ×¡×” ×œ×’××•×§×•×“
      const points = [];
      for (const it of items){
        if (it?.address?.label){
          let {lat,lng} = it.address;
          if ((lat==null || lng==null) && it.address.label){
            const geo = await geocodeOnce(it.address.label);
            if (geo) { lat = +geo.lat; lng = +geo.lon; }
          }
          if (lat!=null && lng!=null) points.push({label: it.title || it.address.label, addr: it.address.label, lat, lng});
        }
      }
      if (!map){
        map = L.map(routeMapEl).setView([31.77,35.21], 8);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
      }
      // × ×§×” ×©×›×‘×•×ª ×§×•×“××•×ª
      routeLayers.forEach(l=> map.removeLayer(l));
      routeLayers = [];
      if (!points.length){ routeLegend.innerHTML = `<div class="text-slate-500">××™×Ÿ ××¡×¤×™×§ ×›×ª×•×‘×•×ª ×œ××¤×”.</div>`; return; }

      const markers = points.map((p,i)=>{
        const m = L.marker([p.lat,p.lng]).addTo(map).bindTooltip(`${i+1}. ${p.addr}`,{direction:'top'});
        routeLayers.push(m); return m;
      });
      const group = L.featureGroup(markers);
      map.fitBounds(group.getBounds(), {padding:[20,20]});

      // ×§×•×•×™× ×‘×™×Ÿ × ×§×•×“×•×ª
      routeLegend.innerHTML = '';
      for (let i=0;i<points.length-1;i++){
        const a = points[i], b = points[i+1];
        const color = segColors[i % segColors.length];
        const routeGeo = await osrmRoute(a, b);
        let poly;
        if (routeGeo){
          poly = L.polyline(routeGeo, {color, weight: 4, opacity: 0.9}).addTo(map);
          // ×—×¥ ×›×™×•×•×Ÿ
          const dec = L.polylineDecorator(poly, {
            patterns: [{ offset: '50%', repeat: 0, symbol: L.Symbol.arrowHead({pixelSize: 12, pathOptions:{color, weight:4, fillOpacity:0.9}})}]
          }).addTo(map);
          routeLayers.push(poly, dec);
        } else {
          poly = L.polyline([[a.lat,a.lng],[b.lat,b.lng]], {color, weight: 3, dashArray:'6 6'}).addTo(map);
          routeLayers.push(poly);
        }
        // ××§×¨×
        const legendItem = document.createElement('div');
        legendItem.innerHTML = `<span class="inline-block w-3 h-3 rounded-full mr-2 align-middle" style="background:${color}"></span> ${a.addr} <b>&gt;</b> ${b.addr}`;
        routeLegend.appendChild(legendItem);
      }
    }
    async function osrmRoute(a,b){
      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url); const data = await res.json();
        if (data?.routes?.[0]?.geometry?.coordinates){
          return data.routes[0].geometry.coordinates.map(([x,y])=>[y,x]);
        }
      }catch(e){}
      return null;
    }
    const geoCache = new Map();
    async function geocodeOnce(q){
      if (geoCache.has(q)) return geoCache.get(q);
      try{
        const url=`https://nominatim.openstreetmap.org/search?format=json&limit=1&q=${encodeURIComponent(q)}`;
        const res=await fetch(url); const arr=await res.json();
        const hit = Array.isArray(arr)&&arr[0]? arr[0]: null;
        geoCache.set(q, hit);
        return hit;
      }catch(e){ return null; }
    }

    // ---------- UI CONFIG (Firestore: trips/{tripId}/ui) ----------
    const uiDoc = ()=> doc(db,'trips',tripId,'ui','config'); // ××¡××š ××—×“ ×¢× {global, destinations:{name:{}}, dates:{ISO:{}}}
    function scopePath(scope){
      if (scope==='date') return ['dates', dateISO];
      if (scope==='trip') return ['global'];
      // dest
      const key = (destForDate?.nameHe || destForDate?.name || 'dest');
      return ['destinations', key];
    }
    // ××™×–×•×’ ×¢×“×™×¤×•×™×•×ª: ×ª××¨×™×š > ×™×¢×“ > ×’×œ×•×‘×œ×™
    function effectiveUI(u){
      const destKey = (destForDate?.nameHe || destForDate?.name || 'dest');
      const g = u?.global || {};
      const d = (u?.destinations||{})[destKey] || {};
      const dt= (u?.dates||{})[dateISO] || {};
      return {
        background: dt.background || d.background || g.background || {mode:'image', imageUrl:null, brightness:100},
        styleMode:  dt.styleMode  || d.styleMode  || g.styleMode  || 'modal-first',
        theme:      dt.theme      || d.theme      || g.theme      || { cardBgRGBA:'rgba(255,255,255,0.9)', textColor:'#0f172a', modalBg:'#ffffff', modalText:'#0f172a' }
      };
    }

    function rgbaFromHex(hex, alphaPct){
      const h = hex.replace('#','');
      const r = parseInt(h.substring(0,2),16);
      const g = parseInt(h.substring(2,4),16);
      const b = parseInt(h.substring(4,6),16);
      const a = Math.max(0, Math.min(1, (alphaPct/100)));
      return `rgba(${r},${g},${b},${a})`;
    }

    async function saveToUI(partial, scope){
      const [root, subkey] = scopePath(scope);
      const payload = subkey ? { [`${root}.${subkey}`]: { ...( (await getDoc(uiDoc())).data()?.[root]?.[subkey] || {} ), ...partial } }
                             : { [root]: { ...( (await getDoc(uiDoc())).data()?.[root] || {} ), ...partial } };
      await setDoc(uiDoc(), payload, {merge:true});
    }

    function attachSettingsHandlers(){
      // ×”×—×œ×¤×ª ××¦×‘ ×ª××•× ×”/×¦×‘×¢
      bgModeRadios.forEach(r=> r.addEventListener('change', ()=>{
        const mode = document.querySelector('input[name="bg-mode"]:checked').value;
        bgImageRow.classList.toggle('hidden', mode!=='image');
        bgColorRow.classList.toggle('hidden', mode!=='color');
        const brightness = +bgBrightness.value;
        const val = (mode==='image') ? bgImageUrl.value : bgColor.value;
        setBackgroundPreview(mode, val, brightness);
      }));
      // ×ª×¦×•×’×” ××§×“×™××”
      bgImageUrl.addEventListener('input', ()=> setBackgroundPreview('image', bgImageUrl.value, +bgBrightness.value));
      bgColor.addEventListener('input', ()=> setBackgroundPreview('color', bgColor.value, +bgBrightness.value));
      bgBrightness.addEventListener('input', ()=>{
        const mode = document.querySelector('input[name="bg-mode"]:checked').value;
        const val  = (mode==='image') ? bgImageUrl.value : bgColor.value;
        setBackgroundPreview(mode, val, +bgBrightness.value);
      });

      // ×©××™×¨×ª ×¨×§×¢
      saveBgBtn.addEventListener('click', async ()=>{
        const scope = document.querySelector('input[name="ui-scope"]:checked').value;
        const mode  = document.querySelector('input[name="bg-mode"]:checked').value;
        const cfg = (mode==='image') ? {mode:'image', imageUrl:bgImageUrl.value||null, brightness:+bgBrightness.value}
                                     : {mode:'color', color:bgColor.value, brightness:+bgBrightness.value};
        await saveToUI({ background: cfg }, scope);
      });

      // ×©××™×¨×ª ×¡×’× ×•×Ÿ
      saveStyleBtn.addEventListener('click', async ()=>{
        const scope = document.querySelector('input[name="ui-scope"]:checked').value;
        const sm = document.querySelector('input[name="style-mode"]:checked').value;
        await saveToUI({ styleMode: sm }, scope);
      });

      // ×¡×˜×™× ××•×›× ×™×
      const presets = {
        glass:   {cardBgRGBA:'rgba(255,255,255,0.2)', textColor:'#ffffff', modalBg:'rgba(17,24,39,0.6)', modalText:'#ffffff'},
        classic: {cardBgRGBA:'rgba(255,255,255,0.96)', textColor:'#0f172a', modalBg:'#ffffff', modalText:'#0f172a'},
        sky:     {cardBgRGBA:'rgba(219,234,254,0.9)', textColor:'#0c4a6e', modalBg:'#ffffff', modalText:'#0f172a'},
        forest:  {cardBgRGBA:'rgba(20,83,45,0.8)',   textColor:'#ecfdf5', modalBg:'#14532d', modalText:'#ecfdf5'},
        sunset:  {cardBgRGBA:'rgba(251,146,60,0.85)', textColor:'#111827', modalBg:'#fff7ed', modalText:'#111827'},
        mint:    {cardBgRGBA:'rgba(16,185,129,0.8)',  textColor:'#06281e', modalBg:'#ecfdf5', modalText:'#06281e'},
        lavender:{cardBgRGBA:'rgba(196,181,253,0.85)',textColor:'#2e1065', modalBg:'#eef2ff', modalText:'#1e1b4b'},
        slate:   {cardBgRGBA:'rgba(30,41,59,0.9)',    textColor:'#e2e8f0', modalBg:'#0f172a', modalText:'#e2e8f0'},
      };
      presetBtns.forEach(b=> b.addEventListener('click', ()=>{
        const p = presets[b.dataset.preset];
        if (!p) return;
        themeCardColor.value = '#ffffff'; // ×œ× ×¨×œ×•×•× ×˜×™ â€“ × ×“×¨×•×¡ ×™×©×™×¨×•×ª ×‘×”×©××™×¨×”
        themeCardAlpha.value = 90;
        themeTextColor.value = p.textColor;
        applyTheme(p); // ×ª×¦×•×’×” ××™×™×“×™×ª
      }));

      // ×©××™×¨×ª ×¢×™×¦×•×‘ ×›×¨×˜×™×¡×™×•×ª/×˜×§×¡×˜
      saveThemeBtn.addEventListener('click', async ()=>{
        const scope = document.querySelector('input[name="ui-scope"]:checked').value;
        const cardRGBA = rgbaFromHex(themeCardColor.value, +themeCardAlpha.value);
        const theme = { cardBgRGBA: cardRGBA, textColor: themeTextColor.value, modalBg: cardRGBA, modalText: themeTextColor.value };
        await saveToUI({ theme }, scope);
      });

      // ×¤×ª×™×—×”/×¡×’×™×¨×” ××•×“×œ
      settingsBtn.addEventListener('click', ()=> settingsModal.classList.add('show'));
      settingsClose.addEventListener('click', ()=> settingsModal.classList.remove('show'));
      settingsModal.addEventListener('click', (e)=>{ if (e.target===settingsModal) settingsModal.classList.remove('show'); });
    }

    // ×˜×¢×™× ×ª UI ×•×”×—×œ×”
    function listenApplyUI(){
      onSnapshot(uiDoc(), (snap)=>{
        const ui = snap.exists()? snap.data(): {};
        const eff = effectiveUI(ui);
        // ×¨×§×¢
        applyPageBackground(eff.background);
        // ×¡×’× ×•×Ÿ
        styleMode = eff.styleMode || 'modal-first';
        // ×ª××”
        applyTheme(eff.theme);

        // ×¢×“×›×•×Ÿ ×¤×§×“×™× ×‘×ª×¦×•×’×ª ×”×”×’×“×¨×•×ª (×œ× ×•×—×•×ª)
        const isImg = eff.background?.mode==='image';
        document.querySelector(`input[name="bg-mode"][value="${isImg?'image':'color'}"]`).checked = true;
        bgImageRow.classList.toggle('hidden', !isImg);
        bgColorRow.classList.toggle('hidden', isImg);
        bgImageUrl.value = eff.background?.imageUrl || '';
        bgColor.value    = eff.background?.color || '#0ea5e9';
        bgBrightness.value = eff.background?.brightness ?? 100;
        setBackgroundPreview(eff.background?.mode||'image', isImg? bgImageUrl.value : bgColor.value, +bgBrightness.value);

        document.querySelectorAll('input[name="style-mode"]').forEach(r=> r.checked = (r.value===styleMode));
      }, ()=>{});
    }

    // ---------- Events ----------
    function attachEvents() {
      hamburgerBtn.addEventListener('click', toggleSidebar);
      closeSidebarBtn.addEventListener('click', toggleSidebar);
      overlay.addEventListener('click', toggleSidebar);
    }

    // ---------- Init ----------
    async function initPage() {
      const url = new URLSearchParams(window.location.search);
      tripId = url.get('tripId');
      dateStr = decodeURIComponent(url.get('date') || '').trim();

      const parsed = parseLocalDateFlexible(dateStr);
      if (parsed) {
        dateISO = toISODateUTC(parsed);
        dayNameHe = hebWeekdayUTC(parsed);
      }

      if (!tripId || !dateStr) {
        alert('×›×ª×•×‘×ª ×©×’×•×™×”: ×—×¡×¨ tripId ××• date.');
        location.href = 'index.html'; return;
      }

      attachEvents();
      attachSettingsHandlers();

      onAuthStateChanged(auth, async (user) => {
        if (!user) { location.replace('login.html'); return; }
        currentUser = user;
        const displayName = user.displayName || user.email.split('@')[0];
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${displayName} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));

        // ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×“×£ ×”×˜×™×•×œ (×©× ×” ×œ× ×ª×™×‘ ×”×“×£ ×©×œ×š ×× ×¦×¨×™×š)
        const tripHref = `trip.html?tripId=${encodeURIComponent(tripId)}`;
        tripBtn.href = tripHref;

        // Load trip
        const tripRef = doc(db, 'trips', tripId);
        const tripSnap = await getDoc(tripRef);
        if (!tripSnap.exists()) { alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href = 'index.html'; return; }
        tripData = tripSnap.data();
        if (tripData.ownerId && tripData.ownerId !== currentUser.uid) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.'); location.href = 'index.html'; return;
        }

        // ×™×¢×“ ×œ××•×ª×• ×ª××¨×™×š, ×¨×§×¢ ×•×ª×¤×¨×™×˜
        destForDate = findDestinationForDate(tripData, dateStr);
        buildMenuFromTrip();

        // ×›×•×ª×¨×ª ×”×™×•×
        let dayTitleFromDoc = null;
        if (dateISO){
          const schedDocRef = doc(db, 'trips', tripId, 'schedules', dateISO);
          const schedSnap = await getDoc(schedDocRef);
          dayTitleFromDoc = schedSnap.exists() ? (schedSnap.data().title || null) : null;
        }
        renderHeadline(dayTitleFromDoc);

        // ×§×™×©×•×¨ ×™×¦×™×¨×”/×¢×¨×™×›×” (×¨×§ ×œ××˜×”)
        const destNameParam = encodeURIComponent(destForDate?.nameHe || destForDate?.name || '');
        const editHref   = `create-schedule.html?tripId=${encodeURIComponent(tripId)}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
        createOrEditBtn.href = editHref;

        // UI â€“ ×××–×™× ×™× ×œ×”×’×“×¨×•×ª
        listenApplyUI();

        // items & notes realtime
        if (dateISO){
          const itemsCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'items');
          const qItems = query(itemsCol, orderBy('sort','asc'));
          onSnapshot(qItems, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderTimelineFromItems(arr);
          }, ()=> renderTimelineFromItems([]));

          const notesCol = collection(db, 'trips', tripId, 'schedules', dateISO, 'notes');
          const qNotes = query(notesCol, orderBy('createdAt','asc'));
          onSnapshot(qNotes, (snap)=>{
            const arr = snap.docs.map(d => ({id:d.id, ...d.data()}));
            renderNotesList(arr);
          }, ()=> renderNotesList([]));
        } else {
          renderTimelineFromItems([]);
          renderNotesList([]);
        }

        // Reveal UI
        initialLoader.style.opacity = '0';
        mainContent.style.opacity = '1';
        setTimeout(()=>{ initialLoader.style.display='none'; }, 400);
      });
    }

    initPage();
  </script>
</body>
</html>