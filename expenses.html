<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול הוצאות</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons + Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Assistant', sans-serif; 
        }
        .modal-transition { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
        
        .tab-btn.active {
            border-color: #2563eb; /* blue-600 */
            color: #2563eb;
            background-color: #dbeafe; /* blue-100 */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .filter-btn.active {
            background-color: #1e40af; /* blue-800 */
            color: white;
        }
        
        .owner-filter-btn.active {
            background-color: #3b82f6; /* blue-500 */
            color: white;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .owner-filter-btn[data-owner="compare"].active {
            background-color: #16a34a; /* green-600 */
        }
        
        .expense-card-clickable {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .expense-card-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* NEW: Accordion Styles */
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        .accordion-toggle .accordion-icon {
            transition: transform 0.3s ease-in-out;
        }
        .accordion-toggle.active .accordion-icon {
            transform: rotate(180deg);
        }

        .loader {
            width: 12px;
            height: 12px;
            border: 2px solid #d1d5db; /* gray-300 */
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-wallet text-5xl text-blue-600 animate-pulse"></i>
        <p class="text-xl font-bold text-slate-700">טוען הוצאות...</p>
    </div>

    <!-- Expense Details Modal -->
    <div id="expense-details-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[102] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg text-slate-800">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold">פרטי הוצאה</h3>
                <button data-close-modal="expense-details-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="expense-details-content" class="space-y-3"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[101] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg text-slate-800">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold">הגדרות קיצור דרך</h3>
                <button data-close-modal="settings-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="space-y-6">
                 <p class="text-sm text-slate-600">העתק את שני הפרטים הבאים והדבק אותם בשאלות ההתקנה של הקיצור באייפון.</p>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">1. מזהה הטיול הנוכחי</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="trip-id-input" readonly class="w-full p-2 rounded-md bg-slate-100 text-slate-500 font-mono text-sm text-left" dir="ltr">
                        <button id="copy-trip-id-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-3 rounded-lg transition whitespace-nowrap" title="העתק מזהה טיול"><i class="fas fa-copy"></i></button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-slate-700 mb-1">2. המפתח הסודי האישי שלך</label>
                    <div class="flex items-center gap-2">
                        <input type="text" id="api-key-input" readonly class="w-full p-2 rounded-md bg-slate-100 text-slate-500 font-mono text-sm text-left" dir="ltr" placeholder="לחץ על הכפתור כדי ליצור מפתח...">
                        <button id="copy-api-key-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-3 rounded-lg transition whitespace-nowrap" title="העתק מפתח סודי"><i class="fas fa-copy"></i></button>
                    </div>
                     <button id="generate-api-key-btn" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">צור/החלף מפתח סודי (פעולה זו תבטל מפתח קודם)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add/Edit Expense Modal -->
    <div id="expense-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">הוספת הוצאה חדשה</h3>
                <button data-close-modal="expense-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="expense-id">
                <div>
                    <label for="expense-owner-name" class="block text-sm font-medium text-slate-700 mb-1">שם המוסיף</label>
                    <input type="text" id="expense-owner-name" class="w-full p-2 border rounded-md bg-slate-50" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-slate-700 mb-1">סכום</label>
                        <input type="number" id="expense-amount" step="0.01" class="w-full p-2 border rounded-md" placeholder="100" required>
                    </div>
                    <div>
                        <label for="expense-currency" class="block text-sm font-medium text-slate-700 mb-1">מטבע</label>
                        <select id="expense-currency" class="w-full p-2 border rounded-md bg-white"></select>
                    </div>
                </div>
                <div>
                    <label for="expense-category" class="block text-sm font-medium text-slate-700 mb-1">קטגוריה</label>
                    <div class="flex items-center gap-2">
                        <select id="expense-category" class="w-full p-2 border rounded-md bg-white"></select>
                        <button type="button" id="delete-category-btn" class="text-slate-400 hover:text-red-500 p-2 hidden" title="מחק קטגוריה זו"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div id="new-category-wrapper" class="hidden">
                    <label for="new-category-name" class="block text-sm font-medium text-slate-700 mb-1">שם הקטגוריה החדשה</label>
                    <input type="text" id="new-category-name" class="w-full p-2 border rounded-md" placeholder="לדוגמה: בילויים">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-slate-700 mb-1">תאריך</label>
                        <input type="date" id="expense-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="expense-notes" class="block text-sm font-medium text-slate-700 mb-1">פירוט (אופציונלי)</label>
                        <input type="text" id="expense-notes" class="w-full p-2 border rounded-md" placeholder="פרטים נוספים...">
                    </div>
                </div>
                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" data-close-modal="expense-modal" class="bg-gray-200 hover:bg-gray-300 text-black font-bold py-2 px-6 rounded-lg">ביטול</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">שמור</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW: Onboarding Screen -->
    <div id="onboarding-screen" class="hidden container mx-auto px-4 sm:px-6 lg:px-8 py-6">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-lg text-slate-700 space-y-6">
            <div class="text-center">
                <i class="fas fa-rocket text-5xl text-blue-500 mb-4"></i>
                <h2 class="text-3xl font-bold text-slate-800">ברוכים הבאים!</h2>
                <p class="mt-2 text-lg text-slate-600">בואו נתחיל לנהל את הוצאות הטיול שלכם.</p>
            </div>

            <div>
                <h3 class="text-xl font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fas fa-plus-circle text-green-500"></i>הוספת הוצאה ראשונה</h3>
                <p>כדי להוסיף הוצאה, לחצו על כפתור הפלוס <span class="inline-block bg-blue-600 text-white rounded-full h-6 w-6 text-center leading-6 mx-1"><i class="fas fa-plus text-xs"></i></span> שנמצא בפינה השמאלית העליונה של המסך. יפתח חלון שבו תוכלו למלא את כל פרטי ההוצאה.</p>
            </div>

            <div>
                <h3 class="text-xl font-bold text-slate-800 mb-3 flex items-center gap-2"><i class="fab fa-apple text-slate-500"></i>הוספה מהירה עם קיצור דרך לאייפון</h3>
                <p class="mb-4">רוצים להוסיף הוצאות ישירות ממסך הבית של האייפון? התקינו את קיצורי הדרך שלנו!</p>
                
                <div class="flex flex-col sm:flex-row gap-4 mb-6">
                    <a href="https://www.icloud.com/shortcuts/88b14f6975534bfba93f01a98a72610a" target="_blank" class="flex-1 bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg text-center transition">1. הורד קיצור ״הוספת הוצאה״</a>
                    <a href="https://www.icloud.com/shortcuts/e0dfcf2d79c7425f959cb2bef02e3b1a" target="_blank" class="flex-1 bg-slate-500 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-lg text-center transition">2. הורד קיצור ״עריכת פרטים״</a>
                </div>

                <ol class="list-decimal list-inside space-y-3 bg-slate-50 p-4 rounded-lg">
                    <li>לאחר שהורדתם את שני הקיצורים, לחצו על **כפתור ההגדרות** <span class="inline-block bg-slate-200 text-slate-600 rounded-full h-6 w-6 text-center leading-6 mx-1"><i class="fas fa-cog text-xs"></i></span> בפינת המסך.</li>
                    <li>בחלון שיפתח, **העתיקו** את "מזהה הטיול הנוכחי".</li>
                    <li>הפעילו את קיצור הדרך **"עריכת פרטים"** שהורדתם, ובחרו באפשרות לערוך את מזהה הטיול. **הדביקו** את המזהה שהעתקתם.</li>
                    <li>חזרו לדף האינטרנט, לחצו שוב על כפתור ההגדרות, וודאו שנוצר לכם "מפתח סודי". אם לא, לחצו על הכפתור כדי ליצור אחד.</li>
                    <li>**העתיקו** את "המפתח הסודי האישי שלך".</li>
                    <li>הפעילו שוב את קיצור הדרך **"עריכת פרטים"**, בחרו באפשרות לערוך את המפתח הסודי, ו**הדביקו** את המפתח שהעתקתם.</li>
                </ol>
                <p class="mt-4 font-semibold text-green-600">זהו! עכשיו תוכלו להשתמש בקיצור "הוספת הוצאה" כדי להוסיף הוצאות במהירות ובקלות.</p>
            </div>
        </div>
    </div>


    <!-- Main Content -->
    <div id="main-content" class="pb-24">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a id="back-to-dashboard" href="#" class="text-slate-700 font-bold hover:text-blue-600 flex items-center gap-2">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                    <h1 id="trip-title" class="text-xl font-bold text-slate-800 truncate">ניהול הוצאות</h1>
                    <div class="flex items-center gap-2">
                        <button id="settings-btn" class="text-slate-500 hover:text-blue-600 bg-slate-100 hover:bg-slate-200 rounded-full h-8 w-8 flex items-center justify-center transition">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="add-expense-btn-header" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full h-8 w-8 flex items-center justify-center shadow-md">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="mb-6 bg-slate-200 p-1 rounded-full grid grid-cols-2 gap-1">
                <button class="tab-btn active font-bold py-2 px-4 rounded-full transition" data-tab="today">היום</button>
                <button class="tab-btn font-bold py-2 px-4 rounded-full transition" data-tab="all">כל ההוצאות</button>
            </div>

            <!-- TODAY TAB -->
            <div id="tab-today" class="tab-content active space-y-6">
                <section id="owner-filters-today" class="mb-6 hidden"></section>
                <div id="normal-view-today">
                    <div class="space-y-6">
                        <section id="summary-section-today" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></section>
                        <section class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">התפלגות יומית (בשקלים)</h3>
                            <div class="h-64 md:h-80 flex justify-center"><canvas id="expenses-chart-today"></canvas></div>
                        </section>
                        <section>
                            <div id="expenses-list-today" class="space-y-4"></div>
                            <div id="no-expenses-message-today" class="text-center p-10 bg-white rounded-2xl shadow-lg hidden">
                                <i class="fas fa-receipt text-4xl text-slate-300 mb-4"></i>
                                <p class="text-slate-500">אין הוצאות להיום.</p>
                            </div>
                        </section>
                        <section id="summary-table-section-today" class="bg-white p-4 md:p-6 rounded-2xl shadow-lg hidden">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">סיכום הוצאות יומי</h3>
                            <div id="summary-table-today"></div>
                        </section>
                    </div>
                </div>
                <div id="comparison-view-today" class="hidden space-y-6">
                    <section class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="text-xl font-bold text-slate-800">השוואת הוצאות</h3>
                            <select id="comparison-category-filter-today" class="w-full sm:w-auto p-2 border rounded-md bg-slate-50"></select>
                        </div>
                        <div class="h-64 md:h-80 flex justify-center"><canvas id="owner-comparison-chart-today"></canvas></div>
                        <div id="comparison-total-today" class="text-center mt-4 text-lg font-bold text-slate-700"></div>
                    </section>
                </div>
            </div>

            <!-- ALL EXPENSES TAB -->
            <div id="tab-all" class="tab-content space-y-6">
                <section id="owner-filters-all" class="mb-6 hidden"></section>
                <div id="normal-view-all">
                    <div class="space-y-6">
                        <section class="bg-white p-3 rounded-2xl shadow-lg">
                            <div id="filters" class="flex items-center justify-center gap-2 bg-blue-700 p-1 rounded-full flex-wrap">
                                <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="week">שבוע</button>
                                <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="month">חודש</button>
                                <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="2months">חודשיים</button>
                                <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="6months">חצי שנה</button>
                                <button class="filter-btn active text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="all">הכל</button>
                            </div>
                        </section>
                        <section id="summary-section-all" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></section>
                        <section class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">התפלגות לפי קטגוריה (בשקלים)</h3>
                            <div class="h-64 md:h-80 flex justify-center"><canvas id="expenses-chart-all"></canvas></div>
                        </section>
                        <section>
                            <div id="expenses-list-all" class="space-y-4"></div>
                            <div id="no-expenses-message-all" class="text-center p-10 bg-white rounded-2xl shadow-lg hidden">
                                <i class="fas fa-search-dollar text-4xl text-slate-300 mb-4"></i>
                                <p class="text-slate-500">לא נמצאו הוצאות התואמות לסינון.</p>
                            </div>
                        </section>
                        <section id="summary-table-section-all" class="bg-white p-4 md:p-6 rounded-2xl shadow-lg hidden">
                            <h3 class="text-xl font-bold text-slate-800 mb-4">סיכום הוצאות כללי</h3>
                            <div id="summary-table-all"></div>
                        </section>
                    </div>
                </div>
                <div id="comparison-view-all" class="hidden space-y-6">
                    <section class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                        <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                            <h3 class="text-xl font-bold text-slate-800">השוואת הוצאות</h3>
                            <select id="comparison-category-filter-all" class="w-full sm:w-auto p-2 border rounded-md bg-slate-50"></select>
                        </div>
                        <div class="h-64 md:h-80 flex justify-center"><canvas id="owner-comparison-chart-all"></canvas></div>
                        <div id="comparison-total-all" class="text-center mt-4 text-lg font-bold text-slate-700"></div>
                    </section>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUserProfile = null;
        let tripId = null;
        let allExpenses = [];
        let tripCategories = [];
        let expensesUnsubscribe = null;
        let categoriesUnsubscribe = null;
        
        let expensesChartAll = null;
        let expensesChartToday = null;
        let ownerComparisonChartAll = null;
        let ownerComparisonChartToday = null;
        
        let activeTab = 'today';
        let activeFilter = 'all';
        let activeOwner = 'all'; 
        let comparisonViewActive = false;
        let activeComparisonCategory = 'all';

        let rateCache = {};
        
        const defaultCategories = ['🍔 אוכל ושתיה', '🚗 תחבורה', '🏨 לינה', '🎢 אטרקציות', '🛍️ קניות', '📎 אחר'];
        const currencies = {
            "ILS": "Israeli New Sheqel (₪)", "USD": "United States Dollar ($)", "EUR": "Euro (€)", "GBP": "British Pound (£)", "AUD": "Australian Dollar (A$)", "BGN": "Bulgarian Lev (лв)", "BRL": "Brazilian Real (R$)", "CAD": "Canadian Dollar (C$)", "CHF": "Swiss Franc (CHF)", "CNY": "Chinese Renminbi Yuan (¥)", "CZK": "Czech Koruna (Kč)", "DKK": "Danish Krone (kr)", "HKD": "Hong Kong Dollar (HK$)", "HUF": "Hungarian Forint (Ft)", "IDR": "Indonesian Rupiah (Rp)", "INR": "Indian Rupee (₹)", "ISK": "Icelandic Króna (kr)", "JPY": "Japanese Yen (¥)", "KRW": "South Korean Won (₩)", "MXN": "Mexican Peso (MX$)", "MYR": "Malaysian Ringgit (RM)", "NOK": "Norwegian Krone (kr)", "NZD": "New Zealand Dollar (NZ$)", "PHP": "Philippine Peso (₱)", "PLN": "Polish Złoty (zł)", "RON": "Romanian Leu (lei)", "SEK": "Swedish Krona (kr)", "SGD": "Singapore Dollar (S$)", "THB": "Thai Baht (฿)", "TRY": "Turkish Lira (₺)", "ZAR": "South African Rand (R)"
        };
        const prioritizedCurrencies = ['ILS', 'USD', 'EUR', 'GBP'];

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                console.error("Error: Trip ID not found.");
                window.location.href = 'index.html';
                return;
            }
            document.getElementById('back-to-dashboard').href = `trip.html?id=${tripId}`;
            populateCurrencyDropdown();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await fetchUserProfile(user.uid);
                    fetchTripDetails();
                    listenForCategories();
                    listenForExpenses();
                } else {
                    window.location.href = 'login.html';
                }
            });
            setupEventListeners();
        }

        // --- Data Fetching & Realtime Listeners ---
        async function fetchUserProfile(uid) {
            const userDocRef = doc(db, "users", uid);
            const docSnap = await getDoc(userDocRef);
            currentUserProfile = docSnap.exists() ? { uid, ...docSnap.data() } : { uid, displayName: "משתמש" };
        }

        async function fetchTripDetails() {
            const tripDocRef = doc(db, "trips", tripId);
            const docSnap = await getDoc(tripDocRef);
            if (docSnap.exists()) document.getElementById('trip-title').textContent = docSnap.data().name || 'ניהול הוצאות';
        }

        function listenForCategories() {
            if (categoriesUnsubscribe) categoriesUnsubscribe();
            const categoriesDocRef = doc(db, "trips", tripId, "settings", "categories");
            categoriesUnsubscribe = onSnapshot(categoriesDocRef, (docSnap) => {
                tripCategories = docSnap.exists() ? (docSnap.data().list || []) : [...defaultCategories];
                if (!docSnap.exists()) {
                    setDoc(categoriesDocRef, { list: defaultCategories });
                }
                populateCategoryDropdown();
            });
        }

        function listenForExpenses() {
            if (expensesUnsubscribe) expensesUnsubscribe();
            const expensesColRef = collection(db, "trips", tripId, "expenses");
            expensesUnsubscribe = onSnapshot(expensesColRef, async (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                // NEW: Onboarding logic
                const mainContent = document.getElementById('main-content');
                const onboardingScreen = document.getElementById('onboarding-screen');
                if (allExpenses.length === 0) {
                    mainContent.classList.add('hidden');
                    onboardingScreen.classList.remove('hidden');
                } else {
                    mainContent.classList.remove('hidden');
                    onboardingScreen.classList.add('hidden');
                    allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                    await render();
                }

                const loadingOverlay = document.getElementById('loading-overlay');
                if (!loadingOverlay.classList.contains('opacity-0')) {
                    loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => loadingOverlay.style.display = 'none', 500);
                }
            });
        }

        // --- Central Render Function ---
        async function render() {
            renderOwnerFilters();
            let filteredExpenses = getFilteredExpenses();

            const normalView = document.getElementById(`normal-view-${activeTab}`);
            const comparisonView = document.getElementById(`comparison-view-${activeTab}`);

            if (comparisonViewActive) {
                normalView.style.display = 'none';
                comparisonView.style.display = 'block';
                await renderComparisonView(filteredExpenses, activeTab);
            } else {
                normalView.style.display = 'block';
                comparisonView.style.display = 'none';
                await renderNormalView(filteredExpenses, activeTab);
            }
        }
        
        async function renderNormalView(expenses, tabId) {
            renderExpenseList(expenses, tabId);
            renderSummary(expenses, tabId);
            await renderSummaryTable(expenses, tabId);

            if (tabId === 'today') {
                expensesChartToday = await updateChartGeneric(expenses, 'expenses-chart-today', expensesChartToday);
            } else {
                expensesChartAll = await updateChartGeneric(expenses, 'expenses-chart-all', expensesChartAll);
            }
        }

        async function renderComparisonView(expenses, tabId) {
             populateComparisonCategoryFilter(expenses, tabId);
             let categoryFilteredExpenses = expenses;
             if(activeComparisonCategory !== 'all') {
                 categoryFilteredExpenses = expenses.filter(exp => exp.category === activeComparisonCategory);
             }

             if (tabId === 'today') {
                ownerComparisonChartToday = await updateOwnerComparisonChart(categoryFilteredExpenses, 'owner-comparison-chart-today', ownerComparisonChartToday);
             } else {
                ownerComparisonChartAll = await updateOwnerComparisonChart(categoryFilteredExpenses, 'owner-comparison-chart-all', ownerComparisonChartAll);
             }
        }

        // --- Filtering Logic ---
        function getFilteredExpenses() {
            const now = new Date();
            const todayString = now.toISOString().split('T')[0];
            
            let dateFilteredExpenses;
            if (activeTab === 'today') {
                dateFilteredExpenses = allExpenses.filter(exp => exp.date === todayString);
            } else {
                let startDate = new Date(0);
                switch (activeFilter) {
                    case 'week': startDate = new Date(new Date().setDate(now.getDate() - 7)); break;
                    case 'month': startDate = new Date(new Date().setMonth(now.getMonth() - 1)); break;
                    case '2months': startDate = new Date(new Date().setMonth(now.getMonth() - 2)); break;
                    case '6months': startDate = new Date(new Date().setMonth(now.getMonth() - 6)); break;
                    default: break;
                }
                if (activeFilter !== 'all') {
                    dateFilteredExpenses = allExpenses.filter(exp => new Date(exp.date) >= startDate);
                } else {
                    dateFilteredExpenses = allExpenses;
                }
            }

            if (comparisonViewActive || activeOwner === 'all') {
                return dateFilteredExpenses;
            } else {
                return dateFilteredExpenses.filter(exp => exp.ownerName === activeOwner);
            }
        }

        // --- UI Rendering ---
        function renderExpenseList(expenses, containerId) {
            const listContainer = document.getElementById(`expenses-list-${containerId}`);
            const noItemsMsg = document.getElementById(`no-expenses-message-${containerId}`);
            listContainer.innerHTML = ''; 
            
            if (expenses.length === 0) {
                noItemsMsg.classList.remove('hidden');
                listContainer.classList.add('hidden');
                return;
            }
            
            noItemsMsg.classList.add('hidden');
            listContainer.classList.remove('hidden');

            if (containerId === 'today') {
                renderFlatList(expenses, listContainer, containerId);
            } else {
                renderAccordionList(expenses, listContainer, containerId);
            }
        }

        function renderFlatList(expenses, container, containerId) {
            expenses.forEach((exp, index) => {
                container.appendChild(createExpenseCard(exp, containerId, index));
            });
        }

        async function renderAccordionList(expenses, container, containerId) {
            const groupedByCategory = expenses.reduce((acc, exp) => {
                (acc[exp.category] = acc[exp.category] || []).push(exp);
                return acc;
            }, {});

            for (const category in groupedByCategory) {
                const groupWrapper = document.createElement('div');
                groupWrapper.className = 'bg-white rounded-2xl shadow-md overflow-hidden';
                
                const expensesInCategory = groupedByCategory[category];
                let totalInCategory = 0;
                for (const exp of expensesInCategory) {
                    totalInCategory += await convertToILS(exp.amount, exp.currency);
                }

                const button = document.createElement('button');
                button.className = 'accordion-toggle w-full p-4 flex justify-between items-center text-right';
                button.innerHTML = `
                    <div class="flex items-center gap-4">
                        <span class="flex-shrink-0 h-10 w-10 bg-slate-100 rounded-full flex items-center justify-center text-xl">${category.match(/(\p{Emoji})/u)?.[0] || '📎'}</span>
                        <div>
                            <p class="font-bold text-slate-800">${category}</p>
                            <p class="text-sm text-slate-500">${expensesInCategory.length} הוצאות</p>
                        </div>
                    </div>
                    <div class="text-left">
                        <p class="font-bold text-lg text-slate-700">₪${totalInCategory.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        <i class="fas fa-chevron-down accordion-icon text-slate-400 mt-1"></i>
                    </div>
                `;

                const content = document.createElement('div');
                content.className = 'accordion-content';
                const innerContent = document.createElement('div');
                innerContent.className = 'p-4 border-t border-slate-200 space-y-3';
                expensesInCategory.forEach((exp, index) => {
                    innerContent.appendChild(createExpenseCard(exp, `${containerId}-${category}`, index));
                });
                content.appendChild(innerContent);

                groupWrapper.appendChild(button);
                groupWrapper.appendChild(content);
                container.appendChild(groupWrapper);
            }
        }

        function createExpenseCard(exp, containerId, index) {
            const card = document.createElement('div');
            card.className = 'bg-white p-4 rounded-2xl border border-slate-100 flex items-center gap-4 expense-card-clickable';
            card.dataset.id = exp.id; 

            const isOwner = currentUserProfile && exp.ownerId === currentUserProfile.uid;
            const uniqueId = `conv-${containerId}-${index}`;
            
            card.innerHTML = `
                <div class="flex-shrink-0 h-12 w-12 bg-slate-100 rounded-full flex items-center justify-center text-2xl">${exp.category.match(/(\p{Emoji})/u)?.[0] || '📎'}</div>
                <div class="flex-grow min-w-0">
                    <p class="font-bold text-slate-800 truncate">${exp.notes || 'הוצאה'}</p>
                    <p class="text-sm text-slate-500"><span class="font-semibold">${exp.ownerName || 'לא ידוע'}</span> • ${new Date(exp.date).toLocaleDateString('he-IL')}</p>
                </div>
                <div class="text-left flex-shrink-0">
                    <p class="font-bold text-lg text-red-600 whitespace-nowrap">
                        ${exp.amount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${exp.currency}
                    </p>
                    <p id="${uniqueId}" class="text-slate-500 font-normal text-sm text-right"></p>
                    ${isOwner ? `<div class="flex justify-end gap-2 mt-1">
                        <button class="edit-btn text-slate-400 hover:text-blue-600" data-id="${exp.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn text-slate-400 hover:text-red-600" data-id="${exp.id}"><i class="fas fa-trash"></i></button>
                    </div>` : ''}
                </div>
            `;
            
            if (exp.currency !== 'ILS') {
                displayConvertedAmount(uniqueId, exp.amount, exp.currency);
            } else {
                const el = card.querySelector(`#${uniqueId}`);
                if (el) el.style.display = 'none';
            }
            return card;
        }

        function renderSummary(expenses, containerId) {
            const summaryContainer = document.getElementById(`summary-section-${containerId}`);
            const summary = expenses.reduce((acc, exp) => {
                acc[exp.currency] = (acc[exp.currency] || 0) + Number(exp.amount);
                return acc;
            }, {});
            summaryContainer.innerHTML = '';
            if (Object.keys(summary).length === 0) {
                summaryContainer.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg text-center col-span-full"><p class="text-slate-500">אין הוצאות להצגה</p></div>`;
                return;
            }
            for (const currency in summary) {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-2xl shadow-lg text-center';
                card.innerHTML = `
                    <h3 class="text-slate-500 font-semibold text-sm">סה"כ (${currency})</h3>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${summary[currency].toLocaleString('he-IL', { minimumFractionDigits: 2 })}</p>
                `;
                summaryContainer.appendChild(card);
            }
        }

        async function updateChartGeneric(expenses, canvasId, chartInstance) {
            const chartCanvas = document.getElementById(canvasId);
            if (!chartCanvas) return chartInstance;
            const parentSection = chartCanvas.closest('section');

            if (expenses.length === 0) {
                if (chartInstance) chartInstance.destroy();
                parentSection.style.display = 'none';
                return null;
            }
            parentSection.style.display = 'block';

            const categoryData = {};
            for (const exp of expenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                categoryData[exp.category] = (categoryData[exp.category] || 0) + amountInILS;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const chartColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#eab308', '#64748b', '#ec4899', '#10b981', '#f59e0b'];

            const chartConfig = {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: chartColors, borderColor: '#fff', borderWidth: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: "'Assistant', sans-serif" }, boxWidth: 20, padding: 20 } },
                        tooltip: { callbacks: { label: (context) => ` ${context.label}: ${new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS' }).format(context.parsed)}` } }
                    }
                }
            };
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.update();
                return chartInstance;
            } else {
                return new Chart(chartCanvas, chartConfig);
            }
        }

        function renderOwnerFilters() {
            const uniqueOwners = [...new Set(allExpenses.map(exp => exp.ownerName).filter(Boolean))];
            const containers = [document.getElementById('owner-filters-today'), document.getElementById('owner-filters-all')];
            
            containers.forEach(container => {
                if (uniqueOwners.length <= 1) {
                    container.innerHTML = '';
                    container.classList.add('hidden');
                    return;
                }
                container.classList.remove('hidden');
                let buttonsHTML = `<button class="owner-filter-btn font-semibold px-4 py-2 rounded-full transition ${activeOwner === 'all' && !comparisonViewActive ? 'active' : 'bg-white'}" data-owner="all">הכל</button>`;
                uniqueOwners.forEach(owner => {
                    buttonsHTML += `<button class="owner-filter-btn font-semibold px-4 py-2 rounded-full transition ${activeOwner === owner && !comparisonViewActive ? 'active' : 'bg-white'}" data-owner="${owner}">${owner}</button>`;
                });
                buttonsHTML += `<button class="owner-filter-btn font-semibold px-4 py-2 rounded-full transition ${comparisonViewActive ? 'active' : 'bg-white'}" data-owner="compare"><i class="fas fa-chart-pie mr-2"></i>השווה</button>`;
                container.innerHTML = `<div class="flex items-center justify-center gap-2 flex-wrap p-1 bg-slate-200 rounded-full">${buttonsHTML}</div>`;
            });
        }

        async function renderSummaryTable(expenses, containerId) {
            const tableContainer = document.getElementById(`summary-table-${containerId}`);
            const sectionContainer = document.getElementById(`summary-table-section-${containerId}`);

            if (expenses.length === 0) {
                sectionContainer.classList.add('hidden');
                return;
            }
            sectionContainer.classList.remove('hidden');

            const categoryTotals = {};
            for (const exp of expenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + amountInILS;
            }

            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);
            
            let tableHTML = `<div class="flow-root"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8"><div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8"><table class="min-w-full divide-y divide-slate-200">`;
            tableHTML += `<thead><tr>
                <th scope="col" class="py-3.5 pl-4 pr-3 text-right text-sm font-semibold text-slate-900 sm:pl-0">קטגוריה</th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-slate-900">סכום (₪)</th>
            </tr></thead>`;
            tableHTML += `<tbody class="divide-y divide-slate-100">`;
            for (const [category, total] of sortedCategories) {
                tableHTML += `<tr>
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-slate-900 sm:pl-0">${category}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 text-left font-mono">${total.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>`;
            }
            tableHTML += `</tbody></table></div></div></div>`;
            tableContainer.innerHTML = tableHTML;
        }

        async function updateOwnerComparisonChart(expenses, canvasId, chartInstance) {
            const chartCanvas = document.getElementById(canvasId);
            if (!chartCanvas) return chartInstance;
            const parentSection = chartCanvas.closest('section');
            const totalContainer = document.getElementById(`comparison-total-${activeTab}`);

            if (expenses.length === 0) {
                if (chartInstance) chartInstance.destroy();
                parentSection.style.display = 'none';
                return null;
            }
            parentSection.style.display = 'block';

            const ownerTotals = {};
            let grandTotal = 0;
            for (const exp of expenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                ownerTotals[exp.ownerName] = (ownerTotals[exp.ownerName] || 0) + amountInILS;
                grandTotal += amountInILS;
            }

            totalContainer.textContent = `סה"כ: ${grandTotal.toLocaleString('he-IL', { style: 'currency', currency: 'ILS' })}`;

            const labels = Object.keys(ownerTotals);
            const data = Object.values(ownerTotals);
            const chartColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#eab308', '#64748b', '#ec4899', '#10b981', '#f59e0b'];
            
            const chartConfig = {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: chartColors, borderColor: '#fff', borderWidth: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: "'Assistant', sans-serif" }, boxWidth: 20, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = grandTotal > 0 ? ((value / grandTotal) * 100).toFixed(1) : 0;
                                    return ` ${label}: ${new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS' }).format(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.update();
                return chartInstance;
            } else {
                return new Chart(chartCanvas, chartConfig);
            }
        }
        
        function populateComparisonCategoryFilter(expenses, tabId) {
            const select = document.getElementById(`comparison-category-filter-${tabId}`);
            const uniqueCategories = [...new Set(expenses.map(exp => exp.category))];
            
            let optionsHTML = `<option value="all">כל הקטגוריות</option>`;
            uniqueCategories.forEach(cat => {
                optionsHTML += `<option value="${cat}" ${activeComparisonCategory === cat ? 'selected' : ''}>${cat}</option>`;
            });
            select.innerHTML = optionsHTML;
        }

        // --- Currency Conversion API & Helpers ---
        async function getRate(from, to) {
            if (from === to) return 1;
            const cacheKey = `${from}-${to}`;
            if (rateCache[cacheKey]) return rateCache[cacheKey];
            try {
                const res = await fetch(`https://api.frankfurter.app/latest?from=${from}&to=${to}`);
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const rate = data.rates[to];
                if (typeof rate !== 'number') return 1;
                rateCache[cacheKey] = rate;
                return rate;
            } catch (error) {
                console.error('Failed to fetch currency rate:', error);
                return 1;
            }
        }
        
        async function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            const rate = await getRate(currency, 'ILS');
            return amount * rate;
        }

        async function displayConvertedAmount(elementId, amount, from) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = `<span class="loader"></span>`;
            const convertedAmount = await convertToILS(amount, from);
            el.textContent = `(₪${convertedAmount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
        }

        // --- Dropdown Population ---
        function populateCurrencyDropdown() {
            const expenseCurrency = document.getElementById('expense-currency');
            const fragment = document.createDocumentFragment();
            prioritizedCurrencies.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} — ${currencies[code]}`;
                fragment.appendChild(opt);
            });
            const otherCurrencies = Object.keys(currencies).filter(c => !prioritizedCurrencies.includes(c)).sort();
            otherCurrencies.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} — ${currencies[code]}`;
                fragment.appendChild(opt);
            });
            expenseCurrency.appendChild(fragment);
        }

        function populateCategoryDropdown() {
            const expenseCategory = document.getElementById('expense-category');
            expenseCategory.innerHTML = tripCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('') + '<option value="add_new_category">➕ הוסף חדשה...</option>';
        }

        // --- Modal & Form Logic ---
        function openModal(modalId) { document.getElementById(modalId)?.classList.remove('modal-hidden'); }
        function closeModal(modalId) { document.getElementById(modalId)?.classList.add('modal-hidden'); }

        function openExpenseModal(expense = null) {
            const expenseForm = document.getElementById('expense-form');
            expenseForm.reset();
            document.getElementById('new-category-wrapper').classList.add('hidden');
            document.getElementById('delete-category-btn').classList.add('hidden');

            if (expense) {
                document.getElementById('modal-title').textContent = 'עריכת הוצאה';
                const expenseDocRef = doc(db, "trips", tripId, "expenses", expense.id);
                getDoc(expenseDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('expense-id').value = expense.id;
                        document.getElementById('expense-owner-name').value = data.ownerName || '';
                        document.getElementById('expense-amount').value = data.amount;
                        document.getElementById('expense-currency').value = data.currency;
                        document.getElementById('expense-category').value = data.category;
                        document.getElementById('expense-date').value = data.date;
                        document.getElementById('expense-notes').value = data.notes || '';
                    }
                });
            } else {
                document.getElementById('modal-title').textContent = 'הוספת הוצאה חדשה';
                document.getElementById('expense-id').value = '';
                // NEW: Remember last owner
                const lastOwner = localStorage.getItem(`lastExpenseOwner_${tripId}`);
                document.getElementById('expense-owner-name').value = lastOwner || currentUserProfile.displayName;
                document.getElementById('expense-date').valueAsDate = new Date();
            }
            openModal('expense-modal');
        }
        
        async function openExpenseDetailsModal(expenseId) {
            const expense = allExpenses.find(exp => exp.id === expenseId);
            if (!expense) return;

            const contentEl = document.getElementById('expense-details-content');
            
            const detailsHTML = `
                <div class="grid grid-cols-3 gap-x-4 gap-y-3">
                    <p class="text-sm text-slate-500 col-span-1">מוציא:</p>
                    <p class="font-semibold col-span-2">${expense.ownerName || 'לא ידוע'}</p>

                    <p class="text-sm text-slate-500 col-span-1">קטגוריה:</p>
                    <p class="font-semibold col-span-2">${expense.category}</p>

                    <p class="text-sm text-slate-500 col-span-1">פירוט:</p>
                    <p class="font-semibold col-span-2">${expense.notes || '---'}</p>

                    <p class="text-sm text-slate-500 col-span-1">תאריך:</p>
                    <p class="font-semibold col-span-2">${new Date(expense.date).toLocaleDateString('he-IL')}</p>

                    <p class="text-sm text-slate-500 col-span-1">שעת הוספה:</p>
                    <p class="font-semibold col-span-2">${expense.createdAt && expense.createdAt.toDate ? expense.createdAt.toDate().toLocaleTimeString('he-IL') : 'לא ידוע'}</p>
                </div>
                <div class="pt-3 border-t mt-3 space-y-3">
                    <div class="grid grid-cols-3 gap-x-4">
                        <p class="text-sm text-slate-500 col-span-1">סכום מקורי:</p>
                        <p class="font-bold text-red-600 col-span-2">${expense.amount.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${expense.currency}</p>
                    </div>
                    <div id="details-conversion-row" class="grid grid-cols-3 gap-x-4">
                        <p class="text-sm text-slate-500 col-span-1">סכום בשקלים:</p>
                        <p class="font-bold text-blue-600 col-span-2" id="details-converted-amount"><span class="loader"></span></p>
                    </div>
                </div>
            `;
            contentEl.innerHTML = detailsHTML;

            if (expense.currency === 'ILS') {
                document.getElementById('details-conversion-row').style.display = 'none';
            } else {
                document.getElementById('details-conversion-row').style.display = 'grid';
                const convertedAmount = await convertToILS(expense.amount, expense.currency);
                document.getElementById('details-converted-amount').textContent = `₪${convertedAmount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }

            openModal('expense-details-modal');
        }

        // --- Settings Modal Logic ---
        async function openSettingsModal() {
            if (!currentUserProfile) return;
            document.getElementById('trip-id-input').value = tripId;
            const userDocRef = doc(db, "users", currentUserProfile.uid);
            const userDocSnap = await getDoc(userDocRef);
            const apiKey = userDocSnap.exists() ? userDocSnap.data().settings?.apiKey : null;
            document.getElementById('api-key-input').value = apiKey || 'לחץ על הכפתור ליצירה...';
            openModal('settings-modal');
        }

        async function generateAndSaveApiKey() {
            if (!currentUserProfile) return;
            const newKey = `sk_${crypto.randomUUID()}`;
            document.getElementById('api-key-input').value = newKey;
            const userDocRef = doc(db, "users", currentUserProfile.uid);
            try {
                await setDoc(userDocRef, { settings: { apiKey: newKey } }, { merge: true });
            } catch (error) {
                console.error("Error saving API key:", error);
            }
        }

        function copyToClipboard(inputElement, buttonElement) {
            if (!inputElement.value || inputElement.value.startsWith('לחץ')) return;
            inputElement.select();
            inputElement.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                const originalIcon = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                setTimeout(() => { buttonElement.innerHTML = originalIcon; }, 1500);
            } catch (err) { console.error('Failed to copy to clipboard'); }
        }

        async function handleExpenseFormSubmit(e) {
            e.preventDefault();
            const expenseCategory = document.getElementById('expense-category');
            let category = expenseCategory.value;

            if (category === 'add_new_category') {
                const newCategoryName = document.getElementById('new-category-name').value.trim();
                if (newCategoryName && !tripCategories.includes(newCategoryName)) {
                    const updatedCategories = [...tripCategories, newCategoryName];
                    await setDoc(doc(db, "trips", tripId, "settings", "categories"), { list: updatedCategories });
                    category = newCategoryName;
                } else { return; }
            }
            
            const ownerName = document.getElementById('expense-owner-name').value.trim();
            localStorage.setItem(`lastExpenseOwner_${tripId}`, ownerName); // NEW: Save last owner name

            const expenseData = {
                ownerName: ownerName,
                amount: parseFloat(document.getElementById('expense-amount').value),
                currency: document.getElementById('expense-currency').value,
                category: category,
                date: document.getElementById('expense-date').value,
                notes: document.getElementById('expense-notes').value.trim(),
                ownerId: currentUserProfile.uid,
            };

            try {
                const id = document.getElementById('expense-id').value;
                if (id) {
                    await updateDoc(doc(db, "trips", tripId, "expenses", id), expenseData);
                } else {
                    expenseData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "trips", tripId, "expenses"), expenseData);
                }
                closeModal('expense-modal');
            } catch (error) { console.error("Error saving expense:", error); }
        }
        
        async function handleDeleteCategory() {
            const categoryToDelete = document.getElementById('expense-category').value;
            if (!categoryToDelete || defaultCategories.includes(categoryToDelete)) return;
            if (window.confirm(`האם למחוק את הקטגוריה "${categoryToDelete}"?`)) {
                const updatedCategories = tripCategories.filter(c => c !== categoryToDelete);
                await setDoc(doc(db, "trips", tripId, "settings", "categories"), { list: updatedCategories });
            }
        }
        
        async function handleDeleteExpense(id) {
            if (window.confirm('האם אתה בטוח שברצונך למחוק הוצאה זו?')) {
                await deleteDoc(doc(db, "trips", tripId, "expenses", id));
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('add-expense-btn-header').addEventListener('click', () => openExpenseModal());
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
            document.getElementById('expense-form').addEventListener('submit', handleExpenseFormSubmit);
            
            document.querySelectorAll('[data-close-modal]').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.closeModal));
            });

            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', async () => {
                    activeTab = tab.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${activeTab}`).classList.add('active');
                    await render();
                });
            });

            document.querySelectorAll('.filter-btn').forEach(filter => {
                filter.addEventListener('click', async () => {
                    activeFilter = filter.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    await render();
                });
            });
            
            document.body.addEventListener('click', async (e) => {
                // Accordion Toggle
                const accordionToggle = e.target.closest('.accordion-toggle');
                if (accordionToggle) {
                    accordionToggle.classList.toggle('active');
                    const content = accordionToggle.nextElementSibling;
                    if (content.style.maxHeight) {
                        content.style.maxHeight = null;
                    } else {
                        content.style.maxHeight = content.scrollHeight + "px";
                    }
                    return;
                }

                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    e.stopPropagation();
                    openExpenseModal({ id: editBtn.dataset.id });
                    return;
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    handleDeleteExpense(deleteBtn.dataset.id);
                    return;
                }

                const ownerBtn = e.target.closest('.owner-filter-btn');
                if (ownerBtn) {
                    const owner = ownerBtn.dataset.owner;
                    if(owner === 'compare') {
                        comparisonViewActive = true;
                    } else {
                        comparisonViewActive = false;
                        activeOwner = owner;
                    }
                    await render();
                    return;
                }
                
                const card = e.target.closest('.expense-card-clickable');
                if (card) {
                    openExpenseDetailsModal(card.dataset.id);
                }
            });

            const expenseCategorySelect = document.getElementById('expense-category');
            expenseCategorySelect.addEventListener('change', () => {
                const isAddNew = expenseCategorySelect.value === 'add_new_category';
                document.getElementById('new-category-wrapper').classList.toggle('hidden', !isAddNew);
                const isCustom = !defaultCategories.includes(expenseCategorySelect.value) && !isAddNew;
                document.getElementById('delete-category-btn').classList.toggle('hidden', !isCustom);
            });
            
            document.getElementById('delete-category-btn').addEventListener('click', handleDeleteCategory);

            document.getElementById('generate-api-key-btn').addEventListener('click', generateAndSaveApiKey);
            document.getElementById('copy-api-key-btn').addEventListener('click', () => copyToClipboard(document.getElementById('api-key-input'), document.getElementById('copy-api-key-btn')));
            document.getElementById('copy-trip-id-btn').addEventListener('click', () => copyToClipboard(document.getElementById('trip-id-input'), document.getElementById('copy-trip-id-btn')));
            
            document.getElementById('comparison-category-filter-today').addEventListener('change', async (e) => {
                activeComparisonCategory = e.target.value;
                await render();
            });
            document.getElementById('comparison-category-filter-all').addEventListener('change', async (e) => {
                activeComparisonCategory = e.target.value;
                await render();
            });
        }

        // --- Start ---
        initPage();
    </script>
</body>
</html>
