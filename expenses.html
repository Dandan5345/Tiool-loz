<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>× ×™×”×•×œ ×”×•×¦××•×ª ××©×•×“×¨×’</title>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts: Assistant + Rubik (for Sidebar) -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <!-- jsPDF and html2canvas for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Assistant', 'sans-serif'],
                rubik: ['Rubik', 'sans-serif'],
              }
            }
          }
        }
    </script>

    <style>
        :root {
            --bg-color: #f1f5f9; /* slate-100 */
            --card-bg-color: #ffffff; /* white */
            --text-color: #334155; /* slate-700 */
            --header-bg-color: #ffffff;
            --accent-color: #3b82f6; /* blue-500 */
        }

        body { 
            font-family: 'Assistant', sans-serif; 
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.5s ease;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* Modal Transitions */
        .modal-transition { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
        
        /* Tabs & Filters */
        .tab-btn.active {
            border-color: var(--accent-color);
            color: var(--accent-color);
            background-color: color-mix(in srgb, var(--accent-color) 15%, transparent);
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .filter-btn.active {
            background-color: var(--accent-color);
            color: white;
        }
        
        .owner-filter-btn.active {
            background-color: var(--accent-color);
            color: white;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .owner-filter-btn[data-owner="compare"].active {
            background-color: #16a34a; /* green-600 */
        }
        
        /* Expense Cards */
        .expense-card-clickable {
            cursor: pointer;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .expense-card-clickable:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        /* Excluded Expense Style */
        .expense-excluded {
            opacity: 0.6;
            filter: grayscale(0.8);
            background-color: #f8fafc !important; 
        }

        /* Loader */
        .loader {
            width: 12px;
            height: 12px;
            border: 2px solid #d1d5db; /* gray-300 */
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Collapsible Categories */
        .category-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out;
            padding: 0 1rem; /* p-4 horizontal */
        }
        .category-content.expanded {
             max-height: 2000px; /* Increased for safety */
             padding: 1rem; /* p-4 */
        }

        /* Settings Modal Tabs */
        .settings-tab-btn.active {
            background-color: var(--accent-color);
            color: white;
        }
        .settings-tab-content { display: none; }
        .settings-tab-content.active { display: block; }

        /* Table Layout */
        .expense-table-wrapper {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }
        .expense-table {
            width: 100%;
            min-width: 700px; 
            border-collapse: collapse;
        }
        .expense-table th, .expense-table td {
            padding: 12px 16px;
            text-align: right;
            border-bottom: 1px solid #e5e7eb; 
            white-space: nowrap;
        }
        .expense-table th {
            background-color: #f9fafb; 
            font-weight: 600;
        }
        .expense-table tbody tr:hover {
            background-color: #f9fafb; 
        }
        
        /* Layout Switching Logic */
        .layout-cards .expense-table-view { display: none; }
        .layout-table .expense-cards-view { display: none; }
        
        /* Sticky Header Fix */
        #main-content-wrapper {
            padding-top: 64px; 
        }

        /* Toggle Switch */
        .toggle-checkbox:checked {
            right: 0;
            border-color: #3b82f6;
        }
        .toggle-checkbox:checked + .toggle-label {
            background-color: #3b82f6;
        }
        
        /* --- SIDEBAR STYLES --- */
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .submenu.open { 
            max-height: 1000px; 
        }
        
        .chevron-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }

        #sidebar::-webkit-scrollbar { width: 4px; }
        #sidebar::-webkit-scrollbar-track { background: transparent; }
        #sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        body.modal-locked { overflow: hidden; }

    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-wallet text-5xl text-blue-600 animate-pulse"></i>
        <p id="loading-text" class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ ×”×•×¦××•×ª...</p>
    </div>

    <!-- Onboarding screen -->
    <div id="onboarding-screen" class="hidden">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-10 text-center">
            <i class="fas fa-magic-wand-sparkles text-6xl text-blue-500 mb-6"></i>
            <h1 class="text-3xl font-bold text-slate-800 mb-4">×‘×¨×•×›×™× ×”×‘××™× ×œ×× ×”×œ ×”×”×•×¦××•×ª!</h1>
            <p class="text-slate-600 max-w-2xl mx-auto mb-8">×–×”×• ×”××§×•× ×”××¨×›×–×™ ×©×œ×›× ×œ××¢×§×‘ ××—×¨ ×›×œ ×”×”×•×¦××•×ª ×‘×˜×™×•×œ. ×‘×•××• × ×ª×—×™×œ!</p>
            <div class="text-right max-w-3xl mx-auto space-y-8">
                <div class="bg-white p-6 rounded-2xl shadow-lg">
                    <h2 class="text-xl font-bold text-slate-800 mb-3">××™×š ××ª×—×™×œ×™×?</h2>
                      <div class="flex flex-col sm:flex-row gap-4 mt-4">
                          <button id="add-first-expense-btn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg text-lg transition-transform transform hover:scale-105">
                              <i class="fas fa-plus-circle mr-2"></i>×”×•×¡×£ ×”×•×¦××” ×¨××©×•× ×”
                          </button>
                          <button id="onboarding-settings-btn" class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3 px-6 rounded-lg text-lg transition">
                             <i class="fas fa-cog mr-2"></i>×”×’×“×¨×•×ª
                          </button>
                      </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Details Modal -->
    <div id="expense-details-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[102] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg text-slate-800" style="background-color: var(--card-bg-color); color: var(--text-color);">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 class="text-2xl font-bold">×¤×¨×˜×™ ×”×•×¦××”</h3>
                <button data-close-modal="expense-details-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div id="expense-details-content" class="space-y-3">
                <!-- Content generated by JS -->
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[101] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-xl text-slate-800 flex flex-col max-h-[90vh]">
            <div class="flex-shrink-0">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-2xl font-bold">×”×’×“×¨×•×ª</h3>
                    <button data-close-modal="settings-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>

                <div class="mb-4 border-b border-gray-200">
                    <nav class="flex -mb-px" aria-label="Tabs">
                        <button class="settings-tab-btn active whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm" data-tab="theme">
                            <i class="fas fa-palette mr-2"></i>×¢×¨×›×ª × ×•×©×
                        </button>
                        <button class="settings-tab-btn whitespace-nowrap py-3 px-4 border-b-2 font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300" data-tab="shortcuts">
                            <i class="fas fa-bolt mr-2"></i>×§×™×¦×•×¨ ×“×¨×š
                        </button>
                    </nav>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto pr-2 -mr-2">
                <div id="settings-tab-shortcuts" class="settings-tab-content">
                    <div class="space-y-6">
                         <p class="text-sm text-slate-600">×”×¢×ª×§ ××ª ×©× ×™ ×”×¤×¨×˜×™× ×”×‘××™× ×•×”×“×‘×§ ××•×ª× ×‘×©××œ×•×ª ×”×”×ª×§× ×” ×©×œ ×”×§×™×¦×•×¨ ×‘××™×™×¤×•×Ÿ.</p>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">1. ××–×”×” ×”×˜×™×•×œ ×”× ×•×›×—×™</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="trip-id-input" readonly class="w-full p-2 rounded-md bg-slate-100 text-slate-500 font-mono text-sm text-left" dir="ltr">
                                <button id="copy-trip-id-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-3 rounded-lg transition whitespace-nowrap" title="×”×¢×ª×§ ××–×”×” ×˜×™×•×œ"><i class="fas fa-copy"></i></button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-slate-700 mb-1">2. ×”××¤×ª×— ×”×¡×•×“×™ ×”××™×©×™ ×©×œ×š</label>
                            <div class="flex items-center gap-2">
                                <input type="text" id="api-key-input" readonly class="w-full p-2 rounded-md bg-slate-100 text-slate-500 font-mono text-sm text-left" dir="ltr" placeholder="×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×›×“×™ ×œ×™×¦×•×¨ ××¤×ª×—...">
                                <button id="copy-api-key-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-bold py-2 px-3 rounded-lg transition whitespace-nowrap" title="×”×¢×ª×§ ××¤×ª×— ×¡×•×“×™"><i class="fas fa-copy"></i></button>
                            </div>
                             <button id="generate-api-key-btn" class="mt-2 w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg text-sm">×¦×•×¨/×”×—×œ×£ ××¤×ª×— ×¡×•×“×™ (×¤×¢×•×œ×” ×–×• ×ª×‘×˜×œ ××¤×ª×— ×§×•×“×)</button>
                        </div>
                    </div>
                </div>

                <div id="settings-tab-theme" class="settings-tab-content active">
                    <div class="space-y-6">
                        <div>
                            <h4 class="text-lg font-semibold mb-2">×¡×’× ×•×Ÿ ×ª×¦×•×’×”</h4>
                            <div class="flex gap-4 rounded-lg bg-slate-100 p-1">
                                <label class="flex-1 text-center cursor-pointer">
                                    <input type="radio" name="layout-style" value="cards" class="sr-only peer" checked>
                                    <div class="p-2 rounded-md peer-checked:bg-blue-500 peer-checked:text-white">×›×¨×˜×™×¡×™×•×ª</div>
                                </label>
                                <label class="flex-1 text-center cursor-pointer">
                                    <input type="radio" name="layout-style" value="table" class="sr-only peer">
                                    <div class="p-2 rounded-md peer-checked:bg-blue-500 peer-checked:text-white">×˜×‘×œ×”</div>
                                </label>
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-2">×¢×¨×›×•×ª × ×•×©× ×“×™× ××™×•×ª</h4>
                            <div id="dynamic-themes-container" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-2">×¢×¨×›×•×ª × ×•×©× ××•×›× ×•×ª</h4>
                            <div id="preset-themes-container" class="grid grid-cols-2 sm:grid-cols-4 gap-2"></div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold mb-2">×¦×‘×¢×™× ××•×ª×××™×</h4>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                <div class="flex flex-col items-center">
                                    <label for="bg-color-picker" class="text-sm mb-1">×¦×‘×¢ ×¨×§×¢</label>
                                    <input type="color" id="bg-color-picker" class="w-16 h-10 rounded-md border-none cursor-pointer">
                                </div>
                                <div class="flex flex-col items-center">
                                    <label for="card-bg-color-picker" class="text-sm mb-1">×¨×§×¢ ×›×¨×˜×™×¡×™×”</label>
                                    <input type="color" id="card-bg-color-picker" class="w-16 h-10 rounded-md border-none cursor-pointer">
                                </div>
                                 <div class="flex flex-col items-center">
                                    <label for="text-color-picker" class="text-sm mb-1">×¦×‘×¢ ×˜×§×¡×˜</label>
                                    <input type="color" id="text-color-picker" class="w-16 h-10 rounded-md border-none cursor-pointer">
                                </div>
                                <div class="flex flex-col items-center">
                                    <label for="accent-color-picker" class="text-sm mb-1">×¦×‘×¢ ×”×“×’×©×”</label>
                                    <input type="color" id="accent-color-picker" class="w-16 h-10 rounded-md border-none cursor-pointer">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Expense Form Modal -->
    <div id="expense-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×”×•×¦××” ×—×“×©×”</h3>
                <button data-close-modal="expense-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="expense-id">
                <div>
                    <label for="expense-owner-name" class="block text-sm font-medium text-slate-700 mb-1">×©× ×”××•×¡×™×£</label>
                    <input type="text" id="expense-owner-name" class="w-full p-2 border rounded-md bg-slate-50" required>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-slate-700 mb-1">×¡×›×•×</label>
                        <input type="number" id="expense-amount" step="0.01" class="w-full p-2 border rounded-md" placeholder="100" required>
                    </div>
                    <div>
                        <label for="expense-currency" class="block text-sm font-medium text-slate-700 mb-1">××˜×‘×¢</label>
                        <select id="expense-currency" class="w-full p-2 border rounded-md bg-white"></select>
                    </div>
                </div>
                <div>
                    <label for="expense-category" class="block text-sm font-medium text-slate-700 mb-1">×§×˜×’×•×¨×™×”</label>
                    <div class="flex items-center gap-2">
                        <select id="expense-category" class="w-full p-2 border rounded-md bg-white"></select>
                        <button type="button" id="delete-category-btn" class="text-slate-400 hover:text-red-500 p-2 hidden" title="××—×§ ×§×˜×’×•×¨×™×” ×–×•"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div id="new-category-wrapper" class="hidden">
                    <label for="new-category-name" class="block text-sm font-medium text-slate-700 mb-1">×©× ×”×§×˜×’×•×¨×™×” ×”×—×“×©×”</label>
                    <input type="text" id="new-category-name" class="w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: ×‘×™×œ×•×™×™×">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-slate-700 mb-1">×ª××¨×™×š</label>
                        <input type="date" id="expense-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="expense-notes" class="block text-sm font-medium text-slate-700 mb-1">×¤×™×¨×•×˜ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="text" id="expense-notes" class="w-full p-2 border rounded-md" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×...">
                    </div>
                </div>
                
                <!-- NEW FEATURE 1: Toggle Exclusion -->
                <div class="flex items-center gap-2 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                    <input type="checkbox" id="expense-is-excluded" class="w-5 h-5 rounded text-blue-600 focus:ring-blue-500 border-gray-300">
                    <label for="expense-is-excluded" class="text-sm font-medium text-slate-700 cursor-pointer select-none">
                        ×”×•×¦××” ×—×¨×™×’×” (×œ× ×œ×›×œ×•×œ ×‘×—×™×©×•×‘ ×”×©×•×˜×£)
                        <span class="block text-xs text-slate-500 font-normal">×œ×“×•×’××”: ×§× ×™×™×ª ××™×™×¤×•×Ÿ, ××ª× ×•×ª ×’×“×•×œ×•×ª</span>
                    </label>
                </div>

                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" data-close-modal="expense-modal" class="bg-gray-200 hover:bg-gray-300 text-black font-bold py-2 px-6 rounded-lg">×‘×™×˜×•×œ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main content area -->
    <div id="main-content" class="hidden">
        <header class="shadow-sm sticky top-0 z-30 h-16" style="background-color: var(--header-bg-color);">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <!-- Right Side: Hamburger + Back Button -->
                    <div class="flex items-center gap-2">
                        <button id="hamburger-btn" class="text-slate-600 hover:text-blue-600 bg-slate-100 hover:bg-slate-200 rounded-full h-10 w-10 flex items-center justify-center transition shadow-sm">
                            <i class="fas fa-bars fa-lg"></i>
                        </button>

                        <a id="back-to-dashboard" href="#" class="font-bold hover:text-blue-600 flex items-center gap-2 mr-2" style="color: var(--text-color);">
                            <i class="fas fa-arrow-right"></i>
                        </a>
                    </div>

                    <!-- Center: Title -->
                    <h1 id="trip-title" class="text-xl font-bold truncate mx-2" style="color: var(--text-color);">× ×™×”×•×œ ×”×•×¦××•×ª</h1>
                    
                    <!-- Left Side: Actions -->
                    <div class="flex items-center gap-2">
                        <button id="export-pdf-btn" class="text-slate-500 hover:text-blue-600 bg-slate-100 hover:bg-slate-200 rounded-full h-8 w-8 flex items-center justify-center transition" title="×™×™×¦× ×“×•×— ×œ-PDF">
                            <i class="fas fa-file-export"></i>
                        </button>
                        <button id="settings-btn" class="text-slate-500 hover:text-blue-600 bg-slate-100 hover:bg-slate-200 rounded-full h-8 w-8 flex items-center justify-center transition" title="×”×’×“×¨×•×ª">
                            <i class="fas fa-cog"></i>
                        </button>
                        <button id="add-expense-btn-header" class="bg-blue-600 hover:bg-blue-700 text-white rounded-full h-8 w-8 flex items-center justify-center shadow-md" title="×”×•×¡×£ ×”×•×¦××”">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div id="main-content-wrapper">
            <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 pb-24">
                
                <!-- NEW FEATURE 2: Dashboard Stats -->
                <div id="stats-dashboard" class="grid grid-cols-3 gap-2 mb-6 text-center">
                    <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400 mb-1">×××•×¦×¢ ×œ×™×•×</p>
                        <p id="stat-daily-avg" class="text-sm font-bold text-slate-800">â‚ª0</p>
                    </div>
                     <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400 mb-1">×”×”×•×¦××” ×”×’×“×•×œ×”</p>
                        <p id="stat-max-expense" class="text-sm font-bold text-rose-600">â‚ª0</p>
                    </div>
                     <div class="bg-white p-3 rounded-xl shadow-sm border border-slate-100">
                        <p class="text-xs text-slate-400 mb-1">×¡×”"×› ×¤×¨×™×˜×™×</p>
                        <p id="stat-total-items" class="text-sm font-bold text-blue-600">0</p>
                    </div>
                </div>

                <div class="mb-6 bg-slate-200 p-1 rounded-full grid grid-cols-2 gap-1">
                    <button class="tab-btn active font-bold py-2 px-4 rounded-full transition" data-tab="today">×”×™×•×</button>
                    <button class="tab-btn font-bold py-2 px-4 rounded-full transition" data-tab="all">×›×œ ×”×”×•×¦××•×ª</button>
                </div>

                <!-- "Today" Tab Content -->
                <div id="tab-today" class="tab-content active space-y-6">
                    <section id="owner-filters-today" class="mb-6 hidden"></section>
                    
                    <div id="normal-view-today">
                        <div class="space-y-6">
                            <section id="summary-section-today" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></section>
                            <section class="p-4 md:p-6 rounded-2xl shadow-lg" style="background-color: var(--card-bg-color);">
                                <h3 class="text-xl font-bold mb-4" style="color: var(--text-color);">×”×ª×¤×œ×’×•×ª ×™×•××™×ª (×‘×©×§×œ×™×)</h3>
                                <div class="h-64 md:h-80 flex justify-center"><canvas id="expenses-chart-today"></canvas></div>
                            </section>
                            <section>
                                <div id="expenses-list-today"></div>
                                <div id="no-expenses-message-today" class="text-center p-10 rounded-2xl shadow-lg hidden" style="background-color: var(--card-bg-color);">
                                    <i class="fas fa-receipt text-4xl text-slate-300 mb-4"></i>
                                    <p class="text-slate-500">××™×Ÿ ×”×•×¦××•×ª ×œ×”×™×•×.</p>
                                </div>
                            </section>
                            <section id="summary-table-section-today" class="p-4 md:p-6 rounded-2xl shadow-lg hidden" style="background-color: var(--card-bg-color);">
                                <h3 class="text-xl font-bold mb-4" style="color: var(--text-color);">×¡×™×›×•× ×”×•×¦××•×ª ×™×•××™</h3>
                                <div id="summary-table-today"></div>
                            </section>
                        </div>
                    </div>

                    <div id="comparison-view-today" class="hidden space-y-6">
                        <section class="p-4 md:p-6 rounded-2xl shadow-lg" style="background-color: var(--card-bg-color);">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                <h3 class="text-xl font-bold" style="color: var(--text-color);">×”×©×•×•××ª ×”×•×¦××•×ª</h3>
                                <select id="comparison-category-filter-today" class="w-full sm:w-auto p-2 border rounded-md bg-slate-50"></select>
                            </div>
                            <div class="h-64 md:h-80 flex justify-center"><canvas id="owner-comparison-chart-today"></canvas></div>
                            <div id="comparison-total-today" class="text-center mt-4 text-lg font-bold"></div>
                        </section>
                    </div>
                </div>

                <!-- "All Expenses" Tab Content -->
                <div id="tab-all" class="tab-content space-y-6">
                    <section id="owner-filters-all" class="mb-6 hidden"></section>
                    
                    <div id="normal-view-all">
                        <div class="space-y-6">
                            <section class="p-3 rounded-2xl shadow-lg" style="background-color: var(--card-bg-color);">
                                <!-- Standard Filters -->
                                <div id="filters" class="flex items-center justify-center gap-2 bg-blue-700 p-1 rounded-full flex-wrap">
                                    <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="week">×©×‘×•×¢</button>
                                    <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="month">×—×•×“×©</button>
                                    <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="2months">×—×•×“×©×™×™×</button>
                                    <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="6months">×—×¦×™ ×©× ×”</button>
                                    <button class="filter-btn active text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="all">×”×›×œ</button>
                                </div>
                                
                                <!-- NEW FEATURE 3: Search Bar -->
                                <div class="mt-3 px-1">
                                    <div class="relative">
                                        <input type="text" id="search-input" placeholder="×—×¤×© ×”×•×¦××” ×œ×¤×™ ×©×, ×§×˜×’×•×¨×™×” ××• ×”×¢×¨×”..." class="w-full p-2 pr-10 border border-slate-200 rounded-lg bg-slate-50 text-sm focus:outline-none focus:border-blue-500">
                                        <i class="fas fa-search absolute right-3 top-2.5 text-slate-400"></i>
                                        <button id="clear-search" class="absolute left-2 top-2 text-slate-400 hover:text-slate-600 hidden"><i class="fas fa-times"></i></button>
                                    </div>
                                </div>

                                <!-- Advanced Filters Toggle -->
                                <div class="text-center mt-2 border-t pt-2 border-slate-100">
                                    <button id="toggle-advanced-filters" class="text-sm font-medium text-blue-600 hover:text-blue-800 transition flex items-center justify-center gap-2 w-full">
                                        <i class="fas fa-filter"></i> ×¡×™× ×•×Ÿ ××ª×§×“× (×ª××¨×™×›×™×/×™×¢×“×™×/×—×¨×™×’×™×) <i class="fas fa-chevron-down text-xs"></i>
                                    </button>
                                </div>

                                <!-- Advanced Filters Panel (Hidden by default) -->
                                <div id="advanced-filters" class="hidden mt-3 p-3 bg-slate-50 rounded-xl border border-slate-200 space-y-3">
                                    <div class="grid grid-cols-2 gap-3">
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-500 mb-1">××ª××¨×™×š</label>
                                            <input type="date" id="filter-start-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                        <div>
                                            <label class="block text-xs font-semibold text-slate-500 mb-1">×¢×“ ×ª××¨×™×š</label>
                                            <input type="date" id="filter-end-date" class="w-full p-2 border border-slate-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-xs font-semibold text-slate-500 mb-1">×¡×™× ×•×Ÿ ×œ×¤×™ ×™×¢×“ ×‘×˜×™×•×œ</label>
                                        <select id="filter-destination-select" class="w-full p-2 border border-slate-300 rounded-lg text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                            <option value="">-- ×›×œ ×”×™×¢×“×™× --</option>
                                        </select>
                                    </div>
                                    
                                    <!-- NEW FEATURE 4: Toggle Include/Exclude Global Filter -->
                                    <div class="flex items-center justify-between bg-white p-2 rounded-lg border border-slate-200">
                                        <span class="text-sm font-medium text-slate-700">×›×œ×•×œ ×”×•×¦××•×ª ×—×¨×™×’×•×ª ×‘×—×™×©×•×‘</span>
                                        <div class="relative inline-block w-10 mr-2 align-middle select-none transition duration-200 ease-in">
                                            <input type="checkbox" name="toggle" id="include-excluded-toggle" class="toggle-checkbox absolute block w-5 h-5 rounded-full bg-white border-4 appearance-none cursor-pointer border-gray-300 right-5 transition-all duration-300"/>
                                            <label for="include-excluded-toggle" class="toggle-label block overflow-hidden h-5 rounded-full bg-gray-300 cursor-pointer transition-colors duration-300"></label>
                                        </div>
                                    </div>

                                    <div class="flex justify-between items-center pt-1">
                                         <span id="active-filter-label" class="text-xs text-orange-600 font-bold hidden">×¡×™× ×•×Ÿ ××•×ª×× ×¤×¢×™×œ</span>
                                         <button id="clear-advanced-filters" class="text-xs text-red-500 hover:text-red-700 font-bold ml-auto">× ×§×” ×¡×™× ×•×Ÿ</button>
                                    </div>
                                </div>
                            </section>

                            <section id="summary-section-all" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></section>
                            <section class="p-4 md:p-6 rounded-2xl shadow-lg" style="background-color: var(--card-bg-color);">
                                <h3 class="text-xl font-bold mb-4" style="color: var(--text-color);">×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×” (×‘×©×§×œ×™×)</h3>
                                <div class="h-64 md:h-80 flex justify-center"><canvas id="expenses-chart-all"></canvas></div>
                            </section>
                            <section>
                                <div id="expenses-list-all"></div>
                                <div id="no-expenses-message-all" class="text-center p-10 rounded-2xl shadow-lg hidden" style="background-color: var(--card-bg-color);">
                                    <i class="fas fa-search-dollar text-4xl text-slate-300 mb-4"></i>
                                    <p class="text-slate-500">×œ× × ××¦××• ×”×•×¦××•×ª ×”×ª×•×××•×ª ×œ×¡×™× ×•×Ÿ.</p>
                                </div>
                            </section>
                            <section id="summary-table-section-all" class="p-4 md:p-6 rounded-2xl shadow-lg hidden" style="background-color: var(--card-bg-color);">
                                <h3 class="text-xl font-bold mb-4" style="color: var(--text-color);">×¡×™×›×•× ×”×•×¦××•×ª ×›×œ×œ×™</h3>
                                <div id="summary-table-all"></div>
                            </section>
                        </div>
                    </div>
                    
                    <div id="comparison-view-all" class="hidden space-y-6">
                        <section class="p-4 md:p-6 rounded-2xl shadow-lg" style="background-color: var(--card-bg-color);">
                            <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                                <h3 class="text-xl font-bold" style="color: var(--text-color);">×”×©×•×•××ª ×”×•×¦××•×ª</h3>
                                <select id="comparison-category-filter-all" class="w-full sm:w-auto p-2 border rounded-md bg-slate-50"></select>
                            </div>
                            <div class="h-64 md:h-80 flex justify-center"><canvas id="owner-comparison-chart-all"></canvas></div>
                            <div id="comparison-total-all" class="text-center mt-4 text-lg font-bold"></div>
                        </section>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- --- SIDEBAR COMPONENTS --- -->
    <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300 opacity-0"></div>

    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform translate-x-full transition-transform duration-300 ease-out border-l border-white/20 flex flex-col">
        <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-l from-cyan-50 to-transparent shrink-0">
          <h2 class="text-2xl font-bold text-slate-800 font-rubik">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
          <button id="close-sidebar-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
            <i class="fas fa-times fa-lg"></i>
          </button>
        </div>

        <nav id="main-menu" class="p-4 space-y-3 overflow-y-auto flex-grow pb-20 scroll-smooth">
          <div class="text-center py-10 text-slate-400">
              <i class="fas fa-circle-notch fa-spin mb-2"></i>
              <p class="text-sm">×˜×•×¢×Ÿ ×ª×¤×¨×™×˜...</p>
          </div>
        </nav>
        
        <div class="p-4 border-t border-slate-100 bg-slate-50 shrink-0 text-center">
            <p class="text-xs text-slate-400">×ª×›× ×•×Ÿ ×˜×™×•×œ ×—×›×</p>
        </div>
    </aside>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import {
          getFirestore, doc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, setDoc,
          enableIndexedDbPersistence 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {
          if (err.code === 'failed-precondition') {
            console.warn("Persistence × ×›×©×œ: ×›× ×¨××” ×™×© ×›××” ×˜××‘×™× ×¤×ª×•×—×™×.");
          } else if (err.code === 'unimplemented') {
            console.warn("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘-Persistence.");
          }
        });

        // --- Global State ---
        let currentUserProfile = null;
        let tripId = null;
        let tripDetails = {};
        let allExpenses = [];
        let tripCategories = [];
        let expensesUnsubscribe = null;
        let categoriesUnsubscribe = null;
        
        let expensesChartAll = null;
        let expensesChartToday = null;
        let ownerComparisonChartAll = null;
        let ownerComparisonChartToday = null;
        
        let activeTab = 'today';
        let activeFilter = 'all';
        let activeOwner = 'all'; 
        let comparisonViewActive = false;
        let activeComparisonCategory = 'all';
        let currentTheme = {};
        let themeUpdateInterval = null;

        let rateCache = {};
        let renderTimeout = null;

        // --- NEW STATES FOR FILTERS ---
        let customDateRange = { start: null, end: null };
        let includeExcluded = false; // "iPhone" logic - default OFF
        let searchQuery = ""; // Text search

        const defaultCategories = ['ğŸ” ××•×›×œ ×•×©×ª×™×”', 'ğŸš— ×ª×—×‘×•×¨×”', 'ğŸ¨ ×œ×™× ×”', 'ğŸ¢ ××˜×¨×§×¦×™×•×ª', 'ğŸ›ï¸ ×§× ×™×•×ª', 'ğŸ“ ××—×¨'];
        const currencies = {
            "ILS": "Israeli New Sheqel (â‚ª)", "USD": "United States Dollar ($)", "EUR": "Euro (â‚¬)", "GBP": "British Pound (Â£)", "AUD": "Australian Dollar (A$)", "BGN": "Bulgarian Lev (Ğ»Ğ²)", "BRL": "Brazilian Real (R$)", "CAD": "Canadian Dollar (C$)", "CHF": "Swiss Franc (CHF)", "CNY": "Chinese Renminbi Yuan (Â¥)", "CZK": "Czech Koruna (KÄ)", "DKK": "Danish Krone (kr)", "HKD": "Hong Kong Dollar (HK$)", "HUF": "Hungarian Forint (Ft)", "IDR": "Indonesian Rupiah (Rp)", "INR": "Indian Rupee (â‚¹)", "ISK": "Icelandic KrÃ³na (kr)", "JPY": "Japanese Yen (Â¥)", "KRW": "South Korean Won (â‚©)", "MXN": "Mexican Peso (MX$)", "MYR": "Malaysian Ringgit (RM)", "NOK": "Norwegian Krone (kr)", "NZD": "New Zealand Dollar (NZ$)", "PHP": "Philippine Peso (â‚±)", "PLN": "Polish ZÅ‚oty (zÅ‚)", "RON": "Romanian Leu (lei)", "SEK": "Swedish Krona (kr)", "SGD": "Singapore Dollar (S$)", "THB": "Thai Baht (à¸¿)", "TRY": "Turkish Lira (â‚º)", "ZAR": "South African Rand (R)"
        };
        const prioritizedCurrencies = ['ILS', 'USD', 'EUR', 'GBP'];

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                console.error("Error: Trip ID not found.");
                return;
            }
            document.getElementById('back-to-dashboard').href = `trip.html?id=${tripId}`;
            populateCurrencyDropdown();
            populateThemes();
            loadTheme();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await fetchUserProfile(user.uid);
                    fetchTripDetails();
                    listenForCategories();
                    listenForExpenses();
                }
            });
            setupEventListeners();
        }

        // --- Data Fetching & Realtime Listeners ---
        async function fetchUserProfile(uid) {
            const userDocRef = doc(db, "users", uid);
            const docSnap = await getDoc(userDocRef);
            currentUserProfile = docSnap.exists() ? { uid, ...docSnap.data() } : { uid, displayName: "××©×ª××©" };
        }

        async function fetchTripDetails() {
            const tripDocRef = doc(db, "trips", tripId);
            const docSnap = await getDoc(tripDocRef);
            if (docSnap.exists()) {
                tripDetails = docSnap.data();
                document.getElementById('trip-title').textContent = tripDetails.name || '× ×™×”×•×œ ×”×•×¦××•×ª';
                buildMenuFromTrip(tripDetails);
                populateDestinationFilter(tripDetails.destinations);
            }
        }

        function listenForCategories() {
            if (categoriesUnsubscribe) categoriesUnsubscribe();
            const categoriesDocRef = doc(db, "trips", tripId, "settings", "categories");
            categoriesUnsubscribe = onSnapshot(categoriesDocRef, (docSnap) => {
                tripCategories = docSnap.exists() ? (docSnap.data().list || []) : [...defaultCategories];
                if (!docSnap.exists()) {
                    setDoc(categoriesDocRef, { list: defaultCategories });
                }
                populateCategoryDropdown();
            });
        }

        function listenForExpenses() {
            if (expensesUnsubscribe) expensesUnsubscribe();
            const expensesColRef = collection(db, "trips", tripId, "expenses");
            expensesUnsubscribe = onSnapshot(expensesColRef, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                
                if (allExpenses.length === 0 && !snapshot.metadata.fromCache) {
                    document.getElementById('main-content').classList.add('hidden');
                    document.getElementById('onboarding-screen').classList.remove('hidden');
                    hideLoadingOverlay();
                } else {
                    document.getElementById('main-content').classList.remove('hidden');
                    document.getElementById('onboarding-screen').classList.add('hidden');
                    allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                    scheduleRender();
                }
            });
        }

        function hideLoadingOverlay() {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (!loadingOverlay.classList.contains('opacity-0')) {
                loadingOverlay.classList.add('opacity-0');
                setTimeout(() => loadingOverlay.style.display = 'none', 500);
            }
        }

        // --- Central Render Function ---
        function scheduleRender() {
            if (renderTimeout) clearTimeout(renderTimeout);
            renderTimeout = setTimeout(async () => {
                await prefetchAllCurrencyRates(allExpenses);
                await render();
                hideLoadingOverlay();
            }, 200);
        }

        async function render() {
            if (allExpenses.length === 0) return; 
            
            renderOwnerFilters();
            let filteredExpenses = getFilteredExpenses();

            // Calculate Dashboard Stats based on filtered expenses
            await updateDashboardStats(filteredExpenses);

            const normalView = document.getElementById(`normal-view-${activeTab}`);
            const comparisonView = document.getElementById(`comparison-view-${activeTab}`);

            if (comparisonViewActive) {
                normalView.style.display = 'none';
                comparisonView.style.display = 'block';
                await renderComparisonView(filteredExpenses, activeTab);
            } else {
                normalView.style.display = 'block';
                comparisonView.style.display = 'none';
                await renderNormalView(filteredExpenses, activeTab);
            }
        }
        
        async function renderNormalView(expenses, tabId) {
            renderExpenseList(expenses, tabId);
            renderSummary(expenses, tabId);
            await renderSummaryTable(expenses, tabId);

            if (tabId === 'today') {
                expensesChartToday = await updateChartGeneric(expenses, 'expenses-chart-today', expensesChartToday);
            } else {
                expensesChartAll = await updateChartGeneric(expenses, 'expenses-chart-all', expensesChartAll);
            }
        }

        async function renderComparisonView(expenses, tabId) {
             populateComparisonCategoryFilter(expenses, tabId);
             let categoryFilteredExpenses = expenses;
             if(activeComparisonCategory !== 'all') {
                 categoryFilteredExpenses = expenses.filter(exp => exp.category === activeComparisonCategory);
             }

             if (tabId === 'today') {
                 ownerComparisonChartToday = await updateOwnerComparisonChart(categoryFilteredExpenses, 'owner-comparison-chart-today', ownerComparisonChartToday);
             } else {
                 ownerComparisonChartAll = await updateOwnerComparisonChart(categoryFilteredExpenses, 'owner-comparison-chart-all', ownerComparisonChartAll);
             }
        }

        // --- NEW: Dashboard Statistics ---
        async function updateDashboardStats(expenses) {
            const dailyAvgEl = document.getElementById('stat-daily-avg');
            const maxExpEl = document.getElementById('stat-max-expense');
            const totalItemsEl = document.getElementById('stat-total-items');

            // Filter out excluded if toggle is off
            const statsExpenses = includeExcluded ? expenses : expenses.filter(e => !e.isExcluded);

            if (statsExpenses.length === 0) {
                dailyAvgEl.textContent = 'â‚ª0';
                maxExpEl.textContent = 'â‚ª0';
                totalItemsEl.textContent = '0';
                return;
            }

            // 1. Total Items
            totalItemsEl.textContent = statsExpenses.length;

            // 2. Max Expense
            let maxAmountILS = 0;
            for (const exp of statsExpenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                if (amountInILS > maxAmountILS) maxAmountILS = amountInILS;
            }
            maxExpEl.textContent = `â‚ª${Math.round(maxAmountILS).toLocaleString()}`;

            // 3. Daily Average
            // Find unique dates
            const uniqueDates = new Set(statsExpenses.map(e => e.date));
            const daysCount = uniqueDates.size || 1;
            
            let totalSum = 0;
            for (const exp of statsExpenses) {
                totalSum += await convertToILS(exp.amount, exp.currency);
            }
            
            const avg = totalSum / daysCount;
            dailyAvgEl.textContent = `â‚ª${Math.round(avg).toLocaleString()}`;
        }

        // --- Filtering Logic (UPDATED) ---
        function getFilteredExpenses() {
            const now = new Date();
            const todayString = now.toISOString().split('T')[0];
            
            let resultExpenses = allExpenses;

            // 1. Tab Filtering (Today vs All)
            if (activeTab === 'today') {
                resultExpenses = resultExpenses.filter(exp => exp.date === todayString);
            } else {
                // Time Filters (Week, Month...) OR Custom Date Range
                if (customDateRange.start || customDateRange.end) {
                    document.querySelectorAll('.filter-btn').forEach(f => f.classList.remove('active'));
                    document.getElementById('active-filter-label').classList.remove('hidden');

                    resultExpenses = resultExpenses.filter(exp => {
                        const expDate = exp.date; // YYYY-MM-DD string
                        let isValid = true;
                        if (customDateRange.start && expDate < customDateRange.start) isValid = false;
                        if (customDateRange.end && expDate > customDateRange.end) isValid = false;
                        return isValid;
                    });
                } else {
                    document.getElementById('active-filter-label').classList.add('hidden');
                    let startDate = new Date(0);
                    switch (activeFilter) {
                        case 'week': startDate = new Date(new Date().setDate(now.getDate() - 7)); break;
                        case 'month': startDate = new Date(new Date().setMonth(now.getMonth() - 1)); break;
                        case '2months': startDate = new Date(new Date().setMonth(now.getMonth() - 2)); break;
                        case '6months': startDate = new Date(new Date().setMonth(now.getMonth() - 6)); break;
                        default: break; 
                    }
                    if (activeFilter !== 'all') {
                        resultExpenses = resultExpenses.filter(exp => new Date(exp.date) >= startDate);
                    }
                }
            }

            // 2. Owner Filter
            if (!comparisonViewActive && activeOwner !== 'all') {
                resultExpenses = resultExpenses.filter(exp => exp.ownerName === activeOwner);
            }

            // 3. Text Search (NEW)
            if (searchQuery) {
                const lowerQ = searchQuery.toLowerCase();
                resultExpenses = resultExpenses.filter(exp => 
                    (exp.notes && exp.notes.toLowerCase().includes(lowerQ)) ||
                    (exp.category && exp.category.toLowerCase().includes(lowerQ)) ||
                    (exp.ownerName && exp.ownerName.toLowerCase().includes(lowerQ))
                );
            }

            return resultExpenses;
        }

        // --- UI Rendering ---
        function renderExpenseList(expenses, tabId) {
            const listContainer = document.getElementById(`expenses-list-${tabId}`);
            const noItemsMsg = document.getElementById(`no-expenses-message-${tabId}`);
            listContainer.innerHTML = '';

            // Even if we filter out excluded for SUM, we might want to SHOW them visually but disabled?
            // Decision: If toggle "Include Excluded" is OFF, show them grayed out but don't count.
            // But if text search is active, show matches regardless.
            
            if (expenses.length === 0) {
                noItemsMsg.classList.remove('hidden');
                listContainer.parentElement.classList.add('hidden');
                return;
            }

            noItemsMsg.classList.add('hidden');
            listContainer.parentElement.classList.remove('hidden');

            listContainer.innerHTML = `
                <div class="expense-cards-view"></div>
                <div class="expense-table-view"></div>
            `;
            
            const cardsContainer = listContainer.querySelector('.expense-cards-view');
            const tableContainer = listContainer.querySelector('.expense-table-view');

            renderExpenseTable(expenses, tableContainer, tabId);
            if (tabId === 'all') {
                renderCollapsibleCategories(expenses, cardsContainer);
            } else {
                renderSimpleExpenseList(expenses, cardsContainer);
            }
        }

        function renderSimpleExpenseList(expenses, container) {
            expenses.forEach((exp, index) => {
                const card = createExpenseCard(exp, `conv-today-${index}`);
                container.appendChild(card);
                if (exp.currency !== 'ILS') {
                    displayConvertedAmount(`conv-today-${index}`, exp.amount, exp.currency);
                } else {
                    const el = document.getElementById(`conv-today-${index}`);
                    if (el) el.style.display = 'none';
                }
            });
        }

        function renderCollapsibleCategories(expenses, container) {
            const groupedExpenses = expenses.reduce((acc, exp) => {
                (acc[exp.category] = acc[exp.category] || []).push(exp);
                return acc;
            }, {});

            Object.entries(groupedExpenses).forEach(([category, items]) => {
                const categoryWrapper = document.createElement('div');
                categoryWrapper.className = 'rounded-2xl shadow-lg overflow-hidden';
                categoryWrapper.style.backgroundColor = 'var(--card-bg-color)';

                const header = document.createElement('button');
                header.className = 'category-header w-full text-right p-4 flex justify-between items-center hover:bg-slate-50/50 transition';
                header.innerHTML = `
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-lg" style="color: var(--text-color);">${category}</span>
                        <span class="text-sm text-slate-500">(${items.length} ×”×•×¦××•×ª)</span>
                    </div>
                    <i class="fas fa-chevron-down text-slate-400 transition-transform"></i>
                `;

                const content = document.createElement('div');
                content.className = 'category-content border-t border-slate-100';
                
                const innerList = document.createElement('div');
                innerList.className = 'space-y-3';
                content.appendChild(innerList);

                items.forEach((exp, index) => {
                    const uniqueId = `conv-all-${category.replace(/\s/g, '')}-${index}`;
                    const card = createExpenseCard(exp, uniqueId);
                    card.classList.remove('shadow-md');
                    card.classList.add('shadow-none', 'border-b', 'last:border-b-0', 'rounded-none', 'p-3');
                    card.style.backgroundColor = 'transparent';
                    innerList.appendChild(card);
                    if (exp.currency !== 'ILS') {
                        displayConvertedAmount(uniqueId, exp.amount, exp.currency);
                    } else {
                         const el = document.getElementById(uniqueId);
                         if (el) el.style.display = 'none';
                    }
                });

                categoryWrapper.appendChild(header);
                categoryWrapper.appendChild(content);
                container.appendChild(categoryWrapper);
            });
        }
        
        function renderExpenseTable(expenses, container, tabId) {
            container.innerHTML = '';
            const wrapper = document.createElement('div');
            wrapper.className = 'expense-table-wrapper rounded-2xl shadow-lg';
            wrapper.style.backgroundColor = 'var(--card-bg-color)';

            const table = document.createElement('table');
            table.className = 'expense-table';
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>×ª××¨×™×š</th>
                        <th>×©×</th>
                        <th>×§×˜×’×•×¨×™×”</th>
                        <th>×¤×™×¨×•×˜</th>
                        <th>×¡×›×•×</th>
                        <th>×¡×›×•× (â‚ª)</th>
                        <th>×¤×¢×•×œ×•×ª</th>
                    </tr>
                </thead>
            `;
            const tbody = document.createElement('tbody');
            
            expenses.forEach((exp, index) => {
                const tr = document.createElement('tr');
                tr.className = 'expense-card-clickable';
                if (exp.isExcluded && !includeExcluded) {
                    tr.classList.add('expense-excluded');
                }
                tr.dataset.id = exp.id;
                const isOwner = currentUserProfile && exp.ownerId === currentUserProfile.uid;
                const uniqueId = `conv-table-${tabId}-${index}`;

                tr.innerHTML = `
                    <td>${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                    <td>${exp.ownerName || '×œ× ×™×“×•×¢'}</td>
                    <td>${exp.category}</td>
                    <td>${exp.notes || '---'}</td>
                    <td class="font-mono">${exp.amount.toLocaleString('he-IL', { minimumFractionDigits: 2 })} ${exp.currency}</td>
                    <td id="${uniqueId}" class="font-mono"></td>
                    <td>
                        ${isOwner ? `<div class="flex justify-end gap-3">
                            <button class="edit-btn text-slate-400 hover:text-blue-600" data-id="${exp.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn text-slate-400 hover:text-red-600" data-id="${exp.id}"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </td>
                `;
                tbody.appendChild(tr);

                if (exp.currency !== 'ILS') {
                    displayConvertedAmount(uniqueId, exp.amount, exp.currency, true);
                } else {
                    const el = document.getElementById(uniqueId);
                    if (el) el.textContent = exp.amount.toLocaleString('he-IL', { minimumFractionDigits: 2 });
                }
            });

            table.appendChild(tbody);
            wrapper.appendChild(table);
            container.appendChild(wrapper);
        }

        function createExpenseCard(exp, uniqueId) {
            const card = document.createElement('div');
            card.className = 'p-4 rounded-2xl shadow-md flex items-center gap-4 expense-card-clickable relative group';
            // NEW: Add styles if excluded
            if (exp.isExcluded && !includeExcluded) {
                card.classList.add('expense-excluded');
            }

            card.style.backgroundColor = 'var(--card-bg-color)';
            card.dataset.id = exp.id;
            const isOwner = currentUserProfile && exp.ownerId === currentUserProfile.uid;
            
            card.innerHTML = `
                <div class="flex-shrink-0 h-12 w-12 bg-slate-100 rounded-full flex items-center justify-center text-2xl">${exp.category.match(/(\p{Emoji})/u)?.[0] || 'ğŸ“'}</div>
                <div class="flex-grow min-w-0">
                    <div class="flex items-center gap-2">
                         <p class="font-bold truncate" style="color: var(--text-color);">${exp.notes || '×”×•×¦××”'}</p>
                         ${exp.isExcluded ? '<i class="fas fa-eye-slash text-xs text-gray-400" title="×”×•×¦××” ×—×¨×™×’×”"></i>' : ''}
                    </div>
                    <p class="text-sm text-slate-500"><span class="font-semibold">${exp.ownerName || '×œ× ×™×“×•×¢'}</span> â€¢ ${new Date(exp.date).toLocaleDateString('he-IL')}</p>
                </div>
                <div class="text-right flex-shrink-0">
                    <p class="font-bold text-lg text-red-600 whitespace-nowrap">
                        ${exp.amount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${exp.currency}
                    </p>
                    <p id="${uniqueId}" class="text-slate-500 font-normal text-sm text-right"></p>
                    
                    <div class="flex justify-end gap-2 mt-1 opacity-100 sm:opacity-0 sm:group-hover:opacity-100 transition-opacity">
                        <!-- Toggle Exclusion Shortcut -->
                        <button class="toggle-exclude-btn text-slate-400 hover:text-orange-500" data-id="${exp.id}" data-excluded="${exp.isExcluded || false}" title="${exp.isExcluded ? '×‘×˜×œ ×”×—×¨×’×”' : '×”×—×¨×’ ×”×•×¦××”'}">
                            <i class="fas ${exp.isExcluded ? 'fa-eye' : 'fa-eye-slash'}"></i>
                        </button>
                        ${isOwner ? `
                        <button class="edit-btn text-slate-400 hover:text-blue-600" data-id="${exp.id}"><i class="fas fa-pencil-alt"></i></button>
                        <button class="delete-btn text-slate-400 hover:text-red-600" data-id="${exp.id}"><i class="fas fa-trash"></i></button>
                        ` : ''}
                    </div>
                </div>
            `;
            return card;
        }

        function renderSummary(expenses, containerId) {
            const summaryContainer = document.getElementById(`summary-section-${containerId}`);
            
            // FILTER: Don't sum up excluded items unless toggle is ON
            const calcExpenses = includeExcluded ? expenses : expenses.filter(e => !e.isExcluded);

            const summary = calcExpenses.reduce((acc, exp) => {
                acc[exp.currency] = (acc[exp.currency] || 0) + Number(exp.amount);
                return acc;
            }, {});

            summaryContainer.innerHTML = '';
            if (Object.keys(summary).length === 0) {
                summaryContainer.innerHTML = `<div class="p-6 rounded-2xl shadow-lg text-center col-span-full" style="background-color: var(--card-bg-color);"><p class="text-slate-500">××™×Ÿ × ×ª×•× ×™× ×œ×—×™×©×•×‘ (×‘×“×•×§ ××¡× × ×™×)</p></div>`;
                return;
            }
            for (const currency in summary) {
                const card = document.createElement('div');
                card.className = 'p-4 rounded-2xl shadow-lg text-center';
                card.style.backgroundColor = 'var(--card-bg-color)';
                card.innerHTML = `
                    <h3 class="text-slate-500 font-semibold text-sm">×¡×”"×› (${currency})</h3>
                    <p class="text-2xl font-bold mt-1" style="color: var(--accent-color);">${summary[currency].toLocaleString('he-IL', { minimumFractionDigits: 2 })}</p>
                `;
                summaryContainer.appendChild(card);
            }
        }

        async function updateChartGeneric(expenses, canvasId, chartInstance) {
            const chartCanvas = document.getElementById(canvasId);
            if (!chartCanvas) return chartInstance;
            const parentSection = chartCanvas.closest('section');

            // FILTER Chart Data
            const calcExpenses = includeExcluded ? expenses : expenses.filter(e => !e.isExcluded);

            if (calcExpenses.length === 0) {
                if (chartInstance) chartInstance.destroy();
                parentSection.style.display = 'none';
                return null;
            }
            parentSection.style.display = 'block';

            const categoryData = {};
            for (const exp of calcExpenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                categoryData[exp.category] = (categoryData[exp.category] || 0) + amountInILS;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const chartColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#eab308', '#64748b', '#ec4899', '#10b981', '#f59e0b'];

            const chartConfig = {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: chartColors, borderColor: currentTheme.cardBgColor || '#fff', borderWidth: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: "'Assistant', sans-serif" }, color: currentTheme.textColor || '#334155', boxWidth: 20, padding: 20 } },
                        tooltip: { callbacks: { label: (context) => ` ${context.label}: ${new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS' }).format(context.parsed)}` } }
                    }
                }
            };
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.options.plugins.legend.labels.color = currentTheme.textColor;
                chartInstance.data.datasets[0].borderColor = currentTheme.cardBgColor;
                chartInstance.update();
                return chartInstance;
            } else {
                return new Chart(chartCanvas, chartConfig);
            }
        }

        function renderOwnerFilters() {
            const uniqueOwners = [...new Set(allExpenses.map(exp => exp.ownerName).filter(Boolean))];
            const containers = [document.getElementById('owner-filters-today'), document.getElementById('owner-filters-all')];
            
            containers.forEach(container => {
                if (uniqueOwners.length <= 1) {
                    container.innerHTML = '';
                    container.classList.add('hidden');
                    return;
                }
                container.classList.remove('hidden');
                let buttonsHTML = `<button class="owner-filter-btn font-semibold px-4 py-2 rounded-full transition ${activeOwner === 'all' && !comparisonViewActive ? 'active' : ''}" style="background-color: ${activeOwner === 'all' && !comparisonViewActive ? '' : 'var(--card-bg-color)'}" data-owner="all">×”×›×œ</button>`;
                uniqueOwners.forEach(owner => {
                    buttonsHTML += `<button class="owner-filter-btn font-semibold px-4 py-2 rounded-full transition ${activeOwner === owner && !comparisonViewActive ? 'active' : ''}" style="background-color: ${activeOwner === owner && !comparisonViewActive ? '' : 'var(--card-bg-color)'}" data-owner="${owner}">${owner}</button>`;
                });
                buttonsHTML += `<button class="owner-filter-btn font-semibold px-4 py-2 rounded-full transition ${comparisonViewActive ? 'active' : ''}" style="background-color: ${comparisonViewActive ? '' : 'var(--card-bg-color)'}" data-owner="compare"><i class="fas fa-chart-pie mr-2"></i>×”×©×•×•×”</button>`;
                container.innerHTML = `<div class="flex items-center justify-center gap-2 flex-wrap p-1 bg-slate-200 rounded-full">${buttonsHTML}</div>`;
            });
        }

        async function renderSummaryTable(expenses, containerId) {
            const tableContainer = document.getElementById(`summary-table-${containerId}`);
            const sectionContainer = document.getElementById(`summary-table-section-${containerId}`);

            // Filter
            const calcExpenses = includeExcluded ? expenses : expenses.filter(e => !e.isExcluded);

            if (calcExpenses.length === 0) {
                sectionContainer.classList.add('hidden');
                return;
            }
            sectionContainer.classList.remove('hidden');

            const categoryTotals = {};
            for (const exp of calcExpenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                categoryTotals[exp.category] = (categoryTotals[exp.category] || 0) + amountInILS;
            }

            const sortedCategories = Object.entries(categoryTotals).sort(([, a], [, b]) => b - a);
            
            let tableHTML = `<div class="flow-root"><div class="-mx-4 -my-2 overflow-x-auto sm:-mx-6 lg:-mx-8"><div class="inline-block min-w-full py-2 align-middle sm:px-6 lg:px-8"><table class="min-w-full divide-y divide-slate-200">`;
            tableHTML += `<thead><tr>
                <th scope="col" class="py-3.5 pl-4 pr-3 text-right text-sm font-semibold sm:pl-0" style="color: var(--text-color);">×§×˜×’×•×¨×™×”</th>
                <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold" style="color: var(--text-color);">×¡×›×•× (â‚ª)</th>
            </tr></thead>`;
            tableHTML += `<tbody class="divide-y divide-slate-100">`;
            for (const [category, total] of sortedCategories) {
                tableHTML += `<tr>
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium sm:pl-0" style="color: var(--text-color);">${category}</td>
                    <td class="whitespace-nowrap px-3 py-4 text-sm text-slate-500 text-left font-mono">${total.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                </tr>`;
            }
            tableHTML += `</tbody></table></div></div></div>`;
            tableContainer.innerHTML = tableHTML;
        }

        async function updateOwnerComparisonChart(expenses, canvasId, chartInstance) {
            const chartCanvas = document.getElementById(canvasId);
            if (!chartCanvas) return chartInstance;
            const parentSection = chartCanvas.closest('section');
            const totalContainer = document.getElementById(`comparison-total-${activeTab}`);

            // Filter
            const calcExpenses = includeExcluded ? expenses : expenses.filter(e => !e.isExcluded);

            if (calcExpenses.length === 0) {
                if (chartInstance) chartInstance.destroy();
                parentSection.style.display = 'none';
                return null;
            }
            parentSection.style.display = 'block';

            const ownerTotals = {};
            let grandTotal = 0;
            for (const exp of calcExpenses) {
                const amountInILS = await convertToILS(exp.amount, exp.currency);
                ownerTotals[exp.ownerName] = (ownerTotals[exp.ownerName] || 0) + amountInILS;
                grandTotal += amountInILS;
            }

            totalContainer.textContent = `×¡×”"×›: ${grandTotal.toLocaleString('he-IL', { style: 'currency', currency: 'ILS' })}`;

            const labels = Object.keys(ownerTotals);
            const data = Object.values(ownerTotals);
            const chartColors = ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#eab308', '#64748b', '#ec4899', '#10b981', '#f59e0b'];
            
            const chartConfig = {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: chartColors, borderColor: currentTheme.cardBgColor || '#fff', borderWidth: 4 }] },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '60%',
                    plugins: {
                        legend: { position: 'right', labels: { font: { family: "'Assistant', sans-serif" }, color: currentTheme.textColor || '#334155', boxWidth: 20, padding: 20 } },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const label = context.label || '';
                                    const value = context.parsed || 0;
                                    const percentage = grandTotal > 0 ? ((value / grandTotal) * 100).toFixed(1) : 0;
                                    return ` ${label}: ${new Intl.NumberFormat('he-IL', { style: 'currency', currency: 'ILS' }).format(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            };
            
            if (chartInstance) {
                chartInstance.data.labels = labels;
                chartInstance.data.datasets[0].data = data;
                chartInstance.options.plugins.legend.labels.color = currentTheme.textColor;
                chartInstance.data.datasets[0].borderColor = currentTheme.cardBgColor;
                chartInstance.update();
                return chartInstance;
            } else {
                return new Chart(chartCanvas, chartConfig);
            }
        }
        
        function populateComparisonCategoryFilter(expenses, tabId) {
            const select = document.getElementById(`comparison-category-filter-${tabId}`);
            const uniqueCategories = [...new Set(expenses.map(exp => exp.category))];
            
            let optionsHTML = `<option value="all">×›×œ ×”×§×˜×’×•×¨×™×•×ª</option>`;
            uniqueCategories.forEach(cat => {
                optionsHTML += `<option value="${cat}" ${activeComparisonCategory === cat ? 'selected' : ''}>${cat}</option>`;
            });
            select.innerHTML = optionsHTML;
        }

        // --- NEW: Populate Destination Filter ---
        function populateDestinationFilter(destinations) {
            const select = document.getElementById('filter-destination-select');
            if (!destinations || destinations.length === 0) {
                select.innerHTML = '<option value="">×œ× × ××¦××• ×™×¢×“×™×</option>';
                select.disabled = true;
                return;
            }

            let html = '<option value="">-- ×›×œ ×”×™×¢×“×™× --</option>';
            destinations.forEach((dest, index) => {
                if (dest.dates) {
                    html += `<option value="${index}" data-dates="${dest.dates}">${dest.nameHe || dest.name}</option>`;
                }
            });
            select.innerHTML = html;

            select.addEventListener('change', (e) => {
                const selectedOption = e.target.selectedOptions[0];
                const dateRange = selectedOption.dataset.dates;
                
                if (dateRange) {
                    const [startStr, endStr] = dateRange.split(' - ');
                    const startDate = parseDDMMYYYY(startStr);
                    const endDate = parseDDMMYYYY(endStr);
                    
                    if (startDate && endDate) {
                        const format = (d) => {
                             const year = d.getFullYear();
                             const month = String(d.getMonth() + 1).padStart(2, '0');
                             const day = String(d.getDate()).padStart(2, '0');
                             return `${year}-${month}-${day}`;
                        };

                        document.getElementById('filter-start-date').value = format(startDate);
                        document.getElementById('filter-end-date').value = format(endDate);
                        
                        customDateRange.start = format(startDate);
                        customDateRange.end = format(endDate);
                    }
                } else {
                    document.getElementById('filter-start-date').value = '';
                    document.getElementById('filter-end-date').value = '';
                    customDateRange.start = null;
                    customDateRange.end = null;
                }
                scheduleRender();
            });
        }

        // --- Currency Conversion API & Helpers ---
        async function prefetchAllCurrencyRates(expenses) {
            const uniqueCurrencies = [...new Set(expenses.map(e => e.currency))];
            const promises = uniqueCurrencies
                .filter(c => c !== 'ILS' && !rateCache[`${c}-ILS`])
                .map(c => getRate(c, 'ILS'));
            await Promise.all(promises);
        }

        async function getRate(from, to) {
            if (from === to) return 1;
            const cacheKey = `${from}-${to}`;
            if (rateCache[cacheKey]) return rateCache[cacheKey];
            try {
                const res = await fetch(`https://api.frankfurter.app/latest?from=${from}&to=${to}`);
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const rate = data.rates[to];
                if (typeof rate !== 'number') return 1;
                rateCache[cacheKey] = rate;
                return rate;
            } catch (error) {
                console.error('Failed to fetch currency rate:', error);
                return 1; // Fallback rate
            }
        }
        
        async function convertToILS(amount, currency) {
            if (currency === 'ILS') return amount;
            const rate = rateCache[`${currency}-ILS`] || await getRate(currency, 'ILS');
            return amount * rate;
        }

        async function displayConvertedAmount(elementId, amount, from, isTable = false) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = `<span class="loader"></span>`;
            const convertedAmount = await convertToILS(amount, from);
            const formattedAmount = convertedAmount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
            el.textContent = isTable ? formattedAmount : `(â‚ª${formattedAmount})`;
        }

        // --- Dropdown Population ---
        function populateCurrencyDropdown() {
            const expenseCurrency = document.getElementById('expense-currency');
            const fragment = document.createDocumentFragment();
            prioritizedCurrencies.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} â€” ${currencies[code]}`;
                fragment.appendChild(opt);
            });
            const otherCurrencies = Object.keys(currencies).filter(c => !prioritizedCurrencies.includes(c)).sort();
            otherCurrencies.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} â€” ${currencies[code]}`;
                fragment.appendChild(opt);
            });
            expenseCurrency.appendChild(fragment);
        }

        function populateCategoryDropdown() {
            const expenseCategory = document.getElementById('expense-category');
            expenseCategory.innerHTML = tripCategories.map(cat => `<option value="${cat}">${cat}</option>`).join('') + '<option value="add_new_category">â• ×”×•×¡×£ ×—×“×©×”...</option>';
        }

        // --- Modal & Form Logic ---
        function openModal(modalId) { document.getElementById(modalId)?.classList.remove('modal-hidden'); }
        function closeModal(modalId) { document.getElementById(modalId)?.classList.add('modal-hidden'); }

        function openExpenseModal(expense = null) {
            const expenseForm = document.getElementById('expense-form');
            expenseForm.reset();
            document.getElementById('new-category-wrapper').classList.add('hidden');
            document.getElementById('delete-category-btn').classList.add('hidden');

            if (expense) {
                document.getElementById('modal-title').textContent = '×¢×¨×™×›×ª ×”×•×¦××”';
                const expenseDocRef = doc(db, "trips", tripId, "expenses", expense.id);
                getDoc(expenseDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        document.getElementById('expense-id').value = expense.id;
                        document.getElementById('expense-owner-name').value = data.ownerName || '';
                        document.getElementById('expense-amount').value = data.amount;
                        document.getElementById('expense-currency').value = data.currency;
                        document.getElementById('expense-category').value = data.category;
                        document.getElementById('expense-date').value = data.date;
                        document.getElementById('expense-notes').value = data.notes || '';
                        document.getElementById('expense-is-excluded').checked = data.isExcluded || false; // Set exclusion status
                    }
                });
            } else {
                document.getElementById('modal-title').textContent = '×”×•×¡×¤×ª ×”×•×¦××” ×—×“×©×”';
                document.getElementById('expense-id').value = '';
                const lastOwner = localStorage.getItem('lastExpenseOwner');
                document.getElementById('expense-owner-name').value = lastOwner || (currentUserProfile ? currentUserProfile.displayName : '');
                document.getElementById('expense-date').valueAsDate = new Date();
                document.getElementById('expense-is-excluded').checked = false; // Default false
            }
            openModal('expense-modal');
        }
        
        async function openExpenseDetailsModal(expenseId) {
            const expense = allExpenses.find(exp => exp.id === expenseId);
            if (!expense) return;

            const contentEl = document.getElementById('expense-details-content');
            
            const detailsHTML = `
                <div class="grid grid-cols-3 gap-x-4 gap-y-3">
                    <p class="text-sm text-slate-500 col-span-1">××•×¦×™×:</p>
                    <p class="font-semibold col-span-2">${expense.ownerName || '×œ× ×™×“×•×¢'}</p>

                    <p class="text-sm text-slate-500 col-span-1">×§×˜×’×•×¨×™×”:</p>
                    <p class="font-semibold col-span-2">${expense.category}</p>

                    <p class="text-sm text-slate-500 col-span-1">×¤×™×¨×•×˜:</p>
                    <p class="font-semibold col-span-2">${expense.notes || '---'}</p>

                    <p class="text-sm text-slate-500 col-span-1">×ª××¨×™×š:</p>
                    <p class="font-semibold col-span-2">${new Date(expense.date).toLocaleDateString('he-IL')}</p>
                    
                    ${expense.isExcluded ? '<div class="col-span-3 bg-red-50 text-red-600 p-2 rounded text-center text-sm font-bold border border-red-100">ğŸš« ×”×•×¦××” ×–×• ×—×¨×™×’×” ×•×œ× × ×¡×¤×¨×ª ×‘×¡×™×›×•×</div>' : ''}

                    <p class="text-sm text-slate-500 col-span-1">×©×¢×ª ×”×•×¡×¤×”:</p>
                    <p class="font-semibold col-span-2">${expense.createdAt && expense.createdAt.toDate ? expense.createdAt.toDate().toLocaleTimeString('he-IL') : '×œ× ×™×“×•×¢'}</p>
                </div>
                <div class="pt-3 border-t mt-3 space-y-3">
                    <div class="grid grid-cols-3 gap-x-4">
                        <p class="text-sm text-slate-500 col-span-1">×¡×›×•× ××§×•×¨×™:</p>
                        <p class="font-bold text-red-600 col-span-2">${expense.amount.toLocaleString('he-IL', {minimumFractionDigits: 2, maximumFractionDigits: 2})} ${expense.currency}</p>
                    </div>
                    <div id="details-conversion-row" class="grid grid-cols-3 gap-x-4">
                        <p class="text-sm text-slate-500 col-span-1">×¡×›×•× ×‘×©×§×œ×™×:</p>
                        <p class="font-bold col-span-2" id="details-converted-amount" style="color: var(--accent-color);"><span class="loader"></span></p>
                    </div>
                </div>
            `;
            contentEl.innerHTML = detailsHTML;

            if (expense.currency === 'ILS') {
                document.getElementById('details-conversion-row').style.display = 'none';
            } else {
                document.getElementById('details-conversion-row').style.display = 'grid';
                const convertedAmount = await convertToILS(expense.amount, expense.currency);
                document.getElementById('details-converted-amount').textContent = `â‚ª${convertedAmount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            }

            openModal('expense-details-modal');
        }

        // --- Settings Modal Logic ---
        async function openSettingsModal() {
            if (!currentUserProfile) return;
            document.getElementById('trip-id-input').value = tripId;
            const userDocRef = doc(db, "users", currentUserProfile.uid);
            const userDocSnap = await getDoc(userDocRef);
            const apiKey = userDocSnap.exists() ? userDocSnap.data().settings?.apiKey : null;
            document.getElementById('api-key-input').value = apiKey || '×œ×—×¥ ×¢×œ ×”×›×¤×ª×•×¨ ×œ×™×¦×™×¨×”...';
            openModal('settings-modal');
        }

        async function generateAndSaveApiKey() {
            if (!currentUserProfile) return;
            const newKey = `sk_${crypto.randomUUID()}`;
            document.getElementById('api-key-input').value = newKey;
            const userDocRef = doc(db, "users", currentUserProfile.uid);
            try {
                await setDoc(userDocRef, { settings: { apiKey: newKey } }, { merge: true });
            } catch (error) {
                console.error("Error saving API key:", error);
            }
        }

        function copyToClipboard(inputElement, buttonElement) {
            if (!inputElement.value || inputElement.value.startsWith('×œ×—×¥')) return;
            inputElement.select();
            inputElement.setSelectionRange(0, 99999);
            try {
                document.execCommand('copy');
                const originalIcon = buttonElement.innerHTML;
                buttonElement.innerHTML = '<i class="fas fa-check text-green-500"></i>';
                setTimeout(() => { buttonElement.innerHTML = originalIcon; }, 1500);
            } catch (err) { console.error('Failed to copy to clipboard'); }
        }

        async function handleExpenseFormSubmit(e) {
            e.preventDefault();
            const expenseCategory = document.getElementById('expense-category');
            let category = expenseCategory.value;

            if (category === 'add_new_category') {
                const newCategoryName = document.getElementById('new-category-name').value.trim();
                if (newCategoryName && !tripCategories.includes(newCategoryName)) {
                    const updatedCategories = [...tripCategories, newCategoryName];
                    await setDoc(doc(db, "trips", tripId, "settings", "categories"), { list: updatedCategories });
                    category = newCategoryName;
                } else { return; }
            }

            const ownerName = document.getElementById('expense-owner-name').value.trim();
            const expenseData = {
                ownerName: ownerName,
                amount: parseFloat(document.getElementById('expense-amount').value),
                currency: document.getElementById('expense-currency').value,
                category: category,
                date: document.getElementById('expense-date').value,
                notes: document.getElementById('expense-notes').value.trim(),
                isExcluded: document.getElementById('expense-is-excluded').checked, // NEW FIELD
                ownerId: currentUserProfile.uid,
            };

            try {
                const id = document.getElementById('expense-id').value;
                if (id) {
                    await updateDoc(doc(db, "trips", tripId, "expenses", id), expenseData);
                } else {
                    expenseData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "trips", tripId, "expenses"), expenseData);
                }
                localStorage.setItem('lastExpenseOwner', ownerName);
                closeModal('expense-modal');
            } catch (error) { console.error("Error saving expense:", error); }
        }
        
        async function handleDeleteCategory() {
            const categoryToDelete = document.getElementById('expense-category').value;
            if (!categoryToDelete || defaultCategories.includes(categoryToDelete)) return;
            if (confirm(`×”×× ×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×” "${categoryToDelete}"?`)) {
                const updatedCategories = tripCategories.filter(c => c !== categoryToDelete);
                await setDoc(doc(db, "trips", tripId, "settings", "categories"), { list: updatedCategories });
            }
        }
        
        async function handleDeleteExpense(id) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×•×¦××” ×–×•?')) {
                await deleteDoc(doc(db, "trips", tripId, "expenses", id));
            }
        }
        
        // NEW: Toggle Exclude Directly
        async function toggleExpenseExclusion(id, currentStatus) {
            try {
                await updateDoc(doc(db, "trips", tripId, "expenses", id), {
                    isExcluded: !currentStatus
                });
            } catch(e) { console.error(e); }
        }

        // --- Theme Logic ---
        const themes = {
            dynamic: [
                { name: 'autoDayNight', displayName: 'â˜€ï¸ ×™×•× ×•×œ×™×œ×” ğŸŒ™', isDynamic: true },
                { name: 'autoSeasonal', displayName: 'ğŸ‚ ×¢×•× ×•×ª ×”×©× ×” ğŸŒ·', isDynamic: true },
            ],
            static: [
                { name: 'defaultLight', displayName: '×‘×”×™×¨', colors: { bgColor: '#f1f5f9', cardBgColor: '#ffffff', textColor: '#334155', accentColor: '#3b82f6' } },
                { name: 'defaultDark', displayName: '×›×”×”', colors: { bgColor: '#1e293b', cardBgColor: '#334155', textColor: '#f1f5f9', accentColor: '#60a5fa' } },
                { name: 'warm', displayName: '×—××™×', colors: { bgColor: '#fefce8', cardBgColor: '#fef3c7', textColor: '#92400e', accentColor: '#f59e0b' } },
                { name: 'bubble', displayName: '×‘×•×¢×•×ª', colors: { bgColor: '#0b1120', cardBgColor: 'rgba(255, 255, 255, 0.1)', textColor: '#e0e7ff', accentColor: '#818cf8' }, bgStyle: 'radial-gradient(circle at 100% 100%, #1e3a8a, #0c152e), radial-gradient(circle at 0% 0%, #312e81, #0c152e)' },
                { name: 'forest', displayName: '×™×¢×¨', colors: { bgColor: '#f0fdf4', cardBgColor: '#ffffff', textColor: '#14532d', accentColor: '#22c55e' } },
                { name: 'ocean', displayName: '××•×§×™×™× ×•×¡', colors: { bgColor: '#0c243b', cardBgColor: '#183d5d', textColor: '#eff6ff', accentColor: '#38bdf8' } },
                { name: 'rose', displayName: '×•×¨×•×“', colors: { bgColor: '#fff1f2', cardBgColor: '#ffffff', textColor: '#831843', accentColor: '#f43f5e' } },
                { name: 'slate', displayName: '×¦×¤×—×”', colors: { bgColor: '#f8fafc', cardBgColor: '#ffffff', textColor: '#334155', accentColor: '#64748b' } },
                { name: 'mint', displayName: '×× ×˜×”', colors: { bgColor: '#f0fdfa', cardBgColor: '#ccfbf1', textColor: '#134e4a', accentColor: '#2dd4bf' } },
                { name: 'sunset', displayName: '×©×§×™×¢×”', colors: { bgColor: '#312e81', cardBgColor: '#4338ca', textColor: '#e0e7ff', accentColor: '#f59e0b' }, bgStyle: 'linear-gradient(to top, #312e81, #7c3aed, #f59e0b)' },
                { name: 'newspaper', displayName: '×¢×™×ª×•×Ÿ', colors: { bgColor: '#f5f5f4', cardBgColor: '#ffffff', textColor: '#1c1917', accentColor: '#ef4444' } },
                { name: 'cyberpunk', displayName: '×¡×™×™×‘×¨×¤×× ×§', colors: { bgColor: '#000000', cardBgColor: '#1a1a1a', textColor: '#00ff00', accentColor: '#ff00ff' } },
                { name: 'lavender', displayName: '×œ×‘× ×“×¨', colors: { bgColor: '#f5f3ff', cardBgColor: '#ede9fe', textColor: '#5b21b6', accentColor: '#8b5cf6' } },
                { name: 'sand', displayName: '×—×•×œ', colors: { bgColor: '#fdf6e3', cardBgColor: '#fcfbf5', textColor: '#654321', accentColor: '#d2b48c' } },
                { name: 'sky', displayName: '×©××™×™×', colors: { bgColor: '#e0f2fe', cardBgColor: '#f0f9ff', textColor: '#0c4a6e', accentColor: '#38bdf8' } },
                { name: 'cherry', displayName: '×“×•×‘×“×‘×Ÿ', colors: { bgColor: '#4c0519', cardBgColor: '#750e2b', textColor: '#fecdd3', accentColor: '#f43f5e' } },
                { name: 'matcha', displayName: '×××¦×³×”', colors: { bgColor: '#f7fee7', cardBgColor: '#eaffd4', textColor: '#3f6212', accentColor: '#84cc16' } },
                { name: 'graphite', displayName: '×’×¨×¤×™×˜', colors: { bgColor: '#171717', cardBgColor: '#262626', textColor: '#d4d4d4', accentColor: '#a3a3a3' } },
                { name: 'peach', displayName: '××¤×¨×¡×§', colors: { bgColor: '#fff7ed', cardBgColor: '#ffedd5', textColor: '#9a3412', accentColor: '#fb923c' } },
                { name: 'royal', displayName: '××œ×›×•×ª×™', colors: { bgColor: '#1e1b4b', cardBgColor: '#312e81', textColor: '#e0e7ff', accentColor: '#eab308' } },
            ]
        };

        function getDynamicThemeColors(themeName) {
            const hour = new Date().getHours();
            if (themeName === 'autoDayNight') {
                if (hour >= 6 && hour < 18) return { name: 'autoDayNight', displayName: 'â˜€ï¸ ×™×•×', colors: { bgColor: '#f1f5f9', cardBgColor: '#ffffff', textColor: '#334155', accentColor: '#3b82f6' } }; // Day
                return { name: 'autoDayNight', displayName: 'ğŸŒ™ ×œ×™×œ×”', colors: { bgColor: '#1e293b', cardBgColor: '#334155', textColor: '#f1f5f9', accentColor: '#60a5fa' } }; // Night
            }
            if (themeName === 'autoSeasonal') {
                const month = new Date().getMonth(); // 0-11
                if (month >= 2 && month <= 4) return { name: 'autoSeasonal', displayName: 'ğŸŒ· ××‘×™×‘', colors: { bgColor: '#f0fdf4', cardBgColor: '#dcfce7', textColor: '#166534', accentColor: '#4ade80' } }; // Spring
                if (month >= 5 && month <= 7) return { name: 'autoSeasonal', displayName: 'â˜€ï¸ ×§×™×¥', colors: { bgColor: '#fefce8', cardBgColor: '#fef9c3', textColor: '#854d0e', accentColor: '#facc15' } }; // Summer
                if (month >= 8 && month <= 10) return { name: 'autoSeasonal', displayName: 'ğŸ‚ ×¡×ª×™×•', colors: { bgColor: '#fff7ed', cardBgColor: '#ffedd5', textColor: '#9a3412', accentColor: '#fb923c' } }; // Autumn
                return { name: 'autoSeasonal', displayName: 'â„ï¸ ×—×•×¨×£', colors: { bgColor: '#f0f9ff', cardBgColor: '#e0f2fe', textColor: '#0c4a6e', accentColor: '#38bdf8' } }; // Winter
            }
            return null;
        }

        function populateThemes() {
            const dynamicContainer = document.getElementById('dynamic-themes-container');
            const staticContainer = document.getElementById('preset-themes-container');
            
            themes.dynamic.forEach(theme => {
                const currentDynamic = getDynamicThemeColors(theme.name);
                const btn = document.createElement('button');
                btn.className = 'theme-preset-btn p-2 rounded-lg border-2 border-transparent text-sm';
                btn.dataset.themeName = theme.name;
                btn.dataset.isDynamic = "true";
                btn.innerHTML = `<span class="block w-full h-8 rounded mb-1" style="background: linear-gradient(45deg, ${currentDynamic.colors.bgColor} 50%, ${currentDynamic.colors.cardBgColor} 50%);"></span>${theme.displayName}`;
                dynamicContainer.appendChild(btn);
            });

            themes.static.forEach(theme => {
                const btn = document.createElement('button');
                btn.className = 'theme-preset-btn p-2 rounded-lg border-2 border-transparent text-sm';
                btn.dataset.themeName = theme.name;
                btn.innerHTML = `<span class="block w-full h-8 rounded mb-1" style="background: ${theme.bgStyle || `linear-gradient(45deg, ${theme.colors.bgColor} 50%, ${theme.colors.cardBgColor} 50%)`};"></span>${theme.displayName}`;
                staticContainer.appendChild(btn);
            });
        }

        function applyTheme(themeConfig) {
            document.documentElement.style.setProperty('--bg-color', themeConfig.colors.bgColor);
            document.documentElement.style.setProperty('--card-bg-color', themeConfig.colors.cardBgColor);
            document.documentElement.style.setProperty('--text-color', themeConfig.colors.textColor);
            document.documentElement.style.setProperty('--accent-color', themeConfig.colors.accentColor);

            if (themeConfig.bgStyle) {
                document.body.style.background = themeConfig.bgStyle;
            } else {
                document.body.style.background = ''; 
            }
            
            const headerBgColor = themeConfig.colors.bgColor === themeConfig.colors.cardBgColor ? themeConfig.colors.bgColor : themeConfig.colors.cardBgColor;
            document.documentElement.style.setProperty('--header-bg-color', headerBgColor);

            document.getElementById('main-content').className = `layout-${themeConfig.layout}`;
            
            document.getElementById('bg-color-picker').value = themeConfig.colors.bgColor;
            document.getElementById('card-bg-color-picker').value = themeConfig.colors.cardBgColor;
            document.getElementById('text-color-picker').value = themeConfig.colors.textColor;
            document.getElementById('accent-color-picker').value = themeConfig.colors.accentColor;
            
            const layoutRadio = document.querySelector(`input[name="layout-style"][value="${themeConfig.layout}"]`);
            if (layoutRadio) layoutRadio.checked = true;

            document.querySelectorAll('.theme-preset-btn').forEach(btn => {
                btn.classList.remove('border-green-500', 'ring-2', 'ring-green-500');
                if (btn.dataset.themeName === themeConfig.name) {
                    btn.classList.add('border-green-500', 'ring-2', 'ring-green-500');
                }
            });

            currentTheme = themeConfig.colors;
            if (expensesChartToday) { expensesChartToday.destroy(); expensesChartToday = null; }
            if (expensesChartAll) { expensesChartAll.destroy(); expensesChartAll = null; }
            if (ownerComparisonChartToday) { ownerComparisonChartToday.destroy(); ownerComparisonChartToday = null; }
            if (ownerComparisonChartAll) { ownerComparisonChartAll.destroy(); ownerComparisonChartAll = null; }
            scheduleRender();
        }

        function saveTheme(themeToSave) {
            localStorage.setItem(`tripTheme_${tripId}`, JSON.stringify(themeToSave));
            loadTheme();
        }

        function loadTheme() {
            if (themeUpdateInterval) clearInterval(themeUpdateInterval);
            const savedTheme = JSON.parse(localStorage.getItem(`tripTheme_${tripId}`));
            
            const defaultTheme = {
                layout: 'cards',
                name: 'defaultLight',
            };

            const themeIdentifier = savedTheme || defaultTheme;
            let themeConfig;

            if (themeIdentifier.name === 'custom') {
                themeConfig = themeIdentifier;
            } else {
                const staticTheme = themes.static.find(t => t.name === themeIdentifier.name);
                if (staticTheme) {
                    themeConfig = { ...staticTheme, layout: themeIdentifier.layout };
                } else {
                    const dynamicTheme = getDynamicThemeColors(themeIdentifier.name);
                    if (dynamicTheme) {
                        themeConfig = { ...dynamicTheme, layout: themeIdentifier.layout };
                        themeUpdateInterval = setInterval(loadTheme, 60000);
                    } else {
                        themeConfig = { ...themes.static[0], layout: 'cards' };
                    }
                }
            }
            applyTheme(themeConfig);
        }

        // --- PDF Export Logic ---
        async function generateReportHTML() {
            // Respect current filter state for PDF
            let expensesToExport = getFilteredExpenses();
            // Respect Exclude Toggle
            expensesToExport = includeExcluded ? expensesToExport : expensesToExport.filter(e => !e.isExcluded);

            const owners = [...new Set(expensesToExport.map(exp => exp.ownerName).filter(Boolean))];
            let reportHtml = `
                <div style="font-family: 'Assistant', sans-serif; direction: rtl; text-align: right; padding: 20px; background-color: #fff; color: #333;">
                    <h1 style="font-size: 24px; font-weight: bold; border-bottom: 2px solid #3b82f6; padding-bottom: 10px; margin-bottom: 20px;">×“×•×— ×”×•×¦××•×ª: ${tripDetails.name || ''}</h1>
            `;

            const allExpensesSorted = [...expensesToExport].sort((a, b) => new Date(a.date) - new Date(b.date));
            const categorySummary = {};
            
            for (const owner of owners) {
                reportHtml += `<h2 style="font-size: 20px; font-weight: bold; margin-top: 30px; margin-bottom: 15px;">×¡×™×›×•× ×¢×‘×•×¨: ${owner}</h2>`;
                const ownerExpenses = allExpensesSorted.filter(exp => exp.ownerName === owner);
                
                reportHtml += `
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead>
                            <tr style="background-color: #f1f5f9;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×ª××¨×™×š</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×§×˜×’×•×¨×™×”</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: right;">×¤×™×¨×•×˜</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">×¡×›×•×</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">×¡×›×•× (â‚ª)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                const ownerCategorySummary = {};
                for (const exp of ownerExpenses) {
                    const amountInILS = await convertToILS(exp.amount, exp.currency);
                    ownerCategorySummary[exp.category] = (ownerCategorySummary[exp.category] || 0) + amountInILS;
                    categorySummary[exp.category] = (categorySummary[exp.category] || 0) + amountInILS;
                    reportHtml += `
                        <tr>
                            <td style="padding: 8px; border: 1px solid #ddd;">${new Date(exp.date).toLocaleDateString('he-IL')}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${exp.category}</td>
                            <td style="padding: 8px; border: 1px solid #ddd;">${exp.notes || ''}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-family: monospace;">${exp.amount.toFixed(2)} ${exp.currency}</td>
                            <td style="padding: 8px; border: 1px solid #ddd; text-align: left; font-family: monospace;">${amountInILS.toFixed(2)}</td>
                        </tr>
                    `;
                }
                reportHtml += '</tbody></table>';

                reportHtml += `<h3 style="font-size: 16px; font-weight: bold; margin-top: 20px; margin-bottom: 10px;">×¡×™×›×•× ×œ×¤×™ ×§×˜×’×•×¨×™×•×ª (${owner})</h3>`;
                reportHtml += '<table style="width: 50%; border-collapse: collapse;"><tbody>';
                let ownerTotal = 0;
                for (const [cat, total] of Object.entries(ownerCategorySummary).sort(([,a],[,b]) => b-a)) {
                    ownerTotal += total;
                    reportHtml += `<tr><td style="padding: 6px; border-bottom: 1px solid #eee;">${cat}</td><td style="padding: 6px; border-bottom: 1px solid #eee; text-align: left; font-family: monospace;">${total.toFixed(2)} â‚ª</td></tr>`;
                }
                reportHtml += `<tr style="font-weight: bold; background-color: #f1f5f9;"><td style="padding: 8px;">×¡×”"×›</td><td style="padding: 8px; text-align: left; font-family: monospace;">${ownerTotal.toFixed(2)} â‚ª</td></tr>`;
                reportHtml += '</tbody></table>';
            }

            if (owners.length > 1) {
                reportHtml += `<h2 style="font-size: 20px; font-weight: bold; margin-top: 40px; margin-bottom: 15px; border-top: 2px solid #3b82f6; padding-top: 20px;">×¡×™×›×•× ×›×œ×œ×™</h2>`;
                reportHtml += '<table style="width: 50%; border-collapse: collapse;"><tbody>';
                let grandTotal = 0;
                for (const [cat, total] of Object.entries(categorySummary).sort(([,a],[,b]) => b-a)) {
                    grandTotal += total;
                    reportHtml += `<tr><td style="padding: 6px; border-bottom: 1px solid #eee;">${cat}</td><td style="padding: 6px; border-bottom: 1px solid #eee; text-align: left; font-family: monospace;">${total.toFixed(2)} â‚ª</td></tr>`;
                }
                reportHtml += `<tr style="font-weight: bold; background-color: #f1f5f9;"><td style="padding: 8px;">×¡×”"×› ×›×œ×œ×™</td><td style="padding: 8px; text-align: left; font-family: monospace;">${grandTotal.toFixed(2)} â‚ª</td></tr>`;
                reportHtml += '</tbody></table>';
            }

            reportHtml += '</div>';
            return reportHtml;
        }

        async function exportToPdf() {
            const loadingText = document.getElementById('loading-text');
            loadingText.textContent = '××›×™×Ÿ ××ª ×”×“×•×—...';
            document.getElementById('loading-overlay').style.display = 'flex';
            document.getElementById('loading-overlay').classList.remove('opacity-0');

            const reportHTML = await generateReportHTML();

            const reportContainer = document.createElement('div');
            reportContainer.style.position = 'absolute';
            reportContainer.style.left = '-9999px';
            reportContainer.style.width = '800px'; 
            reportContainer.innerHTML = reportHTML;
            document.body.appendChild(reportContainer);

            try {
                const canvas = await html2canvas(reportContainer, { scale: 2 });
                const imgData = canvas.toDataURL('image/png');
                
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'portrait',
                    unit: 'pt',
                    format: 'a4'
                });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;
                const ratio = imgWidth / imgHeight;
                
                const finalImgWidth = pdfWidth - 40; // with margin
                const finalImgHeight = finalImgWidth / ratio;
                
                let heightLeft = finalImgHeight;
                let position = 20; // top margin

                pdf.addImage(imgData, 'PNG', 20, position, finalImgWidth, finalImgHeight);
                heightLeft -= (pdfHeight - 40);

                while (heightLeft > 0) {
                    position = heightLeft - finalImgHeight;
                    pdf.addPage();
                    pdf.addImage(imgData, 'PNG', 20, position, finalImgWidth, finalImgHeight);
                    heightLeft -= (pdfHeight - 40);
                }

                pdf.save(`expense-report-${tripId}.pdf`);

            } catch(error) {
                console.error("Error generating PDF:", error);
                alert("××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”-PDF.");
            } finally {
                document.body.removeChild(reportContainer);
                loadingText.textContent = '×˜×•×¢×Ÿ ×”×•×¦××•×ª...';
                hideLoadingOverlay();
            }
        }
        
        // --- Sidebar Logic ---
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('overlay');
        const hamburgerBtn = document.getElementById('hamburger-btn');
        const closeSidebarBtn = document.getElementById('close-sidebar-btn');
        const mainMenu = document.getElementById('main-menu');

        function toggleSidebar() {
          const isClosed = sidebar.classList.contains('translate-x-full');
          if (isClosed) {
            // Open
            sidebar.classList.remove('translate-x-full');
            overlay.classList.remove('hidden');
            requestAnimationFrame(() => {
                overlay.classList.remove('opacity-0');
            });
            document.body.classList.add('modal-locked'); 
          } else {
            // Close
            sidebar.classList.add('translate-x-full');
            overlay.classList.add('opacity-0');
            setTimeout(() => {
                overlay.classList.add('hidden');
                document.body.classList.remove('modal-locked');
            }, 300); 
          }
        }

        // --- Date Helpers for Sidebar ---
        function parseDDMMYYYY(s) {
            if (!s || typeof s !== 'string') return null;
            const [d, m, y] = s.split('/').map(Number);
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            return new Date(y, m - 1, d);
        }

        function hebWeekday(d) {
            const n = d.toLocaleDateString('he-IL', { weekday: 'long' });
            return n.startsWith('×™×•×') ? n : `×™×•× ${n}`;
        }

        function dotted(d) {
            return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
        }

        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDDMMYYYY(startStr);
            const endDate = parseDDMMYYYY(endStr);
            if (!startDate || !endDate) return [];
            
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const dd = String(currentDate.getDate()).padStart(2,'0');
                const mm = String(currentDate.getMonth()+1).padStart(2,'0');
                const yyyy = currentDate.getFullYear();
                dates.push(`${dd}/${mm}/${yyyy}`);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function buildMenuFromTrip(tripData) {
            mainMenu.innerHTML = ''; 

            // 1. Navigation Buttons
            const tParam = `?tripId=${tripId}`;
            
            const navLinks = [
                { name: '××¨×›×– ×”×‘×§×¨×”', icon: 'fa-home', href: `trip.html${tParam}`, color: 'text-blue-600', bg: 'bg-blue-50' },
                { name: '× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”', icon: 'fa-suitcase', href: `summary.html${tParam}`, color: 'text-orange-600', bg: 'bg-orange-50' },
                { name: '××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª', icon: 'fa-utensils', href: `attractions.html${tParam}`, color: 'text-cyan-600', bg: 'bg-cyan-50' },
                { name: '×¨×©×™××•×ª ×•×¦\'×§ ×œ×™×¡×˜', icon: 'fa-list-check', href: `checklists.html${tParam}`, color: 'text-emerald-600', bg: 'bg-emerald-50' },
                { name: '××¢×§×‘ ×”×•×¦××•×ª', icon: 'fa-coins', href: `expenses.html${tParam}`, color: 'text-rose-600', bg: 'bg-rose-50' },
                { name: '×‘× ×™×™×ª ××¡×œ×•×œ ×—×›×', icon: 'fa-magic-wand-sparkles', href: `edit-trip.html${tParam}`, color: 'text-purple-600', bg: 'bg-purple-50' }
            ];

            const navContainer = document.createElement('div');
            navContainer.className = 'space-y-2 mb-6';

            // Highlight current page (expenses.html)
            const currentPath = window.location.pathname;
            const isExpensesPage = currentPath.includes('expenses.html') || window.location.href.includes('expenses.html');

            navLinks.forEach(link => {
                const a = document.createElement('a');
                a.href = link.href;
                const isActive = link.href.includes('expenses.html'); 

                a.className = `flex items-center gap-3 w-full p-3 rounded-xl transition-all hover:translate-x-1 ${isActive ? 'bg-slate-100 font-bold border-r-4 border-cyan-500' : 'hover:bg-slate-50'}`;
                
                a.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${link.bg} ${link.color} flex items-center justify-center shadow-sm">
                        <i class="fas ${link.icon}"></i>
                    </div>
                    <span class="text-slate-700 ${isActive ? 'font-bold' : 'font-medium'}">${link.name}</span>
                `;
                navContainer.appendChild(a);
            });
            mainMenu.appendChild(navContainer);

            // 2. Separator & Header
            const separator = document.createElement('div');
            separator.className = 'h-px bg-slate-200 my-4';
            mainMenu.appendChild(separator);

            const scheduleHeader = document.createElement('h3');
            scheduleHeader.className = 'text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2';
            scheduleHeader.innerText = "×œ×•×´×– ×™×•××™ ×œ×¤×™ ×™×¢×“×™×";
            mainMenu.appendChild(scheduleHeader);

            // 3. Destinations
            if (!tripData?.destinations || !Array.isArray(tripData.destinations)) {
                mainMenu.insertAdjacentHTML('beforeend', '<p class="text-center text-slate-400 text-sm">×œ× ×”×•×’×“×¨×• ×™×¢×“×™× ×œ×˜×™×•×œ ×–×”.</p>');
                return;
            }

            const sortedDestinations = [...tripData.destinations].sort((a, b) => {
                const dateA = parseDDMMYYYY(a.dates?.split(' - ')[0]);
                const dateB = parseDDMMYYYY(b.dates?.split(' - ')[0]);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            sortedDestinations.forEach(dest => {
                const destinationDiv = document.createElement('div');
                destinationDiv.className = 'mb-2';

                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 hover:bg-cyan-50 rounded-xl font-bold text-slate-700 flex justify-between items-center transition-all group';
                button.innerHTML = `
                    <span class="flex items-center gap-3">
                        <i class="fas fa-map-marked-alt text-slate-400 group-hover:text-cyan-500 transition-colors"></i> 
                        ${dest.nameHe || dest.name}
                    </span> 
                    <i class="fas fa-chevron-down chevron-icon text-slate-300 text-sm"></i>`;

                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-4 border-r-2 border-slate-100 pr-2 space-y-1';

                if (dest.dates) {
                    const dates = generateDatesFromRange(dest.dates);
                    dates.forEach(dateStr => {
                        const d = parseDDMMYYYY(dateStr);
                        if (!d) return;
                        
                        const a = document.createElement('a');
                        const destNameParam = encodeURIComponent(dest.nameHe || dest.name);
                        a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
                        
                        a.className = 'block w-full text-right py-2 px-3 text-slate-600 hover:bg-slate-50 hover:text-cyan-700 rounded-lg transition text-sm';
                        a.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                                <span class="font-medium">${hebWeekday(d)}</span>
                                <span class="text-xs text-slate-400">(${dotted(d)})</span>
                            </div>
                        `;
                        submenu.appendChild(a);
                    });
                } else {
                    const noDates = document.createElement('div');
                    noDates.className = 'text-xs text-slate-400 pr-3 py-1';
                    noDates.innerText = '×œ×œ× ×ª××¨×™×›×™×';
                    submenu.appendChild(noDates);
                }

                button.addEventListener('click', () => {
                    submenu.classList.toggle('open');
                    button.querySelector('.chevron-icon').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                mainMenu.appendChild(destinationDiv);
            });
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            document.getElementById('add-expense-btn-header').addEventListener('click', () => openExpenseModal());
            document.getElementById('add-first-expense-btn').addEventListener('click', () => openExpenseModal());
            document.getElementById('onboarding-settings-btn').addEventListener('click', openSettingsModal);
            document.getElementById('settings-btn').addEventListener('click', openSettingsModal);
            document.getElementById('export-pdf-btn').addEventListener('click', exportToPdf);
            document.getElementById('expense-form').addEventListener('submit', handleExpenseFormSubmit);
            
            // Sidebar Event Listeners
            hamburgerBtn.addEventListener('click', toggleSidebar);
            closeSidebarBtn.addEventListener('click', toggleSidebar);
            overlay.addEventListener('click', toggleSidebar);

            document.querySelectorAll('[data-close-modal]').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.closeModal));
            });

            document.querySelectorAll('.tab-btn').forEach(tab => {
                tab.addEventListener('click', async () => {
                    activeTab = tab.dataset.tab;
                    document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${activeTab}`).classList.add('active');
                    await scheduleRender();
                });
            });

            document.querySelectorAll('.filter-btn').forEach(filter => {
                filter.addEventListener('click', async () => {
                    activeFilter = filter.dataset.filter;
                    document.querySelectorAll('.filter-btn').forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    
                    // Reset custom filters when standard filter is clicked
                    customDateRange.start = null;
                    customDateRange.end = null;
                    document.getElementById('filter-start-date').value = '';
                    document.getElementById('filter-end-date').value = '';
                    document.getElementById('filter-destination-select').value = '';
                    document.getElementById('active-filter-label').classList.add('hidden');

                    await scheduleRender();
                });
            });

            // NEW: Toggle "Include Excluded"
            document.getElementById('include-excluded-toggle').addEventListener('change', async (e) => {
                includeExcluded = e.target.checked;
                await scheduleRender();
            });

            // NEW: Search Input
            document.getElementById('search-input').addEventListener('input', (e) => {
                searchQuery = e.target.value;
                const clearBtn = document.getElementById('clear-search');
                clearBtn.classList.toggle('hidden', searchQuery === "");
                scheduleRender();
            });
            document.getElementById('clear-search').addEventListener('click', () => {
                document.getElementById('search-input').value = "";
                searchQuery = "";
                document.getElementById('clear-search').classList.add('hidden');
                scheduleRender();
            });

            // Advanced Filters Listeners
            document.getElementById('toggle-advanced-filters').addEventListener('click', () => {
                const panel = document.getElementById('advanced-filters');
                panel.classList.toggle('hidden');
            });

            document.getElementById('filter-start-date').addEventListener('change', (e) => {
                customDateRange.start = e.target.value;
                scheduleRender();
            });

            document.getElementById('filter-end-date').addEventListener('change', (e) => {
                customDateRange.end = e.target.value;
                scheduleRender();
            });

            document.getElementById('clear-advanced-filters').addEventListener('click', () => {
                document.getElementById('filter-start-date').value = '';
                document.getElementById('filter-end-date').value = '';
                document.getElementById('filter-destination-select').value = '';
                document.getElementById('include-excluded-toggle').checked = false; 
                includeExcluded = false;
                customDateRange.start = null;
                customDateRange.end = null;
                
                activeFilter = 'all';
                document.querySelectorAll('.filter-btn').forEach(f => f.classList.remove('active'));
                document.querySelector('.filter-btn[data-filter="all"]').classList.add('active');
                
                scheduleRender();
            });
            
            document.body.addEventListener('click', async (e) => {
                const editBtn = e.target.closest('.edit-btn');
                if (editBtn) {
                    e.stopPropagation();
                    openExpenseModal({ id: editBtn.dataset.id });
                    return;
                }

                const deleteBtn = e.target.closest('.delete-btn');
                if (deleteBtn) {
                    e.stopPropagation();
                    handleDeleteExpense(deleteBtn.dataset.id);
                    return;
                }
                
                // NEW: Toggle Exclude button on card
                const toggleExcludeBtn = e.target.closest('.toggle-exclude-btn');
                if (toggleExcludeBtn) {
                    e.stopPropagation();
                    const id = toggleExcludeBtn.dataset.id;
                    const status = toggleExcludeBtn.dataset.excluded === 'true';
                    await toggleExpenseExclusion(id, status);
                    return;
                }

                const ownerBtn = e.target.closest('.owner-filter-btn');
                if (ownerBtn) {
                    const owner = ownerBtn.dataset.owner;
                    if(owner === 'compare') {
                        comparisonViewActive = true;
                    } else {
                        comparisonViewActive = false;
                        activeOwner = owner;
                    }
                    await scheduleRender();
                    return;
                }
                
                const card = e.target.closest('.expense-card-clickable');
                if (card) {
                    openExpenseDetailsModal(card.dataset.id);
                }
                
                const categoryHeader = e.target.closest('.category-header');
                if (categoryHeader) {
                    const content = categoryHeader.nextElementSibling;
                    const icon = categoryHeader.querySelector('i');
                    content.classList.toggle('expanded');
                    icon.classList.toggle('rotate-180');
                }
            });

            const expenseCategorySelect = document.getElementById('expense-category');
            expenseCategorySelect.addEventListener('change', () => {
                const isAddNew = expenseCategorySelect.value === 'add_new_category';
                document.getElementById('new-category-wrapper').classList.toggle('hidden', !isAddNew);
                const isCustom = !defaultCategories.includes(expenseCategorySelect.value) && !isAddNew;
                document.getElementById('delete-category-btn').classList.toggle('hidden', !isCustom);
            });
            
            document.getElementById('delete-category-btn').addEventListener('click', handleDeleteCategory);

            document.getElementById('generate-api-key-btn').addEventListener('click', generateAndSaveApiKey);
            document.getElementById('copy-api-key-btn').addEventListener('click', () => copyToClipboard(document.getElementById('api-key-input'), document.getElementById('copy-api-key-btn')));
            document.getElementById('copy-trip-id-btn').addEventListener('click', () => copyToClipboard(document.getElementById('trip-id-input'), document.getElementById('copy-trip-id-btn')));
            
            document.getElementById('comparison-category-filter-today').addEventListener('change', async (e) => {
                activeComparisonCategory = e.target.value;
                await scheduleRender();
            });
            document.getElementById('comparison-category-filter-all').addEventListener('change', async (e) => {
                activeComparisonCategory = e.target.value;
                await scheduleRender();
            });

            // Settings modal tabs
            document.querySelectorAll('.settings-tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabId = btn.dataset.tab;
                    document.querySelectorAll('.settings-tab-btn').forEach(t => t.classList.remove('active'));
                    btn.classList.add('active');
                    document.querySelectorAll('.settings-tab-content').forEach(c => c.classList.remove('active'));
                    document.getElementById(`settings-tab-${tabId}`).classList.add('active');
                });
            });

            // Theme control event listeners
            document.querySelectorAll('input[name="layout-style"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const savedTheme = JSON.parse(localStorage.getItem(`tripTheme_${tripId}`)) || { name: 'defaultLight', layout: 'cards' };
                    savedTheme.layout = e.target.value;
                    saveTheme(savedTheme);
                });
            });

            ['bg-color-picker', 'card-bg-color-picker', 'text-color-picker', 'accent-color-picker'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => {
                    const theme = {
                        name: 'custom',
                        layout: document.querySelector('input[name="layout-style"]:checked').value,
                        colors: {
                            bgColor: document.getElementById('bg-color-picker').value,
                            cardBgColor: document.getElementById('card-bg-color-picker').value,
                            textColor: document.getElementById('text-color-picker').value,
                            accentColor: document.getElementById('accent-color-picker').value
                        }
                    };
                    saveTheme(theme);
                });
            });
            
            document.getElementById('settings-modal').addEventListener('click', (e) => {
                const themeBtn = e.target.closest('.theme-preset-btn');
                if (themeBtn) {
                    const themeName = themeBtn.dataset.themeName;
                    const layout = document.querySelector('input[name="layout-style"]:checked').value;
                    saveTheme({ name: themeName, layout: layout });
                }
            });
        }

        // --- Start the application ---
        initPage();
    </script>
</body>
</html>