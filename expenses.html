<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>× ×™×”×•×œ ×”×•×¦××•×ª</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Chart.js for graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Icons + Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { 
            font-family: 'Assistant', sans-serif; 
            overscroll-behavior-y: none;
        }
        .modal-transition { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal-hidden { opacity: 0; transform: scale(0.95); pointer-events: none; }
        .modal-visible { opacity: 1; transform: scale(1); }
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
        
        .tab-btn.active {
            border-color: #2563eb; /* blue-600 */
            color: #2563eb;
            background-color: #dbeafe; /* blue-100 */
        }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .filter-btn.active {
            background-color: #1e40af; /* blue-800 */
            color: white;
        }
        
        /* Small spinner for currency conversion */
        .loader {
            width: 12px;
            height: 12px;
            border: 2px solid #d1d5db; /* gray-300 */
            border-bottom-color: transparent;
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }

        @keyframes rotation {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-wallet text-5xl text-blue-600 animate-pulse"></i>
        <p class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ ×”×•×¦××•×ª...</p>
    </div>

    <!-- Add/Edit Expense Modal -->
    <div id="expense-modal" class="modal-transition modal-hidden fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-lg">
            <div class="flex justify-between items-center mb-4 border-b pb-3">
                <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×”×•×¦××” ×—×“×©×”</h3>
                <button data-close-modal="expense-modal" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <form id="expense-form" class="space-y-4">
                <input type="hidden" id="expense-id">
                
                <div>
                    <label for="expense-owner-name" class="block text-sm font-medium text-slate-700 mb-1">×©× ×”××•×¡×™×£</label>
                    <input type="text" id="expense-owner-name" class="w-full p-2 border rounded-md bg-slate-50" required>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="expense-amount" class="block text-sm font-medium text-slate-700 mb-1">×¡×›×•×</label>
                        <input type="number" id="expense-amount" step="0.01" class="w-full p-2 border rounded-md" placeholder="100" required>
                    </div>
                    <div>
                        <label for="expense-currency" class="block text-sm font-medium text-slate-700 mb-1">××˜×‘×¢</label>
                        <select id="expense-currency" class="w-full p-2 border rounded-md bg-white"></select>
                    </div>
                </div>

                <div>
                    <label for="expense-category" class="block text-sm font-medium text-slate-700 mb-1">×§×˜×’×•×¨×™×”</label>
                    <div class="flex items-center gap-2">
                        <select id="expense-category" class="w-full p-2 border rounded-md bg-white"></select>
                        <button type="button" id="delete-category-btn" class="text-slate-400 hover:text-red-500 p-2 hidden" title="××—×§ ×§×˜×’×•×¨×™×” ×–×•"><i class="fas fa-trash"></i></button>
                    </div>
                </div>

                <div id="new-category-wrapper" class="hidden">
                    <label for="new-category-name" class="block text-sm font-medium text-slate-700 mb-1">×©× ×”×§×˜×’×•×¨×™×” ×”×—×“×©×”</label>
                    <input type="text" id="new-category-name" class="w-full p-2 border rounded-md" placeholder="×œ×“×•×’××”: ×‘×™×œ×•×™×™×">
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="expense-date" class="block text-sm font-medium text-slate-700 mb-1">×ª××¨×™×š</label>
                        <input type="date" id="expense-date" class="w-full p-2 border rounded-md" required>
                    </div>
                    <div>
                        <label for="expense-notes" class="block text-sm font-medium text-slate-700 mb-1">×¤×™×¨×•×˜ (××•×¤×¦×™×•× ×œ×™)</label>
                        <input type="text" id="expense-notes" class="w-full p-2 border rounded-md" placeholder="×¤×¨×˜×™× × ×•×¡×¤×™×...">
                    </div>
                </div>

                <div class="flex justify-end gap-4 pt-4">
                    <button type="button" data-close-modal="expense-modal" class="bg-gray-200 hover:bg-gray-300 text-black font-bold py-2 px-6 rounded-lg">×‘×™×˜×•×œ</button>
                    <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">×©××•×¨</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="pb-24">
        <header class="bg-white shadow-sm sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a id="back-to-dashboard" href="#" class="text-slate-700 font-bold hover:text-blue-600 flex items-center gap-2">
                        <i class="fas fa-arrow-right"></i>
                    </a>
                    <h1 id="trip-title" class="text-xl font-bold text-slate-800 truncate">× ×™×”×•×œ ×”×•×¦××•×ª</h1>
                    <button id="add-expense-btn-header" class="bg-blue-600 text-white rounded-full h-8 w-8 flex items-center justify-center shadow-md">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6">
            <div class="mb-6 bg-slate-200 p-1 rounded-full grid grid-cols-2 gap-1">
                <button class="tab-btn active font-bold py-2 px-4 rounded-full transition" data-tab="today">×”×™×•×</button>
                <button class="tab-btn font-bold py-2 px-4 rounded-full transition" data-tab="all">×›×œ ×”×”×•×¦××•×ª</button>
            </div>

            <div id="tab-today" class="tab-content active space-y-6">
                <section>
                    <div id="summary-section-today" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></div>
                    <div id="expenses-list-today" class="space-y-4 mt-6"></div>
                    <div id="no-expenses-message-today" class="text-center p-10 bg-white rounded-2xl shadow-lg hidden">
                        <i class="fas fa-receipt text-4xl text-slate-300 mb-4"></i>
                        <p class="text-slate-500">××™×Ÿ ×”×•×¦××•×ª ×œ×”×™×•×.</p>
                    </div>
                </section>
            </div>

            <div id="tab-all" class="tab-content space-y-6">
                <section class="bg-white p-3 rounded-2xl shadow-lg">
                    <div id="filters" class="flex items-center justify-center gap-2 bg-blue-700 p-1 rounded-full">
                        <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="week">×©×‘×•×¢</button>
                        <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="month">×—×•×“×©</button>
                        <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="2months">×—×•×“×©×™×™×</button>
                        <button class="filter-btn text-white text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="6months">×—×¦×™ ×©× ×”</button>
                        <button class="filter-btn active text-sm font-semibold px-3 py-1 rounded-full transition" data-filter="all">×”×›×œ</button>
                    </div>
                </section>
                
                <section id="summary-section-all" class="grid grid-cols-2 lg:grid-cols-4 gap-4"></section>
                
                <section class="bg-white p-4 md:p-6 rounded-2xl shadow-lg">
                    <h3 class="text-xl font-bold text-slate-800 mb-4">×”×ª×¤×œ×’×•×ª ×œ×¤×™ ×§×˜×’×•×¨×™×” (×‘×©×§×œ×™×)</h3>
                    <div class="h-64 md:h-80 flex justify-center"><canvas id="expenses-chart"></canvas></div>
                </section>

                <section>
                    <div id="expenses-list-all" class="space-y-4"></div>
                    <div id="no-expenses-message-all" class="text-center p-10 bg-white rounded-2xl shadow-lg hidden">
                        <i class="fas fa-search-dollar text-4xl text-slate-300 mb-4"></i>
                        <p class="text-slate-500">×œ× × ××¦××• ×”×•×¦××•×ª ×”×ª×•×××•×ª ×œ×¡×™× ×•×Ÿ.</p>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, onSnapshot, collection, addDoc, updateDoc, deleteDoc, serverTimestamp, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            tripTitle: document.getElementById('trip-title'),
            expenseModal: document.getElementById('expense-modal'),
            modalTitle: document.getElementById('modal-title'),
            expenseForm: document.getElementById('expense-form'),
            expenseId: document.getElementById('expense-id'),
            expenseOwnerName: document.getElementById('expense-owner-name'),
            expenseAmount: document.getElementById('expense-amount'),
            expenseCurrency: document.getElementById('expense-currency'),
            expenseCategory: document.getElementById('expense-category'),
            newCategoryWrapper: document.getElementById('new-category-wrapper'),
            newCategoryName: document.getElementById('new-category-name'),
            deleteCategoryBtn: document.getElementById('delete-category-btn'),
            expenseDate: document.getElementById('expense-date'),
            expenseNotes: document.getElementById('expense-notes'),
            backToDashboardLink: document.getElementById('back-to-dashboard'),
            addExpenseBtnHeader: document.getElementById('add-expense-btn-header'),
            tabs: document.querySelectorAll('.tab-btn'),
            tabContents: document.querySelectorAll('.tab-content'),
            filters: document.querySelectorAll('.filter-btn'),
        };

        // --- Global State ---
        let currentUserProfile = null;
        let tripId = null;
        let allExpenses = [];
        let tripCategories = [];
        let expensesUnsubscribe = null;
        let categoriesUnsubscribe = null;
        let expensesChart = null;
        let activeTab = 'today';
        let activeFilter = 'all';
        let rateCache = {}; // Cache for currency rates
        
        const defaultCategories = ['ğŸ” ××•×›×œ ×•×©×ª×™×”', 'ğŸš— ×ª×—×‘×•×¨×”', 'ğŸ¨ ×œ×™× ×”', 'ğŸ¢ ××˜×¨×§×¦×™×•×ª', 'ğŸ›ï¸ ×§× ×™×•×ª', 'ğŸ“ ××—×¨'];
        
        // --- Currency Data ---
        const currencies = {
            "ILS": "Israeli New Sheqel (â‚ª)", "USD": "United States Dollar ($)", "EUR": "Euro (â‚¬)", "GBP": "British Pound (Â£)",
            "AUD": "Australian Dollar (A$)", "BGN": "Bulgarian Lev (Ğ»Ğ²)", "BRL": "Brazilian Real (R$)", "CAD": "Canadian Dollar (C$)",
            "CHF": "Swiss Franc (CHF)", "CNY": "Chinese Renminbi Yuan (Â¥)", "CZK": "Czech Koruna (KÄ)", "DKK": "Danish Krone (kr)",
            "HKD": "Hong Kong Dollar (HK$)", "HUF": "Hungarian Forint (Ft)", "IDR": "Indonesian Rupiah (Rp)",
            "INR": "Indian Rupee (â‚¹)", "ISK": "Icelandic KrÃ³na (kr)", "JPY": "Japanese Yen (Â¥)", "KRW": "South Korean Won (â‚©)",
            "MXN": "Mexican Peso (MX$)", "MYR": "Malaysian Ringgit (RM)", "NOK": "Norwegian Krone (kr)", "NZD": "New Zealand Dollar (NZ$)",
            "PHP": "Philippine Peso (â‚±)", "PLN": "Polish ZÅ‚oty (zÅ‚)", "RON": "Romanian Leu (lei)", "SEK": "Swedish Krona (kr)",
            "SGD": "Singapore Dollar (S$)", "THB": "Thai Baht (à¸¿)", "TRY": "Turkish Lira (â‚º)", "ZAR": "South African Rand (R)"
        };
        const prioritizedCurrencies = ['ILS', 'USD', 'EUR', 'GBP'];

        // --- Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('tripId');
            if (!tripId) {
                alert("×©×’×™××”: ×œ× × ××¦× ××–×”×” ×˜×™×•×œ.");
                window.location.href = 'index.html';
                return;
            }
            DOM.backToDashboardLink.href = `trip.html?id=${tripId}`;
            populateCurrencyDropdown();

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    await fetchUserProfile(user.uid);
                    fetchTripDetails();
                    listenForCategories();
                    listenForExpenses();
                } else {
                    window.location.href = 'login.html';
                }
            });
            setupEventListeners();
        }

        // --- Data Fetching & Realtime Listeners ---
        async function fetchUserProfile(uid) {
            const userDocRef = doc(db, "users", uid);
            const docSnap = await getDoc(userDocRef);
            currentUserProfile = docSnap.exists() ? { uid, ...docSnap.data() } : { uid, displayName: "××©×ª××©" };
        }

        async function fetchTripDetails() {
            const tripDocRef = doc(db, "trips", tripId);
            const docSnap = await getDoc(tripDocRef);
            if (docSnap.exists()) DOM.tripTitle.textContent = docSnap.data().name || '× ×™×”×•×œ ×”×•×¦××•×ª';
        }

        function listenForCategories() {
            if (categoriesUnsubscribe) categoriesUnsubscribe();
            const categoriesDocRef = doc(db, "trips", tripId, "settings", "categories");
            categoriesUnsubscribe = onSnapshot(categoriesDocRef, (docSnap) => {
                tripCategories = docSnap.exists() ? (docSnap.data().list || []) : [...defaultCategories];
                if (!docSnap.exists()) {
                    setDoc(categoriesDocRef, { list: defaultCategories });
                }
                populateCategoryDropdown();
            });
        }

        function listenForExpenses() {
            if (expensesUnsubscribe) expensesUnsubscribe();
            const expensesColRef = collection(db, "trips", tripId, "expenses");
            expensesUnsubscribe = onSnapshot(expensesColRef, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                allExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
                render();
                if (!DOM.loadingOverlay.classList.contains('opacity-0')) {
                    DOM.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);
                }
            });
        }

        // --- Central Render Function ---
        function render() {
            let filteredExpenses = getFilteredExpenses();
            if (activeTab === 'today') {
                renderExpenseList(filteredExpenses, 'today');
                renderSummary(filteredExpenses, 'today');
            } else {
                renderExpenseList(filteredExpenses, 'all');
                renderSummary(filteredExpenses, 'all');
                updateChart(filteredExpenses);
            }
        }

        // --- Filtering Logic ---
        function getFilteredExpenses() {
            const now = new Date();
            const todayString = now.toISOString().split('T')[0];
            
            if (activeTab === 'today') {
                return allExpenses.filter(exp => exp.date === todayString);
            }

            let startDate = new Date(0);
            switch (activeFilter) {
                case 'week': startDate = new Date(new Date().setDate(now.getDate() - 7)); break;
                case 'month': startDate = new Date(new Date().setMonth(now.getMonth() - 1)); break;
                case '2months': startDate = new Date(new Date().setMonth(now.getMonth() - 2)); break;
                case '6months': startDate = new Date(new Date().setMonth(now.getMonth() - 6)); break;
            }
            return allExpenses.filter(exp => new Date(exp.date) >= startDate);
        }

        // --- UI Rendering ---
        function renderExpenseList(expenses, containerId) {
            const listContainer = document.getElementById(`expenses-list-${containerId}`);
            const noItemsMsg = document.getElementById(`no-expenses-message-${containerId}`);
            listContainer.innerHTML = '';
            
            const hasExpenses = expenses.length > 0;
            noItemsMsg.classList.toggle('hidden', hasExpenses);
            listContainer.classList.toggle('hidden', !hasExpenses);

            expenses.forEach((exp, index) => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-2xl shadow-md flex items-center gap-4';
                const isOwner = currentUserProfile && exp.ownerId === currentUserProfile.uid;
                const uniqueId = `conv-${containerId}-${index}`;
                
                card.innerHTML = `
                    <div class="flex-shrink-0 h-12 w-12 bg-slate-100 rounded-full flex items-center justify-center text-2xl">${exp.category.match(/(\p{Emoji})/u)?.[0] || 'ğŸ“'}</div>
                    <div class="flex-grow">
                        <p class="font-bold text-slate-800">${exp.notes || '×”×•×¦××”'}</p>
                        <p class="text-sm text-slate-500"><span class="font-semibold">${exp.ownerName || '×œ× ×™×“×•×¢'}</span> â€¢ ${new Date(exp.date).toLocaleDateString('he-IL')}</p>
                    </div>
                    <div class="text-left">
                        <p class="font-bold text-lg text-red-600 whitespace-nowrap">
                            ${exp.amount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ${exp.currency}
                            <span id="${uniqueId}" class="text-slate-500 font-normal text-sm ml-1"></span>
                        </p>
                        ${isOwner ? `<div class="flex justify-end gap-2 mt-1">
                            <button class="edit-btn text-slate-400 hover:text-blue-600" data-id="${exp.id}"><i class="fas fa-pencil-alt"></i></button>
                            <button class="delete-btn text-slate-400 hover:text-red-600" data-id="${exp.id}"><i class="fas fa-trash"></i></button>
                        </div>` : ''}
                    </div>
                `;
                listContainer.appendChild(card);
                
                // Trigger conversion display
                if (exp.currency !== 'ILS') {
                    displayConvertedAmount(uniqueId, exp.amount, exp.currency);
                }
            });
        }

        function renderSummary(expenses, containerId) {
            const summaryContainer = document.getElementById(`summary-section-${containerId}`);
            const summary = expenses.reduce((acc, exp) => {
                acc[exp.currency] = (acc[exp.currency] || 0) + Number(exp.amount);
                return acc;
            }, {});
            summaryContainer.innerHTML = '';
            if (Object.keys(summary).length === 0) {
                summaryContainer.innerHTML = `<div class="bg-white p-6 rounded-2xl shadow-lg text-center col-span-full"><p class="text-slate-500">××™×Ÿ ×”×•×¦××•×ª ×œ×”×¦×’×”</p></div>`;
                return;
            }
            for (const currency in summary) {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-2xl shadow-lg text-center';
                card.innerHTML = `
                    <h3 class="text-slate-500 font-semibold text-sm">×¡×”"×› (${currency})</h3>
                    <p class="text-2xl font-bold text-blue-600 mt-1">${summary[currency].toLocaleString('he-IL', { minimumFractionDigits: 2 })}</p>
                `;
                summaryContainer.appendChild(card);
            }
        }

        async function updateChart(expenses) {
            if (expenses.length === 0) {
                if (expensesChart) expensesChart.destroy();
                expensesChart = null;
                return;
            }

            const categoryData = {};
            // Convert all amounts to ILS for a unified chart
            for (const exp of expenses) {
                let amountInILS = exp.amount;
                if (exp.currency !== 'ILS') {
                    const rate = await getRate(exp.currency, 'ILS');
                    amountInILS = exp.amount * rate;
                }
                categoryData[exp.category] = (categoryData[exp.category] || 0) + amountInILS;
            }

            const labels = Object.keys(categoryData);
            const data = Object.values(categoryData);
            const chartCanvas = document.getElementById('expenses-chart');

            const chartConfig = {
                type: 'doughnut',
                data: { labels, datasets: [{ data, backgroundColor: ['#3b82f6', '#ef4444', '#22c55e', '#f97316', '#8b5cf6', '#eab308', '#64748b'], borderColor: '#fff', borderWidth: 2 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { font: { family: "'Assistant', sans-serif" } } } } }
            };
            if (expensesChart) {
                expensesChart.data.labels = labels;
                expensesChart.data.datasets[0].data = data;
                expensesChart.update();
            } else {
                expensesChart = new Chart(chartCanvas, chartConfig);
            }
        }

        // --- Currency Conversion API ---
        async function getRate(from, to) {
            if (from === to) return 1;
            const cacheKey = `${from}-${to}`;
            if (rateCache[cacheKey]) return rateCache[cacheKey];

            try {
                const res = await fetch(`https://api.frankfurter.app/latest?from=${from}&to=${to}`);
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const rate = data.rates[to];
                if (typeof rate !== 'number') return 1; // Fallback
                rateCache[cacheKey] = rate;
                return rate;
            } catch (error) {
                console.error('Failed to fetch currency rate:', error);
                return 1; // Fallback on error
            }
        }

        async function displayConvertedAmount(elementId, amount, from) {
            const el = document.getElementById(elementId);
            if (!el) return;
            el.innerHTML = `<span class="loader"></span>`;
            const rate = await getRate(from, 'ILS');
            const convertedAmount = amount * rate;
            el.textContent = `(â‚ª${convertedAmount.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })})`;
        }

        // --- Dropdown Population ---
        function populateCurrencyDropdown() {
            const fragment = document.createDocumentFragment();
            prioritizedCurrencies.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} â€” ${currencies[code]}`;
                fragment.appendChild(opt);
            });

            const otherCurrencies = Object.keys(currencies)
                .filter(c => !prioritizedCurrencies.includes(c))
                .sort();
            
            otherCurrencies.forEach(code => {
                const opt = document.createElement('option');
                opt.value = code;
                opt.textContent = `${code} â€” ${currencies[code]}`;
                fragment.appendChild(opt);
            });
            DOM.expenseCurrency.appendChild(fragment);
        }

        function populateCategoryDropdown() {
            DOM.expenseCategory.innerHTML = tripCategories
                .map(cat => `<option value="${cat}">${cat}</option>`)
                .join('') + '<option value="add_new_category">â• ×”×•×¡×£ ×—×“×©×”...</option>';
        }

        // --- Modal & Form Logic ---
        function openModal(modalId) { document.getElementById(modalId).classList.remove('modal-hidden'); }
        function closeModal(modalId) { document.getElementById(modalId).classList.add('modal-hidden'); }

        function openExpenseModal(expense = null) {
            DOM.expenseForm.reset();
            DOM.newCategoryWrapper.classList.add('hidden');
            DOM.deleteCategoryBtn.classList.add('hidden');

            if (expense) {
                DOM.modalTitle.textContent = '×¢×¨×™×›×ª ×”×•×¦××”';
                const expenseDocRef = doc(db, "trips", tripId, "expenses", expense.id);
                getDoc(expenseDocRef).then(docSnap => {
                    if (docSnap.exists()) {
                        const data = docSnap.data();
                        DOM.expenseId.value = expense.id;
                        DOM.expenseOwnerName.value = data.ownerName || '';
                        DOM.expenseAmount.value = data.amount;
                        DOM.expenseCurrency.value = data.currency;
                        DOM.expenseCategory.value = data.category;
                        DOM.expenseDate.value = data.date;
                        DOM.expenseNotes.value = data.notes || '';
                    }
                });
            } else {
                DOM.modalTitle.textContent = '×”×•×¡×¤×ª ×”×•×¦××” ×—×“×©×”';
                DOM.expenseId.value = '';
                DOM.expenseOwnerName.value = currentUserProfile.displayName;
                DOM.expenseDate.valueAsDate = new Date();
            }
            openModal('expense-modal');
        }

        async function handleExpenseFormSubmit(e) {
            e.preventDefault();
            let category = DOM.expenseCategory.value;

            if (category === 'add_new_category') {
                const newCategoryName = DOM.newCategoryName.value.trim();
                if (newCategoryName && !tripCategories.includes(newCategoryName)) {
                    const updatedCategories = [...tripCategories, newCategoryName];
                    await setDoc(doc(db, "trips", tripId, "settings", "categories"), { list: updatedCategories });
                    category = newCategoryName;
                } else {
                    alert("×©× ×”×§×˜×’×•×¨×™×” ××™× ×• ×ª×§×™×Ÿ ××• ×©×›×‘×¨ ×§×™×™×.");
                    return;
                }
            }

            const expenseData = {
                ownerName: DOM.expenseOwnerName.value,
                amount: parseFloat(DOM.expenseAmount.value),
                currency: DOM.expenseCurrency.value,
                category: category,
                date: DOM.expenseDate.value,
                notes: DOM.expenseNotes.value,
                ownerId: currentUserProfile.uid,
            };

            try {
                const id = DOM.expenseId.value;
                if (id) {
                    await updateDoc(doc(db, "trips", tripId, "expenses", id), expenseData);
                } else {
                    expenseData.createdAt = serverTimestamp();
                    await addDoc(collection(db, "trips", tripId, "expenses"), expenseData);
                }
                closeModal('expense-modal');
            } catch (error) {
                console.error("Error saving expense:", error);
            }
        }
        
        async function handleDeleteCategory() {
            const categoryToDelete = DOM.expenseCategory.value;
            if (!categoryToDelete || defaultCategories.includes(categoryToDelete)) {
                alert("×œ× × ×™×ª×Ÿ ×œ××—×•×§ ×§×˜×’×•×¨×™×™×ª ×‘×¨×™×¨×ª ××—×“×œ.");
                return;
            }
            if (confirm(`×”×× ×œ××—×•×§ ××ª ×”×§×˜×’×•×¨×™×” "${categoryToDelete}"?`)) {
                const updatedCategories = tripCategories.filter(c => c !== categoryToDelete);
                await setDoc(doc(db, "trips", tripId, "settings", "categories"), { list: updatedCategories });
            }
        }
        
        async function handleDeleteExpense(id) {
            if (confirm('×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ×”×•×¦××” ×–×•?')) {
                await deleteDoc(doc(db, "trips", tripId, "expenses", id));
            }
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            DOM.addExpenseBtnHeader.addEventListener('click', () => openExpenseModal());
            DOM.expenseForm.addEventListener('submit', handleExpenseFormSubmit);
            
            document.querySelectorAll('[data-close-modal]').forEach(btn => {
                btn.addEventListener('click', () => closeModal(btn.dataset.closeModal));
            });

            DOM.tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    activeTab = tab.dataset.tab;
                    DOM.tabs.forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    DOM.tabContents.forEach(c => c.classList.remove('active'));
                    document.getElementById(`tab-${activeTab}`).classList.add('active');
                    render();
                });
            });

            DOM.filters.forEach(filter => {
                filter.addEventListener('click', () => {
                    activeFilter = filter.dataset.filter;
                    DOM.filters.forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    render();
                });
            });

            document.getElementById('main-content').addEventListener('click', (e) => {
                const editBtn = e.target.closest('.edit-btn');
                const deleteBtn = e.target.closest('.delete-btn');
                if (editBtn) openExpenseModal({ id: editBtn.dataset.id });
                if (deleteBtn) handleDeleteExpense(deleteBtn.dataset.id);
            });

            DOM.expenseCategory.addEventListener('change', () => {
                const isAddNew = DOM.expenseCategory.value === 'add_new_category';
                DOM.newCategoryWrapper.classList.toggle('hidden', !isAddNew);
                
                const isCustom = !defaultCategories.includes(DOM.expenseCategory.value) && !isAddNew;
                DOM.deleteCategoryBtn.classList.toggle('hidden', !isCustom);
            });
            
            DOM.deleteCategoryBtn.addEventListener('click', handleDeleteCategory);
        }

        // --- Start ---
        initPage();
    </script>
</body>
</html>
