<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¨×©×™××•×ª, ×“×’×©×™× ×•×”×¢×¨×•×ª</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Assistant', sans-serif; }
    #sidebar { transition: transform .3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height .5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    /* details/summary */
    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
    .chevron-icon { transition: transform .3s ease-out; }
    details[open] > summary .chevron-icon { transform: rotate(180deg); }

    /* Custom checkboxes â€“ green when checked */
    .checklist-item input[type="checkbox"] { display: none; }
    .checklist-item .custom-checkbox{
      width:22px;height:22px;border:2px solid #38bdf8;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0;
    }
    .checklist-item .custom-checkbox .fa-check{font-size:14px;color:#fff;transform:scale(0);transition:transform .2s;}
    .checklist-item input:checked + label .custom-checkbox{background:#22c55e;border-color:#16a34a;}
    .checklist-item input:checked + label .custom-checkbox .fa-check{transform:scale(1);}
    .checklist-item input:checked + label .item-text{ text-decoration: line-through; color:#64748b; }

    .priority-3 { border-right: 4px solid #f43f5e; } /* High */
    .priority-2 { border-right: 4px solid #f97316; } /* Medium */
    .priority-1 { border-right: 4px solid #eab308; } /* Low  */

    .modal-step{display:none}
    .modal-step.active{display:block}

    /* Loader */
    #loader{position:fixed;inset:0;background:#f0f4f8;display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s ease}
    
    /* Preserve whitespace in notes */
    .note-content {
        white-space: pre-wrap;
    }
  </style>
</head>
<body class="bg-slate-50">
  <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image:url('https://i.imgur.com/IrS6mDW.jpeg')"></div>
  <div class="fixed inset-0 z-0 bg-black/50"></div>

  <div class="relative z-10">
    <div id="loader"><i class="fas fa-plane-departure fa-spin fa-3x text-blue-500"></i></div>

    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
      <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
        <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
        <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
      </div>
      <nav id="main-menu" class="p-4 space-y-2"></nav>
    </aside>

    <div id="main-content" class="min-h-screen">
      <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-4">
              <a id="home-link" href="index.html" class="p-2 text-slate-600 hover:text-blue-600" title="×“×£ ×”×‘×™×ª"><i class="fas fa-home fa-lg"></i></a>
              <h1 class="text-xl font-bold text-slate-800">×¨×©×™××•×ª ×•×“×’×©×™×</h1>
            </div>
            <div class="flex items-center gap-4">
              <div id="auth-container" class="flex items-center"></div>
              <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
            </div>
          </div>
        </div>
      </header>

      <main class="p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">ğŸ“ ×¡×“×¨ ×¢×•×©×™× ×‘×›×™×£</h2>
            <p class="mt-3 text-xl text-slate-200 max-w-2xl mx-auto">×›×œ ×”×¨×©×™××•×ª, ×”×“×’×©×™× ×•×”×”×¢×¨×•×ª ×œ×˜×™×•×œ, ××¡×•× ×›×¨× ×•×ª ×¢× ×›×•×œ× ×‘×–××Ÿ ×××ª.</p>
            <div class="mt-6 flex justify-center gap-4 flex-wrap">
              <button id="add-checklist-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i> ×”×•×¡×¤×ª ×¨×©×™××” ×—×“×©×”
              </button>
              <button id="add-note-btn" class="bg-teal-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-teal-700 transition-transform transform hover:scale-105">
                <i class="fas fa-lightbulb mr-2"></i> ×”×•×¡×¤×ª ×“×’×©/×”×¢×¨×”
              </button>
            </div>
          </div>
          <div id="content-container" class="space-y-8">
            <!-- Collapsible sections - now closed by default -->
            <details id="notes-section" class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden">
                <summary class="text-3xl font-bold text-slate-800 flex justify-between items-center p-6 bg-white/20 cursor-pointer">
                    <span>ğŸ’¡ ×“×’×©×™× ×•×”×¢×¨×•×ª</span>
                    <i class="fa-solid fa-chevron-down chevron-icon"></i>
                </summary>
                <div id="notes-container" class="p-4 space-y-4 bg-slate-50/80"></div>
            </details>

            <details id="checklists-section" class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden">
                <summary class="text-3xl font-bold text-slate-800 flex justify-between items-center p-6 bg-white/20 cursor-pointer">
                    <span>âœ… ×¦'×§ ×œ×™×¡×˜×™×</span>
                    <i class="fa-solid fa-chevron-down chevron-icon"></i>
                </summary>
                <div id="checklists-container" class="p-4 space-y-4 bg-slate-50/80"></div>
            </details>
          </div>
        </div>
      </main>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

    <!-- Checklist Modal -->
    <div id="checklist-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
          <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
          <button class="modal-close-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
          <div id="step-0" class="modal-step">
            <label for="checklist-name" class="block text-sm font-bold text-slate-700 mb-2">×©× ×”×¨×©×™××”</label>
            <input type="text" id="checklist-name" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-400 focus:border-blue-400" placeholder="×œ×“×•×’××”: ××¨×™×–×” ×œ×™×¢×“" />
          </div>
          <div id="step-1" class="modal-step">
            <label class="block text-sm font-bold text-slate-700 mb-2">×¡×•×’ ×¨×©×™××”</label>
            <select id="checklist-type" class="w-full p-3 border border-slate-300 rounded-lg">
              <option value="">-- ×‘×—×¨ --</option>
              <option value="×œ×¤× ×™ ×”×˜×™×•×œ">âœˆï¸ ×œ×¤× ×™ ×”×˜×™×•×œ</option>
              <option value="×œ×¤× ×™ ×™×¢×“">ğŸ—ºï¸ ×œ×¤× ×™ ×™×¢×“</option>
              <option value="×œ×¤× ×™ ××¢×‘×¨">ğŸšš ×œ×¤× ×™ ××¢×‘×¨</option>
              <option value="××—×¨">ğŸ“‹ ××—×¨</option>
            </select>
            <input type="text" id="checklist-type-other" class="w-full p-3 border border-slate-300 rounded-lg mt-2 hidden" placeholder="×©× ××•×ª×× ×œ×¡×•×’ ×”×¨×©×™××”" />
          </div>
          <div id="step-2" class="modal-step"></div>
          <div id="step-3" class="modal-step"></div>
          <div id="step-items" class="modal-step">
            <h4 class="text-lg font-bold text-slate-700 mb-3">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</h4>
            <div class="bg-slate-50 p-4 rounded-lg">
              <div class="flex flex-col md:grid md:grid-cols-5 gap-3">
                <input type="text" id="item-text" placeholder="×©× ×”×¤×¨×™×˜" class="md:col-span-2 p-2 border rounded-md" />
                <input type="number" id="item-quantity" placeholder="×›××•×ª" value="1" class="p-2 border rounded-md" />
                <input type="text" id="item-description" placeholder="×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)" class="p-2 border rounded-md" />
                <select id="item-priority" class="p-2 border rounded-md">
                  <option value="1">ğŸŸ¡ × ××•×›×”</option>
                  <option value="2" selected>ğŸŸ  ×‘×™× ×•× ×™×ª</option>
                  <option value="3">ğŸ”´ ×’×‘×•×”×”</option>
                </select>
              </div>
              <button id="add-item-btn" class="mt-3 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition w-full">×”×•×¡×£ ×¤×¨×™×˜</button>
            </div>
            <div id="items-preview-container" class="mt-4 space-y-2"></div>
          </div>
        </div>
        <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
          <button id="modal-back-btn" class="py-2 px-4 rounded-lg hover:bg-slate-200 transition hidden">××—×•×¨×”</button>
          <div id="modal-steps-indicator" class="text-sm text-slate-500"></div>
          <button id="modal-next-btn" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
          <button id="modal-finish-btn" class="py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition hidden">×©××•×¨ ×¨×©×™××”</button>
        </div>
      </div>
    </div>
    
    <!-- NEW: Note Modal with steps -->
    <div id="note-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="note-modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×“×’×©/×”×¢×¨×”</h3>
                <button class="modal-close-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <div id="note-step-0" class="modal-step">
                    <label for="note-title-input" class="block text-sm font-bold text-slate-700 mb-2">×›×•×ª×¨×ª ×”×”×¢×¨×”</label>
                    <input type="text" id="note-title-input" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="×œ×“×•×’××”: ×˜×™×¤×™× ×œ×ª×—×‘×•×¨×” ×¦×™×‘×•×¨×™×ª">
                </div>
                <div id="note-step-1" class="modal-step">
                    <label for="note-type-select" class="block text-sm font-bold text-slate-700 mb-2">×”×§×©×¨ ×”×”×¢×¨×”</label>
                    <select id="note-type-select" class="w-full p-3 border border-slate-300 rounded-lg">
                        <option value="">-- ×‘×—×¨ --</option>
                        <option value="×œ×¤× ×™ ×”×˜×™×•×œ">âœˆï¸ ×›×œ×œ×™ - ×œ×¤× ×™ ×”×˜×™×•×œ</option>
                        <option value="×œ×¤× ×™ ×™×¢×“">ğŸ—ºï¸ ×§×©×•×¨ ×œ×™×¢×“ ×¡×¤×¦×™×¤×™</option>
                    </select>
                </div>
                <div id="note-step-2" class="modal-step"></div> <!-- Dynamic content for destination/topic -->
                <div id="note-step-content" class="modal-step">
                    <label for="note-content-textarea" class="block text-sm font-bold text-slate-700 mb-2">×ª×•×›×Ÿ ×”×”×¢×¨×”</label>
                    <textarea id="note-content-textarea" rows="8" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="×›×ª×‘×• ×›××Ÿ ××ª ×›×œ ×”×¤×¨×˜×™× ×”×—×©×•×‘×™×..."></textarea>
                </div>
            </div>
            <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
                <button id="note-modal-back-btn" class="py-2 px-4 rounded-lg hover:bg-slate-200 transition hidden">××—×•×¨×”</button>
                <div id="note-modal-steps-indicator" class="text-sm text-slate-500"></div>
                <button id="note-modal-next-btn" class="py-2 px-4 bg-teal-600 text-white font-semibold rounded-lg hover:bg-teal-700 transition">×”×‘×</button>
                <button id="note-modal-finish-btn" class="py-2 px-6 bg-teal-600 text-white font-bold rounded-lg hover:bg-teal-700 transition hidden">×©××•×¨ ×”×¢×¨×”</button>
            </div>
        </div>
    </div>


    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center">
      <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full">
        <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
        <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§?</h3>
        <p id="delete-modal-text" class="text-slate-600 mb-6">×”×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”.</p>
        <div class="flex justify-center gap-4">
          <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
          <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc,
      serverTimestamp, query, orderBy, getDoc, enableIndexedDbPersistence
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // --- Firebase (××•×ª×• ×¤×¨×•×™×§×˜ ×©×œ ×”××¤×œ×™×§×¦×™×”) ---
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- ×”×•×¡×¤×ª ×™×›×•×œ×•×ª ××•×¤×œ×™×™×Ÿ ---
    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.warn("Persistence × ×›×©×œ â€“ ×™×© ×™×•×ª×¨ ××“×™ ×˜××‘×™× ×¤×ª×•×—×™×.");
      } else if (err.code === 'unimplemented') {
        console.warn("×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘Ö¾Persistence.");
      }
    });

    // --- URL params ---
    const params = new URLSearchParams(location.search);
    const tripId = params.get('tripId');

    if (!tripId) {
      alert('×—×¡×¨ tripId ×‘×›×ª×•×‘×ª.');
      location.href = 'index.html';
    }

    // --- DOM ---
    const loader = document.getElementById('loader');
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');
    const mainMenu = document.getElementById('main-menu');
    const homeLink = document.getElementById('home-link');
    const authContainer = document.getElementById('auth-container');
    const addChecklistBtn = document.getElementById('add-checklist-btn');
    const checklistsContainer = document.getElementById('checklists-container');
    const notesContainer = document.getElementById('notes-container');
    const addNoteBtn = document.getElementById('add-note-btn');

    // Checklist Modal DOM
    const checklistModal = document.getElementById('checklist-modal');
    const modalTitle = document.getElementById('modal-title');
    const modalBackBtn = document.getElementById('modal-back-btn');
    const modalNextBtn = document.getElementById('modal-next-btn');
    const modalFinishBtn = document.getElementById('modal-finish-btn');
    const stepsIndicator = document.getElementById('modal-steps-indicator');
    const nameInput = document.getElementById('checklist-name');
    const typeSelect = document.getElementById('checklist-type');
    const typeOtherInput = document.getElementById('checklist-type-other');
    const step2 = document.getElementById('step-2');
    const step3 = document.getElementById('step-3');
    const itemsPreview = document.getElementById('items-preview-container');
    const addItemBtn = document.getElementById('add-item-btn');

    // Note Modal DOM
    const noteModal = document.getElementById('note-modal');
    const noteModalTitle = document.getElementById('note-modal-title');
    const noteTitleInput = document.getElementById('note-title-input');
    const noteTypeSelect = document.getElementById('note-type-select');
    const noteContentTextarea = document.getElementById('note-content-textarea');
    const noteModalBackBtn = document.getElementById('note-modal-back-btn');
    const noteModalNextBtn = document.getElementById('note-modal-next-btn');
    const noteModalFinishBtn = document.getElementById('note-modal-finish-btn');
    const noteStepsIndicator = document.getElementById('note-modal-steps-indicator');
    const noteStep2 = document.getElementById('note-step-2');

    
    // --- State ---
    let currentUser = null;
    let tripData = null;

    let checklistsData = [];
    let notesData = [];
    let editingChecklistId = null;
    let editingNoteId = null;
    
    // Checklist Modal State
    let currentModalStep = 0;
    let modalItems = [];
    let numQuestionSteps = 0;
    
    // Note Modal State
    let currentNoteModalStep = 0;
    let numNoteQuestionSteps = 0;


    // --- Helpers: dates formatting for sidebar ---
    function parseDDMMYYYY(s){ const [d,m,y] = s.split('/').map(Number); return new Date(y, m-1, d); }
    function hebWeekday(d){
      const n = d.toLocaleDateString('he-IL', { weekday:'long' });
      return n.startsWith('×™×•×') ? n : `×™×•× ${n}`;
    }
    function dotted(d){ return `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`; }
    function generateDatesFromRange(rangeStr) {
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [s,e] = rangeStr.split(' - ');
      const [sd, sm, sy] = s.split('/').map(Number);
      const [ed, em, ey] = e.split('/').map(Number);
      const start = new Date(sy, sm-1, sd);
      const end   = new Date(ey, em-1, ed);
      const out = [];
      let cur = new Date(start);
      while (cur <= end) {
        const dd = String(cur.getDate()).padStart(2,'0');
        const mm = String(cur.getMonth()+1).padStart(2,'0');
        out.push(`${dd}/${mm}/${cur.getFullYear()}`);
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }

    function toggleSidebar(){
      sidebar.classList.toggle('translate-x-full');
      overlay.classList.toggle('hidden');
    }

    function buildSidebarMenu(){
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;

      tripData.destinations.forEach(dest=>{
        const wrap = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe}</span><i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div');
        submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        const dates = generateDatesFromRange(dest.dates);
        dates.forEach(dstr=>{
          const d = parseDDMMYYYY(dstr);
          const a = document.createElement('a');
          a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dstr)}`;
          a.className = 'block w-full text-right p-3 pr-4 rounded-md transition-colors hover:bg-sky-50';
          a.innerHTML = `
            <div class="flex flex-col">
              <span class="text-slate-700 text-sm font-bold">${hebWeekday(d)} â€“ (${dest.nameHe})</span>
              <span class="text-slate-500 text-xs">${dotted(d)}</span>
            </div>`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', ()=>{
          submenu.classList.toggle('open');
          btn.querySelector('i').classList.toggle('rotate-180');
        });
        wrap.append(btn, submenu);
        mainMenu.appendChild(wrap);
      });
    }

    // --- Auth & initial load ---
    onAuthStateChanged(auth, async (user)=>{
      if (!user) { location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`; return; }
      currentUser = user;

      try{
        const udoc = await getDoc(doc(db,'users', user.uid));
        const name = udoc.exists() ? (udoc.data().name || '××©×ª××©') : '××©×ª××©';
        authContainer.innerHTML = `
          <span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${name} ğŸ‘‹</span>
          <button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', ()=>signOut(auth));
      }catch{}

      await loadTripAndCheckPermissions();
    });

    async function loadTripAndCheckPermissions(){
      const tdoc = await getDoc(doc(db,'trips', tripId));
      if (tdoc.exists()) {
        const data = tdoc.data();
        const canAccess = data.editors && data.editors.includes(currentUser.uid);
        if (canAccess) {
            tripData = data;
            document.getElementById('home-link').href = `trip.html?id=${tripId}`;
            buildSidebarMenu();
            initRealtimeListeners();
            loader.style.opacity = '0';
            setTimeout(()=> loader.style.display = 'none', 500);
        } else {
            alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.');
            location.href = 'index.html';
        }
      } else {
        alert('×”×˜×™×•×œ ×œ× × ××¦×.');
        location.href='index.html';
      }
    }

    // --- Firestore paths ---
    const checklistsCol = collection(db, 'trips', tripId, 'checklists');
    const notesCol = collection(db, 'trips', tripId, 'notes');

    function initRealtimeListeners(){
      const qChecklists = query(checklistsCol, orderBy('createdAt','desc'));
      onSnapshot(qChecklists, (snap)=>{
        checklistsData = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderChecklists();
      }, (err)=>{
        console.error(err);
        checklistsContainer.innerHTML = `<div class="text-center p-10 bg-red-100 text-red-700 rounded-lg">×©×’×™××” ×‘×˜×¢×™× ×ª ×¨×©×™××•×ª.</div>`;
      });
      
      const qNotes = query(notesCol, orderBy('createdAt','desc'));
      onSnapshot(qNotes, (snap)=>{
        notesData = snap.docs.map(d=>({id:d.id, ...d.data()}));
        renderNotes();
      }, (err)=>{
        console.error(err);
        notesContainer.innerHTML = `<div class="text-center p-10 bg-red-100 text-red-700 rounded-lg">×©×’×™××” ×‘×˜×¢×™× ×ª ×“×’×©×™×.</div>`;
      });
    }
    
    // --- Grouping helper ---
    const groupBy = (arr, key, fallback='×›×œ×œ×™') => arr.reduce((r,v)=>{
        const k = v[key] || fallback; (r[k] = r[k] || []).push(v); return r;
    },{});

    const getEmoji = (category, value)=>{
      const map = {
        types: {'×œ×¤× ×™ ×”×˜×™×•×œ':'âœˆï¸','×œ×¤× ×™ ×™×¢×“':'ğŸ—ºï¸','×œ×¤× ×™ ××¢×‘×¨':'ğŸšš','××—×¨':'ğŸ“‹'},
        topics:{'×‘×’×“×™×':'ğŸ‘•','××¡××›×™×':'ğŸ“„','×§× ×™×•×ª':'ğŸ›’','×¦×™×•×“':'ğŸ’','×”×–×× ×•×ª':'ğŸŸï¸','××™×©×•×¨×™×':'âœ”ï¸'}
      };
      if (!value || !map[category]) return '';
      const key = Object.keys(map[category]).find(k => value.includes(k));
      return key ? map[category][key] : '';
    };

    // --- Rendering ---
    function renderNotes() {
        if (notesData.length === 0) {
            notesContainer.innerHTML =
              `<div class="text-center p-16 bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm">
                  <i class="fas fa-folder-open fa-4x text-slate-400 mb-6"></i>
                  <h3 class="text-2xl font-bold text-slate-700">×¢×“×™×™×Ÿ ××™×Ÿ ×“×’×©×™×...</h3>
                  <p class="text-slate-500 mt-2">×œ×—×¦×• "×”×•×¡×¤×ª ×“×’×©/×”×¢×¨×”" ×›×“×™ ×œ×”×ª×—×™×œ.</p>
                 </div>`;
            return;
        }

        const byType = groupBy(notesData, 'type');
        let html = '';
        for(const type of Object.keys(byType).sort()) {
            const notesInType = byType[type];
            const byDest = groupBy(notesInType, 'destination');
            for(const dest of Object.keys(byDest).sort()) {
                const notesInDest = byDest[dest];
                const header = type === '×œ×¤× ×™ ×™×¢×“' ? `×™×¢×“: ${dest}` : `${type}`;
                const emoji = type === '×œ×¤× ×™ ×™×¢×“' ? 'ğŸ—ºï¸' : 'âœˆï¸';
                
                html += `<details class="bg-white/90 rounded-xl shadow-md" open><summary class="text-xl font-bold text-slate-700 flex justify-between items-center p-4">
                        <span>${emoji} ${header}</span><i class="fa-solid fa-chevron-down chevron-icon text-lg"></i></summary>
                        <div class="p-3 pt-3 border-t space-y-3">`;
                
                notesInDest.forEach(note => {
                    html += `
                        <div class="bg-white/80 p-4 rounded-xl shadow-sm border border-slate-200">
                            <div class="flex justify-between items-start mb-3">
                                <h4 class="text-lg font-bold text-teal-700">${note.title}</h4>
                                <div class="flex-shrink-0">
                                    <button class="edit-note-btn p-2 text-slate-500 hover:text-blue-600" data-note-id="${note.id}"><i class="fas fa-pencil-alt"></i></button>
                                    <button class="delete-note-btn p-2 text-slate-500 hover:text-red-600" data-note-id="${note.id}"><i class="fas fa-trash-alt"></i></button>
                                </div>
                            </div>
                            <div class="text-slate-700 note-content">${note.content}</div>
                        </div>
                    `;
                });
                html += `</div></details>`;
            }
        }
        notesContainer.innerHTML = html;
    }

    function renderChecklists(){
      if (checklistsData.length === 0){
        checklistsContainer.innerHTML =
          `<div class="text-center p-16 bg-white/80 backdrop-blur-sm rounded-2xl shadow-sm">
            <i class="fas fa-folder-open fa-4x text-slate-400 mb-6"></i>
            <h3 class="text-2xl font-bold text-slate-700">×¢×“×™×™×Ÿ ××™×Ÿ ×¨×©×™××•×ª...</h3>
            <p class="text-slate-500 mt-2">×œ×—×¦×• "×”×•×¡×¤×ª ×¨×©×™××” ×—×“×©×”" ×›×“×™ ×œ×”×ª×—×™×œ.</p>
           </div>`;
        return;
      }

      const byType = groupBy(checklistsData,'type');
      let html = '';
      for (const type of Object.keys(byType).sort()){
        const listsInType = byType[type];
        const typeEmoji = getEmoji('types', type);
        html += `<details class="bg-white/90 rounded-xl shadow-md" open>
          <summary class="text-2xl font-bold text-slate-800 flex justify-between items-center p-5">
            <span>${typeEmoji} ${type || '×›×œ×œ×™'}</span><i class="fa-solid fa-chevron-down chevron-icon"></i>
          </summary>
          <div class="p-4 space-y-4 bg-slate-50/80">`;
        const byDest = groupBy(listsInType,'destination');
        for (const dest of Object.keys(byDest).sort()){
          const listsInDest = byDest[dest];
          const isOnlyGeneral = Object.keys(byDest).length===1 && dest==='×›×œ×œ×™';
          html += `<div class="${isOnlyGeneral ? '' : 'bg-white/90 rounded-xl shadow-md p-4'}">`;
          if (!isOnlyGeneral){
            html += `<h3 class="text-xl font-bold text-slate-700 mb-3">×™×¢×“: ${dest}</h3>`;
          }
          const byTopic = groupBy(listsInDest,'subType');
          for (const topic of Object.keys(byTopic).sort()){
            const listsInTopic = byTopic[topic];
            listsInTopic.forEach(list => { html += renderSingleChecklist(list); });
          }
          html += `</div>`;
        }
        html += `</div></details>`;
      }
      checklistsContainer.innerHTML = html;
    }

    function renderSingleChecklist(list){
      const sortedItems = (list.items||[]).slice().sort((a,b)=>(b.priority||0)-(a.priority||0));
      const itemsHtml = sortedItems.map((item,index)=>`
        <div class="checklist-item bg-white p-3 rounded-lg flex items-center gap-4 hover:bg-sky-50 transition-colors duration-200 ${'priority-'+(item.priority||1)}">
          <input type="checkbox" id="item-${list.id}-${index}" data-list-id="${list.id}" data-item-index="${index}" ${item.checked?'checked':''}>
          <label for="item-${list.id}-${index}" class="flex-grow flex items-center gap-4 text-slate-700 cursor-pointer">
            <div class="custom-checkbox"><i class="fas fa-check"></i></div>
            <div class="item-text">
              <span class="font-semibold">${item.text}</span> <span class="text-sm text-slate-500">(x${item.quantity||1})</span>
              ${item.description ? `<p class="text-sm text-slate-500">${item.description}</p>` : ''}
            </div>
          </label>
        </div>`).join('');

      return `
        <div class="bg-white/80 p-4 rounded-xl shadow-sm border border-slate-200 mb-3">
          <div class="flex justify-between items-center mb-3">
            <h4 class="text-lg font-bold text-blue-700">${list.name}</h4>
            <div>
              <button class="edit-btn p-2 text-slate-500 hover:text-blue-600" data-list-id="${list.id}"><i class="fas fa-pencil-alt"></i></button>
              <button class="delete-btn p-2 text-slate-500 hover:text-red-600" data-list-id="${list.id}"><i class="fas fa-trash-alt"></i></button>
            </div>
          </div>
          <div class="space-y-2">${itemsHtml || '<p class="text-center text-slate-400 p-4">××™×Ÿ ×¤×¨×™×˜×™× ×‘×¨×©×™××” ×–×•.</p>'}</div>
        </div>`;
    }

    // --- Modals Logic ---
    function openModal(list=null){
      editingChecklistId = list ? list.id : null;
      modalTitle.textContent = list ? '×¢×¨×™×›×ª ×¨×©×™××”' : '×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”';
      nameInput.value = list?.name || '';
      typeSelect.value = list?.type || '';
      typeOtherInput.classList.toggle('hidden', typeSelect.value !== '××—×¨');
      modalItems = list?.items ? JSON.parse(JSON.stringify(list.items)) : [];
      renderModalItems();
      currentModalStep = 0;
      updateModalStep(true);
      checklistModal.classList.add('flex'); checklistModal.classList.remove('hidden');
    }
    
    function openNoteModal(note=null){
        editingNoteId = note ? note.id : null;
        noteModalTitle.textContent = note ? '×¢×¨×™×›×ª ×”×¢×¨×”' : '×™×¦×™×¨×ª ×”×¢×¨×” ×—×“×©×”';
        noteTitleInput.value = note?.title || '';
        noteTypeSelect.value = note?.type || '';
        noteContentTextarea.value = note?.content || '';
        
        currentNoteModalStep = 0;
        updateNoteModalStep(true, note);
        noteModal.classList.add('flex'); noteModal.classList.remove('hidden');
    }
    
    function closeModal(){ 
        checklistModal.classList.add('hidden'); checklistModal.classList.remove('flex'); 
        noteModal.classList.add('hidden'); noteModal.classList.remove('flex');
    }

    // --- Checklist Modal Steps ---
    function updateModalStep(isOpening=false){
      const type = typeSelect.value;
      if (type.includes('×™×¢×“') || type.includes('××¢×‘×¨')) numQuestionSteps = 4;
      else if (type.includes('×”×˜×™×•×œ')) numQuestionSteps = 3;
      else numQuestionSteps = 2;
      if (isOpening) currentModalStep = 0;
      
      document.querySelectorAll('#checklist-modal .modal-step').forEach(s=>s.classList.remove('active'));
      const isLast = currentModalStep >= numQuestionSteps;
      const curId = isLast ? 'step-items' : `step-${currentModalStep}`;
      document.getElementById(curId).classList.add('active');

      modalBackBtn.classList.toggle('hidden', currentModalStep===0);
      modalNextBtn.classList.toggle('hidden', isLast);
      modalFinishBtn.classList.toggle('hidden', !isLast);
      stepsIndicator.textContent = `×©×œ×‘ ${currentModalStep+1} ××ª×•×š ${numQuestionSteps+1}`;
      if (currentModalStep === 1) genStep2();
      if (currentModalStep === 2) genStep3();
    }
    function genStep2(){
      const type = typeSelect.value;
      let html = '';
      if (type.includes('×”×˜×™×•×œ')){
        html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ × ×•×©×</label><select id="checklist-subtype" class="w-full p-3 border rounded-lg"><option>ğŸ‘• ×‘×’×“×™×</option><option>ğŸ“„ ××¡××›×™×</option><option>ğŸŸï¸ ×”×–×× ×•×ª</option><option>ğŸ›’ ×§× ×™×•×ª</option><option>ğŸ’ ×¦×™×•×“</option><option value="××—×¨">××—×¨</option></select><input type="text" id="checklist-subtype-other" class="w-full p-3 border rounded-lg mt-2 hidden" placeholder="× ×•×©× ××•×ª××" />`;
      } else if (type.includes('×™×¢×“') || type.includes('××¢×‘×¨')){
        const options = (tripData?.destinations||[]).map(d=>`<option value="${d.nameHe}">${d.nameHe}</option>`).join('');
        html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ ×™×¢×“</label><select id="checklist-destination" class="w-full p-3 border rounded-lg">${options}</select>`;
      }
      step2.innerHTML = html;
    }
    function genStep3(){
      const type = typeSelect.value;
      let html = '';
      if (type.includes('×™×¢×“')){
        html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ × ×•×©× ×œ×™×¢×“</label><select id="checklist-subtype" class="w-full p-3 border rounded-lg"><option>ğŸ‘• ×‘×’×“×™×</option><option>ğŸ“„ ××¡××›×™× ×œ×™×¢×“</option><option>ğŸ’ ×¦×™×•×“ × ×“×¨×©</option><option value="××—×¨">××—×¨</option></select><input type="text" id="checklist-subtype-other" class="w-full p-3 border rounded-lg mt-2 hidden" placeholder="× ×•×©× ××•×ª××" />`;
      } else if (type.includes('××¢×‘×¨')){
        html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ × ×•×©× ×œ××¢×‘×¨</label><select id="checklist-subtype" class="w-full p-3 border rounded-lg"><option>ğŸ“„ ××™×©×•×¨×™×</option><option>ğŸ›’ ×§× ×™×•×ª</option><option>ğŸ‘• ×‘×’×“×™×</option></select>`;
      }
      step3.innerHTML = html;
    }
    function renderModalItems(){
      itemsPreview.innerHTML = modalItems.length===0 ? `<p class="text-center text-slate-500">××™×Ÿ ×¤×¨×™×˜×™×.</p>` : modalItems.map((it,i)=>`
          <div class="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm">
            <span>${it.text} (x${it.quantity||1})</span>
            <button class="remove-item-btn text-red-500 hover:text-red-700" data-index="${i}"><i class="fas fa-times-circle"></i></button>
          </div>`).join('');
    }

    // --- Note Modal Steps ---
    function updateNoteModalStep(isOpening = false, note = null) {
        const type = noteTypeSelect.value;
        if (type.includes('×™×¢×“')) numNoteQuestionSteps = 3;
        else numNoteQuestionSteps = 2;

        if (isOpening) currentNoteModalStep = 0;

        document.querySelectorAll('#note-modal .modal-step').forEach(s => s.classList.remove('active'));
        
        const isLast = currentNoteModalStep >= numNoteQuestionSteps;
        const curId = isLast ? 'note-step-content' : `note-step-${currentNoteModalStep}`;
        document.getElementById(curId).classList.add('active');

        noteModalBackBtn.classList.toggle('hidden', currentNoteModalStep === 0);
        noteModalNextBtn.classList.toggle('hidden', isLast);
        noteModalFinishBtn.classList.toggle('hidden', !isLast);
        noteStepsIndicator.textContent = `×©×œ×‘ ${currentNoteModalStep + 1} ××ª×•×š ${numNoteQuestionSteps + 1}`;

        if (currentNoteModalStep === 2) {
            genNoteStep2(note);
        }
    }

    function genNoteStep2(note = null) {
        const type = noteTypeSelect.value;
        let html = '';
        if (type.includes('×™×¢×“')) {
            const options = (tripData?.destinations || []).map(d => `<option value="${d.nameHe}" ${note?.destination === d.nameHe ? 'selected' : ''}>${d.nameHe}</option>`).join('');
            html = `<label class="block text-sm font-bold text-slate-700 mb-2">×œ××™×–×” ×™×¢×“ ××ª×™×™×—×¡×ª ×”×”×¢×¨×”?</label><select id="note-destination" class="w-full p-3 border rounded-lg">${options}</select>`;
        }
        noteStep2.innerHTML = html;
    }


    async function finishChecklistModal(){
      const name = nameInput.value.trim();
      if (!name) return alert('×™×© ×œ×”×–×™×Ÿ ×©× ×œ×¨×©×™××”.');
      let type = typeSelect.value;
      if (type === '××—×¨') type = typeOtherInput.value.trim() || '××—×¨';
      let subType = document.getElementById('checklist-subtype')?.value || null;
      if (subType === '××—×¨') subType = document.getElementById('checklist-subtype-other')?.value || '××—×¨';
      let destination = document.getElementById('checklist-destination')?.value || null;
      const payload = { name, type, destination, subType, items: modalItems, updatedAt: serverTimestamp() };
      try{
        if (editingChecklistId){
          await updateDoc(doc(db,'trips', tripId, 'checklists', editingChecklistId), payload);
        } else {
          payload.createdAt = serverTimestamp();
          await addDoc(checklistsCol, payload);
        }
        closeModal();
      }catch(e){ console.error(e); alert('×©×’×™××” ×‘×©××™×¨×ª ×”×¨×©×™××”.'); }
    }
    
    async function finishNoteModal(){
        const title = noteTitleInput.value.trim();
        const content = noteContentTextarea.value.trim();
        if (!title || !content) return alert('×™×© ×œ××œ× ×›×•×ª×¨×ª ×•×ª×•×›×Ÿ ×œ×”×¢×¨×”.');
        
        const type = noteTypeSelect.value;
        const destination = type === '×œ×¤× ×™ ×™×¢×“' ? document.getElementById('note-destination')?.value : null;

        const payload = { title, content, type, destination, updatedAt: serverTimestamp() };
        
        try {
            if (editingNoteId) {
                await updateDoc(doc(db, 'trips', tripId, 'notes', editingNoteId), payload);
            } else {
                payload.createdAt = serverTimestamp();
                await addDoc(notesCol, payload);
            }
            closeModal();
        } catch(e) { console.error(e); alert('×©×’×™××” ×‘×©××™×¨×ª ×”×”×¢×¨×”.'); }
    }

    // --- Events ---
    hamburgerBtn.addEventListener('click', toggleSidebar);
    closeSidebarBtn.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);

    addChecklistBtn.addEventListener('click', ()=> openModal());
    addNoteBtn.addEventListener('click', ()=> openNoteModal());
    
    document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', closeModal));

    // Checklist modal events
    modalBackBtn.addEventListener('click', ()=>{ if (currentModalStep>0){ currentModalStep--; updateModalStep(); }});
    modalNextBtn.addEventListener('click', ()=>{ currentModalStep++; updateModalStep(); });
    modalFinishBtn.addEventListener('click', finishChecklistModal);
    typeSelect.addEventListener('change', (e)=>{
      typeOtherInput.classList.toggle('hidden', e.target.value!=='××—×¨');
      updateModalStep();
    });
    document.getElementById('checklist-modal').addEventListener('change', e=>{
      if (e.target.id==='checklist-subtype'){
        const other = document.getElementById('checklist-subtype-other');
        if (other) other.classList.toggle('hidden', e.target.value!=='××—×¨');
      }
    });
    addItemBtn.addEventListener('click', ()=>{
      const t = document.getElementById('item-text');
      if (!t.value.trim()) return;
      modalItems.push({ text: t.value.trim(), quantity: Number(document.getElementById('item-quantity').value || 1), description: document.getElementById('item-description').value.trim(), priority: Number(document.getElementById('item-priority').value || 2), checked: false });
      renderModalItems();
      ['item-text','item-description'].forEach(id=>document.getElementById(id).value='');
      document.getElementById('item-quantity').value = 1;
      t.focus();
    });
    itemsPreview.addEventListener('click', e=>{
      const btn = e.target.closest('.remove-item-btn');
      if (!btn) return;
      modalItems.splice(Number(btn.dataset.index),1);
      renderModalItems();
    });

    // Note modal events
    noteModalBackBtn.addEventListener('click', () => { if (currentNoteModalStep > 0) { currentNoteModalStep--; updateNoteModalStep(); }});
    noteModalNextBtn.addEventListener('click', () => { currentNoteModalStep++; updateNoteModalStep(); });
    noteModalFinishBtn.addEventListener('click', finishNoteModal);
    noteTypeSelect.addEventListener('change', () => {
        updateNoteModalStep();
    });


    // Delegated events for content containers
    checklistsContainer.addEventListener('change', async e=>{
      if (e.target.type!=='checkbox') return;
      const listId = e.target.dataset.listId, idx = Number(e.target.dataset.itemIndex);
      const list = checklistsData.find(l=>l.id===listId);
      if (!list) return;
      const items = list.items ? list.items.slice() : [];
      if (!items[idx]) return;
      items[idx].checked = e.target.checked;
      await updateDoc(doc(db,'trips', tripId, 'checklists', listId), { items });
    });

    checklistsContainer.addEventListener('click', e=>{
      const del = e.target.closest('.delete-btn');
      const edit = e.target.closest('.edit-btn');
      if (del){
        const list = checklistsData.find(x=>x.id===del.dataset.listId);
        if(list) showDeleteModal(`×œ××—×•×§ ××ª "${list.name}"?`, () => deleteDoc(doc(db,'trips', tripId, 'checklists', list.id)));
      }
      if (edit){
        const list = checklistsData.find(x=>x.id===edit.dataset.listId);
        if (list) openModal(list);
      }
    });
    
    notesContainer.addEventListener('click', e=>{
      const del = e.target.closest('.delete-note-btn');
      const edit = e.target.closest('.edit-note-btn');
      if (del){
        const note = notesData.find(x=>x.id===del.dataset.noteId);
        if(note) showDeleteModal(`×œ××—×•×§ ××ª "${note.title}"?`, () => deleteDoc(doc(db,'trips', tripId, 'notes', note.id)));
      }
      if (edit){
        const note = notesData.find(x=>x.id===edit.dataset.noteId);
        if (note) openNoteModal(note);
      }
    });
    
    function showDeleteModal(title, onConfirm) {
        const delModal = document.getElementById('delete-modal');
        const confirmBtn = document.getElementById('delete-modal-confirm');
        const cancelBtn = document.getElementById('delete-modal-cancel');
        document.getElementById('delete-modal-title').textContent = title;
        
        const close = () => {
            delModal.classList.add('hidden');
            delModal.classList.remove('flex');
            // Remove old listeners by replacing the node
            confirmBtn.replaceWith(confirmBtn.cloneNode(true));
            cancelBtn.replaceWith(cancelBtn.cloneNode(true));
        };
        
        const newConfirm = document.getElementById('delete-modal-confirm');
        const newCancel = document.getElementById('delete-modal-cancel');
        
        newConfirm.addEventListener('click', async () => {
            await onConfirm();
            close();
        });
        newCancel.addEventListener('click', close);

        delModal.classList.remove('hidden');
        delModal.classList.add('flex');
    }

  </script>
</body>
</html>