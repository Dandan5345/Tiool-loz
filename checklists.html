<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>×¨×©×™××•×ª, ×“×’×©×™× ×•×”×¢×¨×•×ª</title>

  <script src="https://cdn.tailwindcss.com"></script>

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet" />

  <style>
    body { font-family: 'Assistant', sans-serif; }
    #sidebar { transition: transform .3s ease-in-out; }
    .submenu { max-height: 0; overflow: hidden; transition: max-height .5s ease-in-out; }
    .submenu.open { max-height: 1200px; }
    details > summary { list-style: none; cursor: pointer; }
    details > summary::-webkit-details-marker { display: none; }
    .chevron-icon { transition: transform .3s ease-out; }
    details[open] > summary .chevron-icon { transform: rotate(180deg); }

    .checklist-item input[type="checkbox"] { display: none; }
    .checklist-item .custom-checkbox{ width:22px;height:22px;border:2px solid #38bdf8;border-radius:6px;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0; }
    .checklist-item .custom-checkbox .fa-check{font-size:14px;color:#fff;transform:scale(0);transition:transform .2s;}
    .checklist-item input:checked + label .custom-checkbox{background:#22c55e;border-color:#16a34a;}
    .checklist-item input:checked + label .custom-checkbox .fa-check{transform:scale(1);}
    .checklist-item input:checked + label .item-text{ text-decoration: line-through; color:#64748b; }

    .priority-3 { border-right: 4px solid #f43f5e; } /* High */
    .priority-2 { border-right: 4px solid #f97316; } /* Medium */
    .priority-1 { border-right: 4px solid #eab308; } /* Low   */

    .modal-step{display:none}
    .modal-step.active{display:block}

    #loader{position:fixed;inset:0;background:#f0f4f8;display:flex;align-items:center;justify-content:center;z-index:1000;transition:opacity .5s ease}

    .color-picker-btn { width: 40px; height: 40px; border-radius: 9999px; cursor: pointer; border: 3px solid transparent; transition: all 0.2s ease; }
    .color-picker-btn.selected { border-color: #0c4a6e; transform: scale(1.1); box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    .note-card { cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; }
    .note-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
  </style>
</head>
<body>
  <div class="fixed inset-0 z-0 bg-cover bg-center" style="background-image:url('https://i.imgur.com/IrS6mDW.jpeg')"></div>
  <div class="fixed inset-0 z-0 bg-black/50"></div>

  <div class="relative z-10">
    <div id="loader"><i class="fas fa-plane-departure fa-spin fa-3x text-blue-500"></i></div>

    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
      <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
        <h2 class="text-2xl font-bold text-slate-800">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
        <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
      </div>
      <nav id="main-menu" class="p-4 space-y-2"></nav>
    </aside>

    <div id="main-content" class="min-h-screen">
      <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
        <div class="container mx-auto px-4 sm:px-6 lg:px-8">
          <div class="flex items-center justify-between h-16">
            <div class="flex items-center gap-4">
              <a id="home-link" href="index.html" class="p-2 text-slate-600 hover:text-blue-600" title="×“×£ ×”×‘×™×ª"><i class="fas fa-home fa-lg"></i></a>
              <h1 class="text-xl font-bold text-slate-800">×¨×©×™××•×ª ×•×“×’×©×™×</h1>
            </div>
            <div class="flex items-center gap-4">
              <div id="auth-container" class="flex items-center"></div>
              <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
            </div>
          </div>
        </div>
      </header>

      <main class="p-4 sm:p-6 lg:p-8">
        <div class="max-w-6xl mx-auto">
          <div class="text-center mb-12">
            <h2 class="text-5xl font-extrabold text-white drop-shadow-lg">âœ… ×¡×“×¨ ×¢×•×©×™× ×‘×›×™×£</h2>
            <p class="mt-3 text-xl text-slate-200 max-w-2xl mx-auto">×›×œ ×”×¨×©×™××•×ª, ×”×“×’×©×™× ×•×”×”×¢×¨×•×ª ×œ×˜×™×•×œ, ××¡×•× ×›×¨× ×™× ×¢× ×›×•×œ× ×‘×–××Ÿ ×××ª.</p>
            <div class="flex flex-wrap justify-center gap-4 mt-6">
              <button id="add-checklist-btn" class="bg-blue-600 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                <i class="fas fa-plus mr-2"></i> ×”×•×¡×¤×ª ×¨×©×™××” ×—×“×©×”
              </button>
              <button id="add-note-btn" class="bg-amber-500 text-white font-bold py-3 px-8 rounded-full shadow-lg hover:bg-amber-600 transition-transform transform hover:scale-105">
                <i class="fas fa-lightbulb mr-2"></i> ×”×•×¡×¤×ª ×“×’×©/×”×¢×¨×”
              </button>
            </div>
          </div>
          <div id="content-container" class="space-y-8">
            <details id="notes-wrapper" class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden">
              <summary class="text-2xl font-bold text-slate-800 flex justify-between items-center p-5 cursor-pointer">
                <span>ğŸ’¡ ×“×’×©×™× ×•×”×¢×¨×•×ª</span><i class="fa-solid fa-chevron-down chevron-icon"></i>
              </summary>
              <div id="notes-container" class="p-4 space-y-4 bg-slate-50/80"></div>
            </details>
            <details id="checklists-wrapper" class="bg-white/90 backdrop-blur-sm rounded-2xl shadow-lg overflow-hidden">
              <summary class="text-2xl font-bold text-slate-800 flex justify-between items-center p-5 cursor-pointer">
                <span>ğŸ“‹ ×¦'×§-×œ×™×¡×˜×™×</span><i class="fa-solid fa-chevron-down chevron-icon"></i>
              </summary>
              <div id="checklists-container" class="p-4 space-y-4 bg-slate-50/80"></div>
            </details>
          </div>
        </div>
      </main>
    </div>

    <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>

    <!-- Checklist Modal -->
    <div id="checklist-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
      <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
        <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
          <h3 id="modal-title" class="text-2xl font-bold text-slate-800">×™×¦×™×¨×ª ×¨×©×™××” ×—×“×©×”</h3>
          <button class="modal-close-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
        </div>
        <div class="p-6 space-y-6 overflow-y-auto">
            <div id="checklist-step-0" class="modal-step">
                <label for="checklist-name" class="block text-sm font-bold text-slate-700 mb-2">×©× ×”×¨×©×™××”</label>
                <input type="text" id="checklist-name" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="×œ×“×•×’××”: ××¨×™×–×” ×œ×™×¢×“" />
            </div>
            <div id="checklist-step-1" class="modal-step">
                <label class="block text-sm font-bold text-slate-700 mb-2">×¡×•×’ ×¨×©×™××”</label>
                <select id="checklist-type" class="w-full p-3 border border-slate-300 rounded-lg">
                    <option value="">-- ×‘×—×¨ --</option> <option value="×œ×¤× ×™ ×”×˜×™×•×œ">âœˆï¸ ×œ×¤× ×™ ×”×˜×™×•×œ</option> <option value="×œ×¤× ×™ ×™×¢×“">ğŸ—ºï¸ ×œ×¤× ×™ ×™×¢×“</option> <option value="×œ×¤× ×™ ××¢×‘×¨">ğŸšš ×œ×¤× ×™ ××¢×‘×¨</option> <option value="××—×¨">ğŸ“‹ ××—×¨</option>
                </select>
                <input type="text" id="checklist-type-other" class="w-full p-3 border border-slate-300 rounded-lg mt-2 hidden" placeholder="×©× ××•×ª×× ×œ×¡×•×’ ×”×¨×©×™××”" />
            </div>
            <div id="checklist-step-2" class="modal-step"></div>
            <div id="checklist-step-3" class="modal-step"></div>
            <div id="checklist-step-items" class="modal-step">
                <h4 class="text-lg font-bold text-slate-700 mb-3">×”×•×¡×¤×ª ×¤×¨×™×˜×™×</h4>
                <div class="bg-slate-50 p-4 rounded-lg">
                    <div class="grid grid-cols-1 md:grid-cols-5 gap-3">
                        <input type="text" id="item-text" placeholder="×©× ×”×¤×¨×™×˜" class="md:col-span-2 p-2 border rounded-md" />
                        <input type="number" id="item-quantity" placeholder="×›××•×ª" value="1" class="p-2 border rounded-md" />
                        <input type="text" id="item-description" placeholder="×ª×™××•×¨ (××•×¤×¦×™×•× ×œ×™)" class="p-2 border rounded-md" />
                        <select id="item-priority" class="p-2 border rounded-md">
                            <option value="1">ğŸŸ¡ × ××•×›×”</option> <option value="2" selected>ğŸŸ  ×‘×™× ×•× ×™×ª</option> <option value="3">ğŸ”´ ×’×‘×•×”×”</option>
                        </select>
                    </div>
                    <button id="add-item-btn" class="mt-3 bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600 transition w-full">×”×•×¡×£ ×¤×¨×™×˜</button>
                </div>
                <div id="items-preview-container" class="mt-4 space-y-2"></div>
            </div>
        </div>
        <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
          <button id="checklist-modal-back-btn" class="py-2 px-4 rounded-lg hover:bg-slate-200 transition hidden">××—×•×¨×”</button>
          <div id="checklist-modal-steps-indicator" class="text-sm text-slate-500"></div>
          <button id="checklist-modal-next-btn" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
          <button id="checklist-modal-finish-btn" class="py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition hidden">×©××•×¨ ×¨×©×™××”</button>
        </div>
      </div>
    </div>
    
    <!-- Note Modal (Multi-step) -->
    <div id="note-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl">
                <h3 id="note-modal-title" class="text-2xl font-bold text-slate-800">×”×•×¡×¤×ª ×“×’×©/×”×¢×¨×”</h3>
                <button class="modal-close-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-6 overflow-y-auto">
                <div id="note-step-0" class="modal-step">
                    <label for="note-name" class="block text-sm font-bold text-slate-700 mb-2">×©× / ×›×•×ª×¨×ª ×”×“×’×©</label>
                    <input type="text" id="note-name" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="×œ×“×•×’××”: ×”××œ×¦×” ×œ××¡×¢×“×”" />
                </div>
                <div id="note-step-1" class="modal-step">
                    <label class="block text-sm font-bold text-slate-700 mb-2">×¡×•×’ ×”×“×’×©</label>
                    <select id="note-type" class="w-full p-3 border border-slate-300 rounded-lg">
                        <option value="">-- ×‘×—×¨ --</option> <option value="×œ×¤× ×™ ×”×˜×™×•×œ">âœˆï¸ ×œ×¤× ×™ ×”×˜×™×•×œ</option> <option value="×œ×¤× ×™ ×™×¢×“">ğŸ—ºï¸ ×œ×¤× ×™ ×™×¢×“</option> <option value="×œ×¤× ×™ ××¢×‘×¨">ğŸšš ×œ×¤× ×™ ××¢×‘×¨</option> <option value="××—×¨">ğŸ“‹ ××—×¨</option>
                    </select>
                    <input type="text" id="note-type-other" class="w-full p-3 border border-slate-300 rounded-lg mt-2 hidden" placeholder="×©× ××•×ª×× ×œ×¡×•×’ ×”×“×’×©" />
                </div>
                <div id="note-step-2" class="modal-step"></div>
                <div id="note-step-3" class="modal-step"></div>
                <div id="note-step-final" class="modal-step space-y-4">
                    <div>
                        <label for="note-short-desc" class="block text-sm font-bold text-slate-700 mb-2">×¤×™×¨×•×˜ ×§×¦×¨ (××•×¤×¦×™×•× ×œ×™)</label>
                        <textarea id="note-short-desc" rows="2" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="×™×•×¦×’ ×‘×›×¨×˜×™×¡×™×™×” ×”×¨××©×™×ª..."></textarea>
                    </div>
                    <div>
                        <label for="note-full-desc" class="block text-sm font-bold text-slate-700 mb-2">×¤×™×¨×•×˜ ××œ×</label>
                        <textarea id="note-full-desc" rows="5" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="×™×•×¦×’ ×‘×œ×—×™×¦×” ×¢×œ ×”×“×’×©..."></textarea>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×™×¨×ª ×¦×‘×¢ ×¨×§×¢</label>
                        <div id="note-color-picker" class="flex flex-wrap gap-3 p-2 bg-slate-100 rounded-lg justify-center">
                            <button class="color-picker-btn bg-red-300" data-color="#fca5a5"></button>
                            <button class="color-picker-btn bg-yellow-300" data-color="#fde047"></button>
                            <button class="color-picker-btn bg-green-300 selected" data-color="#86efac"></button>
                            <button class="color-picker-btn bg-blue-300" data-color="#93c5fd"></button>
                            <button class="color-picker-btn bg-orange-300" data-color="#fed7aa"></button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="p-4 bg-slate-100 border-t flex justify-between items-center rounded-b-2xl">
                <button id="note-modal-back-btn" class="py-2 px-4 rounded-lg hover:bg-slate-200 transition hidden">××—×•×¨×”</button>
                <div id="note-modal-steps-indicator" class="text-sm text-slate-500"></div>
                <button id="note-modal-next-btn" class="py-2 px-4 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700 transition">×”×‘×</button>
                <button id="note-modal-finish-btn" class="py-2 px-4 bg-green-600 text-white font-bold rounded-lg hover:bg-green-700 transition hidden">×©××•×¨ ×“×’×©</button>
            </div>
        </div>
    </div>
    
    <!-- View Note Modal -->
    <div id="view-note-modal" class="fixed inset-0 bg-black/60 z-[70] hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <div id="view-note-header" class="p-5 border-b flex justify-between items-center rounded-t-2xl">
                <h3 id="view-note-title" class="text-2xl font-bold text-slate-800"></h3>
                <button id="view-note-close-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <div class="p-6 space-y-4 overflow-y-auto">
                <div id="view-note-short-desc-wrapper">
                    <h4 class="text-sm font-bold text-slate-500 mb-1 uppercase tracking-wider">×¤×™×¨×•×˜ ×§×¦×¨</h4>
                    <p id="view-note-short-desc" class="text-slate-600 bg-slate-50 p-3 rounded-lg"></p>
                </div>
                <div>
                    <h4 class="text-sm font-bold text-slate-500 mb-1 uppercase tracking-wider">×¤×™×¨×•×˜ ××œ×</h4>
                    <p id="view-note-full-desc" class="text-slate-800 whitespace-pre-wrap"></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete Modal (reusable) -->
    <div id="delete-modal" class="fixed inset-0 bg-black/60 z-[80] hidden items-center justify-center">
      <div class="bg-white rounded-2xl shadow-2xl p-8 text-center max-w-sm w-full">
        <div class="text-red-500 mb-4"><i class="fas fa-exclamation-triangle fa-3x"></i></div>
        <h3 id="delete-modal-title" class="text-xl font-bold text-slate-800 mb-4">×”×× ×œ××—×•×§?</h3>
        <p id="delete-modal-text" class="text-slate-600 mb-6">×”×¤×¢×•×œ×” ×‘×œ×ª×™ ×”×¤×™×›×”.</p>
        <div class="flex justify-center gap-4">
          <button id="delete-modal-cancel" class="py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">×‘×™×˜×•×œ</button>
          <button id="delete-modal-confirm" class="py-2 px-6 bg-red-500 text-white font-semibold rounded-lg hover:bg-red-600">××—×§</button>
        </div>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, collection, onSnapshot, addDoc, doc, updateDoc, deleteDoc, serverTimestamp, query, orderBy, getDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = { apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o", authDomain: "tiool-loz.firebaseapp.com", projectId: "tiool-loz", storageBucket: "tiool-loz.appspot.com", messagingSenderId: "226069823505", appId: "1:226069823505:web:ab7672692ccfa49173b1b0" };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    enableIndexedDbPersistence(db).catch(err => console.warn(err.code === 'failed-precondition' ? "Persistence × ×›×©×œ â€“ ×™×© ×™×•×ª×¨ ××“×™ ×˜××‘×™× ×¤×ª×•×—×™×." : "×”×“×¤×“×¤×Ÿ ×œ× ×ª×•××š ×‘Ö¾Persistence."));
    
    const params = new URLSearchParams(location.search);
    const tripId = params.get('tripId');
    if (!tripId) { alert('×—×¡×¨ tripId ×‘×›×ª×•×‘×ª.'); location.href = 'index.html'; }

    // --- DOM Elements ---
    const loader = document.getElementById('loader');
    const sidebar = document.getElementById('sidebar');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const overlay = document.getElementById('overlay');
    const mainMenu = document.getElementById('main-menu');
    const authContainer = document.getElementById('auth-container');
    const contentContainer = document.getElementById('content-container');
    const checklistsContainer = document.getElementById('checklists-container');
    const notesContainer = document.getElementById('notes-container');
    const addChecklistBtn = document.getElementById('add-checklist-btn');
    const addNoteBtn = document.getElementById('add-note-btn');

    // Checklist Modal DOM
    const checklistModal = document.getElementById('checklist-modal');
    const checklistModalTitle = document.getElementById('modal-title');
    const checklistModalBackBtn = document.getElementById('checklist-modal-back-btn');
    const checklistModalNextBtn = document.getElementById('checklist-modal-next-btn');
    const checklistModalFinishBtn = document.getElementById('checklist-modal-finish-btn');
    const checklistStepsIndicator = document.getElementById('checklist-modal-steps-indicator');
    const checklistNameInput = document.getElementById('checklist-name');
    const checklistTypeSelect = document.getElementById('checklist-type');
    const checklistTypeOtherInput = document.getElementById('checklist-type-other');
    const checklistItemsPreview = document.getElementById('items-preview-container');
    const checklistAddItemBtn = document.getElementById('add-item-btn');

    // Note Modal DOM
    const noteModal = document.getElementById('note-modal');
    const noteModalTitle = document.getElementById('note-modal-title');
    const noteModalBackBtn = document.getElementById('note-modal-back-btn');
    const noteModalNextBtn = document.getElementById('note-modal-next-btn');
    const noteModalFinishBtn = document.getElementById('note-modal-finish-btn');
    const noteStepsIndicator = document.getElementById('note-modal-steps-indicator');
    const noteNameInput = document.getElementById('note-name');
    const noteTypeSelect = document.getElementById('note-type');
    const noteTypeOtherInput = document.getElementById('note-type-other');
    const noteShortDesc = document.getElementById('note-short-desc');
    const noteFullDesc = document.getElementById('note-full-desc');
    const noteColorPicker = document.getElementById('note-color-picker');

    // View Note Modal DOM
    const viewNoteModal = document.getElementById('view-note-modal');
    const viewNoteHeader = document.getElementById('view-note-header');
    const viewNoteTitle = document.getElementById('view-note-title');
    const viewNoteShortDesc = document.getElementById('view-note-short-desc');
    const viewNoteShortDescWrapper = document.getElementById('view-note-short-desc-wrapper');
    const viewNoteFullDesc = document.getElementById('view-note-full-desc');
    const viewNoteCloseBtn = document.getElementById('view-note-close-btn');

    // --- State ---
    let currentUser = null, tripData = null, checklistsData = [], notesData = [];
    let currentChecklistModalStep = 0, checklistModalItems = [], editingChecklistId = null, numChecklistQuestionSteps = 0;
    let currentNoteModalStep = 0, editingNoteId = null, numNoteQuestionSteps = 0;

    // --- Helper Functions ---
    const parseDDMMYYYY = s => { const [d,m,y] = s.split('/').map(Number); return new Date(y, m-1, d); };
    const hebWeekday = d => { const n = d.toLocaleDateString('he-IL', { weekday:'long' }); return n.startsWith('×™×•×') ? n : `×™×•× ${n}`; };
    const dotted = d => `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
    function generateDatesFromRange(rangeStr) { /* Unchanged */
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [s,e] = rangeStr.split(' - '); const [sd, sm, sy] = s.split('/').map(Number); const [ed, em, ey] = e.split('/').map(Number);
      const start = new Date(sy, sm-1, sd); const end = new Date(ey, em-1, ed);
      const out = []; let cur = new Date(start);
      while (cur <= end) {
        out.push(`${String(cur.getDate()).padStart(2,'0')}/${String(cur.getMonth()+1).padStart(2,'0')}/${cur.getFullYear()}`);
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }
    const toggleSidebar = () => { sidebar.classList.toggle('translate-x-full'); overlay.classList.toggle('hidden'); };
    const groupBy = (arr, key, fallback='×›×œ×œ×™') => arr.reduce((r,v) => { (r[v[key] || fallback] = r[v[key] || fallback] || []).push(v); return r; }, {});

    function buildSidebarMenu() { /* Unchanged */
      mainMenu.innerHTML = '';
      if (!tripData?.destinations) return;
      tripData.destinations.forEach(dest => {
        const wrap = document.createElement('div');
        const btn = document.createElement('button');
        btn.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center';
        btn.innerHTML = `<span>${dest.nameHe}</span><i class="fas fa-chevron-down"></i>`;
        const submenu = document.createElement('div'); submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
        generateDatesFromRange(dest.dates).forEach(dstr => {
          const d = parseDDMMYYYY(dstr);
          const a = document.createElement('a');
          a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dstr)}`;
          a.className = 'block w-full text-right p-3 pr-4 rounded-md transition-colors hover:bg-sky-50';
          a.innerHTML = `<div class="flex flex-col"><span class="text-slate-700 text-sm font-bold">${hebWeekday(d)} â€“ (${dest.nameHe})</span><span class="text-slate-500 text-xs">${dotted(d)}</span></div>`;
          submenu.appendChild(a);
        });
        btn.addEventListener('click', () => { submenu.classList.toggle('open'); btn.querySelector('i').classList.toggle('rotate-180'); });
        wrap.append(btn, submenu); mainMenu.appendChild(wrap);
      });
    }

    // --- Auth & Initial Load ---
    onAuthStateChanged(auth, async user => {
      if (!user) { location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`; return; }
      currentUser = user;
      try{
        const udoc = await getDoc(doc(db,'users', user.uid));
        const name = udoc.exists() ? (udoc.data().name || '××©×ª××©') : '××©×ª××©';
        authContainer.innerHTML = `<span class="text-sm font-semibold text-slate-700 hidden sm:block">×©×œ×•×, ${name} ğŸ‘‹</span><button id="sign-out-btn" title="×”×ª× ×ª×§" class="p-2 text-slate-600 hover:text-red-500"><i class="fas fa-right-from-bracket fa-lg"></i></button>`;
        document.getElementById('sign-out-btn').addEventListener('click', () => signOut(auth));
      } catch(e) { console.error("Error fetching user data:", e); }
      await loadTripAndCheckPermissions();
    });

    async function loadTripAndCheckPermissions() {
      const tdoc = await getDoc(doc(db,'trips', tripId));
      if (tdoc.exists()) {
        const data = tdoc.data();
        if (data.editors && data.editors.includes(currentUser.uid)) {
            tripData = data;
            document.getElementById('home-link').href = `trip.html?id=${tripId}`;
            buildSidebarMenu();
            initRealtimeListeners();
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
        } else {
            alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×˜×™×•×œ ×–×”.'); location.href = 'index.html';
        }
      } else { alert('×”×˜×™×•×œ ×œ× × ××¦×.'); location.href='index.html'; }
    }

    // --- Realtime Listeners ---
    function initRealtimeListeners() {
      const checklistsQuery = query(collection(db, 'trips', tripId, 'checklists'), orderBy('createdAt','desc'));
      onSnapshot(checklistsQuery, snap => { checklistsData = snap.docs.map(d=>({id:d.id, ...d.data()})); renderChecklists(); });
      
      const notesQuery = query(collection(db, 'trips', tripId, 'notes'), orderBy('createdAt','desc'));
      onSnapshot(notesQuery, snap => { notesData = snap.docs.map(d=>({id:d.id, ...d.data()})); renderNotes(); });
    }

    // --- Rendering ---
    function renderChecklists() { /* Unchanged but uses updated renderSingleChecklist */
        if (checklistsData.length === 0) { checklistsContainer.innerHTML = `<div class="text-center p-8 bg-white/80 rounded-lg"><p class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×¨×©×™××•×ª.</p></div>`; return; }
        checklistsContainer.innerHTML = Object.values(groupBy(checklistsData, 'type')).flat().map(renderSingleChecklist).join('');
    }

    function renderSingleChecklist(list) {
      const itemsHtml = (list.items||[]).sort((a,b)=>(b.priority||0)-(a.priority||0)).map((item,index)=>`
        <div class="checklist-item bg-white p-3 rounded-lg flex items-center gap-4 hover:bg-sky-50 ${'priority-'+(item.priority||1)}">
          <input type="checkbox" id="item-${list.id}-${index}" data-list-id="${list.id}" data-item-index="${index}" ${item.checked?'checked':''}>
          <label for="item-${list.id}-${index}" class="flex-grow flex items-center gap-4 text-slate-700 cursor-pointer"><div class="custom-checkbox"><i class="fas fa-check"></i></div><div class="item-text"><span class="font-semibold">${item.text}</span> <span class="text-sm text-slate-500">(x${item.quantity||1})</span>${item.description ? `<p class="text-sm text-slate-500">${item.description}</p>` : ''}</div></label>
        </div>`).join('');
      return `<div class="bg-white/80 p-4 rounded-xl shadow-sm border border-slate-200"><div class="flex justify-between items-center mb-3"><h4 class="text-lg font-bold text-blue-700">${list.name}</h4><div><button class="edit-btn p-2 text-slate-500 hover:text-blue-600" data-type="checklist" data-id="${list.id}"><i class="fas fa-pencil-alt"></i></button><button class="delete-btn p-2 text-slate-500 hover:text-red-600" data-type="checklist" data-id="${list.id}"><i class="fas fa-trash-alt"></i></button></div></div><div class="space-y-2">${itemsHtml || '<p class="text-center text-slate-400 p-4">××™×Ÿ ×¤×¨×™×˜×™×.</p>'}</div></div>`;
    }
    
    function renderNotes() {
        if (notesData.length === 0) { notesContainer.innerHTML = `<div class="text-center p-8 bg-white/80 rounded-lg"><p class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×.</p></div>`; return; }
        notesContainer.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">${notesData.map(renderSingleNote).join('')}</div>`;
    }
    
    function renderSingleNote(note) {
        return `
        <div class="note-card rounded-xl shadow-md p-4 flex flex-col" style="background-color: ${note.color || '#86efac'}" data-note-id="${note.id}">
            <div class="flex-grow">
                <h4 class="font-bold text-slate-800 text-lg mb-2">${note.name}</h4>
                ${note.shortDesc ? `<p class="text-slate-700 text-sm">${note.shortDesc}</p>` : ''}
            </div>
            <div class="pt-3 mt-3 border-t border-black/10 text-right">
                <button class="edit-btn p-2 text-slate-600 hover:text-blue-800" data-type="note" data-id="${note.id}"><i class="fas fa-pencil-alt"></i></button>
                <button class="delete-btn p-2 text-slate-600 hover:text-red-700" data-type="note" data-id="${note.id}"><i class="fas fa-trash-alt"></i></button>
            </div>
        </div>`;
    }

    // --- Multi-step Modal Logic ---
    function openModal(type, item = null) {
        const isChecklist = type === 'checklist';
        const modal = isChecklist ? checklistModal : noteModal;
        const titleEl = isChecklist ? checklistModalTitle : noteModalTitle;
        
        if (isChecklist) {
            editingChecklistId = item ? item.id : null;
            checklistNameInput.value = item?.name || '';
            checklistTypeSelect.value = item?.type || '';
            checklistTypeOtherInput.classList.toggle('hidden', checklistTypeSelect.value !== '××—×¨');
            checklistModalItems = item?.items ? JSON.parse(JSON.stringify(item.items)) : [];
            renderChecklistModalItems();
            currentChecklistModalStep = 0;
            updateModalStep('checklist', true);
        } else {
            editingNoteId = item ? item.id : null;
            noteNameInput.value = item?.name || '';
            noteTypeSelect.value = item?.type || '';
            noteTypeOtherInput.classList.toggle('hidden', noteTypeSelect.value !== '××—×¨');
            noteShortDesc.value = item?.shortDesc || '';
            noteFullDesc.value = item?.fullDesc || '';
            document.querySelectorAll('#note-color-picker .color-picker-btn').forEach(btn => {
                btn.classList.toggle('selected', (item ? item.color : '#86efac') === btn.dataset.color);
            });
            currentNoteModalStep = 0;
            updateModalStep('note', true);
        }
        
        titleEl.textContent = `${item ? '×¢×¨×™×›×ª' : '×™×¦×™×¨×ª'} ${isChecklist ? '×¨×©×™××”' : '×“×’×©'}`;
        modal.classList.add('flex'); modal.classList.remove('hidden');
    }

    function updateModalStep(type, isOpening = false) {
        const isChecklist = type === 'checklist';
        const typeSelect = isChecklist ? checklistTypeSelect : noteTypeSelect;
        const modal = isChecklist ? checklistModal : noteModal;
        
        let currentStep, numSteps, stepSetter;
        if(isChecklist) { [currentStep, numSteps, stepSetter] = [currentChecklistModalStep, numChecklistQuestionSteps, (v) => currentChecklistModalStep = v]; }
        else { [currentStep, numSteps, stepSetter] = [currentNoteModalStep, numNoteQuestionSteps, (v) => currentNoteModalStep = v]; }

        const typeValue = typeSelect.value;
        if (typeValue.includes('×™×¢×“') || typeValue.includes('××¢×‘×¨')) numSteps = 3;
        else if (typeValue.includes('×”×˜×™×•×œ')) numSteps = 2;
        else numSteps = 1;
        if(isChecklist) numChecklistQuestionSteps = numSteps; else numNoteQuestionSteps = numSteps;

        if (isOpening) stepSetter(0);
        
        modal.querySelectorAll('.modal-step').forEach(s => s.classList.remove('active'));
        const isLast = currentStep >= numSteps;
        const finalStepId = isChecklist ? 'checklist-step-items' : 'note-step-final';
        const curId = isLast ? finalStepId : `${type}-step-${currentStep}`;
        modal.querySelector(`#${curId}`).classList.add('active');

        const [backBtn, nextBtn, finishBtn, indicator] = [
            modal.querySelector(`#${type}-modal-back-btn`),
            modal.querySelector(`#${type}-modal-next-btn`),
            modal.querySelector(`#${type}-modal-finish-btn`),
            modal.querySelector(`#${type}-modal-steps-indicator`)
        ];
        
        backBtn.classList.toggle('hidden', currentStep === 0);
        nextBtn.classList.toggle('hidden', isLast);
        finishBtn.classList.toggle('hidden', !isLast);
        indicator.textContent = `×©×œ×‘ ${currentStep + 1} ××ª×•×š ${numSteps + 1}`;

        if (currentStep === 1) generateStepContent(type, 2);
        if (currentStep === 2) generateStepContent(type, 3);
    }

    function generateStepContent(type, stepNum) {
        const isChecklist = type === 'checklist';
        const typeValue = (isChecklist ? checklistTypeSelect : noteTypeSelect).value;
        const container = document.getElementById(`${type}-step-${stepNum-1}`);
        let html = '';

        if(stepNum === 2) {
            if (typeValue.includes('×”×˜×™×•×œ')){
                html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ × ×•×©×</label><select id="${type}-subtype" class="w-full p-3 border rounded-lg"><option>ğŸ‘• ×‘×’×“×™×</option><option>ğŸ“„ ××¡××›×™×</option><option>ğŸŸï¸ ×”×–×× ×•×ª</option><option>ğŸ›’ ×§× ×™×•×ª</option><option>ğŸ’ ×¦×™×•×“</option><option value="××—×¨">××—×¨</option></select><input type="text" id="${type}-subtype-other" class="w-full p-3 border rounded-lg mt-2 hidden" placeholder="× ×•×©× ××•×ª××" />`;
            } else if (typeValue.includes('×™×¢×“') || typeValue.includes('××¢×‘×¨')){
                const options = (tripData?.destinations||[]).map(d=>`<option value="${d.nameHe}">${d.nameHe}</option>`).join('');
                html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ ×™×¢×“</label><select id="${type}-destination" class="w-full p-3 border rounded-lg">${options}</select>`;
            }
        } else if (stepNum === 3) {
            if (typeValue.includes('×™×¢×“')){
                html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ × ×•×©× ×œ×™×¢×“</label><select id="${type}-subtype" class="w-full p-3 border rounded-lg"><option>ğŸ‘• ×‘×’×“×™×</option><option>ğŸ“„ ××¡××›×™× ×œ×™×¢×“</option><option>ğŸ’ ×¦×™×•×“ × ×“×¨×©</option><option value="××—×¨">××—×¨</option></select><input type="text" id="${type}-subtype-other" class="w-full p-3 border rounded-lg mt-2 hidden" placeholder="× ×•×©× ××•×ª××" />`;
            } else if (typeValue.includes('××¢×‘×¨')){
                html = `<label class="block text-sm font-bold text-slate-700 mb-2">×‘×—×¨ × ×•×©× ×œ××¢×‘×¨</label><select id="${type}-subtype" class="w-full p-3 border rounded-lg"><option>ğŸ“„ ××™×©×•×¨×™×</option><option>ğŸ›’ ×§× ×™×•×ª</option><option>ğŸ‘• ×‘×’×“×™×</option></select>`;
            }
        }
        container.innerHTML = html;
    }
    
    function renderChecklistModalItems() { /* Unchanged */
      checklistItemsPreview.innerHTML = checklistModalItems.length===0 ? `<p class="text-center text-slate-500">××™×Ÿ ×¤×¨×™×˜×™×.</p>` : checklistModalItems.map((it,i)=>`<div class="flex items-center justify-between bg-white p-2 rounded-lg shadow-sm"><span>${it.text} (x${it.quantity||1})</span><button class="remove-item-btn text-red-500" data-index="${i}"><i class="fas fa-times-circle"></i></button></div>`).join('');
    }

    async function finishModal(type) {
        const isChecklist = type === 'checklist';
        const name = (isChecklist ? checklistNameInput : noteNameInput).value.trim();
        if (!name) return alert(`×™×© ×œ×”×–×™×Ÿ ×©× ×œ${isChecklist ? '×¨×©×™××”' : '×“×’×©'}.`);

        let typeValue = (isChecklist ? checklistTypeSelect : noteTypeSelect).value;
        if (typeValue === '××—×¨') typeValue = (isChecklist ? checklistTypeOtherInput : noteTypeOtherInput).value.trim() || '××—×¨';
        
        const modal = isChecklist ? checklistModal : noteModal;
        let subType = modal.querySelector(`#${type}-subtype`)?.value || null;
        if (subType === '××—×¨') subType = modal.querySelector(`#${type}-subtype-other`)?.value || '××—×¨';
        let destination = modal.querySelector(`#${type}-destination`)?.value || null;

        const payload = { name, type: typeValue, destination, subType, updatedAt: serverTimestamp() };

        if (isChecklist) {
            payload.items = checklistModalItems;
        } else {
            payload.shortDesc = noteShortDesc.value.trim();
            payload.fullDesc = noteFullDesc.value.trim();
            payload.color = noteColorPicker.querySelector('.selected').dataset.color;
        }

        try {
            const id = isChecklist ? editingChecklistId : editingNoteId;
            const collectionName = isChecklist ? 'checklists' : 'notes';
            if (id) {
                await updateDoc(doc(db, 'trips', tripId, collectionName, id), payload);
            } else {
                payload.createdAt = serverTimestamp();
                await addDoc(collection(db, 'trips', tripId, collectionName), payload);
            }
            modal.classList.add('hidden'); modal.classList.remove('flex');
        } catch(e) { console.error(e); alert('×©×’×™××” ×‘×©××™×¨×”.'); }
    }
    
    function openViewNoteModal(noteId) {
        const note = notesData.find(n => n.id === noteId);
        if(!note) return;

        viewNoteHeader.style.backgroundColor = note.color;
        viewNoteTitle.textContent = note.name;
        viewNoteFullDesc.textContent = note.fullDesc;
        if (note.shortDesc) {
            viewNoteShortDesc.textContent = note.shortDesc;
            viewNoteShortDescWrapper.style.display = 'block';
        } else {
            viewNoteShortDescWrapper.style.display = 'none';
        }
        viewNoteModal.classList.add('flex'); viewNoteModal.classList.remove('hidden');
    }

    // --- Event Listeners ---
    addChecklistBtn.addEventListener('click', () => openModal('checklist'));
    addNoteBtn.addEventListener('click', () => openModal('note'));
    
    [checklistModal, noteModal].forEach(modal => {
        const type = modal.id.split('-')[0];
        modal.querySelector(`#${type}-modal-back-btn`).addEventListener('click', () => { 
            if(type === 'checklist' && currentChecklistModalStep > 0) currentChecklistModalStep--; else if (type === 'note' && currentNoteModalStep > 0) currentNoteModalStep--;
            updateModalStep(type); 
        });
        modal.querySelector(`#${type}-modal-next-btn`).addEventListener('click', () => { 
            if(type === 'checklist') currentChecklistModalStep++; else currentNoteModalStep++;
            updateModalStep(type); 
        });
        modal.querySelector(`#${type}-modal-finish-btn`).addEventListener('click', () => finishModal(type));
        modal.querySelector(`#${type}-type`).addEventListener('change', e => { 
            modal.querySelector(`#${type}-type-other`).classList.toggle('hidden', e.target.value !== '××—×¨');
            updateModalStep(type);
        });
        modal.addEventListener('change', e => {
            if (e.target.id === `${type}-subtype`) {
                const other = modal.querySelector(`#${type}-subtype-other`);
                if(other) other.classList.toggle('hidden', e.target.value !== '××—×¨');
            }
        });
    });

    checklistAddItemBtn.addEventListener('click', () => {
      const t = document.getElementById('item-text'); if (!t.value.trim()) return;
      checklistModalItems.push({ text: t.value.trim(), quantity: Number(document.getElementById('item-quantity').value || 1), description: document.getElementById('item-description').value.trim(), priority: Number(document.getElementById('item-priority').value || 2), checked: false });
      renderChecklistModalItems();
      ['item-text','item-description'].forEach(id => document.getElementById(id).value='');
      document.getElementById('item-quantity').value = 1; t.focus();
    });

    checklistItemsPreview.addEventListener('click', e => {
      const btn = e.target.closest('.remove-item-btn'); if (!btn) return;
      checklistModalItems.splice(Number(btn.dataset.index), 1); renderChecklistModalItems();
    });

    noteColorPicker.addEventListener('click', e => {
        const btn = e.target.closest('.color-picker-btn');
        if(!btn) return;
        noteColorPicker.querySelector('.selected').classList.remove('selected');
        btn.classList.add('selected');
    });

    checklistsContainer.addEventListener('change', async e => {
      if (e.target.type !== 'checkbox') return;
      const {listId, itemIndex} = e.target.dataset;
      const list = checklistsData.find(l=>l.id === listId); if (!list) return;
      const items = list.items ? [...list.items] : []; if (!items[itemIndex]) return;
      items[itemIndex].checked = e.target.checked;
      await updateDoc(doc(db,'trips', tripId, 'checklists', listId), { items });
    });
    
    contentContainer.addEventListener('click', e => {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');
        const noteCard = e.target.closest('.note-card');

        if(editBtn || deleteBtn) {
            const btn = editBtn || deleteBtn;
            const { type, id } = btn.dataset;
            const isNote = type === 'note';
            const item = (isNote ? notesData : checklistsData).find(x => x.id === id);
            if (!item) return;

            if (editBtn) {
                openModal(type, item);
            } else { // Delete button
                const delModal = document.getElementById('delete-modal');
                document.getElementById('delete-modal-title').textContent = `×œ××—×•×§ ××ª "${item.name}"?`;
                delModal.classList.add('flex'); delModal.classList.remove('hidden');
                
                const confirmHandler = async () => {
                    await deleteDoc(doc(db, 'trips', tripId, isNote ? 'notes' : 'checklists', id));
                    closeDeleteModal();
                };
                const confirmBtn = document.getElementById('delete-modal-confirm');
                const newConfirmBtn = confirmBtn.cloneNode(true);
                confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
                newConfirmBtn.addEventListener('click', confirmHandler, { once: true });
            }
        } else if (noteCard) {
            openViewNoteModal(noteCard.dataset.noteId);
        }
    });

    const closeDeleteModal = () => { document.getElementById('delete-modal').classList.remove('flex'); document.getElementById('delete-modal').classList.add('hidden'); };
    document.getElementById('delete-modal-cancel').addEventListener('click', closeDeleteModal);

    document.querySelectorAll('.modal-close-btn').forEach(btn => btn.addEventListener('click', () => {
        checklistModal.classList.add('hidden'); checklistModal.classList.remove('flex');
        noteModal.classList.add('hidden'); noteModal.classList.remove('flex');
    }));
    viewNoteCloseBtn.addEventListener('click', () => { viewNoteModal.classList.add('hidden'); viewNoteModal.classList.remove('flex'); });

    [hamburgerBtn, closeSidebarBtn, overlay].forEach(el => el.addEventListener('click', toggleSidebar));
  </script>
</body>
</html>


