<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>××¨×›×– ×”×‘×§×¨×” ×©×œ ×”×˜×™×•×œ</title>

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
          theme: {
            extend: {
              fontFamily: {
                sans: ['Assistant', 'sans-serif'],
                rubik: ['Rubik', 'sans-serif'],
              }
            }
          }
        }
    </script>

    <style>
        html { height: 100%; scrollbar-gutter: stable both-edges; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Assistant', sans-serif;
            min-height: 100%;
            overflow-y: scroll;
            overscroll-behavior-y: contain;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            background-color: #0f172a; 
        }
        body.modal-locked { overflow: hidden; }

        /* Sidebar Styles - NEW */
        #sidebar { 
            transition: transform 0.3s ease-out; 
            border-left: 1px solid rgba(255,255,255,0.2);
        }
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .submenu.open { 
            max-height: 1000px; 
        }
        .chevron-icon { transition: transform 0.3s ease; }
        .rotate-180 { transform: rotate(180deg); }

        /* Sidebar Scrollbar */
        #main-menu::-webkit-scrollbar { width: 4px; }
        #main-menu::-webkit-scrollbar-track { background: transparent; }
        #main-menu::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        #trip-map-container, .details-map-container { border-radius: 1rem; z-index: 0; }
        #trip-map-container { height: 450px; }
        .details-map-container { height: 250px; background-color: #e2e8f0; }
        .modal { transition: opacity 0.3s ease, transform 0.3s ease; }
        .modal-content { transition: transform 0.3s ease, opacity 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .edit-dest-card { border-inline-start: 4px solid #38bdf8; }
        .date-pill { background: #eef6ff; border-radius: 9999px; padding: .15rem .5rem; font-weight: 700; font-size: .75rem }

        .main-nav-button {
            transition: transform .2s ease-out, box-shadow .2s ease-out, background-color .2s ease;
            will-change: transform, box-shadow;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        .main-nav-button:hover { transform: scale(1.02); box-shadow: 0 10px 24px rgba(0, 0, 0, 0.18); }

        .card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(226, 232, 240, 0.7);
            transition: box-shadow .3s ease, transform .3s ease;
            will-change: transform;
            cursor: pointer;
        }
        .card:hover { box-shadow: 0 12px 28px rgba(0, 0, 0, 0.12); transform: translateY(-4px); }

        .badge {
            display: inline-flex; align-items: center; gap: .4rem;
            font-weight: 600; font-size: .8rem;
            background: #f1f5f9; border-radius: 9999px;
            padding: .25rem .75rem; color: #475569;
            flex-wrap: nowrap;
        }
        .price-chip {
            background: linear-gradient(135deg, #e0f2fe, #dbeafe); border: 1px solid #bfdbfe; color: #1e3a8a;
            font-weight: 800; border-radius: 9999px; padding: .3rem .8rem; font-size: 0.8rem;
            text-shadow: 0 1px 1px rgba(255,255,255,0.5);
            white-space: nowrap;
        }
        .icon-chip {
            width: 44px; height: 44px;
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            flex-shrink: 0;
            background: linear-gradient(135deg, #f0f9ff, #e0f2fe);
            border: 1px solid #bae6fd;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .icon-chip i { color: #0284c7; }

        .transport-card .icon-chip {
            background: linear-gradient(135deg, #f0fdf4, #dcfce7);
            border: 1px solid #a7f3d0;
        }
        .transport-card .icon-chip i { color: #16a34a; }
       
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
       
        #page-bg {
             transition: background-image 1s ease, transform .6s ease;
             transform: translateZ(0);
        }

        .card-footer {
            margin-top: auto;
            padding-top: 0.75rem;
            border-top: 1px solid #e2e8f0;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 0.5rem;
        }
       
        .section-title {
            text-shadow: 0 3px 12px rgba(0,0,0,0.5);
        }

        /* Accordion Styles (Logistics) */
        .accordion-section {
            background-color: rgba(15, 23, 42, 0.45);
            backdrop-filter: blur(8px);
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .accordion-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.5s cubic-bezier(0, 1, 0, 1);
        }
        .accordion-content.open {
            max-height: 5000px;
            transition: max-height 1s ease-in-out;
        }
        .accordion-button .chevron {
            transition: transform 0.3s ease-out;
        }
        .accordion-button.open .chevron {
            transform: rotate(180deg);
        }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">×˜×•×¢×Ÿ ××ª ×”×˜×™×•×œ ×©×œ×š...</p>
    </div>

    <div id="page-bg" class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/PXLTIi4.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-gradient-to-b from-black/70 via-slate-900/60 to-black/70"></div>

    <div class="relative z-10">
        <!-- MODALS -->
        <div id="nav-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center opacity-0 transform scale-95">
                <h3 id="nav-modal-title" class="text-xl font-bold text-slate-800 mb-2">× ×•×•×˜ ××œ...</h3>
                <p id="nav-modal-message" class="text-slate-600 mb-4"></p>
                <div id="nav-modal-content" class="flex flex-col gap-4"></div>
                <button id="nav-modal-close" class="mt-6 text-slate-500 hover:text-slate-700">×¡×’×•×¨</button>
            </div>
        </div>

        <div id="share-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="modal-content bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg text-center opacity-0 transform scale-95">
                <h3 class="text-2xl font-bold text-slate-800 mb-2">××™×š ×ª×¨×¦×” ×œ×©×ª×£?</h3>
                <p class="text-slate-600 mb-8">×‘×—×¨ ×›×™×¦×“ ×œ×©×ª×£ ××ª ×ª×•×›× ×™×ª ×”×˜×™×•×œ ×©×œ×š.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="share-add-editor-btn" class="flex flex-col items-center justify-center p-6 bg-blue-50 hover:bg-blue-100 rounded-xl border-2 border-blue-200 hover:border-blue-400 transition-all">
                        <i class="fas fa-user-plus fa-2x text-blue-500 mb-3"></i>
                        <span class="font-bold text-slate-800">×”×•×¡×£ ×—×‘×¨ ×œ×¢×¨×™×›×”</span>
                        <span class="text-sm text-slate-500 mt-1">×©×œ×— ×”×–×× ×” ×œ×—×‘×¨ ×œ×”×¦×˜×¨×£ ×•×œ×¢×¨×•×š ××ª ×”×˜×™×•×œ ×‘×™×—×“.</span>
                    </button>
                    <button id="share-as-file-btn" class="flex flex-col items-center justify-center p-6 bg-green-50 hover:bg-green-100 rounded-xl border-2 border-green-200 hover:border-green-400 transition-all">
                        <i class="fas fa-file-export fa-2x text-green-500 mb-3"></i>
                        <span class="font-bold text-slate-800">×©×ª×£ ×›×§×•×‘×¥ (PDF/Word)</span>
                        <span class="text-sm text-slate-500 mt-1">×¦×•×¨ ×§×•×‘×¥ ××¡×•×“×¨ ×©×œ ×”×˜×™×•×œ ×©× ×™×ª×Ÿ ×œ×”×“×¤×™×¡ ××• ×œ×©×œ×•×—.</span>
                    </button>
                </div>
                <button id="share-modal-close-btn" class="mt-8 text-slate-500 hover:text-slate-700">×‘×™×˜×•×œ</button>
            </div>
        </div>

        <div id="logout-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4">×”×ª× ×ª×§×•×ª</h2>
                <p class="text-slate-600 mb-8">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ×”×ª× ×ª×§?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-logout-btn" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">×‘×™×˜×•×œ</button>
                    <button id="confirm-logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">×”×ª× ×ª×§</button>
                </div>
            </div>
        </div>
       
        <!-- Delete Trip Modals -->
        <div id="delete-modal-1" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4 text-red-600">××—×™×§×ª ×˜×™×•×œ</h2>
                <p class="text-slate-600 mb-8">×”×× ××ª×” ×‘×˜×•×— ×©×‘×¨×¦×•× ×š ×œ××—×•×§ ××ª ×”×˜×™×•×œ ×”×–×” ×œ×¦××™×ª×•×ª?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete-1" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">×‘×™×˜×•×œ</button>
                    <button id="confirm-delete-1" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">×›×Ÿ, ×× ×™ ×‘×˜×•×—</button>
                </div>
            </div>
        </div>
        <div id="delete-modal-2" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[102] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <i class="fas fa-exclamation-triangle text-5xl text-yellow-400 mb-4"></i>
                <h2 class="text-2xl font-bold mb-4">××–×”×¨×” ××—×¨×•× ×”!</h2>
                <p class="text-slate-600 mb-8">×¤×¢×•×œ×” ×–×• ×ª××—×§ ××ª <strong class="font-bold">×›×œ</strong> × ×ª×•× ×™ ×”×˜×™×•×œ, ×›×•×œ×œ ×œ×•×’×™×¡×˜×™×§×”, ××˜×¨×§×¦×™×•×ª ×•×¨×©×™××•×ª. <strong class="underline">×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ×”××™×“×¢.</strong></p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-delete-2" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">×”×ª×—×¨×˜×ª×™, ×‘×˜×œ</button>
                    <button id="confirm-delete-2" class="bg-red-800 hover:bg-red-900 text-white font-bold py-2 px-6 rounded-lg">×× ×™ ××‘×™×Ÿ, ××—×§ ×œ×¦××™×ª×•×ª</button>
                </div>
            </div>
        </div>

        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-2xl font-bold">×”×’×“×¨×•×ª</h2>
                    <button id="close-settings-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>

                <div class="space-y-6">
                    <div>
                        <label for="main-bg-input" class="block text-sm font-medium text-slate-700 mb-1">×¨×§×¢ ×›×œ×œ×™ ×œ×“×£ ×”×˜×™×•×œ</label>
                        <input type="url" id="main-bg-input" class="w-full p-2 border rounded-md" placeholder="×”×“×‘×§ ×§×™×©×•×¨ (URL) ×œ×ª××•× ×”">
                    </div>
                    <hr>
                    <div class="bg-slate-50 border rounded-lg p-4">
                        <h3 class="font-bold text-slate-800 mb-2"><i class="fa-solid fa-calendar-days ml-2 text-sky-600"></i> ×¢×¨×™×›×ª ×ª××¨×™×›×™× ×•×™×¢×“×™× ×‘×œ×•×–</h3>
                        <button id="open-edit-destinations-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">
                            ×¤×ª×— ×¢×•×¨×š ×ª××¨×™×›×™× ×•×™×¢×“×™×
                        </button>
                    </div>
                    <div class="bg-slate-50 border rounded-lg p-4">
                        <h3 class="font-bold text-slate-800 mb-2"><i class="fa-solid fa-rocket ml-2 text-purple-600"></i> ××¨×›×– ×”×§×™×¦×•×¨×™× (Shortcuts)</h3>
                        <a id="open-shortcuts-btn" href="#" class="block w-full text-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                            ×¤×ª×— ××ª ××¨×›×– ×”×§×™×¦×•×¨×™×
                        </a>
                    </div>
                     <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <h3 class="font-bold text-red-800 mb-2"><i class="fa-solid fa-trash-alt ml-2"></i> ××–×•×¨ ×¡×›× ×”</h3>
                        <p class="text-red-700 text-sm mb-3">××—×™×§×ª ×”×˜×™×•×œ ×”×™× ×¤×¢×•×œ×” ×¡×•×¤×™×ª ×•×œ× × ×™×ª× ×ª ×œ×©×—×–×•×¨.</p>
                        <button id="delete-trip-btn" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">
                            ××—×§ ××ª ×”×˜×™×•×œ
                        </button>
                    </div>
                </div>

                <div class="mt-6 flex justify-end gap-4">
                    <div id="settings-feedback" class="text-green-600 font-bold flex-grow"></div>
                    <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">×©××•×¨ ×”×’×“×¨×•×ª</button>
                </div>
            </div>
        </div>

        <div id="edit-destinations-modal" class="hidden fixed inset-0 bg-black/70 z-[110] p-4 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                <header class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold">×¢×¨×™×›×ª ×ª××¨×™×›×™× ×•×™×¢×“×™× ×‘×œ×•×–</h2>
                    <button id="edit-destinations-close" class="p-2 text-slate-500 hover:text-red-600"><i class="fa-solid fa-xmark fa-lg"></i></button>
                </header>
                <main class="p-4 overflow-y-auto no-scrollbar flex-1 space-y-5">
                    <section class="bg-slate-50 p-4 rounded-lg">
                        <label class="block text-sm font-semibold mb-1">×ª××¨×™×›×™ ×”×˜×™×•×œ (×›×œ×œ×™)</label>
                        <input type="text" id="trip-dates-edit" class="w-full p-2 border rounded-md text-center" placeholder="DD/MM/YYYY - DD/MM/YYYY">
                        <p class="text-xs text-slate-500 mt-1">×”×¢×¨×”: ×–×”×• ×˜×•×•×— ×›×œ×œ×™ ×‘×œ×‘×“ â€“ ×œ×›×œ ×™×¢×“ ×™×© ×˜×•×•×— ××©×œ×•.</p>
                    </section>

                    <section>
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-slate-800 text-lg">×™×¢×“×™×</h3>
                            <button id="add-dest-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-plus ml-2"></i>×”×•×¡×£ ×™×¢×“</button>
                        </div>
                        <div id="destinations-list" class="space-y-4"></div>
                    </section>
                </main>
                <footer class="p-4 border-t flex justify-between">
                    <button id="edit-destinations-cancel" class="bg-slate-200 hover:bg-slate-300 font-semibold py-2 px-4 rounded-lg">×‘×™×˜×•×œ</button>
                    <button id="save-destinations-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">×©××•×¨ ×©×™× ×•×™×™×</button>
                </footer>
            </div>
        </div>

        <div id="details-modal" class="modal fixed inset-0 bg-black/60 z-[102] hidden items-center justify-center p-4 opacity-0">
            <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[95vh] flex flex-col transform scale-95 opacity-0">
                <header class="p-5 border-b flex justify-between items-center bg-gradient-to-r from-slate-100 to-slate-200 rounded-t-2xl sticky top-0">
                    <h3 id="details-modal-title" class="text-2xl font-bold text-slate-800 break-words">×¤×¨×˜×™ ×”×¤×¨×™×˜</h3>
                    <button id="details-modal-close" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </header>
                <div id="details-modal-body" class="flex-grow overflow-y-auto p-6 space-y-4">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>
       
        <!-- Generic Alert/Confirm Modal -->
        <div id="generic-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[110] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <h2 id="generic-modal-title" class="text-2xl font-bold mb-4">×›×•×ª×¨×ª</h2>
                <p id="generic-modal-message" class="text-slate-600 mb-8">×”×•×“×¢×”.</p>
                <div id="generic-modal-buttons" class="flex justify-center gap-4">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>


        <!-- Overlay for Sidebar -->
        <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300 opacity-0"></div>

        <!-- NEW Sidebar Container -->
        <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform translate-x-full transition-transform duration-300 ease-out flex flex-col">
            
            <!-- Sidebar Header -->
            <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-l from-cyan-50 to-transparent shrink-0">
            <h2 class="text-2xl font-bold text-slate-800 font-rubik">×ª×¤×¨×™×˜ ×”××¡×¢ ğŸ§­</h2>
            <button id="close-sidebar-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
                <i class="fas fa-times fa-lg"></i>
            </button>
            </div>

            <!-- Sidebar Content (Navigation) -->
            <nav id="main-menu" class="p-4 space-y-3 overflow-y-auto flex-grow pb-20 scroll-smooth">
            <!-- Content Injected via JS -->
            <div class="text-center py-10 text-slate-400">
                <i class="fas fa-circle-notch fa-spin mb-2"></i>
                <p class="text-sm">×˜×•×¢×Ÿ ×ª×¤×¨×™×˜...</p>
            </div>
            </nav>
            
            <!-- Footer -->
            <div class="p-4 border-t border-slate-100 bg-slate-50 shrink-0 text-center">
                <p class="text-xs text-slate-400">×ª×›× ×•×Ÿ ×˜×™×•×œ ×—×›×</p>
            </div>
        </aside>

        <div id="main-content" class="min-h-screen">
            <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <a href="index.html" class="text-slate-700 font-bold hover:text-blue-600 transition-colors"><i class="fas fa-home"></i> ×“×£ ×”×‘×™×ª</a>
                        <div class="flex items-center gap-2 sm:gap-4">
                            <div id="auth-container"></div>
                            <button id="navigate-hotel-btn" class="p-2 text-slate-600 hover:text-blue-600 transition-colors" aria-label="× ×•×•×˜ ×œ××œ×•×Ÿ"><i class="fas fa-hotel fa-lg"></i></button>
                            <button id="share-trip-btn" class="p-2 text-slate-600 hover:text-blue-600 transition-colors" aria-label="×©×ª×£ ×˜×™×•×œ"><i class="fas fa-share-alt fa-lg"></i></button>
                            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600 transition-colors" aria-label="×”×’×“×¨×•×ª"><i class="fas fa-cog fa-lg"></i></button>
                            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 transition-colors focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-12">

                    <section class="text-center">
                        <h2 id="trip-title" class="text-4xl md:text-6xl font-extrabold text-white" style="text-shadow: 0 4px 15px rgba(0,0,0,0.6);">×˜×•×¢×Ÿ ××ª ×©× ×”×˜×™×•×œ...</h2>
                        <p class="mt-4 text-lg text-slate-200 max-w-3xl mx-auto drop-shadow-md">×–×”×• ××¨×›×– ×”×‘×§×¨×” ×©×œ ×”×˜×™×•×œ! ××›××Ÿ ××¤×©×¨ ×œ× ×•×•×˜ ×œ×›×œ ×”××™×“×¢ ×”×—×©×•×‘.</p>
                        <div id="main-nav-buttons" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                            <!-- Nav buttons will be injected here -->
                        </div>
                    </section>

                    <!-- Expense Summary Section -->
                    <section id="quick-expense-summary" class="max-w-4xl mx-auto">
                        <div class="grid grid-cols-2 gap-4">
                            <a id="today-expense-card-link" href="#" class="main-nav-button bg-sky-500/20 backdrop-blur-md hover:bg-sky-500/30 p-4 rounded-xl text-white text-center flex flex-col items-center justify-center">
                                <i class="fas fa-sun text-3xl mb-2"></i>
                                <span class="font-bold">×”×•×¦××•×ª ×”×™×•×</span>
                                <span id="today-expenses-summary" class="text-2xl font-extrabold mt-1">×˜×•×¢×Ÿ...</span>
                            </a>
                            <a id="total-expense-card-link" href="#" class="main-nav-button bg-sky-500/20 backdrop-blur-md hover:bg-sky-500/30 p-4 rounded-xl text-white text-center flex flex-col items-center justify-center">
                                <i class="fas fa-wallet text-3xl mb-2"></i>
                                <span class="font-bold">×¡×š ×›×œ ×”×•×¦××•×ª ×”×˜×™×•×œ</span>
                                <span id="total-expenses-summary" class="text-2xl font-extrabold mt-1">×˜×•×¢×Ÿ...</span>
                            </a>
                        </div>
                    </section>

                    <section>
                        <h3 class="section-title text-4xl font-extrabold text-white mb-6 text-center">××¤×ª ×”××¡×¢ ×”×›×œ×œ×™×ª</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-lg"><div id="trip-map-container"></div></div>
                    </section>

                    <!-- Logistics Accordion Section -->
                    <section id="logistics-summary-section" class="space-y-6">
                        <h3 class="section-title text-4xl font-extrabold text-white text-center mb-6">ğŸ—‚ï¸ ×¡×™×›×•× ×œ×•×’×™×¡×˜×™×§×”</h3>
                        <div id="logistics-accordion-container" class="space-y-4">
                            <p class="text-white/80 text-center col-span-full">×˜×•×¢×Ÿ ×¡×™×›×•× ×œ×•×’×™×¡×˜×™×§×”...</p>
                        </div>
                    </section>
                   
                    <section id="costs-summary-section">
                        <h3 class="section-title text-4xl font-extrabold text-white mb-6 text-center">ğŸ“Š ×¡×™×›×•× ×¢×œ×•×™×•×ª</h3>
                        <div id="costs-summary-container" class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                           <p class="text-slate-600 text-center">×˜×•×¢×Ÿ ×¡×™×›×•× ×¢×œ×•×™×•×ª...</p>
                        </div>
                    </section>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, updateDoc, enableIndexedDbPersistence, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {
         if (err.code == 'failed-precondition') {
           console.warn("Persistence failed because of multiple tabs open.");
         } else if (err.code == 'unimplemented') {
           console.warn("Browser does not support persistence.");
         }
        });

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            pageBg: document.getElementById('page-bg'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            navModal: document.getElementById('nav-modal'),
            navModalContent: document.getElementById('nav-modal-content'),
            navModalClose: document.getElementById('nav-modal-close'),
            navigateHotelBtn: document.getElementById('navigate-hotel-btn'),
            logoutModal: document.getElementById('logout-modal'),
            cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
            confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
            authContainer: document.getElementById('auth-container'),
            tripTitle: document.getElementById('trip-title'),
            tripMapContainer: document.getElementById('trip-map-container'),
            mainNavButtons: document.getElementById('main-nav-buttons'),
            logisticsAccordionContainer: document.getElementById('logistics-accordion-container'),
            costsSummaryContainer: document.getElementById('costs-summary-container'),
            shareTripBtn: document.getElementById('share-trip-btn'),
            shareModal: document.getElementById('share-modal'),
            shareModalCloseBtn: document.getElementById('share-modal-close-btn'),
            shareAsFileBtn: document.getElementById('share-as-file-btn'),
            shareAddEditorBtn: document.getElementById('share-add-editor-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            mainBgInput: document.getElementById('main-bg-input'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            settingsFeedback: document.getElementById('settings-feedback'),
            openEditDestBtn: document.getElementById('open-edit-destinations-btn'),
            openShortcutsBtn: document.getElementById('open-shortcuts-btn'),
            editDestModal: document.getElementById('edit-destinations-modal'),
            editDestClose: document.getElementById('edit-destinations-close'),
            editDestCancel: document.getElementById('edit-destinations-cancel'),
            saveDestinationsBtn: document.getElementById('save-destinations-btn'),
            tripDatesEdit: document.getElementById('trip-dates-edit'),
            destinationsList: document.getElementById('destinations-list'),
            addDestBtn: document.getElementById('add-dest-btn'),
            detailsModal: document.getElementById('details-modal'),
            detailsModalTitle: document.getElementById('details-modal-title'),
            detailsModalBody: document.getElementById('details-modal-body'),
            detailsModalClose: document.getElementById('details-modal-close'),
            deleteTripBtn: document.getElementById('delete-trip-btn'),
            deleteModal1: document.getElementById('delete-modal-1'),
            cancelDelete1: document.getElementById('cancel-delete-1'),
            confirmDelete1: document.getElementById('confirm-delete-1'),
            deleteModal2: document.getElementById('delete-modal-2'),
            cancelDelete2: document.getElementById('cancel-delete-2'),
            confirmDelete2: document.getElementById('confirm-delete-2'),
            todayExpensesSummary: document.getElementById('today-expenses-summary'),
            totalExpensesSummary: document.getElementById('total-expenses-summary'),
            todayExpenseCardLink: document.getElementById('today-expense-card-link'),
            totalExpenseCardLink: document.getElementById('total-expense-card-link'),
        };

        let currentUser = null;
        let tripId = null;
        let tripData = null;
        let allLogisticsItems = [];
        let allExpenses = [];
        let logisticsUnsubscribe = null;
        let expensesUnsubscribe = null;
        let detailsMap = null;
        let rateCache = {};

        const editUI = new Map();

        // --- Generic Modal Logic ---
        let confirmResolve = null;

        function showAlert(title, message, callback) {
            const modal = document.getElementById('generic-modal');
            document.getElementById('generic-modal-title').textContent = title;
            document.getElementById('generic-modal-message').innerHTML = message;
            const buttonsContainer = document.getElementById('generic-modal-buttons');

            buttonsContainer.innerHTML = '<button id="generic-modal-ok" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">××™×©×•×¨</button>';

            modal.classList.remove('hidden');

            const okBtn = document.getElementById('generic-modal-ok');
            okBtn.onclick = () => {
                modal.classList.add('hidden');
                if (callback) callback();
            };
        }

        function showConfirm(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const modal = document.getElementById('generic-modal');
                document.getElementById('generic-modal-title').textContent = title;
                document.getElementById('generic-modal-message').innerHTML = message;
                const buttonsContainer = document.getElementById('generic-modal-buttons');

                buttonsContainer.innerHTML = `
                    <button id="generic-modal-cancel" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">×‘×™×˜×•×œ</button>
                    <button id="generic-modal-confirm" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">××©×¨</button>
                `;

                modal.classList.remove('hidden');

                document.getElementById('generic-modal-confirm').onclick = () => {
                    modal.classList.add('hidden');
                    if (confirmResolve) confirmResolve(true);
                };
                document.getElementById('generic-modal-cancel').onclick = () => {
                    modal.classList.add('hidden');
                    if (confirmResolve) confirmResolve(false);
                };
            });
        }
       
        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            if (!tripId) {
                showAlert("×©×’×™××”", "×œ× × ××¦× ××–×”×” ×˜×™×•×œ.", () => {
                    window.location.href = 'index.html';
                });
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadTripData();
                    setupAuthUI(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData() {
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);

            if (tripSnap.exists()) {
                const loadedTripData = tripSnap.data();
                const canAccess = loadedTripData.owner === currentUser.uid || (loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid));

                if (canAccess) {
                    tripData = loadedTripData;
                    document.title = tripData.name;
                    applySettings();
                    populateUI();
                    listenForLogistics();
                    listenForExpenses();
                    DOM.loadingOverlay.style.opacity = '0';
                    setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);

                } else {
                    showAlert("×©×’×™××”", "×”×˜×™×•×œ ×œ× × ××¦× ××• ×©××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×•.", () => {
                       window.location.href = 'index.html';
                    });
                }
            } else {
                showAlert("×©×’×™××”", "×”×˜×™×•×œ ×œ× × ××¦× ××• ×©××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¦×¤×•×ª ×‘×•.", () => {
                    window.location.href = 'index.html';
                });
            }
        }

        function listenForLogistics() {
            if (logisticsUnsubscribe) logisticsUnsubscribe();
            const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
            const q = query(logisticsCollectionRef);
            logisticsUnsubscribe = onSnapshot(q, async (snapshot) => {
                allLogisticsItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                await populateSummaries(allLogisticsItems);
            }, (error) => {
                console.error("Logistics snapshot error:", error);
            });
        }

        // --- Expenses Logic ---
        function listenForExpenses() {
            if (expensesUnsubscribe) expensesUnsubscribe();
            const expensesCollectionRef = collection(db, "trips", tripId, "expenses");
            expensesUnsubscribe = onSnapshot(expensesCollectionRef, async (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                await prefetchAllCurrencyRates(allExpenses);
                renderExpenseSummary(allExpenses);
            }, (error) => {
                console.error("Expenses snapshot error:", error);
                DOM.todayExpensesSummary.textContent = '×©×’×™××”';
                DOM.totalExpensesSummary.textContent = '×©×’×™××”';
            });
        }

        async function renderExpenseSummary(expenses) {
            const todayString = new Date().toISOString().split('T')[0];
            const todayExpenses = expenses.filter(exp => exp.date === todayString);

            let todayTotalILS = 0;
            for (const exp of todayExpenses) {
                todayTotalILS += await convertToILS(Number(exp.amount) || 0, exp.currency);
            }

            let grandTotalILS = 0;
            for (const exp of expenses) {
                grandTotalILS += await convertToILS(Number(exp.amount) || 0, exp.currency);
            }

            DOM.todayExpensesSummary.textContent = `â‚ª${todayTotalILS.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
            DOM.totalExpensesSummary.textContent = `â‚ª${grandTotalILS.toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        }

        // --- Settings Logic ---
        function applySettings() {
            if (tripData.backgroundUrl) {
                DOM.pageBg.style.backgroundImage = `url('${tripData.backgroundUrl}')`;
            }
        }

        function openSettingsModal() {
            DOM.mainBgInput.value = tripData.backgroundUrl || '';
            DOM.settingsFeedback.textContent = '';
            DOM.settingsModal.classList.remove('hidden');
        }
        function closeSettingsModal() { DOM.settingsModal.classList.add('hidden'); }

        async function saveSettings() {
            const tripRef = doc(db, "trips", tripId);
            let updatedTripData = { ...tripData };
            updatedTripData.backgroundUrl = (DOM.mainBgInput.value || '').trim();

            try {
                await updateDoc(tripRef, updatedTripData);
                tripData = updatedTripData;
                applySettings();
                DOM.settingsFeedback.textContent = '×”×”×’×“×¨×•×ª × ×©××¨×•!';
                setTimeout(() => { DOM.settingsFeedback.textContent = ''; closeSettingsModal(); }, 1200);
            } catch (error) {
                console.error("Error saving settings:", error);
                DOM.settingsFeedback.textContent = '×©×’×™××” ×‘×©××™×¨×”.';
                DOM.settingsFeedback.classList.remove('text-green-600');
                DOM.settingsFeedback.classList.add('text-red-600');
            }
        }
       
        async function deleteTrip() {
            DOM.confirmDelete2.disabled = true;
            DOM.confirmDelete2.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> ××•×—×§...';
           
            try {
                // Delete all documents in the 'logistics' subcollection
                const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
                const logisticsSnapshot = await getDocs(logisticsCollectionRef);
                const deleteLogisticsPromises = logisticsSnapshot.docs.map(d => deleteDoc(d.ref));
               
                // Delete all documents in the 'expenses' subcollection
                const expensesCollectionRef = collection(db, "trips", tripId, "expenses");
                const expensesSnapshot = await getDocs(expensesCollectionRef);
                const deleteExpensesPromises = expensesSnapshot.docs.map(d => deleteDoc(d.ref));

                // TODO: Add deletion for other subcollections if they exist (e.g., attractions, checklists)
               
                await Promise.all([...deleteLogisticsPromises, ...deleteExpensesPromises]);

                // Delete the main trip document
                await deleteDoc(doc(db, "trips", tripId));

                showAlert('×”×¦×œ×—×”', '×”×˜×™×•×œ × ××—×§ ×‘×”×¦×œ×—×”.', () => {
                    window.location.href = 'index.html';
                });

            } catch (error) {
                console.error("Error deleting trip:", error);
                showAlert("×©×’×™××”", "××™×¨×¢×” ×©×’×™××” ×‘××—×™×§×ª ×”×˜×™×•×œ. ×× × × ×¡×” ×©×•×‘.");
                DOM.confirmDelete2.disabled = false;
                DOM.confirmDelete2.textContent = '×× ×™ ××‘×™×Ÿ, ××—×§ ×œ×¦××™×ª×•×ª';
            }
        }


        // --- UI Population ---
        function populateUI() {
            DOM.tripTitle.textContent = tripData.name;
            DOM.openShortcutsBtn.href = `shortcuts.html?tripId=${tripId}`;
            DOM.todayExpenseCardLink.href = `expenses.html?tripId=${tripId}`;
            DOM.totalExpenseCardLink.href = `expenses.html?tripId=${tripId}`;
            
            // Replaced old sidebar builder with new logic
            buildSidebarMenu(); 
            
            buildTripMap();
            buildNavButtons();
        }

        // --- Sorting and Summary Population ---
        async function populateSummaries(items) {
            renderLogisticsAccordions(items);
            await renderCostsSummary(items);
        }

        // --- ACCORDION RENDER LOGIC ---
        function renderLogisticsAccordions(items) {
            const container = DOM.logisticsAccordionContainer;
            container.innerHTML = ''; // Clear previous content

            const groups = {
                hotel: { title: "ğŸ¨ ××œ×•× ×•×ª", icon: "fa-hotel", items: [] },
                flight: { title: "âœˆï¸ ×˜×™×¡×•×ª", icon: "fa-plane-departure", items: [] },
                car_rental: { title: "ğŸš— ×¨×›×‘×™× ×©×›×•×¨×™×", icon: "fa-car", items: [] },
                ride: { title: "ğŸš• ×”×¡×¢×•×ª ×•××•× ×™×•×ª", icon: "fa-taxi", items: [] },
                ferry: { title: "ğŸš¢ ××¢×‘×•×¨×•×ª", icon: "fa-ship", items: [] },
                train: { title: "ğŸš† ×¨×›×‘×•×ª", icon: "fa-train", items: [] },
            };

            // Group items by type
            items.forEach(item => {
                if (groups[item.type]) {
                    groups[item.type].items.push(item);
                }
            });

            // Sort items within each group
            Object.values(groups).forEach(group => {
                group.items.sort((a, b) => {
                    const dateA = getStartDate(a);
                    const dateB = getStartDate(b);
                    if (!dateA) return 1;
                    if (!dateB) return -1;
                    return dateA - dateB;
                });
            });

            let hasContent = false;
            for (const key in groups) {
                const group = groups[key];
                if (group.items.length > 0) {
                    hasContent = true;
                    const accordionSection = document.createElement('div');
                    accordionSection.className = "accordion-section";
                   
                    const buttonId = `accordion-button-${key}`;
                    const contentId = `accordion-content-${key}`;

                    accordionSection.innerHTML = `
                        <button id="${buttonId}" class="accordion-button w-full flex justify-between items-center p-5 text-left text-white font-bold text-xl">
                            <span><i class="fas ${group.icon} ml-3"></i>${group.title} (${group.items.length})</span>
                            <i class="fas fa-chevron-down chevron"></i>
                        </button>
                        <div id="${contentId}" class="accordion-content">
                            <div class="px-5 pb-5 pt-4 border-t border-white/10">
                               <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                    <!-- Cards will be injected here -->
                               </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(accordionSection);
                   
                    const cardContainer = accordionSection.querySelector('.grid');
                    if (key === 'hotel') {
                        cardContainer.innerHTML = group.items.map(createHotelCardHTML).join('');
                    } else {
                        cardContainer.innerHTML = group.items.map(createTransportCardHTML).join('');
                    }
                }
            }

            if (!hasContent) {
                container.innerHTML = `<div class="bg-white/10 backdrop-blur-sm rounded-xl p-6"><p class="text-white/80 text-center col-span-full">×œ× × ×•×¡×¤×• ×¤×¨×™×˜×™ ×œ×•×’×™×¡×˜×™×§×”. <a href="logistics.html?tripId=${tripId}" class="font-bold underline hover:text-white">×”×•×¡×£ ×¢×›×©×™×•</a></p></div>`;
            }

            // Add event listeners to accordion buttons
            container.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    button.classList.toggle('open');
                    content.classList.toggle('open');
                });
            });
        }
       
        function createHotelCardHTML(hotel) {
            const title = hotel.name || '××œ×•×Ÿ';
            const place = hotel.destination || '';
            const dates = hotel.dates || '';
            const price = hotel.price || 0;
            const address = hotel.address || '';
            const meals = (hotel.meals || []).join(', ') || '';

            const navButtons = address ? `
            <div class="card-footer">
                <a href="https://waze.com/ul?q=${encodeURIComponent(address)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="flex items-center justify-center w-9 h-9 rounded-full bg-sky-500 hover:bg-sky-600 text-white transition-transform hover:scale-110" title="× ×•×•×˜ ×¢× Waze"><i class="fa-brands fa-waze"></i></a>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="flex items-center justify-center w-9 h-9 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-transform hover:scale-110" title="× ×•×•×˜ ×¢× Google Maps"><i class="fa-solid fa-map-location-dot"></i></a>
            </div>` : '<div class="pt-3 mt-3"></div>';

            return `
            <div class="card p-3 flex flex-col" data-id="${hotel.id}">
                <div class="flex-grow">
                    <div class="flex items-start justify-between gap-3 mb-2">
                        <div class="icon-chip"><i class="fas fa-hotel fa-lg"></i></div>
                        <div class="flex flex-col items-end flex-1 min-w-0">
                            <h4 class="text-lg font-extrabold text-slate-800 text-right w-full break-words">${title}</h4>
                            <span class="price-chip mt-1.5">$${Number(price).toLocaleString()}</span>
                        </div>
                    </div>
                    <div class="space-y-1.5 mt-2">
                        ${place ? `<span class="badge w-full"><i class="fa-solid fa-location-dot"></i>${place}</span>` : ''}
                        ${dates ? `<span class="badge w-full"><i class="fa-regular fa-calendar"></i>${dates}</span>` : ''}
                        ${meals ? `<span class="badge w-full"><i class="fa-solid fa-utensils"></i>${meals}</span>` : ''}
                    </div>
                </div>
                ${navButtons}
            </div>`;
        }
       
        function createTransportCardHTML(item) {
            let title = '', subtitle = '', navAddress = '';
           
            const getIcon = (type) => {
                switch(type) {
                    case 'flight': return 'fa-plane-departure';
                    case 'car_rental': return 'fa-car';
                    case 'ferry': return 'fa-ship';
                    case 'train': return 'fa-train';
                    case 'ride': return 'fa-taxi';
                    default: return 'fa-ticket-alt';
                }
            };
            const getPriceDisplay = (item) => {
                if (item.price === undefined && item.price_per_person === undefined) return '';
                let totalPrice = (item.type === 'car_rental') ? (item.price || 0) : ((item.price_per_person || 0) * (item.travelers || 1));
                return `<div class="price-chip">$${Number(totalPrice).toLocaleString()}</div>`;
            };

            const arrowSpan = `<span class="inline-block" dir="ltr">&nbsp;&rarr;&nbsp;</span>`;

            switch(item.type) {
                case 'flight':
                    title = `${item.from?.destination || '?'}${arrowSpan}${item.to?.destination || '?'}`;
                    subtitle = `${item.airline || ''} #${item.flight_number || ''}`;
                    navAddress = item.from?.airport_address || item.from?.airport_name;
                    break;
                case 'car_rental':
                    title = `×¨×›×‘ ×©×›×•×¨ ×‘${item.destination || ''}`;
                    subtitle = item.booked_via || '';
                    navAddress = item.pickup_location;
                    break;
                case 'ferry':
                    title = `${item.from_destination || ''}${arrowSpan}${item.to_destination || ''}`;
                    subtitle = item.company || '';
                    navAddress = item.from_destination;
                    break;
                case 'train':
                    title = `${item.from_station || ''}${arrowSpan}${item.to_station || ''}`;
                    subtitle = item.company || '';
                    navAddress = item.from_station;
                    break;
                case 'ride':
                    title = `×”×¡×¢×” ×: ${item.from_address?.split(',')[0] || '?'}`;
                    subtitle = item.driver_name || '×”×¡×¢×” ×¤×¨×˜×™×ª';
                    navAddress = item.from_address;
                    break;
            }

            const navButtons = navAddress ? `
            <div class="card-footer">
                ${item.type === 'ride' && item.driver_phone ? `<a href="tel:${item.driver_phone}" onclick="event.stopPropagation()" class="flex items-center justify-center w-9 h-9 rounded-full bg-green-500 hover:bg-green-600 text-white transition-transform hover:scale-110" title="×¦×œ×¦×œ ×œ× ×”×’"><i class="fa-solid fa-phone"></i></a>` : ''}
                <a href="https://waze.com/ul?q=${encodeURIComponent(navAddress)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="flex items-center justify-center w-9 h-9 rounded-full bg-sky-500 hover:bg-sky-600 text-white transition-transform hover:scale-110" title="× ×•×•×˜ ×¢× Waze"><i class="fa-brands fa-waze"></i></a>
                <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(navAddress)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="flex items-center justify-center w-9 h-9 rounded-full bg-blue-500 hover:bg-blue-600 text-white transition-transform hover:scale-110" title="× ×•×•×˜ ×¢× Google Maps"><i class="fa-solid fa-map-location-dot"></i></a>
            </div>` : '<div class="pt-3 mt-3"></div>';
           
            const departureTime = item.pickup_time || item.departure_time;
            const arrivalTime = item.arrival_time;

            return `
            <div class="card transport-card p-3 flex flex-col" data-id="${item.id}">
                <div class="flex-grow">
                    <div class="flex items-start justify-between gap-3 mb-2">
                         <div class="icon-chip"><i class="fas ${getIcon(item.type)} fa-lg"></i></div>
                        <div class="flex flex-col items-end flex-1 min-w-0">
                            <h4 class="font-extrabold text-slate-800 text-right w-full break-words text-lg">${title || '××¢×‘×¨'}</h4>
                            ${subtitle ? `<p class="text-sm text-slate-500 text-right w-full">${subtitle}</p>` : ''}
                        </div>
                       ${getPriceDisplay(item)}
                    </div>
                    <div class="space-y-1.5 mt-2">
                        <span class="badge w-full"><i class="fa-regular fa-calendar"></i>${item.dates || item.date || ''}</span>
                        ${departureTime ? `<span class="badge w-full"><i class="fa-solid fa-plane-departure"></i>×™×¦×™××”: ${departureTime}</span>` : ''}
                        ${arrivalTime ? `<span class="badge w-full"><i class="fa-solid fa-plane-arrival"></i>×”×’×¢×”: ${arrivalTime}</span>` : ''}
                    </div>
                </div>
                ${navButtons}
            </div>`;
        }

        async function renderCostsSummary(items) {
            const container = DOM.costsSummaryContainer;
            const usdToIlsRate = await getRate('USD', 'ILS');
           
            let totalCost = 0;
            let hotelCost = 0;
            let transportCost = 0;

            items.forEach(item => {
                let itemCost = 0;
                if (item.type === 'hotel' || item.type === 'car_rental') {
                    itemCost = Number(item.price) || 0;
                } else {
                    itemCost = (Number(item.price_per_person) || 0) * (Number(item.travelers) || 1);
                }
                totalCost += itemCost;

                if (item.type === 'hotel') {
                    hotelCost += itemCost;
                } else if (['flight', 'car_rental', 'ferry', 'train', 'ride'].includes(item.type)) {
                    transportCost += itemCost;
                }
            });

            container.innerHTML = `
                <div class="space-y-4">
                     <div class="text-center">
                         <p class="text-slate-600 text-lg">×¡×”"×› ×¢×œ×•×ª ××©×•×¢×¨×ª (×œ×•×’×™×¡×˜×™×§×”)</p>
                         <p class="text-4xl font-extrabold text-blue-700 mt-1">$${totalCost.toLocaleString()}</p>
                         <p class="text-xl font-bold text-slate-500 mt-1">~ â‚ª${(totalCost * usdToIlsRate).toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}*</p>
                     </div>
                     <div class="pt-4 border-t">
                         <table class="w-full text-right">
                             <thead>
                                 <tr>
                                     <th class="py-2 font-semibold text-slate-700">×§×˜×’×•×¨×™×”</th>
                                     <th class="py-2 font-semibold text-slate-700 text-left">×¢×œ×•×ª ($)</th>
                                     <th class="py-2 font-semibold text-slate-700 text-left">×¢×œ×•×ª (â‚ª)</th>
                                 </tr>
                             </thead>
                             <tbody>
                                 <tr class="border-b">
                                     <td class="py-2 text-slate-600">ğŸ¨ ××œ×•× ×•×ª</td>
                                     <td class="py-2 text-slate-800 font-mono text-left">$${hotelCost.toLocaleString()}</td>
                                     <td class="py-2 text-slate-500 font-mono text-left">â‚ª${(hotelCost * usdToIlsRate).toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                 </tr>
                                 <tr class="border-b">
                                     <td class="py-2 text-slate-600">âœˆï¸ ××¢×‘×¨×™×</td>
                                     <td class="py-2 text-slate-800 font-mono text-left">$${transportCost.toLocaleString()}</td>
                                     <td class="py-2 text-slate-500 font-mono text-left">â‚ª${(transportCost * usdToIlsRate).toLocaleString('he-IL', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
                                 </tr>
                             </tbody>
                         </table>
                     </div>
                     <div class="text-center text-xs text-slate-400 pt-2">
                         *×”×”××¨×” ×œ×©×§×œ ×”×™× ×œ×¤×™ ×©×¢×¨ ×¢×“×›× ×™ ×©×œ ${usdToIlsRate.toFixed(4)} â‚ª ×œ-$.
                         <a href="logistics.html?tripId=${tripId}" class="block mt-1 text-sm text-blue-600 font-semibold hover:underline">×œ× ×™×”×•×œ ×¢×œ×•×™×•×ª ×•×¤×™×¨×•×˜ ××œ×</a>
                     </div>
                </div>
            `;
        }
       
        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? (docSnap.data().name || '××©×ª××©') : '××©×ª××©';
                DOM.authContainer.innerHTML = `<button id="user-name-btn" class="text-slate-700 font-bold hover:text-blue-600 transition-colors">×©×œ×•×, ${name}</button>`;
                document.getElementById('user-name-btn').addEventListener('click', () => {
                    DOM.logoutModal.classList.remove('hidden');
                });
            });
        }

        function buildNavButtons() {
            const buttons = [
                { title: '× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”', icon: 'fa-plane-departure', page: 'summary' },
                { title: '××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª', icon: 'fa-map-marked-alt', page: 'attractions' },
                { title: '×¨×©×™××•×ª ×•×¦\'×§ ×œ×™×¡×˜×™×', icon: 'fa-list-check', page: 'checklists' },
                { title: '××¢×§×‘ ×”×•×¦××•×ª', icon: 'fa-dollar-sign', page: 'expenses' },
            ];
            DOM.mainNavButtons.innerHTML = buttons.map(btn => `
                <a href="${btn.page}.html?tripId=${tripId}" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 border border-white/20 flex flex-col items-center justify-center p-4 rounded-xl text-white text-center">
                    <i class="fas ${btn.icon} text-3xl mb-2"></i><span class="font-bold">${btn.title}</span>
                </a>
            `).join('');
        }

        // --- Helper Functions ---
        function parseDDMMYYYY(s){
            if (!s || typeof s !== 'string') return null;
            const [d,m,y] = s.split('/').map(Number);
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            return new Date(y, m-1, d);
        }
        function hebWeekday(d){
            const n = d.toLocaleDateString('he-IL', { weekday:'long' });
            return n.startsWith('×™×•×') ? n : `×™×•× ${n}`;
        }
        function dotted(d){
            return `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
        }
       
        async function prefetchAllCurrencyRates(expenses) {
            const uniqueCurrencies = [...new Set(expenses.map(e => e.currency))];
            const promises = uniqueCurrencies
                .filter(c => c !== 'ILS' && !rateCache[`${c}-ILS`])
                .map(c => getRate(c, 'ILS'));
            await Promise.all(promises);
        }

        async function getRate(from, to) {
            if (from === to) return 1;
            const cacheKey = `${from}-${to}`;
            if (rateCache[cacheKey]) return rateCache[cacheKey];
            try {
                const res = await fetch(`https://api.frankfurter.app/latest?from=${from}&to=${to}`);
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const rate = data.rates[to];
                if (typeof rate !== 'number') return 1;
                rateCache[cacheKey] = rate;
                return rate;
            } catch (error) {
                console.error('Failed to fetch currency rate:', error);
                // A reasonable fallback for USD to ILS if API fails
                if (from === 'USD' && to === 'ILS') return 3.7; 
                return 1; // Generic fallback
            }
        }
       
        async function convertToILS(amount, currency) {
            if (!currency || currency === 'ILS') return amount;
            const rate = rateCache[`${currency}-ILS`] || await getRate(currency, 'ILS');
            return amount * rate;
        }

        // --- NEW SIDEBAR LOGIC (Updated to match request) ---
        function buildSidebarMenu() {
            DOM.mainMenu.innerHTML = ''; // Clear existing content

            // 1. Static Navigation Buttons
            const tParam = `?tripId=${tripId}`;
            const navLinks = [
                { name: '××¨×›×– ×”×‘×§×¨×”', icon: 'fa-home', href: `trip.html${tParam}`, color: 'text-blue-600', bg: 'bg-blue-50' },
                { name: '× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”', icon: 'fa-suitcase', href: `summary.html${tParam}`, color: 'text-orange-600', bg: 'bg-orange-50' },
                { name: '××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª', icon: 'fa-utensils', href: `attractions.html${tParam}`, color: 'text-cyan-600', bg: 'bg-cyan-50' },
                { name: '×¨×©×™××•×ª ×•×¦\'×§ ×œ×™×¡×˜', icon: 'fa-list-check', href: `checklists.html${tParam}`, color: 'text-emerald-600', bg: 'bg-emerald-50' },
                { name: '××¢×§×‘ ×”×•×¦××•×ª', icon: 'fa-coins', href: `expenses.html${tParam}`, color: 'text-rose-600', bg: 'bg-rose-50' },
                { name: '×‘× ×™×™×ª ××¡×œ×•×œ ×—×›×', icon: 'fa-magic-wand-sparkles', href: `edit-trip.html${tParam}`, color: 'text-purple-600', bg: 'bg-purple-50' }
            ];

            const navContainer = document.createElement('div');
            navContainer.className = 'space-y-2 mb-6';

            const currentPath = window.location.pathname;

            navLinks.forEach(link => {
                const a = document.createElement('a');
                a.href = link.href;
                // Simple active check logic
                const isActive = currentPath.includes(link.href.split('?')[0]); 

                a.className = `flex items-center gap-3 w-full p-3 rounded-xl transition-all hover:translate-x-1 ${isActive ? 'bg-slate-100 font-bold border-r-4 border-cyan-500' : 'hover:bg-slate-50'}`;
                
                a.innerHTML = `
                    <div class="w-10 h-10 rounded-full ${link.bg} ${link.color} flex items-center justify-center shadow-sm">
                        <i class="fas ${link.icon}"></i>
                    </div>
                    <span class="text-slate-700 ${isActive ? 'font-bold' : 'font-medium'}">${link.name}</span>
                `;
                navContainer.appendChild(a);
            });
            DOM.mainMenu.appendChild(navContainer);

            // 2. Separator and Header
            const separator = document.createElement('div');
            separator.className = 'h-px bg-slate-200 my-4';
            DOM.mainMenu.appendChild(separator);

            const scheduleHeader = document.createElement('h3');
            scheduleHeader.className = 'text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2';
            scheduleHeader.innerText = "×œ×•×´×– ×™×•××™ ×œ×¤×™ ×™×¢×“×™×";
            DOM.mainMenu.appendChild(scheduleHeader);

            // 3. Dynamic Destinations from Firebase Data
            if (!tripData?.destinations || !Array.isArray(tripData.destinations)) {
                DOM.mainMenu.insertAdjacentHTML('beforeend', '<p class="text-center text-slate-400 text-sm">×œ× ×”×•×’×“×¨×• ×™×¢×“×™× ×œ×˜×™×•×œ ×–×”.</p>');
                return;
            }

            // Sort destinations by date
            const sortedDestinations = [...tripData.destinations].sort((a, b) => {
                const dateA = parseDDMMYYYY(a.dates?.split(' - ')[0]);
                const dateB = parseDDMMYYYY(b.dates?.split(' - ')[0]);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            sortedDestinations.forEach(dest => {
                const destinationDiv = document.createElement('div');
                destinationDiv.className = 'mb-2';

                // Destination Header (Accordion Button)
                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 hover:bg-cyan-50 rounded-xl font-bold text-slate-700 flex justify-between items-center transition-all group';
                button.innerHTML = `
                    <span class="flex items-center gap-3">
                        <i class="fas fa-map-marked-alt text-slate-400 group-hover:text-cyan-500 transition-colors"></i> 
                        ${dest.nameHe || dest.name}
                    </span> 
                    <i class="fas fa-chevron-down chevron-icon text-slate-300 text-sm"></i>`;

                // Submenu for Days
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-4 border-r-2 border-slate-100 pr-2 space-y-1';

                if (dest.dates) {
                    const dates = generateDatesFromRange(dest.dates);
                    dates.forEach(dateStr => {
                        const d = parseDDMMYYYY(dateStr);
                        if (!d) return;
                        
                        const a = document.createElement('a');
                        const destNameParam = encodeURIComponent(dest.nameHe || dest.name);
                        a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
                        
                        a.className = 'block w-full text-right py-2 px-3 text-slate-600 hover:bg-slate-50 hover:text-cyan-700 rounded-lg transition text-sm';
                        a.innerHTML = `
                            <div class="flex items-center gap-2">
                                <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                                <span class="font-medium">${hebWeekday(d)}</span>
                                <span class="text-xs text-slate-400">(${dotted(d)})</span>
                            </div>
                        `;
                        submenu.appendChild(a);
                    });
                } else {
                    const noDates = document.createElement('div');
                    noDates.className = 'text-xs text-slate-400 pr-3 py-1';
                    noDates.innerText = '×œ×œ× ×ª××¨×™×›×™×';
                    submenu.appendChild(noDates);
                }

                // Toggle Event
                button.addEventListener('click', () => {
                    submenu.classList.toggle('open');
                    button.querySelector('.chevron-icon').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }

        function buildTripMap() {
            const mapContainer = DOM.tripMapContainer;
            if (!mapContainer) return;

            if (mapContainer._leaflet_id) {
                mapContainer._leaflet_id = null;
                mapContainer.innerHTML = "";
            }

            const tripMap = L.map(mapContainer).setView([38, -95], 3.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap Â© CARTO' }).addTo(tripMap);

            const points = (tripData.destinations || [])
                .filter(d => d.coords)
                .map(d => [d.coords.lat, d.coords.lng]);

            (tripData.destinations || []).forEach(dest => {
                if (dest.coords) {
                    L.marker([dest.coords.lat, dest.coords.lng])
                     .addTo(tripMap)
                     .bindTooltip(dest.nameHe, {permanent: true, direction: 'top', offset: [0, -10]}).openTooltip();
                }
            });

            if (points.length > 1) {
                L.polyline(points, { color: '#38bdf8', weight: 3, opacity: 0.7, dashArray: '5, 10' }).addTo(tripMap);
                tripMap.fitBounds(points, { padding: [50, 50] });
            } else if (points.length === 1) {
                tripMap.setView(points[0], 8);
            }
        }

        // --- More Helper Functions ---
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDDMMYYYY(startStr);
            const endDate = parseDDMMYYYY(endStr);
            if (!startDate || !endDate) return [];
           
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const dd = String(currentDate.getDate()).padStart(2,'0');
                const mm = String(currentDate.getMonth()+1).padStart(2,'0');
                const yyyy = currentDate.getFullYear();
                dates.push(`${dd}/${mm}/${yyyy}`);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function getStartDate(item) {
            let dateStr = item.dates || item.date;
            if (!dateStr || typeof dateStr !== 'string') return null;

            if (dateStr.includes(' - ')) {
                dateStr = dateStr.split(' - ')[0].trim();
            }

            return parseDate(dateStr);
        }
       
        // --- UPDATED TOGGLE SIDEBAR LOGIC ---
        function toggleSidebar() {
            const isClosed = DOM.sidebar.classList.contains('translate-x-full');
            if (isClosed) {
                // Open
                DOM.sidebar.classList.remove('translate-x-full');
                DOM.overlay.classList.remove('hidden');
                // Request animation frame to allow browser to render before adding opacity class
                requestAnimationFrame(() => {
                    DOM.overlay.classList.remove('opacity-0');
                });
                document.body.classList.add('modal-locked'); // Lock body scroll
            } else {
                // Close
                DOM.sidebar.classList.add('translate-x-full');
                DOM.overlay.classList.add('opacity-0');
                setTimeout(() => {
                    DOM.overlay.classList.add('hidden');
                    document.body.classList.remove('modal-locked');
                }, 300); // Matches transition duration
            }
        }

        // --- Navigation Modal Logic ---
        function openNavModal({ title, options = [], message = '' }) {
            document.getElementById('nav-modal-title').textContent = title;
            const navContent = DOM.navModalContent;
            const navMessage = document.getElementById('nav-modal-message');

            navContent.innerHTML = '';
            navMessage.textContent = '';
           
            if (options.length === 1 && options[0].address) {
                const { address } = options[0];
                navContent.innerHTML = `
                    <a href="https://waze.com/ul?q=${encodeURIComponent(address)}" target="_blank" class="block w-full text-center bg-[#33ccff] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#00bfff] transition text-lg"><i class="fa-brands fa-waze"></i> Waze</a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" class="block w-full text-center bg-[#4285F4] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#3367D6] transition text-lg"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a>
                `;
                navMessage.textContent = message;
            } else if (options.length > 1) {
                navContent.innerHTML = options.map(opt =>
                    `<button data-address="${opt.address}" class="hotel-choice-btn block w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3 px-4 rounded-lg transition">${opt.name}</button>`
                ).join('');
                navMessage.textContent = "×™×© ×œ×‘×—×•×¨ ×œ××™×–×” ××œ×•×Ÿ ×œ× ×•×•×˜:";
            } else {
                navMessage.textContent = message || '×œ× × ××¦× ×™×¢×“ ×œ× ×™×•×•×˜.';
            }

            DOM.navModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.navModal.classList.remove('opacity-0')
                DOM.navModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
            }, 10);
        }
       
        function closeNavModal() {
            DOM.navModal.classList.add('opacity-0');
            DOM.navModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => DOM.navModal.classList.add('hidden'), 300);
        }

        function parseDate(dateStr) {
            return parseDDMMYYYY(dateStr);
        }

        function isDateInRange(checkDate, rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return false;
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDate(startStr);
            const endDate = parseDate(endStr);
            if (!startDate || !endDate) return false;

            const normalizedCheckDate = new Date(checkDate);
            normalizedCheckDate.setHours(0, 0, 0, 0);

            return normalizedCheckDate >= startDate && normalizedCheckDate <= endDate;
        }

        async function handleNavigateToHotel() {
            const hotels = allLogisticsItems.filter(item => item.type === 'hotel' && item.address);
            if (hotels.length === 0) {
                openNavModal({ title: '× ×™×•×•×˜ ×œ××œ×•×Ÿ', message: '×œ× × ××¦××• ××œ×•× ×•×ª ×¢× ×›×ª×•×‘×ª ×‘×˜×™×•×œ ×–×”.' });
                return;
            }

            const today = new Date();
            const todaysHotels = hotels.filter(h => isDateInRange(today, h.dates));

            if (todaysHotels.length > 0) {
                openNavModal({
                    title: '× ×•×•×˜ ×œ××œ×•×Ÿ ×œ×”×™×•×',
                    options: todaysHotels.map(h => ({ name: h.name, address: h.address }))
                });
                return;
            }

            const futureHotels = hotels
                .map(h => ({ ...h, startDate: getStartDate(h) }))
                .filter(h => h.startDate && h.startDate >= today)
                .sort((a, b) => a.startDate - b.startDate);

            if (futureHotels.length > 0) {
                const nextHotel = futureHotels[0];
                openNavModal({
                    title: `×”××œ×•×Ÿ ×”×‘×`,
                    message: `${nextHotel.name} (×‘×ª××¨×™×š ${nextHotel.dates.split(' - ')[0]})`,
                    options: [{ name: nextHotel.name, address: nextHotel.address }]
                });
                return;
            }

            openNavModal({ title: '× ×™×•×•×˜ ×œ××œ×•×Ÿ', message: '×œ× × ××¦× ××œ×•×Ÿ ×œ×”×™×•× ××• ×‘×¢×ª×™×“.' });
        }

        // --- UPDATED DETAILS MODAL LOGIC ---

        function openDetailsModal(item) {
            if (!item) return;

            let contentHtml = '';
            switch(item.type) {
                case 'hotel': contentHtml = generateHotelDetailsHTML(item); break;
                case 'ride': contentHtml = generateRideDetailsHTML(item); break;
                case 'flight': contentHtml = generateFlightDetailsHTML(item); break;
                case 'car_rental': contentHtml = generateCarRentalDetailsHTML(item); break;
                case 'ferry': contentHtml = generateFerryDetailsHTML(item); break;
                case 'train': contentHtml = generateTrainDetailsHTML(item); break;
                default: contentHtml = `<p>××™×Ÿ ×ª×¦×•×’×” ××¤×•×¨×˜×ª ×¢×‘×•×¨ ×¡×•×’ ×¤×¨×™×˜ ×–×”.</p>`;
            }

            DOM.detailsModalBody.innerHTML = contentHtml;
           
            DOM.detailsModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.detailsModal.classList.remove('opacity-0');
                DOM.detailsModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
                initDetailsMap(item);
            }, 10);
        }

        function closeDetailsModal() {
            DOM.detailsModal.classList.add('opacity-0');
            DOM.detailsModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                DOM.detailsModal.classList.add('hidden');
                if (detailsMap) {
                    detailsMap.remove();
                    detailsMap = null;
                }
            }, 300);
        }
       
        // --- DETAILS HTML GENERATORS ---

        function createDetailItem(icon, label, value, extraClasses = '') {
            if (!value || value === '-') return '';
            return `<div class="bg-slate-50 p-3 rounded-lg ${extraClasses}">
                        <div class="text-xs text-slate-500 font-semibold flex items-center gap-2 mb-1"><i class="fas ${icon} fa-fw"></i> ${label}</div>
                        <div class="text-slate-800 font-bold text-base break-words">${value}</div>
                    </div>`;
        }
       
        function generatePaymentDetailsHTML_DisplayOnly(item) {
            const payment = item.payment || { status: 'unpaid' };
            const totalCost = (item.type === 'hotel' || item.type === 'car_rental') 
                ? (item.price || 0) 
                : ((item.price_per_person || 0) * (item.travelers || 1));

            let statusText, statusColor, amountText = '';
            switch (payment.status) {
                case 'paid':
                    statusText = '×©×•×œ× ×‘××œ×•××•';
                    statusColor = 'text-green-600';
                    amountText = `$${totalCost.toLocaleString()}`;
                    break;
                case 'partial':
                    statusText = '×ª×©×œ×•× ×—×œ×§×™';
                    statusColor = 'text-orange-600';
                    amountText = `$${(payment.amountPaid || 0).toLocaleString()} / $${totalCost.toLocaleString()}`;
                    break;
                default:
                    statusText = '×œ× ×©×•×œ×';
                    statusColor = 'text-red-600';
                    amountText = `$0 / $${totalCost.toLocaleString()}`;
            }

            return createDetailItem('fa-credit-card', '×¡×˜×˜×•×¡ ×ª×©×œ×•×', `<span class="font-bold ${statusColor}">${statusText}</span><br>${amountText}`, 'sm:col-span-2');
        }

        function generateHotelDetailsHTML(item) {
            DOM.detailsModalTitle.textContent = item.name || '×¤×¨×˜×™ ××œ×•×Ÿ';
            let starsHtml = '';
            if (item.stars && item.stars > 0) {
                for (let i = 0; i < 5; i++) {
                    starsHtml += `<i class="fas fa-star ${i < item.stars ? 'text-yellow-400' : 'text-slate-300'}"></i>`;
                }
            }
            let mealsHtml = (item.meals && Array.isArray(item.meals) && item.meals.length > 0) ? item.meals.join(', ') : '-';
           
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${createDetailItem('fa-map-pin', '×™×¢×“', item.destination)}
                    ${createDetailItem('fa-calendar-days', '×ª××¨×™×›×™×', item.dates)}
                    ${createDetailItem('fa-bookmark', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                    ${createDetailItem('fa-dollar-sign', '××—×™×¨', `$${(item.price || 0).toLocaleString()}`)}
                    ${createDetailItem('fa-utensils', '××¨×•×—×•×ª', mealsHtml)}
                    ${createDetailItem('fa-star', '×“×™×¨×•×’ ×›×•×›×‘×™×', starsHtml)}
                    ${createDetailItem('fa-thumbs-up', '×“×™×¨×•×’ ×‘×•×§×™× ×’', item.booking_rating)}
                    ${createDetailItem('fa-location-dot', '×›×ª×•×‘×ª', item.address, 'sm:col-span-2')}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-2 gap-4 mt-4">
                    <a href="${item.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition ${item.address ? '' : 'opacity-50 cursor-not-allowed'}">× ×™×•×•×˜ <i class="fa-solid fa-diamond-turn-right text-xs"></i></a>
                </div>
                ${item.coords ? '<div id="details-map" class="details-map-container mt-4"></div>' : ''}
            `;
        }

        function generateRideDetailsHTML(item) {
            const title = `×”×¡×¢×”: ${item.from_address?.split(',')[0] || ''} â†’ ${item.to_address?.split(',')[0] || ''}`;
            DOM.detailsModalTitle.textContent = title;

            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${createDetailItem('fa-arrow-up', '×××™×¤×”', item.from_address, 'sm:col-span-2')}
                    ${createDetailItem('fa-arrow-down', '×œ××™×¤×”', item.to_address, 'sm:col-span-2')}
                    ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                    ${createDetailItem('fa-clock', '×©×¢×ª ××™×¡×•×£', item.pickup_time)}
                    ${createDetailItem('fa-building', '×—×‘×¨×”', item.company)}
                    ${createDetailItem('fa-bookmark', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                    ${createDetailItem('fa-user-tie', '×©× × ×”×’', item.driver_name)}
                    ${createDetailItem('fa-phone', '×˜×œ×¤×•×Ÿ × ×”×’', item.driver_phone ? `<a href="tel:${item.driver_phone}" class="text-blue-600 hover:underline">${item.driver_phone}</a>` : '-')}
                    ${createDetailItem('fa-car', '×¤×¨×˜×™ ×¨×›×‘', `${item.vehicle_details || ''} (${item.vehicle_number || ''})`)}
                    ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                    ${createDetailItem('fa-dollar-sign', '××—×™×¨', `$${((item.price_per_person || 0) * (item.travelers || 1)).toLocaleString()}`)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
                ${item.route_geometry ? '<div id="details-map" class="details-map-container mt-4"></div>' : ''}
                `;
        }

        function generateFlightDetailsHTML(item) {
            const title = `×˜×™×¡×”: ${item.from?.destination || ''} â†’ ${item.to?.destination || ''}`;
            DOM.detailsModalTitle.textContent = title;
            const travelers = item.travelers || (item.seats?.length || 1);
            const totalPrice = (item.price_per_person || 0) * travelers;
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${createDetailItem('fa-plane', '×—×‘×¨×ª ×ª×¢×•×¤×”', `${item.airline || '-'} #${item.flight_number || ''}`)}
                    ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date || item.dates)}
                    ${createDetailItem('fa-clock', '×©×¢×ª ×”××¨××”', item.departure_time)}
                    ${createDetailItem('fa-clock', '×©×¢×ª × ×—×™×ª×”', item.arrival_time)}
                    ${createDetailItem('fa-users', '× ×•×¡×¢×™×', travelers)}
                    ${createDetailItem('fa-tag', '××—×™×¨ ×œ× ×•×¡×¢', `$${(item.price_per_person || 0).toLocaleString()}`)}
                    ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `<span class="font-bold text-green-700 text-base">$${totalPrice.toLocaleString()}</span>`,'bg-green-50 sm:col-span-2')}
                    ${createDetailItem('fa-chair', '××§×•××•×ª', (item.seats || []).join(', ') || '-', 'sm:col-span-2')}
                     ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                ${(item.from?.coords || item.to?.coords) ? '<div id="details-map" class="details-map-container mt-4"></div>' : ''}
                `;
        }
       
         function generateCarRentalDetailsHTML(item) {
            DOM.detailsModalTitle.textContent = `×¨×›×‘ ×©×›×•×¨: ${item.destination || ''}`;
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${createDetailItem('fa-location-dot', '××™×§×•× ××™×¡×•×£', item.pickup_location, 'sm:col-span-2')}
                    ${createDetailItem('fa-calendar-days', '×ª××¨×™×›×™×', item.dates)}
                    ${createDetailItem('fa-clock', '×©×¢×•×ª', `${item.pickup_time || '?'} - ${item.return_time || '?'}`)}
                    ${createDetailItem('fa-car-side', '×¡×•×’ ×¨×›×‘', item.car_type)}
                    ${createDetailItem('fa-bookmark', '×”×•×–××Ÿ ×“×¨×š', item.booked_via)}
                    ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                    ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `$${(item.price || 0). toLocaleString()}`)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
                `;
        }
       
        function generateFerryDetailsHTML(item) {
             const title = `××¢×‘×•×¨×ª: ${item.from_destination || ''} â†’ ${item.to_destination || ''}`;
             DOM.detailsModalTitle.textContent = title;
             const totalPrice = (item.price_per_person || 0) * (item.travelers || 1);
             return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${createDetailItem('fa-building', '×—×‘×¨×”', item.company)}
                    ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                    ${createDetailItem('fa-clock', '×©×¢×ª ×™×¦×™××”', item.departure_time)}
                    ${createDetailItem('fa-clock', '×©×¢×ª ×”×’×¢×”', item.arrival_time)}
                    ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                    ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `$${totalPrice.toLocaleString()}`)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
                `;
        }
       
        function generateTrainDetailsHTML(item) {
              const title = `×¨×›×‘×ª: ${item.from_station || ''} â†’ ${item.to_station || ''}`;
              DOM.detailsModalTitle.textContent = title;
              const totalPrice = (item.price_per_person || 0) * (item.travelers || 1);
              return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
                    ${createDetailItem('fa-building', '×—×‘×¨×”', item.company)}
                    ${createDetailItem('fa-calendar-day', '×ª××¨×™×š', item.date)}
                    ${createDetailItem('fa-clock', '×©×¢×ª ×™×¦×™××”', item.departure_time)}
                    ${createDetailItem('fa-clock', '×©×¢×ª ×”×’×¢×”', item.arrival_time)}
                    ${createDetailItem('fa-chair', '××•×©×‘×™×', item.seat_info)}
                    ${createDetailItem('fa-users', '× ×•×¡×¢×™×', item.travelers)}
                    ${createDetailItem('fa-dollar-sign', '××—×™×¨ ×›×•×œ×œ', `$${totalPrice.toLocaleString()}`, 'sm:col-span-2')}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-100 rounded-lg mt-4"><h5 class="font-bold mb-2">×¤×¨×˜×™× × ×•×¡×¤×™×:</h5><p class="whitespace-pre-wrap">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-1 gap-4 mt-4">
                    <a href="${item.booking_link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${item.booking_link ? '' : 'opacity-50 cursor-not-allowed'}">×§×™×©×•×¨ ×œ×”×–×× ×” <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                </div>
                `;
        }

        // --- Details Modal Map (using Leaflet) ---
        function initDetailsMap(item) {
            if (detailsMap) {
                detailsMap.remove();
                detailsMap = null;
            }
            const mapContainer = document.getElementById('details-map');
            if (!mapContainer) return;

            detailsMap = L.map('details-map').setView([31.7683, 35.2137], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: 'Â© OpenStreetMap Â© CARTO' }).addTo(detailsMap);
            const layerGroup = L.layerGroup().addTo(detailsMap);

            const points = [];

            switch (item.type) {
                case 'hotel':
                    if (item.coords) {
                        const coords = [item.coords.lat, item.coords.lng || item.coords.lon];
                        L.marker(coords).addTo(layerGroup);
                        points.push(coords);
                    }
                    break;
                case 'ride':
                    let route_geometry = item.route_geometry;
                    if (typeof route_geometry === 'string') {
                        try { route_geometry = JSON.parse(route_geometry); } catch (e) { route_geometry = null; }
                    }
                    if (route_geometry && Array.isArray(route_geometry) && item.from_coords && item.to_coords) {
                        const fromCoords = [item.from_coords.lat, item.from_coords.lng || item.from_coords.lon];
                        const toCoords = [item.to_coords.lat, item.to_coords.lng || item.to_coords.lon];
                        L.marker(fromCoords).addTo(layerGroup).bindPopup('×”×ª×—×œ×”');
                        L.marker(toCoords).addTo(layerGroup).bindPopup('×¡×™×•×');
                       
                        const latlngs = route_geometry.map(coord => L.latLng(coord.lat, coord.lng));
                        L.polyline(latlngs, { color: '#3b82f6', weight: 5 }).addTo(layerGroup);
                        points.push(fromCoords, toCoords);
                    }
                    break;
                case 'flight':
                    const allLegs = [item.from, ...(item.connections || []), item.to];
                    allLegs.forEach(leg => {
                        if (leg && leg.coords) {
                            const coords = [leg.coords.lat, leg.coords.lng || leg.coords.lon];
                            points.push(coords);
                            L.marker(coords).addTo(layerGroup).bindPopup(leg.destination || '');
                        }
                    });
                    if (points.length > 1) {
                         L.polyline(points, { color: '#3b82f6', weight: 3, dashArray: '10, 10' }).addTo(layerGroup);
                    }
                    break;
            }

            if (points.length > 1) {
                detailsMap.fitBounds(points, { padding: [40, 40] });
            } else if (points.length === 1) {
                detailsMap.setView(points[0], 13);
            }

            setTimeout(() => detailsMap.invalidateSize(), 100);
        }

        // --- Edit Destinations Modal Logic ---
        function openEditDestinationsModal(){
            DOM.tripDatesEdit.value = (tripData.startDate && tripData.endDate) ? `${tripData.startDate} - ${tripData.endDate}` : '';
            new Litepicker({ element: DOM.tripDatesEdit, singleMode:false, lang:'he-IL', format:'DD/MM/YYYY' });

            DOM.destinationsList.innerHTML = '';
            editUI.clear();

            (tripData.destinations || []).forEach((dest, idx) => addDestRow(dest, idx));

            DOM.editDestModal.classList.remove('hidden');
        }
        function closeEditDestinationsModal(){ DOM.editDestModal.classList.add('hidden'); }

        function addDestRow(dest = {}, idx = Date.now()){
            const id = `dest-${idx}-${Math.random().toString(36).slice(2,7)}`;
            const el = document.createElement('div');
            el.className = 'edit-dest-card bg-white rounded-xl shadow p-4';
            el.dataset.destId = id;
            el.innerHTML = `
                <div class="flex items-start gap-3 justify-between">
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold mb-1">×©× ×”×™×¢×“ (×¢×‘×¨×™×ª)</label>
                            <input type="text" class="dest-name-he w-full p-2 border rounded-md" value="${dest.nameHe || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">×©× ×”×™×¢×“ (×× ×’×œ×™×ª ×œ×—×™×¤×•×©)</label>
                            <div class="flex gap-2">
                                <input type="text" class="dest-name-en w-full p-2 border rounded-md" value="${dest.nameEn || ''}">
                                <button class="find-btn bg-sky-600 hover:bg-sky-700 text-white px-3 rounded-md text-sm">××¦×</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">×ª××¨×™×›×™× ×‘×™×¢×“</label>
                            <input type="text" class="dest-dates w-full p-2 border rounded-md text-center" value="${dest.dates || ''}" placeholder="DD/MM/YYYY - DD/MM/YYYY">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">×›×ª×•×‘×ª ×¨×§×¢ (××•×¤×¦×™×•× ×œ×™)</label>
                            <input type="url" class="dest-bg w-full p-2 border rounded-md" value="${dest.backgroundUrl || ''}">
                        </div>
                    </div>
                    <button class="remove-btn text-red-600 hover:text-red-700" title="××—×§ ×™×¢×“"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="mt-3 w-full h-44 rounded-lg overflow-hidden bg-slate-100">
                    <div class="map w-full h-full"></div>
                </div>
                <div class="mt-2 text-xs text-slate-500">× ×§×•×“×ª ××¤×”: <span class="coords">${dest.coords ? `${dest.coords.lat.toFixed(5)}, ${dest.coords.lng.toFixed(5)}` : '×œ× × ×‘×—×¨'}</span></div>
            `;
            DOM.destinationsList.appendChild(el);

            new Litepicker({ element: el.querySelector('.dest-dates'), singleMode:false, lang:'he-IL', format:'DD/MM/YYYY' });

            const mapDiv = el.querySelector('.map');
            const map = L.map(mapDiv).setView(dest.coords ? [dest.coords.lat, dest.coords.lng] : [20,0], dest.coords ? 10 : 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const marker = dest.coords ? L.marker([dest.coords.lat, dest.coords.lng]).addTo(map) : null;

            editUI.set(id, { el, map, marker });

            el.querySelector('.find-btn').addEventListener('click', async () => {
                const q = el.querySelector('.dest-name-en').value.trim();
                if (!q) { showAlert('×—×™×¤×•×©', '×™×© ×œ×›×ª×•×‘ ×©× ×™×¢×“ ×‘×× ×’×œ×™×ª ×›×“×™ ×œ×‘×¦×¢ ×—×™×¤×•×©.'); return; }
                try{
                    const btn = el.querySelector('.find-btn');
                    btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
                    const data = await res.json();
                    if (data && data.length){
                        const { lat, lon } = data[0];
                        const latNum = parseFloat(lat), lngNum = parseFloat(lon);
                        if (editUI.get(id).marker) editUI.get(id).marker.setLatLng([latNum, lngNum]);
                        else editUI.get(id).marker = L.marker([latNum, lngNum]).addTo(editUI.get(id).map);
                        editUI.get(id).map.setView([latNum, lngNum], 12);
                        el.querySelector('.coords').textContent = `${latNum.toFixed(5)}, ${lngNum.toFixed(5)}`;
                        el.dataset.coords = JSON.stringify({lat:latNum, lng:lngNum});
                    } else {
                        showAlert('×—×™×¤×•×©', '×œ× × ××¦××” ×ª×•×¦××” ×¢×‘×•×¨ ×”×—×™×¤×•×© ×©×‘×™×¦×¢×ª.');
                    }
                    btn.disabled = false; btn.textContent = '××¦×';
                }catch(e){
                    console.error(e);
                    showAlert('×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘×—×™×¤×•×© ×”××™×§×•×.');
                    const btn = el.querySelector('.find-btn');
                    btn.disabled = false; btn.textContent = '××¦×';
                }
            });

            el.querySelector('.remove-btn').addEventListener('click', async () => {
                if (await showConfirm('××—×™×§×ª ×™×¢×“', '×”×× ××ª×” ×‘×˜×•×—? ×”×¤×¢×•×œ×” ×ª×¡×™×¨ ××ª ×”×™×¢×“ ××”×¨×©×™××” ×‘××•×¤×Ÿ ×–×× ×™. ×”×©×™× ×•×™×™× ×™×™×©××¨×• ×¨×§ ×œ××—×¨ ×œ×—×™×¦×” ×¢×œ "×©××•×¨ ×©×™× ×•×™×™×".')) {
                    editUI.get(id).map.remove();
                    editUI.delete(id);
                    el.remove();
                }
            });
        }

        function collectEditedDestinations(){
            const arr = [];
            DOM.destinationsList.querySelectorAll('[data-dest-id]').forEach(el => {
                const nameHe = el.querySelector('.dest-name-he').value.trim();
                const nameEn = el.querySelector('.dest-name-en').value.trim();
                const dates = el.querySelector('.dest-dates').value.trim();
                const backgroundUrl = el.querySelector('.dest-bg').value.trim();
                let coords = null;
                if (el.dataset.coords) {
                    try { coords = JSON.parse(el.dataset.coords); } catch {}
                } else if (editUI.get(el.dataset.destId)?.marker) {
                    const ll = editUI.get(el.dataset.destId).marker.getLatLng();
                    coords = { lat: ll.lat, lng: ll.lng };
                }
                if (!nameHe || !dates) return;
                arr.push({ nameHe, nameEn, dates, coords, backgroundUrl });
            });
            return arr;
        }

        async function saveDestinationsChanges(){
            const tripRef = doc(db, "trips", tripId);

            let startDate = tripData.startDate || null, endDate = tripData.endDate || null;
            const raw = DOM.tripDatesEdit.value.trim();
            if (raw && raw.includes(' - ')) {
                const [s,e] = raw.split(' - ');
                startDate = s; endDate = e;
            }
           
            const destinations = collectEditedDestinations();
           
            const updated = { ...tripData, startDate, endDate, destinations };
           
            try{
                DOM.saveDestinationsBtn.disabled = true;
                DOM.saveDestinationsBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>×©×•××¨...';
                await updateDoc(tripRef, updated);
                tripData = updated;
                // refresh UI
                buildSidebarMenu(); // Uses the new function
                buildTripMap();
                closeEditDestinationsModal();
            }catch(e){
                console.error(e);
                showAlert('×©×’×™××”', '××™×¨×¢×” ×©×’×™××” ×‘×©××™×¨×ª ×”×©×™× ×•×™×™×.');
            }finally{
                DOM.saveDestinationsBtn.disabled = false;
                DOM.saveDestinationsBtn.textContent = '×©××•×¨ ×©×™× ×•×™×™×';
            }
        }

        // --- Share Modal Logic ---
        function openShareModal() {
            DOM.shareModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.shareModal.classList.remove('opacity-0');
                DOM.shareModal.querySelector('.modal-content').classList.remove('opacity-0', 'scale-95');
            }, 10);
        }
        function closeShareModal() {
            DOM.shareModal.classList.add('opacity-0');
            DOM.shareModal.querySelector('.modal-content').classList.add('opacity-0', 'scale-95');
            setTimeout(() => DOM.shareModal.classList.add('hidden'), 300);
        }

        // --- Event Listeners ---
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);
        DOM.navigateHotelBtn.addEventListener('click', handleNavigateToHotel);
        DOM.navModalClose.addEventListener('click', closeNavModal);
       
        DOM.cancelLogoutBtn.addEventListener('click', () => DOM.logoutModal.classList.add('hidden'));
        DOM.confirmLogoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));

        DOM.shareTripBtn.addEventListener('click', openShareModal);
        DOM.shareModalCloseBtn.addEventListener('click', closeShareModal);
        DOM.shareAddEditorBtn.addEventListener('click', () => {
             if(tripId) window.location.href = `join.html?tripId=${tripId}`;
        });
        DOM.shareAsFileBtn.addEventListener('click', () => {
            if(tripId) window.location.href = `export.html?tripId=${tripId}`;
        });

        DOM.settingsBtn.addEventListener('click', openSettingsModal);
        DOM.closeSettingsBtn.addEventListener('click', closeSettingsModal);
        DOM.saveSettingsBtn.addEventListener('click', saveSettings);

        // Delete Trip Listeners
        DOM.deleteTripBtn.addEventListener('click', () => {
            DOM.settingsModal.classList.add('hidden');
            DOM.deleteModal1.classList.remove('hidden');
        });
        DOM.cancelDelete1.addEventListener('click', () => DOM.deleteModal1.classList.add('hidden'));
        DOM.confirmDelete1.addEventListener('click', () => {
            DOM.deleteModal1.classList.add('hidden');
            DOM.deleteModal2.classList.remove('hidden');
        });
        DOM.cancelDelete2.addEventListener('click', () => DOM.deleteModal2.classList.add('hidden'));
        DOM.confirmDelete2.addEventListener('click', deleteTrip);

        DOM.openEditDestBtn.addEventListener('click', () => {
            closeSettingsModal();
            openEditDestinationsModal();
        });

        DOM.editDestClose.addEventListener('click', closeEditDestinationsModal);
        DOM.editDestCancel.addEventListener('click', closeEditDestinationsModal);
        DOM.addDestBtn.addEventListener('click', () => addDestRow());
        DOM.saveDestinationsBtn.addEventListener('click', saveDestinationsChanges);

        DOM.detailsModalClose.addEventListener('click', closeDetailsModal);
       
        // Main content click listener for cards
        document.getElementById('main-content').addEventListener('click', (e) => {
            const card = e.target.closest('.card[data-id]');
            if (card) {
                const itemId = card.dataset.id;
                const item = allLogisticsItems.find(i => i.id === itemId);
                openDetailsModal(item);
            }
        });

        DOM.navModalContent.addEventListener('click', (e) => {
            const choiceBtn = e.target.closest('.hotel-choice-btn');
            if (choiceBtn) {
                const address = choiceBtn.dataset.address;
                const name = choiceBtn.textContent;
                if (address) {
                    openNavModal({ title: `× ×•×•×˜ ××œ ${name}`, options: [{ name, address }] });
                }
            }
        });

        // --- Start the page ---
        initPage();
    </script>
</body>
</html>

