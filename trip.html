<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>专 拽专 砖 </title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .submenu.open { max-height: 1200px; }
        #trip-map-container { height: 450px; border-radius: 1rem; z-index: 0; }
        .modal { transition: opacity 0.3s ease; }
        .main-nav-button {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .main-nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">注 转  砖...</p>
    </div>

    <!-- Fixed Background -->
    <div id="page-bg" class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/PXLTIi4.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <!-- Scrollable Content Wrapper -->
    <div class="relative z-10">
        <!-- Navigation Modal -->
        <div id="nav-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
                <h3 id="nav-modal-title" class="text-xl font-bold text-slate-800 mb-4"> ...</h3>
                <div id="nav-modal-content" class="flex flex-col gap-4">
                    <a id="nav-waze-link" href="#" target="_blank" class="block w-full text-center bg-[#33ccff] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#00bfff] transition text-lg"><i class="fa-brands fa-waze"></i> Waze</a>
                    <a id="nav-gmaps-link" href="#" target="_blank" class="block w-full text-center bg-[#4285F4] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#3367D6] transition text-lg"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a>
                </div>
                <p id="nav-modal-message" class="text-slate-600"></p>
                <button id="nav-modal-close" class="mt-6 text-slate-500 hover:text-slate-700">住专</button>
            </div>
        </div>

        <!-- Logout Modal -->
        <div id="logout-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4">转转拽转</h2>
                <p class="text-slate-600 mb-8"> 转  砖专爪 转转拽?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-logout-btn" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg"></button>
                    <button id="confirm-logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">转转拽</button>
                </div>
            </div>
        </div>

        <!-- Sidebar (Full Navigation Menu) -->
        <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
            <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
                <h2 class="text-2xl font-bold text-slate-800">转驻专 住注</h2>
                <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <nav id="main-menu" class="p-4 space-y-2"></nav>
        </aside>

        <!-- Main Content -->
        <div id="main-content" class="min-h-screen">
            <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <a href="index.html" class="text-slate-700 font-bold hover:text-blue-600"><i class="fas fa-home"></i> 祝 转</a>
                        <div class="flex items-center gap-4">
                            <div id="auth-container"></div>
                            <button id="navigate-hotel-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label=" "><i class="fas fa-hotel fa-lg"></i></button>
                            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-12">
                
                    <section class="text-center">
                        <h2 id="trip-title" class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg">注 转 砖 ...</h2>
                        <p class="mt-4 text-lg text-slate-200 max-w-3xl mx-auto"> 专 拽专 砖 !  驻砖专   注 砖.</p>
                        <div id="main-nav-buttons" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                            <!-- Buttons will be generated here -->
                        </div>
                    </section>

                    <section>
                        <h3 class="text-3xl font-bold text-white mb-4 text-center drop-shadow-md">驻转 住注 转</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-lg"><div id="trip-map-container"></div></div>
                    </section>

                    <section id="hotel-summary-section">
                        <h3 class="text-3xl font-bold text-white text-center drop-shadow-md mb-6"> 住 转</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                           <p class="text-white/80 text-center col-span-full"> 爪 专住转 转 专 砖转住祝 转 注专转 .</p>
                        </div>
                    </section>
                    
                    <section id="flight-summary-section">
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">锔 住 注专</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                            <p class="text-white/80 text-center col-span-full"> 爪 专住转 注专 (住转, 专 ') 专 砖转住祝 转.</p>
                        </div>
                    </section>

                    <section>
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md"> 住 注转</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                           <p class="text-slate-600 text-center">转 住 注转 爪 .</p>
                        </div>
                    </section>
                </div>
            </main>
        </div>
        
        <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            navModal: document.getElementById('nav-modal'),
            navModalClose: document.getElementById('nav-modal-close'),
            navigateHotelBtn: document.getElementById('navigate-hotel-btn'),
            logoutModal: document.getElementById('logout-modal'),
            cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
            confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
            authContainer: document.getElementById('auth-container'),
            tripTitle: document.getElementById('trip-title'),
            tripMapContainer: document.getElementById('trip-map-container'),
            mainNavButtons: document.getElementById('main-nav-buttons'),
        };

        let currentUser = null;
        let tripId = null;
        let tripData = null;

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id');
            if (!tripId) {
                alert("砖:  爪  .");
                window.location.href = 'index.html';
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadTripData();
                    setupAuthUI(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData() {
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);

            if (tripSnap.exists() && tripSnap.data().ownerId === currentUser.uid) {
                tripData = tripSnap.data();
                document.title = tripData.name;
                populateUI();
                DOM.loadingOverlay.style.display = 'none';
            } else {
                alert("  爪  砖  专砖 爪驻转 .");
                window.location.href = 'index.html';
            }
        }

        // --- UI Population ---
        function populateUI() {
            DOM.tripTitle.textContent = tripData.name;
            buildSidebarMenu();
            buildTripMap();
            buildNavButtons();
        }

        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? docSnap.data().name : '砖转砖';
                DOM.authContainer.innerHTML = `<button id="user-name-btn" class="text-slate-700 font-bold hover:text-blue-600">砖, ${name}</button>`;
                document.getElementById('user-name-btn').addEventListener('click', () => {
                    DOM.logoutModal.classList.remove('hidden');
                });
            });
        }
        
        function buildNavButtons() {
            const buttons = [
                { title: '住 注专 转', icon: 'fa-plane-departure', page: 'summary' },
                { title: '专拽爪转 住注转', icon: 'fa-map-marked-alt', page: 'attractions' },
                { title: '专砖转 爪\'拽 住', icon: 'fa-list-check', page: 'checklists' },
                { title: '注拽 爪转', icon: 'fa-dollar-sign', page: 'expenses' },
            ];

            DOM.mainNavButtons.innerHTML = buttons.map(btn => `
                <a href="${btn.page}.html?tripId=${tripId}" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-4 rounded-xl text-white text-center">
                    <i class="fas ${btn.icon} text-3xl mb-2"></i><span class="font-bold">${btn.title}</span>
                </a>
            `).join('');
        }

        function buildSidebarMenu() {
            DOM.mainMenu.innerHTML = '';
            if (!tripData || !tripData.destinations) return;

            tripData.destinations.forEach(dest => {
                const destinationDiv = document.createElement('div');
                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
                button.innerHTML = `<span>${dest.nameHe}</span> <i class="fas fa-chevron-down"></i>`;
                
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';
                
                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dateStr => {
                    const dayLink = document.createElement('a');
                    // This will eventually link to a daily schedule page
                    dayLink.href = `daily-schedule.html?tripId=${tripId}&date=${dateStr}`;
                    dayLink.className = 'block w-full text-right p-2 pr-4 text-slate-600 hover:bg-sky-100 hover:text-sky-600 rounded-md transition-colors';
                    dayLink.textContent = `"  ${dateStr}`;
                    submenu.appendChild(dayLink);
                });

                button.addEventListener('click', () => {
                    submenu.classList.toggle('open');
                    button.querySelector('i').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }

        function buildTripMap() {
            const mapContainer = DOM.tripMapContainer;
            if (!mapContainer || mapContainer._leaflet_id) return;
            
            const tripMap = L.map(mapContainer).setView([38, -95], 3.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: '&copy; OpenStreetMap &copy; CARTO' }).addTo(tripMap);

            const points = tripData.destinations
                .filter(d => d.coords)
                .map(d => [d.coords.lat, d.coords.lng]);

            tripData.destinations.forEach(dest => {
                if (dest.coords) {
                    L.marker([dest.coords.lat, dest.coords.lng])
                     .addTo(tripMap)
                     .bindTooltip(dest.nameHe, {permanent: true, direction: 'top', offset: [0, -10]}).openTooltip();
                }
            });

            if (points.length > 1) {
                L.polyline(points, { color: '#38bdf8', weight: 3, opacity: 0.7, dashArray: '5, 10' }).addTo(tripMap);
                tripMap.fitBounds(points, { padding: [50, 50] });
            } else if (points.length === 1) {
                tripMap.setView(points[0], 8);
            }
        }

        // --- Helper Functions ---
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const [startDay, startMonth, startYear] = startStr.split('/').map(Number);
            const [endDay, endMonth, endYear] = endStr.split('/').map(Number);
            
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                dates.push(currentDate.toLocaleDateString('he-IL', {day: '2-digit', month: '2-digit', year: 'numeric'}));
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function toggleSidebar() {
            DOM.sidebar.classList.toggle('translate-x-full');
            DOM.overlay.classList.toggle('hidden');
        }
        
        function openNavModal(title, address) {
            // Placeholder for hotel navigation
            document.getElementById('nav-modal-title').textContent = title;
            const navContent = document.getElementById('nav-modal-content');
            const navMessage = document.getElementById('nav-modal-message');
            
            if (address) {
                // Logic to show Waze/Google links
            } else {
                navContent.classList.add('hidden');
                navMessage.textContent = " 爪  转专 .";
                navMessage.classList.remove('hidden');
            }
            DOM.navModal.classList.remove('hidden');
            setTimeout(() => DOM.navModal.classList.remove('opacity-0'), 10);
        }

        // --- Event Listeners ---
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);
        DOM.navigateHotelBtn.addEventListener('click', () => {
            // This will be implemented fully when hotel data is available
            openNavModal(' ', null);
        });
        DOM.navModalClose.addEventListener('click', () => {
            DOM.navModal.classList.add('opacity-0');
            setTimeout(() => DOM.navModal.classList.add('hidden'), 300);
        });
        DOM.cancelLogoutBtn.addEventListener('click', () => DOM.logoutModal.classList.add('hidden'));
        DOM.confirmLogoutBtn.addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = 'index.html';
            });
        });

        // --- Start the page ---
        initPage();
    </script>
</body>
</html>