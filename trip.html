<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מרכז הבקרה של הטיול</title>
    
    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        html{height:100%;scrollbar-gutter:stable both-edges}
        body{
            font-family:'Assistant',sans-serif;
            min-height:100%;
            overflow-y:scroll;          /* מונע שינוי רוחב בעת הופעת סרגל גלילה */
            overscroll-behavior-y:contain;/* מפחית "ריבאונד" גלילה בסוף הדף */
            -webkit-font-smoothing:antialiased;
        }

        #sidebar { transition: transform 0.3s ease-in-out; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .submenu.open { max-height: 1200px; }
        #trip-map-container, .details-map-container { border-radius: 1rem; z-index: 0; }
        #trip-map-container { height: 450px; }
        .details-map-container { height: 250px; }
        .modal { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .no-scrollbar::-webkit-scrollbar{display:none}
        .no-scrollbar{-ms-overflow-style:none;scrollbar-width:none}
        .edit-dest-card { border-inline-start: 4px solid #38bdf8; }
        .date-pill{background:#eef6ff;border-radius:9999px;padding:.15rem .5rem;font-weight:700;font-size:.75rem}

        /* כפתורי נווט ראשיים - בלי תזוזה אנכית שגורמת "קפיצות" */
        .main-nav-button { transition: transform .2s ease-out, box-shadow .2s ease-out; will-change: transform; }
        .main-nav-button:hover { transform: scale(1.02); box-shadow: 0 10px 24px rgba(0,0,0,0.18); }

        /* כרטיסים חדשים יפים ויציבים */
        .card{
            background: linear-gradient(180deg, rgba(255,255,255,0.95), rgba(255,255,255,0.88));
            border-radius: 16px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.10);
            border: 1px solid rgba(226,232,240,0.7);
            transition: box-shadow .2s ease, transform .2s ease;
            will-change: transform;
            cursor: pointer;
        }
        .card:hover{
            box-shadow: 0 12px 28px rgba(0,0,0,0.14);
        }
        .badge{
            display:inline-flex;align-items:center;gap:.4rem;
            font-weight:700;font-size:.75rem;
            background:#f1f5f9;border:1px solid #e2e8f0;border-radius:9999px;
            padding:.2rem .6rem;color:#334155;
        }
        .price-chip{
            background:#e6f2ff;border:1px solid #cfe3ff;color:#1e3a8a;
            font-weight:800;border-radius:9999px;padding:.35rem .8rem;
        }

        /* טעינה חלקה */
        #loading-overlay { transition: opacity 0.5s ease-in-out; }

        /* רקע */
        #page-bg { transition: background-image 1s ease, transform .6s ease; }
    </style>
</head>
<body>

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">טוען את הטיול שלך...</p>
    </div>

    <div id="page-bg" class="fixed inset-0 z-0 bg-cover bg-center" style="background-image: url('https://i.imgur.com/PXLTIi4.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <div class="relative z-10">
        <!-- NAV MODAL -->
        <div id="nav-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
                <h3 id="nav-modal-title" class="text-xl font-bold text-slate-800 mb-2">נווט אל...</h3>
                <p id="nav-modal-message" class="text-slate-600 mb-4"></p>
                <div id="nav-modal-content" class="flex flex-col gap-4"></div>
                <button id="nav-modal-close" class="mt-6 text-slate-500 hover:text-slate-700">סגור</button>
            </div>
        </div>

        <!-- NEW SHARE MODAL START -->
        <div id="share-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-lg text-center">
                <h3 class="text-2xl font-bold text-slate-800 mb-2">איך תרצה לשתף?</h3>
                <p class="text-slate-600 mb-8">בחר כיצד לשתף את תוכנית הטיול שלך.</p>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <button id="share-add-editor-btn" class="flex flex-col items-center justify-center p-6 bg-blue-50 hover:bg-blue-100 rounded-xl border-2 border-blue-200 hover:border-blue-400 transition-all">
                        <i class="fas fa-user-plus fa-2x text-blue-500 mb-3"></i>
                        <span class="font-bold text-slate-800">הוסף חבר לעריכה</span>
                        <span class="text-sm text-slate-500 mt-1">שלח הזמנה לחבר להצטרף ולערוך את הטיול ביחד.</span>
                    </button>
                    <button id="share-as-file-btn" class="flex flex-col items-center justify-center p-6 bg-green-50 hover:bg-green-100 rounded-xl border-2 border-green-200 hover:border-green-400 transition-all">
                        <i class="fas fa-file-export fa-2x text-green-500 mb-3"></i>
                        <span class="font-bold text-slate-800">שתף כקובץ (PDF/Word)</span>
                        <span class="text-sm text-slate-500 mt-1">צור קובץ מסודר של הטיול שניתן להדפיס או לשלוח.</span>
                    </button>
                </div>
                <button id="share-modal-close-btn" class="mt-8 text-slate-500 hover:text-slate-700">ביטול</button>
            </div>
        </div>
        <!-- NEW SHARE MODAL END -->

        <div id="logout-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4">התנתקות</h2>
                <p class="text-slate-600 mb-8">האם אתה בטוח שברצונך להתנתק?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-logout-btn" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">ביטול</button>
                    <button id="confirm-logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">התנתק</button>
                </div>
            </div>
        </div>
        
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-2xl font-bold">הגדרות תצוגה</h2>
                    <button id="close-settings-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
                
                <div class="space-y-6">
                    <div>
                        <label for="main-bg-input" class="block text-sm font-medium text-slate-700 mb-1">רקע כללי לדף הטיול</label>
                        <input type="url" id="main-bg-input" class="w-full p-2 border rounded-md" placeholder="הדבק קישור (URL) לתמונה">
                        <p class="text-xs text-slate-500 mt-1">שינוי זה משפיע על כל הדף (לא לפי יעד).</p>
                    </div>

                    <hr>

                    <div class="bg-slate-50 border rounded-lg p-4">
                        <h3 class="font-bold text-slate-800 mb-2"><i class="fa-solid fa-calendar-days ml-2 text-sky-600"></i> עריכת תאריכים ויעדים בלוז</h3>
                        <p class="text-slate-600 text-sm mb-3">שנה את טווח התאריכים הכללי של הטיול, הוסף/מחק/ערוך יעדים ותאריכיהם.</p>
                        <button id="open-edit-destinations-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-2 px-4 rounded-lg">
                            פתח עורך תאריכים ויעדים
                        </button>
                    </div>

                    <!-- New Section for Shortcuts -->
                    <div class="bg-slate-50 border rounded-lg p-4">
                        <h3 class="font-bold text-slate-800 mb-2"><i class="fa-solid fa-rocket ml-2 text-purple-600"></i> מרכז הקיצורים (Shortcuts)</h3>
                        <p class="text-slate-600 text-sm mb-3">צור קיצורי דרך לאייפון/אנדרואיד לביצוע פעולות מהירות כמו ניווט למלון, קבלת לו"ז יומי ועוד.</p>
                        <a id="open-shortcuts-btn" href="#" class="block w-full text-center bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">
                            פתח את מרכז הקיצורים
                        </a>
                    </div>
                </div>
                
                <div class="mt-6 flex justify-end gap-4">
                    <div id="settings-feedback" class="text-green-600 font-bold flex-grow"></div>
                    <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">שמור הגדרות</button>
                </div>
            </div>
        </div>

        <div id="edit-destinations-modal" class="hidden fixed inset-0 bg-black/70 z-[110] p-4 flex items-center justify-center">
            <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl max-h-[95vh] flex flex-col">
                <header class="p-4 border-b flex justify-between items-center">
                    <h2 class="text-xl font-bold">עריכת תאריכים ויעדים בלוז</h2>
                    <button id="edit-destinations-close" class="p-2 text-slate-500 hover:text-red-600"><i class="fa-solid fa-xmark fa-lg"></i></button>
                </header>
                <main class="p-4 overflow-y-auto no-scrollbar flex-1 space-y-5">
                    <section class="bg-slate-50 p-4 rounded-lg">
                        <label class="block text-sm font-semibold mb-1">תאריכי הטיול (כללי)</label>
                        <input type="text" id="trip-dates-edit" class="w-full p-2 border rounded-md text-center" placeholder="DD/MM/YYYY - DD/MM/YYYY">
                        <p class="text-xs text-slate-500 mt-1">הערה: זהו טווח כללי בלבד – לכל יעד יש טווח משלו.</p>
                    </section>

                    <section>
                        <div class="flex items-center justify-between mb-3">
                            <h3 class="font-bold text-slate-800 text-lg">יעדים</h3>
                            <button id="add-dest-btn" class="bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-bold py-2 px-4 rounded-lg"><i class="fa-solid fa-plus ml-2"></i>הוסף יעד</button>
                        </div>
                        <div id="destinations-list" class="space-y-4"></div>
                    </section>
                </main>
                <footer class="p-4 border-t flex justify-between">
                    <button id="edit-destinations-cancel" class="bg-slate-200 hover:bg-slate-300 font-semibold py-2 px-4 rounded-lg">ביטול</button>
                    <button id="save-destinations-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg">שמור שינויים</button>
                </footer>
            </div>
        </div>
        
        <div id="details-modal" class="modal fixed inset-0 bg-black/60 z-[102] hidden items-center justify-center p-4 opacity-0">
            <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[95vh] flex flex-col transform scale-95">
                <header class="p-5 border-b flex justify-between items-center bg-slate-50 rounded-t-2xl sticky top-0">
                    <h3 id="details-modal-title" class="text-2xl font-bold text-slate-800">פרטי הפריט</h3>
                    <button id="details-modal-close" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </header>
                <div id="details-modal-body" class="flex-grow overflow-y-auto p-6 space-y-4">
                    <!-- Content will be injected here -->
                </div>
            </div>
        </div>

        <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
            <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
                <h2 class="text-2xl font-bold text-slate-800">תפריט המסע</h2>
                <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <nav id="main-menu" class="p-4 space-y-2"></nav>
        </aside>

        <div id="main-content" class="min-h-screen">
            <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <a href="index.html" class="text-slate-700 font-bold hover:text-blue-600"><i class="fas fa-home"></i> דף הבית</a>
                        <div class="flex items-center gap-2 sm:gap-4">
                            <div id="auth-container"></div>
                            <button id="navigate-hotel-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="נווט למלון"><i class="fas fa-hotel fa-lg"></i></button>
                            <!-- SHARE BUTTON MODIFIED: Changed from <a> to <button> -->
                            <button id="share-trip-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="שתף טיול"><i class="fas fa-share-alt fa-lg"></i></button>
                            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="הגדרות"><i class="fas fa-cog fa-lg"></i></button>
                            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-12">
                
                    <section class="text-center">
                        <h2 id="trip-title" class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg">טוען את שם הטיול...</h2>
                        <p class="mt-4 text-lg text-slate-200 max-w-3xl mx-auto">זהו מרכז הבקרה של הטיול! מכאן אפשר לנווט לכל המידע החשוב.</p>
                        <div id="main-nav-buttons" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto">
                            </div>
                    </section>

                    <section>
                        <h3 class="text-3xl font-bold text-white mb-4 text-center drop-shadow-md">מפת המסע הכללית</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-lg"><div id="trip-map-container"></div></div>
                    </section>

                    <section id="hotel-summary-section">
                        <h3 class="text-3xl font-bold text-white text-center drop-shadow-md mb-6">🏨 סיכום מלונות</h3>
                        <div id="hotel-summary-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                           <p class="text-white/80 text-center col-span-full">טוען סיכום מלונות...</p>
                        </div>
                    </section>
                    
                    <section id="transport-summary-section">
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">✈️ סיכום מעברים</h3>
                        <div id="transport-summary-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                                 <p class="text-white/80 text-center col-span-full">טוען סיכום מעברים...</p>
                        </div>
                    </section>

                    <section id="costs-summary-section">
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">📊 סיכום עלויות</h3>
                        <div id="costs-summary-container" class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg">
                           <p class="text-slate-600 text-center">טוען סיכום עלויות...</p>
                        </div>
                    </section>
                </div>
            </main>
        </div>
        
        <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, updateDoc, enableIndexedDbPersistence } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- הוספת יכולות אופליין ---
        enableIndexedDbPersistence(db).catch((err) => {
          if (err.code === 'failed-precondition') {
            console.warn("Persistence נכשל – יש יותר מדי טאבים פתוחים.");
          } else if (err.code === 'unimplemented') {
            console.warn("הדפדפן לא תומך ב־Persistence.");
          }
        });

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            pageBg: document.getElementById('page-bg'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            navModal: document.getElementById('nav-modal'),
            navModalClose: document.getElementById('nav-modal-close'),
            navigateHotelBtn: document.getElementById('navigate-hotel-btn'),
            logoutModal: document.getElementById('logout-modal'),
            cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
            confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
            authContainer: document.getElementById('auth-container'),
            tripTitle: document.getElementById('trip-title'),
            tripMapContainer: document.getElementById('trip-map-container'),
            mainNavButtons: document.getElementById('main-nav-buttons'),
            hotelSummaryContainer: document.getElementById('hotel-summary-container'),
            transportSummaryContainer: document.getElementById('transport-summary-container'),
            costsSummaryContainer: document.getElementById('costs-summary-container'),
            shareTripBtn: document.getElementById('share-trip-btn'),
            // NEW SHARE MODAL ELEMENTS
            shareModal: document.getElementById('share-modal'),
            shareModalCloseBtn: document.getElementById('share-modal-close-btn'),
            shareAsFileBtn: document.getElementById('share-as-file-btn'),
            shareAddEditorBtn: document.getElementById('share-add-editor-btn'),
            // Settings Modal Elements
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            mainBgInput: document.getElementById('main-bg-input'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            settingsFeedback: document.getElementById('settings-feedback'),
            openEditDestBtn: document.getElementById('open-edit-destinations-btn'),
            openShortcutsBtn: document.getElementById('open-shortcuts-btn'),
            // Edit destinations modal
            editDestModal: document.getElementById('edit-destinations-modal'),
            editDestClose: document.getElementById('edit-destinations-close'),
            editDestCancel: document.getElementById('edit-destinations-cancel'),
            saveDestinationsBtn: document.getElementById('save-destinations-btn'),
            tripDatesEdit: document.getElementById('trip-dates-edit'),
            destinationsList: document.getElementById('destinations-list'),
            addDestBtn: document.getElementById('add-dest-btn'),
            // Details Modal
            detailsModal: document.getElementById('details-modal'),
            detailsModalTitle: document.getElementById('details-modal-title'),
            detailsModalBody: document.getElementById('details-modal-body'),
            detailsModalClose: document.getElementById('details-modal-close'),
        };

        let currentUser = null;
        let tripId = null;
        let tripData = null;
        let allLogisticsItems = []; // Store all items for details modal
        let logisticsUnsubscribe = null;
        let detailsMap = null; // Map instance for the details modal

        const editUI = new Map(); // key: destId string, value: {map, marker, el}

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id');
            if (!tripId) {
                alert("שגיאה: לא נמצא מזהה טיול.");
                window.location.href = 'index.html';
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadTripData();
                    setupAuthUI(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData() {
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);

            if (tripSnap.exists()) {
                const loadedTripData = tripSnap.data();
                const canAccess = loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid);

                if (canAccess) {
                    tripData = loadedTripData;
                    document.title = tripData.name;
                    applySettings();
                    populateUI();
                    listenForLogistics();
                    DOM.loadingOverlay.style.display = 'none';
                } else {
                    alert("הטיול לא נמצא או שאין לך הרשאה לצפות בו.");
                    window.location.href = 'index.html';
                }
            } else {
                alert("הטיול לא נמצא או שאין לך הרשאה לצפות בו.");
                window.location.href = 'index.html';
            }
        }

        function listenForLogistics() {
            if (logisticsUnsubscribe) logisticsUnsubscribe();
            const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
            const q = query(logisticsCollectionRef);
            logisticsUnsubscribe = onSnapshot(q, (snapshot) => {
                allLogisticsItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateSummaries(allLogisticsItems);
            }, (error) => {
                console.error("Logistics snapshot error:", error);
            });
        }
        
        // --- Settings Logic ---
        function applySettings() {
            if (tripData.backgroundUrl) {
                DOM.pageBg.style.backgroundImage = `url('${tripData.backgroundUrl}')`;
            }
        }

        function openSettingsModal() {
            DOM.mainBgInput.value = tripData.backgroundUrl || '';
            DOM.settingsFeedback.textContent = '';
            DOM.settingsModal.classList.remove('hidden');
        }
        function closeSettingsModal() { DOM.settingsModal.classList.add('hidden'); }

        async function saveSettings() {
            const tripRef = doc(db, "trips", tripId);
            let updatedTripData = { ...tripData };
            updatedTripData.backgroundUrl = (DOM.mainBgInput.value || '').trim();

            try {
                await updateDoc(tripRef, updatedTripData);
                tripData = updatedTripData;
                applySettings();
                DOM.settingsFeedback.textContent = 'ההגדרות נשמרו!';
                setTimeout(() => { DOM.settingsFeedback.textContent = ''; closeSettingsModal(); }, 1200);
            } catch (error) {
                console.error("Error saving settings:", error);
                DOM.settingsFeedback.textContent = 'שגיאה בשמירה.';
                DOM.settingsFeedback.classList.remove('text-green-600');
                DOM.settingsFeedback.classList.add('text-red-600');
            }
        }
        
        // --- UI Population ---
        function populateUI() {
            DOM.tripTitle.textContent = tripData.name;
            // The share button functionality is now handled by JavaScript, so href is not needed here
            DOM.openShortcutsBtn.href = `shortcuts.html?tripId=${tripId}`;
            buildSidebarMenu();
            buildTripMap();
            buildNavButtons();
        }
        
        // --- Sorting and Summary Population ---
        function populateSummaries(items) {
            const hotels = items.filter(item => item.type === 'hotel');
            const transports = items.filter(item => ['flight', 'car_rental', 'ferry', 'train', 'ride'].includes(item.type));

            const now = new Date();
            now.setHours(0, 0, 0, 0);

            const hotelSorter = (a, b) => {
                const dateA = getStartDate(a);
                const dateB = getStartDate(b);

                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                
                const isAPast = dateA < now;
                const isBPast = dateB < now;

                if (isAPast && !isBPast) return 1;
                if (!isAPast && isBPast) return -1;
                
                if (isAPast && isBPast) {
                     return dateB - dateA; // Show most recent past first
                }
                return dateA - dateB; // Show nearest future first
            };
            
            const transportSorter = (a, b) => {
                const dateTimeA = getStartDateTime(a);
                const dateTimeB = getStartDateTime(b);

                if (!dateTimeA && !dateTimeB) return 0;
                if (!dateTimeA) return 1;
                if (!dateTimeB) return -1;

                const isAPast = dateTimeA < new Date();
                const isBPast = dateTimeB < new Date();

                if (isAPast && !isBPast) return 1;
                if (!isAPast && isBPast) return -1;
                
                if (isAPast && isBPast) {
                     return dateTimeB - dateTimeA; // Show most recent past first
                }
                return dateTimeA - dateTimeB; // Show nearest future first
            };


            hotels.sort(hotelSorter);
            transports.sort(transportSorter);

            renderHotelSummary(hotels);
            renderTransportSummary(transports);
            renderCostsSummary(items);
        }

        function renderHotelSummary(hotels) {
            const container = DOM.hotelSummaryContainer;
            if (hotels.length === 0) {
                container.innerHTML = `<p class="text-white/80 text-center col-span-full">לא נוספו מלונות עדיין. <a href="logistics.html?tripId=${tripId}" class="font-bold underline hover:text-white">הוסף עכשיו</a></p>`;
                return;
            }

            container.innerHTML = hotels.map(hotel => {
                const title = hotel.name || 'מלון';
                const place = hotel.destination || '';
                const dates = hotel.dates || '';
                const price = hotel.price || 0;
                const address = hotel.address || '';

                const navButtons = address ? `
                <div class="mt-4 pt-4 border-t border-slate-200 flex items-center justify-end gap-3">
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="inline-flex items-center gap-2 text-sm font-bold text-white bg-green-500 hover:bg-green-600 rounded-full px-4 py-2 transition-transform hover:scale-105">
                        <i class="fa-solid fa-map-location-dot"></i> Google Maps
                    </a>
                    <a href="https://waze.com/ul?q=${encodeURIComponent(address)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="inline-flex items-center gap-2 text-sm font-bold text-white bg-sky-500 hover:bg-sky-600 rounded-full px-4 py-2 transition-transform hover:scale-105">
                        <i class="fa-brands fa-waze"></i> Waze
                    </a>
                </div>` : '';

                return `
                <div class="card p-4 flex flex-col justify-between" data-id="${hotel.id}">
                    <div>
                        <div class="flex items-start justify-between gap-3">
                            <div class="min-w-0">
                                <h4 class="text-lg font-extrabold text-slate-800 truncate">${title}</h4>
                                <div class="mt-1 flex flex-wrap items-center gap-2">
                                    ${place ? `<span class="badge"><i class="fa-solid fa-location-dot"></i>${place}</span>` : ''}
                                    ${dates ? `<span class="badge"><i class="fa-regular fa-calendar"></i>${dates}</span>` : ''}
                                </div>
                            </div>
                            <div class="flex flex-col items-end">
                                <span class="price-chip">$${Number(price).toLocaleString()}</span>
                                <span class="text-[11px] text-slate-400 mt-1">סה״כ שהייה</span>
                            </div>
                        </div>
                    </div>
                    ${navButtons}
                </div>`;
            }).join('');
        }

        function renderTransportSummary(transports) {
            const container = DOM.transportSummaryContainer;
            if (transports.length === 0) {
                container.innerHTML = `<p class="text-white/80 text-center col-span-full">לא נוספו מעברים עדיין. <a href="logistics.html?tripId=${tripId}" class="font-bold underline hover:text-white">הוסף עכשיו</a></p>`;
                return;
            }

            const getIcon = (type) => {
                switch(type) {
                    case 'flight': return 'fa-plane-departure';
                    case 'car_rental': return 'fa-car';
                    case 'ferry': return 'fa-ship';
                    case 'train': return 'fa-train';
                    case 'ride': return 'fa-taxi';
                    default: return 'fa-ticket-alt';
                }
            };

            container.innerHTML = transports.map(item => {
                let title = '', subtitle = '', navAddress = '', navButtons = '';
                const date = item.dates || item.date || '';
                
                switch(item.type) {
                    case 'flight':
                        title = `${item.from?.destination || ''} ← ${item.to?.destination || ''}`;
                        subtitle = `${item.airline || ''} | ${date}`;
                        navAddress = item.from?.airport_address || item.from?.airport_name;
                        break;
                    case 'car_rental':
                        title = `רכב שכור ב${item.destination || ''}`;
                        subtitle = `${item.booked_via || ''} | ${date}`;
                        navAddress = item.pickup_location;
                        break;
                    case 'ferry':
                        title = `מעבורת: ${item.from_destination || ''} ← ${item.to_destination || ''}`;
                         subtitle = `${item.company || ''} | ${date}`;
                        navAddress = item.from_destination;
                        break;
                    case 'train':
                        title = `רכבת: ${item.from_station || ''} ← ${item.to_station || ''}`;
                         subtitle = `${item.company || ''} | ${date}`;
                        navAddress = item.from_station;
                        break;
                    case 'ride':
                        title = `הסעה: ${item.from_address?.split(',')[0] || ''}`;
                        subtitle = `${date} | ${item.pickup_time || ''}`;
                        navAddress = item.from_address;
                        const phoneBtn = item.driver_phone ? `<a href="tel:${item.driver_phone}" onclick="event.stopPropagation()" class="inline-flex items-center justify-center w-9 h-9 text-white bg-green-500 hover:bg-green-600 rounded-full transition-transform hover:scale-110" title="צלצל לנהג"><i class="fa-solid fa-phone"></i></a>` : '';
                        navButtons += phoneBtn;
                        break;
                }

                if (navAddress) {
                    navButtons += `
                        <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(navAddress)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="inline-flex items-center justify-center w-9 h-9 text-white bg-blue-500 hover:bg-blue-600 rounded-full transition-transform hover:scale-110" title="נווט עם Google Maps">
                            <i class="fa-solid fa-map-location-dot"></i>
                        </a>
                        <a href="https://waze.com/ul?q=${encodeURIComponent(navAddress)}" target="_blank" rel="noopener noreferrer" onclick="event.stopPropagation()" class="inline-flex items-center justify-center w-9 h-9 text-white bg-sky-500 hover:bg-sky-600 rounded-full transition-transform hover:scale-110" title="נווט עם Waze">
                            <i class="fa-brands fa-waze"></i>
                        </a>`;
                }

                return `
                <div class="card p-4 flex flex-col justify-between" data-id="${item.id}">
                    <div>
                        <div class="flex items-center gap-4">
                            <div class="shrink-0 w-12 h-12 rounded-full bg-sky-100 border border-sky-200 flex items-center justify-center">
                                <i class="fas ${getIcon(item.type)} fa-lg text-sky-600"></i>
                            </div>
                            <div class="min-w-0">
                                <h4 class="font-bold text-slate-800 truncate">${title || 'מעבר'}</h4>
                                ${subtitle ? `<p class="text-sm text-slate-500">${subtitle}</p>` : ''}
                            </div>
                        </div>
                    </div>
                    ${navButtons ? `<div class="mt-3 pt-3 border-t border-slate-200 flex items-center justify-end gap-2">${navButtons}</div>` : ''}
                </div>`;
            }).join('');
        }

        function renderCostsSummary(items) {
            const container = DOM.costsSummaryContainer;
            let totalCost = 0;
            items.forEach(item => {
                if (item.type === 'flight') {
                    const numSeats = item.seats?.length || tripData.participants?.length || 1;
                    totalCost += (item.price_per_person || 0) * numSeats;
                } else {
                    totalCost += item.price || 0;
                }
            });

            container.innerHTML = `
                <div class="text-center">
                    <p class="text-slate-600 text-lg">סה"כ עלות משוערת (לוגיסטיקה)</p>
                    <p class="text-4xl font-bold text-blue-700 mt-2">$${totalCost.toLocaleString()}</p>
                    <a href="logistics.html?tripId=${tripId}" class="inline-block mt-4 text-sm text-blue-600 font-semibold hover:underline">צפה בפירוט המלא ונהל עלויות</a>
                </div>
            `;
        }

        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? (docSnap.data().name || 'משתמש') : 'משתמש';
                DOM.authContainer.innerHTML = `<button id="user-name-btn" class="text-slate-700 font-bold hover:text-blue-600">שלום, ${name}</button>`;
                document.getElementById('user-name-btn').addEventListener('click', () => {
                    DOM.logoutModal.classList.remove('hidden');
                });
            });
        }
        
        function buildNavButtons() {
            const buttons = [
                { title: 'ניהול לוגיסטיקה', icon: 'fa-plane-departure', page: 'logistics' },
                { title: 'אטרקציות ומסעדות', icon: 'fa-map-marked-alt', page: 'attractions' },
                { title: 'רשימות וצ\'ק ליסטים', icon: 'fa-list-check', page: 'checklists' },
                { title: 'מעקב הוצאות', icon: 'fa-dollar-sign', page: 'expenses' },
            ];
            DOM.mainNavButtons.innerHTML = buttons.map(btn => `
                <a href="${btn.page}.html?tripId=${tripId}" class="main-nav-button bg-white/20 backdrop-blur-md hover:bg-white/30 flex flex-col items-center justify-center p-4 rounded-xl text-white text-center">
                    <i class="fas ${btn.icon} text-3xl mb-2"></i><span class="font-bold">${btn.title}</span>
                </a>
            `).join('');
        }

        // ---------- Helper: format + weekday ----------
        function parseDDMMYYYY(s){
            const [d,m,y] = s.split('/').map(Number);
            return new Date(y, m-1, d);
        }
        function hebWeekday(d){
            const n = d.toLocaleDateString('he-IL', { weekday:'long' });
            return n.startsWith('יום') ? n : `יום ${n}`;
        }
        function dotted(d){
            return `${d.getDate()}.${d.getMonth()+1}.${d.getFullYear()}`;
        }

        function buildSidebarMenu() {
            DOM.mainMenu.innerHTML = '';
            if (!tripData || !tripData.destinations) return;

            tripData.destinations.forEach(dest => {
                const destinationDiv = document.createElement('div');

                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
                button.innerHTML = `<span>${dest.nameHe}</span> <i class="fas fa-chevron-down"></i>`;
                
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';

                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dateStr => {
                    const d = parseDDMMYYYY(dateStr);
                    const a = document.createElement('a');
                    a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}`;
                    a.className = 'block w-full text-right p-3 pr-4 rounded-md transition-colors hover:bg-sky-50';
                    a.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-slate-700 text-sm font-bold">${hebWeekday(d)} – (${dest.nameHe})</span>
                            <span class="text-slate-500 text-xs">${dotted(d)}</span>
                        </div>
                    `;
                    submenu.appendChild(a);
                });

                button.addEventListener('click', () => {
                    submenu.classList.toggle('open');
                    button.querySelector('i').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }

        function buildTripMap() {
            const mapContainer = DOM.tripMapContainer;
            if (!mapContainer) return;

            if (mapContainer._leaflet_id) {
                mapContainer._leaflet_id = null;
                mapContainer.innerHTML = "";
            }
            
            const tripMap = L.map(mapContainer).setView([38, -95], 3.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager_labels_under/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap © CARTO' }).addTo(tripMap);

            const points = (tripData.destinations || [])
                .filter(d => d.coords)
                .map(d => [d.coords.lat, d.coords.lng]);

            (tripData.destinations || []).forEach(dest => {
                if (dest.coords) {
                    L.marker([dest.coords.lat, dest.coords.lng])
                     .addTo(tripMap)
                     .bindTooltip(dest.nameHe, {permanent: true, direction: 'top', offset: [0, -10]}).openTooltip();
                }
            });

            if (points.length > 1) {
                L.polyline(points, { color: '#38bdf8', weight: 3, opacity: 0.7, dashArray: '5, 10' }).addTo(tripMap);
                tripMap.fitBounds(points, { padding: [50, 50] });
            } else if (points.length === 1) {
                tripMap.setView(points[0], 8);
            }
        }

        // --- Helper Functions ---
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const [startDay, startMonth, startYear] = startStr.split('/').map(Number);
            const [endDay, endMonth, endYear] = endStr.split('/').map(Number);
            
            const startDate = new Date(startYear, startMonth - 1, startDay);
            const endDate = new Date(endYear, endMonth - 1, endDay);
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const dd = String(currentDate.getDate()).padStart(2,'0');
                const mm = String(currentDate.getMonth()+1).padStart(2,'0');
                const yyyy = currentDate.getFullYear();
                dates.push(`${dd}/${mm}/${yyyy}`);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function getStartDate(item) {
            let dateStr = item.dates || item.date;
            if (!dateStr || typeof dateStr !== 'string') return null;

            if (dateStr.includes(' - ')) {
                dateStr = dateStr.split(' - ')[0].trim();
            }

            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }
        
        function getStartDateTime(item) {
            const date = getStartDate(item);
            if (!date) return null;

            const timeStr = item.pickup_time || item.departure_time;
            if (timeStr && typeof timeStr === 'string' && timeStr.includes(':')) {
                const [hours, minutes] = timeStr.split(':').map(Number);
                if (!isNaN(hours) && !isNaN(minutes)) {
                    date.setHours(hours, minutes);
                }
            }
            return date;
        }

        function toggleSidebar() {
            DOM.sidebar.classList.toggle('translate-x-full');
            DOM.overlay.classList.toggle('hidden');
        }
        
        // --- Navigation Modal Logic ---
        function openNavModal({ title, options = [], message = '' }) {
            document.getElementById('nav-modal-title').textContent = title;
            const navContent = document.getElementById('nav-modal-content');
            const navMessage = document.getElementById('nav-modal-message');
            
            navContent.innerHTML = '';
            navMessage.textContent = '';

            if (options.length === 1 && options[0].address) {
                const { address } = options[0];
                navContent.innerHTML = `
                    <a href="https://waze.com/ul?q=${encodeURIComponent(address)}" target="_blank" class="block w-full text-center bg-[#33ccff] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#00bfff] transition text-lg"><i class="fa-brands fa-waze"></i> Waze</a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" class="block w-full text-center bg-[#4285F4] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#3367D6] transition text-lg"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a>
                `;
                navMessage.textContent = message;
            } else if (options.length > 1) {
                navContent.innerHTML = options.map(opt => 
                    `<button data-address="${opt.address}" class="hotel-choice-btn block w-full text-center bg-slate-100 hover:bg-slate-200 text-slate-800 font-bold py-3 px-4 rounded-lg transition">${opt.name}</button>`
                ).join('');
                navMessage.textContent = "יש לבחור לאיזה מלון לנווט:";
            } else {
                navMessage.textContent = message || 'לא נמצא יעד לניווט.';
            }

            DOM.navModal.classList.remove('hidden');
            setTimeout(() => DOM.navModal.classList.remove('opacity-0'), 10);
        }

        function parseDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return null;
            const parts = dateStr.split('/');
            if (parts.length !== 3) return null;
            return new Date(parts[2], parts[1] - 1, parts[0]);
        }

        function isDateInRange(checkDate, rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return false;
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDate(startStr);
            const endDate = parseDate(endStr);
            if (!startDate || !endDate) return false;
            
            const normalizedCheckDate = new Date(checkDate);
            normalizedCheckDate.setHours(0, 0, 0, 0);

            return normalizedCheckDate >= startDate && normalizedCheckDate <= endDate;
        }

        async function handleNavigateToHotel() {
            const hotels = allLogisticsItems.filter(item => item.type === 'hotel' && item.address);
            if (hotels.length === 0) {
                openNavModal({ title: 'ניווט למלון', message: 'לא נמצאו מלונות עם כתובת בטיול זה.' });
                return;
            }

            const today = new Date();
            const todaysHotels = hotels.filter(h => isDateInRange(today, h.dates));

            if (todaysHotels.length > 0) {
                openNavModal({
                    title: 'נווט למלון להיום',
                    options: todaysHotels.map(h => ({ name: h.name, address: h.address }))
                });
                return;
            }

            const futureHotels = hotels
                .map(h => ({ ...h, startDate: getStartDate(h) }))
                .filter(h => h.startDate && h.startDate >= today)
                .sort((a, b) => a.startDate - b.startDate);

            if (futureHotels.length > 0) {
                const nextHotel = futureHotels[0];
                openNavModal({
                    title: `המלון הבא`,
                    message: `${nextHotel.name} (בתאריך ${nextHotel.dates.split(' - ')[0]})`,
                    options: [{ name: nextHotel.name, address: nextHotel.address }]
                });
                return;
            }

            openNavModal({ title: 'ניווט למלון', message: 'לא נמצא מלון להיום או בעתיד.' });
        }

        // --- Details Modal Logic ---
        function openDetailsModal(item) {
            if (!item) return;
            let title = 'פרטי פריט';
            if (item.type === 'hotel') title = item.name;
            else if (item.type === 'ride') title = `הסעה: ${item.from_address?.split(',')[0] || ''}`;
            else if (item.type === 'flight') title = `טיסה: ${item.from?.destination || ''}`;
            
            DOM.detailsModalTitle.textContent = title;
            DOM.detailsModalBody.innerHTML = generateDetailsHtml(item);

            DOM.detailsModal.classList.remove('hidden');
            setTimeout(() => {
                DOM.detailsModal.classList.remove('opacity-0');
                DOM.detailsModal.querySelector('.modal-content').classList.remove('scale-95');
                initDetailsMap(item);
            }, 10);
        }

        function closeDetailsModal() {
            DOM.detailsModal.classList.add('opacity-0');
            DOM.detailsModal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => {
                DOM.detailsModal.classList.add('hidden');
                if (detailsMap) {
                    detailsMap.remove();
                    detailsMap = null;
                }
            }, 300);
        }

        function generateDetailsHtml(item) {
            let html = '';
            const detail = (icon, label, value, extraClass = '') => {
                if (!value && typeof value !== 'number') return '';
                return `<div class="flex items-start gap-4 ${extraClass}">
                    <i class="fas ${icon} fa-fw text-slate-400 mt-1"></i>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm text-slate-500">${label}</p>
                        <p class="font-semibold text-slate-800 whitespace-pre-wrap break-words">${value}</p>
                    </div>
                </div>`;
            };

            switch (item.type) {
                case 'hotel':
                    html += detail('fa-hotel', 'שם המלון', item.name);
                    html += detail('fa-calendar-days', 'תאריכים', item.dates);
                    html += detail('fa-map-marker-alt', 'יעד', item.destination);
                    html += detail('fa-location-dot', 'כתובת', item.address);
                    html += detail('fa-dollar-sign', 'מחיר', item.price ? `$${item.price.toLocaleString()}` : '');
                    html += detail('fa-building-user', 'הוזמן דרך', item.booked_via);
                    html += detail('fa-info-circle', 'פרטים נוספים', item.additional_details);
                    if (item.link || item.address) {
                        html += `<div class="mt-6 pt-4 border-t grid grid-cols-2 gap-4">
                            ${item.link ? `<a href="${item.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition">קישור להזמנה <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>` : '<div class="opacity-50 text-center bg-blue-200 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">אין קישור</div>'}
                            ${item.address ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition">ניווט למלון <i class="fa-solid fa-diamond-turn-right text-xs"></i></a>` : '<div class="opacity-50 text-center bg-slate-300 text-white font-bold py-2 px-4 rounded-lg cursor-not-allowed">אין כתובת</div>'}
                        </div>`;
                    }
                    if (item.coords) {
                        html += `<div id="details-map" class="details-map-container mt-4"></div>`;
                    }
                    break;
                case 'ride':
                    html += detail('fa-route', 'מאיפה', item.from_address);
                    html += detail('fa-route', 'לאיפה', item.to_address);
                    html += detail('fa-calendar-day', 'תאריך', item.date);
                    html += detail('fa-clock', 'שעת איסוף', item.pickup_time);
                    if (item.route_duration) html += detail('fa-hourglass-half', 'זמן נסיעה', formatDuration(item.route_duration));
                    if (item.route_distance) html += detail('fa-road', 'מרחק', formatDistance(item.route_distance));
                    html += detail('fa-building', 'חברה', item.company);
                    html += detail('fa-user-tie', 'שם נהג', item.driver_name);
                    html += detail('fa-phone', 'טלפון נהג', item.driver_phone ? `<a href="tel:${item.driver_phone}" class="text-blue-600 hover:underline">${item.driver_phone}</a>` : '-');
                    html += detail('fa-dollar-sign', 'מחיר', item.price ? `$${item.price.toLocaleString()}` : '0');
                    html += detail('fa-info-circle', 'פרטים נוספים', item.additional_details);
                    if (item.route_geometry) {
                        html += `<div id="details-map" class="details-map-container mt-4"></div>`;
                    }
                    break;
                case 'flight':
                    const from = item.from || {};
                    const to = item.to || {};
                    html += detail('fa-plane-departure', 'ממריאים מ', `${from.destination || ''} (${from.airport_name || ''})`);
                    html += detail('fa-plane-arrival', 'נוחתים ב', `${to.destination || ''} (${to.airport_name || ''})`);
                    html += detail('fa-calendar-day', 'תאריך', item.dates);
                    html += detail('fa-clock', 'שעת המראה', item.departure_time);
                    html += detail('fa-clock', 'שעת נחיתה', item.arrival_time);
                    html += detail('fa-building', 'חברת תעופה', item.airline);
                    html += detail('fa-hashtag', 'מספר טיסה', item.flight_number);
                    html += detail('fa-dollar-sign', 'מחיר לאדם', item.price_per_person ? `$${item.price_per_person.toLocaleString()}` : '');
                    html += detail('fa-chair', 'מקומות ישיבה', item.seats?.join(', '));
                    html += detail('fa-info-circle', 'פרטים נוספים', item.additional_details);
                    if (from.coords && to.coords) {
                        html += `<div id="details-map" class="details-map-container mt-4"></div>`;
                    }
                    break;
                // Add more cases for train, ferry etc.
                default:
                     html += `<p>אין תצוגה מפורטת עבור פריט זה.</p>`;
            }
            return html;
        }

        async function initDetailsMap(item) {
            if (detailsMap) {
                detailsMap.remove();
                detailsMap = null;
            }
            const mapContainer = document.getElementById('details-map');
            if (!mapContainer) return;

            detailsMap = L.map('details-map').setView([31.7683, 35.2137], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(detailsMap);
            const layerGroup = L.layerGroup().addTo(detailsMap);

            switch (item.type) {
                case 'hotel':
                    if (item.coords) {
                        const coords = [item.coords.lat, item.coords.lng || item.coords.lon];
                        L.marker(coords).addTo(layerGroup);
                        detailsMap.setView(coords, 13);
                    }
                    break;
                case 'ride':
                    let route_geometry = item.route_geometry;
                    if (typeof route_geometry === 'string') {
                        try { route_geometry = JSON.parse(route_geometry); } catch (e) { route_geometry = null; }
                    }
                    if (route_geometry) {
                        const latlngs = route_geometry.map(coord => L.latLng(coord[0], coord[1]));
                        if (item.from_coords) L.marker([item.from_coords.lat, item.from_coords.lon]).addTo(layerGroup).bindPopup('התחלה');
                        if (item.to_coords) L.marker([item.to_coords.lat, item.to_coords.lon]).addTo(layerGroup).bindPopup('סיום');
                        const polyline = L.polyline(latlngs, { color: '#3b82f6', weight: 5 }).addTo(layerGroup);
                        detailsMap.fitBounds(polyline.getBounds(), { padding: [20, 20] });
                    }
                    break;
                case 'flight':
                    if (item.from?.coords && item.to?.coords) {
                        const from = L.latLng(item.from.coords.lat, item.from.coords.lng || item.from.coords.lon);
                        const to = L.latLng(item.to.coords.lat, item.to.coords.lng || item.to.coords.lon);
                        const points = [from, to];
                        
                        L.marker(from).addTo(layerGroup).bindPopup(item.from.destination);
                        L.marker(to).addTo(layerGroup).bindPopup(item.to.destination);
                        
                        const polyline = L.polyline(points, { color: '#3b82f6', weight: 3, dashArray: '10, 10' }).addTo(layerGroup);
                        L.polylineDecorator(polyline, {
                            patterns: [{ offset: 25, repeat: 50, symbol: L.Symbol.arrowHead({ pixelSize: 12, pathOptions: { fillOpacity: 1, weight: 0, color: '#3b82f6' } }) }]
                        }).addTo(layerGroup);
                        
                        const distance = from.distanceTo(to) / 1000;
                        polyline.bindTooltip(`מרחק: ${distance.toLocaleString(undefined, {maximumFractionDigits:0})} ק"מ`, {permanent: true});

                        detailsMap.fitBounds(points, { padding: [50, 50] });
                    }
                    break;
            }

            setTimeout(() => detailsMap.invalidateSize(), 100);
        }

        function formatDuration(seconds) {
            if (seconds === undefined || seconds === null) return '-';
            const hours = Math.floor(seconds / 3600);
            const minutes = Math.floor((seconds % 3600) / 60);
            return `${hours.toString().padStart(2, '0')} שעות ו-${minutes.toString().padStart(2, '0')} דקות`;
        }

        function formatDistance(meters) {
            if (meters === undefined || meters === null) return '-';
            return `${(meters / 1000).toFixed(1)} ק"מ`;
        }

        // --- Edit Destinations Modal Logic ---
        function openEditDestinationsModal(){
            DOM.tripDatesEdit.value = (tripData.startDate && tripData.endDate) ? `${tripData.startDate} - ${tripData.endDate}` : '';
            new Litepicker({ element: DOM.tripDatesEdit, singleMode:false, lang:'he-IL', format:'DD/MM/YYYY' });

            DOM.destinationsList.innerHTML = '';
            editUI.clear();

            (tripData.destinations || []).forEach((dest, idx) => addDestRow(dest, idx));

            DOM.editDestModal.classList.remove('hidden');
        }
        function closeEditDestinationsModal(){ DOM.editDestModal.classList.add('hidden'); }

        function addDestRow(dest = {}, idx = Date.now()){
            const id = `dest-${idx}-${Math.random().toString(36).slice(2,7)}`;
            const el = document.createElement('div');
            el.className = 'edit-dest-card bg-white rounded-xl shadow p-4';
            el.dataset.destId = id;
            el.innerHTML = `
                <div class="flex items-start gap-3 justify-between">
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <div>
                            <label class="block text-sm font-semibold mb-1">שם היעד (עברית)</label>
                            <input type="text" class="dest-name-he w-full p-2 border rounded-md" value="${dest.nameHe || ''}">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">שם היעד (אנגלית לחיפוש)</label>
                            <div class="flex gap-2">
                                <input type="text" class="dest-name-en w-full p-2 border rounded-md" value="${dest.nameEn || ''}">
                                <button class="find-btn bg-sky-600 hover:bg-sky-700 text-white px-3 rounded-md text-sm">מצא</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">תאריכים ביעד</label>
                            <input type="text" class="dest-dates w-full p-2 border rounded-md text-center" value="${dest.dates || ''}" placeholder="DD/MM/YYYY - DD/MM/YYYY">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold mb-1">כתובת רקע (אופציונלי)</label>
                            <input type="url" class="dest-bg w-full p-2 border rounded-md" value="${dest.backgroundUrl || ''}">
                        </div>
                    </div>
                    <button class="remove-btn text-red-600 hover:text-red-700" title="מחק יעד"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="mt-3 w-full h-44 rounded-lg overflow-hidden bg-slate-100">
                    <div class="map w-full h-full"></div>
                </div>
                <div class="mt-2 text-xs text-slate-500">נקודת מפה: <span class="coords">${dest.coords ? `${dest.coords.lat.toFixed(5)}, ${dest.coords.lng.toFixed(5)}` : 'לא נבחר'}</span></div>
            `;
            DOM.destinationsList.appendChild(el);

            new Litepicker({ element: el.querySelector('.dest-dates'), singleMode:false, lang:'he-IL', format:'DD/MM/YYYY' });

            const mapDiv = el.querySelector('.map');
            const map = L.map(mapDiv).setView(dest.coords ? [dest.coords.lat, dest.coords.lng] : [20,0], dest.coords ? 10 : 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const marker = dest.coords ? L.marker([dest.coords.lat, dest.coords.lng]).addTo(map) : null;

            editUI.set(id, { el, map, marker });

            el.querySelector('.find-btn').addEventListener('click', async () => {
                const q = el.querySelector('.dest-name-en').value.trim();
                if (!q) { alert('כתוב שם יעד באנגלית לחיפוש.'); return; }
                try{
                    const btn = el.querySelector('.find-btn');
                    btn.disabled = true; btn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                    const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
                    const data = await res.json();
                    if (data && data.length){
                        const { lat, lon } = data[0];
                        const latNum = parseFloat(lat), lngNum = parseFloat(lon);
                        if (editUI.get(id).marker) editUI.get(id).marker.setLatLng([latNum, lngNum]);
                        else editUI.get(id).marker = L.marker([latNum, lngNum]).addTo(editUI.get(id).map);
                        editUI.get(id).map.setView([latNum, lngNum], 12);
                        el.querySelector('.coords').textContent = `${latNum.toFixed(5)}, ${lngNum.toFixed(5)}`;
                        el.dataset.coords = JSON.stringify({lat:latNum, lng:lngNum});
                    } else {
                        alert('לא נמצאה תוצאה לחיפוש.');
                    }
                    btn.disabled = false; btn.textContent = 'מצא';
                }catch(e){
                    console.error(e);
                    alert('שגיאה בחיפוש מיקום.');
                    const btn = el.querySelector('.find-btn');
                    btn.disabled = false; btn.textContent = 'מצא';
                }
            });

            el.querySelector('.remove-btn').addEventListener('click', () => {
                if (confirm('למחוק יעד זה?')) {
                    editUI.get(id).map.remove();
                    editUI.delete(id);
                    el.remove();
                }
            });
        }

        function collectEditedDestinations(){
            const arr = [];
            DOM.destinationsList.querySelectorAll('[data-dest-id]').forEach(el => {
                const nameHe = el.querySelector('.dest-name-he').value.trim();
                const nameEn = el.querySelector('.dest-name-en').value.trim();
                const dates = el.querySelector('.dest-dates').value.trim();
                const backgroundUrl = el.querySelector('.dest-bg').value.trim();
                let coords = null;
                if (el.dataset.coords) {
                    try { coords = JSON.parse(el.dataset.coords); } catch {}
                } else if (editUI.get(el.dataset.destId)?.marker) {
                    const ll = editUI.get(el.dataset.destId).marker.getLatLng();
                    coords = { lat: ll.lat, lng: ll.lng };
                }
                if (!nameHe || !dates) return;
                arr.push({ nameHe, nameEn, dates, coords, backgroundUrl });
            });
            return arr;
        }

        async function saveDestinationsChanges(){
            const tripRef = doc(db, "trips", tripId);

            let startDate = tripData.startDate || null, endDate = tripData.endDate || null;
            const raw = DOM.tripDatesEdit.value.trim();
            if (raw && raw.includes(' - ')) {
                const [s,e] = raw.split(' - ');
                startDate = s; endDate = e;
            }

            const destinations = collectEditedDestinations();
            if (destinations.length === 0) {
                if (!confirm('לא נבחר אף יעד. לשמור בכל זאת?')) return;
            }

            const updated = { ...tripData, startDate, endDate, destinations };

            try{
                DOM.saveDestinationsBtn.disabled = true;
                DOM.saveDestinationsBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i>שומר...';
                await updateDoc(tripRef, updated);
                tripData = updated;
                // refresh UI
                buildSidebarMenu();
                buildTripMap();
                closeEditDestinationsModal();
            }catch(e){
                console.error(e);
                alert('שגיאה בשמירת השינויים.');
            }finally{
                DOM.saveDestinationsBtn.disabled = false;
                DOM.saveDestinationsBtn.textContent = 'שמור שינויים';
            }
        }

        // --- NEW: Share Modal Logic ---
        function openShareModal() {
            DOM.shareModal.classList.remove('hidden');
            setTimeout(() => DOM.shareModal.classList.remove('opacity-0'), 10);
        }
        function closeShareModal() {
            DOM.shareModal.classList.add('opacity-0');
            setTimeout(() => DOM.shareModal.classList.add('hidden'), 300);
        }

        // --- Event Listeners ---
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);
        DOM.navigateHotelBtn.addEventListener('click', handleNavigateToHotel);
        DOM.navModalClose.addEventListener('click', () => {
            DOM.navModal.classList.add('opacity-0');
            setTimeout(() => DOM.navModal.classList.add('hidden'), 300);
        });
        DOM.cancelLogoutBtn.addEventListener('click', () => DOM.logoutModal.classList.add('hidden'));
        DOM.confirmLogoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));

        // NEW: Share button listener
        DOM.shareTripBtn.addEventListener('click', openShareModal);
        DOM.shareModalCloseBtn.addEventListener('click', closeShareModal);
        DOM.shareAddEditorBtn.addEventListener('click', () => {
             if(tripId) window.location.href = `join.html?tripId=${tripId}`;
        });
        DOM.shareAsFileBtn.addEventListener('click', () => {
            if(tripId) window.location.href = `export.html?tripId=${tripId}`;
        });

        // Settings listeners
        DOM.settingsBtn.addEventListener('click', openSettingsModal);
        DOM.closeSettingsBtn.addEventListener('click', closeSettingsModal);
        DOM.saveSettingsBtn.addEventListener('click', saveSettings);

        DOM.openEditDestBtn.addEventListener('click', () => {
            closeSettingsModal();
            openEditDestinationsModal();
        });

        // Edit-destinations modal events
        DOM.editDestClose.addEventListener('click', closeEditDestinationsModal);
        DOM.editDestCancel.addEventListener('click', closeEditDestinationsModal);
        DOM.addDestBtn.addEventListener('click', () => addDestRow());
        DOM.saveDestinationsBtn.addEventListener('click', saveDestinationsChanges);

        // Details Modal Listeners
        DOM.detailsModalClose.addEventListener('click', closeDetailsModal);
        document.addEventListener('click', (e) => {
            const card = e.target.closest('.card[data-id]');
            if (card) {
                const itemId = card.dataset.id;
                const item = allLogisticsItems.find(i => i.id === itemId);
                openDetailsModal(item);
            }
        });
        
        // Navigation modal choice listener
        document.getElementById('nav-modal-content').addEventListener('click', (e) => {
            const choiceBtn = e.target.closest('.hotel-choice-btn');
            if (choiceBtn) {
                const address = choiceBtn.dataset.address;
                const name = choiceBtn.textContent;
                if (address) {
                    openNavModal({ title: `נווט אל ${name}`, options: [{ name, address }] });
                }
            }
        });

        // --- Start the page ---
        initPage();
    </script>
</body>
</html>
