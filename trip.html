<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מרכז הבקרה של הטיול</title>
    
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; }
        #sidebar { transition: transform 0.3s ease-in-out; }
        .submenu { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out; }
        .submenu.open { max-height: 1200px; }
        #trip-map-container { height: 450px; border-radius: 1rem; z-index: 0; }
        .modal { transition: opacity 0.3s ease; }
        .main-nav-button {
            transition: transform 0.2s ease-out, box-shadow 0.2s ease-out;
        }
        .main-nav-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        #loading-overlay { transition: opacity 0.5s ease-in-out; }
        .btn-spinner { animation: spin 1s linear infinite; }
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-plane text-5xl text-blue-600 animate-spin"></i>
        <p class="text-xl font-bold text-slate-700">טוען את הטיול שלך...</p>
    </div>

    <!-- Fixed Background -->
    <div id="page-bg" class="fixed inset-0 z-0 bg-cover bg-center transition-all duration-1000" style="background-image: url('https://i.imgur.com/PXLTIi4.jpeg');"></div>
    <div class="fixed inset-0 z-0 bg-black/50"></div>

    <!-- Scrollable Content Wrapper -->
    <div class="relative z-10">
        <!-- Navigation Modal -->
        <div id="nav-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
                <h3 id="nav-modal-title" class="text-xl font-bold text-slate-800 mb-4">נווט אל...</h3>
                <div id="nav-modal-content" class="flex flex-col gap-4">
                    <a id="nav-waze-link" href="#" target="_blank" class="block w-full text-center bg-[#33ccff] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#00bfff] transition text-lg"><i class="fa-brands fa-waze"></i> Waze</a>
                    <a id="nav-gmaps-link" href="#" target="_blank" class="block w-full text-center bg-[#4285F4] text-white font-bold py-3 px-4 rounded-lg hover:bg-[#3367D6] transition text-lg"><i class="fa-solid fa-map-location-dot"></i> Google Maps</a>
                </div>
                <p id="nav-modal-message" class="text-slate-600"></p>
                <button id="nav-modal-close" class="mt-6 text-slate-500 hover:text-slate-700">סגור</button>
            </div>
        </div>

        <!-- Logout Modal -->
        <div id="logout-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-8 w-full max-w-sm text-center">
                <h2 class="text-2xl font-bold mb-4">התנתקות</h2>
                <p class="text-slate-600 mb-8">האם אתה בטוח שברצונך להתנתק?</p>
                <div class="flex justify-center gap-4">
                    <button id="cancel-logout-btn" class="bg-gray-300 hover:bg-gray-400 text-black font-bold py-2 px-6 rounded-lg">ביטול</button>
                    <button id="confirm-logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg">התנתק</button>
                </div>
            </div>
        </div>
        
        <!-- Settings Modal -->
        <div id="settings-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[101] p-4">
            <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
                <div class="flex justify-between items-center mb-4 border-b pb-3">
                    <h2 class="text-2xl font-bold">הגדרות תצוגה</h2>
                    <button id="close-settings-btn" class="text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <div class="space-y-6">
                    <div>
                        <label for="main-bg-input" class="block text-sm font-medium text-slate-700 mb-1">רקע כללי לדף הטיול</label>
                        <input type="url" id="main-bg-input" class="w-full p-2 border rounded-md" placeholder="הדבק קישור (URL) לתמונה">
                    </div>
                    <hr>
                    <div>
                        <label for="destination-bg-select" class="block text-sm font-medium text-slate-700 mb-1">רקע ללו"ז יומי לפי יעד</label>
                        <select id="destination-bg-select" class="w-full p-2 border rounded-md"><option value="">-- בחר יעד --</option></select>
                        <div id="destination-bg-input-container" class="mt-2 hidden">
                             <label for="destination-bg-input" class="block text-sm font-medium text-slate-700 mb-1">רקע עבור <span id="dest-name-label" class="font-bold"></span></label>
                             <input type="url" id="destination-bg-input" class="w-full p-2 border rounded-md" placeholder="הדבק קישור (URL) לתמונה">
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-4">
                    <div id="settings-feedback" class="text-green-600 font-bold flex-grow"></div>
                    <button id="save-settings-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">שמור הגדרות</button>
                </div>
            </div>
        </div>
        
        <!-- Cashback Edit Modal -->
        <div id="cashback-modal" class="modal fixed inset-0 bg-black/60 z-[100] flex items-center justify-center p-4 hidden opacity-0">
            <div class="bg-white rounded-2xl shadow-xl p-6 w-full max-w-sm text-center">
                <h3 class="text-xl font-bold text-slate-800 mb-4">עדכון החזר כספי</h3>
                <label for="cashback-amount" class="text-slate-600">הזן את סכום ההחזר בשקלים (לדוגמה: -1500)</label>
                <input type="number" id="cashback-amount" class="form-input w-full p-3 mt-2 text-center text-lg font-mono border rounded-lg" placeholder="-1500">
                <div class="mt-6 flex gap-4">
                    <button id="cashback-modal-close" class="flex-1 py-2 px-6 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300">ביטול</button>
                    <button id="cashback-modal-save" class="flex-1 py-2 px-6 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">שמור</button>
                </div>
            </div>
        </div>

        <!-- Sidebar (Full Navigation Menu) -->
        <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl z-50 transform translate-x-full overflow-y-auto">
            <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white">
                <h2 class="text-2xl font-bold text-slate-800">תפריט המסע</h2>
                <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
            </div>
            <nav id="main-menu" class="p-4 space-y-2"></nav>
        </aside>

        <!-- Main Content -->
        <div id="main-content" class="min-h-screen">
            <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
                <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                    <div class="flex items-center justify-between h-16">
                        <a href="index.html" class="text-slate-700 font-bold hover:text-blue-600"><i class="fas fa-home"></i> דף הבית</a>
                        <div class="flex items-center gap-2 sm:gap-4">
                            <div id="auth-container"></div>
                            <button id="navigate-hotel-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="נווט למלון"><i class="fas fa-hotel fa-lg"></i></button>
                            <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="הגדרות"><i class="fas fa-cog fa-lg"></i></button>
                            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                        </div>
                    </div>
                </div>
            </header>

            <main>
                <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-12 space-y-12">
                
                    <section class="text-center">
                        <h2 id="trip-title" class="text-4xl md:text-5xl font-extrabold text-white drop-shadow-lg">טוען את שם הטיול...</h2>
                        <p class="mt-4 text-lg text-slate-200 max-w-3xl mx-auto">זהו מרכז הבקרה של הטיול! מכאן אפשר לנווט לכל המידע החשוב.</p>
                        <div id="main-nav-buttons" class="mt-8 grid grid-cols-2 md:grid-cols-4 gap-4 max-w-4xl mx-auto"></div>
                    </section>

                    <section>
                        <h3 class="text-3xl font-bold text-white mb-4 text-center drop-shadow-md">מפת המסע הכללית</h3>
                        <div class="bg-white/90 backdrop-blur-sm p-4 rounded-2xl shadow-lg"><div id="trip-map-container"></div></div>
                    </section>

                    <section id="hotel-summary-section">
                        <div class="flex flex-col sm:flex-row justify-center items-center gap-4 mb-6">
                             <h3 class="text-3xl font-bold text-white text-center drop-shadow-md">🏨 סיכום המלונות שלנו</h3>
                             <button id="refresh-rates-btn" class="bg-sky-500 hover:bg-sky-600 text-white font-bold py-2 px-5 rounded-lg transition flex items-center gap-2 shadow-md">
                                 <i id="refresh-rates-icon" class="fas fa-sync-alt"></i>
                                 <span id="refresh-rates-text">רענן המרות</span>
                             </button>
                         </div>
                        <div id="hotel-summary-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>
                    
                    <section id="transport-summary-section">
                        <h3 class="text-3xl font-bold text-white mb-6 text-center drop-shadow-md">✈️ סיכום המעברים שלנו</h3>
                        <div id="transport-summary-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    </section>

                    <section id="costs-summary-section">
                         <h3 class="text-3xl font-bold text-white mb-2 text-center drop-shadow-md flex items-center justify-center gap-4">
                             <span>📊 סיכומי עלויות</span>
                             <button id="edit-cashback-btn" class="p-2 text-white/70 hover:text-white" title="ערוך החזר כספי"><i class="fas fa-pencil-alt"></i></button>
                         </h3>
                         <div id="exchange-rates-display" class="text-center text-slate-200 text-sm mb-4">
                             <p id="usd-rate-display">טוען שער דולר...</p>
                         </div>
                        <div id="costs-summary-container" class="bg-white/90 backdrop-blur-sm p-6 rounded-2xl shadow-lg"></div>
                    </section>
                </div>
            </main>
        </div>
        
        <div id="overlay" class="fixed inset-0 bg-black/50 z-40 hidden"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            pageBg: document.getElementById('page-bg'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            navModal: document.getElementById('nav-modal'),
            navModalClose: document.getElementById('nav-modal-close'),
            navigateHotelBtn: document.getElementById('navigate-hotel-btn'),
            logoutModal: document.getElementById('logout-modal'),
            cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
            confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
            authContainer: document.getElementById('auth-container'),
            tripTitle: document.getElementById('trip-title'),
            tripMapContainer: document.getElementById('trip-map-container'),
            mainNavButtons: document.getElementById('main-nav-buttons'),
            hotelSummaryContainer: document.getElementById('hotel-summary-container'),
            transportSummaryContainer: document.getElementById('transport-summary-container'),
            costsSummaryContainer: document.getElementById('costs-summary-container'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            mainBgInput: document.getElementById('main-bg-input'),
            destinationBgSelect: document.getElementById('destination-bg-select'),
            destinationBgInputContainer: document.getElementById('destination-bg-input-container'),
            destinationBgInput: document.getElementById('destination-bg-input'),
            destNameLabel: document.getElementById('dest-name-label'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            settingsFeedback: document.getElementById('settings-feedback'),
            cashbackModal: document.getElementById('cashback-modal'),
            editCashbackBtn: document.getElementById('edit-cashback-btn'),
            cashbackModalClose: document.getElementById('cashback-modal-close'),
            cashbackModalSave: document.getElementById('cashback-modal-save'),
            cashbackAmountInput: document.getElementById('cashback-amount'),
            refreshRatesBtn: document.getElementById('refresh-rates-btn'),
            usdRateDisplay: document.getElementById('usd-rate-display'),
        };

        let currentUser = null;
        let tripId = null;
        let tripData = null;
        let allLogisticsItems = [];
        let logisticsUnsubscribe = null;
        let configUnsubscribe = null;
        let exchangeRates = { USD: null };
        let cashbackAmountILS = 0;

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id');
            if (!tripId) {
                alert("שגיאה: לא נמצא מזהה טיול.");
                window.location.href = 'index.html';
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadTripData();
                    setupAuthUI(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData() {
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);

            if (tripSnap.exists() && tripSnap.data().ownerId === currentUser.uid) {
                tripData = tripSnap.data();
                document.title = tripData.name;
                applySettings();
                populateUI();
                await fetchExchangeRates(); // Fetch rates before listening to data
                listenForLogistics();
                listenForConfig();
                DOM.loadingOverlay.style.display = 'none';
            } else {
                alert("הטיול לא נמצא או שאין לך הרשאה לצפות בו.");
                window.location.href = 'index.html';
            }
        }

        function listenForLogistics() {
            if (logisticsUnsubscribe) logisticsUnsubscribe();
            const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
            logisticsUnsubscribe = onSnapshot(query(logisticsCollectionRef), (snapshot) => {
                allLogisticsItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAllWithNewData();
            });
        }
        
        function listenForConfig() {
            if (configUnsubscribe) configUnsubscribe();
            const configDocRef = doc(db, "trips", tripId, "config", "main");
            configUnsubscribe = onSnapshot(configDocRef, (doc) => {
                if (doc.exists()) {
                    cashbackAmountILS = doc.data().cashbackAmount || 0;
                } else {
                    cashbackAmountILS = 0;
                }
                rerenderAllWithNewData();
            });
        }
        
        function rerenderAllWithNewData() {
            if (!exchangeRates.USD) return; // Don't render if rates aren't ready
            populateSummaries(allLogisticsItems);
        }

        // --- Settings Logic ---
        function applySettings() {
            if (tripData.backgroundUrl) {
                DOM.pageBg.style.backgroundImage = `url('${tripData.backgroundUrl}')`;
            }
        }

        function openSettingsModal() {
            DOM.mainBgInput.value = tripData.backgroundUrl || '';
            DOM.destinationBgSelect.innerHTML = '<option value="">-- בחר יעד --</option>';
            DOM.destinationBgInputContainer.classList.add('hidden');
            DOM.destinationBgInput.value = '';
            DOM.settingsFeedback.textContent = '';
            if (tripData && tripData.destinations) {
                tripData.destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest.nameHe;
                    option.textContent = dest.nameHe;
                    DOM.destinationBgSelect.appendChild(option);
                });
            }
            DOM.settingsModal.classList.remove('hidden');
        }

        function closeSettingsModal() { DOM.settingsModal.classList.add('hidden'); }

        async function saveSettings() {
            const tripRef = doc(db, "trips", tripId);
            const newMainBg = DOM.mainBgInput.value.trim();
            const selectedDestName = DOM.destinationBgSelect.value;
            const newDestBg = DOM.destinationBgInput.value.trim();
            let updatedTripData = { ...tripData };
            updatedTripData.backgroundUrl = newMainBg;
            if (selectedDestName) {
                const destIndex = updatedTripData.destinations.findIndex(d => d.nameHe === selectedDestName);
                if (destIndex !== -1) {
                    updatedTripData.destinations[destIndex].backgroundUrl = newDestBg;
                }
            }
            try {
                await updateDoc(tripRef, updatedTripData);
                tripData = updatedTripData;
                applySettings();
                DOM.settingsFeedback.textContent = 'ההגדרות נשמרו!';
                setTimeout(() => {
                    DOM.settingsFeedback.textContent = '';
                    closeSettingsModal();
                }, 1500);
            } catch (error) {
                console.error("Error saving settings:", error);
                DOM.settingsFeedback.textContent = 'שגיאה בשמירה.';
            }
        }
        
        // --- Cashback Modal Logic ---
        function openCashbackModal() {
            DOM.cashbackAmountInput.value = cashbackAmountILS;
            DOM.cashbackModal.classList.remove('hidden');
            setTimeout(() => DOM.cashbackModal.classList.remove('opacity-0'), 10);
        }

        function closeCashbackModal() {
            DOM.cashbackModal.classList.add('opacity-0');
            setTimeout(() => DOM.cashbackModal.classList.add('hidden'), 300);
        }

        async function saveCashback() {
            const newAmount = parseFloat(DOM.cashbackAmountInput.value);
            if (!isNaN(newAmount)) {
                try {
                    const configDocRef = doc(db, "trips", tripId, "config", "main");
                    await setDoc(configDocRef, { cashbackAmount: newAmount }, { merge: true });
                    closeCashbackModal();
                } catch (error) {
                    console.error("Error saving cashback:", error);
                    alert("שגיאה בשמירת הסכום.");
                }
            } else {
                alert("אנא הזן מספר תקין.");
            }
        }
        
        // --- Exchange Rate Logic ---
        async function fetchExchangeRates() {
            const refreshIcon = document.getElementById('refresh-rates-icon');
            const refreshText = document.getElementById('refresh-rates-text');
            refreshIcon.classList.add('btn-spinner');
            refreshText.textContent = 'מעדכן...';
            DOM.refreshRatesBtn.disabled = true;

            try {
                const response = await fetch('https://api.frankfurter.app/latest?from=USD&to=ILS');
                const data = await response.json();
                exchangeRates.USD = data.rates.ILS;
                DOM.usdRateDisplay.textContent = `שער הדולר: 1$ = ${exchangeRates.USD.toFixed(3)}₪`;
                rerenderAllWithNewData();
            } catch (e) {
                console.error("Failed to fetch exchange rates:", e);
                DOM.usdRateDisplay.textContent = 'שגיאה בטעינת שער דולר';
            } finally {
                refreshIcon.classList.remove('btn-spinner');
                refreshText.textContent = 'רענן המרות';
                DOM.refreshRatesBtn.disabled = false;
            }
        }

        // --- UI Population ---
        function populateUI() {
            DOM.tripTitle.textContent = tripData.name;
            buildSidebarMenu();
            buildTripMap();
            buildNavButtons();
        }
        
        function populateSummaries(items) {
            const hotels = items.filter(item => item.type === 'hotel');
            const transports = items.filter(item => ['flight', 'car_rental', 'ferry', 'train'].includes(item.type));
            renderHotelSummary(hotels);
            renderTransportSummary(transports);
            renderCostsSummary(items);
        }

        function renderHotelSummary(hotels) {
            const container = DOM.hotelSummaryContainer;
            if (hotels.length === 0) {
                container.innerHTML = `<p class="text-white/80 text-center col-span-full">לא נוספו מלונות. <a href="summary.html?tripId=${tripId}" class="font-bold underline hover:text-white">הוסף</a></p>`;
                return;
            }
             const sortedHotels = [...hotels].sort((a, b) => parseStartDateString(a.dates) - parseStartDateString(b.dates));
            container.innerHTML = sortedHotels.map(hotel => {
                const priceUSD = hotel.price || 0;
                const priceILS = exchangeRates.USD ? (priceUSD * exchangeRates.USD).toLocaleString('he-IL', {maximumFractionDigits: 0}) : '...';
                return `
                <div class="bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex flex-col">
                    <h4 class="font-bold text-lg text-slate-800">${hotel.name}</h4>
                    <p class="text-sm text-slate-500 mb-3">${hotel.destination} | ${hotel.dates}</p>
                    <ul class="space-y-2 text-slate-600 text-sm mb-4">
                        <li class="flex items-center gap-2"><i class="fa-solid fa-dollar-sign fa-fw text-blue-500"></i> <strong>מחיר:</strong> $${priceUSD.toLocaleString()}</li>
                        <li class="flex items-center gap-2"><i class="fa-solid fa-shekel-sign fa-fw text-green-600"></i> <strong>בשקלים:</strong> ${priceILS} ₪</li>
                    </ul>
                    <div class="mt-auto pt-4 border-t grid grid-cols-2 gap-2">
                        <a href="${hotel.link}" target="_blank" class="text-center bg-blue-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-600 transition ${!hotel.link ? 'opacity-50 cursor-not-allowed' : ''}">לאתר <i class="fa-solid fa-arrow-up-right-from-square text-xs"></i></a>
                        <button onclick="openNavModal('נווט אל ${hotel.name}', '${hotel.address}')" class="text-center bg-slate-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-slate-700 transition">נווט <i class="fa-solid fa-diamond-turn-right text-xs"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function renderTransportSummary(transports) {
            const container = DOM.transportSummaryContainer;
            if (transports.length === 0) {
                container.innerHTML = `<p class="text-white/80 text-center col-span-full">לא נוספו מעברים. <a href="summary.html?tripId=${tripId}" class="font-bold underline hover:text-white">הוסף</a></p>`;
                return;
            }
            const sortedTransports = [...transports].sort((a, b) => parseStartDateString(a.dates || a.date) - parseStartDateString(b.dates || b.date));
            container.innerHTML = sortedTransports.map(item => {
                let title = '', icon = '', priceUSD = 0;
                if (item.type === 'flight') {
                    title = `${item.from?.destination || ''} → ${item.to?.destination || ''}`;
                    icon = 'fa-plane-departure';
                    priceUSD = (item.price_per_person || 0) * (item.seats?.length || 1);
                } else { // car, ferry, train
                    title = item.type === 'car_rental' ? `רכב ב${item.destination}` : `${item.from_destination || item.from_station} → ${item.to_destination || item.to_station}`;
                    icon = item.type === 'car_rental' ? 'fa-car' : (item.type === 'ferry' ? 'fa-ship' : 'fa-train');
                    priceUSD = item.price || 0;
                }
                const priceILS = exchangeRates.USD ? (priceUSD * exchangeRates.USD).toLocaleString('he-IL', {maximumFractionDigits: 0}) : '...';
                return `
                <a href="summary.html?tripId=${tripId}" class="main-nav-button bg-white/90 backdrop-blur-sm p-5 rounded-2xl shadow-lg flex items-center gap-4 text-right">
                    <i class="fas ${icon} fa-2x text-sky-500"></i>
                    <div>
                        <h4 class="font-bold text-lg text-slate-800">${title}</h4>
                        <p class="text-sm text-slate-500">${item.airline || item.company || item.booked_via}</p>
                        <p class="text-sm text-slate-600 font-semibold">${item.dates || item.date}</p>
                        <p class="text-sm text-slate-800 font-bold mt-2">$${priceUSD.toLocaleString()} (${priceILS} ₪)</p>
                    </div>
                </a>`;
            }).join('');
        }

        function renderCostsSummary(items) {
            const container = DOM.costsSummaryContainer;
            if (!exchangeRates.USD) {
                container.innerHTML = `<p class="text-center">טוען שערי המרה...</p>`;
                return;
            }
            const hotels = items.filter(item => item.type === 'hotel');
            const transports = items.filter(item => ['flight', 'car_rental', 'ferry', 'train'].includes(item.type));
            
            const totalHotelsUSD = hotels.reduce((sum, hotel) => sum + (hotel.price || 0), 0);
            const totalTransportUSD = transports.reduce((sum, item) => {
                const price = item.type === 'flight' ? (item.price_per_person || 0) * (item.seats?.length || 1) : (item.price || 0);
                return sum + price;
            }, 0);

            const totalHotelsILS = totalHotelsUSD * exchangeRates.USD;
            const totalTransportILS = totalTransportUSD * exchangeRates.USD;
            const subTotal = totalHotelsILS + totalTransportILS;
            const finalTotal = subTotal + cashbackAmountILS;

            container.innerHTML = `
            <table class="w-full">
                <tbody class="divide-y divide-slate-200 text-slate-700">
                    <tr><td class="py-3 pr-2">🏨 סה"כ מלונות</td><td class="py-3 pl-2 text-left font-mono">${Math.round(totalHotelsILS).toLocaleString()} ₪</td></tr>
                    <tr><td class="py-3 pr-2">✈️ סה"כ תחבורה</td><td class="py-3 pl-2 text-left font-mono">${Math.round(totalTransportILS).toLocaleString()} ₪</td></tr>
                    <tr class="font-semibold"><td class="py-3 pr-2">סה"כ (לפני החזר)</td><td class="py-3 pl-2 text-left font-mono">${Math.round(subTotal).toLocaleString()} ₪</td></tr>
                    <tr><td class="py-3 pr-2 text-green-600">💸 החזר כספי</td><td class="py-3 pl-2 text-left font-mono text-green-600">${cashbackAmountILS.toLocaleString()} ₪</td></tr>
                    <tr class="text-xl font-bold bg-slate-100 rounded-lg"><td class="p-4">סה"כ סופי</td><td class="p-4 text-left font-mono">${Math.round(finalTotal).toLocaleString()} ₪</td></tr>
                </tbody>
            </table>`;
        }
        
        // --- Other UI building functions ---
        function setupAuthUI(user) { /* ... same as before ... */ }
        function buildNavButtons() { /* ... same as before ... */ }
        function buildSidebarMenu() { /* ... same as before ... */ }
        function buildTripMap() { /* ... same as before ... */ }
        function generateDatesFromRange(rangeStr) { /* ... same as before ... */ }
        function toggleSidebar() { /* ... same as before ... */ }
        window.openNavModal = openNavModal; // Make it globally accessible for inline onclick
        function parseStartDateString(dateString) {
            if (!dateString) return null;
            const datePart = dateString.split(' - ')[0]; 
            const [day, month, year] = datePart.split('/').map(Number);
            if (!day || !month || !year) return null;
            return new Date(year, month - 1, day);
        }

        // --- Event Listeners ---
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);
        DOM.navModalClose.addEventListener('click', () => { DOM.navModal.classList.add('opacity-0'); setTimeout(() => DOM.navModal.classList.add('hidden'), 300); });
        DOM.cancelLogoutBtn.addEventListener('click', () => DOM.logoutModal.classList.add('hidden'));
        DOM.confirmLogoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
        DOM.settingsBtn.addEventListener('click', openSettingsModal);
        DOM.closeSettingsBtn.addEventListener('click', closeSettingsModal);
        DOM.saveSettingsBtn.addEventListener('click', saveSettings);
        DOM.destinationBgSelect.addEventListener('change', (e) => {
            const selectedDestName = e.target.value;
            if (selectedDestName) {
                const destData = tripData.destinations.find(d => d.nameHe === selectedDestName);
                DOM.destNameLabel.textContent = selectedDestName;
                DOM.destinationBgInput.value = destData?.backgroundUrl || '';
                DOM.destinationBgInputContainer.classList.remove('hidden');
            } else {
                DOM.destinationBgInputContainer.classList.add('hidden');
            }
        });
        DOM.editCashbackBtn.addEventListener('click', openCashbackModal);
        DOM.cashbackModalClose.addEventListener('click', closeCashbackModal);
        DOM.cashbackModalSave.addEventListener('click', saveCashback);
        DOM.refreshRatesBtn.addEventListener('click', fetchExchangeRates);
        
        // --- Start the page ---
        initPage();
    </script>
</body>
</html>
