<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>מרכז הבקרה של הטיול</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <!-- Litepicker -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litepicker/dist/css/litepicker.css"/>
    <script src="https://cdn.jsdelivr.net/npm/litepicker/dist/litepicker.js"></script>

    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Heebo:wght@300;400;500;700;800;900&display=swap" rel="stylesheet">

    <style>
        /* --- Base & Reset --- */
        :root {
            --primary-color: #38bdf8; /* Sky 400 */
            --glass-bg: rgba(30, 41, 59, 0.75); /* Slate 800 with opacity */
            --glass-border: rgba(255, 255, 255, 0.1);
            --content-width: 1000px;
        }

        html { height: 100%; -webkit-tap-highlight-color: transparent; }
        body {
            font-family: 'Heebo', sans-serif;
            min-height: 100%;
            background-color: #0f172a; /* Slate 900 */
            color: #f8fafc;
            overflow-x: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- Custom Scrollbar --- */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Dynamic Background --- */
        .animated-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(125deg, #0f172a 0%, #1e293b 40%, #0f172a 100%);
        }
        .animated-bg::before {
            content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background: radial-gradient(circle, rgba(56, 189, 248, 0.08) 0%, transparent 60%),
                        radial-gradient(circle, rgba(139, 92, 246, 0.08) 0%, transparent 60%);
            animation: gradientMove 20s linear infinite;
            transform-origin: center center;
        }
        @keyframes gradientMove { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Glassmorphism Utilities --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid var(--glass-border);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.3);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-card:active { transform: scale(0.98); }
        .glass-card:hover { 
            background: rgba(255, 255, 255, 0.07); 
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3);
        }

        /* --- Component Styles --- */
        .section-title {
            position: relative;
            display: inline-block;
            margin-bottom: 1.5rem;
            font-weight: 800;
            letter-spacing: -0.5px;
            background: linear-gradient(to right, #fff, #94a3b8);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        /* Modern Accordion */
        .accordion-item {
            border-radius: 1rem;
            background: rgba(30, 41, 59, 0.4);
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-bottom: 0.75rem;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        .accordion-button {
            display: flex; align-items: center; justify-content: space-between;
            width: 100%; padding: 1.25rem;
            font-weight: 600; color: #e2e8f0;
            transition: background 0.2s;
        }
        .accordion-button:hover { background: rgba(255, 255, 255, 0.03); }
        .accordion-button.open { background: rgba(56, 189, 248, 0.1); color: #38bdf8; }
        .accordion-content {
            max-height: 0; overflow: hidden;
            transition: max-height 0.4s cubic-bezier(0, 1, 0, 1);
        }
        .accordion-content.open { max-height: 5000px; transition: max-height 0.6s ease-in-out; }
        .chevron { transition: transform 0.3s ease; }
        .accordion-button.open .chevron { transform: rotate(180deg); }

        /* Chips & Badges */
        .badge-soft {
            background: rgba(56, 189, 248, 0.1); color: #7dd3fc;
            padding: 0.2rem 0.6rem; border-radius: 99px;
            font-size: 0.75rem; font-weight: 600;
            display: inline-flex; align-items: center; gap: 0.3rem;
        }
        .price-tag {
            background: linear-gradient(135deg, #0ea5e9, #2563eb);
            color: white; padding: 0.25rem 0.75rem; border-radius: 99px;
            font-weight: 700; font-size: 0.85rem;
            box-shadow: 0 4px 10px rgba(14, 165, 233, 0.3);
        }

        /* --- Mobile Optimizations (Bottom Sheet) --- */
        .modal {
            transition: opacity 0.3s ease;
            backdrop-filter: blur(4px);
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1), opacity 0.3s ease;
        }
        
        @media (max-width: 640px) {
            .modal { align-items: flex-end; } /* Bottom alignment */
            .modal-content {
                width: 100%; max-width: 100%;
                border-bottom-left-radius: 0; border-bottom-right-radius: 0;
                border-top-left-radius: 1.5rem; border-top-right-radius: 1.5rem;
                transform: translateY(100%);
                max-height: 85vh;
            }
            .modal.show .modal-content { transform: translateY(0); }
        }
        @media (min-width: 641px) {
            .modal-content { transform: scale(0.95); border-radius: 1rem; }
            .modal.show .modal-content { transform: scale(1); }
        }

        /* --- Map Styling --- */
        #trip-map-container, .details-map-container {
            border-radius: 1rem;
            overflow: hidden;
            border: 2px solid rgba(255, 255, 255, 0.1);
            filter: grayscale(20%) contrast(1.1);
        }

        /* --- Sidebar Animation --- */
        #sidebar { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        
        /* --- Loading Spinner --- */
        .loader {
            width: 48px; height: 48px;
            border: 3px solid #FFF; border-bottom-color: transparent;
            border-radius: 50%; display: inline-block; box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* --- Form Elements --- */
        input, select {
            background: rgba(15, 23, 42, 0.6) !important;
            border: 1px solid rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        input:focus { border-color: #38bdf8 !important; outline: none; }
    </style>
</head>
<body class="antialiased selection:bg-sky-500 selection:text-white">

    <!-- Background -->
    <div class="animated-bg"></div>

    <!-- Loading Screen -->
    <div id="loading-overlay" class="fixed inset-0 bg-slate-900 z-[200] flex flex-col items-center justify-center gap-6 transition-opacity duration-500">
        <span class="loader"></span>
        <p class="text-lg font-medium text-slate-300 animate-pulse">מארגן את הטיול...</p>
    </div>

    <!-- Modals Wrapper -->
    <div class="relative z-50">
        
        <!-- GENERIC ALERT/CONFIRM -->
        <div id="generic-modal" class="hidden modal fixed inset-0 bg-black/80 z-[110] flex items-center justify-center p-4">
            <div class="modal-content glass-panel bg-slate-800 p-6 w-full max-w-sm text-center">
                <div class="w-12 h-12 rounded-full bg-sky-500/20 flex items-center justify-center mx-auto mb-4 text-sky-400">
                    <i class="fas fa-info text-xl"></i>
                </div>
                <h2 id="generic-modal-title" class="text-xl font-bold mb-2 text-white">כותרת</h2>
                <p id="generic-modal-message" class="text-slate-300 mb-6 text-sm leading-relaxed">הודעה.</p>
                <div id="generic-modal-buttons" class="flex justify-center gap-3"></div>
            </div>
        </div>

        <!-- NAVIGATE MODAL -->
        <div id="nav-modal" class="modal fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 hidden opacity-0 pointer-events-none">
            <div class="modal-content glass-panel bg-slate-800 p-6 w-full max-w-sm text-center">
                <div class="w-12 h-12 bg-emerald-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                    <i class="fas fa-location-arrow text-emerald-400 text-xl"></i>
                </div>
                <h3 id="nav-modal-title" class="text-xl font-bold text-white mb-2">נווט אל...</h3>
                <p id="nav-modal-message" class="text-slate-400 text-sm mb-6"></p>
                <div id="nav-modal-content" class="flex flex-col gap-3"></div>
                <button id="nav-modal-close" class="mt-6 text-slate-500 hover:text-white text-sm">סגור</button>
            </div>
        </div>

        <!-- SHARE MODAL -->
        <div id="share-modal" class="modal fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4 hidden opacity-0 pointer-events-none">
            <div class="modal-content glass-panel bg-slate-800 p-8 w-full max-w-md text-center">
                <h3 class="text-2xl font-bold text-white mb-2">שיתוף הטיול</h3>
                <p class="text-slate-400 mb-8 text-sm">איך תרצה לשתף את התוכנית?</p>
                <div class="grid grid-cols-2 gap-4">
                    <button id="share-add-editor-btn" class="glass-card p-4 rounded-xl flex flex-col items-center gap-3 hover:bg-sky-500/10 transition">
                        <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400"><i class="fas fa-user-plus"></i></div>
                        <span class="font-bold text-sm text-slate-200">עריכה משותפת</span>
                    </button>
                    <button id="share-as-file-btn" class="glass-card p-4 rounded-xl flex flex-col items-center gap-3 hover:bg-emerald-500/10 transition">
                        <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400"><i class="fas fa-file-pdf"></i></div>
                        <span class="font-bold text-sm text-slate-200">ייצוא לקובץ</span>
                    </button>
                </div>
                <button id="share-modal-close-btn" class="mt-8 py-2 px-6 rounded-full bg-slate-700 hover:bg-slate-600 text-white text-sm font-medium transition">ביטול</button>
            </div>
        </div>

        <!-- LOGOUT MODAL -->
        <div id="logout-modal" class="hidden modal fixed inset-0 bg-black/80 z-[101] flex items-center justify-center p-4">
            <div class="modal-content glass-panel bg-slate-800 p-8 w-full max-w-sm text-center">
                <h2 class="text-xl font-bold mb-4 text-white">התנתקות</h2>
                <p class="text-slate-400 mb-8">האם להתנתק מהמערכת?</p>
                <div class="flex justify-center gap-3">
                    <button id="cancel-logout-btn" class="px-6 py-2 rounded-lg bg-slate-700 text-slate-200 hover:bg-slate-600">ביטול</button>
                    <button id="confirm-logout-btn" class="px-6 py-2 rounded-lg bg-red-500/80 text-white hover:bg-red-600">התנתק</button>
                </div>
            </div>
        </div>
       
        <!-- SETTINGS MODAL -->
        <div id="settings-modal" class="hidden modal fixed inset-0 bg-black/80 z-[101] flex items-center justify-center p-4">
            <div class="modal-content glass-panel bg-slate-800 p-0 w-full max-w-lg overflow-hidden flex flex-col max-h-[90vh]">
                <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-900/50">
                    <h2 class="text-lg font-bold text-white">הגדרות</h2>
                    <button id="close-settings-btn" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-700 text-slate-300 hover:bg-slate-600"><i class="fas fa-times"></i></button>
                </div>
                <div class="p-6 space-y-6 overflow-y-auto">
                    <div>
                        <label for="main-bg-input" class="block text-sm font-medium text-slate-400 mb-2">תמונת רקע (URL)</label>
                        <input type="url" id="main-bg-input" class="w-full p-3 rounded-lg text-sm" placeholder="https://...">
                    </div>
                    
                    <div class="grid grid-cols-1 gap-3">
                        <button id="open-edit-destinations-btn" class="flex items-center justify-between p-4 rounded-xl bg-sky-900/20 border border-sky-500/30 hover:bg-sky-900/40 transition group">
                            <span class="flex items-center gap-3 font-semibold text-sky-100">
                                <div class="w-8 h-8 rounded-lg bg-sky-500/20 flex items-center justify-center text-sky-400"><i class="fa-solid fa-calendar-days"></i></div>
                                עריכת תאריכים ויעדים
                            </span>
                            <i class="fas fa-chevron-left text-sky-500/50 group-hover:-translate-x-1 transition"></i>
                        </button>

                        <a id="open-shortcuts-btn" href="#" class="flex items-center justify-between p-4 rounded-xl bg-purple-900/20 border border-purple-500/30 hover:bg-purple-900/40 transition group">
                            <span class="flex items-center gap-3 font-semibold text-purple-100">
                                <div class="w-8 h-8 rounded-lg bg-purple-500/20 flex items-center justify-center text-purple-400"><i class="fa-solid fa-rocket"></i></div>
                                מרכז הקיצורים (Shortcuts)
                            </span>
                            <i class="fas fa-chevron-left text-purple-500/50 group-hover:-translate-x-1 transition"></i>
                        </a>
                    </div>

                    <div class="mt-8 pt-6 border-t border-slate-700">
                        <h3 class="text-xs font-bold text-slate-500 uppercase mb-3">אזור סכנה</h3>
                        <button id="delete-trip-btn" class="w-full p-3 rounded-lg border border-red-500/30 text-red-400 hover:bg-red-500/10 transition text-sm font-bold flex items-center justify-center gap-2">
                            <i class="fa-solid fa-trash-alt"></i> מחק טיול זה
                        </button>
                    </div>
                </div>
                <div class="p-4 border-t border-slate-700 bg-slate-900/50 flex justify-between items-center">
                    <div id="settings-feedback" class="text-sm font-medium"></div>
                    <button id="save-settings-btn" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-6 rounded-lg text-sm shadow-lg shadow-sky-500/20">שמור</button>
                </div>
            </div>
        </div>

        <!-- EDIT DESTINATIONS MODAL -->
        <div id="edit-destinations-modal" class="hidden modal fixed inset-0 bg-black/90 z-[110] p-0 sm:p-4 flex items-center justify-center">
            <div class="modal-content glass-panel bg-slate-800 rounded-none sm:rounded-2xl w-full max-w-4xl h-full sm:h-[90vh] flex flex-col">
                <header class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-900/80 backdrop-blur-md sticky top-0 z-10">
                    <h2 class="text-lg font-bold text-white">עריכת לו"ז ויעדים</h2>
                    <button id="edit-destinations-close" class="text-slate-400 hover:text-white"><i class="fa-solid fa-xmark fa-lg"></i></button>
                </header>
                <main class="p-4 overflow-y-auto no-scrollbar flex-1 space-y-6 bg-slate-800">
                    <section class="glass-card p-4 rounded-xl">
                        <label class="block text-xs font-bold text-sky-400 mb-2 uppercase">טווח תאריכים כללי</label>
                        <input type="text" id="trip-dates-edit" class="w-full p-3 bg-slate-900 border border-slate-700 rounded-lg text-center font-mono text-white" placeholder="בחר תאריכים">
                    </section>
                    <section>
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="font-bold text-white text-lg">רשימת יעדים</h3>
                            <button id="add-dest-btn" class="bg-emerald-500/20 hover:bg-emerald-500/30 text-emerald-400 text-xs font-bold py-2 px-3 rounded-lg border border-emerald-500/30 transition flex items-center gap-2">
                                <i class="fa-solid fa-plus"></i> הוסף יעד
                            </button>
                        </div>
                        <div id="destinations-list" class="space-y-4"></div>
                    </section>
                </main>
                <footer class="p-4 border-t border-slate-700 bg-slate-900/80 flex justify-between items-center backdrop-blur-md">
                    <button id="edit-destinations-cancel" class="text-slate-400 hover:text-white font-medium text-sm">ביטול</button>
                    <button id="save-destinations-btn" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg shadow-emerald-500/20">שמור שינויים</button>
                </footer>
            </div>
        </div>

        <!-- DETAILS MODAL -->
        <div id="details-modal" class="modal fixed inset-0 bg-black/80 z-[102] hidden items-center justify-center p-0 sm:p-4 opacity-0 pointer-events-none">
            <div class="modal-content glass-panel bg-slate-800 w-full max-w-2xl h-[85vh] sm:h-auto sm:max-h-[90vh] flex flex-col">
                <header class="p-5 border-b border-slate-700 flex justify-between items-start bg-slate-900/50">
                    <h3 id="details-modal-title" class="text-xl font-bold text-white leading-tight pr-2">פרטים</h3>
                    <button id="details-modal-close" class="w-8 h-8 rounded-full bg-slate-700/50 flex items-center justify-center text-slate-400 hover:text-white hover:bg-slate-700"><i class="fas fa-times"></i></button>
                </header>
                <div id="details-modal-body" class="flex-grow overflow-y-auto p-6 space-y-5 custom-scroll">
                    <!-- Dynamic Content -->
                </div>
            </div>
        </div>

        <!-- Delete Modals (Hidden by default) -->
        <div id="delete-modal-1" class="hidden modal fixed inset-0 bg-black/80 z-[105] flex items-center justify-center p-4">
            <div class="modal-content glass-panel bg-slate-800 p-8 w-full max-w-sm text-center">
                <div class="w-16 h-16 rounded-full bg-red-500/10 flex items-center justify-center mx-auto mb-4 text-red-500"><i class="fas fa-trash-alt text-2xl"></i></div>
                <h2 class="text-xl font-bold mb-2 text-white">מחיקת טיול</h2>
                <p class="text-slate-400 mb-6 text-sm">האם אתה בטוח שברצונך למחוק?</p>
                <div class="flex justify-center gap-3">
                    <button id="cancel-delete-1" class="px-5 py-2 rounded-lg bg-slate-700 text-slate-300">ביטול</button>
                    <button id="confirm-delete-1" class="px-5 py-2 rounded-lg bg-red-600 text-white font-bold">כן, בטוח</button>
                </div>
            </div>
        </div>
        <div id="delete-modal-2" class="hidden modal fixed inset-0 bg-black/90 z-[106] flex items-center justify-center p-4">
             <div class="modal-content glass-panel bg-slate-800 p-8 w-full max-w-sm text-center border-red-500/50 border">
                <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                <h2 class="text-xl font-bold mb-4 text-white">אזהרה אחרונה!</h2>
                <p class="text-slate-300 mb-8 text-sm">המידע יימחק <strong class="text-red-400 underline">לצמיתות</strong> ולא ניתן לשחזור.</p>
                <div class="flex flex-col gap-3">
                    <button id="cancel-delete-2" class="w-full py-3 rounded-lg bg-slate-700 text-white font-bold">התחרטתי, בטל</button>
                    <button id="confirm-delete-2" class="w-full py-3 rounded-lg bg-red-600/20 text-red-500 border border-red-500/50 hover:bg-red-600 hover:text-white transition font-bold">מחק הכל לצמיתות</button>
                </div>
            </div>
        </div>

    </div> <!-- End Modals -->

    <!-- Sidebar -->
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 glass-panel border-l-0 border-r-0 border-t-0 border-b-0 bg-slate-900 z-[150] transform translate-x-full overflow-y-auto shadow-2xl">
        <div class="p-6 flex justify-between items-center border-b border-slate-700/50">
            <h2 class="text-xl font-bold text-white tracking-wide">תפריט המסע</h2>
            <button id="close-sidebar-btn" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-800 text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
        </div>
        <nav id="main-menu" class="p-4 space-y-2"></nav>
        <div class="absolute bottom-0 w-full p-4 border-t border-slate-700/50 bg-slate-900/50 backdrop-blur-sm">
             <div id="auth-container" class="flex justify-center"></div>
        </div>
    </aside>

    <!-- Overlay -->
    <div id="overlay" class="fixed inset-0 bg-black/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300"></div>

    <!-- Main App -->
    <div id="main-content" class="relative z-10 flex flex-col min-h-screen">
        
        <!-- Header -->
        <header class="sticky top-0 z-40 transition-all duration-300 bg-slate-900/80 backdrop-blur-md border-b border-white/5">
            <div class="container mx-auto px-4 h-16 flex items-center justify-between">
                <a href="index.html" class="flex items-center gap-2 text-white font-bold hover:text-sky-400 transition">
                    <div class="w-8 h-8 rounded-lg bg-sky-500 flex items-center justify-center shadow-lg shadow-sky-500/30">
                        <i class="fas fa-plane text-white text-sm"></i>
                    </div>
                    <span class="hidden sm:inline">MyTrip</span>
                </a>
                
                <div class="flex items-center gap-1 sm:gap-2">
                    <button id="navigate-hotel-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-300 hover:bg-white/10 hover:text-white transition" title="נווט למלון">
                        <i class="fas fa-bed"></i>
                    </button>
                    <button id="share-trip-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-300 hover:bg-white/10 hover:text-white transition" title="שתף">
                        <i class="fas fa-share-nodes"></i>
                    </button>
                    <button id="settings-btn" class="w-10 h-10 rounded-full flex items-center justify-center text-slate-300 hover:bg-white/10 hover:text-white transition" title="הגדרות">
                        <i class="fas fa-gear"></i>
                    </button>
                    <button id="hamburger-btn" class="ml-2 w-10 h-10 rounded-full flex items-center justify-center bg-white/10 text-white hover:bg-white/20 transition">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Content -->
        <main class="flex-grow container mx-auto px-4 pb-20 pt-8 space-y-10 max-w-5xl">

            <!-- Hero Section -->
            <section class="text-center space-y-6 relative">
                <!-- Background decorative element for Trip Title -->
                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-3/4 h-32 bg-sky-500/20 blur-[60px] rounded-full pointer-events-none"></div>
                
                <h1 id="trip-title" class="text-4xl md:text-6xl font-black text-white tracking-tight relative z-10 drop-shadow-2xl">
                    <span class="bg-clip-text text-transparent bg-gradient-to-r from-white via-sky-100 to-sky-300">
                        טוען טיול...
                    </span>
                </h1>
                
                <!-- Quick Stats Bento Grid -->
                <div class="grid grid-cols-2 gap-3 max-w-2xl mx-auto mt-8">
                    <a id="today-expense-card-link" href="#" class="glass-card p-4 rounded-2xl flex flex-col items-center justify-center gap-2 group">
                        <div class="w-10 h-10 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-lg group-hover:scale-110 transition"><i class="fas fa-coins"></i></div>
                        <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">הוצאות היום</span>
                        <span id="today-expenses-summary" class="text-xl font-black text-white">...</span>
                    </a>
                    <a id="total-expense-card-link" href="#" class="glass-card p-4 rounded-2xl flex flex-col items-center justify-center gap-2 group">
                        <div class="w-10 h-10 rounded-full bg-purple-500/20 text-purple-400 flex items-center justify-center text-lg group-hover:scale-110 transition"><i class="fas fa-wallet"></i></div>
                        <span class="text-xs text-slate-400 font-bold uppercase tracking-wider">סה"כ טיול</span>
                        <span id="total-expenses-summary" class="text-xl font-black text-white">...</span>
                    </a>
                </div>

                <!-- Main Navigation Grid -->
                <div id="main-nav-buttons" class="grid grid-cols-2 md:grid-cols-4 gap-3 max-w-4xl mx-auto mt-4">
                    <!-- Injected via JS -->
                </div>
            </section>

            <!-- Map Section -->
            <section>
                <div class="flex items-center justify-between mb-4 px-1">
                    <h3 class="text-xl font-bold text-white flex items-center gap-2"><i class="fas fa-map-marked-alt text-sky-400"></i> מפת המסע</h3>
                </div>
                <div id="trip-map-container" class="h-64 md:h-80 shadow-2xl shadow-sky-900/20"></div>
            </section>

            <!-- Logistics -->
            <section id="logistics-summary-section">
                 <h3 class="section-title text-2xl">לו"ז ולוגיסטיקה</h3>
                 <div id="logistics-accordion-container" class="space-y-3">
                     <!-- Accordions -->
                 </div>
            </section>

             <!-- Costs Summary Box -->
             <section id="costs-summary-section" class="pb-8">
                <div class="glass-panel rounded-2xl p-6 relative overflow-hidden">
                    <div class="absolute top-0 right-0 w-32 h-32 bg-sky-500/10 rounded-full blur-3xl -mr-10 -mt-10 pointer-events-none"></div>
                    <div id="costs-summary-container">
                         <!-- Injected content -->
                    </div>
                </div>
            </section>

        </main>
    </div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, onSnapshot, updateDoc, enableIndexedDbPersistence, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        enableIndexedDbPersistence(db).catch((err) => {
         if (err.code == 'failed-precondition') {
           console.warn("Persistence failed because of multiple tabs open.");
         } else if (err.code == 'unimplemented') {
           console.warn("Browser does not support persistence.");
         }
        });

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            navModal: document.getElementById('nav-modal'),
            navModalContent: document.getElementById('nav-modal-content'),
            navModalClose: document.getElementById('nav-modal-close'),
            navigateHotelBtn: document.getElementById('navigate-hotel-btn'),
            logoutModal: document.getElementById('logout-modal'),
            cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
            confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
            authContainer: document.getElementById('auth-container'),
            tripTitle: document.getElementById('trip-title'),
            tripMapContainer: document.getElementById('trip-map-container'),
            mainNavButtons: document.getElementById('main-nav-buttons'),
            logisticsAccordionContainer: document.getElementById('logistics-accordion-container'),
            costsSummaryContainer: document.getElementById('costs-summary-container'),
            shareTripBtn: document.getElementById('share-trip-btn'),
            shareModal: document.getElementById('share-modal'),
            shareModalCloseBtn: document.getElementById('share-modal-close-btn'),
            shareAsFileBtn: document.getElementById('share-as-file-btn'),
            shareAddEditorBtn: document.getElementById('share-add-editor-btn'),
            settingsBtn: document.getElementById('settings-btn'),
            settingsModal: document.getElementById('settings-modal'),
            closeSettingsBtn: document.getElementById('close-settings-btn'),
            mainBgInput: document.getElementById('main-bg-input'),
            saveSettingsBtn: document.getElementById('save-settings-btn'),
            settingsFeedback: document.getElementById('settings-feedback'),
            openEditDestBtn: document.getElementById('open-edit-destinations-btn'),
            openShortcutsBtn: document.getElementById('open-shortcuts-btn'),
            editDestModal: document.getElementById('edit-destinations-modal'),
            editDestClose: document.getElementById('edit-destinations-close'),
            editDestCancel: document.getElementById('edit-destinations-cancel'),
            saveDestinationsBtn: document.getElementById('save-destinations-btn'),
            tripDatesEdit: document.getElementById('trip-dates-edit'),
            destinationsList: document.getElementById('destinations-list'),
            addDestBtn: document.getElementById('add-dest-btn'),
            detailsModal: document.getElementById('details-modal'),
            detailsModalTitle: document.getElementById('details-modal-title'),
            detailsModalBody: document.getElementById('details-modal-body'),
            detailsModalClose: document.getElementById('details-modal-close'),
            deleteTripBtn: document.getElementById('delete-trip-btn'),
            deleteModal1: document.getElementById('delete-modal-1'),
            cancelDelete1: document.getElementById('cancel-delete-1'),
            confirmDelete1: document.getElementById('confirm-delete-1'),
            deleteModal2: document.getElementById('delete-modal-2'),
            cancelDelete2: document.getElementById('cancel-delete-2'),
            confirmDelete2: document.getElementById('confirm-delete-2'),
            todayExpensesSummary: document.getElementById('today-expenses-summary'),
            totalExpensesSummary: document.getElementById('total-expenses-summary'),
            todayExpenseCardLink: document.getElementById('today-expense-card-link'),
            totalExpenseCardLink: document.getElementById('total-expense-card-link'),
        };

        let currentUser = null;
        let tripId = null;
        let tripData = null;
        let allLogisticsItems = [];
        let allExpenses = [];
        let logisticsUnsubscribe = null;
        let expensesUnsubscribe = null;
        let detailsMap = null;
        let rateCache = {};

        const editUI = new Map();

        // --- Generic Modal Logic ---
        let confirmResolve = null;

        function showAlert(title, message, callback) {
            const modal = document.getElementById('generic-modal');
            document.getElementById('generic-modal-title').textContent = title;
            document.getElementById('generic-modal-message').innerHTML = message;
            const buttonsContainer = document.getElementById('generic-modal-buttons');

            buttonsContainer.innerHTML = '<button id="generic-modal-ok" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-8 rounded-lg shadow-lg shadow-sky-900/50">אישור</button>';

            toggleModal(modal, true);

            const okBtn = document.getElementById('generic-modal-ok');
            okBtn.onclick = () => {
                toggleModal(modal, false);
                if (callback) callback();
            };
        }

        function showConfirm(title, message) {
            return new Promise(resolve => {
                confirmResolve = resolve;
                const modal = document.getElementById('generic-modal');
                document.getElementById('generic-modal-title').textContent = title;
                document.getElementById('generic-modal-message').innerHTML = message;
                const buttonsContainer = document.getElementById('generic-modal-buttons');

                buttonsContainer.innerHTML = `
                    <button id="generic-modal-cancel" class="bg-slate-700 hover:bg-slate-600 text-white font-medium py-2 px-6 rounded-lg">ביטול</button>
                    <button id="generic-modal-confirm" class="bg-sky-600 hover:bg-sky-500 text-white font-bold py-2 px-6 rounded-lg shadow-lg">אשר</button>
                `;

                toggleModal(modal, true);

                document.getElementById('generic-modal-confirm').onclick = () => {
                    toggleModal(modal, false);
                    if (confirmResolve) confirmResolve(true);
                };
                document.getElementById('generic-modal-cancel').onclick = () => {
                    toggleModal(modal, false);
                    if (confirmResolve) confirmResolve(false);
                };
            });
        }
        
        function toggleModal(modal, show) {
            if (show) {
                modal.classList.remove('hidden');
                modal.classList.add('show');
                // Small delay to allow CSS transition to catch the display:block
                setTimeout(() => {
                    modal.classList.remove('opacity-0', 'pointer-events-none');
                    const content = modal.querySelector('.modal-content');
                    if (content) content.classList.remove('opacity-0', 'scale-95');
                }, 10);
            } else {
                modal.classList.remove('show');
                modal.classList.add('opacity-0', 'pointer-events-none');
                const content = modal.querySelector('.modal-content');
                if (content) content.classList.add('opacity-0', 'scale-95');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        // --- Page Initialization ---
        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            if (!tripId) {
                showAlert("שגיאה", "לא נמצא מזהה טיול.", () => {
                    window.location.href = 'index.html';
                });
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    currentUser = user;
                    loadTripData();
                    setupAuthUI(user);
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        async function loadTripData() {
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);

            if (tripSnap.exists()) {
                const loadedTripData = tripSnap.data();
                const canAccess = loadedTripData.owner === currentUser.uid || (loadedTripData.editors && loadedTripData.editors.includes(currentUser.uid));

                if (canAccess) {
                    tripData = loadedTripData;
                    document.title = tripData.name;
                    applySettings();
                    populateUI();
                    listenForLogistics();
                    listenForExpenses();
                    
                    // Smooth loading fade out
                    DOM.loadingOverlay.classList.add('opacity-0');
                    setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);

                } else {
                    showAlert("שגיאה", "הטיול לא נמצא או שאין לך הרשאה לצפות בו.", () => {
                       window.location.href = 'index.html';
                    });
                }
            } else {
                showAlert("שגיאה", "הטיול לא נמצא או שאין לך הרשאה לצפות בו.", () => {
                    window.location.href = 'index.html';
                });
            }
        }

        function listenForLogistics() {
            if (logisticsUnsubscribe) logisticsUnsubscribe();
            const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
            const q = query(logisticsCollectionRef);
            logisticsUnsubscribe = onSnapshot(q, async (snapshot) => {
                allLogisticsItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                await populateSummaries(allLogisticsItems);
            }, (error) => {
                console.error("Logistics snapshot error:", error);
            });
        }

        // --- Expenses Logic ---
        function listenForExpenses() {
            if (expensesUnsubscribe) expensesUnsubscribe();
            const expensesCollectionRef = collection(db, "trips", tripId, "expenses");
            expensesUnsubscribe = onSnapshot(expensesCollectionRef, async (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                await prefetchAllCurrencyRates(allExpenses);
                renderExpenseSummary(allExpenses);
            }, (error) => {
                console.error("Expenses snapshot error:", error);
                DOM.todayExpensesSummary.textContent = 'שגיאה';
                DOM.totalExpensesSummary.textContent = 'שגיאה';
            });
        }

        async function renderExpenseSummary(expenses) {
            const todayString = new Date().toISOString().split('T')[0];
            const todayExpenses = expenses.filter(exp => exp.date === todayString);

            let todayTotalILS = 0;
            for (const exp of todayExpenses) {
                todayTotalILS += await convertToILS(Number(exp.amount) || 0, exp.currency);
            }

            let grandTotalILS = 0;
            for (const exp of expenses) {
                grandTotalILS += await convertToILS(Number(exp.amount) || 0, exp.currency);
            }

            DOM.todayExpensesSummary.textContent = `₪${todayTotalILS.toLocaleString('he-IL', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
            DOM.totalExpensesSummary.textContent = `₪${grandTotalILS.toLocaleString('he-IL', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`;
        }

        // --- Settings Logic ---
        function applySettings() {
            // Note: In this new design, we use CSS gradients as default. 
            // If user has a BG image, we can overlay it or ignore it to keep the theme consistency.
            // For now, let's respect the user's wish but keep it subtle.
            if (tripData.backgroundUrl) {
                // We will create a pseudo element on body via JS if needed, but let's just stick to the animated gradient for modern feel
                // OR apply it to the .animated-bg div with low opacity
                const bgDiv = document.querySelector('.animated-bg');
                bgDiv.style.backgroundImage = `url('${tripData.backgroundUrl}')`;
                bgDiv.style.backgroundSize = 'cover';
                bgDiv.style.backgroundPosition = 'center';
                bgDiv.style.opacity = '0.4'; // Keep it dark
                bgDiv.classList.remove('animated-bg'); // remove animation if image exists
                bgDiv.classList.add('fixed', 'inset-0', 'z-0'); // ensure classes
            }
        }

        function openSettingsModal() {
            DOM.mainBgInput.value = tripData.backgroundUrl || '';
            DOM.settingsFeedback.textContent = '';
            toggleModal(DOM.settingsModal, true);
        }
        function closeSettingsModal() { toggleModal(DOM.settingsModal, false); }

        async function saveSettings() {
            const tripRef = doc(db, "trips", tripId);
            let updatedTripData = { ...tripData };
            updatedTripData.backgroundUrl = (DOM.mainBgInput.value || '').trim();

            try {
                await updateDoc(tripRef, updatedTripData);
                tripData = updatedTripData;
                applySettings();
                DOM.settingsFeedback.textContent = 'ההגדרות נשמרו!';
                DOM.settingsFeedback.classList.add('text-emerald-400');
                setTimeout(() => { DOM.settingsFeedback.textContent = ''; closeSettingsModal(); }, 1200);
            } catch (error) {
                console.error("Error saving settings:", error);
                DOM.settingsFeedback.textContent = 'שגיאה בשמירה.';
                DOM.settingsFeedback.classList.remove('text-emerald-400');
                DOM.settingsFeedback.classList.add('text-red-400');
            }
        }
       
        async function deleteTrip() {
            DOM.confirmDelete2.disabled = true;
            DOM.confirmDelete2.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> מוחק...';
           
            try {
                const logisticsCollectionRef = collection(db, "trips", tripId, "logistics");
                const logisticsSnapshot = await getDocs(logisticsCollectionRef);
                const deleteLogisticsPromises = logisticsSnapshot.docs.map(d => deleteDoc(d.ref));
               
                const expensesCollectionRef = collection(db, "trips", tripId, "expenses");
                const expensesSnapshot = await getDocs(expensesCollectionRef);
                const deleteExpensesPromises = expensesSnapshot.docs.map(d => deleteDoc(d.ref));
               
                await Promise.all([...deleteLogisticsPromises, ...deleteExpensesPromises]);
                await deleteDoc(doc(db, "trips", tripId));

                showAlert('הצלחה', 'הטיול נמחק בהצלחה.', () => {
                    window.location.href = 'index.html';
                });

            } catch (error) {
                console.error("Error deleting trip:", error);
                showAlert("שגיאה", "אירעה שגיאה במחיקת הטיול.");
                DOM.confirmDelete2.disabled = false;
                DOM.confirmDelete2.textContent = 'מחק לצמיתות';
            }
        }

        // --- UI Population ---
        function populateUI() {
            DOM.tripTitle.textContent = tripData.name;
            DOM.openShortcutsBtn.href = `shortcuts.html?tripId=${tripId}`;
            DOM.todayExpenseCardLink.href = `expenses.html?tripId=${tripId}`;
            DOM.totalExpenseCardLink.href = `expenses.html?tripId=${tripId}`;
            buildSidebarMenu();
            buildTripMap();
            buildNavButtons();
        }

        async function populateSummaries(items) {
            renderLogisticsAccordions(items);
            await renderCostsSummary(items);
        }

        // --- ACCORDION RENDER LOGIC (New Design) ---
        function renderLogisticsAccordions(items) {
            const container = DOM.logisticsAccordionContainer;
            container.innerHTML = '';

            const groups = {
                hotel: { title: "מלונות", icon: "fa-hotel", color: "text-amber-400", items: [] },
                flight: { title: "טיסות", icon: "fa-plane-departure", color: "text-sky-400", items: [] },
                car_rental: { title: "רכב שכור", icon: "fa-car", color: "text-emerald-400", items: [] },
                ride: { title: "הסעות", icon: "fa-taxi", color: "text-yellow-400", items: [] },
                ferry: { title: "מעבורות", icon: "fa-ship", color: "text-blue-400", items: [] },
                train: { title: "רכבות", icon: "fa-train", color: "text-purple-400", items: [] },
            };

            items.forEach(item => { if (groups[item.type]) groups[item.type].items.push(item); });

            // Sort logic
            Object.values(groups).forEach(group => {
                group.items.sort((a, b) => {
                    const dateA = getStartDate(a);
                    const dateB = getStartDate(b);
                    if (!dateA) return 1; if (!dateB) return -1;
                    return dateA - dateB;
                });
            });

            let hasContent = false;
            for (const key in groups) {
                const group = groups[key];
                if (group.items.length > 0) {
                    hasContent = true;
                    const accordionSection = document.createElement('div');
                    accordionSection.className = "accordion-item";
                   
                    const buttonId = `accordion-button-${key}`;
                    const contentId = `accordion-content-${key}`;

                    accordionSection.innerHTML = `
                        <button id="${buttonId}" class="accordion-button">
                            <span class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-white/5 flex items-center justify-center ${group.color}">
                                    <i class="fas ${group.icon}"></i>
                                </div>
                                ${group.title}
                                <span class="bg-slate-700 text-slate-300 text-xs py-0.5 px-2 rounded-full ml-2">${group.items.length}</span>
                            </span>
                            <i class="fas fa-chevron-down chevron text-slate-500"></i>
                        </button>
                        <div id="${contentId}" class="accordion-content">
                            <div class="p-3 pt-0 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <!-- Cards injected here -->
                            </div>
                        </div>
                    `;
                    container.appendChild(accordionSection);
                   
                    const cardContainer = accordionSection.querySelector('.grid');
                    const cardsHtml = group.items.map(item => 
                        key === 'hotel' ? createHotelCardHTML(item) : createTransportCardHTML(item)
                    ).join('');
                    cardContainer.innerHTML = cardsHtml;
                }
            }

            if (!hasContent) {
                container.innerHTML = `
                    <div class="glass-panel rounded-2xl p-8 text-center border-dashed border-slate-600">
                        <i class="fas fa-wind text-4xl text-slate-600 mb-3"></i>
                        <p class="text-slate-400">עדיין לא הוספו פרטים לוגיסטיים.</p>
                        <a href="logistics.html?tripId=${tripId}" class="inline-block mt-4 text-sky-400 hover:text-sky-300 font-bold">התחל לתכנן <i class="fas fa-arrow-left mr-1"></i></a>
                    </div>`;
            }

            container.querySelectorAll('.accordion-button').forEach(button => {
                button.addEventListener('click', () => {
                    const content = button.nextElementSibling;
                    button.classList.toggle('open');
                    content.classList.toggle('open');
                });
            });
        }
       
        function createHotelCardHTML(hotel) {
            const price = hotel.price ? `<div class="price-tag">$${Number(hotel.price).toLocaleString()}</div>` : '';
            const address = hotel.address ? `
                <div class="flex gap-2 mt-3 pt-3 border-t border-white/5 justify-end">
                    <a href="https://waze.com/ul?q=${encodeURIComponent(hotel.address)}" target="_blank" onclick="event.stopPropagation()" class="w-8 h-8 rounded-full bg-[#33ccff]/20 hover:bg-[#33ccff]/40 text-[#33ccff] flex items-center justify-center transition"><i class="fa-brands fa-waze"></i></a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(hotel.address)}" target="_blank" onclick="event.stopPropagation()" class="w-8 h-8 rounded-full bg-blue-500/20 hover:bg-blue-500/40 text-blue-400 flex items-center justify-center transition"><i class="fa-solid fa-map-location-dot"></i></a>
                </div>` : '';

            return `
            <div class="glass-card p-4 rounded-xl flex flex-col cursor-pointer group" data-id="${hotel.id}">
                <div class="flex justify-between items-start gap-2 mb-2">
                    <h4 class="font-bold text-white text-lg leading-tight group-hover:text-sky-300 transition">${hotel.name || 'מלון'}</h4>
                    ${price}
                </div>
                <div class="space-y-1.5 text-sm text-slate-300">
                    <div class="flex items-center gap-2"><i class="fa-solid fa-location-dot text-slate-500 w-4"></i> ${hotel.destination || ''}</div>
                    <div class="flex items-center gap-2"><i class="fa-regular fa-calendar text-slate-500 w-4"></i> ${hotel.dates || ''}</div>
                </div>
                ${address}
            </div>`;
        }
       
        function createTransportCardHTML(item) {
            let title = '', subtitle = '', icon = 'fa-ticket', color = 'text-slate-400';
            
            // Icon & Color Logic
            switch(item.type) {
                case 'flight': icon = 'fa-plane'; color = 'text-sky-400'; break;
                case 'car_rental': icon = 'fa-car'; color = 'text-emerald-400'; break;
                case 'ferry': icon = 'fa-ship'; color = 'text-blue-400'; break;
                case 'train': icon = 'fa-train'; color = 'text-purple-400'; break;
                case 'ride': icon = 'fa-taxi'; color = 'text-yellow-400'; break;
            }

            // Title Logic
            if (item.type === 'flight') title = `${item.from?.destination || '?'} <span class="text-slate-500">➝</span> ${item.to?.destination || '?'}`;
            else if (item.type === 'ferry' || item.type === 'train') title = `${item.from_station || item.from_destination || '?'} <span class="text-slate-500">➝</span> ${item.to_station || item.to_destination || '?'}`;
            else if (item.type === 'car_rental') title = item.destination || 'רכב שכור';
            else if (item.type === 'ride') title = 'הסעה פרטית';

            // Price Logic
            let priceDisplay = '';
            let totalPrice = (item.type === 'car_rental') ? (item.price || 0) : ((item.price_per_person || 0) * (item.travelers || 1));
            if(totalPrice > 0) priceDisplay = `<div class="price-tag">$${Number(totalPrice).toLocaleString()}</div>`;

            return `
            <div class="glass-card p-4 rounded-xl flex flex-col cursor-pointer group relative overflow-hidden" data-id="${item.id}">
                <div class="absolute top-0 left-0 w-1 h-full bg-gradient-to-b from-transparent via-white/10 to-transparent"></div>
                <div class="flex justify-between items-start gap-3 mb-2">
                    <div class="flex items-start gap-3">
                        <div class="mt-1 ${color}"><i class="fas ${icon}"></i></div>
                        <div>
                             <h4 class="font-bold text-white leading-tight group-hover:text-sky-300 transition">${title}</h4>
                             <p class="text-xs text-slate-400 mt-0.5">${item.airline || item.company || item.driver_name || ''}</p>
                        </div>
                    </div>
                    ${priceDisplay}
                </div>
                <div class="mt-2 flex flex-wrap gap-2">
                     <span class="badge-soft"><i class="fa-regular fa-clock"></i> ${item.pickup_time || item.departure_time || '??:??'}</span>
                     <span class="badge-soft bg-slate-700/50 text-slate-300 border border-slate-600"><i class="fa-regular fa-calendar"></i> ${item.dates || item.date || ''}</span>
                </div>
            </div>`;
        }

        async function renderCostsSummary(items) {
            const container = DOM.costsSummaryContainer;
            const usdToIlsRate = await getRate('USD', 'ILS');
           
            let totalCost = 0;
            items.forEach(item => {
                let itemCost = 0;
                if (item.type === 'hotel' || item.type === 'car_rental') {
                    itemCost = Number(item.price) || 0;
                } else {
                    itemCost = (Number(item.price_per_person) || 0) * (Number(item.travelers) || 1);
                }
                totalCost += itemCost;
            });

            container.innerHTML = `
                <div class="flex flex-col items-center justify-center relative z-10">
                     <p class="text-slate-400 text-sm font-medium tracking-wide">סה"כ לוגיסטיקה משוער</p>
                     <div class="text-5xl font-black text-white mt-2 mb-1 tracking-tight drop-shadow-lg">$${totalCost.toLocaleString()}</div>
                     <div class="inline-block bg-slate-800/80 rounded-full px-4 py-1 border border-slate-700">
                        <p class="text-lg font-bold text-emerald-400">₪${(totalCost * usdToIlsRate).toLocaleString('he-IL', { maximumFractionDigits: 0 })}</p>
                     </div>
                     <div class="mt-6 w-full h-px bg-gradient-to-r from-transparent via-slate-600 to-transparent"></div>
                     <div class="flex gap-4 mt-4 w-full justify-center text-center">
                        <div>
                             <span class="text-xs text-slate-500 block">שער המרה</span>
                             <span class="text-sm font-mono text-slate-300">${usdToIlsRate.toFixed(2)} ₪</span>
                        </div>
                         <div class="w-px bg-slate-700 h-8"></div>
                        <div>
                             <a href="logistics.html?tripId=${tripId}" class="text-xs text-sky-400 hover:text-white font-bold block mt-1 transition">פירוט מלא <i class="fas fa-arrow-left"></i></a>
                        </div>
                     </div>
                </div>
            `;
        }
       
        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? (docSnap.data().name || 'משתמש') : 'אורח';
                DOM.authContainer.innerHTML = `
                <button id="user-profile-btn" class="flex items-center gap-3 bg-slate-800/80 hover:bg-slate-700 py-2 px-4 rounded-full border border-slate-700 transition">
                    <div class="w-6 h-6 rounded-full bg-gradient-to-br from-sky-400 to-purple-500 flex items-center justify-center text-[10px] text-white font-bold">
                        ${name.charAt(0)}
                    </div>
                    <span class="text-sm font-medium text-slate-200">${name}</span>
                    <i class="fas fa-sign-out-alt text-slate-500 text-xs"></i>
                </button>`;
                document.getElementById('user-profile-btn').addEventListener('click', () => {
                    toggleModal(DOM.logoutModal, true);
                });
            });
        }

        function buildNavButtons() {
            const buttons = [
                { title: 'ניהול לוגיסטיקה', icon: 'fa-plane-circle-check', page: 'summary', color: 'bg-blue-500' },
                { title: 'אטרקציות', icon: 'fa-ticket-alt', page: 'attractions', color: 'bg-purple-500' },
                { title: 'צ\'ק ליסטים', icon: 'fa-clipboard-check', page: 'checklists', color: 'bg-emerald-500' },
                { title: 'הוצאות', icon: 'fa-chart-pie', page: 'expenses', color: 'bg-pink-500' },
            ];
            DOM.mainNavButtons.innerHTML = buttons.map(btn => `
                <a href="${btn.page}.html?tripId=${tripId}" class="glass-card p-4 rounded-2xl flex flex-col items-center justify-center gap-3 hover:bg-white/5 transition group">
                    <div class="w-12 h-12 rounded-xl ${btn.color} bg-opacity-20 flex items-center justify-center text-xl text-white shadow-inner group-hover:scale-110 transition duration-300 border border-white/10">
                        <i class="fas ${btn.icon}"></i>
                    </div>
                    <span class="font-bold text-sm text-slate-200">${btn.title}</span>
                </a>
            `).join('');
        }

        // --- Helper Functions ---
        function parseDDMMYYYY(s){
            if (!s || typeof s !== 'string') return null;
            const [d,m,y] = s.split('/').map(Number);
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            return new Date(y, m-1, d);
        }
        function hebWeekday(d){
            const n = d.toLocaleDateString('he-IL', { weekday:'long' });
            return n.startsWith('יום') ? n : `יום ${n}`;
        }
        function dotted(d){
            return `${d.getDate()}.${d.getMonth()+1}`;
        }
       
        async function prefetchAllCurrencyRates(expenses) {
            const uniqueCurrencies = [...new Set(expenses.map(e => e.currency))];
            const promises = uniqueCurrencies
                .filter(c => c !== 'ILS' && !rateCache[`${c}-ILS`])
                .map(c => getRate(c, 'ILS'));
            await Promise.all(promises);
        }

        async function getRate(from, to) {
            if (from === to) return 1;
            const cacheKey = `${from}-${to}`;
            if (rateCache[cacheKey]) return rateCache[cacheKey];
            try {
                const res = await fetch(`https://api.frankfurter.app/latest?from=${from}&to=${to}`);
                if (!res.ok) throw new Error('API error');
                const data = await res.json();
                const rate = data.rates[to];
                if (typeof rate !== 'number') return 1;
                rateCache[cacheKey] = rate;
                return rate;
            } catch (error) {
                if (from === 'USD' && to === 'ILS') return 3.7; 
                return 1; 
            }
        }
       
        async function convertToILS(amount, currency) {
            if (!currency || currency === 'ILS') return amount;
            const rate = rateCache[`${currency}-ILS`] || await getRate(currency, 'ILS');
            return amount * rate;
        }

        function buildSidebarMenu() {
            DOM.mainMenu.innerHTML = '';
            if (!tripData || !tripData.destinations) return;

            const sortedDestinations = [...tripData.destinations].sort((a, b) => {
                const dateA = parseDDMMYYYY(a.dates?.split(' - ')[0]);
                const dateB = parseDDMMYYYY(b.dates?.split(' - ')[0]);
                if (!dateA) return 1; if (!dateB) return -1;
                return dateA - dateB;
            });

            sortedDestinations.forEach(dest => {
                const destinationDiv = document.createElement('div');
                destinationDiv.className = 'mb-2';

                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 bg-white/5 hover:bg-white/10 rounded-lg font-bold text-slate-200 flex justify-between items-center transition border border-white/5';
                button.innerHTML = `<span><i class="fa-solid fa-location-dot ml-2 text-sky-500"></i>${dest.nameHe}</span> <i class="fas fa-chevron-down text-xs text-slate-500 transition-transform duration-300"></i>`;

                const submenu = document.createElement('div');
                submenu.className = 'submenu overflow-hidden max-h-0 transition-all duration-500 ease-in-out bg-black/20 rounded-b-lg mx-1';

                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dateStr => {
                    const d = parseDDMMYYYY(dateStr);
                    if (!d) return;
                    const a = document.createElement('a');

                    const destNameParam = encodeURIComponent(dest.nameHe);
                    a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;

                    a.className = 'block w-full text-right p-3 pr-8 border-b border-white/5 hover:bg-sky-500/10 hover:text-sky-300 transition text-sm';
                    a.innerHTML = `<span class="font-bold">${hebWeekday(d)}</span> <span class="opacity-50 mx-1">|</span> <span class="font-mono text-xs">${dotted(d)}</span>`;
                    submenu.appendChild(a);
                });

                button.addEventListener('click', () => {
                    const isOpen = submenu.style.maxHeight;
                    submenu.style.maxHeight = isOpen ? null : submenu.scrollHeight + "px";
                    button.querySelector('.fa-chevron-down').style.transform = isOpen ? 'rotate(0deg)' : 'rotate(180deg)';
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }

        function buildTripMap() {
            const mapContainer = DOM.tripMapContainer;
            if (!mapContainer) return;

            if (mapContainer._leaflet_id) {
                mapContainer._leaflet_id = null;
                mapContainer.innerHTML = "";
            }
            
            // Dark Mode Map Style
            const tripMap = L.map(mapContainer, { zoomControl: false }).setView([38, -95], 3.5);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { 
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(tripMap);

            const points = (tripData.destinations || []).filter(d => d.coords).map(d => [d.coords.lat, d.coords.lng]);

            const icon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#38bdf8;width:12px;height:12px;border-radius:50%;border:2px solid white;box-shadow:0 0 10px #38bdf8'></div>",
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });

            (tripData.destinations || []).forEach(dest => {
                if (dest.coords) {
                    L.marker([dest.coords.lat, dest.coords.lng], {icon: icon})
                     .addTo(tripMap)
                     .bindTooltip(dest.nameHe, {permanent: false, direction: 'top', className: 'bg-slate-800 text-white border-0 px-2 py-1 rounded shadow-lg'}).openTooltip();
                }
            });

            if (points.length > 1) {
                L.polyline(points, { color: '#38bdf8', weight: 3, opacity: 0.8, dashArray: '5, 10' }).addTo(tripMap);
                tripMap.fitBounds(points, { padding: [50, 50] });
            } else if (points.length === 1) {
                tripMap.setView(points[0], 8);
            }
        }

        // --- Core Helpers ---
        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDDMMYYYY(startStr);
            const endDate = parseDDMMYYYY(endStr);
            if (!startDate || !endDate) return [];
            const dates = [];
            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const dd = String(currentDate.getDate()).padStart(2,'0');
                const mm = String(currentDate.getMonth()+1).padStart(2,'0');
                const yyyy = currentDate.getFullYear();
                dates.push(`${dd}/${mm}/${yyyy}`);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function getStartDate(item) {
            let dateStr = item.dates || item.date;
            if (!dateStr || typeof dateStr !== 'string') return null;
            if (dateStr.includes(' - ')) dateStr = dateStr.split(' - ')[0].trim();
            return parseDDMMYYYY(dateStr);
        }
       
        function toggleSidebar() {
            DOM.sidebar.classList.toggle('translate-x-full');
            if(DOM.sidebar.classList.contains('translate-x-full')) {
                 DOM.overlay.classList.add('hidden');
            } else {
                DOM.overlay.classList.remove('hidden');
            }
        }

        // --- Navigation Modal Logic ---
        function openNavModal({ title, options = [], message = '' }) {
            document.getElementById('nav-modal-title').textContent = title;
            const navContent = DOM.navModalContent;
            const navMessage = document.getElementById('nav-modal-message');

            navContent.innerHTML = '';
            navMessage.textContent = '';
           
            if (options.length === 1 && options[0].address) {
                const { address } = options[0];
                navContent.innerHTML = `
                    <a href="https://waze.com/ul?q=${encodeURIComponent(address)}" target="_blank" class="flex items-center justify-center gap-3 w-full bg-[#33ccff]/10 text-[#33ccff] border border-[#33ccff]/30 font-bold py-3 px-4 rounded-xl hover:bg-[#33ccff]/20 transition"><i class="fa-brands fa-waze fa-xl"></i> Waze</a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(address)}" target="_blank" class="flex items-center justify-center gap-3 w-full bg-blue-500/10 text-blue-400 border border-blue-500/30 font-bold py-3 px-4 rounded-xl hover:bg-blue-500/20 transition"><i class="fa-solid fa-map-location-dot fa-xl"></i> Google Maps</a>
                `;
                navMessage.textContent = message;
            } else if (options.length > 1) {
                navContent.innerHTML = options.map(opt =>
                    `<button data-address="${opt.address}" class="hotel-choice-btn block w-full text-center bg-slate-700 hover:bg-slate-600 text-white font-medium py-3 px-4 rounded-xl transition border border-slate-600">${opt.name}</button>`
                ).join('');
                navMessage.textContent = "יש לבחור לאיזה מלון לנווט:";
            } else {
                navMessage.textContent = message || 'לא נמצא יעד לניווט.';
            }

            toggleModal(DOM.navModal, true);
        }
       
        function closeNavModal() { toggleModal(DOM.navModal, false); }

        function parseDate(dateStr) { return parseDDMMYYYY(dateStr); }

        function isDateInRange(checkDate, rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return false;
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDate(startStr);
            const endDate = parseDate(endStr);
            if (!startDate || !endDate) return false;
            const normalizedCheckDate = new Date(checkDate);
            normalizedCheckDate.setHours(0, 0, 0, 0);
            return normalizedCheckDate >= startDate && normalizedCheckDate <= endDate;
        }

        async function handleNavigateToHotel() {
            const hotels = allLogisticsItems.filter(item => item.type === 'hotel' && item.address);
            if (hotels.length === 0) {
                openNavModal({ title: 'ניווט למלון', message: 'לא נמצאו מלונות עם כתובת בטיול זה.' });
                return;
            }

            const today = new Date();
            const todaysHotels = hotels.filter(h => isDateInRange(today, h.dates));

            if (todaysHotels.length > 0) {
                openNavModal({
                    title: 'נווט למלון להיום',
                    options: todaysHotels.map(h => ({ name: h.name, address: h.address }))
                });
                return;
            }

            const futureHotels = hotels
                .map(h => ({ ...h, startDate: getStartDate(h) }))
                .filter(h => h.startDate && h.startDate >= today)
                .sort((a, b) => a.startDate - b.startDate);

            if (futureHotels.length > 0) {
                const nextHotel = futureHotels[0];
                openNavModal({
                    title: `המלון הבא`,
                    message: `${nextHotel.name} (בתאריך ${nextHotel.dates.split(' - ')[0]})`,
                    options: [{ name: nextHotel.name, address: nextHotel.address }]
                });
                return;
            }

            openNavModal({ title: 'ניווט למלון', message: 'לא נמצא מלון להיום או בעתיד.' });
        }

        // --- UPDATED DETAILS MODAL LOGIC ---
        function openDetailsModal(item) {
            if (!item) return;

            let contentHtml = '';
            switch(item.type) {
                case 'hotel': contentHtml = generateHotelDetailsHTML(item); break;
                case 'ride': contentHtml = generateRideDetailsHTML(item); break;
                case 'flight': contentHtml = generateFlightDetailsHTML(item); break;
                case 'car_rental': contentHtml = generateCarRentalDetailsHTML(item); break;
                case 'ferry': contentHtml = generateFerryDetailsHTML(item); break;
                case 'train': contentHtml = generateTrainDetailsHTML(item); break;
                default: contentHtml = `<p class="text-slate-400">אין תצוגה מפורטת עבור סוג פריט זה.</p>`;
            }

            DOM.detailsModalBody.innerHTML = contentHtml;
            toggleModal(DOM.detailsModal, true);
            setTimeout(() => initDetailsMap(item), 300); // delay for transition
        }

        function closeDetailsModal() {
            toggleModal(DOM.detailsModal, false);
            if (detailsMap) { detailsMap.remove(); detailsMap = null; }
        }
       
        function createDetailItem(icon, label, value, extraClasses = '') {
            if (!value || value === '-') return '';
            return `<div class="bg-slate-700/50 p-4 rounded-xl border border-slate-600/50 ${extraClasses}">
                        <div class="text-xs text-slate-400 font-bold uppercase tracking-wider flex items-center gap-2 mb-1"><i class="fas ${icon} fa-fw text-sky-500"></i> ${label}</div>
                        <div class="text-white font-medium text-base break-words leading-relaxed">${value}</div>
                    </div>`;
        }
       
        function generatePaymentDetailsHTML_DisplayOnly(item) {
            const payment = item.payment || { status: 'unpaid' };
            const totalCost = (item.type === 'hotel' || item.type === 'car_rental') 
                ? (item.price || 0) 
                : ((item.price_per_person || 0) * (item.travelers || 1));

            let statusText, statusColor, amountText = '';
            switch (payment.status) {
                case 'paid': statusText = 'שולם במלואו'; statusColor = 'text-emerald-400'; amountText = `$${totalCost.toLocaleString()}`; break;
                case 'partial': statusText = 'תשלום חלקי'; statusColor = 'text-amber-400'; amountText = `$${(payment.amountPaid || 0).toLocaleString()} / $${totalCost.toLocaleString()}`; break;
                default: statusText = 'לא שולם'; statusColor = 'text-red-400'; amountText = `$0 / $${totalCost.toLocaleString()}`;
            }
            return createDetailItem('fa-credit-card', 'סטטוס תשלום', `<span class="font-bold ${statusColor}">${statusText}</span><br><span class="text-sm opacity-80">${amountText}</span>`, 'sm:col-span-2');
        }

        function generateHotelDetailsHTML(item) {
            DOM.detailsModalTitle.textContent = item.name || 'פרטי מלון';
            let starsHtml = '';
            if (item.stars && item.stars > 0) {
                for (let i = 0; i < 5; i++) starsHtml += `<i class="fas fa-star ${i < item.stars ? 'text-yellow-400' : 'text-slate-600'}"></i>`;
            }
            return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    ${createDetailItem('fa-map-pin', 'יעד', item.destination)}
                    ${createDetailItem('fa-calendar-days', 'תאריכים', item.dates)}
                    ${createDetailItem('fa-dollar-sign', 'מחיר', `$${(item.price || 0).toLocaleString()}`)}
                    ${createDetailItem('fa-utensils', 'ארוחות', (item.meals || []).join(', '))}
                    ${createDetailItem('fa-star', 'דירוג', starsHtml)}
                    ${createDetailItem('fa-location-dot', 'כתובת', item.address, 'sm:col-span-2')}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-700/30 border border-slate-600 rounded-xl mt-4"><h5 class="font-bold text-sky-400 mb-2 text-xs uppercase">פרטים נוספים</h5><p class="whitespace-pre-wrap text-slate-300 text-sm">${item.additional_details}</p></div>` : ''}
                <div class="grid grid-cols-2 gap-3 mt-6">
                    <a href="${item.link}" target="_blank" class="flex items-center justify-center gap-2 bg-sky-600 hover:bg-sky-500 text-white font-bold py-3 px-4 rounded-xl transition ${item.link ? '' : 'opacity-50 pointer-events-none'}">הזמנה <i class="fa-solid fa-arrow-up-right-from-square"></i></a>
                    <a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(item.address)}" target="_blank" class="flex items-center justify-center gap-2 bg-slate-700 hover:bg-slate-600 text-white font-bold py-3 px-4 rounded-xl transition ${item.address ? '' : 'opacity-50 pointer-events-none'}">ניווט <i class="fa-solid fa-location-arrow"></i></a>
                </div>
                ${item.coords ? '<div id="details-map" class="details-map-container mt-4 h-48 rounded-xl"></div>' : ''}
            `;
        }
        
        // Similar simplified generators for other types (keeping structure but updating classes)
        function generateRideDetailsHTML(item) {
             DOM.detailsModalTitle.textContent = 'פרטי הסעה';
             return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    ${createDetailItem('fa-arrow-up', 'מאיפה', item.from_address, 'sm:col-span-2')}
                    ${createDetailItem('fa-arrow-down', 'לאיפה', item.to_address, 'sm:col-span-2')}
                    ${createDetailItem('fa-calendar-day', 'תאריך', item.date)}
                    ${createDetailItem('fa-clock', 'שעה', item.pickup_time)}
                    ${createDetailItem('fa-user-tie', 'נהג', `${item.driver_name || '-'} (${item.driver_phone || '-'})`)}
                    ${createDetailItem('fa-users', 'נוסעים', item.travelers)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-700/30 border border-slate-600 rounded-xl mt-4 text-slate-300 text-sm">${item.additional_details}</div>` : ''}
                ${item.route_geometry ? '<div id="details-map" class="details-map-container mt-4 h-48 rounded-xl"></div>' : ''}
             `;
        }

        function generateFlightDetailsHTML(item) {
            DOM.detailsModalTitle.textContent = `טיסה: ${item.from?.destination} > ${item.to?.destination}`;
             return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    ${createDetailItem('fa-plane', 'טיסה', `${item.airline} #${item.flight_number}`)}
                    ${createDetailItem('fa-clock', 'המראה', `${item.date} ${item.departure_time}`)}
                    ${createDetailItem('fa-clock', 'נחיתה', item.arrival_time)}
                    ${createDetailItem('fa-chair', 'מושבים', (item.seats || []).join(', '))}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${(item.from?.coords || item.to?.coords) ? '<div id="details-map" class="details-map-container mt-4 h-48 rounded-xl"></div>' : ''}
             `;
        }

        function generateCarRentalDetailsHTML(item) {
             DOM.detailsModalTitle.textContent = 'רכב שכור';
             return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    ${createDetailItem('fa-location-dot', 'איסוף', item.pickup_location, 'sm:col-span-2')}
                    ${createDetailItem('fa-calendar-days', 'תאריכים', item.dates)}
                    ${createDetailItem('fa-car-side', 'רכב', item.car_type)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
                ${item.additional_details ? `<div class="p-4 bg-slate-700/30 border border-slate-600 rounded-xl mt-4 text-slate-300 text-sm">${item.additional_details}</div>` : ''}
             `;
        }
        function generateFerryDetailsHTML(item) {
             DOM.detailsModalTitle.textContent = 'מעבורת';
             return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    ${createDetailItem('fa-ship', 'חברה', item.company)}
                    ${createDetailItem('fa-clock', 'יציאה', `${item.date} ${item.departure_time}`)}
                    ${createDetailItem('fa-dollar-sign', 'מחיר', `$${((item.price_per_person||0)*(item.travelers||1)).toLocaleString()}`)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
             `;
        }
        function generateTrainDetailsHTML(item) {
             DOM.detailsModalTitle.textContent = 'רכבת';
             return `
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                    ${createDetailItem('fa-train', 'קו', `${item.from_station} > ${item.to_station}`, 'sm:col-span-2')}
                    ${createDetailItem('fa-clock', 'יציאה', `${item.date} ${item.departure_time}`)}
                    ${generatePaymentDetailsHTML_DisplayOnly(item)}
                </div>
             `;
        }

        // --- Details Modal Map ---
        function initDetailsMap(item) {
            if (detailsMap) { detailsMap.remove(); detailsMap = null; }
            const mapContainer = document.getElementById('details-map');
            if (!mapContainer) return;

            detailsMap = L.map('details-map', {zoomControl: false}).setView([31.7683, 35.2137], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: '© OpenStreetMap' }).addTo(detailsMap);
            const layerGroup = L.layerGroup().addTo(detailsMap);
            const points = [];

            if (item.type === 'hotel' && item.coords) {
                 const c = [item.coords.lat, item.coords.lng || item.coords.lon];
                 L.marker(c).addTo(layerGroup); points.push(c);
            } else if (item.type === 'ride' && item.route_geometry) {
                 // Simplified for ride...
                 try {
                     const route = JSON.parse(item.route_geometry);
                     const latlngs = route.map(c => L.latLng(c.lat, c.lng));
                     L.polyline(latlngs, {color: '#38bdf8', weight: 4}).addTo(layerGroup);
                     points.push(latlngs[0], latlngs[latlngs.length-1]);
                 } catch(e){}
            } else if (item.type === 'flight') {
                if(item.from?.coords) { 
                    const c = [item.from.coords.lat, item.from.coords.lng];
                    L.marker(c).addTo(layerGroup); points.push(c);
                }
                if(item.to?.coords) {
                     const c = [item.to.coords.lat, item.to.coords.lng];
                     L.marker(c).addTo(layerGroup); points.push(c);
                }
                if(points.length > 1) L.polyline(points, {color: '#38bdf8', dashArray: '5,5'}).addTo(layerGroup);
            }

            if (points.length > 0) detailsMap.fitBounds(points, { padding: [30, 30] });
            setTimeout(() => detailsMap.invalidateSize(), 200);
        }

        // --- Edit Destinations Logic (Simplified for brevity but functional) ---
        function openEditDestinationsModal(){
            DOM.tripDatesEdit.value = (tripData.startDate && tripData.endDate) ? `${tripData.startDate} - ${tripData.endDate}` : '';
            new Litepicker({ element: DOM.tripDatesEdit, singleMode:false, lang:'he-IL', format:'DD/MM/YYYY' });
            DOM.destinationsList.innerHTML = '';
            editUI.clear();
            (tripData.destinations || []).forEach((dest, idx) => addDestRow(dest, idx));
            toggleModal(DOM.editDestModal, true);
        }
        function closeEditDestinationsModal(){ toggleModal(DOM.editDestModal, false); }

        function addDestRow(dest = {}, idx = Date.now()){
            const id = `dest-${idx}-${Math.random().toString(36).slice(2,7)}`;
            const el = document.createElement('div');
            el.className = 'glass-card bg-slate-700/30 p-4 rounded-xl border border-slate-600';
            el.dataset.destId = id;
            el.innerHTML = `
                <div class="flex items-start gap-3 justify-between">
                    <div class="flex-1 grid grid-cols-1 md:grid-cols-2 gap-3">
                        <input type="text" class="dest-name-he w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-sm" value="${dest.nameHe || ''}" placeholder="שם היעד (עברית)">
                        <div class="flex gap-2">
                            <input type="text" class="dest-name-en w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-sm" value="${dest.nameEn || ''}" placeholder="שם באנגלית (למפה)">
                            <button class="find-btn bg-sky-600 hover:bg-sky-500 text-white px-3 rounded text-sm"><i class="fas fa-search"></i></button>
                        </div>
                        <input type="text" class="dest-dates w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-sm text-center" value="${dest.dates || ''}" placeholder="תאריכים">
                        <input type="url" class="dest-bg w-full p-2 bg-slate-900 border border-slate-700 rounded text-white text-sm" value="${dest.backgroundUrl || ''}" placeholder="URL תמונת רקע">
                    </div>
                    <button class="remove-btn text-red-400 hover:text-red-300 p-2"><i class="fa-solid fa-trash"></i></button>
                </div>
                <div class="mt-3 w-full h-32 rounded-lg overflow-hidden bg-slate-800 border border-slate-600 relative">
                     <div class="map w-full h-full z-0"></div>
                     <div class="absolute bottom-1 right-1 bg-black/50 px-2 py-0.5 rounded text-[10px] text-slate-300 pointer-events-none coords-disp"></div>
                </div>
            `;
            DOM.destinationsList.appendChild(el);
            new Litepicker({ element: el.querySelector('.dest-dates'), singleMode:false, lang:'he-IL', format:'DD/MM/YYYY' });

            const mapDiv = el.querySelector('.map');
            const map = L.map(mapDiv, {zoomControl: false}).setView(dest.coords ? [dest.coords.lat, dest.coords.lng] : [20,0], dest.coords ? 10 : 1);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);
            const marker = dest.coords ? L.marker([dest.coords.lat, dest.coords.lng]).addTo(map) : null;
            editUI.set(id, { el, map, marker });
            
            // Map Search Logic
            el.querySelector('.find-btn').addEventListener('click', async () => {
                const q = el.querySelector('.dest-name-en').value.trim();
                if(!q) return;
                try {
                     const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1`);
                     const data = await res.json();
                     if(data.length){
                         const {lat, lon} = data[0];
                         const latNum=parseFloat(lat), lngNum=parseFloat(lon);
                         let m = editUI.get(id).marker;
                         if(m) m.setLatLng([latNum, lngNum]); else editUI.get(id).marker = L.marker([latNum, lngNum]).addTo(editUI.get(id).map);
                         editUI.get(id).map.setView([latNum, lngNum], 11);
                         el.dataset.coords = JSON.stringify({lat:latNum, lng:lngNum});
                         el.querySelector('.coords-disp').textContent = "מיקום עודכן";
                     }
                } catch(e){}
            });
            el.querySelector('.remove-btn').addEventListener('click', () => { el.remove(); editUI.delete(id); });
        }

        async function saveDestinationsChanges(){
            const tripRef = doc(db, "trips", tripId);
            let startDate = null, endDate = null;
            const raw = DOM.tripDatesEdit.value.trim();
            if (raw && raw.includes(' - ')) { const [s,e] = raw.split(' - '); startDate = s; endDate = e; }

            const destinations = [];
            DOM.destinationsList.querySelectorAll('[data-dest-id]').forEach(el => {
                const nameHe = el.querySelector('.dest-name-he').value.trim();
                const nameEn = el.querySelector('.dest-name-en').value.trim();
                const dates = el.querySelector('.dest-dates').value.trim();
                const backgroundUrl = el.querySelector('.dest-bg').value.trim();
                let coords = null;
                if (el.dataset.coords) coords = JSON.parse(el.dataset.coords);
                else if (editUI.get(el.dataset.destId)?.marker) {
                    const ll = editUI.get(el.dataset.destId).marker.getLatLng();
                    coords = { lat: ll.lat, lng: ll.lng };
                }
                if(nameHe) destinations.push({nameHe, nameEn, dates, backgroundUrl, coords});
            });

            try {
                DOM.saveDestinationsBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i>';
                await updateDoc(tripRef, {startDate, endDate, destinations});
                tripData.destinations = destinations;
                buildSidebarMenu(); buildTripMap();
                closeEditDestinationsModal();
            } catch(e){ console.error(e); } 
            finally { DOM.saveDestinationsBtn.textContent = 'שמור שינויים'; }
        }

        // --- Event Listeners ---
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar);
        DOM.navigateHotelBtn.addEventListener('click', handleNavigateToHotel);
        DOM.navModalClose.addEventListener('click', closeNavModal);
        DOM.cancelLogoutBtn.addEventListener('click', () => toggleModal(DOM.logoutModal, false));
        DOM.confirmLogoutBtn.addEventListener('click', () => signOut(auth).then(() => window.location.href = 'index.html'));
        DOM.shareTripBtn.addEventListener('click', () => toggleModal(DOM.shareModal, true));
        DOM.shareModalCloseBtn.addEventListener('click', () => toggleModal(DOM.shareModal, false));
        DOM.shareAddEditorBtn.addEventListener('click', () => window.location.href = `join.html?tripId=${tripId}`);
        DOM.shareAsFileBtn.addEventListener('click', () => window.location.href = `export.html?tripId=${tripId}`);
        DOM.settingsBtn.addEventListener('click', openSettingsModal);
        DOM.closeSettingsBtn.addEventListener('click', closeSettingsModal);
        DOM.saveSettingsBtn.addEventListener('click', saveSettings);
        DOM.deleteTripBtn.addEventListener('click', () => { closeSettingsModal(); toggleModal(DOM.deleteModal1, true); });
        DOM.cancelDelete1.addEventListener('click', () => toggleModal(DOM.deleteModal1, false));
        DOM.confirmDelete1.addEventListener('click', () => { toggleModal(DOM.deleteModal1, false); toggleModal(DOM.deleteModal2, true); });
        DOM.cancelDelete2.addEventListener('click', () => toggleModal(DOM.deleteModal2, false));
        DOM.confirmDelete2.addEventListener('click', deleteTrip);
        DOM.openEditDestBtn.addEventListener('click', () => { closeSettingsModal(); openEditDestinationsModal(); });
        DOM.editDestClose.addEventListener('click', closeEditDestinationsModal);
        DOM.editDestCancel.addEventListener('click', closeEditDestinationsModal);
        DOM.addDestBtn.addEventListener('click', () => addDestRow());
        DOM.saveDestinationsBtn.addEventListener('click', saveDestinationsChanges);
        DOM.detailsModalClose.addEventListener('click', closeDetailsModal);
       
        // Card Click Delegation
        document.getElementById('main-content').addEventListener('click', (e) => {
            const card = e.target.closest('.glass-card[data-id]');
            if (card) {
                const itemId = card.dataset.id;
                const item = allLogisticsItems.find(i => i.id === itemId);
                openDetailsModal(item);
            }
        });

        // Navigation Choice Click Delegation
        DOM.navModalContent.addEventListener('click', (e) => {
            if (e.target.classList.contains('hotel-choice-btn')) {
                const address = e.target.dataset.address;
                const name = e.target.textContent;
                openNavModal({ title: `נווט אל ${name}`, options: [{ name, address }] });
            }
        });

        // Init
        initPage();
    </script>
</body>
</html>

