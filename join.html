<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול שיתופים</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">

    <!-- ספריות ליצירת קובץ וורד והורדתו -->
    <script src="https://unpkg.com/docx@8.5.0/build/index.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>

    <style>
        :root {
            --glass: rgba(255,255,255,0.1);
            --glass-border: rgba(255,255,255,0.2);
            --hero-bg: url('https://i.imgur.com/PXLTIi4.jpeg');
        }
        body { 
            font-family: 'Assistant', sans-serif;
            background-color: #0f172a;
        }
        /* רקע דינאמי */
        #bg-gradient {
            background:
                radial-gradient(1200px 800px at 85% -10%, rgba(59,130,246,0.25), transparent 60%),
                radial-gradient(1000px 700px at 0% 100%, rgba(168,85,247,0.25), transparent 60%),
                linear-gradient(180deg, #0f172a 0%, #111827 65%, #0b1020 100%);
        }
        #bg-image-layer {
            background-image: var(--hero-bg);
            background-size: cover;
            background-position: center;
            opacity: 0.08;
        }
        .glass {
            background: var(--glass);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
        }
        .tab-button.active {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            box-shadow: 0 4px 14px rgba(59, 130, 246, 0.25);
        }
        .tab-button:not(.active) {
            background-color: transparent;
            color: #d1d5db; /* Gray 300 */
        }
        .trip-card-image {
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="text-slate-100 selection:bg-blue-600/40">

    <div id="bg-gradient" class="fixed inset-0 -z-20"></div>
    <div id="bg-image-layer" class="fixed inset-0 -z-10"></div>

    <div id="loading-overlay" class="fixed inset-0 bg-[#0b1020]/80 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4 transition-opacity duration-300">
        <i class="fas fa-plane-departure text-6xl text-blue-400 animate-pulse"></i>
        <p class="text-2xl font-bold text-slate-200">טוען את הטיולים שלך...</p>
    </div>
    
    <div id="logout-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-[101] p-4">
        <div class="glass rounded-2xl p-8 w-full max-w-sm text-center shadow-2xl">
            <h2 class="text-2xl font-bold mb-4 text-white">התנתקות</h2>
            <p class="text-slate-300 mb-8">האם להתנתק מהחשבון?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-logout-btn" class="glass px-6 py-2 rounded-lg hover:bg-white/10 font-semibold transition-colors">ביטול</button>
                <button id="confirm-logout-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-6 rounded-lg transition-colors">התנתק</button>
            </div>
        </div>
    </div>

    <div id="share-modal" class="hidden fixed inset-0 bg-black/70 backdrop-blur-sm z-[100] flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-6 w-full max-w-md shadow-2xl flex flex-col max-h-[90vh]">
            <div class="flex justify-between items-start mb-4 shrink-0">
                <div class="pr-4">
                    <h3 id="share-modal-title" class="text-xl font-bold text-white">שתף את הטיול</h3>
                    <p class="text-sm text-slate-300">ייצא את הטיול כקובץ Word או שלח קישור הצטרפות.</p>
                </div>
                <button id="share-modal-close" class="p-2 text-slate-400 hover:text-red-400 rounded-full hover:bg-white/10 transition-colors"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="space-y-4 shrink-0">
                <div class="grid grid-cols-2 gap-3">
                    <button id="generate-word-doc-btn" class="w-full bg-sky-600 hover:bg-sky-700 text-white font-bold py-3 px-4 rounded-lg transition text-base flex items-center justify-center gap-2">
                        <i class="fas fa-file-word"></i>
                        <span id="generate-word-text">צור קובץ Docx</span>
                    </button>
                    <button id="create-share-link-btn" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition text-base flex items-center justify-center gap-2">
                        <i class="fas fa-link"></i>
                        <span id="create-link-text">צור קישור שיתוף</span>
                    </button>
                </div>
                <div id="share-link-container" class="hidden">
                    <label class="font-semibold text-sm text-slate-200">הקישור מוכן! העתק ושתף:</label>
                    <div class="mt-1 flex gap-2">
                        <input type="text" id="share-link-input" readonly class="w-full p-2 border border-white/20 rounded-lg bg-white/10 text-sm focus:ring-2 focus:ring-blue-500 text-slate-100" dir="ltr">
                        <button id="copy-link-btn" class="bg-slate-200 hover:bg-slate-300 text-slate-800 font-semibold px-4 rounded-lg transition-colors">העתק</button>
                    </div>
                </div>
            </div>

            <hr class="my-6 border-white/20 shrink-0">

            <div class="flex-grow overflow-y-auto">
                <h4 class="font-bold text-white mb-3">משתתפים בטיול:</h4>
                <div id="shared-with-list" class="space-y-2 pr-2">
                    </div>
            </div>
        </div>
    </div>

    <div>
        <header class="glass sticky top-0 z-30">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-20">
                    <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-5 rounded-lg shadow-sm hover:shadow-md transition-all flex items-center gap-2">
                        <i class="fas fa-arrow-left"></i>
                        <span>חזרה</span>
                    </a>
                    
                    <div id="auth-container">
                        </div>
                </div>
            </div>
        </header>

        <main class="pb-16">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
                <div class="text-center mb-10">
                    <h1 class="text-4xl md:text-5xl font-extrabold text-white mb-2">ניהול שיתופים</h1>
                    <p class="text-lg text-slate-300">נהל את הטיולים שלך ואת אלה שחברים שיתפו איתך.</p>
                </div>
                
                <div class="flex bg-black/20 p-1.5 rounded-full mb-10 max-w-sm mx-auto shadow-inner border border-white/10">
                    <button id="my-trips-tab" class="tab-button w-1/2 p-2.5 rounded-full font-bold transition-all duration-300 active">הטיולים שלי</button>
                    <button id="shared-trips-tab" class="tab-button w-1/2 p-2.5 rounded-full font-bold transition-all duration-300">שותף איתי</button>
                </div>
                
                <div id="trips-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    </div>
                <div id="trips-placeholder" class="text-center text-slate-400 mt-12 hidden">
                    <i class="fas fa-map-signs text-6xl text-slate-500 mb-4"></i>
                    <p class="text-xl font-semibold">לא נמצאו טיולים בקטגוריה זו</p>
                    <p>אפשר ליצור טיול חדש מדף הבית.</p>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, onSnapshot, updateDoc, arrayUnion, addDoc, getDocs, writeBatch, serverTimestamp, collectionGroup } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM & State ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            authContainer: document.getElementById('auth-container'),
            logoutModal: document.getElementById('logout-modal'),
            confirmLogoutBtn: document.getElementById('confirm-logout-btn'),
            cancelLogoutBtn: document.getElementById('cancel-logout-btn'),
            myTripsTab: document.getElementById('my-trips-tab'),
            sharedTripsTab: document.getElementById('shared-trips-tab'),
            tripsContainer: document.getElementById('trips-container'),
            tripsPlaceholder: document.getElementById('trips-placeholder'),
            shareModal: document.getElementById('share-modal'),
            shareModalClose: document.getElementById('share-modal-close'),
            shareModalTitle: document.getElementById('share-modal-title'),
            createShareLinkBtn: document.getElementById('create-share-link-btn'),
            createLinkText: document.getElementById('create-link-text'),
            shareLinkContainer: document.getElementById('share-link-container'),
            shareLinkInput: document.getElementById('share-link-input'),
            copyLinkBtn: document.getElementById('copy-link-btn'),
            sharedWithList: document.getElementById('shared-with-list'),
            generateWordDocBtn: document.getElementById('generate-word-doc-btn'),
            generateWordText: document.getElementById('generate-word-text'),
        };
        const TRIP_IMG_PLACEHOLDER = 'https://i.imgur.com/K73z2Zg.png';

        let currentUser = null;
        let allUserTrips = []; 
        let currentView = 'my';
        let activeTripId = null;

        // --- Page Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                currentUser = user;
                setupAuthUI(user);
                await handleInviteToken();
                listenToTrips();
            } else {
                window.location.href = `login.html?redirect=${encodeURIComponent(window.location.href)}`;
            }
        });

        async function handleInviteToken() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');
            if (!token || !currentUser) return;

            DOM.loadingOverlay.classList.remove('hidden');
            const invitesRef = collection(db, "invites");
            const q = query(invitesRef, where("token", "==", token));
            const snapshot = await getDocs(q);

            if (snapshot.empty) {
                alert("קישור ההזמנה אינו חוקי או שכבר נעשה בו שימוש.");
                window.history.replaceState({}, document.title, window.location.pathname);
                DOM.loadingOverlay.style.opacity = '0';
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
                return;
            }

            const inviteDoc = snapshot.docs[0];
            const { tripId } = inviteDoc.data();
            const tripRef = doc(db, "trips", tripId);
            
            const tripSnap = await getDoc(tripRef);
            if(tripSnap.exists() && tripSnap.data().editors.includes(currentUser.uid)) {
                alert("אתה כבר חבר בטיול הזה.");
                window.history.replaceState({}, document.title, window.location.pathname);
                return;
            }

            const batch = writeBatch(db);
            batch.update(tripRef, { editors: arrayUnion(currentUser.uid) });
            batch.delete(inviteDoc.ref);

            try {
                await batch.commit();
                alert("הצטרפת בהצלחה לטיול! הוא יופיע ברשימת 'שותף איתי'.");
                window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                console.error("Error accepting invite:", error);
                alert("אירעה שגיאה בעת ההצטרפות לטיול.");
            }
        }
        
        function listenToTrips() {
            if (!currentUser) return;
            const q = query(collection(db, "trips"), where("editors", "array-contains", currentUser.uid));
            onSnapshot(q, (snapshot) => {
                allUserTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderTrips();
                DOM.loadingOverlay.style.opacity = '0';
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
            }, error => {
                console.error("Error fetching trips:", error);
                DOM.loadingOverlay.style.opacity = '0';
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
            });
        }
        
        function renderTrips() {
            const tripsToRender = allUserTrips.filter(trip => 
                currentView === 'my' ? trip.ownerId === currentUser.uid : trip.ownerId !== currentUser.uid
            );
            DOM.tripsContainer.innerHTML = '';
            DOM.tripsPlaceholder.classList.toggle('hidden', tripsToRender.length > 0);

            tripsToRender.forEach(trip => {
                const card = document.createElement('div');
                card.className = 'glass rounded-xl overflow-hidden flex flex-col transition-all duration-300 hover:shadow-2xl hover:scale-[1.03]';
                const participantCount = trip.editors?.length || 0;
                
                card.innerHTML = `
                    <div class="trip-card-image h-32 relative" style="background-image: url('${trip.coverImage || TRIP_IMG_PLACEHOLDER}')">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-transparent"></div>
                        <h3 class="absolute bottom-0 right-0 p-4 text-2xl font-bold text-white z-10 truncate w-full">${trip.name}</h3>
                    </div>
                    <div class="p-4 flex-grow flex flex-col">
                        <div class="flex-grow space-y-3 text-slate-300">
                             <div class="flex items-center gap-3">
                                <i class="fas fa-calendar-alt fa-fw text-blue-400"></i>
                                <span>${trip.startDate && trip.endDate ? `${trip.startDate} - ${trip.endDate}` : 'טרם נקבעו תאריכים'}</span>
                            </div>
                            <div class="flex items-center gap-3">
                                <i class="fas fa-users fa-fw text-purple-400"></i>
                                <span>${participantCount} משתתפים</span>
                            </div>
                        </div>
                        <div class="mt-5 pt-4 border-t border-white/20 flex justify-between items-center gap-2">
                            <a href="trip.html?id=${trip.id}" class="flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white font-bold py-2.5 px-3 rounded-lg transition-colors">
                                פתח טיול
                            </a>
                            ${currentView === 'my' ? `<button data-trip-id="${trip.id}" data-trip-name="${trip.name}" class="share-btn text-center bg-white/10 hover:bg-white/20 text-white font-semibold py-2.5 px-4 rounded-lg transition-colors" title="שתף טיול"><i class="fas fa-share-alt"></i></button>` : ''}
                        </div>
                    </div>
                `;
                DOM.tripsContainer.appendChild(card);
            });
        }
        
        // --- UI Logic & Event Listeners ---
        function setupAuthUI(user) {
            getDoc(doc(db, "users", user.uid)).then(docSnap => {
                const name = docSnap.exists() ? (docSnap.data().name || 'משתמש') : 'משתמש';
                DOM.authContainer.innerHTML = `
                    <button id="user-name-btn" class="flex items-center gap-3 text-slate-200 font-bold hover:text-white transition-colors">
                        <div class="w-10 h-10 rounded-full bg-white/20 flex items-center justify-center text-white font-extrabold">
                           ${name.charAt(0).toUpperCase()}
                        </div>
                        <span class="hidden md:inline">${name}</span>
                    </button>`;
                document.getElementById('user-name-btn').addEventListener('click', () => {
                    DOM.logoutModal.classList.remove('hidden');
                });
            });
        }

        DOM.myTripsTab.addEventListener('click', () => {
            currentView = 'my';
            DOM.myTripsTab.classList.add('active');
            DOM.sharedTripsTab.classList.remove('active');
            renderTrips();
        });

        DOM.sharedTripsTab.addEventListener('click', () => {
            currentView = 'shared';
            DOM.sharedTripsTab.classList.add('active');
            DOM.myTripsTab.classList.remove('active');
            renderTrips();
        });

        DOM.tripsContainer.addEventListener('click', (e) => {
            const shareBtn = e.target.closest('.share-btn');
            if (shareBtn) {
                openShareModal(shareBtn.dataset.tripId, shareBtn.dataset.tripName);
            }
        });

        DOM.cancelLogoutBtn.addEventListener('click', () => DOM.logoutModal.classList.add('hidden'));
        DOM.confirmLogoutBtn.addEventListener('click', () => signOut(auth));

        // --- Share Modal Logic ---
        function openShareModal(tripId, tripName) {
            activeTripId = tripId;
            DOM.shareModalTitle.textContent = `שתף את "${tripName}"`;
            DOM.shareModal.classList.remove('hidden');
            DOM.shareLinkContainer.classList.add('hidden');
            DOM.createShareLinkBtn.disabled = false;
            DOM.createShareLinkBtn.querySelector('i').className = 'fas fa-link';
            DOM.createLinkText.textContent = 'צור קישור שיתוף';
            DOM.generateWordDocBtn.disabled = false;
            DOM.generateWordDocBtn.querySelector('i').className = 'fas fa-file-word';
            DOM.generateWordText.textContent = 'צור קובץ Docx';
            loadSharedWithList(tripId);
        }

        DOM.shareModalClose.addEventListener('click', () => DOM.shareModal.classList.add('hidden'));

        DOM.createShareLinkBtn.addEventListener('click', async () => {
            if (!activeTripId) return;
            const btn = DOM.createShareLinkBtn;
            btn.disabled = true;
            btn.querySelector('i').className = 'fas fa-spinner fa-spin';
            DOM.createLinkText.textContent = 'יוצר קישור...';

            try {
                const token = `tok_${Date.now()}_${Math.random().toString(36).substring(2, 10)}`;
                await addDoc(collection(db, "invites"), {
                    tripId: activeTripId, token, createdAt: serverTimestamp()
                });
                const shareUrl = `${window.location.origin}${window.location.pathname.replace('join.html', '')}join.html?token=${token}`;
                DOM.shareLinkInput.value = shareUrl;
                DOM.shareLinkContainer.classList.remove('hidden');
            } catch (error) {
                console.error("Error creating share link", error);
                btn.disabled = false;
                btn.querySelector('i').className = 'fas fa-link';
                DOM.createLinkText.textContent = 'צור קישור שיתוף';
            }
        });

        DOM.copyLinkBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(DOM.shareLinkInput.value).then(() => {
                DOM.copyLinkBtn.textContent = 'הועתק!';
                setTimeout(() => { DOM.copyLinkBtn.textContent = 'העתק'; }, 2000);
            });
        });
        
        async function loadSharedWithList(tripId) {
            DOM.sharedWithList.innerHTML = `<p class="text-slate-400 text-center py-4">טוען רשימת משתתפים...</p>`;
            const tripDocSnap = await getDoc(doc(db, "trips", tripId));
            if (!tripDocSnap.exists()) return;

            const tripData = tripDocSnap.data();
            const editors = tripData.editors || [];
            if (editors.length === 0) {
                 DOM.sharedWithList.innerHTML = `<p class="text-slate-400 text-center py-4">הטיול לא משותף עדיין.</p>`;
                 return;
            }

            const userPromises = editors.map(uid => getDoc(doc(db, "users", uid)));
            const userDocs = await Promise.all(userPromises);

            DOM.sharedWithList.innerHTML = userDocs.map(userDoc => {
                if (!userDoc.exists()) return '';
                const userData = userDoc.data();
                const isOwner = userDoc.id === tripData.ownerId; 
                
                return `<div class="flex items-center justify-between bg-white/5 p-2.5 rounded-lg">
                            <div class="flex items-center gap-3">
                               <div class="size-8 rounded-full bg-white/20 flex items-center justify-center text-white font-bold text-sm">${(userData.name || 'U').charAt(0).toUpperCase()}</div>
                                <span class="font-semibold text-slate-100">${userData.name || 'משתמש'}</span>
                           </div>
                            <span class="text-xs font-bold py-1 px-2.5 rounded-full ${isOwner ? 'bg-amber-400/20 text-amber-300' : 'bg-slate-200/10 text-slate-300'}">${isOwner ? 'יוצר' : 'עורך'}</span>
                        </div>`;
            }).join('');
        }

        // --- Word Document Generation Logic ---
        DOM.generateWordDocBtn.addEventListener('click', async () => {
            if (!activeTripId) return;
            const trip = allUserTrips.find(t => t.id === activeTripId);
            if (!trip) return;

            const btn = DOM.generateWordDocBtn;
            btn.disabled = true;
            btn.querySelector('i').className = 'fas fa-spinner fa-spin';
            DOM.generateWordText.textContent = 'אוסף נתונים...';

            try {
                // 1. Fetch all related data
                const placesQuery = query(collection(db, 'trips', activeTripId, 'places'));
                const logisticsQuery = query(collection(db, 'trips', activeTripId, 'logistics'));
                const schedulesQuery = query(collection(db, 'trips', activeTripId, 'schedules'));

                const [placesSnap, logisticsSnap, schedulesSnap] = await Promise.all([
                    getDocs(placesQuery),
                    getDocs(logisticsQuery),
                    getDocs(schedulesQuery)
                ]);

                const places = placesSnap.docs.map(d => d.data());
                const logistics = logisticsSnap.docs.map(d => d.data());
                
                let schedules = [];
                for (const scheduleDoc of schedulesSnap.docs) {
                    const itemsQuery = query(collection(scheduleDoc.ref, 'items'));
                    const itemsSnap = await getDocs(itemsQuery);
                    schedules.push({
                        date: scheduleDoc.id, // YYYY-MM-DD format
                        ...scheduleDoc.data(),
                        items: itemsSnap.docs.map(d => d.data()).sort((a,b) => (a.sort || 0) - (b.sort || 0))
                    });
                }
                schedules.sort((a,b) => a.date.localeCompare(b.date));

                // 2. Build and download the Word document
                DOM.generateWordText.textContent = 'יוצר את הקובץ...';
                await createAndDownloadDoc(trip, places, logistics, schedules);

            } catch (error) {
                console.error("Error during the data fetching phase for Word doc:", error);
                alert("אירעה שגיאה באיסוף הנתונים ליצירת הקובץ.");
            } finally {
                btn.disabled = false;
                btn.querySelector('i').className = 'fas fa-file-word';
                DOM.generateWordText.textContent = 'צור קובץ Docx';
            }
        });

        // --- REBUILT & ROBUST Word Document Generation ---
        async function createAndDownloadDoc(trip, places, logistics, schedules) {
            console.log("Starting Word doc creation with data:", { trip, places, logistics, schedules });
            const { Document, Packer, HeadingLevel, Paragraph, TextRun, AlignmentType, SectionType } = window.docx;

            // Robust sanitizer function to prevent errors from invalid data types
            const sanitize = (value) => {
                if (value === null || typeof value === 'undefined') {
                    return '';
                }
                if (typeof value === 'object') {
                    // Avoid printing [Object object]
                    return JSON.stringify(value, null, 2);
                }
                return String(value);
            };

            try {
                const docSections = [];

                // --- Title Section ---
                console.log("Creating Title section...");
                docSections.push(new Paragraph({
                    children: [new TextRun({ text: `סיכום תכנון טיול: ${sanitize(trip.name)}`, bold: true, size: 44 })],
                    alignment: AlignmentType.CENTER,
                    rightToLeft: true,
                    spacing: { after: 400 },
                }));

                // --- Schedules Section ---
                console.log("Creating Schedules section...");
                if (schedules && schedules.length > 0) {
                    docSections.push(new Paragraph({ children: [new TextRun("לוחות זמנים יומיים")], heading: HeadingLevel.HEADING_1, rightToLeft: true, spacing: { before: 400 } }));
                    schedules.forEach(day => {
                        const [y, m, d] = sanitize(day.date).split('-');
                        const date = new Date(y, m - 1, d);
                        const formattedDate = !isNaN(date) ? date.toLocaleDateString('he-IL', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }) : sanitize(day.date);
                        docSections.push(new Paragraph({ children: [new TextRun(formattedDate)], heading: HeadingLevel.HEADING_2, rightToLeft: true, spacing: { before: 300 } }));

                        if (day.items && day.items.length > 0) {
                            day.items.forEach(item => {
                                const time = `${sanitize(item.startTime)}${item.endTime ? ` - ${sanitize(item.endTime)}` : ''}`;
                                docSections.push(new Paragraph({
                                    children: [
                                        new TextRun({ text: `${time ? time + ': ' : ''}`, bold: true }),
                                        new TextRun(sanitize(item.title) || 'פריט ללא כותרת')
                                    ],
                                    rightToLeft: true,
                                }));
                                if (item.summary) {
                                    docSections.push(new Paragraph({ children: [new TextRun(sanitize(item.summary))], indentation: { start: 720 }, rightToLeft: true }));
                                }
                            });
                        } else {
                            docSections.push(new Paragraph({ children: [new TextRun("אין פריטים בלוז ליום זה.")], rightToLeft: true }));
                        }
                    });
                } else {
                    console.log("No schedules to add.");
                }

                // --- Places Section ---
                console.log("Creating Places section...");
                if (places && places.length > 0) {
                    docSections.push(new Paragraph({ children: [new TextRun("אטרקציות ומסעדות")], heading: HeadingLevel.HEADING_1, rightToLeft: true, spacing: { before: 400 } }));
                    const placesByDest = places.reduce((acc, p) => {
                        const dest = sanitize(p.destination) || 'כללי';
                        (acc[dest] = acc[dest] || []).push(p);
                        return acc;
                    }, {});

                    for (const dest in placesByDest) {
                        docSections.push(new Paragraph({ children: [new TextRun(dest)], heading: HeadingLevel.HEADING_2, rightToLeft: true, spacing: { before: 300 } }));
                        placesByDest[dest].forEach(p => {
                            docSections.push(new Paragraph({ children: [new TextRun(sanitize(p.name) || 'ללא שם')], heading: HeadingLevel.HEADING_3, rightToLeft: true }));
                            if (p.shortDescription) docSections.push(new Paragraph({ children: [new TextRun(sanitize(p.shortDescription))], rightToLeft: true }));
                            if (p.location) docSections.push(new Paragraph({ children: [new TextRun({ text: "כתובת: ", bold: true }), new TextRun(sanitize(p.location))], rightToLeft: true }));
                        });
                    }
                } else {
                    console.log("No places to add.");
                }

                // --- Logistics Section ---
                console.log("Creating Logistics section...");
                if (logistics && logistics.length > 0) {
                    docSections.push(new Paragraph({ children: [new TextRun("לוגיסטיקה")], heading: HeadingLevel.HEADING_1, rightToLeft: true, spacing: { before: 400 } }));
                    logistics.forEach(l => {
                        docSections.push(new Paragraph({ children: [new TextRun(sanitize(l.name) || sanitize(l.type) || 'פריט לוגיסטי')], heading: HeadingLevel.HEADING_2, rightToLeft: true, spacing: { before: 300 } }));
                        if (l.dates) docSections.push(new Paragraph({ children: [new TextRun({ text: "תאריכים: ", bold: true }), new TextRun(sanitize(l.dates))], rightToLeft: true }));
                        if (l.address) docSections.push(new Paragraph({ children: [new TextRun({ text: "כתובת: ", bold: true }), new TextRun(sanitize(l.address))], rightToLeft: true }));
                        if (l.price) {
                            const priceValue = Number(l.price);
                            const priceText = !isNaN(priceValue) ? `$${priceValue.toLocaleString()}` : sanitize(l.price);
                            docSections.push(new Paragraph({ children: [new TextRun({ text: "מחיר: ", bold: true }), new TextRun(priceText)], rightToLeft: true }));
                        }
                        if (l.type === 'flight') {
                            const fromDest = l.from?.destination ?? 'לא צוין';
                            const toDest = l.to?.destination ?? 'לא צוין';
                            const flightNum = l.flight_number ? ` (${sanitize(l.flight_number)})` : '';
                            docSections.push(new Paragraph({ children: [new TextRun({ text: "טיסה: ", bold: true }), new TextRun(`${sanitize(fromDest)} -> ${sanitize(toDest)}${flightNum}`)], rightToLeft: true }));
                        }
                    });
                } else {
                    console.log("No logistics to add.");
                }

                console.log("All sections created. Assembling document.");
                const doc = new Document({
                    features: { MIGRATION_2023_11: true },
                    sections: [{
                        properties: { type: SectionType.NEXT_PAGE, rightToLeft: true },
                        children: docSections
                    }]
                });

                console.log("Packing document to blob...");
                const blob = await Packer.toBlob(doc);

                console.log("Blob created successfully. Triggering download.");
                saveAs(blob, `${sanitize(trip.name) || 'Trip'} - סיכום טיול.docx`);
                console.log("Download triggered.");

            } catch (error) {
                console.error("CRITICAL ERROR during Word document generation:", error);
                alert("אירעה שגיאה קריטית בזמן יצירת המסמך. אנא בדוק את המסוף (F12) לפרטים נוספים.");
            }
        }

    </script>
</body>
</html>
