<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הצטרפות לטיול</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9;
        }
        .status-card {
            display: none; /* All cards are hidden by default */
        }
        .status-card.active {
            display: flex; /* Only the active card is shown */
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-md bg-white rounded-2xl shadow-xl p-8 text-center">
        
        <div id="loading-card" class="status-card active flex-col items-center gap-4">
            <i class="fas fa-spinner text-5xl text-blue-600 animate-spin"></i>
            <h2 class="text-2xl font-bold text-slate-700">בודקים את ההזמנה שלך...</h2>
            <p class="text-slate-500">רק רגע, אנחנו מאמתים את הקישור.</p>
        </div>

        <div id="login-required-card" class="status-card flex-col items-center gap-4">
            <i class="fas fa-sign-in-alt text-5xl text-slate-500"></i>
            <h2 class="text-2xl font-bold text-slate-700">נדרשת התחברות</h2>
            <p class="text-slate-600 mb-4">כדי להצטרף לטיול, עליך להתחבר לחשבון שלך או ליצור חשבון חדש.</p>
            <div class="w-full flex flex-col sm:flex-row gap-3">
                <a id="login-btn" href="login.html" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg">התחברות</a>
                <a id="signup-btn" href="signup.html" class="w-full bg-slate-600 hover:bg-slate-700 text-white font-bold py-3 px-4 rounded-lg transition text-lg">הרשמה</a>
            </div>
        </div>

        <div id="success-card" class="status-card flex-col items-center gap-4">
            <i class="fas fa-check-circle text-6xl text-green-500"></i>
            <h2 class="text-2xl font-bold text-slate-700">הצטרפת בהצלחה!</h2>
            <p id="success-message" class="text-slate-600">ברוך הבא לטיול. אתה מועבר כעת לרשימת הטיולים שלך...</p>
        </div>

        <div id="error-card" class="status-card flex-col items-center gap-4">
            <i class="fas fa-exclamation-triangle text-6xl text-red-500"></i>
            <h2 class="text-2xl font-bold text-slate-700">אופס, משהו השתבש</h2>
            <p id="error-message" class="text-slate-600 mb-4">לא ניתן להצטרף לטיול. ייתכן שההזמנה אינה חוקית או שכבר נעשה בה שימוש.</p>
            <a href="index.html" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">חזרה לדף הבית</a>
        </div>

    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, writeBatch, arrayUnion } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingCard: document.getElementById('loading-card'),
            loginRequiredCard: document.getElementById('login-required-card'),
            successCard: document.getElementById('success-card'),
            errorCard: document.getElementById('error-card'),
            successMessage: document.getElementById('success-message'),
            errorMessage: document.getElementById('error-message'),
            loginBtn: document.getElementById('login-btn'),
            signupBtn: document.getElementById('signup-btn'),
        };

        // --- Helper to switch between cards ---
        function showCard(cardName) {
            Object.values(DOM).forEach(el => {
                if (el.classList && el.classList.contains('status-card')) {
                    el.classList.remove('active');
                }
            });
            DOM[cardName].classList.add('active');
        }
        
        // --- Main Logic ---
        async function handleInvite() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('token');

            if (!token) {
                DOM.errorMessage.textContent = "הקישור חסר אסימון הזמנה (token). ודא שהעתקת את הקישור המלא.";
                showCard('errorCard');
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    // User is logged in, process the invitation
                    processInvite(token, user);
                } else {
                    // User is not logged in, show login prompt
                    const redirectUrl = encodeURIComponent(window.location.href);
                    DOM.loginBtn.href = `login.html?redirect=${redirectUrl}`;
                    DOM.signupBtn.href = `signup.html?redirect=${redirectUrl}`;
                    showCard('loginRequiredCard');
                }
            });
        }

        async function processInvite(token, user) {
            const invitesRef = collection(db, "invites");
            const q = query(invitesRef, where("token", "==", token));
            
            try {
                const snapshot = await getDocs(q);

                if (snapshot.empty) {
                    throw new Error("ההזמנה אינה חוקית או שכבר נעשה בה שימוש.");
                }

                const batch = writeBatch(db);
                const inviteDoc = snapshot.docs[0];
                const { tripId, permission } = inviteDoc.data();
                
                // Get trip name for a friendlier success message
                const tripRef = doc(db, "trips", tripId);
                const tripDoc = await getDoc(tripRef);
                const tripName = tripDoc.exists() ? tripDoc.data().name : "הטיול";

                if (permission === 'editor') {
                    batch.update(tripRef, {
                        editors: arrayUnion(user.uid)
                    });
                }
                
                // Delete the token so it can't be reused
                batch.delete(inviteDoc.ref); 
                
                await batch.commit();

                // Show success and redirect
                DOM.successMessage.textContent = `נהדר! צורפת בהצלחה לטיול "${tripName}".`;
                showCard('successCard');
                setTimeout(() => {
                    window.location.href = 'index.html'; // Redirect to the main trips page
                }, 3000); // 3-second delay

            } catch (error) {
                console.error("Error accepting invite:", error);
                DOM.errorMessage.textContent = error.message || "אירעה שגיאה בעת ההצטרפות לטיול.";
                showCard('errorCard');
            }
        }

        // --- Start the process on page load ---
        handleInvite();

    </script>
</body>
</html>
