<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול ושיתוף טיולים</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons + Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        html { scrollbar-gutter: stable; }
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
        }
        .trip-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .trip-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-spinner fa-spin text-5xl text-blue-600"></i>
        <p class="text-xl font-bold text-slate-700">טוען נתונים...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="min-h-screen">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="index.html" class="text-slate-700 font-bold hover:text-blue-600"><i class="fas fa-home"></i> דף הבית</a>
                    <div id="auth-container" class="flex items-center gap-2 sm:gap-4">
                        <!-- User info will be injected here -->
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Left Column: Actions -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white p-6 rounded-2xl shadow-lg">
                        <h2 class="text-xl font-bold text-slate-800 mb-3">הצטרפות לטיול</h2>
                        <p class="text-slate-600 text-sm mb-4">הזן קוד שקיבלת כדי להצטרף לטיול קיים.</p>
                        <div class="flex gap-2">
                             <input type="text" id="redeem-code-input" class="w-full p-2 border rounded-md text-center tracking-widest font-mono uppercase" placeholder="ABC-123">
                             <button id="redeem-code-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">הצטרף</button>
                        </div>
                        <div id="redeem-feedback" class="text-center mt-2 font-semibold h-5 text-sm"></div>
                    </div>
                </div>

                <!-- Right Column: Trip Lists -->
                <div class="lg:col-span-2 space-y-8">
                    <!-- My Trips -->
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-800 mb-4">הטיולים שלי</h2>
                        <div id="my-trips-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                        <div id="my-trips-placeholder" class="hidden text-center py-10 bg-white rounded-2xl shadow-md">
                            <p class="text-slate-500">עדיין לא יצרת טיולים. <a href="index.html" class="text-blue-600 font-bold">צור טיול חדש</a></p>
                        </div>
                    </div>
                     <!-- Shared With Me -->
                    <div>
                        <h2 class="text-2xl font-extrabold text-slate-800 mb-4">טיולים ששותפו איתי</h2>
                        <div id="shared-trips-container" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
                        <div id="shared-trips-placeholder" class="hidden text-center py-10 bg-white rounded-2xl shadow-md">
                            <p class="text-slate-500">עדיין לא שותפו איתך טיולים.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- My Trip Share Modal -->
    <div id="share-modal" class="modal hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">שיתוף: <span id="share-modal-trip-name"></span></h3>
                    <button class="close-modal-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
            </header>
            <main class="p-6 overflow-y-auto no-scrollbar space-y-6">
                <section>
                    <h4 class="font-bold text-slate-700 mb-2">יצירת קוד שיתוף חד-פעמי</h4>
                    <p class="text-sm text-slate-500 mb-3">הקוד יהיה תקף לשעתיים. לאחר שימוש אחד, הוא יימחק.</p>
                    <div class="flex gap-4">
                        <button data-permission="view" class="generate-code-btn flex-1 bg-sky-100 hover:bg-sky-200 text-sky-800 font-semibold py-2 px-4 rounded-lg"><i class="fas fa-eye mr-2"></i>קוד לצפייה בלבד</button>
                        <button data-permission="edit" class="generate-code-btn flex-1 bg-amber-100 hover:bg-amber-200 text-amber-800 font-semibold py-2 px-4 rounded-lg"><i class="fas fa-pencil-alt mr-2"></i>קוד לעריכה</button>
                    </div>
                    <div id="generated-code-container" class="hidden items-center gap-3 p-3 mt-4 bg-slate-100 rounded-lg">
                        <p class="flex-grow text-slate-700">הקוד: <strong id="generated-code-text" class="text-lg font-mono text-blue-600"></strong></p>
                        <button id="copy-code-btn" class="bg-slate-600 hover:bg-slate-700 text-white text-sm font-bold py-2 px-3 rounded-md"><i class="fas fa-copy"></i> העתק</button>
                    </div>
                </section>
                <hr/>
                <section>
                    <h4 class="font-bold text-slate-700 mb-3">משתמשים עם גישה</h4>
                    <div id="shared-with-list" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar"></div>
                </section>
            </main>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, updateDoc, deleteDoc, writeBatch, serverTimestamp, Timestamp, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            authContainer: document.getElementById('auth-container'),
            myTripsContainer: document.getElementById('my-trips-container'),
            sharedTripsContainer: document.getElementById('shared-trips-container'),
            myTripsPlaceholder: document.getElementById('my-trips-placeholder'),
            sharedTripsPlaceholder: document.getElementById('shared-trips-placeholder'),
            redeemCodeInput: document.getElementById('redeem-code-input'),
            redeemCodeBtn: document.getElementById('redeem-code-btn'),
            redeemFeedback: document.getElementById('redeem-feedback'),
            // Share Modal
            shareModal: document.getElementById('share-modal'),
            shareModalTripName: document.getElementById('share-modal-trip-name'),
            closeModalBtns: document.querySelectorAll('.close-modal-btn'),
            generateCodeBtns: document.querySelectorAll('.generate-code-btn'),
            generatedCodeContainer: document.getElementById('generated-code-container'),
            generatedCodeText: document.getElementById('generated-code-text'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            sharedWithList: document.getElementById('shared-with-list'),
        };

        // --- State & Unsubscribers ---
        let currentUser = null;
        let unsubscribers = [];

        // --- Utils ---
        const randomCode = (len = 8) => {
            const chars = "ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
            let s = "";
            for (let i = 0; i < len; i++) s += chars[Math.floor(Math.random() * chars.length)];
            return s;
        };

        // --- Initialization ---
        onAuthStateChanged(auth, user => {
            unsubscribers.forEach(unsub => unsub());
            unsubscribers = [];
            if (user) {
                currentUser = user;
                setupAuthUI(user);
                attachListeners(user.uid);
            } else {
                window.location.href = 'login.html';
            }
        });

        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? (docSnap.data().name || 'משתמש') : 'משתמש';
                DOM.authContainer.innerHTML = `<span class="text-slate-700 font-bold">שלום, ${name}</span>`;
            });
        }

        function attachListeners(uid) {
            // My Trips
            const myTripsQuery = query(collection(db, "trips"), where("ownerId", "==", uid));
            const unsubMyTrips = onSnapshot(myTripsQuery, snapshot => {
                const trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderMyTrips(trips);
                DOM.loadingOverlay.classList.add('hidden');
            });
            unsubscribers.push(unsubMyTrips);

            // Shared Trips
            const sharedTripsQuery = collection(db, "users", uid, "sharedTrips");
            const unsubSharedTrips = onSnapshot(sharedTripsQuery, async (snapshot) => {
                const sharedRefs = snapshot.docs.map(doc => doc.data());
                if (sharedRefs.length === 0) {
                    renderSharedTrips([]);
                    return;
                }
                const tripIds = sharedRefs.map(ref => ref.tripId);
                const tripsQuery = query(collection(db, "trips"), where("__name__", "in", tripIds));
                const tripsSnap = await getDocs(tripsQuery);
                const tripsData = tripsSnap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderSharedTrips(tripsData);
            });
            unsubscribers.push(unsubSharedTrips);
        }

        // --- Rendering ---
        function renderMyTrips(trips) {
            DOM.myTripsContainer.innerHTML = '';
            if (trips.length === 0) {
                DOM.myTripsPlaceholder.classList.remove('hidden');
            } else {
                DOM.myTripsPlaceholder.classList.add('hidden');
                trips.forEach(trip => {
                    const card = createTripCard(trip, true);
                    DOM.myTripsContainer.appendChild(card);
                });
            }
        }

        function renderSharedTrips(trips) {
            DOM.sharedTripsContainer.innerHTML = '';
             if (trips.length === 0) {
                DOM.sharedTripsPlaceholder.classList.remove('hidden');
            } else {
                DOM.sharedTripsPlaceholder.classList.add('hidden');
                trips.forEach(trip => {
                    const card = createTripCard(trip, false);
                    DOM.sharedTripsContainer.appendChild(card);
                });
            }
        }

        function createTripCard(trip, isOwner) {
            const card = document.createElement('div');
            card.className = 'trip-card bg-white rounded-xl shadow-md p-5 cursor-pointer flex flex-col justify-between';
            card.dataset.tripId = trip.id;
            
            const permission = trip.permissions?.[currentUser.uid] || (isOwner ? 'owner' : 'view');

            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold text-slate-800 truncate">${trip.name}</h3>
                    <p class="text-sm text-slate-500 mt-1">
                        ${isOwner ? 'בבעלותך' : `שותף על ידי בעל הטיול`}
                    </p>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center">
                    <span class="text-xs font-bold ${isOwner ? 'text-blue-600' : 'text-green-600'}">
                        ${isOwner ? 'נהל שיתוף' : `הרשאה: ${permission === 'edit' ? 'עריכה' : 'צפייה'}`}
                    </span>
                    <i class="fas fa-chevron-left text-slate-400"></i>
                </div>
            `;
            card.addEventListener('click', () => isOwner ? openShareModal(trip) : window.location.href = `trip.html?id=${trip.id}`);
            return card;
        }

        // --- Modal Logic ---
        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }
        DOM.closeModalBtns.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));

        // --- Sharing Logic ---
        async function openShareModal(trip) {
            DOM.shareModal.dataset.tripId = trip.id;
            DOM.shareModalTripName.textContent = trip.name;
            DOM.generatedCodeContainer.classList.add('hidden');
            
            await renderSharedWithList(trip);
            openModal(DOM.shareModal);
        }

        async function renderSharedWithList(trip) {
            DOM.sharedWithList.innerHTML = '<p class="text-slate-500">טוען...</p>';
            const permissions = trip.permissions || {};
            const userIds = Object.keys(permissions);

            if (userIds.length === 0) {
                DOM.sharedWithList.innerHTML = '<p class="text-slate-500">הטיול לא משותף עם אף אחד.</p>';
                return;
            }
            
            const usersQuery = query(collection(db, "users"), where("__name__", "in", userIds));
            const usersSnap = await getDocs(usersQuery);
            const usersData = {};
            usersSnap.forEach(doc => usersData[doc.id] = doc.data());

            const listHtml = userIds.map(uid => {
                const user = usersData[uid];
                if (!user) return '';
                const permission = permissions[uid];
                return `
                    <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                        <p class="font-bold text-slate-700">${user.name || 'משתמש לא ידוע'} (${user.email})</p>
                        <div class="flex items-center gap-4">
                            <span class="text-xs font-bold ${permission === 'edit' ? 'text-amber-600' : 'text-sky-600'}">${permission === 'edit' ? 'עורך' : 'צופה'}</span>
                            <button data-uid="${uid}" class="remove-user-btn text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                        </div>
                    </div>
                `;
            }).join('');
            DOM.sharedWithList.innerHTML = listHtml;
        }

        DOM.generateCodeBtns.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const role = e.currentTarget.dataset.permission;
                const tripId = DOM.shareModal.dataset.tripId;
                const code = randomCode(8);
                const expiresMs = Date.now() + (2 * 60 * 60 * 1000); // 2 hours
                const expiresAt = Timestamp.fromMillis(expiresMs);

                const codeRef = doc(db, "inviteCodes", code);
                await setDoc(codeRef, { tripId, role, expiresAt });

                DOM.generatedCodeText.textContent = code;
                DOM.generatedCodeContainer.classList.remove('hidden');
            });
        });

        DOM.copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(DOM.generatedCodeText.textContent).then(() => {
                DOM.copyCodeBtn.innerHTML = '<i class="fas fa-check"></i> הועתק';
                setTimeout(() => { DOM.copyCodeBtn.innerHTML = '<i class="fas fa-copy"></i> העתק'; }, 2000);
            });
        });
        
        DOM.sharedWithList.addEventListener('click', async (e) => {
            const removeBtn = e.target.closest('.remove-user-btn');
            if (!removeBtn) return;
            
            const uidToRemove = removeBtn.dataset.uid;
            const tripId = DOM.shareModal.dataset.tripId;

            if (confirm('להסיר את הגישה של משתמש זה?')) {
                const batch = writeBatch(db);
                const tripRef = doc(db, "trips", tripId);
                const sharedTripRef = doc(db, "users", uidToRemove, "sharedTrips", tripId);

                // This uses dot notation for nested map fields which requires a string literal.
                const permissionField = `permissions.${uidToRemove}`;
                batch.update(tripRef, { [permissionField]: deleteDoc() }); // This is incorrect. Field should be deleted. Let's use correct syntax.
                
                // Correct way to remove a key from a map
                const tripDoc = await getDoc(tripRef);
                const currentPermissions = tripDoc.data().permissions || {};
                delete currentPermissions[uidToRemove];

                batch.update(tripRef, { permissions: currentPermissions });
                batch.delete(sharedTripRef);
                
                await batch.commit();
                // onSnapshot will refresh the list.
            }
        });

        // --- Redeeming Logic ---
        async function redeemCodeAndAttach(code) {
            if (!currentUser) throw new Error("יש להתחבר לפני מימוש קוד.");
            const uid = currentUser.uid;
            DOM.redeemFeedback.textContent = '';
            DOM.redeemCodeBtn.disabled = true;

            const codeRef = doc(db, "inviteCodes", code);
            const snap = await getDoc(codeRef);

            if (!snap.exists()) {
                throw new Error("קוד לא תקין או שפג תוקפו.");
            }

            const { tripId, role, expiresAt } = snap.data();
            if (expiresAt.toMillis() <= Date.now()) {
                await deleteDoc(codeRef); // Clean up expired code
                throw new Error("הקוד פג תוקף.");
            }
            
            const tripRef = doc(db, "trips", tripId);
            const tripSnap = await getDoc(tripRef);
            if(tripSnap.data().ownerId === uid) {
                 throw new Error("לא ניתן להצטרף לטיול של עצמך.");
            }

            // Update trip permissions using the _inviteCode for security rule validation
            const permissionField = `permissions.${uid}`;
            await updateDoc(tripRef, {
                [permissionField]: role,
                _inviteCode: code // Pass code for rules to validate
            });
            
            // Add to user's shared list and clean up
            const batch = writeBatch(db);
            const userSharedRef = doc(db, "users", uid, "sharedTrips", tripId);
            batch.set(userSharedRef, { tripId, role, addedAt: serverTimestamp() });
            batch.delete(codeRef); // "Burn" the code
            await batch.commit();

            return { tripId, role };
        }

        DOM.redeemCodeBtn.addEventListener('click', async () => {
            const code = DOM.redeemCodeInput.value.trim().toUpperCase();
            if (!code) return;
            try {
                await redeemCodeAndAttach(code);
                DOM.redeemFeedback.className = 'text-center mt-2 font-semibold h-5 text-sm text-green-600';
                DOM.redeemFeedback.textContent = 'הטיול נוסף בהצלחה!';
                DOM.redeemCodeInput.value = '';
            } catch (e) {
                DOM.redeemFeedback.className = 'text-center mt-2 font-semibold h-5 text-sm text-red-600';
                DOM.redeemFeedback.textContent = e.message;
            } finally {
                DOM.redeemCodeBtn.disabled = false;
                setTimeout(() => DOM.redeemFeedback.textContent = '', 3000);
            }
        });

    </script>
</body>
</html>
