<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ניהול ושיתוף טיולים</title>

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Icons + Font -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

    <style>
        html { scrollbar-gutter: stable; }
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc;
            -webkit-font-smoothing: antialiased;
        }
        .modal {
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.hidden {
            opacity: 0;
            visibility: hidden;
        }
        .modal-content {
            transition: transform 0.3s ease;
        }
        .modal.hidden .modal-content {
            transform: scale(0.95);
        }
        .tab-btn.active {
            background-color: #3b82f6;
            color: white;
        }
        .tab-btn {
            transition: all 0.2s ease-in-out;
        }
        .trip-card {
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
        }
        .trip-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px -5px rgba(0,0,0,0.1);
        }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-slate-100">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[200] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-spinner fa-spin text-5xl text-blue-600"></i>
        <p class="text-xl font-bold text-slate-700">טוען נתונים...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="min-h-screen">
        <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8">
                <div class="flex items-center justify-between h-16">
                    <a href="index.html" class="text-slate-700 font-bold hover:text-blue-600"><i class="fas fa-home"></i> דף הבית</a>
                    <div class="flex items-center gap-2 sm:gap-4">
                        <div id="auth-container"></div>
                        <button id="navigate-hotel-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="נווט למלון"><i class="fas fa-hotel fa-lg"></i></button>
                        <button id="settings-btn" class="p-2 text-slate-600 hover:text-blue-600" aria-label="הגדרות"><i class="fas fa-cog fa-lg"></i></button>
                        <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 focus:outline-none"><i class="fas fa-bars fa-lg"></i></button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8">
            <h1 class="text-3xl md:text-4xl font-extrabold text-slate-800 mb-6">ניהול ושיתוף</h1>

            <!-- TABS -->
            <div class="bg-slate-200 p-1 rounded-xl flex gap-1 mb-6 max-w-md mx-auto">
                <button data-tab="my-trips" class="tab-btn w-full py-2 px-4 rounded-lg font-bold">הלוזים שלי</button>
                <button data-tab="shared-trips" class="tab-btn w-full py-2 px-4 rounded-lg font-bold">לוזים ששותפו</button>
            </div>

            <!-- Action Button -->
            <div class="text-center mb-8">
                <button id="add-shared-trip-btn" class="bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg shadow-md hover:shadow-lg transition-all">
                    <i class="fas fa-plus mr-2"></i>הוסף לוז עם קוד שיתוף
                </button>
            </div>

            <!-- Trips Container -->
            <div id="trips-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Trip cards will be injected here -->
            </div>
            <div id="placeholder-message" class="hidden text-center py-12">
                <p class="text-slate-500 text-lg"></p>
            </div>
        </main>
    </div>

    <!-- Add Shared Trip Modal -->
    <div id="add-trip-modal" class="modal hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md">
            <div class="p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-slate-800">הוספת לוז ששותף</h3>
                    <button class="close-modal-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
                <p class="text-slate-600 mb-4">הכנס את קוד השיתוף שקיבלת כדי להוסיף את הטיול לרשימה שלך.</p>
                <input type="text" id="share-code-input" class="w-full p-3 border rounded-md text-center tracking-widest font-mono uppercase" placeholder="ABC-123">
                <div id="add-trip-feedback" class="text-center mt-3 font-semibold h-5"></div>
            </div>
            <div class="bg-slate-50 p-4 flex justify-end rounded-b-2xl">
                <button id="submit-share-code-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">הוסף</button>
            </div>
        </div>
    </div>

    <!-- My Trip Share Modal -->
    <div id="my-trip-share-modal" class="modal hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-2xl max-h-[90vh] flex flex-col">
            <header class="p-4 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">שיתוף הטיול: <span id="share-modal-trip-name"></span></h3>
                    <button class="close-modal-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
            </header>
            <main class="p-6 overflow-y-auto no-scrollbar space-y-6">
                <!-- Code Generation -->
                <section class="space-y-4">
                    <div>
                        <h4 class="font-bold text-slate-700 mb-2">יצירת קוד שיתוף חדש</h4>
                        <div class="flex gap-4">
                            <button data-permission="viewer" class="generate-code-btn flex-1 bg-sky-100 hover:bg-sky-200 text-sky-800 font-semibold py-2 px-4 rounded-lg">
                                <i class="fas fa-eye mr-2"></i>קוד לצפייה בלבד
                            </button>
                            <button data-permission="editor" class="generate-code-btn flex-1 bg-amber-100 hover:bg-amber-200 text-amber-800 font-semibold py-2 px-4 rounded-lg">
                                <i class="fas fa-pencil-alt mr-2"></i>קוד לעריכה
                            </button>
                        </div>
                    </div>
                    <div id="generated-code-container" class="hidden items-center gap-3 p-3 bg-slate-100 rounded-lg">
                        <p class="flex-grow text-slate-700">הקוד החדש: <strong id="generated-code-text" class="text-lg font-mono text-blue-600"></strong></p>
                        <button id="copy-code-btn" class="bg-slate-600 hover:bg-slate-700 text-white text-sm font-bold py-2 px-3 rounded-md"><i class="fas fa-copy"></i> העתק</button>
                    </div>
                </section>

                <hr/>

                <!-- Shared With List -->
                <section>
                    <h4 class="font-bold text-slate-700 mb-3">משתמשים עם גישה</h4>
                    <div id="shared-with-list" class="space-y-2 max-h-60 overflow-y-auto no-scrollbar">
                        <!-- User list will be injected here -->
                    </div>
                </section>
            </main>
        </div>
    </div>

    <!-- Shared With Me Info Modal -->
    <div id="shared-info-modal" class="modal hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center p-4">
        <div class="modal-content bg-white rounded-2xl shadow-xl w-full max-w-md">
             <header class="p-6 border-b">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold text-slate-800">פרטי שיתוף</h3>
                    <button class="close-modal-btn text-slate-400 hover:text-red-500"><i class="fas fa-times fa-lg"></i></button>
                </div>
            </header>
            <main class="p-6 text-center space-y-4">
                <p class="text-slate-600">הטיול <strong id="info-modal-trip-name"></strong> שותף איתך.</p>
                <div>
                    <p class="text-sm text-slate-500">רמת ההרשאה שלך:</p>
                    <p id="info-modal-permission" class="text-2xl font-bold text-blue-600"></p>
                </div>
            </main>
            <footer class="bg-slate-50 p-4 flex justify-between items-center rounded-b-2xl">
                <button id="leave-trip-btn" class="text-red-600 hover:text-red-800 font-bold py-2 px-4 rounded-lg">
                    <i class="fas fa-trash-alt mr-2"></i>הסר מהרשימה שלי
                </button>
                 <a id="open-trip-link" href="#" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">פתח טיול</a>
            </footer>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, onSnapshot, updateDoc, arrayUnion, arrayRemove, writeBatch, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            authContainer: document.getElementById('auth-container'),
            tripsContainer: document.getElementById('trips-container'),
            placeholderMessage: document.getElementById('placeholder-message'),
            tabButtons: document.querySelectorAll('.tab-btn'),
            addSharedTripBtn: document.getElementById('add-shared-trip-btn'),
            // Modals
            addTripModal: document.getElementById('add-trip-modal'),
            myTripShareModal: document.getElementById('my-trip-share-modal'),
            sharedInfoModal: document.getElementById('shared-info-modal'),
            closeModalBtns: document.querySelectorAll('.close-modal-btn'),
            // Add Trip Modal
            shareCodeInput: document.getElementById('share-code-input'),
            submitShareCodeBtn: document.getElementById('submit-share-code-btn'),
            addTripFeedback: document.getElementById('add-trip-feedback'),
            // My Trip Share Modal
            shareModalTripName: document.getElementById('share-modal-trip-name'),
            generateCodeBtns: document.querySelectorAll('.generate-code-btn'),
            generatedCodeContainer: document.getElementById('generated-code-container'),
            generatedCodeText: document.getElementById('generated-code-text'),
            copyCodeBtn: document.getElementById('copy-code-btn'),
            sharedWithList: document.getElementById('shared-with-list'),
            // Shared Info Modal
            infoModalTripName: document.getElementById('info-modal-trip-name'),
            infoModalPermission: document.getElementById('info-modal-permission'),
            leaveTripBtn: document.getElementById('leave-trip-btn'),
            openTripLink: document.getElementById('open-trip-link'),
        };

        // --- State ---
        let currentUser = null;
        let myTrips = [];
        let sharedTrips = [];
        let currentView = 'my-trips'; // 'my-trips' or 'shared-trips'
        let myTripsUnsubscribe = null;
        let sharedViewersUnsubscribe = null;
        let sharedEditorsUnsubscribe = null;

        // --- Initialization ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                setupAuthUI(user);
                attachListeners();
            } else {
                window.location.href = 'login.html';
            }
        });

        function setupAuthUI(user) {
            const userDocRef = doc(db, "users", user.uid);
            getDoc(userDocRef).then(docSnap => {
                const name = docSnap.exists() ? (docSnap.data().name || 'משתמש') : 'משתמש';
                DOM.authContainer.innerHTML = `<span class="text-slate-700 font-bold">שלום, ${name}</span>`;
            });
        }

        function attachListeners() {
            if (myTripsUnsubscribe) myTripsUnsubscribe();
            if (sharedViewersUnsubscribe) sharedViewersUnsubscribe();
            if (sharedEditorsUnsubscribe) sharedEditorsUnsubscribe();

            // Listener for trips I own
            const myTripsQuery = query(collection(db, "trips"), where("ownerId", "==", currentUser.uid));
            myTripsUnsubscribe = onSnapshot(myTripsQuery, snapshot => {
                myTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderContent();
                DOM.loadingOverlay.classList.add('hidden');
            });

            // Listeners for trips shared with me
            const viewersQuery = query(collection(db, "trips"), where("viewers", "array-contains", currentUser.uid));
            const editorsQuery = query(collection(db, "trips"), where("editors", "array-contains", currentUser.uid));

            sharedViewersUnsubscribe = onSnapshot(viewersQuery, snapshot => {
                const viewerTrips = snapshot.docs.map(doc => ({ id: doc.id, permission: 'viewer', ...doc.data() }));
                updateSharedTrips(viewerTrips, 'viewer');
            });
            sharedEditorsUnsubscribe = onSnapshot(editorsQuery, snapshot => {
                const editorTrips = snapshot.docs.map(doc => ({ id: doc.id, permission: 'editor', ...doc.data() }));
                updateSharedTrips(editorTrips, 'editor');
            });
        }
        
        function updateSharedTrips(newTrips, permissionType) {
            // Remove old trips of the same permission type and add new ones to avoid duplicates
            const otherPermissionType = permissionType === 'viewer' ? 'editor' : 'viewer';
            const existingOtherTrips = sharedTrips.filter(t => t.permission === otherPermissionType);
            sharedTrips = [...existingOtherTrips, ...newTrips];
            renderContent();
        }

        // --- Rendering ---
        function renderContent() {
            const data = currentView === 'my-trips' ? myTrips : sharedTrips;
            DOM.tripsContainer.innerHTML = '';

            if (data.length === 0) {
                DOM.placeholderMessage.classList.remove('hidden');
                DOM.tripsContainer.classList.add('hidden');
                DOM.placeholderMessage.querySelector('p').textContent = currentView === 'my-trips' 
                    ? 'עדיין לא יצרת טיולים. לחץ על "דף הבית" כדי להתחיל.' 
                    : 'עדיין לא שותפו איתך טיולים.';
            } else {
                DOM.placeholderMessage.classList.add('hidden');
                DOM.tripsContainer.classList.remove('hidden');
                data.forEach(trip => {
                    const card = createTripCard(trip);
                    DOM.tripsContainer.appendChild(card);
                });
            }
        }
        
        function createTripCard(trip) {
            const card = document.createElement('div');
            card.className = 'trip-card bg-white rounded-xl shadow-md p-5 cursor-pointer flex flex-col justify-between';
            card.dataset.tripId = trip.id;
            
            const ownerName = trip.ownerName || 'לא ידוע';
            const isMyTrip = trip.ownerId === currentUser.uid;

            card.innerHTML = `
                <div>
                    <h3 class="text-xl font-bold text-slate-800 truncate">${trip.name}</h3>
                    <p class="text-sm text-slate-500 mt-1">
                        ${isMyTrip ? `נוצר על ידך` : `שותף על ידי: <strong>${ownerName}</strong>`}
                    </p>
                </div>
                <div class="mt-4 pt-4 border-t border-slate-200 flex justify-between items-center">
                    <span class="text-xs font-bold ${isMyTrip ? 'text-blue-600' : 'text-green-600'}">
                        ${isMyTrip ? 'הטיול שלי' : `הרשאה: ${trip.permission === 'editor' ? 'עריכה' : 'צפייה'}`}
                    </span>
                    <i class="fas fa-chevron-left text-slate-400"></i>
                </div>
            `;
            card.addEventListener('click', () => handleCardClick(trip));
            return card;
        }
        
        // --- Event Handlers ---
        function handleCardClick(trip) {
             if (trip.ownerId === currentUser.uid) {
                openMyTripShareModal(trip);
            } else {
                openSharedInfoModal(trip);
            }
        }
        
        DOM.tabButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                DOM.tabButtons.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                currentView = btn.dataset.tab;
                renderContent();
            });
        });
        
        // Set initial active tab
        document.querySelector(`.tab-btn[data-tab="${currentView}"]`).classList.add('active');

        // --- Modal Logic ---
        function openModal(modal) { modal.classList.remove('hidden'); }
        function closeModal(modal) { modal.classList.add('hidden'); }
        
        DOM.addSharedTripBtn.addEventListener('click', () => openModal(DOM.addTripModal));
        DOM.closeModalBtns.forEach(btn => btn.addEventListener('click', (e) => closeModal(e.target.closest('.modal'))));

        // Add Shared Trip
        DOM.submitShareCodeBtn.addEventListener('click', async () => {
            const code = DOM.shareCodeInput.value.trim().toUpperCase();
            if (!code) return;

            DOM.addTripFeedback.textContent = '';
            const codeRef = doc(db, "shareCodes", code);
            const codeSnap = await getDoc(codeRef);

            if (!codeSnap.exists()) {
                DOM.addTripFeedback.textContent = 'קוד לא תקין.';
                DOM.addTripFeedback.className = 'text-center mt-3 font-semibold h-5 text-red-500';
                return;
            }

            const { tripId, permission, ownerId } = codeSnap.data();
            
            if (ownerId === currentUser.uid) {
                DOM.addTripFeedback.textContent = 'לא ניתן להוסיף טיול של עצמך.';
                DOM.addTripFeedback.className = 'text-center mt-3 font-semibold h-5 text-amber-600';
                return;
            }

            const tripRef = doc(db, "trips", tripId);
            const updateData = permission === 'editor' 
                ? { editors: arrayUnion(currentUser.uid) } 
                : { viewers: arrayUnion(currentUser.uid) };

            await updateDoc(tripRef, updateData);

            DOM.addTripFeedback.textContent = 'הטיול נוסף בהצלחה!';
            DOM.addTripFeedback.className = 'text-center mt-3 font-semibold h-5 text-green-600';
            setTimeout(() => {
                closeModal(DOM.addTripModal);
                DOM.shareCodeInput.value = '';
            }, 1500);
        });

        // My Trip Share Modal
        async function openMyTripShareModal(trip) {
            DOM.myTripShareModal.dataset.tripId = trip.id;
            DOM.shareModalTripName.textContent = trip.name;
            DOM.generatedCodeContainer.classList.add('hidden');
            
            // Populate shared users list
            const userIds = [...(trip.viewers || []), ...(trip.editors || [])];
            DOM.sharedWithList.innerHTML = '<p class="text-slate-500">טוען משתמשים...</p>';
            
            if (userIds.length === 0) {
                 DOM.sharedWithList.innerHTML = '<p class="text-slate-500">הטיול לא משותף עם אף אחד עדיין.</p>';
            } else {
                const userDocsQuery = query(collection(db, "users"), where("__name__", "in", userIds));
                const userDocsSnap = await getDocs(userDocsQuery);
                const usersData = {};
                userDocsSnap.forEach(doc => usersData[doc.id] = doc.data());

                const listHtml = userIds.map(uid => {
                    const user = usersData[uid];
                    if (!user) return '';
                    const permission = (trip.editors || []).includes(uid) ? 'editor' : 'viewer';
                    return `
                        <div class="flex items-center justify-between p-2 bg-slate-50 rounded-lg">
                            <div>
                                <p class="font-bold text-slate-700">${user.name || 'משתמש לא ידוע'}</p>
                                <p class="text-sm text-slate-500">${user.email}</p>
                            </div>
                            <div class="flex items-center gap-4">
                                <span class="text-xs font-bold ${permission === 'editor' ? 'text-amber-600' : 'text-sky-600'}">
                                    ${permission === 'editor' ? 'עורך' : 'צופה'}
                                </span>
                                <button data-uid="${uid}" data-permission="${permission}" class="remove-user-btn text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
                DOM.sharedWithList.innerHTML = listHtml;
            }
            openModal(DOM.myTripShareModal);
        }
        
        DOM.generateCodeBtns.forEach(btn => {
            btn.addEventListener('click', async (e) => {
                const permission = e.currentTarget.dataset.permission;
                const tripId = DOM.myTripShareModal.dataset.tripId;
                const code = `${Math.random().toString(36).substring(2, 6).toUpperCase()}`;
                
                const codeRef = doc(db, "shareCodes", code);
                await setDoc(codeRef, {
                    tripId: tripId,
                    permission: permission,
                    ownerId: currentUser.uid
                });

                DOM.generatedCodeText.textContent = code;
                DOM.generatedCodeContainer.classList.remove('hidden');
            });
        });

        DOM.copyCodeBtn.addEventListener('click', () => {
            navigator.clipboard.writeText(DOM.generatedCodeText.textContent)
                .then(() => {
                    DOM.copyCodeBtn.innerHTML = '<i class="fas fa-check"></i> הועתק!';
                    setTimeout(() => {
                        DOM.copyCodeBtn.innerHTML = '<i class="fas fa-copy"></i> העתק';
                    }, 2000);
                });
        });
        
        DOM.sharedWithList.addEventListener('click', async (e) => {
            const removeBtn = e.target.closest('.remove-user-btn');
            if (!removeBtn) return;
            
            const uidToRemove = removeBtn.dataset.uid;
            const permission = removeBtn.dataset.permission;
            const tripId = DOM.myTripShareModal.dataset.tripId;

            if (confirm('להסיר את הגישה של משתמש זה?')) {
                const tripRef = doc(db, "trips", tripId);
                const updateData = permission === 'editor'
                    ? { editors: arrayRemove(uidToRemove) }
                    : { viewers: arrayRemove(uidToRemove) };
                
                await updateDoc(tripRef, updateData);
                // The onSnapshot listener will automatically refresh the list
                closeModal(DOM.myTripShareModal);
            }
        });

        // Shared Info Modal
        function openSharedInfoModal(trip) {
            DOM.sharedInfoModal.dataset.tripId = trip.id;
            DOM.sharedInfoModal.dataset.permission = trip.permission;
            DOM.infoModalTripName.textContent = trip.name;
            DOM.openTripLink.href = `trip.html?id=${trip.id}`;
            
            if (trip.permission === 'editor') {
                DOM.infoModalPermission.textContent = 'עריכה';
                DOM.infoModalPermission.className = 'text-2xl font-bold text-amber-600';
            } else {
                DOM.infoModalPermission.textContent = 'צפייה בלבד';
                DOM.infoModalPermission.className = 'text-2xl font-bold text-sky-600';
            }
            openModal(DOM.sharedInfoModal);
        }
        
        DOM.leaveTripBtn.addEventListener('click', async () => {
            const tripId = DOM.sharedInfoModal.dataset.tripId;
            const permission = DOM.sharedInfoModal.dataset.permission;
            
            if (confirm('האם אתה בטוח שברצונך להסיר את הטיול מהרשימה שלך?')) {
                const tripRef = doc(db, "trips", tripId);
                const updateData = permission === 'editor'
                    ? { editors: arrayRemove(currentUser.uid) }
                    : { viewers: arrayRemove(currentUser.uid) };
                
                await updateDoc(tripRef, updateData);
                closeModal(DOM.sharedInfoModal);
                // onSnapshot will handle the UI update
            }
        });

    </script>
</body>
</html>
