<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>הצטרפות לטיול</title>

    <!-- Tailwind + Icons + Font -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet"/>

    <style>
        body {
            font-family: 'Assistant', sans-serif;
        }
        #bg-gradient {
            background:
                radial-gradient(1200px 800px at 85% -10%, rgba(59,130,246,0.35), transparent 60%),
                radial-gradient(1000px 700px at 0% 100%, rgba(168,85,247,0.35), transparent 60%),
                linear-gradient(180deg, #0f172a 0%, #111827 65%, #0b1020 100%);
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Background -->
    <div id="bg-gradient" class="fixed inset-0 -z-10"></div>

    <div class="flex items-center justify-center min-h-screen p-4">
        <div id="status-container" class="w-full max-w-md text-center bg-white/10 backdrop-blur-md border border-white/20 rounded-2xl p-8 shadow-2xl">
            <!-- Initial State -->
            <div id="loading-state">
                <i class="fas fa-spinner fa-spin text-5xl text-blue-400"></i>
                <h1 class="text-2xl font-bold mt-4">מאמת את ההזמנה...</h1>
                <p class="text-slate-300 mt-2">רק רגע, אנחנו בודקים את הקישור שלך.</p>
            </div>

            <!-- Error State -->
            <div id="error-state" class="hidden">
                <i class="fas fa-exclamation-triangle text-5xl text-red-400"></i>
                <h1 id="error-title" class="text-2xl font-bold mt-4">אירעה שגיאה</h1>
                <p id="error-message" class="text-slate-300 mt-2">ההזמנה אינה חוקית או שכבר נעשה בה שימוש.</p>
                <a href="index.html" class="inline-block mt-6 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg">חזור לדף הבית</a>
            </div>

            <!-- Login Required State -->
            <div id="login-state" class="hidden">
                <i class="fas fa-sign-in-alt text-5xl text-yellow-400"></i>
                <h1 class="text-2xl font-bold mt-4">נדרשת התחברות</h1>
                <p class="text-slate-300 mt-2">כדי להצטרף לטיול, עליך להתחבר או להירשם למערכת.</p>
                <a href="login.html" id="login-redirect-btn" class="inline-block mt-6 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-6 rounded-lg">התחברות / הרשמה</a>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc, serverTimestamp, runTransaction } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Init ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            loadingState: document.getElementById('loading-state'),
            errorState: document.getElementById('error-state'),
            loginState: document.getElementById('login-state'),
            errorTitle: document.getElementById('error-title'),
            errorMessage: document.getElementById('error-message'),
            loginRedirectBtn: document.getElementById('login-redirect-btn'),
        };

        function showState(state, title = '', message = '') {
            DOM.loadingState.classList.add('hidden');
            DOM.errorState.classList.add('hidden');
            DOM.loginState.classList.add('hidden');

            if (state === 'error') {
                DOM.errorTitle.textContent = title;
                DOM.errorMessage.textContent = message;
                DOM.errorState.classList.remove('hidden');
            } else if (state === 'login') {
                DOM.loginState.classList.remove('hidden');
            } else {
                DOM.loadingState.classList.remove('hidden');
            }
        }

        async function processJoinRequest(user) {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const tokenId = urlParams.get('token');

                if (!tokenId) {
                    return showState('error', 'קישור לא תקין', 'לא נמצא קוד הזמנה בקישור.');
                }

                // Use a transaction to ensure atomicity: read trip, update trip, and update token together.
                await runTransaction(db, async (transaction) => {
                    const tokenRef = doc(db, "shareTokens", tokenId);
                    const tokenSnap = await transaction.get(tokenRef);

                    if (!tokenSnap.exists() || tokenSnap.data().used) {
                        throw new Error('הקישור אינו חוקי או שכבר נעשה בו שימוש.');
                    }

                    const tokenData = tokenSnap.data();
                    const twoHoursInMillis = 2 * 60 * 60 * 1000;
                    const tokenAge = Date.now() - tokenData.createdAt.toMillis();

                    if (tokenAge > twoHoursInMillis) {
                        transaction.update(tokenRef, { used: true, reason: 'expired' });
                        throw new Error('ההזמנה פגה תוקף.');
                    }
                    
                    if (tokenData.createdBy === user.uid) {
                        // This isn't an error, just redirect the owner.
                        // We do it outside the transaction.
                        return { redirect: `trip.html?id=${tokenData.tripId}` };
                    }

                    const tripRef = doc(db, "trips", tokenData.tripId);
                    const tripSnap = await transaction.get(tripRef);

                    if (!tripSnap.exists()) {
                        throw new Error('הטיול המקורי שאליו הוזמנת נמחק.');
                    }

                    // --- FIX START: Construct the new members map explicitly ---
                    const currentMembers = tripSnap.data().members || {};
                    const newMembers = {
                        ...currentMembers,
                        [user.uid]: tokenData.permission // Add the new user
                    };
                    // --- FIX END ---

                    // Perform the writes
                    transaction.update(tripRef, { members: newMembers });
                    transaction.update(tokenRef, {
                        used: true,
                        usedBy: user.uid,
                        usedAt: serverTimestamp()
                    });

                    // Return the redirect URL on success
                    return { redirect: `trip.html?id=${tokenData.tripId}` };
                }).then(result => {
                    if (result && result.redirect) {
                        window.location.replace(result.redirect);
                    }
                }).catch(err => {
                    // Catch errors from inside the transaction
                    showState('error', 'שגיאה בתהליך ההצטרפות', err.message);
                });

            } catch (error) {
                // Catch setup errors before the transaction
                console.error("Error processing join request:", error);
                showState('error', 'שגיאה כללית', 'אירעה שגיאה לא צפויה.');
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                processJoinRequest(user);
            } else {
                const loginUrl = new URL(DOM.loginRedirectBtn.href, window.location.origin);
                loginUrl.searchParams.set('redirectUrl', window.location.href);
                DOM.loginRedirectBtn.href = loginUrl.toString();
                showState('login');
            }
        });
    </script>
</body>
</html>

