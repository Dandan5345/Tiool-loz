<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    /* ×”×’×“×¨×•×ª ×‘×¡×™×¡ ×•××™×¤×•×¡×™× ×œ××•×‘×™×™×œ */
    html, body { height: 100%; }
    html { 
      scrollbar-gutter: stable; 
      -webkit-tap-highlight-color: transparent; /* ×‘×™×˜×•×œ ×”×‘×”×•×‘ ××¤×•×¨ ×‘×œ×—×™×¦×” ×‘× ×™×™×“ */
    }
    body {
      font-family: 'Assistant', sans-serif;
      min-height: 100dvh;
      overscroll-behavior-y: none; /* ×× ×™×¢×ª "×§×¤×™×¦×”" ×‘×’×œ×™×œ×” ××¢×‘×¨ ×œ×’×‘×•×œ */
      background-color: #f8fafc;
      overflow-x: hidden;
      font-size: 16px; /* ×’×•×“×œ ×¤×•× ×˜ ×‘×¡×™×¡×™ ×§×¨×™× ×œ× ×™×™×“ */
    }

    /* ×¢×™×¦×•×‘ ×¤×¡ ×’×œ×™×œ×” ××•×“×¨× ×™ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

    /* ×¨×§×¢ ××•×“×¨× ×™ ×•×¢×“×™×Ÿ ×™×•×ª×¨ */
    .bg-fixed {
      background:
        radial-gradient(circle at 0% 0%, rgba(59,130,246,0.08) 0%, transparent 50%),
        radial-gradient(circle at 100% 100%, rgba(16,185,129,0.08) 0%, transparent 50%),
        #f8fafc;
      position: fixed; inset: 0; z-index: -10;
    }

    /* ×§×•× ×˜×™×™× ×¨×™× "×¦×¤×™×" (Sheets) */
    .sheet { 
      background: rgba(255,255,255,0.95); 
      backdrop-filter: blur(12px); 
      border: 1px solid rgba(255,255,255,0.6);
      box-shadow: 0 4px 20px -2px rgba(0,0,0,0.05);
      border-radius: 1.25rem; /* ×¤×™× ×•×ª ×¢×’×•×œ×•×ª ×™×•×ª×¨ */
    }

    /* ×©×™×¤×•×¨ ×©×“×•×ª ×§×œ×˜ ×œ××•×‘×™×™×œ */
    input, select, textarea {
      font-size: 16px !important; /* ×× ×™×¢×ª ×–×•× ××•×˜×•××˜×™ ×‘××™×™×¤×•×Ÿ */
      padding: 0.75rem 1rem !important;
      border-radius: 0.75rem !important;
      border: 1px solid #e2e8f0 !important;
      background-color: #fff;
      transition: all 0.2s ease;
      width: 100%;
    }
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: #3b82f6 !important;
      box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.15) !important;
    }

    /* ×›×¤×ª×•×¨×™× ×•×¤×¨×™×˜×™× ×œ×—×™×¦×™× */
    button { cursor: pointer; touch-action: manipulation; }

    /* ×ª×¤×¨×™×˜×™× × ×¤×ª×—×™× */
    .submenu { max-height: 0; overflow: hidden; transition: max-height 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
    .submenu.open { max-height: 500px; }
    
    /* ××•×“××œ×™× - ×”×ª×××” ×œ××¤×œ×™×§×¦×™×” */
    .modal { 
      display: none; 
      opacity: 0; 
      transition: opacity 0.2s ease-out;
      backdrop-filter: blur(4px);
    }
    .modal.show { display: flex; opacity: 1; }
    
   /* ×¢×™×¦×•×‘ ××•×“××œ×™× ×§×•××¤×§×˜×™ ×•×¦×£ */
   .modal {
      display: none;
      position: fixed;
      inset: 0; /* × ×¦××“ ×œ×›×œ ×”×§×¦×•×•×ª */
      z-index: 9999; /* ××•×•×“× ×©×–×” ××¢×œ ×”×›×œ */
      
      /* ××™×¨×›×•×– ×”××•×“×œ */
      align-items: center; 
      justify-content: center;
      
      /* ×¨×§×¢ ×›×”×” ×—×•×¡× */
      background-color: rgba(15, 23, 42, 0.6); 
      backdrop-filter: blur(4px);
      
      /* ×× ×™×¢×ª ×’×œ×™×œ×” ×‘×ª×•×š ×”×§×•× ×˜×™×™× ×¨ ×©×œ ×”××•×“×œ ×× ×”×•× ×§×˜×Ÿ */
      overflow: hidden; 
      padding: 1rem;
    }
    .modal.show { display: flex; opacity: 1; }
    
    .modal-content {
      /* ×”×’×“×¨×•×ª ×’×•×“×œ ×•××™×§×•× - ×“×•×¨×¡×•×ª ××ª ×”-HTML */
      width: 95% !important; 
      max-width: 500px !important; /* ××’×‘×™×œ ×¨×•×—×‘ ×’× ×‘××—×©×‘ */
      height: auto !important;
      max-height: 85vh !important; /* ××©××™×¨ ×¨×•×•×— ××œ××¢×œ×” ×•××œ××˜×” */
      
      /* ×¢×™×¦×•×‘ ×”×›×¨×˜×™×¡ */
      background: #ffffff;
      border-radius: 24px !important; /* ×¤×™× ×•×ª ×¢×’×•×œ×•×ª ×××•×“ */
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
      
      /* ×× ×™××¦×™×” */
      transform: scale(0.95);
      opacity: 0;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      
      /* ××‘× ×” ×¤× ×™××™ */
      display: flex;
      flex-direction: column;
      margin: auto;
    }

    .modal.show .modal-content {
      transform: scale(1);
      opacity: 1;
    }
    /* ×‘××•×‘×™×™×œ - ××•×“××œ×™× × ×¨××™× ×›××• Bottom Sheet */
    @media (max-width: 640px) {
      .modal { align-items: flex-end; padding: 0; }
      .modal-content {
        width: 100%;
        max-width: 100%;
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        max-height: 90vh;
        margin-bottom: 0;
      }
    }

    .step { display: none; animation: fadeIn 0.3s ease; }
    .step.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* ×”×©×œ××” ××•×˜×•××˜×™×ª */
    .typeahead {
      position: fixed; z-index: 99999; 
      background: #fff; border: 1px solid #e5e7eb;
      border-radius: 0.75rem; max-height: 260px; overflow: auto;
      box-shadow: 0 10px 40px rgba(0,0,0,0.12); display: none;
    }
    .typeahead.open { display: block; animation: slideDown 0.2s ease; }
    .typeahead button { 
      width: 100%; text-align: right; 
      padding: 0.85rem 1rem; /* ×©×˜×— ×œ×—×™×¦×” ×’×“×•×œ ×™×•×ª×¨ */
      border-bottom: 1px solid #f1f5f9;
      font-size: 0.95rem;
    }
    .typeahead button:active { background:#f8fafc; }

    /* ×›×¨×˜×™×¡×™×•×ª ×œ×•"×– */
    .card { 
        position: relative;
        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.2s ease; 
        border: 1px solid rgba(226, 232, 240, 0.8);
        border-right-width: 4px; /* ×œ×©××™×¨×ª ×”×¡×™××•×Ÿ ×”×¦×‘×¢×•× ×™ */
        box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        margin-bottom: 0.75rem;
    }
    .card:active { transform: scale(0.98); background-color: #fafafa; } /* ××¤×§×˜ ×œ×—×™×¦×” ×‘××•×‘×™×™×œ */
    .card:hover { 
        transform: translateY(-2px); 
        box-shadow: 0 10px 30px -5px rgba(0,0,0,0.08); 
    }
    .card.needs-verify { 
        border-right-color: #ef4444;
        background: #fff5f5;
    }
    
    /* ××œ×× ×˜×™× ×§×˜× ×™× */
    .chip {
      display: inline-flex; align-items: center; gap: 0.4rem;
      padding: 0.35rem 0.75rem; border-radius: 999px; 
      background: #e0e7ff; color: #3730a3; border: 1px solid transparent;
      font-size: 0.85rem; font-weight: 600;
      transition: background 0.2s;
    }
    .chip:active { background: #c7d2fe; }
    .chip .x { padding: 4px; margin: -4px; color: #6366f1; } /* ×”×’×“×œ×ª ×©×˜×— ×œ×—×™×¦×” ×œ-X */

    .badge-verify {
      display:inline-flex; align-items:center; gap:0.35rem;
      background:#fee2e2; color:#991b1b; border:1px solid #fecaca;
      font-size:0.75rem; padding:0.2rem 0.6rem; border-radius:6px; font-weight: 700;
    }
    .banner-warn {
      background:#fffbeb; color:#92400e; border:1px solid #fcd34d;
      padding: 1rem; border-radius: 0.75rem; font-size: 0.95rem;
      display: flex; align-items: start; gap: 0.5rem;
    }

    .input-with-btn { display:flex; gap:0.5rem; align-items: stretch; }
    .input-with-btn input { flex:1 1 auto; border-radius: 0.75rem; }
    .input-with-btn button { flex-shrink: 0; }
    
    .loader {
        width: 1.2rem; height: 1.2rem;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    @keyframes slideDown { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
    
    /* ×ª××™×›×” ×‘××¤×•×ª ×•×¨×›×™×‘×™ ×’×œ×™×œ×” ×‘×ª×•×š ××•×“××œ */
    .help-content h5 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-top: 1.2rem; margin-bottom: 0.5rem; }
    .help-content p { color: #475569; line-height: 1.6; margin-bottom: 0.5rem; }
    .scroll-smooth { -webkit-overflow-scrolling: touch; }
    
    /* ×›×¤×ª×•×¨ ×¤×ª×™×—×ª ×‘×œ×•×§×™× */
    .open-block {
      background: #fff;
      border: 1px solid #e2e8f0;
      padding: 0.5rem 0.8rem;
      border-radius: 999px;
      font-size: 0.9rem;
      transition: all 0.2s;
    }
    .open-block:active, .open-block:hover { border-color: #94a3b8; background: #f1f5f9; }
    
    /* Safelist - ××©××© ××ª ×”×¡×§×¨×™×¤×˜, ×œ× ×œ×’×¢×ª */
    ._safelist { color: transparent; background: transparent; height: 0; width: 0; overflow: hidden; position: absolute; }
  </style>
</head>
<body>

  <!-- Safelist ×‘×œ×ª×™ × ×¨××” -->
  <div class="hidden">
    <div class="bg-red-50 border-red-300 text-red-800"></div>
    <div class="bg-green-50 border-green-300 text-green-800"></div>
    <div class="bg-blue-50 border-blue-300 text-blue-800"></div>
    <div class="bg-yellow-50 border-yellow-300 text-yellow-800"></div>
    <div class="bg-orange-50 border-orange-300 text-orange-800"></div>
  </div>

  <!-- ×¨×§×¢ -->
  <div class="fixed inset-0 -z-10 bg-fixed"></div>

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a id="back-to-day" href="#" class="p-2 text-slate-700 hover:text-blue-600 transition-colors" title="×—×–×¨×” ×œ×œ×•×– ×”×™×•××™">
            <i class="fa-solid fa-arrow-right"></i>
          </a>
          <h1 class="text-xl font-bold text-slate-800">×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</h1>
        </div>
        <div class="flex items-center gap-2">
          <!-- Help Button -->
          <button id="help-btn" class="p-2 h-10 w-10 flex items-center justify-center text-slate-600 hover:text-blue-600 hover:bg-slate-100 rounded-full transition-colors" title="×¢×–×¨×”">
            <i class="fa-solid fa-question"></i>
          </button>
          <div id="auth-slot" class="text-slate-700 text-xs sm:text-sm"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <!-- ×‘×—×™×¨×ª ×ª××¨×™×š/×™×¢×“ + ×›×•×ª×¨×ª ×™×•× -->
    <section class="sheet rounded-2xl p-5 shadow-lg space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-2xl font-extrabold text-slate-900">×‘×—×¨ ×ª××¨×™×š ×œ×™×•× ×”×¢×‘×•×“×”</h2>
          <p class="text-slate-600">×‘×¨×™×¨×ª ×”××—×“×œ â€” ×”×ª××¨×™×š ×©××× ×• ×”×’×¢×ª.</p>
        </div>
        <div class="w-full md:w-[460px]">
          <button id="date-toggle" class="w-full flex items-center justify-between bg-white p-3 rounded-xl border shadow-sm hover:bg-slate-50 transition-colors">
            <span id="date-current" class="font-bold text-slate-700">×˜×•×¢×Ÿ...</span>
            <i class="fa-solid fa-chevron-down text-slate-500 transition-transform"></i>
          </button>
          <div id="date-panel" class="submenu bg-white rounded-xl border shadow-lg mt-2 overflow-hidden">
            <div id="date-list" class="max-h-80 overflow-y-auto divide-y"></div>
          </div>
        </div>
      </div>
      <div class="flex items-center flex-wrap gap-2 text-slate-800">
        <div id="badge-date" class="px-3 py-1 rounded-full bg-sky-100 text-sky-800 border border-sky-200 text-sm font-semibold">â€”</div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-500">×›×•×ª×¨×ª ×”×™×•×:</span>
          <strong id="day-title-inline" class="text-blue-700 font-semibold break-words">×œ× × ×§×‘×¢×”</strong>
          <button id="edit-day-title-inline" class="hidden text-slate-600 hover:text-blue-600" title="×¢×¨×™×›×ª ×›×•×ª×¨×ª"><i class="fa-solid fa-pen"></i></button>
        </div>
      </div>
    </section>

    <!-- ×¤×¨×™×˜×™× + ×›×¤×ª×•×¨×™× -->
    <section class="sheet rounded-2xl p-5 shadow-lg">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h3 class="text-xl font-bold text-slate-900">×¤×¨×™×˜×™ ×œ×•×´×– ×œ×™×•× ×–×”</h3>
        <div class="flex gap-2 flex-wrap">
          <button id="add-item-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors shadow-sm">
            <i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×œ×•×–
          </button>
          <button id="ai-build-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors shadow-sm">
            <i class="fa-solid fa-wand-magic-sparkles"></i> ×™×¦×™×¨×ª ×œ×•×– ×¢× AI
          </button>
          <button id="delete-all-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors shadow-sm">
            <i class="fa-solid fa-trash-can"></i> ××—×§ ×”×›×œ
          </button>
        </div>
      </div>

      <div id="items-list" class="mt-4 space-y-3">
        <div class="text-slate-500 p-6 text-center">××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>
      </div>

      <!-- ×”×“×’×©×™×/×˜×™×¤×™× -->
      <div class="mt-8 border-t pt-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-lg font-bold text-slate-800">×“×’×©×™× ×•×˜×™×¤×™× ×œ×™×•× ×–×”</h4>
          <button id="add-note-btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white font-semibold transition-colors shadow-sm">
            <i class="fa-solid fa-lightbulb"></i> ×”×•×¡×¤×ª ×“×’×©/×˜×™×¤
          </button>
        </div>
        <div id="notes-list" class="grid gap-3">
          <div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Help Modal -->
  <div id="help-modal" class="modal fixed inset-0 z-[90] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-600"></i> ××¨×›×– ×”×¢×–×¨×”</h4>
        <button id="help-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto flex-1 help-content scroll-smooth">
        <p class="mb-4">×‘×¨×•×š ×”×‘× ×œ×¢××•×“ ×™×¦×™×¨×ª ×•×¢×¨×™×›×ª ×”×œ×•"×–. ×›××Ÿ ×ª×•×›×œ ×œ×‘× ×•×ª ××ª ×¡×“×¨ ×”×™×•× ×©×œ×š ×‘×¦×•×¨×” ×™×“× ×™×ª ××• ×‘×¢×–×¨×ª AI.</p>
        <!-- Content trimmed for brevity -->
        <h5><i class="fa-solid fa-calendar-day icon"></i> ×‘×—×™×¨×ª ×ª××¨×™×š ×•×›×•×ª×¨×ª</h5>
        <p>×‘×—×œ×§ ×”×¢×œ×™×•×Ÿ ×©×œ ×”×“×£ ×ª×•×›×œ ×œ×‘×—×•×¨ ××ª ×”×ª××¨×™×š ×©×¢×‘×•×¨×• ×ª×¨×¦×” ×œ×¢×¨×•×š ××ª ×”×œ×•"×–. ×œ××—×¨ ×‘×—×™×¨×ª ×ª××¨×™×š, ×ª×•×›×œ ×œ×”×’×“×™×¨ ×œ×• "×›×•×ª×¨×ª ×™×•×".</p>
      </main>
    </div>
  </div>

  <!-- Generic Confirmation Modal -->
  <div id="confirm-modal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-black/70">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl">
      <div class="p-5 text-center">
        <div id="confirm-icon" class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
        </div>
        <h4 id="confirm-title" class="text-lg font-bold text-slate-800">××™×©×•×¨ ×¤×¢×•×œ×”</h4>
        <p id="confirm-message" class="text-slate-600 mt-2">×”×× ××ª×” ×‘×˜×•×—?</p>
      </div>
      <div class="p-4 bg-slate-50 flex justify-center gap-3 rounded-b-2xl">
        <button id="confirm-cancel" class="px-6 py-2 rounded-lg hover:bg-slate-200 font-semibold">×‘×™×˜×•×œ</button>
        <button id="confirm-ok" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold">××™×©×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Hotel Select Modal -->
  <div id="hotel-select-modal" class="modal fixed inset-0 z-[85] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl">
      <div class="p-4 border-b font-bold">×‘×—×™×¨×ª ××œ×•×Ÿ</div>
      <div class="p-4 space-y-2">
          <p class="text-sm text-slate-600">× ××¦××• ××¡×¤×¨ ××œ×•× ×•×ª ×‘×ª××¨×™×š ×–×”. ×‘×—×¨ ××ª ×”××œ×•×Ÿ ×”×¨×¦×•×™:</p>
          <select id="hotel-select-dropdown" class="w-full p-2 border rounded-lg"></select>
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="hotel-select-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-100">×‘×™×˜×•×œ</button>
        <button id="hotel-select-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg">×‘×—×™×¨×”</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ×™×¦×™×¨×ª/×¢×¨×™×›×ª ×¤×¨×™×˜ -->
 <div id="item-modal" class="modal fixed inset-0 z-50 items-center justify-center sm:p-4 bg-slate-900/40">
    <div class="modal-content bg-white w-full sm:rounded-2xl sm:max-w-2xl h-full sm:h-auto sm:max-h-[90vh] flex flex-col shadow-2xl overflow-hidden">
      
      <header class="px-5 py-4 border-b flex items-center justify-between bg-white shrink-0 z-10">
        <div>
           <h4 id="modal-title" class="text-xl font-bold text-slate-800">×”×•×¡×¤×ª ×¤×¨×™×˜</h4>
           <div class="text-xs text-slate-500 mt-0.5" id="step-indicator">×©×œ×‘ 1 ××ª×•×š 7</div>
        </div>
        <button id="close-modal" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition-colors">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>
      </header>

      <main class="p-5 overflow-y-auto flex-1 space-y-6 bg-slate-50/50 scroll-smooth">
        
        <div id="verify-banner" class="banner-warn hidden shadow-sm">
          <i class="fa-solid fa-triangle-exclamation mt-1"></i>
          <div>
            <strong>× ×“×¨×© ××™××•×ª:</strong> ×•×“× ×›×ª×•×‘×ª, ××¡×œ×•×œ ××• ×§×™×©×•×¨×™× ×•×œ×—×¥ ×©××™×¨×”.
          </div>
        </div>

        <div id="step-A" class="step space-y-4">
          <label class="block text-lg font-bold text-slate-800">××” ×”×›×•×ª×¨×ª ×”×›×œ×œ×™×ª ×œ×™×•×?</label>
          <input id="input-day-title" type="text" class="w-full p-4 text-lg border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="×œ××©×œ: ×™×•× ××•×–×™××•× ×™× ×•×›×™×£">
          <p class="text-sm text-slate-500 bg-blue-50 p-3 rounded-lg text-blue-800">
            <i class="fa-solid fa-circle-info"></i> ×©××œ×” ×–×• ×ª×•×¤×™×¢ ×¨×§ ×× ×œ×™×•× ×¢×“×™×™×Ÿ ××™×Ÿ ×›×•×ª×¨×ª.
          </p>
        </div>

        <div id="step-B" class="step space-y-4">
          <label class="block text-lg font-bold text-slate-800">××” ×× ×—× ×• ×¢×•×©×™×?</label>
          <input id="input-item-title" type="text" class="w-full p-4 text-lg border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="×œ××©×œ: ××¨×•×—×ª ×‘×•×§×¨ ×‘××¨×›×–">
        </div>

        <div id="step-C" class="step space-y-5">
          <div class="flex items-center justify-between">
            <label class="block text-lg font-bold text-slate-800">×–×× ×™×</label>
            <button id="add-back-to-hotel" class="text-sm font-semibold text-indigo-600 bg-indigo-50 px-3 py-1.5 rounded-lg hover:bg-indigo-100 transition-colors">
              + ×—×–×¨×” ×œ××œ×•×Ÿ
            </button>
          </div>
          
          <div class="grid grid-cols-2 gap-4">
            <div class="space-y-1">
              <label class="text-sm font-semibold text-slate-600">×”×ª×—×œ×”</label>
              <input id="input-start" type="time" class="w-full p-3 bg-white border border-slate-200 rounded-xl shadow-sm focus:border-blue-500 text-center text-lg font-mono" />
            </div>
            <div id="end-wrap" class="hidden space-y-1">
              <label class="text-sm font-semibold text-slate-600">×¡×™×•×</label>
              <input id="input-end" type="time" class="w-full p-3 bg-white border border-slate-200 rounded-xl shadow-sm focus:border-blue-500 text-center text-lg font-mono" />
            </div>
             <button id="toggle-end" type="button" class="h-[52px] self-end w-full border border-dashed border-slate-300 text-slate-500 rounded-xl hover:bg-slate-50 hover:text-slate-700 hover:border-slate-400 transition-all font-medium">
              + ×©×¢×ª ×¡×™×•×
            </button>
          </div>
        </div>

        <div id="step-D" class="step space-y-4">
          <label class="block text-lg font-bold text-slate-800">×ª×™××•×¨ ×•×¤×¨×˜×™×</label>
          <textarea id="input-desc" rows="5" class="w-full p-4 border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 resize-none" placeholder="×›×ª×•×‘ ×›××Ÿ ×›×œ ××” ×©×¦×¨×™×š ×œ×“×¢×ª ×¢×œ ×”×¤×¢×™×œ×•×ª..."></textarea>
        </div>

        <div id="step-E" class="step space-y-6">
          <h5 class="text-lg font-bold text-slate-800">××™×“×¢ × ×•×¡×£ (×¨×©×•×ª)</h5>
          
          <div class="flex flex-wrap gap-2">
            <button data-open="#block-address" class="open-block flex-1 whitespace-nowrap"><i class="fa-solid fa-location-dot text-red-500"></i> ×›×ª×•×‘×ª</button>
            <button data-open="#block-links" class="open-block flex-1 whitespace-nowrap"><i class="fa-solid fa-link text-slate-500"></i> ×§×™×©×•×¨×™×</button>
            <button data-open="#block-route" class="open-block flex-1 whitespace-nowrap"><i class="fa-solid fa-route text-blue-500"></i> ××¡×œ×•×œ</button>
          </div>
          <div class="flex flex-wrap gap-2">
             <button data-open="#block-book" class="open-block flex-1 whitespace-nowrap"><i class="fa-solid fa-ticket text-green-500"></i> ×›×¨×˜×™×¡×™×</button>
             <button data-open="#block-connect" class="open-block flex-grow-[2] whitespace-nowrap"><i class="fa-regular fa-star text-amber-500"></i> ×§×™×©×•×¨ ×œ××˜×¨×§×¦×™×”/××œ×•×Ÿ</button>
          </div>

          <div id="block-address" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
             <div class="flex justify-between items-center">
                <label class="font-bold text-slate-700">×›×ª×•×‘×ª</label>
                <button id="use-hotel-address" class="text-xs font-bold text-blue-600 bg-blue-50 px-2 py-1 rounded hover:bg-blue-100">×”×©×ª××© ×‘×›×ª×•×‘×ª ×”××œ×•×Ÿ</button>
             </div>
             <div class="flex gap-2">
               <input id="addr-input" type="text" class="flex-1 p-3 border rounded-xl bg-slate-50 focus:bg-white" placeholder="×—×¤×© ×›×ª×•×‘×ª...">
               <button id="addr-search-btn" type="button" class="px-4 bg-slate-800 text-white rounded-xl"><i class="fa-solid fa-magnifying-glass"></i></button>
             </div>
             <div id="addr-map" class="w-full h-48 rounded-xl bg-slate-100 border overflow-hidden"></div>
          </div>

          <div id="block-links" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
            <label class="block font-bold text-slate-700">×§×™×©×•×¨ ×œ××ª×¨ ××™× ×˜×¨× ×˜</label>
            <input id="link-general" type="url" class="w-full p-3 border rounded-xl ltr" placeholder="https://www.example.com">
          </div>

          <div id="block-book" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
            <label class="block font-bold text-slate-700">×§×™×©×•×¨ ×œ×”×–×× ×ª ×›×¨×˜×™×¡×™×</label>
            <input id="link-book" type="url" class="w-full p-3 border rounded-xl ltr" placeholder="https://...">
          </div>

          <div id="block-route" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-4">
             <div class="grid grid-cols-1 gap-3 relative">
               <div class="flex items-center gap-2">
                 <i class="fa-solid fa-circle text-[10px] text-green-500"></i>
                 <input id="route-from" class="w-full p-3 border rounded-xl text-sm" placeholder="××•×¦×">
                 <button id="route-from-search" type="button" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl"><i class="fa-solid fa-magnifying-glass"></i></button>
               </div>
               <div class="absolute left-3 top-8 bottom-8 w-px bg-slate-200 border-l border-dashed border-slate-300"></div>
               <div class="flex items-center gap-2">
                 <i class="fa-solid fa-location-dot text-red-500"></i>
                 <input id="route-to" class="w-full p-3 border rounded-xl text-sm" placeholder="×™×¢×“">
                 <button id="route-to-search" type="button" class="w-10 h-10 flex items-center justify-center bg-slate-100 rounded-xl"><i class="fa-solid fa-magnifying-glass"></i></button>
               </div>
             </div>
             <div class="flex items-center justify-between bg-slate-50 p-2 rounded-xl border">
               <select id="route-mode" class="bg-transparent border-none text-sm font-bold text-slate-700 focus:ring-0">
                 <option value="driving">ğŸš— ×¨×›×‘</option>
                 <option value="foot">ğŸš¶ ×”×œ×™×›×”</option>
               </select>
               <button id="route-calc" class="text-sm font-bold text-blue-600 px-3">×—×©×‘ ×–××Ÿ</button>
             </div>
             <div id="route-time" class="text-center font-bold text-slate-800 text-lg"></div>
             <div id="route-map" class="w-full h-48 rounded-xl bg-slate-100 border overflow-hidden"></div>
          </div>

          <div id="block-connect" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
            <p class="text-sm text-slate-500">×‘×—×¨ ××˜×¨×§×¦×™×•×ª ××• ××œ×•× ×•×ª ×©×›×‘×¨ ×©××¨×ª ×‘×˜×™×•×œ ×›×“×™ ×œ×§×©×¨ ××•×ª× ×œ×›×¨×˜×™×¡ ×”×–×”.</p>
            <div id="selected-refs" class="flex flex-wrap gap-2 mb-2 min-h-[30px]"></div>
            <div id="connect-lists" class="grid gap-2 max-h-60 overflow-y-auto p-1"></div>
          </div>
        </div>

        <div id="step-F" class="step space-y-4">
          <label class="block text-lg font-bold text-slate-800">×ª×§×¦×™×¨ (××•×¤×™×¢ ×‘×›×¨×˜×™×¡)</label>
          <input id="input-summary" type="text" class="w-full p-4 border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500" placeholder="××©×¤×˜ ××—×“ ××¡×›×...">
        </div>

        <div id="step-G" class="step space-y-4">
          <label class="block text-lg font-bold text-slate-800">×”×¢×¨×•×ª ×•×“×’×©×™×</label>
          <textarea id="input-notes" rows="4" class="w-full p-4 border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 bg-yellow-50/50" placeholder="×“×‘×¨×™× ×©×—×©×•×‘ ×œ×–×›×•×¨ (××œ×¨×’×™×•×ª, ×›×¨×˜×™×¡×™× ××•×“×¤×¡×™×...)"></textarea>
        </div>

      </main>

      <footer class="p-4 bg-white border-t shrink-0 z-10 flex items-center gap-3">
        <button id="prev-step" class="px-6 py-3.5 rounded-xl border border-slate-200 text-slate-600 font-bold hover:bg-slate-50 transition-colors">
          ×—×–×¨×”
        </button>
        <button id="next-step" class="flex-1 py-3.5 rounded-xl bg-slate-900 text-white font-bold text-lg hover:bg-slate-800 transition-all shadow-md active:scale-[0.98]">
          ×”××©×š
        </button>
        <button id="save-item" class="hidden flex-1 py-3.5 rounded-xl bg-blue-600 text-white font-bold text-lg hover:bg-blue-700 transition-all shadow-md shadow-blue-200 active:scale-[0.98]">
          ×©××•×¨ ×¡×•×¤×™×ª
        </button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ×¢×¨×™×›×ª ×›×•×ª×¨×ª ×™×•× -->
 <div id="title-modal" class="modal fixed inset-0 z-50 items-center justify-center sm:p-4 bg-slate-900/40">
    <div class="modal-content bg-white w-full sm:rounded-2xl sm:max-w-md flex flex-col shadow-2xl overflow-hidden m-4 rounded-2xl">
      
      <header class="p-4 border-b bg-white flex items-center justify-between">
        <h4 class="text-lg font-bold text-slate-800">×¢×¨×™×›×ª ×›×•×ª×¨×ª ×œ×™×•×</h4>
      </header>

      <main class="p-5 bg-slate-50/50">
        <label class="block text-sm font-bold text-slate-500 mb-2">×›×•×ª×¨×ª ×”×™×•×</label>
        <input id="title-edit-input" class="w-full p-4 text-lg border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 bg-white" placeholder="×œ××©×œ: ×™×•× ×˜×™×•×œ ×‘×œ×•× ×“×•×Ÿ">
      </main>

      <footer class="p-4 border-t bg-white flex gap-3">
        <button id="title-cancel" class="flex-1 py-3.5 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50">×‘×™×˜×•×œ</button>
        <button id="title-save" class="flex-[2] py-3.5 rounded-xl bg-blue-600 text-white font-bold hover:bg-blue-700 shadow-md shadow-blue-200">×©××•×¨ ×©×™× ×•×™×™×</button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ×¦×¤×™×™×” ××œ××” ×‘×¤×¨×™×˜ -->
<div id="view-modal" class="modal fixed inset-0 z-[60] items-end sm:items-center justify-center sm:p-4 bg-slate-900/50">
    <div class="modal-content bg-white w-full sm:rounded-3xl sm:max-w-xl max-h-[95vh] sm:max-h-[85vh] flex flex-col shadow-2xl overflow-hidden rounded-t-3xl">
      
      <header class="p-5 border-b flex items-start justify-between bg-white shrink-0">
        <div class="flex-1">
          <h4 id="view-title" class="text-2xl font-black text-slate-900 leading-tight mb-1">×›×•×ª×¨×ª</h4>
          <div id="view-time" class="text-lg text-blue-600 font-bold flex items-center gap-2">
            <i class="fa-regular fa-clock"></i> <span>--:--</span>
          </div>
        </div>
        <button id="view-close" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 text-slate-400 hover:bg-slate-100 hover:text-slate-800 transition-colors -mt-2 -ml-2">
          <i class="fa-solid fa-xmark text-xl"></i>
        </button>
      </header>

      <main class="p-5 overflow-y-auto space-y-6 scroll-smooth bg-white">
        
        <div id="view-summary" class="text-lg font-medium text-slate-700 bg-slate-50 p-4 rounded-xl border border-slate-100 leading-relaxed"></div>
        
        <div id="view-desc" class="text-slate-600 whitespace-pre-line leading-7 text-base"></div>

        <div class="space-y-3">
           <div id="view-address" class="font-bold text-slate-800 flex items-start gap-2"></div>
           <div class="grid grid-cols-2 gap-3">
             <a id="nav-waze" target="_blank" class="hidden flex items-center justify-center gap-2 py-3 rounded-xl bg-[#33ccff]/10 text-[#33ccff] font-bold border border-[#33ccff]/20 hover:bg-[#33ccff] hover:text-white transition-all">
               <i class="fa-brands fa-waze text-xl"></i> Waze
             </a>
             <a id="nav-gmaps" target="_blank" class="hidden flex items-center justify-center gap-2 py-3 rounded-xl bg-blue-50 text-blue-600 font-bold border border-blue-100 hover:bg-blue-600 hover:text-white transition-all">
               <i class="fa-solid fa-map-location-dot text-xl"></i> Maps
             </a>
           </div>
           <div id="view-map" class="w-full h-48 rounded-2xl bg-slate-100 overflow-hidden shadow-inner border"></div>
        </div>

        <div id="view-links" class="flex flex-wrap gap-3 pt-2"></div>

      </main>

      <footer class="p-4 bg-slate-50 border-t shrink-0 flex flex-col gap-3">
         <button id="view-verify" class="hidden w-full py-3 rounded-xl bg-red-100 text-red-700 font-bold border border-red-200 flex items-center justify-center gap-2">
           <i class="fa-solid fa-triangle-exclamation"></i> ×”×©×œ× ×¤×¨×˜×™× ×—×¡×¨×™×
         </button>
         
         <div class="flex gap-3">
           <button id="view-edit" class="flex-1 py-3.5 rounded-xl bg-white border border-slate-300 text-slate-700 font-bold shadow-sm hover:bg-slate-50">
             <i class="fa-solid fa-pen ml-1"></i> ×¢×¨×•×š
           </button>
           <button id="view-delete" class="px-5 py-3.5 rounded-xl bg-red-50 text-red-600 border border-red-100 font-bold hover:bg-red-100">
             <i class="fa-solid fa-trash-can"></i>
           </button>
         </div>
      </footer>
    </div>
  </div>

  <!-- MODAL: AI ×”×“×‘×§×”/×¤×¨×™×¡×”/×™×¦×™×¨×” -->
 <div id="ai-modal" class="modal fixed inset-0 z-[70] items-center justify-center sm:p-4 bg-slate-900/40">
    <div class="modal-content bg-white w-full sm:rounded-2xl sm:max-w-3xl h-full sm:h-auto sm:max-h-[90vh] flex flex-col shadow-2xl overflow-hidden relative">
      
      <div id="ai-loader-overlay" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm z-20 flex flex-col items-center justify-center gap-6">
          <div class="loader text-purple-600 w-12 h-12 border-4"></div>
          <p class="font-bold text-xl text-slate-800 animate-pulse">×”×¨×•×‘×•×˜ ×‘×•× ×” ××ª ×”×œ×•"×– ×©×œ×š...</p>
      </div>

      <header class="p-4 border-b bg-white shrink-0 flex items-center justify-between">
        <h4 class="text-xl font-bold flex items-center gap-2">
          <span class="w-8 h-8 rounded-lg bg-purple-100 text-purple-600 flex items-center justify-center"><i class="fa-solid fa-wand-magic-sparkles"></i></span>
          ×™×¦×™×¨×” ×¢× AI
        </h4>
        <button id="ai-close" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition-colors">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>
      </header>

      <main class="p-5 overflow-y-auto space-y-6 flex-1 bg-slate-50/50 scroll-smooth">
        
        <div class="bg-white border border-slate-200 rounded-2xl p-4 shadow-sm">
           <h5 class="font-bold text-slate-800 mb-2">××™×š ×–×” ×¢×•×‘×“?</h5>
           <div class="flex flex-col gap-3">
             <div class="flex items-start gap-3">
               <span class="flex-shrink-0 w-6 h-6 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center text-sm">1</span>
               <p class="text-sm text-slate-600 mt-0.5">×“×‘×¨ ×¢× ×”×¢×•×–×¨ ×©×œ× ×•, ×ª××¨ ×œ×• ××ª ×”×™×•× ×©×œ×š.</p>
             </div>
             <div class="flex items-start gap-3">
               <span class="flex-shrink-0 w-6 h-6 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center text-sm">2</span>
               <p class="text-sm text-slate-600 mt-0.5">×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×©×”×•× × ×•×ª×Ÿ ×œ×š ×•×”×“×‘×§ ××•×ª×• ×›××Ÿ ×œ××˜×”.</p>
             </div>
           </div>
           
           <a href="https://chatgpt.com/g/g-6899d3d888d08191b96ce2ccbb43372b-h-vzr-hkhkm-lv-z-tyvl-bqlvt"
              target="_blank"
              class="mt-4 flex items-center justify-center gap-2 w-full py-3 rounded-xl bg-slate-900 text-white font-bold hover:bg-slate-800 transition-all shadow-md">
             <i class="fa-solid fa-robot"></i> ×œ×—×¥ ×›××Ÿ ×œ××¢×‘×¨ ×œ×©×™×—×” ×¢× ×”-AI
           </a>
        </div>

        <div class="space-y-2">
          <label class="font-bold text-slate-800 px-1">×”×“×‘×§ ××ª ×”×˜×§×¡×˜ ×›××Ÿ:</label>
          <textarea id="ai-input" rows="6" class="w-full p-4 border-0 shadow-sm ring-1 ring-slate-200 rounded-xl focus:ring-2 focus:ring-purple-500 resize-none text-sm font-mono" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”×˜×§×¡×˜ ×¢× ×”×¡×™××•× ×™× ( ! ×´ / \ â‚ª : ×³ ×³â‚ª ? $ > < * â€¢ ~ )"></textarea>
        </div>

        <div id="ai-preview" class="hidden space-y-2 border-t pt-4">
          <div class="font-bold text-slate-800 px-1">×ª×¦×•×’×” ××§×“×™××” (Preview):</div>
          <div id="ai-preview-content" class="space-y-2 text-sm bg-white p-4 rounded-xl border border-slate-200 max-h-60 overflow-y-auto"></div>
        </div>
      </main>

      <footer class="p-4 bg-white border-t shrink-0 flex gap-3">
        <button id="ai-parse" class="flex-1 py-3.5 rounded-xl border border-slate-200 font-bold text-slate-700 hover:bg-slate-50 transition-colors">
          <i class="fa-solid fa-eye ml-1"></i> ×‘×“×•×§ ×ª×§×™× ×•×ª
        </button>
        <button id="ai-create" class="flex-[2] py-3.5 rounded-xl bg-purple-600 text-white font-bold hover:bg-purple-700 transition-all shadow-md shadow-purple-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled>
          <span class="loader hidden w-4 h-4 border-2"></span>
          <span class="btn-text"><i class="fa-solid fa-hammer ml-1"></i> ×¦×•×¨ ××ª ×”×œ×•"×–</span>
        </button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ××™××•×ª ×›×ª×•×‘×ª/××¡×œ×•×œ/×§×™×©×•×¨×™× -->
  <div id="verify-modal" class="modal fixed inset-0 z-[75] items-center justify-center sm:p-4 bg-slate-900/40">
    <div class="modal-content bg-white w-full sm:rounded-2xl sm:max-w-3xl h-full sm:h-auto sm:max-h-[90vh] flex flex-col shadow-2xl overflow-hidden relative">
      
      <header class="p-4 border-b bg-white shrink-0 flex items-center justify-between z-10">
        <div>
           <h4 class="text-xl font-bold text-slate-800 flex items-center gap-2">
             <span class="w-8 h-8 rounded-lg bg-blue-100 text-blue-600 flex items-center justify-center"><i class="fa-solid fa-check-double"></i></span>
             ××™××•×ª ×¤×¨×˜×™×
           </h4>
           <div id="v-title" class="text-sm text-slate-500 mt-1 truncate max-w-[200px] sm:max-w-md">×›×•×ª×¨×ª ×”×¤×¨×™×˜</div>
        </div>
        <button id="v-close" class="w-8 h-8 flex items-center justify-center rounded-full bg-slate-100 text-slate-500 hover:bg-slate-200 hover:text-slate-800 transition-colors">
          <i class="fa-solid fa-xmark text-lg"></i>
        </button>
      </header>

      <main class="p-5 overflow-y-auto flex-1 space-y-6 bg-slate-50/50 scroll-smooth">
        
        <div class="bg-amber-50 border border-amber-200 text-amber-800 p-4 rounded-xl flex items-start gap-3">
          <i class="fa-regular fa-lightbulb mt-1 text-amber-600"></i>
          <p class="text-sm leading-relaxed">×”×©×œ× ××ª ×”×¤×¨×˜×™× ×”×—×¡×¨×™× ×‘×¡×¢×™×¤×™× ×©× ×¤×ª×—×• ×œ××˜×”. ×œ××—×¨ ×©××™×¨×”, ×”××–×”×¨×” ×ª×•×¡×¨ ××”×›×¨×˜×™×¡×™×™×”.</p>
        </div>

        <section id="v-block-address" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
          <div class="flex items-center justify-between border-b pb-2 mb-2">
             <h5 class="font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-location-dot text-red-500"></i> ××™××•×ª ×›×ª×•×‘×ª</h5>
             <button id="v-use-hotel" class="text-xs font-bold text-blue-600 bg-blue-50 px-2.5 py-1.5 rounded-lg hover:bg-blue-100">×”×©×ª××© ×‘×›×ª×•×‘×ª ×”××œ×•×Ÿ</button>
          </div>
          
          <div class="flex gap-2">
            <input id="v-addr-input" type="text" class="flex-1 p-3 border rounded-xl bg-slate-50 focus:bg-white focus:ring-2 focus:ring-blue-500" placeholder="×”×§×œ×“ ×›×ª×•×‘×ª ××• ×—×¤×©...">
            <button id="v-addr-search" type="button" class="px-4 bg-slate-800 text-white rounded-xl shadow-md hover:bg-slate-700 transition-colors"><i class="fa-solid fa-magnifying-glass"></i></button>
          </div>
          <div id="v-addr-map" class="w-full h-52 rounded-xl bg-slate-100 border overflow-hidden shadow-inner"></div>
        </section>

        <section id="v-block-route" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-4">
          <h5 class="font-bold text-slate-800 border-b pb-2 mb-2 flex items-center gap-2"><i class="fa-solid fa-route text-blue-500"></i> ××™××•×ª ××¡×œ×•×œ</h5>
          
          <div class="grid grid-cols-1 gap-3 relative">
             <div class="flex items-center gap-2">
               <i class="fa-solid fa-circle text-[10px] text-green-500 shrink-0"></i>
               <div class="flex-1 input-with-btn">
                 <input id="v-route-from" class="w-full p-3 border rounded-xl text-sm" placeholder="××•×¦×">
                 <button id="v-route-from-search" type="button" class="w-10 flex items-center justify-center bg-slate-100 rounded-xl hover:bg-slate-200"><i class="fa-solid fa-magnifying-glass"></i></button>
               </div>
             </div>
             <div class="absolute right-[5px] top-9 bottom-9 w-px bg-slate-200 border-r border-dashed border-slate-300"></div>
             
             <div class="flex items-center gap-2">
               <i class="fa-solid fa-location-dot text-red-500 shrink-0"></i>
               <div class="flex-1 input-with-btn">
                 <input id="v-route-to" class="w-full p-3 border rounded-xl text-sm" placeholder="×™×¢×“">
                 <button id="v-route-to-search" type="button" class="w-10 flex items-center justify-center bg-slate-100 rounded-xl hover:bg-slate-200"><i class="fa-solid fa-magnifying-glass"></i></button>
               </div>
             </div>
          </div>

          <div class="flex items-center justify-between bg-slate-50 p-2 rounded-xl border">
            <select id="v-route-mode" class="bg-transparent border-none text-sm font-bold text-slate-700 focus:ring-0 cursor-pointer py-2 pl-2 pr-8">
              <option value="driving">ğŸš— ×¨×›×‘</option>
              <option value="foot">ğŸš¶ ×”×œ×™×›×”</option>
            </select>
            <button id="v-route-calc" class="text-sm font-bold text-white bg-blue-600 px-4 py-2 rounded-lg hover:bg-blue-700 shadow-sm transition-colors">×—×©×‘ ××¡×œ×•×œ</button>
          </div>
          
          <div class="flex justify-center">
             <div id="v-route-time" class="text-center font-bold text-slate-800 text-lg bg-white px-4 py-1 rounded-full border shadow-sm min-h-[30px]"></div>
          </div>
          <div id="v-route-map" class="w-full h-56 rounded-xl bg-slate-100 border overflow-hidden shadow-inner"></div>
        </section>

        <section id="v-block-refs" class="hidden bg-white border border-slate-200 rounded-2xl p-4 shadow-sm space-y-3">
          <h5 class="font-bold text-slate-800 border-b pb-2 mb-2 flex items-center gap-2"><i class="fa-solid fa-link text-slate-500"></i> ××™××•×ª ×§×™×©×•×¨×™×</h5>
          
          <div class="mb-2">
            <div id="v-selected-refs" class="flex flex-wrap gap-2 min-h-[30px]"></div>
          </div>
          <p class="text-sm text-slate-500 mb-3 bg-slate-50 p-2 rounded-lg">×‘×—×¨ ××§×•×¨×•×ª ××”×¨×©×™××” ×›×“×™ ×œ×§×©×¨ ×œ×›×¨×˜×™×¡ (×œ××©×œ ×›×¨×˜×™×¡ ×˜×™×¡×”, ××œ×•×Ÿ ××• ××¡×¢×“×” ×©×©××¨×ª).</p>
          <div id="v-connect-lists" class="grid gap-2 max-h-60 overflow-y-auto p-1"></div>
        </section>

      </main>

      <footer class="p-4 bg-white border-t shrink-0 flex items-center justify-between gap-3 z-10 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.05)]">
        <button id="v-cancel" class="flex-1 py-3.5 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 transition-colors">
          ×‘×™×˜×•×œ
        </button>
        <button id="v-save" class="flex-[2] py-3.5 rounded-xl bg-emerald-600 text-white font-bold text-lg hover:bg-emerald-700 transition-all shadow-md shadow-emerald-200 flex items-center justify-center gap-2">
          <i class="fa-solid fa-check"></i> ×©××•×¨ ××™××•×ª
        </button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ×“×’×©/×˜×™×¤ -->
  <div id="note-modal" class="modal fixed inset-0 z-[80] items-center justify-center sm:p-4 bg-slate-900/40">
    <div class="modal-content bg-white w-full sm:rounded-2xl sm:max-w-md flex flex-col shadow-2xl overflow-hidden m-4 rounded-2xl">
      
      <header class="p-4 border-b bg-slate-50 flex items-center justify-between">
        <h4 id="note-modal-title" class="text-lg font-bold text-slate-800">×”×•×¡×¤×ª ×”×¢×¨×”</h4>
        <button id="note-close" class="text-slate-400 hover:text-slate-800"><i class="fa-solid fa-xmark text-lg"></i></button>
      </header>

      <main class="p-5 space-y-4">
        <div>
          <label class="text-sm font-bold text-slate-500 mb-1 block">×›×•×ª×¨×ª</label>
          <input id="note-title" type="text" class="w-full p-3 border rounded-xl font-bold text-slate-800 focus:ring-2 focus:ring-amber-400 border-slate-200" placeholder="×œ××©×œ: ×œ× ×œ×©×›×•×— ××™×">
        </div>
        
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-sm font-bold text-slate-500 mb-1 block">×¡×•×’</label>
            <select id="note-kind" class="w-full p-3 border rounded-xl bg-white">
              <option value="×“×’×©">âš ï¸ ×“×’×© ×—×©×•×‘</option>
              <option value="×˜×™×¤">ğŸ’¡ ×˜×™×¤ ×œ×“×¨×š</option>
            </select>
          </div>
          <div>
            <label class="text-sm font-bold text-slate-500 mb-1 block">×¦×‘×¢ ×¨×§×¢</label>
            <div class="flex justify-between gap-1 bg-slate-100 p-1.5 rounded-xl">
               <button data-color="red"    class="note-color w-6 h-6 rounded-full bg-red-100 border border-red-300"></button>
               <button data-color="green"  class="note-color w-6 h-6 rounded-full bg-green-100 border border-green-300"></button>
               <button data-color="blue"   class="note-color w-6 h-6 rounded-full bg-blue-100 border border-blue-300"></button>
               <button data-color="yellow" class="note-color w-6 h-6 rounded-full bg-yellow-100 border border-yellow-300 ring-2 ring-slate-400"></button>
               <button data-color="orange" class="note-color w-6 h-6 rounded-full bg-orange-100 border border-orange-300"></button>
            </div>
            <input id="note-color" type="hidden" value="yellow">
          </div>
        </div>

        <div>
          <label class="text-sm font-bold text-slate-500 mb-1 block">×¤×™×¨×•×˜</label>
          <textarea id="note-details" rows="3" class="w-full p-3 border rounded-xl focus:ring-2 focus:ring-amber-400 border-slate-200" placeholder="×›×ª×•×‘ ×›××Ÿ..."></textarea>
        </div>
      </main>

      <footer class="p-4 border-t flex gap-3">
        <button id="note-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50">×‘×™×˜×•×œ</button>
        <button id="note-save" class="flex-[2] py-3 rounded-xl bg-amber-500 text-white font-bold hover:bg-amber-600 shadow-md shadow-amber-200">×©××™×¨×”</button>
      </footer>
    </div>
  </div>

  <!-- ×ª×™×‘×ª ×”×¦×¢×•×ª ×›×œ×œ×™×ª -->
  <div id="global-typeahead" class="typeahead"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc,
      collection, getDocs, onSnapshot, serverTimestamp, orderBy, query, deleteDoc,
      writeBatch,
      enableIndexedDbPersistence,
      enableMultiTabIndexedDbPersistence,
      where
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.warn('IndexedDB persistence failed-precondition. Falling back to multi-tabâ€¦', err);
        enableMultiTabIndexedDbPersistence(db).catch(e => console.warn('Multi-tab persistence error:', e));
      } else if (err.code === 'unimplemented') {
        console.warn('Browser does not support IndexedDB persistence.');
      } else {
        console.warn('Persistence error:', err);
      }
    });

    const p = new URLSearchParams(location.search);
    const tripId = p.get('tripId') || p.get('id'); // Allow 'id' as well
    const urlDate = p.get('date');
    if (!tripId) { alert('×—×¡×¨ tripId'); location.href='index.html'; }

    // DOM Refs
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpClose = document.getElementById('help-close');

    const deleteAllBtn = document.getElementById('delete-all-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');

    const hotelSelectModal = document.getElementById('hotel-select-modal');
    const hotelSelectDropdown = document.getElementById('hotel-select-dropdown');
    const hotelSelectSave = document.getElementById('hotel-select-save');
    const hotelSelectCancel = document.getElementById('hotel-select-cancel');
    let hotelSelectCallback = null;
    
    const authSlot = document.getElementById('auth-slot');

    const dateToggle = document.getElementById('date-toggle');
    const datePanel  = document.getElementById('date-panel');
    const dateCurrent= document.getElementById('date-current');
    const dateList   = document.getElementById('date-list');
    const badgeDate  = document.getElementById('badge-date');
    const backToDay  = document.getElementById('back-to-day');

    const dayTitleInline = document.getElementById('day-title-inline');
    const editDayTitleInline = document.getElementById('edit-day-title-inline');

    const itemsList     = document.getElementById('items-list');
    const addItemBtn    = document.getElementById('add-item-btn');
    const aiBuildBtn    = document.getElementById('ai-build-btn');

    const notesList     = document.getElementById('notes-list');
    const addNoteBtn    = document.getElementById('add-note-btn');

    const itemModal    = document.getElementById('item-modal');
    const modalTitle   = document.getElementById('modal-title');
    const closeModal   = document.getElementById('close-modal');
    const prevStepBtn  = document.getElementById('prev-step');
    const nextStepBtn  = document.getElementById('next-step');
    const saveBtn       = document.getElementById('save-item');
    const stepIndicator= document.getElementById('step-indicator');
    const verifyBanner = document.getElementById('verify-banner');

    const stepA = document.getElementById('step-A');
    const stepB = document.getElementById('step-B');
    const stepC = document.getElementById('step-C');
    const stepD = document.getElementById('step-D');
    const stepE = document.getElementById('step-E');
    const stepF = document.getElementById('step-F');
    const stepG = document.getElementById('step-G');

    const inputDayTitle = document.getElementById('input-day-title');
    const inputItemTitle= document.getElementById('input-item-title');
    const inputStart    = document.getElementById('input-start');
    const inputEnd      = document.getElementById('input-end');
    const toggleEnd     = document.getElementById('toggle-end');
    const endWrap       = document.getElementById('end-wrap');
    const addBackHotel  = document.getElementById('add-back-to-hotel');
    const inputDesc     = document.getElementById('input-desc');
    const inputSummary  = document.getElementById('input-summary');
    const inputNotes    = document.getElementById('input-notes');

    const openBlockBtns = document.querySelectorAll('.open-block');
    const addrInput   = document.getElementById('addr-input');
    const addrMapDiv  = document.getElementById('addr-map');
    const addrSearchBtn = document.getElementById('addr-search-btn');
    const useHotelBtn = document.getElementById('use-hotel-address');
    let addrMap=null, addrMarker=null;

    const linkGeneral = document.getElementById('link-general');
    const linkBook    = document.getElementById('link-book');

    const rFrom       = document.getElementById('route-from');
    const rTo         = document.getElementById('route-to');
    const rMode       = document.getElementById('route-mode');
    const rCalc       = document.getElementById('route-calc');
    const rFromSearch = document.getElementById('route-from-search');
    const rToSearch   = document.getElementById('route-to-search');
    const rTime       = document.getElementById('route-time');
    const rMapDiv     = document.getElementById('route-map');
    let routeMap=null, routeLayer=null, routeMarkers=[];

    const connectLists = document.getElementById('connect-lists');
    const selectedRefsWrap = document.getElementById('selected-refs');
    let selectedRefs = [];

    const titleModal = document.getElementById('title-modal');
    const titleInput = document.getElementById('title-edit-input');
    const titleSave  = document.getElementById('title-save');
    const titleCancel= document.getElementById('title-cancel');

    const viewModal   = document.getElementById('view-modal');
    const viewClose   = document.getElementById('view-close');
    const viewTitle   = document.getElementById('view-title');
    const viewTime    = document.getElementById('view-time');
    const viewSummary = document.getElementById('view-summary');
    const viewDesc    = document.getElementById('view-desc');
    const viewAddress = document.getElementById('view-address');
    const viewLinks   = document.getElementById('view-links');
    const viewMapDiv  = document.getElementById('view-map');
    const navWaze     = document.getElementById('nav-waze');
    const navGmaps    = document.getElementById('nav-gmaps');
    const viewEditBtn = document.getElementById('view-edit');
    const viewDelBtn  = document.getElementById('view-delete');
    const viewVerifyBtn = document.getElementById('view-verify');
    let viewMap=null, viewMarker=null, viewingItem=null;

    const vModal = document.getElementById('verify-modal');
    const vTitle = document.getElementById('v-title');
    const vClose = document.getElementById('v-close');
    const vCancel= document.getElementById('v-cancel');
    const vSave  = document.getElementById('v-save');

    const vBlockAddr = document.getElementById('v-block-address');
    const vUseHotel  = document.getElementById('v-use-hotel');
    const vAddrInput = document.getElementById('v-addr-input');
    const vAddrSearch= document.getElementById('v-addr-search');
    const vAddrMapDiv= document.getElementById('v-addr-map');
    let vAddrMap=null, vAddrMarker=null;

    const vBlockRoute = document.getElementById('v-block-route');
    const vRouteFrom  = document.getElementById('v-route-from');
    const vRouteTo    = document.getElementById('v-route-to');
    const vRouteFromSearch = document.getElementById('v-route-from-search');
    const vRouteToSearch   = document.getElementById('v-route-to-search');
    const vRouteMode  = document.getElementById('v-route-mode');
    const vRouteCalc  = document.getElementById('v-route-calc');
    const vRouteTime  = document.getElementById('v-route-time');
    const vRouteMapDiv= document.getElementById('v-route-map');
    let vRouteMap=null, vRouteLayer=null, vRouteMarkers=[];

    const vBlockRefs  = document.getElementById('v-block-refs');
    const vSelectedRefsWrap = document.getElementById('v-selected-refs');
    const vConnectLists = document.getElementById('v-connect-lists');
    let vSelectedRefs = [];
    let vCurrentItem = null;

    const globalTA = document.getElementById('global-typeahead');
    let taActiveInput = null;
    let taOutsideHandler = null;
    let taScrollHandler = null;

    const aiModal   = document.getElementById('ai-modal');
    const aiInput   = document.getElementById('ai-input');
    const aiParse   = document.getElementById('ai-parse');
    const aiCreate  = document.getElementById('ai-create');
    const aiPreview = document.getElementById('ai-preview');
    const aiPreviewContent = document.getElementById('ai-preview-content');
    const aiClose   = document.getElementById('ai-close');
    const aiLoaderOverlay = document.getElementById('ai-loader-overlay');

    const noteModal = document.getElementById('note-modal');
    const noteClose = document.getElementById('note-close');
    const noteCancel= document.getElementById('note-cancel');
    const noteSave  = document.getElementById('note-save');
    const noteTitle = document.getElementById('note-title');
    const noteKind  = document.getElementById('note-kind');
    const noteDetails = document.getElementById('note-details');
    const noteColorHidden = document.getElementById('note-color');
    const noteModalTitle = document.getElementById('note-modal-title');
    const noteColorBtns = document.querySelectorAll('.note-color');
    let pickedNoteColor = 'yellow';
    let editingNoteId = null;

    let user=null, tripData=null;
    let selectedDate = null; 
    let selectedDestName = null; 
    let dayDocId=null, dayDocRef=null;
    let dayTitle=null;

    let items=[], notes=[];
    let itemsUnsub = null, notesUnsub = null;
    let currentStepIndex=0;
    const stepsOrder = ['A','B','C','D','E','F','G'];
    let editingItemId = null;
    let requiresRefsFlag = false;

    const pad2 = n => (''+n).padStart(2,'0');
    const toISOFromDDMMYYYY = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${y}-${pad2(m)}-${pad2(d)}`; };
    const toDisplayDotted = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${d}.${m}.${y}`; };
    const weekdayHe = (s)=>{ const [d,m,y]=s.split('/').map(Number); const dt=new Date(y,m-1,d); const w=dt.toLocaleDateString('he-IL',{weekday:'long'}); return w.startsWith('×™×•×')?w:`×™×•× ${w}`; };
    const minutesFromHHMM = (hhmm)=>{ const [h,m]=(hhmm||'00:00').split(':').map(Number); return h*60+m; };
    const haversineMeters = (a,b) => { const R=6371000, t=x=>x*Math.PI/180; const dLa=t(b.lat-a.lat), dLo=t(b.lng-a.lng); const s1=Math.sin(dLa/2)**2 + Math.cos(t(a.lat))*Math.cos(t(b.lat))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(s1)); };

    const colorMap = {
      red:     {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:   {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:    {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow:  {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange:  {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    
    
    // ×¤×•× ×§×¦×™×™×ª ×¢×–×¨ ×œ× ×™×”×•×œ ××•×“××œ×™× ×•×—×¡×™××ª ×’×œ×™×œ×”
    function toggleModal(modalId, show) {
        const el = document.getElementById(modalId);
        if (show) {
            el.classList.add('show');
            document.body.classList.add('overflow-hidden'); // ×—×•×¡× ×’×œ×™×œ×” ×‘×¨×§×¢
        } else {
            el.classList.remove('show');
            document.body.classList.remove('overflow-hidden'); // ××—×–×™×¨ ×’×œ×™×œ×”
        }
    }
    
    
    // Confirmation Modal Logic
    let confirmResolve = null;
    function showConfirm({ title, message, confirmText = '××™×©×•×¨' }) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmOk.textContent = confirmText;
        confirmModal.classList.add('show');
        return new Promise(resolve => {
            confirmResolve = resolve;
        });
    }
    confirmOk.addEventListener('click', () => {
        if (confirmResolve) confirmResolve(true);
        confirmModal.classList.remove('show');
    });
    confirmCancel.addEventListener('click', () => {
        if (confirmResolve) confirmResolve(false);
        confirmModal.classList.remove('show');
    });

    // ×”×ª×—×‘×¨×•×ª + ×˜×¢×™× ×ª ×˜×™×•×œ
    onAuthStateChanged(auth, async (u)=>{
      if (!u){ location.href='login.html'; return; }
      user=u;

      if (authSlot) {
        authSlot.textContent = u.email || '';
      }

      const tSnap = await getDoc(doc(db,'trips',tripId));
      if (!tSnap.exists()){ alert('×˜×™×•×œ ×œ× × ××¦×'); location.href='index.html'; return; }
      tripData=tSnap.data();
      
      const editors = tripData.editors || [];
      if (!Array.isArray(editors) || !editors.includes(user.uid)) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××ª ×”×˜×™×•×œ ×”×–×”.');
          location.href = 'index.html';
          return;
      }

      buildDateSelector();

      let initialDate = urlDate;
      let initialDestName = null;

      if (initialDate) {
        const destForDate = tripData.destinations?.find(d => expandRange(d.dates).includes(initialDate));
        if (destForDate) {
          initialDestName = destForDate.nameHe;
        }
      }

      if (!initialDate || !initialDestName) {
        const firstDest = tripData.destinations?.[0];
        initialDate = firstDest?.dates?.split(' - ')?.[0];
        initialDestName = firstDest?.nameHe;
      }

      if (initialDate && initialDestName) {
        await setWorkingDate(initialDate, initialDestName);
      } else {
        dateCurrent.textContent = '×œ× × ××¦××• ×ª××¨×™×›×™× ×‘×˜×™×•×œ.';
        console.error("Could not determine an initial date and destination for the trip.");
      }
    });

    function renderItems(){
      if (!items.length){
        itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>`;
        deleteAllBtn.classList.add('hidden');
        return;
      }
      deleteAllBtn.classList.remove('hidden');
      itemsList.innerHTML = items.map(it=>{
        const time = `${it.startTime || ''}${it.endTime ? ' â€“ ' + it.endTime : ''}`;
        const dist = (it.distanceFromPreviousMeters!=null)
          ? `<span class="text-xs text-slate-500"> â€¢ ××¨×—×§ ×§×•×“×: ${(it.distanceFromPreviousMeters/1000).toFixed(2)} ×§×´×</span>` : '';
        const addr = it.address?.label ? `<div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-location-dot"></i> ${it.address.label}</div>` : '';
        const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
        const needsTxt = [
          it.needsVerifyAddress?'×›×ª×•×‘×ª':null,
          it.needsVerifyRoute?'××¡×œ×•×œ':null,
          it.needsVerifyRefs?'×§×™×©×•×¨':null
        ].filter(Boolean).join(' / ');
        return `<button class="card w-full text-right bg-white rounded-xl border shadow-sm p-4 ${needs?'needs-verify':''}" data-id="${it.id}">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <div class="font-bold whitespace-normal break-words ${needs?'text-red-800':'text-slate-800'}">${it.title || '(×œ×œ× ×›×•×ª×¨×ª)'}</div>
            </div>
            <div class="flex-shrink-0 ml-2 text-sm text-right font-semibold ${needs?'text-red-700':'text-slate-600'}">${time}${dist}</div>
          </div>
          ${needs?`<div class="mt-1"><span class="badge-verify"><i class="fa-solid fa-circle-exclamation"></i> ×“×¨×•×© ××™××•×ª${needsTxt?': '+needsTxt:''}</span></div>`:''}
          ${it.summary ? `<div class="text-slate-700 mt-1 whitespace-normal break-words">${it.summary}</div>`:''}
          ${addr}
        </button>`;
      }).join('');

      itemsList.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click',()=>{
          const it = items.find(x=>x.id===b.dataset.id);
          if (!it) return;
          if (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs) openVerifyModal(it);
          else openViewModal(it.id);
        });
      });
    }

    async function openViewModal(id){
      const it = items.find(x=>x.id===id);
      if (!it) return;
      viewingItem = it;
      viewTitle.textContent = it.title || '(×œ×œ× ×›×•×ª×¨×ª)';
      viewTime.textContent  = [it.startTime, it.endTime?('â€” '+it.endTime):''].filter(Boolean).join(' ');
      viewSummary.textContent = it.summary || '';
      viewSummary.classList.toggle('hidden', !it.summary);
      viewDesc.textContent = it.description || '';
      viewDesc.classList.toggle('hidden', !it.description);

      let refsHtml='';
      if (Array.isArray(it.refs) && it.refs.length){
        refsHtml = it.refs.map(r=>{
          const page = r.page === 'places' ? 'attractions' : (r.page === 'summary' ? 'summary' : 'attractions');
          const openType = r.type === 'logistics' ? 'logistics' : 'place';
          const href = `${page}.html?id=${tripId}&open=${openType}&id=${r.id}`;
          return `<a class="px-3 py-2 rounded-lg bg-indigo-600 text-white" target="_blank" href="${href}">${iconForRef(r)} ${r.label}</a>`;
        }).join(' ');
      }
      viewLinks.innerHTML = [
        it.links?.site ? `<a class="px-3 py-2 rounded-lg bg-slate-800 text-white" target="_blank" href="${it.links.site}"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
        it.links?.booking ? `<a class="px-3 py-2 rounded-lg bg-emerald-600 text-white" target="_blank" href="${it.links.booking}"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
        refsHtml
      ].filter(Boolean).join(' ');

      if (it.address?.label){
        viewAddress.innerHTML = `<i class="fa-solid fa-location-dot"></i> ${it.address.label}`;
        navWaze.href  = `https://waze.com/ul?q=${encodeURIComponent(it.address.label)}`;
        navGmaps.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}`;
        navWaze.classList.remove('hidden'); navGmaps.classList.remove('hidden');
      } else {
        viewAddress.innerHTML = '';
        navWaze.classList.add('hidden'); navGmaps.classList.add('hidden');
      }

      setTimeout(()=>{
        if (!viewMap){
          viewMap = L.map(viewMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(viewMap);
        }
        if (viewMarker){ viewMap.removeLayer(viewMarker); viewMarker=null; }
        if (it.address?.lat){
          viewMarker = L.marker([it.address.lat,it.address.lng]).addTo(viewMap);
          viewMap.setView([it.address.lat,it.address.lng], 15);
        }
        viewMap.invalidateSize();
      },120);

      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      viewVerifyBtn.classList.toggle('hidden', !needs);
      viewVerifyBtn.onclick = ()=>{ viewModal.classList.remove('show'); openVerifyModal(it); };
      viewEditBtn.onclick = ()=>{ viewModal.classList.remove('show'); openItemModal(it); };
      
      // ××—×™×§×ª ×¤×¨×™×˜ ×‘×•×“×“
      viewDelBtn.onclick  = async ()=>{
        const confirmed = await showConfirm({
            title: '××—×™×§×ª ×¤×¨×™×˜',
            message: `×”×× ×œ××—×•×§ ××ª ×”×¤×¨×™×˜ "${it.title}"? ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ×”×¤×¢×•×œ×”.`
        });
        if (confirmed) {
            viewModal.classList.remove('show');
            await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',it.id));
            await recomputeDistances();
        }
      };

      viewModal.classList.add('show');
    }

    // Help modal
    helpBtn.addEventListener('click', () => helpModal.classList.add('show'));
    helpClose.addEventListener('click', () => helpModal.classList.remove('show'));

    // ××—×™×§×ª ×›×œ ×”×¤×¨×™×˜×™× ×©×œ ×”×™×•×
    deleteAllBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm({
            title: '××—×™×§×ª ×›×œ ×”×¤×¨×™×˜×™×',
            message: `×”×× ×œ××—×•×§ ××ª ×›×œ ${items.length} ×”×¤×¨×™×˜×™× ××™×•× ×–×”? ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ×”×¤×¢×•×œ×”.`
        });
        if (confirmed) {
            const batch = writeBatch(db);
            const itemsCollectionRef = collection(db, 'trips', tripId, 'schedules', dayDocId, 'items');
            const querySnapshot = await getDocs(itemsCollectionRef);
            querySnapshot.forEach(dref => {
                batch.delete(dref.ref);
            });
            await batch.commit();
            // ××™×Ÿ ×¦×•×¨×š ×‘×—×™×©×•×‘ ××¨×—×§×™× ××—×“×© - ××™×Ÿ ×¤×¨×™×˜×™×
        }
    });
    
    // ×‘×•× ×” ×¨×©×™××ª ×ª××¨×™×›×™×/×™×¢×“×™× ×œ×‘×—×™×¨×”
    function buildDateSelector(){
      dateList.innerHTML='';
      dateCurrent.textContent='×‘×—×¨ ×ª××¨×™×š...';
      tripData.destinations?.forEach(dest=>{
        const dates = expandRange(dest.dates);
        const wrap = document.createElement('div');
        wrap.className='p-3';
        wrap.innerHTML=`<div class="font-bold text-slate-800 mb-2">${dest.nameHe}</div>`;
        dates.forEach(d=>{
          const wd=weekdayHe(d);
          const btn=document.createElement('button');
          btn.className='w-full text-right p-2 rounded hover:bg-slate-100';
          btn.textContent=`${wd} â€“ (${dest.nameHe}) â€¢ ${toDisplayDotted(d)}`;
          btn.addEventListener('click', async ()=>{
            await setWorkingDate(d, dest.nameHe);
            datePanel.classList.remove('open');
          });
          wrap.appendChild(btn);
        });
        dateList.appendChild(wrap);
      });
      dateToggle.addEventListener('click', ()=> datePanel.classList.toggle('open'));
    }

    function expandRange(r){
      if (!r?.includes(' - ')) return r ? [r] : [];
      const [s,e]=r.split(' - ');
      const [sd,sm,sy]=s.split('/').map(Number);
      const [ed,em,ey]=e.split('/').map(Number);
      const start=new Date(sy,sm-1,sd), end=new Date(ey,em-1,ed);
      const out=[]; let cur=new Date(start);
      while(cur<=end){
        out.push(`${pad2(cur.getDate())}/${pad2(cur.getMonth()+1)}/${cur.getFullYear()}`);
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }

    // ×‘×—×™×¨×ª ×™×•× ×¢×‘×•×“×” (×ª××¨×™×š+×™×¢×“) ×•×©×™×•×š ××¡××š Firestore
    async function setWorkingDate(ddmmyyyy, destName){
      if (!ddmmyyyy || !destName) {
        console.error("setWorkingDate called with invalid arguments", {ddmmyyyy, destName});
        return;
      }
      
      selectedDate = ddmmyyyy;
      selectedDestName = destName;

      const iso = toISOFromDDMMYYYY(ddmmyyyy);
      dayDocId = `${iso}_${destName}`; 
      dayDocRef = doc(db, 'trips', tripId, 'schedules', dayDocId);

      dateCurrent.textContent = `${weekdayHe(ddmmyyyy)} â€“ (${destName}) â€¢ ${toDisplayDotted(ddmmyyyy)}`;
      badgeDate.textContent   = `${weekdayHe(ddmmyyyy)} â€¢ ${toDisplayDotted(ddmmyyyy)}`;

      const snap = await getDoc(dayDocRef);
      if (snap.exists()) {
        dayTitle = snap.data().title || null;
      } else {
        dayTitle = null;
        await setDoc(dayDocRef, { title: null, date: ddmmyyyy, destination: destName }, { merge: true });
      }

      reflectDayTitleUI();
      backToDay.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(selectedDate)}`;
      resubscribeDayStreams();
    }
    
    function reflectDayTitleUI(){
      dayTitleInline.textContent = dayTitle || '×œ× × ×§×‘×¢×”';
      editDayTitleInline.classList.toggle('hidden', !dayTitle);
    }
    
    function resubscribeDayStreams(){
      if (itemsUnsub) { itemsUnsub(); itemsUnsub=null; }
      if (notesUnsub) { notesUnsub(); notesUnsub=null; }

      if (!dayDocId) {
          console.warn("No dayDocId set, cannot subscribe to streams.");
          itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“.</div>`;
          notesList.innerHTML = `<div class="text-slate-500">× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“.</div>`;
          return;
      }

      const qItems = query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc'));
      itemsUnsub = onSnapshot(qItems, (snap)=>{
        items = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderItems();
      });
      const qNotes = query(collection(db,'trips',tripId,'schedules',dayDocId,'notes'), orderBy('createdAt','asc'));
      notesUnsub = onSnapshot(qNotes, (snap)=>{
        notes = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderNotes();
      });
    }

    editDayTitleInline.addEventListener('click', ()=>{
      titleInput.value = dayTitle || '';
      noteModalTitle.textContent = '×¢×¨×™×›×ª ×›×•×ª×¨×ª ×œ×™×•×'; // ×œ× ×—×•×‘×” ××‘×œ ×©×™×”×™×” ×¢×§×‘×™
      titleModal.classList.add('show');
    });
    titleCancel.addEventListener('click', ()=> titleModal.classList.remove('show'));
    titleSave.addEventListener('click', async ()=>{
      const t=(titleInput.value||'').trim();
      await setDoc(dayDocRef,{title: t || null, updatedAt: serverTimestamp()},{merge:true});
      dayTitle = t || null;
      reflectDayTitleUI();
      titleModal.classList.remove('show');
    });

    function classesForColor(c){
      const m = colorMap[c] || colorMap.yellow;
      return `${m.bg} ${m.border} ${m.text}`;
    }

    function renderNotes(){
      if (!notes.length){
        notesList.innerHTML = `<div class="text-slate-500">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const cls = classesForColor(n.color);
        const titleSafe = (n.title || 'â€”').replace(/"/g, '&quot;');
        return `<div class="border rounded-xl p-3 ${cls}">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
                <div class="font-bold break-words whitespace-normal">${n.kind}: ${n.title || 'â€”'}</div>
            </div>
            <div class="flex gap-2 flex-shrink-0 ml-2">
              <button class="px-2 py-1 rounded bg-white/60 border text-sm note-edit" data-id="${n.id}"><i class="fa-solid fa-pen"></i> ×¢×¨×•×š</button>
              <button class="px-2 py-1 rounded bg-white/60 border text-sm note-del" data-id="${n.id}" data-title="${titleSafe}"><i class="fa-solid fa-trash"></i> ××—×§</button>
            </div>
          </div>
          <div class="mt-2 text-sm whitespace-normal break-words">${(n.details||'').replace(/\n/g,'<br>')}</div>
        </div>`;
      }).join('');

      notesList.querySelectorAll('.note-edit').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const n = notes.find(x=>x.id===btn.dataset.id);
          if (!n) return;
          openNoteModal(n);
        });
      });
      notesList.querySelectorAll('.note-del').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
            const noteTitle = btn.dataset.title;
            const confirmed = await showConfirm({
                title: '××—×™×§×ª ×“×’×©/×˜×™×¤',
                message: `×”×× ×œ××—×•×§ ××ª ×”×“×’×©/×˜×™×¤ "${noteTitle}"?`
            });
            if (confirmed) {
                await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'notes',btn.dataset.id));
            }
        });
      });
    }

    function openNoteModal(n=null){
      editingNoteId = n?.id || null;
      noteModalTitle.textContent = editingNoteId ? '×¢×¨×™×›×ª ×“×’×©/×˜×™×¤' : '×”×•×¡×¤×ª ×“×’×©/×˜×™×¤';
      noteTitle.value = n?.title || '';
      noteKind.value = n?.kind || '×“×’×©';
      noteDetails.value = n?.details || '';
      pickedNoteColor = n?.color || 'yellow';
      noteColorHidden.value = pickedNoteColor;

      // ×¡×™××•×Ÿ ×”×¦×‘×¢ ×©× ×‘×—×¨ (×˜×‘×¢×•×ª highlight)
      noteColorBtns.forEach(btn=>{
        btn.classList.remove('ring-2','ring-offset-2','ring-amber-500');
        if (btn.dataset.color === pickedNoteColor){
          btn.classList.add('ring-2','ring-offset-2','ring-amber-500');
        }
      });

      noteModal.classList.add('show');
    }

    // ×©×™× ×•×™ ×¦×‘×¢ ×‘×“×’×©
    noteColorBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        pickedNoteColor = btn.dataset.color;
        noteColorHidden.value = pickedNoteColor;
        noteColorBtns.forEach(b=>b.classList.remove('ring-2','ring-offset-2','ring-amber-500'));
        btn.classList.add('ring-2','ring-offset-2','ring-amber-500');
      });
    });

    // ×¤×ª×™×—×ª ××•×“×œ ×”×•×¡×¤×ª ×“×’×©
    addNoteBtn.addEventListener('click', ()=> {
      openNoteModal(null);
    });

    // ×¡×’×™×¨×ª ××•×“×œ ×“×’×©
    noteClose.addEventListener('click', ()=> noteModal.classList.remove('show'));
    noteCancel.addEventListener('click', ()=> noteModal.classList.remove('show'));

    // ×©××™×¨×ª ×“×’×©
    noteSave.addEventListener('click', async ()=>{
      const payload = {
        title: (noteTitle.value||'').trim(),
        kind: noteKind.value || '×“×’×©',
        details: (noteDetails.value||'').trim(),
        color: pickedNoteColor || 'yellow',
        updatedAt: serverTimestamp()
      };
      if (editingNoteId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'notes',editingNoteId), payload);
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'notes'), {
          ...payload,
          createdAt: serverTimestamp()
        });
      }
      editingNoteId = null;
      noteModal.classList.remove('show');
    });

    function showStep(code){
      [stepA,stepB,stepC,stepD,stepE,stepF,stepG].forEach(s=>s.classList.remove('active'));
      const idx = stepsOrder.indexOf(code);
      currentStepIndex = Math.max(0, idx);
      document.getElementById('step-'+code).classList.add('active');
      stepIndicator.textContent = `×©×œ×‘ ${currentStepIndex+1} ××ª×•×š ${stepsOrder.length}`;
      saveBtn.classList.toggle('hidden', code!=='G');
      nextStepBtn.classList.toggle('hidden', code==='G');
      prevStepBtn.disabled = (code=== (dayTitle ? 'B' : 'A'));
    }

    nextStepBtn.addEventListener('click', async ()=>{
      const cur = stepsOrder[currentStepIndex];
      if (cur==='A'){
        const t=(inputDayTitle.value||'').trim();
        await setDoc(dayDocRef,{ title: t || null, updatedAt: serverTimestamp() },{merge:true});
        dayTitle = t || null;
        reflectDayTitleUI();
      }
      showStep(stepsOrder[currentStepIndex+1]);
    });
    prevStepBtn.addEventListener('click', ()=> showStep(stepsOrder[currentStepIndex-1]));
    toggleEnd.addEventListener('click', ()=> endWrap.classList.toggle('hidden'));

    // ===== Typeahead helpers =====
    function placeTypeaheadBelow(inputEl){
      const r = inputEl.getBoundingClientRect();
      Object.assign(globalTA.style, { left: r.left+'px', top: (r.bottom+6)+'px', width: r.width+'px' });
    }
    function showTypeaheadFor(inputEl, items){
      taActiveInput = inputEl;
      globalTA.innerHTML = items.map(r=>`<button data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`).join('');
      [...globalTA.querySelectorAll('button')].forEach(b=>{
        b.addEventListener('click', ()=>{
          const picked = { lat: parseFloat(b.dataset.lat), lng: parseFloat(b.dataset.lon), label: b.textContent };
          taActiveInput.dispatchEvent(new CustomEvent('typeahead:pick',{detail:picked}));
          hideTypeahead();
        }, {once:true});
      });
      placeTypeaheadBelow(inputEl);
      globalTA.classList.add('open');
      if (!taOutsideHandler){
        taOutsideHandler = (e)=>{ if (e.target!==globalTA && e.target!==taActiveInput && !globalTA.contains(e.target)) hideTypeahead(); };
        document.addEventListener('mousedown', taOutsideHandler);
        document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') hideTypeahead(); }, {once:true});
      }
      if (!taScrollHandler){
        taScrollHandler = ()=>{ if (taActiveInput) placeTypeaheadBelow(taActiveInput); };
        window.addEventListener('scroll', taScrollHandler, true);
        window.addEventListener('resize', taScrollHandler);
      }
    }
    function hideTypeahead(){
      globalTA.classList.remove('open');
      globalTA.innerHTML='';
      taActiveInput = null;
      if (taOutsideHandler){ document.removeEventListener('mousedown', taOutsideHandler); taOutsideHandler=null; }
      if (taScrollHandler){ window.removeEventListener('scroll', taScrollHandler, true); window.removeEventListener('resize', taScrollHandler); taScrollHandler=null; }
    }
    async function doSearchForInput(inputEl){
      const q = (inputEl.value||'').trim();
      if (!q) return;
      try{
        const url=`https://nominatim.openstreetmap.org/search?format=json&limit=8&q=${encodeURIComponent(q)}`;
        const res=await fetch(url);
        const arr=await res.json();
        if (Array.isArray(arr) && arr.length) showTypeaheadFor(inputEl, arr);
        else hideTypeahead();
      }catch{ hideTypeahead(); }
    }
    function bindTypeahead(inputEl, onPick){
      let timer=null;
      inputEl.addEventListener('input', ()=>{
        const q = inputEl.value.trim();
        clearTimeout(timer);
        if (!q){ hideTypeahead(); return; }
        timer = setTimeout(()=> doSearchForInput(inputEl), 220);
      });
      inputEl.addEventListener('typeahead:pick', (ev)=> onPick(ev.detail));
    }

    bindTypeahead(addrInput, (p)=>{
      addrInput.value=p.label;
      if(!addrMap){
        addrMap = L.map(addrMapDiv).setView([p.lat,p.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap);
      }
      if(!addrMarker) addrMarker = L.marker([p.lat,p.lng]).addTo(addrMap);
      else addrMarker.setLatLng([p.lat,p.lng]);
      addrMarker._data = p;
      addrMap.setView([p.lat,p.lng], 15);
      addrMap.invalidateSize();
    });
    addrSearchBtn.addEventListener('click', ()=> doSearchForInput(addrInput));

    function setRoutePoint(idx,p){
      if(!routeMap){
        routeMap = L.map(rMapDiv).setView([p.lat,p.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
      }
      if(!routeMarkers[idx]) routeMarkers[idx]=L.marker([p.lat,p.lng]).addTo(routeMap);
      else routeMarkers[idx].setLatLng([p.lat,p.lng]);
      routeMarkers[idx]._data=p;
      routeMap.setView([p.lat,p.lng], 13);
      routeMap.invalidateSize();
    }
    bindTypeahead(rFrom, (p)=>{ rFrom.value=p.label; setRoutePoint(0,p); });
    bindTypeahead(rTo,   (p)=>{ rTo.value=p.label;   setRoutePoint(1,p); });
    rFromSearch.addEventListener('click', ()=> doSearchForInput(rFrom));
    rToSearch  .addEventListener('click', ()=> doSearchForInput(rTo));

    rCalc.addEventListener('click', async ()=>{
      if (!routeMarkers[0]?._data || !routeMarkers[1]?._data) return alert('×‘×—×¨ ×’× ××•×¦× ×•×’× ×™×¢×“.');
      const a=routeMarkers[0]._data, b=routeMarkers[1]._data;
      const profile = (rMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        rTime.textContent=`×–××Ÿ ××©×•×¢×¨: ${mins} ×“×§×³`;
        if (routeLayer) routeMap.removeLayer(routeLayer);
        routeLayer=L.geoJSON(r.geometry).addTo(routeMap);
        routeMap.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
        routeMap.invalidateSize();
      } else rTime.textContent='×œ× × ××¦× ××¡×œ×•×œ.';
    });

    // Hotel helpers
    async function findAllHotelsForDate(ddmmyyyy) {
        const qSnap = await getDocs(collection(db, 'trips', tripId, 'logistics'));
        const allHotels = qSnap.docs.map(d => ({ id: d.id, ...d.data() })).filter(x => x.type === 'hotel');
        const inRange = (range) => expandRange(range || '').includes(ddmmyyyy);
        const hotelsForDate = allHotels.filter(h => inRange(h.dates));
        return hotelsForDate;
    }

    function openHotelSelectModal(hotels, callback) {
        hotelSelectCallback = callback;
        hotelSelectDropdown._hotels = hotels;
        hotelSelectDropdown.innerHTML = hotels.map(h => 
            `<option value="${h.id}">${h.name || '××œ×•×Ÿ ×œ×œ× ×©×'} (${h.destination || '×™×¢×“ ×œ× ×¦×•×™×Ÿ'})</option>`
        ).join('');
        hotelSelectModal.classList.add('show');
    }

    function applyHotelAddress(hotel, inputEl, map, currentMarker) {
        if (!hotel) return currentMarker;
        inputEl.value = hotel.address || hotel.name || '';
        const c = hotel.coords || hotel.location || null;
        let newMarker = currentMarker;
        if (c?.lat && c?.lng){
            if(!newMarker) {
                if(!map){
                  // fallback - should not really happen because we init maps before
                }
                newMarker = L.marker([c.lat,c.lng]).addTo(map);
            } else {
                newMarker.setLatLng([c.lat,c.lng]);
            }
            newMarker._data = {label:inputEl.value, lat:c.lat, lng:c.lng};
            map.setView([c.lat,c.lng], 15);
            map.invalidateSize();
        }
        return newMarker;
    }

    async function handleUseHotelAddress(addrInputEl, mapInstance, markerInstance, markerUpdateCallback) {
        const hotels = await findAllHotelsForDate(selectedDate);
        if (hotels.length === 0) {
            alert('××™×Ÿ ××œ×•×Ÿ ××•×’×“×¨ ×œ×ª××¨×™×š ×–×”.');
            return;
        }
        if (hotels.length === 1) {
            const newMarker = applyHotelAddress(hotels[0], addrInputEl, mapInstance, markerInstance);
            markerUpdateCallback(newMarker);
        } else {
            openHotelSelectModal(hotels, (selectedHotel) => {
                const newMarker = applyHotelAddress(selectedHotel, addrInputEl, mapInstance, markerInstance);
                markerUpdateCallback(newMarker);
            });
        }
    }

    hotelSelectSave.addEventListener('click', () => {
        if (hotelSelectCallback && hotelSelectDropdown._hotels) {
            const selectedId = hotelSelectDropdown.value;
            const selectedHotel = hotelSelectDropdown._hotels.find(h => h.id === selectedId);
            if (selectedHotel) {
                hotelSelectCallback(selectedHotel);
            }
        }
        hotelSelectModal.classList.remove('show');
        hotelSelectCallback = null;
        hotelSelectDropdown._hotels = null;
    });

    hotelSelectCancel.addEventListener('click', () => {
        hotelSelectModal.classList.remove('show');
        hotelSelectCallback = null;
        hotelSelectDropdown._hotels = null;
    });

    useHotelBtn.addEventListener('click', () => {
        handleUseHotelAddress(addrInput, addrMap, addrMarker, (newMarker) => { addrMarker = newMarker; });
    });
    
    function renderSelectedRefs(){
      selectedRefsWrap.innerHTML = selectedRefs.length ? selectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm">×œ× × ×‘×—×¨×• ×§×™×©×•×¨×™×.</span>`;
      selectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          selectedRefs.splice(idx,1);
          renderSelectedRefs();
        });
      });
    }

    function iconForRef(r){
      if (r.type==='logistics'){
        if (r.subType==='hotel') return 'ğŸ¨';
        if (r.subType==='flight') return 'âœˆï¸';
        if (r.subType==='train') return 'ğŸš†';
        if (r.subType==='car_rental') return 'ğŸš—';
        if (r.subType==='ferry') return 'â›´ï¸';
        return 'â¬…ï¸';
      }
      if (r.type==='place'){
        return 'ğŸ“';
      }
      return 'ğŸ“';
    }
    
    async function buildConnectLists(targetListsEl, selectedRefsArr){
      targetListsEl.innerHTML='×˜×•×¢×Ÿ...';
      
      // ×œ×•×’×™×¡×˜×™×§×”
      const logSnap = await getDocs(collection(db,'trips',tripId,'logistics'));
      const logistics = logSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // ××˜×¨×§×¦×™×•×ª/××•×›×œ ×‘×™×¢×“ ×”×¤×¢×™×œ
      if (!selectedDestName) {
        targetListsEl.innerHTML = '<div class="text-red-600">×©×’×™××”: ×œ× × ×‘×—×¨ ×™×¢×“. ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××˜×¨×§×¦×™×•×ª.</div>';
        return;
      }
      
      const placesQuery = query(
        collection(db, 'trips', tripId, 'places'),
        where("destination", "==", selectedDestName)
      );
      const placesSnap = await getDocs(placesQuery);
      const places = placesSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // Mobile-friendly card design with better wrapping and larger touch target
      const card = (title, sub, openHref, picked=false)=>`
        <div class="relative p-3 rounded-xl border bg-white shadow-sm hover:shadow-md transition-shadow">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
             <div class="flex-1 min-w-0">
                <div class="font-bold text-slate-800 break-words whitespace-normal text-base">${title}</div>
                ${sub ? `<div class="text-xs text-slate-500 mt-1 break-words">${sub}</div>` : ''}
             </div>
             <div class="flex items-center gap-3 shrink-0 self-end sm:self-auto w-full sm:w-auto justify-end">
                <a href="${openHref}" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-2 py-1" target="_blank">×¤×ª×—</a>
                <button class="px-4 py-2 rounded-lg text-sm font-bold transition-all pick-btn ${picked ? 'bg-green-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200'}">
                   ${picked ? '<i class="fa-solid fa-check"></i> × ×‘×—×¨' : '×‘×—×¨'}
                </button>
             </div>
          </div>
        </div>`;

      let html='';

      if (logistics.length){
        html+=`<div><div class="font-bold mb-2 text-lg text-slate-800">××¢×‘×¨×™× ×•××œ×•× ×•×ª</div><div class="grid gap-3">`;
        html+= logistics.map(l=>{
          const label = (l.type==='hotel'?'××œ×•×Ÿ: ':'') + (l.name||l.destination||l.type);
          const sub   = l.dates || l.date || '';
          const href  = `summary.html?id=${tripId}&open=logistics&id=${l.id}`;
          const picked= selectedRefsArr.some(r=>r.type==='logistics' && r.id===l.id);
          return `<div data-ref-type="logistics" data-ref-id="${l.id}" data-ref-subtype="${l.type}" data-ref-label="${label}">${card(iconForRef({type:'logistics',subType:l.type})+' '+label, sub, href, picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      
      if (places.length){
        html+=`<div class="mt-6"><div class="font-bold mb-2 text-lg text-slate-800">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª (×¨×§ ×: ${selectedDestName})</div><div class="grid gap-3">`;
        html+= places.map(p=>{
          const label = p.name || '×¤×¨×™×˜';
          const sub   = p.type || p.destination || '';
          const href  = `attractions.html?id=${tripId}&open=place&id=${p.id}`;
          const picked= selectedRefsArr.some(r=>r.type==='place' && r.id===p.id);
          return `<div data-ref-type="place" data-ref-id="${p.id}" data-ref-subtype="${p.type}" data-ref-label="${label}">${card('ğŸ“ '+label, sub, href, picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      
      targetListsEl.innerHTML = html || '<div class="text-slate-500 py-4 text-center bg-slate-50 rounded-lg">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</div>';

      targetListsEl.querySelectorAll('.pick-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const wrap=btn.closest('[data-ref-type]');
          const type=wrap.dataset.refType;
          const id  =wrap.dataset.refId;
          const subType = wrap.dataset.refSubtype || null;
          const label=wrap.dataset.refLabel;
          const page = type === 'logistics' ? 'summary' : 'places'; 
          
          const existed = selectedRefsArr.findIndex(r=>r.type===type && r.id===id);
          if (existed>-1){
            selectedRefsArr.splice(existed,1);
            btn.innerHTML='×‘×—×¨';
            btn.className = 'px-4 py-2 rounded-lg text-sm font-bold transition-all pick-btn bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200';
          } else {
            selectedRefsArr.push({type, id, label, page, subType});
            btn.innerHTML='<i class="fa-solid fa-check"></i> × ×‘×—×¨';
            btn.className = 'px-4 py-2 rounded-lg text-sm font-bold transition-all pick-btn bg-green-600 text-white shadow-md';
          }
          if (targetListsEl===connectLists) renderSelectedRefs();
          else renderVSelectedRefs();
        });
      });
    }

    document.querySelector('[data-open="#block-connect"]').addEventListener('click', async ()=>{
      const el=document.querySelector('#block-connect');
      setTimeout(async ()=>{
        if (!el.classList.contains('hidden')) await buildConnectLists(connectLists, selectedRefs);
      }, 0);
    });

    saveBtn.addEventListener('click', async ()=>{
      const payload = collectItemFromModal();
      await saveItemCore(payload, editingItemId);
      itemModal.classList.remove('show');
      hideTypeahead();
      editingItemId = null;
    });

    function collectItemFromModal(){
      const addrData = addrMarker?._data
        ? { label: addrMarker._data.label, lat: addrMarker._data.lat, lng: addrMarker._data.lng }
        : (addrInput.value.trim()? { label: addrInput.value.trim(), lat:null, lng:null } : null);

      const travelFrom = routeMarkers[0]?._data
        ? routeMarkers[0]._data
        : (rFrom.value.trim()? {label:rFrom.value.trim(), lat:null, lng:null}: null);

      const travelTo   = routeMarkers[1]?._data
        ? routeMarkers[1]._data
        : (rTo.value.trim()? {label:rTo.value.trim(), lat:null, lng:null}: null);

      const refsCopy = selectedRefs.slice();

      return {
        title: (inputItemTitle.value||'').trim() || '(×œ×œ× ×›×•×ª×¨×ª)',
        startTime: inputStart.value || null,
        endTime:   inputEnd.value   || null,
        description: (inputDesc.value||'').trim() || null,
        summary:     (inputSummary.value||'').trim() || null,
        notes:       (inputNotes.value||'').trim() || null,
        links: { site:(linkGeneral.value||'').trim() || null, booking:(linkBook.value||'').trim() || null },
        address: addrData,
        travel: (travelFrom || travelTo) ? { from: travelFrom, to: travelTo, mode: rMode.value, timeText: rTime.textContent || null } : null,
        refs: refsCopy,
        requiresRefs: !!requiresRefsFlag
      };
    }

    async function saveItemCore(payload, editId=null, extraFlags={}){
      await setDoc(dayDocRef,{ title: dayTitle || null, updatedAt: serverTimestamp() },{merge:true});
      const thisSort = minutesFromHHMM(payload.startTime||'00:00');
      const needsVerifyAddress = !!(payload.address && !(payload.address.lat!=null && payload.address.lng!=null));
      const needsVerifyRoute   = !!(payload.travel && !((payload.travel.from?.lat!=null) && (payload.travel.to?.lat!=null)));
      const needsVerifyRefs    = !!(payload.requiresRefs && (!Array.isArray(payload.refs) || payload.refs.length===0));
      const base = {
        ...payload,
        sort:thisSort,
        date:selectedDate,
        destination:selectedDestName,
        updatedAt: serverTimestamp(),
        needsVerifyAddress,
        needsVerifyRoute,
        needsVerifyRefs,
        ...extraFlags
      };
      if (editId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',editId), base);
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'items'), {
          ...base,
          createdAt: serverTimestamp()
        });
      }
      await recomputeDistances();
    }

    async function recomputeDistances(){
      const snap = await getDocs(query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc')));
      const arr = snap.docs.map(d=>({id:d.id,...d.data()}));
      for (let i=0;i<arr.length;i++){
        let dist=null;
        const a = arr[i-1], b=arr[i];
        if (a?.address?.lat!=null && b?.address?.lat!=null){
          dist = Math.round(haversineMeters({lat:a.address.lat,lng:a.address.lng},{lat:b.address.lat,lng:b.address.lng}));
        }
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',b.id), { distanceFromPreviousMeters: dist });
      }
    }

    // ×™×¦×™×¨×ª ×›×¨×˜×™×¡ "×—×–×¨×” ×œ××œ×•×Ÿ"
    addBackHotel.addEventListener('click', async () => {
        if (!inputStart.value) return alert('×‘×—×¨ ×©×¢×ª ×”×ª×—×œ×” ×œ×—×–×¨×” ×œ××œ×•×Ÿ.');
        const hotels = await findAllHotelsForDate(selectedDate);
        if (hotels.length === 0) {
            return alert('×œ× × ××¦× ××œ×•×Ÿ ×œ×ª××¨×™×š ×–×”.');
        }

        const processHotelSelection = async (h) => {
            await saveItemCore({
                title: '×—×–×¨×” ×œ××œ×•×Ÿ',
                startTime: inputStart.value, endTime: null,
                summary: '×¡×™×•× ×”×™×•× ×•×—×–×¨×” ×œ××œ×•×Ÿ',
                address: h.address ? { label: h.address, lat: h.coords?.lat ?? null, lng: h.coords?.lng ?? null } : null,
                isBackToHotel: true,
                refs: [],
                requiresRefs: false
            }, null);
            itemModal.classList.remove('show');
            hideTypeahead();
        };

        if (hotels.length === 1) {
            await processHotelSelection(hotels[0]);
        } else {
            openHotelSelectModal(hotels, (selectedHotel) => {
                processHotelSelection(selectedHotel);
            });
        }
    });

    // ×¤×ª×™×—×ª/×¡×’×™×¨×ª ×‘×œ×•×§×™× ×‘×ª×•×š ×¤×¨×™×˜
    openBlockBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const el=document.querySelector(b.dataset.open);
        el.classList.toggle('hidden');
        if (el.id==='block-address') setTimeout(()=>{ if(addrMap) addrMap.invalidateSize(); },100);
        if (el.id==='block-route') setTimeout(()=>{ if(routeMap) routeMap.invalidateSize(); },100);
      });
    });

    // ×¡×’×™×¨×ª ××•×“×œ ×¦×¤×™×™×”
    viewClose.addEventListener('click', ()=> viewModal.classList.remove('show'));

    // ×¤×ª×™×—×ª ××•×“×œ AI
    aiBuildBtn.addEventListener('click', ()=>{
      aiInput.value='';
      aiPreview.classList.add('hidden');
      aiCreate.disabled = true;
      aiModal.classList.add('show');
    });
    aiClose.addEventListener('click', ()=> aiModal.classList.remove('show'));

    function parseAiText(raw){
      const lines = (raw||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const result = { dayTitle:null, items:[] };
      let cur = null;
      const startItem = (title=null)=>{
        if (cur) result.items.push(finalize(cur));
        cur = {
          title: title, startTime: null, endTime: null, descParts: [], address: null,
          addressFromHotel:false, linkSite: null, linkBook: null,
          travel: { from:null, to:null, mode:'driving', timeText:null },
          wantsRefs:false, summary:null, notes:null, isBackToHotel:false
        };
      };
      const finalize = (o)=>{
        return {
          title: o.title || (o.isBackToHotel?'×—×–×¨×” ×œ××œ×•×Ÿ':'(×œ×œ× ×›×•×ª×¨×ª)'),
          startTime: o.startTime || null, endTime: o.endTime || null,
          description: o.descParts.length ? o.descParts.join('\n') : null,
          address: o.addressFromHotel ? { isHotel:true } : (o.address? {label:o.address} : null),
          links: { site: o.linkSite || null, booking: o.linkBook || null },
          travel: (o.travel.from || o.travel.to) ? {
            from: o.travel.from==='HOTEL' ? {isHotel:true} : (o.travel.from? {label:o.travel.from}: null),
            to:   o.travel.to==='HOTEL'   ? {isHotel:true} : (o.travel.to? {label:o.travel.to}: null),
            mode: o.travel.mode || 'driving', timeText: null
          } : null,
          wantsRefs: !!o.wantsRefs, summary: o.summary || null, notes: o.notes || null, isBackToHotel: !!o.isBackToHotel
        };
      };
      const m = {
        dayTitle: /^!(.+)!$/, itemTitle: /^×´(.+?)×´$/, start: /^\/\s*([^\/]+?)\s*\/$/, end: /^\\\s*([^\\]+?)\s*\\$/,
        backHotel: /^â‚ª$/, desc: /^:\s*(.+?)\s*:$/, addressHotel: /^×³â‚ª(?:\b|$)/, address: /^×³(.+?)×³$/,
        linkSite: /^\?\s*(.+?)\s*\?$/, linkBook: /^\$\s*(.+?)\s*\$$/, routeFrom: /^>\s*(.+)$/, routeTo: /^<\s*(.+)$/,
        refs: /^\*$/, summary: /^â€¢\s*(.+?)\s*â€¢$/, notes: /^~\s*(.+?)\s*~$/
      };
      const parseRouteSide = (txt)=>{
        const t = txt.trim();
        if (/^×³â‚ª/.test(t)) return 'HOTEL';
        const adr = t.match(m.address);
        if (adr) return adr[1].trim();
        return t;
      };
      for (const line of lines){
        if (m.dayTitle.test(line)){ result.dayTitle = line.match(m.dayTitle)[1].trim(); continue; }
        if (m.itemTitle.test(line)){ startItem(line.match(m.itemTitle)[1].trim()); continue; }
        if (!cur) startItem();
        if (m.start.test(line)){ cur.startTime = line.match(m.start)[1].trim(); continue; }
        if (m.end.test(line)){ cur.endTime = line.match(m.end)[1].trim(); continue; }
        if (m.backHotel.test(line)){ cur.isBackToHotel = true; if(!cur.title) cur.title='×—×–×¨×” ×œ××œ×•×Ÿ'; continue; }
        if (m.desc.test(line)){ cur.descParts.push(line.match(m.desc)[1]); continue; }
        if (m.addressHotel.test(line)){ cur.addressFromHotel = true; continue; }
        if (m.address.test(line)){ cur.address = line.match(m.address)[1].trim(); continue; }
        if (m.linkSite.test(line)){ cur.linkSite = line.match(m.linkSite)[1].trim(); continue; }
        if (m.linkBook.test(line)){ cur.linkBook = line.match(m.linkBook)[1].trim(); continue; }
        if (m.routeFrom.test(line)){ cur.travel.from = parseRouteSide(line.match(m.routeFrom)[1]); continue; }
        if (m.routeTo.test(line)){ cur.travel.to   = parseRouteSide(line.match(m.routeTo)[1]); continue; }
        if (m.refs.test(line)){ cur.wantsRefs = true; continue; }
        if (m.summary.test(line)){ cur.summary = line.match(m.summary)[1].trim(); continue; }
        if (m.notes.test(line)){ cur.notes = line.match(m.notes)[1].trim(); continue; }
        cur.descParts.push(line);
      }
      if (cur) result.items.push(finalize(cur));
      return result;
    }

    aiParse.addEventListener('click', ()=>{
      const parsed = parseAiText(aiInput.value);
      const rows = [];
      if (parsed.dayTitle) rows.push(`<div class="text-slate-800"><b>×›×•×ª×¨×ª ×™×•×:</b> ${parsed.dayTitle}</div>`);
      rows.push(`<div class="text-slate-800"><b>×›××•×ª ×¤×¨×™×˜×™×:</b> ${parsed.items.length}</div>`);
      parsed.items.forEach((it, i)=>{
        const needsAddr = !!(it.address);
        const needsRoute = !!(it.travel);
        const needsRefs = !!(it.wantsRefs);
        rows.push(`
          <div class="border rounded-lg p-2">
            <div><b>${i+1}.</b> ${it.title}</div>
            <div class="text-xs text-slate-600">${[it.startTime, it.endTime?('â€“ '+it.endTime):''].filter(Boolean).join(' ') || '×œ×œ× ×©×¢×•×ª'}</div>
            ${it.summary?`<div class="text-xs">${it.summary}</div>`:''}
            ${needsAddr?`<div class="text-xs text-red-700">â€¢ ×™×¦×•×™×Ÿ ××™××•×ª ×›×ª×•×‘×ª</div>`:''}
            ${needsRoute?`<div class="text-xs text-red-700">â€¢ ×™×¦×•×™×Ÿ ××™××•×ª ××¡×œ×•×œ</div>`:''}
            ${needsRefs?`<div class="text-xs text-red-700">â€¢ ×™×¦×•×™×Ÿ ×§×™×©×•×¨ ×œ××˜×¨×§×¦×™×•×ª/××¢×‘×¨×™×</div>`:''}
          </div>
        `);
      });
      aiPreviewContent.innerHTML = rows.join('');
      aiPreview.classList.remove('hidden');
      aiCreate.disabled = parsed.items.length===0;
      aiCreate._parsed = parsed;
    });

    aiCreate.addEventListener('click', async () => {
        const parsed = aiCreate._parsed;
        if (!parsed) return;
        aiCreate.disabled = true;
        aiLoaderOverlay.classList.remove('hidden');
        const btnText = aiCreate.querySelector('.btn-text');
        const btnLoader = aiCreate.querySelector('.loader');
        btnText.textContent = '×™×•×¦×¨ ×œ×•"×–...';
        btnLoader.classList.remove('hidden');
        try {
            if (parsed.dayTitle) {
                await setDoc(dayDocRef, { title: parsed.dayTitle, updatedAt: serverTimestamp() }, { merge: true });
                dayTitle = parsed.dayTitle;
                reflectDayTitleUI();
            }
            const allHotelsForDate = await findAllHotelsForDate(selectedDate);
            const hotel = allHotelsForDate.length === 1 ? allHotelsForDate[0] : null;

            for (const it of parsed.items) {
                const payload = {
                    title: it.title || '(×œ×œ× ×›×•×ª×¨×ª)',
                    startTime: it.startTime || null,
                    endTime: it.endTime || null,
                    description: it.description || null,
                    summary: it.summary || null,
                    notes: it.notes || null,
                    links: { site: it.links?.site || null, booking: it.links?.booking || null },
                    address: null,
                    travel: null,
                    refs: [],
                    requiresRefs: !!it.wantsRefs
                };
                if (it.address) {
                    if (it.address.isHotel && hotel) {
                        payload.address = { label: hotel.address || hotel.name || '××œ×•×Ÿ', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null };
                    } else if (it.address.isHotel && !hotel) {
                        payload.address = { label: '×›×ª×•×‘×ª ×”××œ×•×Ÿ', lat: null, lng: null };
                    } else {
                        payload.address = { label: it.address.label || it.address, lat: null, lng: null };
                    }
                }
                if (it.travel) {
                    const from = it.travel.from;
                    const to = it.travel.to;
                    const mode = it.travel.mode || 'driving';
                    const fromPt = (from && from.isHotel && hotel) ? { label: hotel.address || hotel.name || '××œ×•×Ÿ', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null }
                        : (from && from.isHotel && !hotel) ? { label: '×›×ª×•×‘×ª ×”××œ×•×Ÿ', lat: null, lng: null }
                        : (from ? { label: from.label || from, lat: null, lng: null } : null);
                    const toPt = (to && to.isHotel && hotel) ? { label: hotel.address || hotel.name || '××œ×•×Ÿ', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null }
                        : (to && to.isHotel && !hotel) ? { label: '×›×ª×•×‘×ª ×”××œ×•×Ÿ', lat: null, lng: null }
                        : (to ? { label: to.label || to, lat: null, lng: null } : null);
                    payload.travel = (fromPt || toPt) ? { from: fromPt, to: toPt, mode, timeText: null } : null;
                }
                await new Promise(resolve => setTimeout(resolve, 50)); 
                await saveItemCore(payload, null, { source: 'ai' });
            }
            aiModal.classList.remove('show');
        } catch (error) {
            console.error("Error creating schedule from AI:", error);
            alert("××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×œ×•\"×–. × ×¡×” ×©×•×‘.");
        } finally {
            aiLoaderOverlay.classList.add('hidden');
            btnText.textContent = '×¦×•×¨ ×œ×•×–';
            btnLoader.classList.add('hidden');
            aiCreate.disabled = !aiCreate._parsed || aiCreate._parsed.items.length === 0;
        }
    });

    function renderVSelectedRefs(){
      vSelectedRefsWrap.innerHTML = vSelectedRefs.length ? vSelectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm">×œ× × ×‘×—×¨×• ×§×™×©×•×¨×™×.</span>`;
      vSelectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          vSelectedRefs.splice(idx,1);
          renderVSelectedRefs();
        });
      });
    }

    async function openVerifyModal(item){
      vCurrentItem = item;
      vTitle.textContent = item.title || '(×œ×œ× ×›×•×ª×¨×ª)';

      const needAddr = !!item.needsVerifyAddress;
      const needRoute= !!item.needsVerifyRoute;
      const needRefs = !!item.needsVerifyRefs;

      vBlockAddr.classList.toggle('hidden', !needAddr);
      vBlockRoute.classList.toggle('hidden', !needRoute);
      vBlockRefs.classList.toggle('hidden', !needRefs);

      if (needAddr){
        if (!vAddrMap){
          vAddrMap = L.map(vAddrMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vAddrMap);
        }
        if (vAddrMarker){ vAddrMap.removeLayer(vAddrMarker); vAddrMarker=null; }
        vAddrInput.value = item.address?.label || '';
        if (item.address?.lat && item.address?.lng){
          vAddrMarker = L.marker([item.address.lat,item.address.lng]).addTo(vAddrMap);
          vAddrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
          vAddrMap.setView([item.address.lat,item.address.lng], 14);
        }
      }

      if (needRoute){
        if (!vRouteMap){
          vRouteMap = L.map(vRouteMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vRouteMap);
        }
        if (vRouteLayer){ vRouteMap.removeLayer(vRouteLayer); vRouteLayer=null; }
        vRouteMarkers.forEach(m=> m && vRouteMap.removeLayer(m));
        vRouteMarkers=[null,null];

        vRouteFrom.value = item.travel?.from?.label || '';
        vRouteTo.value   = item.travel?.to?.label   || '';
        vRouteMode.value = item.travel?.mode || 'driving';
        vRouteTime.textContent = item.travel?.timeText || '';

        if (item.travel?.from?.lat){
          vRouteMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(vRouteMap);
          vRouteMarkers[0]._data = item.travel.from;
        }
        if (item.travel?.to?.lat){
          vRouteMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(vRouteMap);
          vRouteMarkers[1]._data = item.travel.to;
        }
        if (vRouteMarkers[0] && vRouteMarkers[1]) {
          vRouteMap.fitBounds(L.featureGroup(vRouteMarkers).getBounds(),{padding:[20,20]});
        }
      }

      vSelectedRefs = Array.isArray(item.refs) ? [...item.refs] : [];
      if (needRefs){
        renderVSelectedRefs();
        await buildConnectLists(vConnectLists, vSelectedRefs);
      }

      vModal.classList.add('show');

      // invalidate maps for proper rendering (×× ×™×¢×ª ××¤×” ××¤×•×¨×”)
      setTimeout(()=>{
        if(needAddr && vAddrMap) vAddrMap.invalidateSize();
        if(needRoute && vRouteMap) vRouteMap.invalidateSize();
      },160);
    }

    vClose.addEventListener('click', ()=> vModal.classList.remove('show'));
    vCancel.addEventListener('click', ()=> vModal.classList.remove('show'));

    bindTypeahead(vAddrInput, (p)=>{
      vAddrInput.value=p.label;
      if(!vAddrMap){
        vAddrMap = L.map(vAddrMapDiv).setView([p.lat,p.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vAddrMap);
      }
      if(!vAddrMarker) vAddrMarker = L.marker([p.lat,p.lng]).addTo(vAddrMap);
      else vAddrMarker.setLatLng([p.lat,p.lng]);
      vAddrMarker._data = p;
      vAddrMap.setView([p.lat,p.lng], 15);
      vAddrMap.invalidateSize();
    });
    vAddrSearch.addEventListener('click', ()=> doSearchForInput(vAddrInput));

    function vSetRoutePoint(idx,p){
      if(!vRouteMap){
        vRouteMap = L.map(vRouteMapDiv).setView([p.lat,p.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vRouteMap);
      }
      if(!vRouteMarkers[idx]) vRouteMarkers[idx]=L.marker([p.lat,p.lng]).addTo(vRouteMap);
      else vRouteMarkers[idx].setLatLng([p.lat,p.lng]);
      vRouteMarkers[idx]._data=p;
      vRouteMap.setView([p.lat,p.lng], 13);
      vRouteMap.invalidateSize();
    }
    bindTypeahead(vRouteFrom, (p)=>{ vRouteFrom.value=p.label; vSetRoutePoint(0,p); });
    bindTypeahead(vRouteTo,   (p)=>{ vRouteTo.value=p.label; vSetRoutePoint(1,p); });
    vRouteFromSearch.addEventListener('click', ()=> doSearchForInput(vRouteFrom));
    vRouteToSearch  .addEventListener('click', ()=> doSearchForInput(vRouteTo));

    vRouteCalc.addEventListener('click', async ()=>{
      if (!vRouteMarkers[0]?._data || !vRouteMarkers[1]?._data) return alert('×‘×—×¨ ×’× ××•×¦× ×•×’× ×™×¢×“.');
      const a=vRouteMarkers[0]._data, b=vRouteMarkers[1]._data;
      const profile = (vRouteMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        vRouteTime.textContent=`×–××Ÿ ××©×•×¢×¨: ${mins} ×“×§×³`;
        if (vRouteLayer) vRouteMap.removeLayer(vRouteLayer);
        vRouteLayer=L.geoJSON(r.geometry).addTo(vRouteMap);
        vRouteMap.fitBounds(vRouteLayer.getBounds(),{padding:[20,20]});
        vRouteMap.invalidateSize();
      } else vRouteTime.textContent='×œ× × ××¦× ××¡×œ×•×œ.';
    });

    vUseHotel.addEventListener('click', () => {
        handleUseHotelAddress(vAddrInput, vAddrMap, vAddrMarker, (newMarker) => { vAddrMarker = newMarker; });
    });

    vSave.addEventListener('click', async ()=>{
      if (!vCurrentItem) return;

      let newAddress = vCurrentItem.address || null;
      let newTravel  = vCurrentItem.travel  || null;
      let newRefs    = Array.isArray(vSelectedRefs)? vSelectedRefs : [];

      if (!vBlockAddr.classList.contains('hidden')){
        if (vAddrMarker?._data){
          newAddress = { label: vAddrMarker._data.label, lat: vAddrMarker._data.lat, lng: vAddrMarker._data.lng };
        } else if (vAddrInput.value.trim()){
          newAddress = { label: vAddrInput.value.trim(), lat: null, lng: null };
        } else {
          newAddress = null;
        }
      }

      if (!vBlockRoute.classList.contains('hidden')){
        const from = vRouteMarkers[0]?._data
          ? {label:vRouteMarkers[0]._data.label, lat:vRouteMarkers[0]._data.lat, lng:vRouteMarkers[0]._data.lng}
          : (vRouteFrom.value.trim()? {label:vRouteFrom.value.trim(), lat:null, lng:null}: null);
        const to   = vRouteMarkers[1]?._data
          ? {label:vRouteMarkers[1]._data.label, lat:vRouteMarkers[1]._data.lat, lng:vRouteMarkers[1]._data.lng}
          : (vRouteTo.value.trim()? {label:vRouteTo.value.trim(), lat:null, lng:null}: null);

        newTravel = (from || to) ? { from, to, mode: vRouteMode.value, timeText: vRouteTime.textContent || null } : null;
      }

      const needsVerifyAddress = !!(newAddress && !(newAddress.lat!=null && newAddress.lng!=null));
      const needsVerifyRoute   = !!(newTravel && !((newTravel.from?.lat!=null) && (newTravel.to?.lat!=null)));
      const needsVerifyRefs    = !!(vCurrentItem.requiresRefs && (!Array.isArray(newRefs) || newRefs.length===0));

      await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',vCurrentItem.id), {
        address: newAddress || null,
        travel:  newTravel  || null,
        refs:    newRefs,
        needsVerifyAddress,
        needsVerifyRoute,
        needsVerifyRefs,
        updatedAt: serverTimestamp()
      });

      await recomputeDistances();

      vModal.classList.remove('show');

      // × ×‘×˜×™×— ×©×”××¤×” ×‘××¡×š ×¦×¤×™×™×” (×× ×™×¤×ª×— ××—×“×© ××™×“) ×œ× ×ª×”×™×” ××¤×•×¨×”
      setTimeout(()=>{
        if(viewMap) viewMap.invalidateSize();
      },150);
    });

    // ×¤×ª×™×—×ª ××•×“×œ ×¤×¨×™×˜ (×”×•×¡×¤×”/×¢×¨×™×›×”, ×•×’× ××™××•×ª ×××¡×š ×¦×¤×™×™×”)
    function openItemModal(item=null, opts={verify:false, focus:{address:false, route:false, refs:false}}){
      // === ×ª×™×§×•×Ÿ ×‘××’: ××™×¤×•×¡ ××¦×‘ ===
      // ×¡×•×’×¨×™× ××ª ×›×œ ×”×‘×œ×•×§×™× ×”× ×¤×ª×—×™× ×›×“×™ ×œ×”×‘×˜×™×— ×©×‘×¤×ª×™×—×” ×©×œ×”× ××—×“×© ×™×™×•×•×¦×¨×• ××™×¨×•×¢×™× ×¢×œ ×”××™×“×¢ ×”×—×“×©
      // ×•×× ×§×™× ××ª ×ª×•×›×Ÿ ×”-HTML ×©×œ ×¨×©×™××ª ×”××˜×¨×§×¦×™×•×ª ×›×“×™ ×œ× ×œ×”×¦×™×’ ××™×“×¢ ×™×©×Ÿ
      document.querySelectorAll('#block-address, #block-links, #block-book, #block-route, #block-connect')
        .forEach(el => el.classList.add('hidden'));
      connectLists.innerHTML = ''; // × ×™×§×•×™ ×”×¨×©×™××” ×”×™×©× ×” ×›×“×™ ×©×œ× ×™×”×™×• ×›×¤×ª×•×¨×™× "×ª×§×•×¢×™×"
      // ==========================

      editingItemId = item?.id || null;
      modalTitle.textContent = editingItemId ? '×¢×¨×™×›×ª ×¤×¨×™×˜' : '×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×™×•×';

      inputDayTitle.value = dayTitle || '';
      inputItemTitle.value = item?.title || '';
      inputStart.value = item?.startTime || '';
      inputEnd.value   = item?.endTime || '';
      inputDesc.value  = item?.description || '';
      inputSummary.value = item?.summary || '';
      inputNotes.value   = item?.notes || '';
      linkGeneral.value  = item?.links?.site || '';
      linkBook.value     = item?.links?.booking || '';

      endWrap.classList.toggle('hidden', !item?.endTime);

      requiresRefsFlag = !!item?.requiresRefs;
      selectedRefs = Array.isArray(item?.refs) ? [...item.refs] : [];
      renderSelectedRefs();

      if (!addrMap){
        addrMap = L.map(addrMapDiv).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap);
      }
      if (addrMarker){ addrMap.removeLayer(addrMarker); addrMarker=null; }
      addrInput.value = item?.address?.label || '';
      if (item?.address?.lat && item?.address?.lng){
        addrMarker = L.marker([item.address.lat,item.address.lng]).addTo(addrMap);
        addrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
        addrMap.setView([item.address.lat,item.address.lng], 14);
      }

      if (!routeMap){
        routeMap = L.map(rMapDiv).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
      }
      if (routeLayer){ routeMap.removeLayer(routeLayer); routeLayer=null; }
      routeMarkers.forEach(m=> m && routeMap.removeLayer(m));
      routeMarkers=[null,null];
      rFrom.value = item?.travel?.from?.label || '';
      rTo.value   = item?.travel?.to?.label   || '';
      rMode.value = item?.travel?.mode || 'driving';
      rTime.textContent = item?.travel?.timeText || '';
      if (item?.travel?.from?.lat){
        routeMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(routeMap);
        routeMarkers[0]._data = item.travel.from;
      }
      if (item?.travel?.to?.lat){
        routeMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(routeMap);
        routeMarkers[1]._data = item.travel.to;
      }
      if (routeMarkers[0] && routeMarkers[1]) {
        routeMap.fitBounds(L.featureGroup(routeMarkers).getBounds(),{padding:[20,20]});
      }

      const wantVerify = !!opts.verify;
      verifyBanner.classList.toggle('hidden', !wantVerify);

      showStep(wantVerify ? 'E' : (dayTitle ? 'B' : 'A'));

      itemModal.classList.add('show');

      // invalidate maps ×œ×× ×™×¢×ª ××¤×” ××¤×•×¨×”
      setTimeout(()=>{
        if(addrMap) addrMap.invalidateSize();
        if(routeMap) routeMap.invalidateSize();
      },160);
    }

    addItemBtn.addEventListener('click', ()=> openItemModal());
    closeModal.addEventListener('click', ()=> {
      itemModal.classList.remove('show');
      hideTypeahead();
    });
    
    // --- ×§×•×“ ××•×˜×•××˜×™ ×œ×—×¡×™××ª ×¨×§×¢ ×›×©×”××•×“×œ × ×¤×ª×— ---
    // ×–×” "×××–×™×Ÿ" ×œ×©×™× ×•×™×™× ×‘-DOM. ×× ××•×“×œ ××§×‘×œ class='show', ×”×’×œ×™×œ×” ×‘×¨×§×¢ × × ×¢×œ×ª.
    const observer = new MutationObserver((mutations) => {
        let isAnyModalOpen = false;
        document.querySelectorAll('.modal').forEach(m => {
            if (m.classList.contains('show')) isAnyModalOpen = true;
        });
        
        if (isAnyModalOpen) {
            document.body.classList.add('overflow-hidden'); // × ×•×¢×œ ××ª ×”×“×£
        } else {
            document.body.classList.remove('overflow-hidden'); // ××©×—×¨×¨ ××ª ×”×“×£
        }
    });

    // ××ª×—×™×œ ×œ×”××–×™×Ÿ ×œ×›×œ ×”××•×“××œ×™×
    document.querySelectorAll('.modal').forEach(modal => {
        observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
    });
    
  </script>
</body>
</html>