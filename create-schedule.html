<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- ××¤×” -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    body{font-family:'Assistant',sans-serif}
    .sheet{background:rgba(255,255,255,.92); backdrop-filter: blur(6px)}
    .submenu{max-height:0;overflow:hidden;transition:max-height .45s}
    .submenu.open{max-height:1200px}
    .fade{transition:opacity .2s}
    .modal{display:none}
    .modal.show{display:flex}
    .step{display:none}
    .step.active{display:block}
    .typeahead{position:absolute;z-index:20;inset-inline-start:0;inset-inline-end:0}
  </style>
</head>
<body class="min-h-screen">

  <!-- ×¨×§×¢ -->
  <div class="fixed inset-0 -z-10 bg-cover bg-center" style="background-image:url('https://images.unsplash.com/photo-1499591934245-40232654b021?q=80&w=2000&auto=format&fit=crop')"></div>
  <div class="fixed inset-0 -z-10 bg-black/40"></div>

  <!-- HEADER -->
  <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a id="back-to-day" href="#" class="p-2 text-slate-700 hover:text-blue-600" title="×—×–×¨×” ×œ×œ×•×– ×”×™×•××™">
            <i class="fa-solid fa-arrow-right"></i>
          </a>
          <h1 class="text-xl font-bold text-slate-800">×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</h1>
        </div>
        <div id="auth-slot" class="text-slate-700"></div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

    <!-- ×‘×—×™×¨×ª ×ª××¨×™×š/×™×¢×“ -->
    <section class="sheet rounded-2xl p-5 shadow">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div class="flex-1">
          <h2 class="text-2xl font-extrabold text-slate-900 mb-1">×‘×—×¨ ×ª××¨×™×š ×œ×™×•× ×”×¢×‘×•×“×”</h2>
          <p class="text-slate-600">×‘×¨×™×¨×ª ×”××—×“×œ â€” ×”×ª××¨×™×š ×©××× ×• ×”×’×¢×ª.</p>
        </div>

        <!-- ×ª×™×‘×” × ×¤×ª×—×ª -->
        <div class="w-full md:w-[420px]">
          <button id="date-toggle" class="w-full flex items-center justify-between bg-white p-3 rounded-xl border shadow hover:bg-slate-50">
            <span id="date-current" class="font-bold text-slate-700">×˜×•×¢×Ÿ...</span>
            <i class="fa-solid fa-chevron-down text-slate-500"></i>
          </button>
          <div id="date-panel" class="submenu bg-white rounded-xl border shadow mt-2 overflow-hidden">
            <div id="date-list" class="max-h-80 overflow-y-auto divide-y"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- ×›×•×ª×¨×ª ×›×œ×œ×™×ª ×©×œ ×”×™×•× -->
    <section class="sheet rounded-2xl p-5 shadow space-y-3">
      <div class="flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-900">×›×•×ª×¨×ª ×œ×™×•×</h3>
        <button id="edit-day-title" class="hidden text-slate-600 hover:text-blue-600" title="×¢×¨×™×›×ª ×›×•×ª×¨×ª">
          <i class="fa-solid fa-pen"></i>
        </button>
      </div>
      <div id="day-title-wrap">
        <div id="day-title-empty" class="text-slate-600">×¢×“×™×™×Ÿ ×œ× ×”×•×’×“×¨×” ×›×•×ª×¨×ª ×œ×™×•× ×–×”.</div>
        <div id="day-title-line" class="hidden flex items-center gap-2">
          <div id="day-title-text" class="font-bold text-blue-700"></div>
        </div>
      </div>
      <button id="set-day-title" class="inline-flex items-center gap-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
        <i class="fa-solid fa-heading"></i> ×§×‘×¢/×¢×“×›×Ÿ ×›×•×ª×¨×ª ×™×•×
      </button>
    </section>

    <!-- ×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×•×´×– -->
    <section class="sheet rounded-2xl p-5 shadow">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h3 class="text-xl font-bold text-slate-900">×¤×¨×™×˜×™ ×œ×•×´×– ×œ×™×•× ×–×”</h3>
        <button id="add-item-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg">
          <i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×œ×•×´×–
        </button>
      </div>
      <div id="items-list" class="mt-4 space-y-3">
        <div class="text-slate-500 p-6 text-center">××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>
      </div>
    </section>
  </main>

  <!-- MODAL ×™×¦×™×¨×ª ×¤×¨×™×˜ -->
  <div id="item-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/60">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-2xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 id="modal-title" class="text-lg font-bold">×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×™×•×</h4>
        <button id="close-modal" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>

      <main class="p-4 overflow-y-auto flex-1 space-y-5">
        <!-- ×©×œ×‘ 0: ×‘×—×¨ ×©×™×˜×” -->
        <div id="step-0" class="step">
          <h5 class="font-bold mb-3">××™×š ×ª×¨×¦×” ×œ×”×•×¡×™×£?</h5>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <button id="choose-manual" class="p-5 rounded-xl border hover:border-blue-500 hover:bg-blue-50 text-left">
              <div class="font-bold mb-1"><i class="fa-regular fa-keyboard mr-2"></i> ×™×“× ×™×ª</div>
              <div class="text-sm text-slate-600">×ª×’×“×™×¨ ×”×›×œ ×‘×¢×¦××š ×‘×©×œ×‘×™× ×§×¦×¨×™×.</div>
            </button>
            <button id="choose-ai" class="p-5 rounded-xl border hover:border-purple-500 hover:bg-purple-50 text-left">
              <div class="font-bold mb-1"><i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ×¢× AI</div>
              <div class="text-sm text-slate-600">× ×‘× ×” ×”×¦×¢×” ××•×˜×•××˜×™×ª ×œ×¤×™ ×”×™×¢×“ ×•×”×¢×“×¤×•×ª.</div>
            </button>
          </div>
          <p class="text-xs text-slate-500 mt-3">×”×‘×—×™×¨×” × ×©××¨×ª ×œ××—×©×‘ ×–×” ×‘×œ×‘×“ (××¤×©×¨ ×œ×©× ×•×ª ×‘×›×œ ×”×•×¡×¤×”).</p>
        </div>

        <!-- ×©×œ×‘ A: ×›×•×ª×¨×ª ×œ×™×•× (××•×¦×’ ×¨×§ ×× ××™×Ÿ) -->
        <div id="step-A" class="step">
          <label class="block font-bold mb-1">×›×•×ª×¨×ª ×›×œ×œ×™×ª ×œ×™×•×</label>
          <input id="input-day-title" type="text" class="w-full p-2 border rounded-lg" placeholder="×œ××©×œ: '×™×•× ××•×–×™××•× ×™× ×•××•×›×œ ×¨×—×•×‘'">
          <div class="text-xs text-slate-500 mt-2">×× ×›×‘×¨ ×§×™×™××ª ×›×•×ª×¨×ª â€“ × ×“×œ×’ ××•×˜×•××˜×™×ª.</div>
        </div>

        <!-- ×©×œ×‘ B: ×›×•×ª×¨×ª ×œ×¤×¨×™×˜ -->
        <div id="step-B" class="step">
          <div class="flex items-center justify-between">
            <label class="block font-bold mb-1">×›×•×ª×¨×ª ×œ×¤×¨×™×˜</label>
            <button id="build-with-ai-small" class="text-sm text-purple-700 hover:underline hidden"><i class="fa-solid fa-wand-magic-sparkles"></i> ×‘× ×” ×¢× AI</button>
          </div>
          <input id="input-item-title" type="text" class="w-full p-2 border rounded-lg" placeholder="×œ××©×œ: '×¡×™×•×¨ ×‘××•×–×™××•×Ÿ ×™×©×¨××œ'">
        </div>

        <!-- ×©×œ×‘ C: ×©×¢×•×ª -->
        <div id="step-C" class="step">
          <div class="flex items-center justify-between">
            <label class="block font-bold mb-2">×©×¢×•×ª ×¤×¢×™×œ×•×ª</label>
            <button id="add-back-to-hotel" class="text-sm text-blue-700 hover:underline" title="×™×¦×•×¨ ×¤×¨×™×˜ '×—×–×¨×” ×œ××œ×•×Ÿ' ×‘×©×¢×” ×©×‘×—×¨×ª">+ ×—×–×¨×” ×œ××œ×•×Ÿ</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <div>
              <label class="text-sm text-slate-600">×©×¢×ª ×”×ª×—×œ×”</label>
              <input id="input-start" type="time" class="w-full p-2 border rounded-lg" />
            </div>
            <div id="end-wrap" class="hidden">
              <label class="text-sm text-slate-600">×©×¢×ª ×¡×™×•×</label>
              <input id="input-end" type="time" class="w-full p-2 border rounded-lg" />
            </div>
            <button id="toggle-end" type="button" class="p-2 border rounded-lg hover:bg-slate-50">×”×•×¡×£ ×©×¢×ª ×¡×•×£</button>
          </div>
        </div>

        <!-- ×©×œ×‘ D: ×¤×™×¨×•×˜ -->
        <div id="step-D" class="step">
          <label class="block font-bold mb-1">×¤×™×¨×•×˜ ×—×•×¤×©×™</label>
          <textarea id="input-desc" rows="4" class="w-full p-2 border rounded-lg" placeholder="××” ×”×•×œ×š ×œ×”×™×•×ª ×›××Ÿ?"></textarea>
        </div>

        <!-- ×©×œ×‘ E: ×¤×¨×˜×™× × ×•×¡×¤×™× (×¤×ª×™×—×•×ª ×œ×¤×™ ×›×¤×ª×•×¨×™×) -->
        <div id="step-E" class="step space-y-4">
          <h5 class="font-bold">×¤×¨×˜×™× × ×•×¡×¤×™× (×œ×‘×—×™×¨×”)</h5>

          <!-- ×›×¤×ª×•×¨×™ ×¤×ª×™×—×” -->
          <div class="flex flex-wrap gap-2">
            <button data-open="#block-address" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×›×ª×•×‘×ª</button>
            <button data-open="#block-links" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×§×™×©×•×¨ ×œ××ª×¨</button>
            <button data-open="#block-book" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×§×™×©×•×¨ ×œ×”×–×× ×”</button>
            <button data-open="#block-route" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×”×œ×™×›×”/× ×¡×™×¢×”</button>
            <button data-open="#block-connect" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×§×™×©×•×¨ ×œ××˜×¨×§×¦×™×•×ª/××œ×•×Ÿ/×˜×™×¡×•×ª</button>
          </div>

          <!-- ×›×ª×•×‘×ª + ××•×˜×•×§×•××¤×œ×™×˜ + ×›×¤×ª×•×¨ ××œ×•×Ÿ -->
          <div id="block-address" class="hidden border rounded-xl p-3 space-y-2">
            <div class="flex items-center gap-2">
              <label class="font-semibold">×›×ª×•×‘×ª</label>
              <button id="use-hotel-address" class="text-sm text-blue-700 hover:underline">×”×©×ª××© ×‘×›×ª×•×‘×ª ×”××œ×•×Ÿ</button>
            </div>
            <div class="relative">
              <input id="addr-input" type="text" class="w-full p-2 border rounded-lg" placeholder="×”×§×œ×“ ×›×ª×•×‘×ª">
              <div id="addr-suggest" class="typeahead hidden bg-white border rounded-lg mt-1 max-h-52 overflow-auto"></div>
            </div>
            <div id="addr-map" class="w-full h-52 rounded-lg"></div>
          </div>

          <!-- ×§×™×©×•×¨×™× -->
          <div id="block-links" class="hidden border rounded-xl p-3">
            <label class="block mb-1 font-semibold">×§×™×©×•×¨ ×œ××ª×¨</label>
            <input id="link-general" type="url" class="w-full p-2 border rounded-lg" placeholder="https://...">
          </div>

          <div id="block-book" class="hidden border rounded-xl p-3">
            <label class="block mb-1 font-semibold">×§×™×©×•×¨ ×œ×”×–×× ×ª ×›×¨×˜×™×¡</label>
            <input id="link-book" type="url" class="w-full p-2 border rounded-lg" placeholder="https://...">
          </div>

          <!-- ××¡×œ×•×œ ×‘×™×Ÿ × ×§×•×“×•×ª -->
          <div id="block-route" class="hidden border rounded-xl p-3 space-y-2">
            <div class="grid sm:grid-cols-2 gap-2">
              <div class="relative">
                <label class="text-sm">×××™×¤×”</label>
                <input id="route-from" class="w-full p-2 border rounded-lg" placeholder="×›×ª×•×‘×ª ×™×¦×™××”">
                <div id="route-from-suggest" class="typeahead hidden bg-white border rounded-lg mt-1 max-h-52 overflow-auto"></div>
              </div>
              <div class="relative">
                <label class="text-sm">×œ××Ÿ</label>
                <input id="route-to" class="w-full p-2 border rounded-lg" placeholder="×›×ª×•×‘×ª ×™×¢×“">
                <div id="route-to-suggest" class="typeahead hidden bg-white border rounded-lg mt-1 max-h-52 overflow-auto"></div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <label class="text-sm">××•×¤×Ÿ × ×¡×™×¢×”:</label>
              <select id="route-mode" class="p-2 border rounded-lg">
                <option value="foot">×”×œ×™×›×”</option>
                <option value="driving" selected>× ×”×™×’×”</option>
              </select>
              <button id="route-calc" class="px-3 py-2 border rounded-lg hover:bg-slate-50">×—×©×‘ ××¡×œ×•×œ</button>
              <div id="route-time" class="text-sm text-slate-700"></div>
            </div>
            <div id="route-map" class="w-full h-56 rounded-lg"></div>
          </div>

          <!-- ×—×™×‘×•×¨×™× ×œ× ×ª×•× ×™× ×§×™×™××™× -->
          <div id="block-connect" class="hidden border rounded-xl p-3">
            <p class="text-sm text-slate-600 mb-2">×ª×•×›×Ÿ ××ª×•×š â€œ× ×™×”×•×œ ×œ×•×’×™×¡×˜×™×§×”â€ ×•â€œ××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ªâ€. ×œ×—×™×¦×” ×ª×¤×ª×— ××ª ×”×›×¨×˜×™×¡×™×™×” ×”××§×•×¨×™×ª.</p>
            <div id="connect-lists" class="grid gap-3"></div>
          </div>
        </div>

        <!-- ×©×œ×‘ F: ×ª×§×¦×™×¨ -->
        <div id="step-F" class="step">
          <label class="block font-bold mb-1">×ª×§×¦×™×¨ ×§×¦×¨ ×œ×›×¨×˜×™×¡×™×™×”</label>
          <input id="input-summary" type="text" class="w-full p-2 border rounded-lg" placeholder="××” ×™×•×¤×™×¢ ×‘×›×•×ª×¨×ª ×”×›×¨×˜×™×¡?">
        </div>

        <!-- ×©×œ×‘ G: ×”×¢×¨×•×ª -->
        <div id="step-G" class="step">
          <label class="block font-bold mb-1">×”×¢×¨×•×ª ×—×©×•×‘×•×ª</label>
          <textarea id="input-notes" rows="3" class="w-full p-2 border rounded-lg" placeholder="××œ×¨×’×™×•×ª, ×“×’×©×™×, ×ª×–×›×•×¨×•×ª..."></textarea>
        </div>
      </main>

      <!-- × ×™×•×•×˜ -->
      <footer class="p-4 border-t flex items-center justify-between">
        <button id="prev-step" class="px-4 py-2 rounded-lg hover:bg-slate-100">××—×•×¨×”</button>
        <div class="text-sm text-slate-500" id="step-indicator"></div>
        <div class="space-x-2 space-x-reverse">
          <button id="next-step" class="px-4 py-2 bg-blue-600 text-white rounded-lg">×”×‘×</button>
          <button id="save-item" class="hidden px-4 py-2 bg-emerald-600 text-white rounded-lg">×©××•×¨ ×¤×¨×™×˜</button>
        </div>
      </footer>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc,
      collection, query, where, getDocs, onSnapshot, serverTimestamp, orderBy
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // URL params
    const params = new URLSearchParams(location.search);
    const tripId = params.get('tripId');
    const urlDate = params.get('date'); // DD/MM/YYYY
    if (!tripId) { alert('×—×¡×¨ tripId'); location.href='index.html'; }

    // DOM refs
    const dateToggle = document.getElementById('date-toggle');
    const datePanel  = document.getElementById('date-panel');
    const dateCurrent= document.getElementById('date-current');
    const dateList   = document.getElementById('date-list');

    const backToDay  = document.getElementById('back-to-day');

    const dayTitleEmpty = document.getElementById('day-title-empty');
    const dayTitleLine  = document.getElementById('day-title-line');
    const dayTitleText  = document.getElementById('day-title-text');
    const setDayTitleBtn= document.getElementById('set-day-title');
    const editDayTitle  = document.getElementById('edit-day-title');

    const itemsList     = document.getElementById('items-list');
    const addItemBtn    = document.getElementById('add-item-btn');

    // Modal refs
    const modal       = document.getElementById('item-modal');
    const modalTitle  = document.getElementById('modal-title');
    const closeModal  = document.getElementById('close-modal');
    const prevStepBtn = document.getElementById('prev-step');
    const nextStepBtn = document.getElementById('next-step');
    const saveBtn     = document.getElementById('save-item');
    const stepIndicator = document.getElementById('step-indicator');

    const step0 = document.getElementById('step-0');
    const stepA = document.getElementById('step-A');
    const stepB = document.getElementById('step-B');
    const stepC = document.getElementById('step-C');
    const stepD = document.getElementById('step-D');
    const stepE = document.getElementById('step-E');
    const stepF = document.getElementById('step-F');
    const stepG = document.getElementById('step-G');

    const chooseManual = document.getElementById('choose-manual');
    const chooseAI     = document.getElementById('choose-ai');
    const buildWithAiSmall = document.getElementById('build-with-ai-small');

    const inputDayTitle = document.getElementById('input-day-title');
    const inputItemTitle= document.getElementById('input-item-title');
    const inputStart    = document.getElementById('input-start');
    const inputEnd      = document.getElementById('input-end');
    const toggleEnd     = document.getElementById('toggle-end');
    const endWrap       = document.getElementById('end-wrap');
    const addBackHotel  = document.getElementById('add-back-to-hotel');

    const inputDesc     = document.getElementById('input-desc');
    const inputSummary  = document.getElementById('input-summary');
    const inputNotes    = document.getElementById('input-notes');

    // Extra blocks
    const openBlockBtns = document.querySelectorAll('.open-block');

    const addrInput   = document.getElementById('addr-input');
    const addrSuggest = document.getElementById('addr-suggest');
    const addrMapDiv  = document.getElementById('addr-map');
    const useHotelBtn = document.getElementById('use-hotel-address');

    const linkGeneral = document.getElementById('link-general');
    const linkBook    = document.getElementById('link-book');

    const rFrom       = document.getElementById('route-from');
    const rTo         = document.getElementById('route-to');
    const rFromSug    = document.getElementById('route-from-suggest');
    const rToSug      = document.getElementById('route-to-suggest');
    const rMode       = document.getElementById('route-mode');
    const rCalc       = document.getElementById('route-calc');
    const rTime       = document.getElementById('route-time');
    const rMapDiv     = document.getElementById('route-map');

    const connectLists = document.getElementById('connect-lists');

    // Maps
    let addrMap = null, addrMarker = null;
    let routeMap = null, routeLayer = null, routeMarkers = [];

    // State
    let user = null;
    let tripData = null;
    let selectedDate = urlDate || null; // DD/MM/YYYY
    let selectedDest = null;
    let dayDocId = null; // YYYY-MM-DD
    let dayDocRef = null;
    let dayTitle = null;

    let items = []; // existing items of the day (for distance calc)
    let currentStepIndex = 0;
    const stepsOrder = ['0','A','B','C','D','E','F','G']; // 0 (method) always first

    const manualPrefKey = 'loz_add_mode'; // 'manual'/'ai'

    // utils
    const pad2 = n => (''+n).padStart(2,'0');
    const toISOFromDDMMYYYY = (s) => { const [d,m,y]=s.split('/').map(Number); return `${y}-${pad2(m)}-${pad2(d)}`; };
    const toDisplayDotted   = (s) => { const [d,m,y]=s.split('/').map(Number); return `${d}.${m}.${y}`; };
    const weekdayHe = (s) => {
      const [d,m,y]=s.split('/').map(Number);
      const dt = new Date(y,m-1,d);
      const w = dt.toLocaleDateString('he-IL',{weekday:'long'});
      return w.startsWith('×™×•×')?w:`×™×•× ${w}`;
    };
    const minutesFromHHMM = (hhmm) => {
      const [h,m] = (hhmm||'00:00').split(':').map(Number);
      return h*60+m;
    };
    const haversineMeters = (a,b) => {
      const R=6371000, toRad=x=>x*Math.PI/180;
      const dLat=toRad(b.lat-a.lat), dLon=toRad(b.lng-a.lng);
      const s1=Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLon/2)**2;
      return 2*R*Math.asin(Math.sqrt(s1));
    };

    // Auth + init
    onAuthStateChanged(auth, async (u)=>{
      if (!u) { location.href='login.html'; return; }
      user = u;
      // load trip
      const tSnap = await getDoc(doc(db,'trips',tripId));
      if (!tSnap.exists()) { alert('×˜×™×•×œ ×œ× × ××¦×'); location.href='index.html'; return; }
      tripData = tSnap.data();
      if (tripData.ownerId !== user.uid){ alert('××™×Ÿ ×”×¨×©××”'); location.href='index.html'; return; }

      buildDateSelector();
      if (!selectedDate) {
        // default: ×”×™×•× ×”×¨××©×•×Ÿ ×‘×™×¢×“ ×”×¨××©×•×Ÿ
        const d0 = tripData.destinations?.[0]?.dates?.split(' - ')?.[0];
        selectedDate = d0 || null;
      }
      await setWorkingDate(selectedDate);
      backToDay.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(selectedDate)}`;

      // realtime items
      onSnapshot(collection(db,'trips',tripId,'schedules',dayDocId,'items'), (snap)=>{
        items = snap.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=> (a.sort||0)-(b.sort||0));
        renderItems();
      });
    });

    // Build the openable date list grouped by destinations
    function buildDateSelector(){
      dateList.innerHTML = '';
      dateCurrent.textContent = '×‘×—×¨ ×ª××¨×™×š...';

      tripData.destinations?.forEach(dest=>{
        const dates = expandRange(dest.dates);
        const wrap = document.createElement('div');
        wrap.className = 'p-3';
        wrap.innerHTML = `<div class="font-bold text-slate-800 mb-2">${dest.nameHe}</div>`;
        dates.forEach(d=>{
          const a = document.createElement('button');
          const wd = weekdayHe(d);
          a.className = 'w-full text-right p-2 rounded hover:bg-slate-100';
          a.textContent = `${wd} â€“ (${dest.nameHe}) â€¢ ${toDisplayDotted(d)}`;
          a.addEventListener('click', async ()=>{
            await setWorkingDate(d);
            datePanel.classList.remove('open');
          });
          wrap.appendChild(a);
        });
        dateList.appendChild(wrap);
      });

      dateToggle.addEventListener('click', ()=> datePanel.classList.toggle('open'));
    }

    function expandRange(rangeStr){
      if (!rangeStr?.includes(' - ')) return [];
      const [s,e] = rangeStr.split(' - ');
      const [sd,sm,sy] = s.split('/').map(Number);
      const [ed,em,ey] = e.split('/').map(Number);
      const start = new Date(sy,sm-1,sd);
      const end   = new Date(ey,em-1,ed);
      const arr=[];
      let cur=new Date(start);
      while (cur<=end){
        arr.push(`${pad2(cur.getDate())}/${pad2(cur.getMonth()+1)}/${cur.getFullYear()}`);
        cur.setDate(cur.getDate()+1);
      }
      return arr;
    }

    async function setWorkingDate(ddmmyyyy){
      selectedDate = ddmmyyyy;
      const iso = toISOFromDDMMYYYY(ddmmyyyy);
      dayDocId = iso;
      dayDocRef = doc(db,'trips',tripId,'schedules',dayDocId);

      // find the destination for the date
      selectedDest = tripData.destinations?.find(d=> expandRange(d.dates).includes(ddmmyyyy)) || null;

      dateCurrent.textContent = `${weekdayHe(ddmmyyyy)} â€“ (${selectedDest?.nameHe || '×œ×œ× ×™×¢×“'}) â€¢ ${toDisplayDotted(ddmmyyyy)}`;

      // load (or create placeholder) day doc
      const daySnap = await getDoc(dayDocRef);
      if (daySnap.exists()){
        dayTitle = daySnap.data().title || null;
      } else {
        dayTitle = null;
        await setDoc(dayDocRef, { title:null, date:ddmmyyyy, destination: selectedDest?.nameHe || null }, { merge:true });
      }
      reflectDayTitleUI();
    }

    function reflectDayTitleUI(){
      if (dayTitle){
        dayTitleEmpty.classList.add('hidden');
        dayTitleLine.classList.remove('hidden');
        dayTitleText.textContent = dayTitle;
        editDayTitle.classList.remove('hidden');
      } else {
        dayTitleEmpty.classList.remove('hidden');
        dayTitleLine.classList.add('hidden');
        editDayTitle.classList.add('hidden');
      }
    }

    setDayTitleBtn.addEventListener('click', async ()=>{
      const t = prompt('×›×•×ª×¨×ª ×œ×™×•× ×–×”:', dayTitle || '');
      if (t===null) return;
      dayTitle = t.trim() || null;
      await setDoc(dayDocRef, { title: dayTitle, updatedAt: serverTimestamp() }, { merge:true });
      reflectDayTitleUI();
    });
    editDayTitle.addEventListener('click', ()=> setDayTitleBtn.click());

    // ----- Items rendering -----
    function renderItems(){
      if (!items.length){
        itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>`;
        return;
      }
      itemsList.innerHTML = items.map((it,i)=>{
        const time = `${it.startTime || ''}${it.endTime ? ' â€“ ' + it.endTime : ''}`;
        const dist = (it.distanceFromPreviousMeters!=null) ? `<span class="text-xs text-slate-500"> â€¢ ××¨×—×§ ×§×•×“×: ${(it.distanceFromPreviousMeters/1000).toFixed(2)} ×§×´×</span>` : '';
        return `<div class="bg-white rounded-xl border shadow p-4">
          <div class="flex items-center justify-between">
            <div class="font-bold text-blue-700">${it.title || '(×œ×œ× ×›×•×ª×¨×ª)'}</div>
            <div class="text-sm text-slate-600">${time}${dist}</div>
          </div>
          ${it.summary ? `<div class="text-slate-700 mt-1">${it.summary}</div>`:''}
          ${it.address?.label ? `<div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-location-dot"></i> ${it.address.label}</div>`:''}
        </div>`;
      }).join('');
    }

    // ----- Add item modal -----
    addItemBtn.addEventListener('click', openItemModal);

    function openItemModal(){
      modal.classList.add('show');
      // reset controls
      inputItemTitle.value = '';
      inputStart.value = ''; inputEnd.value = ''; endWrap.classList.add('hidden');
      inputDesc.value = ''; inputSummary.value = ''; inputNotes.value = '';
      linkGeneral.value=''; linkBook.value='';
      addrInput.value=''; addrSuggest.classList.add('hidden'); if(addrMarker){ addrMap.removeLayer(addrMarker); addrMarker=null; }
      if (!addrMap){ addrMap = L.map(addrMapDiv).setView([31.77,35.21], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap); }
      if (!routeMap){ routeMap = L.map(rMapDiv).setView([31.77,35.21], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap); }

      // steps visibility
      const savedMode = localStorage.getItem(manualPrefKey);
      showStep('0'); // always first
      buildWithAiSmall.classList.add('hidden');
      // If ×™×© ×›×‘×¨ ×›×•×ª×¨×ª ×™×•× â€“ × ×“×œ×’ ×¢×œ A ×‘×”××©×š
      // nothing else
    }

    closeModal.addEventListener('click', ()=> modal.classList.remove('show'));

    function showStep(code){
      [step0,stepA,stepB,stepC,stepD,stepE,stepF,stepG].forEach(s=>s.classList.remove('active'));
      if (code==='0') { step0.classList.add('active'); currentStepIndex = 0; }
      if (code==='A') { stepA.classList.add('active'); currentStepIndex = stepsOrder.indexOf('A'); }
      if (code==='B') { stepB.classList.add('active'); currentStepIndex = stepsOrder.indexOf('B'); }
      if (code==='C') { stepC.classList.add('active'); currentStepIndex = stepsOrder.indexOf('C'); }
      if (code==='D') { stepD.classList.add('active'); currentStepIndex = stepsOrder.indexOf('D'); }
      if (code==='E') { stepE.classList.add('active'); currentStepIndex = stepsOrder.indexOf('E'); }
      if (code==='F') { stepF.classList.add('active'); currentStepIndex = stepsOrder.indexOf('F'); }
      if (code==='G') { stepG.classList.add('active'); currentStepIndex = stepsOrder.indexOf('G'); }
      stepIndicator.textContent = `×©×œ×‘ ${currentStepIndex+1} ××ª×•×š ${stepsOrder.length}`;
      // next/save visibility
      saveBtn.classList.toggle('hidden', stepsOrder[currentStepIndex] !== 'G');
      nextStepBtn.classList.toggle('hidden', stepsOrder[currentStepIndex] === 'G');
      prevStepBtn.disabled = (stepsOrder[currentStepIndex] === '0');
    }

    chooseManual.addEventListener('click', ()=>{
      localStorage.setItem(manualPrefKey,'manual');
      // ×× ××™×Ÿ ×›×•×ª×¨×ª ×œ×™×•× â€“ A, ××—×¨×ª B
      showStep(dayTitle ? 'B' : 'A');
      buildWithAiSmall.classList.remove('hidden'); // ×××¤×©×¨ ××¢×‘×¨ ×œ-AI ×‘×›×•×ª×¨×ª ×”×¤×¨×™×˜
    });
    chooseAI.addEventListener('click', ()=>{
      localStorage.setItem(manualPrefKey,'ai');
      alert('×‘×©×œ×‘ ×–×” × ×•×¡×™×£ ×ª××™×›×” ×‘-AI ×‘×”××©×š ğŸ‘Œ (×”×“×£ ×××©×™×š ×™×“× ×™×ª).');
      showStep(dayTitle ? 'B' : 'A');
      buildWithAiSmall.classList.remove('hidden');
    });
    buildWithAiSmall.addEventListener('click', ()=>{
      alert('×‘×§×¨×•×‘: ×™×¦×™×¨×ª ×›×•×ª×¨×ª ×•×ª×™××•×¨ ×¢× AI ×œ×¤×™ ×”×™×¢×“ ×•×”×¢×“×¤×•×ª.');
    });

    nextStepBtn.addEventListener('click', ()=>{
      const cur = stepsOrder[currentStepIndex];
      if (cur==='A'){
        // ×œ×©××•×¨ ×›×•×ª×¨×ª ×™×•× ×× ××•×œ××”
        const t = (inputDayTitle.value||'').trim();
        if (t) setDoc(dayDocRef,{ title:t, updatedAt:serverTimestamp() },{merge:true}).then(()=>{ dayTitle=t; reflectDayTitleUI(); });
      }
      showStep(stepsOrder[currentStepIndex+1]);
    });
    prevStepBtn.addEventListener('click', ()=>{
      showStep(stepsOrder[currentStepIndex-1]);
    });

    toggleEnd.addEventListener('click', ()=> endWrap.classList.toggle('hidden'));

    // ----- ×¤×ª×™×—×ª ×‘×œ×•×§×™× -----
    openBlockBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const sel = btn.getAttribute('data-open');
        const el = document.querySelector(sel);
        el.classList.toggle('hidden');
        if (sel==='#block-route') routeMap.invalidateSize();
        if (sel==='#block-address') addrMap.invalidateSize();
      });
    });

    // ----- ×”×¦×¢×•×ª ×›×ª×•×‘×ª (Nominatim) -----
    function attachTypeahead(input, suggestBox, onPick){
      let timer=null;
      input.addEventListener('input', ()=>{
        clearTimeout(timer);
        const q = input.value.trim();
        if (!q){ suggestBox.classList.add('hidden'); suggestBox.innerHTML=''; return; }
        timer = setTimeout(async ()=>{
          const url=`https://nominatim.openstreetmap.org/search?format=json&limit=5&q=${encodeURIComponent(q)}`;
          const res = await fetch(url);
          const arr = await res.json();
          suggestBox.innerHTML = arr.map(r=>`<button class="w-full text-right p-2 hover:bg-slate-100" data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`).join('');
          suggestBox.classList.remove('hidden');
          suggestBox.querySelectorAll('button').forEach(b=>{
            b.addEventListener('click', ()=>{
              suggestBox.classList.add('hidden');
              onPick({
                lat: parseFloat(b.dataset.lat),
                lng: parseFloat(b.dataset.lon),
                label: b.textContent
              });
            });
          });
        }, 250);
      });
      document.addEventListener('click', (e)=>{
        if (!suggestBox.contains(e.target) && e.target!==input) suggestBox.classList.add('hidden');
      });
    }

    attachTypeahead(addrInput, addrSuggest, (p)=>{
      addrInput.value = p.label;
      if (!addrMarker) addrMarker = L.marker([p.lat,p.lng]).addTo(addrMap);
      else addrMarker.setLatLng([p.lat,p.lng]);
      addrMap.setView([p.lat,p.lng], 15);
      addrMarker._data = p; // ×©××™×¨×” ×¢×œ ×”× ×ª×•× ×™×
    });

    attachTypeahead(rFrom, rFromSug, (p)=>{
      rFrom.value = p.label;
      setRoutePoint(0, p);
    });
    attachTypeahead(rTo, rToSug, (p)=>{
      rTo.value = p.label;
      setRoutePoint(1, p);
    });

    function setRoutePoint(idx, p){
      if (!routeMarkers[idx]) routeMarkers[idx] = L.marker([p.lat,p.lng]).addTo(routeMap);
      else routeMarkers[idx].setLatLng([p.lat,p.lng]);
      routeMarkers[idx]._data = p;
      routeMap.setView([p.lat,p.lng], 13);
    }

    rCalc.addEventListener('click', async ()=>{
      if (!routeMarkers[0]?._data || !routeMarkers[1]?._data) return alert('×‘×—×¨ ×’× ××•×¦× ×•×’× ×™×¢×“.');
      const a = routeMarkers[0]._data, b = routeMarkers[1]._data;
      const profile = (rMode.value==='foot') ? 'foot' : 'driving';
      // OSRM (×”×œ×™×›×”=foot, × ×”×™×’×”=driving)
      const url = `https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res = await fetch(url);
      const data = await res.json();
      if (data?.routes?.[0]){
        const r = data.routes[0];
        const secs = Math.round(r.duration);
        const mins = Math.round(secs/60);
        rTime.textContent = `×–××Ÿ ××©×•×¢×¨: ${mins} ×“×§×³`;
        if (routeLayer) routeMap.removeLayer(routeLayer);
        routeLayer = L.geoJSON(r.geometry).addTo(routeMap);
        routeMap.fitBounds(routeLayer.getBounds(), { padding:[20,20] });
      } else {
        rTime.textContent = '×œ× × ××¦× ××¡×œ×•×œ.';
      }
    });

    // ××œ×•×Ÿ ×œ×™×•×/×™×¢×“
    useHotelBtn.addEventListener('click', async ()=>{
      const hotel = await findHotelForDate(selectedDate, selectedDest?.nameHe);
      if (!hotel) return alert('××™×Ÿ ××œ×•×Ÿ ××•×’×“×¨ ×œ×ª××¨×™×š ×–×”.');
      addrInput.value = hotel.address || hotel.name || '';
      const coords = hotel.coords || hotel.location || null;
      if (coords?.lat && coords?.lng){
        if (!addrMarker) addrMarker = L.marker([coords.lat,coords.lng]).addTo(addrMap);
        else addrMarker.setLatLng([coords.lat,coords.lng]);
        addrMarker._data = {lat:coords.lat,lng:coords.lng,label:addrInput.value};
        addrMap.setView([coords.lat,coords.lng], 15);
      }
    });

    async function findHotelForDate(dateDDMMYYYY, destName){
      // ××•×©×š ××ª ×›×œ ×”×œ×•×’×™×¡×˜×™×§×” ×•××—×¤×© ××œ×•×Ÿ ×©×ª××¨×™×›×™×• ×›×•×œ×œ×™× ××ª ×”×™×•×
      const qSnap = await getDocs(collection(db,'trips',tripId,'logistics'));
      const hotels = qSnap.docs.map(d=>({id:d.id, ...d.data()})).filter(x=>x.type==='hotel');
      const inRange = (range) => expandRange(range).includes(dateDDMMYYYY);
      const byDest = hotels.find(h=> (h.destination===destName || !destName) && inRange(h.dates||''));
      return byDest || hotels.find(h=> inRange(h.dates||''));
    }

    // ××©×™×›×ª ×¨×©×™××•×ª ×œ×—×™×‘×•×¨×™×
    async function loadConnectLists(){
      connectLists.innerHTML = '<div class="text-slate-500">×˜×•×¢×Ÿ...</div>';
      const logistics = (await getDocs(collection(db,'trips',tripId,'logistics'))).docs.map(d=>({id:d.id, ...d.data()}));
      const attractions = (await getDocs(collection(db,'trips',tripId,'attractions'))).docs.map(d=>({id:d.id, ...d.data()}));

      const mkCard = (title, sub, type, link)=>`
        <div class="p-3 rounded-lg border bg-white flex items-center justify-between">
          <div>
            <div class="font-bold">${title}</div>
            <div class="text-xs text-slate-500">${sub||''}</div>
          </div>
          <a href="${link}" class="text-blue-600 hover:underline text-sm" target="_blank">×¤×ª×—</a>
        </div>`;

      let html = '';
      if (logistics.length){
        html += `<div><div class="font-bold mb-2">××¢×‘×¨×™× ×•××œ×•× ×•×ª</div><div class="grid gap-2">` +
          logistics.map(l=> mkCard(
            (l.type==='flight'?'âœˆï¸ ×˜×™×¡×”': l.type==='hotel'?'ğŸ¨ ××œ×•×Ÿ': 'â¬…ï¸ ××¢×‘×¨'),
            l.dates || l.date || '',
            l.type,
            `summary.html?tripId=${tripId}#${l.id}`
          )).join('') + `</div></div>`;
      }
      if (attractions.length){
        html += `<div class="mt-4"><div class="font-bold mb-2">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</div><div class="grid gap-2">` +
          attractions.map(a=> mkCard(a.name, a.destination, 'attraction', `attractions.html?tripId=${tripId}#${a.id}`)).join('') + `</div></div>`;
      }
      connectLists.innerHTML = html || '<div class="text-slate-500">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</div>';
    }
    // ×˜×¢×Ÿ ×›×©×¤×•×ª×—×™× ××ª ×”×‘×œ×•×§
    document.querySelector('[data-open="#block-connect"]').addEventListener('click', ()=>{
      if (!document.getElementById('block-connect').classList.contains('hidden')) loadConnectLists();
    });

    // ×›×¤×ª×•×¨ "×—×–×¨×” ×œ××œ×•×Ÿ" ×‘×©×œ×‘ ×”×©×¢×•×ª
    addBackHotel.addEventListener('click', async ()=>{
      if (!inputStart.value) return alert('×‘×—×¨ ×©×¢×ª ×”×ª×—×œ×” ×œ×—×–×¨×” ×œ××œ×•×Ÿ.');
      const hotel = await findHotelForDate(selectedDate, selectedDest?.nameHe);
      if (!hotel) return alert('×œ× × ××¦× ××œ×•×Ÿ ×œ×ª××¨×™×š ×–×”.');
      // ×¦×•×¨ ×¤×¨×™×˜ ××™×™×“×™×ª
      await saveItemCore({
        title: '×—×–×¨×” ×œ××œ×•×Ÿ',
        startTime: inputStart.value,
        endTime: null,
        summary: '×¡×™×•× ×”×™×•× ×•×—×–×¨×” ×œ××œ×•×Ÿ',
        address: hotel.address ? { label: hotel.address, lat: hotel.coords?.lat, lng: hotel.coords?.lng } : null,
        isBackToHotel: true
      }, true);
      modal.classList.remove('show');
    });

    // ×©××™×¨×”
    saveBtn.addEventListener('click', async ()=>{
      // ×‘× ×™×™×”
      const payload = {
        title: (inputItemTitle.value||'').trim() || '(×œ×œ× ×›×•×ª×¨×ª)',
        startTime: inputStart.value || null,
        endTime: inputEnd.value || null,
        description: (inputDesc.value||'').trim() || null,
        summary: (inputSummary.value||'').trim() || null,
        notes: (inputNotes.value||'').trim() || null,
        links: {
          site: (linkGeneral.value||'').trim() || null,
          booking: (linkBook.value||'').trim() || null
        },
        address: addrMarker?._data ? { label: addrMarker._data.label, lat: addrMarker._data.lat, lng: addrMarker._data.lng } : null,
        travel: (routeMarkers[0]?._data && routeMarkers[1]?._data) ? {
          from: routeMarkers[0]._data,
          to: routeMarkers[1]._data,
          mode: rMode.value,
          timeText: rTime.textContent || null
        } : null
      };

      await saveItemCore(payload, false);
      modal.classList.remove('show');
    });

    async function saveItemCore(payload, isBackToHotel){
      // ×•×“× ×›×•×ª×¨×ª ×™×•× ×§×™×™××ª ×‘××¡××š
      if (dayTitle!=null) {
        await setDoc(dayDocRef, { title: dayTitle, updatedAt: serverTimestamp() }, { merge:true });
      }

      // ××¨×—×§ ××”×¤×¨×™×˜ ×”×§×•×“× (×× ×™×© ×›×ª×•×‘×•×ª)
      const sorted = items.slice().sort((a,b)=>(a.sort||0)-(b.sort||0));
      const thisSort = minutesFromHHMM(payload.startTime||'00:00');
      const before = [...sorted].filter(i => (i.sort||0) <= thisSort).pop();
      let distanceFromPrev = null;
      if (before?.address && payload.address){
        distanceFromPrev = Math.round(haversineMeters(
          {lat:before.address.lat,lng:before.address.lng},
          {lat:payload.address.lat,lng:payload.address.lng}
        ));
      } else if (isBackToHotel && payload.address && before?.address==null){
        // ×× ×—×–×¨×” ×œ××œ×•×Ÿ ×•×”×¤×¨×™×˜ ×©×œ×¤× ×™×” ×‘×œ×™ ×›×ª×•×‘×ª â€“ ××™×Ÿ ×—×™×©×•×‘
        distanceFromPrev = null;
      }

      const docData = {
        ...payload,
        sort: thisSort,
        destination: selectedDest?.nameHe || null,
        date: selectedDate,
        createdAt: serverTimestamp(),
        distanceFromPreviousMeters: distanceFromPrev
      };

      await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'items'), docData);
    }

    // --- ×¢×–×¨: ×›×¤×ª×•×¨ ×—×–×¨×” ×œ×œ×•×– ×”×™×•××™ ×ª××™×“ ××¢×•×“×›×Ÿ ---
    backToDay.addEventListener('click', (e)=>{
      // ×”×§×™×©×•×¨ ×›×‘×¨ ×¢×•×“×›×Ÿ ×œ××—×¨ setWorkingDate
    });

  </script>
</body>
</html>