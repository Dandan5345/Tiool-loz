<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; }
    body {
      font-family: 'Assistant', sans-serif;
      min-height: 100svh;
      overscroll-behavior-y: contain;
      -webkit-overflow-scrolling: touch;
      scrollbar-gutter: stable both-edges;
    }
    /* ×¨×§×¢ */
    .bg-fixed {
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(59,130,246,.35), transparent 60%),
        radial-gradient(900px 700px at 10% 110%, rgba(16,185,129,.35), transparent 60%),
        url('https://images.unsplash.com/photo-1526779259212-939e64788e3c?q=80&w=2000&auto=format&fit=crop');
      background-size: cover; background-position: center; filter: saturate(1.05);
    }
    .sheet { background: rgba(255,255,255,.92); backdrop-filter: blur(6px); }
    .submenu { max-height: 0; overflow: hidden; transition: max-height .4s ease; }
    .submenu.open { max-height: 1000px; }
    .modal { display: none; }
    .modal.show { display: flex; }
    .step { display: none; }
    .step.active { display: block; }

    /* ×ª×™×‘×•×ª ××•×˜×•×§×•××¤×œ×™×˜ ×¦×¤×•×ª (××¢×œ ××¤×•×ª ×•××•×“×œ×™×) */
    .typeahead {
      position: fixed; /* ×—×©×•×‘! */
      z-index: 99999;  /* ××¢×œ ×”×›×œ */
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: .75rem;
      max-height: 260px;
      overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.14);
      display: none;
    }
    .typeahead.open { display: block; }
    .typeahead button {
      width: 100%;
      text-align: right;
      padding: .6rem .8rem;
      line-height: 1.35;
      white-space: normal;
    }
    .typeahead button:hover { background:#f8fafc; }

    .card { transition: transform .12s ease, box-shadow .12s ease; }
    .card:hover { transform: translateY(-2px); box-shadow: 0 10px 22px rgba(2,6,23,.08); }

    /* chips ×œ×‘×—×™×¨×•×ª ×—×™×‘×•×¨×™× */
    .chip {
      display: inline-flex; align-items: center; gap:.4rem;
      padding:.25rem .55rem; border-radius: 999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
      font-size:.85rem;
    }
    .chip .x { cursor: pointer; color:#6366f1; }
  </style>
</head>
<body>

  <!-- ×¨×§×¢ -->
  <div class="fixed inset-0 -z-10 bg-fixed"></div>
  <div class="fixed inset-0 -z-10 bg-white/40"></div>

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-sm sticky top-0 z-30 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a id="back-to-day" href="#" class="p-2 text-slate-700 hover:text-blue-600" title="×—×–×¨×” ×œ×œ×•×– ×”×™×•××™">
            <i class="fa-solid fa-arrow-right"></i>
          </a>
          <h1 class="text-xl font-bold text-slate-800">×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</h1>
        </div>
        <div id="auth-slot" class="text-slate-700"></div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <!-- ×‘×—×™×¨×ª ×ª××¨×™×š/×™×¢×“ + ×”×¦×’×ª ×›×•×ª×¨×ª ×™×•× (×¢× ×¢×™×¤×¨×•×Ÿ ×œ×¢×¨×™×›×”) -->
    <section class="sheet rounded-2xl p-5 shadow space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-2xl font-extrabold text-slate-900">×‘×—×¨ ×ª××¨×™×š ×œ×™×•× ×”×¢×‘×•×“×”</h2>
          <p class="text-slate-600">×‘×¨×™×¨×ª ×”××—×“×œ â€” ×”×ª××¨×™×š ×©××× ×• ×”×’×¢×ª.</p>
        </div>
        <div class="w-full md:w-[460px]">
          <button id="date-toggle" class="w-full flex items-center justify-between bg-white p-3 rounded-xl border shadow hover:bg-slate-50">
            <span id="date-current" class="font-bold text-slate-700">×˜×•×¢×Ÿ...</span>
            <i class="fa-solid fa-chevron-down text-slate-500"></i>
          </button>
          <div id="date-panel" class="submenu bg-white rounded-xl border shadow mt-2 overflow-hidden">
            <div id="date-list" class="max-h-80 overflow-y-auto divide-y"></div>
          </div>
        </div>
      </div>

      <!-- ×©×•×¨×ª ×ª××¨×™×š + ×›×•×ª×¨×ª ×™×•× -->
      <div class="flex items-center flex-wrap gap-2 text-slate-800">
        <div id="badge-date" class="px-3 py-1 rounded-full bg-sky-50 text-sky-700 border border-sky-200 text-sm">â€”</div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-500">×›×•×ª×¨×ª ×”×™×•×:</span>
          <strong id="day-title-inline" class="text-blue-700">×œ× × ×§×‘×¢×”</strong>
          <button id="edit-day-title-inline" class="hidden text-slate-600 hover:text-blue-600" title="×¢×¨×™×›×ª ×›×•×ª×¨×ª"><i class="fa-solid fa-pen"></i></button>
        </div>
      </div>
    </section>

    <!-- ×¤×¨×™×˜×™× + ×›×¤×ª×•×¨×™× -->
    <section class="sheet rounded-2xl p-5 shadow">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h3 class="text-xl font-bold text-slate-900">×¤×¨×™×˜×™ ×œ×•×´×– ×œ×™×•× ×–×”</h3>
        <div class="flex gap-2">
          <button id="add-item-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg">
            <i class="fa-solid fa-plus"></i> ×”×•×¡×£ ×œ×•×–
          </button>
          <button id="ai-build-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg">
            <i class="fa-solid fa-wand-magic-sparkles"></i> ×™×¦×™×¨×ª ×œ×•×– ×¢× AI
          </button>
        </div>
      </div>
      <div id="items-list" class="mt-4 space-y-3">
        <div class="text-slate-500 p-6 text-center">××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>
      </div>
    </section>
  </main>

  <!-- MODAL: ×™×¦×™×¨×ª/×¢×¨×™×›×ª ×¤×¨×™×˜ -->
  <div id="item-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/60">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-2xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 id="modal-title" class="text-lg font-bold">×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×™×•×</h4>
        <button id="close-modal" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>

      <main class="p-4 overflow-y-auto flex-1 space-y-5">
        <!-- ×©×œ×‘ A: ×›×•×ª×¨×ª ×œ×™×•× (××•×¤×™×¢ ×¨×§ ×× ×¢×“×™×™×Ÿ ××™×Ÿ) -->
        <div id="step-A" class="step">
          <label class="block font-bold mb-1">×›×•×ª×¨×ª ×›×œ×œ×™×ª ×œ×™×•×</label>
          <input id="input-day-title" type="text" class="w-full p-2 border rounded-lg" placeholder="×œ××©×œ: '×™×•× ××•×–×™××•× ×™× ×•××•×›×œ ×¨×—×•×‘'">
          <p class="text-xs text-slate-500 mt-2">×©××œ×” ×–×• ×ª×™×“×œ×’ ××•×˜×•××˜×™×ª ×œ××—×¨ ×©×ª×©××¨ ×›×•×ª×¨×ª ×œ×™×•×.</p>
        </div>

        <!-- ×©×œ×‘ B: ×›×•×ª×¨×ª ×œ×¤×¨×™×˜ -->
        <div id="step-B" class="step">
          <label class="block font-bold mb-1">×›×•×ª×¨×ª ×œ×¤×¨×™×˜</label>
          <input id="input-item-title" type="text" class="w-full p-2 border rounded-lg" placeholder="×œ××©×œ: '×¡×™×•×¨ ×‘××•×–×™××•×Ÿ ×™×©×¨××œ'">
        </div>

        <!-- ×©×œ×‘ C: ×©×¢×•×ª -->
        <div id="step-C" class="step">
          <div class="flex items-center justify-between">
            <label class="block font-bold mb-2">×©×¢×•×ª ×¤×¢×™×œ×•×ª</label>
            <button id="add-back-to-hotel" class="text-sm text-blue-700 hover:underline" title="×™×¦×•×¨ ×¤×¨×™×˜ '×—×–×¨×” ×œ××œ×•×Ÿ' ×‘×©×¢×” ×©×‘×—×¨×ª">+ ×—×–×¨×” ×œ××œ×•×Ÿ</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <div>
              <label class="text-sm text-slate-600">×©×¢×ª ×”×ª×—×œ×”</label>
              <input id="input-start" type="time" class="w-full p-2 border rounded-lg" />
            </div>
            <div id="end-wrap" class="hidden">
              <label class="text-sm text-slate-600">×©×¢×ª ×¡×™×•×</label>
              <input id="input-end" type="time" class="w-full p-2 border rounded-lg" />
            </div>
            <button id="toggle-end" type="button" class="p-2 border rounded-lg hover:bg-slate-50">×”×•×¡×£ ×©×¢×ª ×¡×•×£</button>
          </div>
        </div>

        <!-- ×©×œ×‘ D: ×¤×™×¨×•×˜ -->
        <div id="step-D" class="step">
          <label class="block font-bold mb-1">×¤×™×¨×•×˜ ×—×•×¤×©×™</label>
          <textarea id="input-desc" rows="4" class="w-full p-2 border rounded-lg" placeholder="××” ×”×•×œ×š ×œ×”×™×•×ª ×›××Ÿ?"></textarea>
        </div>

        <!-- ×©×œ×‘ E: ×¤×¨×˜×™× × ×•×¡×¤×™× -->
        <div id="step-E" class="step space-y-4">
          <h5 class="font-bold">×¤×¨×˜×™× × ×•×¡×¤×™× (×œ×‘×—×™×¨×”)</h5>
          <div class="flex flex-wrap gap-2">
            <button data-open="#block-address" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×›×ª×•×‘×ª</button>
            <button data-open="#block-links"   class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×§×™×©×•×¨ ×œ××ª×¨</button>
            <button data-open="#block-book"    class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×§×™×©×•×¨ ×œ×”×–×× ×”</button>
            <button data-open="#block-route"   class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×”×œ×™×›×”/× ×¡×™×¢×”</button>
            <button data-open="#block-connect" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">×§×™×©×•×¨ ×œ××˜×¨×§×¦×™×•×ª/××œ×•×Ÿ/×˜×™×¡×•×ª</button>
          </div>

          <!-- ×›×ª×•×‘×ª ×¨×’×™×œ×” -->
          <div id="block-address" class="hidden border rounded-xl p-3 space-y-2">
            <div class="flex items-center gap-2">
              <label class="font-semibold">×›×ª×•×‘×ª</label>
              <button id="use-hotel-address" class="text-sm text-blue-700 hover:underline">×”×©×ª××© ×‘×›×ª×•×‘×ª ×”××œ×•×Ÿ</button>
            </div>
            <div class="relative">
              <input id="addr-input" type="text" class="w-full p-2 border rounded-lg" placeholder="×”×§×œ×“ ×›×ª×•×‘×ª">
              <!-- ×ª×™×‘×ª ×”×¦×¢×•×ª ×ª×™×¦××“ ×œ-body ×•×œ×›×Ÿ ×œ× ×›××Ÿ -->
            </div>
            <div id="addr-map" class="w-full h-52 rounded-lg"></div>
          </div>

          <!-- ×§×™×©×•×¨×™× -->
          <div id="block-links" class="hidden border rounded-xl p-3">
            <label class="block mb-1 font-semibold">×§×™×©×•×¨ ×œ××ª×¨</label>
            <input id="link-general" type="url" class="w-full p-2 border rounded-lg" placeholder="https://...">
          </div>
          <div id="block-book" class="hidden border rounded-xl p-3">
            <label class="block mb-1 font-semibold">×§×™×©×•×¨ ×œ×”×–×× ×ª ×›×¨×˜×™×¡</label>
            <input id="link-book" type="url" class="w-full p-2 border rounded-lg" placeholder="https://...">
          </div>

          <!-- ××¡×œ×•×œ -->
          <div id="block-route" class="hidden border rounded-xl p-3 space-y-2">
            <div class="grid sm:grid-cols-2 gap-2">
              <div class="relative">
                <label class="text-sm">×××™×¤×”</label>
                <input id="route-from" class="w-full p-2 border rounded-lg" placeholder="×›×ª×•×‘×ª ×™×¦×™××”">
              </div>
              <div class="relative">
                <label class="text-sm">×œ××Ÿ</label>
                <input id="route-to" class="w-full p-2 border rounded-lg" placeholder="×›×ª×•×‘×ª ×™×¢×“">
              </div>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <label class="text-sm">××•×¤×Ÿ × ×¡×™×¢×”:</label>
              <select id="route-mode" class="p-2 border rounded-lg">
                <option value="foot">×”×œ×™×›×”</option>
                <option value="driving" selected>× ×”×™×’×”</option>
              </select>
              <button id="route-calc" class="px-3 py-2 border rounded-lg hover:bg-slate-50">×—×©×‘ ××¡×œ×•×œ</button>
              <div id="route-time" class="text-sm text-slate-700"></div>
            </div>
            <div id="route-map" class="w-full h-56 rounded-lg"></div>
          </div>

          <!-- ×—×™×‘×•×¨×™× -->
          <div id="block-connect" class="hidden border rounded-xl p-3">
            <div class="mb-2">
              <div id="selected-refs" class="flex flex-wrap gap-2"></div>
            </div>
            <p class="text-sm text-slate-600 mb-3">×‘×—×¨ ××§×•×¨×•×ª ×œ×§×©×¨ ×œ×›×¨×˜×™×¡: ××˜×¨×§×¦×™×•×ª/××¡×¢×“×•×ª, ××œ×•× ×•×ª ×•××¢×‘×¨×™× (×˜×™×¡×•×ª/×¨×›×‘×•×ª/×¨×›×‘).</p>
            <div id="connect-lists" class="grid gap-3"></div>
          </div>
        </div>

        <!-- ×©×œ×‘ F: ×ª×§×¦×™×¨ -->
        <div id="step-F" class="step">
          <label class="block font-bold mb-1">×ª×§×¦×™×¨ ×§×¦×¨ ×œ×›×¨×˜×™×¡×™×™×”</label>
          <input id="input-summary" type="text" class="w-full p-2 border rounded-lg" placeholder="××” ×™×•×¤×™×¢ ×‘×›×•×ª×¨×ª ×”×›×¨×˜×™×¡?">
        </div>

        <!-- ×©×œ×‘ G: ×”×¢×¨×•×ª -->
        <div id="step-G" class="step">
          <label class="block font-bold mb-1">×”×¢×¨×•×ª ×—×©×•×‘×•×ª</label>
          <textarea id="input-notes" rows="3" class="w-full p-2 border rounded-lg" placeholder="××œ×¨×’×™×•×ª, ×“×’×©×™×, ×ª×–×›×•×¨×•×ª..."></textarea>
        </div>
      </main>

      <footer class="p-4 border-t flex items-center justify-between">
        <button id="prev-step" class="px-4 py-2 rounded-lg hover:bg-slate-100">××—×•×¨×”</button>
        <div class="text-sm text-slate-500" id="step-indicator"></div>
        <div>
          <button id="next-step" class="px-4 py-2 bg-blue-600 text-white rounded-lg">×”×‘×</button>
          <button id="save-item" class="hidden px-4 py-2 bg-emerald-600 text-white rounded-lg">×©××•×¨ ×¤×¨×™×˜</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- MODAL: ×¢×¨×™×›×ª ×›×•×ª×¨×ª ×™×•× ×§×˜×Ÿ -->
  <div id="title-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/60">
    <div class="bg-white rounded-2xl w-full max-w-sm shadow-2xl">
      <div class="p-4 border-b font-bold">×¢×¨×™×›×ª ×›×•×ª×¨×ª ×œ×™×•×</div>
      <div class="p-4">
        <input id="title-edit-input" class="w-full p-2 border rounded-lg" placeholder="×›×•×ª×¨×ª ×”×™×•×">
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="title-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-100">×‘×™×˜×•×œ</button>
        <button id="title-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg">×©××™×¨×”</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ×¦×¤×™×™×” ××œ××” ×‘×¤×¨×™×˜ -->
  <div id="view-modal" class="modal fixed inset-0 z-[60] items-center justify-center p-4 bg-black/60">
    <div class="bg-white rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-2xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 id="view-title" class="text-lg font-bold">â€”</h4>
        <button id="view-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 overflow-y-auto space-y-4">
        <div id="view-time" class="text-slate-600"></div>
        <div id="view-summary" class="text-slate-800"></div>
        <div id="view-desc" class="text-slate-700 whitespace-pre-line"></div>
        <div id="view-address" class="text-slate-700"></div>
        <div id="view-links" class="flex flex-wrap gap-2"></div>
        <div id="view-map" class="w-full h-60 rounded-xl"></div>
      </main>
      <footer class="p-4 border-t flex items-center justify-between">
        <div class="flex gap-2">
          <a id="nav-waze"   target="_blank" class="px-3 py-2 rounded-lg bg-[#33ccff] text-white hidden"><i class="fa-brands fa-waze"></i> × ×•×•×˜</a>
          <a id="nav-gmaps"  target="_blank" class="px-3 py-2 rounded-lg bg-[#4285F4] text-white hidden"><i class="fa-solid fa-location-dot"></i> ××¤×•×ª</a>
        </div>
        <div class="flex gap-2">
          <button id="view-edit"  class="px-3 py-2 rounded-lg bg-amber-500 text-white"><i class="fa-solid fa-pen"></i> ×¢×¨×•×š</button>
          <button id="view-delete" class="px-3 py-2 rounded-lg bg-red-600 text-white"><i class="fa-solid fa-trash"></i> ××—×§</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- ×ª×™×‘×ª ×”×¦×¢×•×ª ×›×œ×œ×™×ª ×©××•×¦××“×ª ×œ-body -->
  <div id="global-typeahead" class="typeahead"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc,
      collection, getDocs, onSnapshot, serverTimestamp, orderBy, query, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // URL
    const p = new URLSearchParams(location.search);
    const tripId = p.get('tripId');
    const urlDate = p.get('date'); // DD/MM/YYYY
    if (!tripId) { alert('×—×¡×¨ tripId'); location.href='index.html'; }

    // DOM
    const dateToggle = document.getElementById('date-toggle');
    const datePanel  = document.getElementById('date-panel');
    const dateCurrent= document.getElementById('date-current');
    const dateList   = document.getElementById('date-list');
    const badgeDate  = document.getElementById('badge-date');

    const backToDay  = document.getElementById('back-to-day');

    const dayTitleInline = document.getElementById('day-title-inline');
    const editDayTitleInline = document.getElementById('edit-day-title-inline');

    const itemsList     = document.getElementById('items-list');
    const addItemBtn    = document.getElementById('add-item-btn');
    const aiBuildBtn    = document.getElementById('ai-build-btn');

    // Item modal refs
    const itemModal    = document.getElementById('item-modal');
    const modalTitle   = document.getElementById('modal-title');
    const closeModal   = document.getElementById('close-modal');
    const prevStepBtn  = document.getElementById('prev-step');
    const nextStepBtn  = document.getElementById('next-step');
    const saveBtn      = document.getElementById('save-item');
    const stepIndicator= document.getElementById('step-indicator');

    const stepA = document.getElementById('step-A');
    const stepB = document.getElementById('step-B');
    const stepC = document.getElementById('step-C');
    const stepD = document.getElementById('step-D');
    const stepE = document.getElementById('step-E');
    const stepF = document.getElementById('step-F');
    const stepG = document.getElementById('step-G');

    const inputDayTitle = document.getElementById('input-day-title');
    const inputItemTitle= document.getElementById('input-item-title');
    const inputStart    = document.getElementById('input-start');
    const inputEnd      = document.getElementById('input-end');
    const toggleEnd     = document.getElementById('toggle-end');
    const endWrap       = document.getElementById('end-wrap');
    const addBackHotel  = document.getElementById('add-back-to-hotel');

    const inputDesc     = document.getElementById('input-desc');
    const inputSummary  = document.getElementById('input-summary');
    const inputNotes    = document.getElementById('input-notes');

    const openBlockBtns = document.querySelectorAll('.open-block');

    const addrInput   = document.getElementById('addr-input');
    const addrMapDiv  = document.getElementById('addr-map');
    const useHotelBtn = document.getElementById('use-hotel-address');
    let addrMap=null, addrMarker=null;

    const linkGeneral = document.getElementById('link-general');
    const linkBook    = document.getElementById('link-book');

    const rFrom       = document.getElementById('route-from');
    const rTo         = document.getElementById('route-to');
    const rMode       = document.getElementById('route-mode');
    const rCalc       = document.getElementById('route-calc');
    const rTime       = document.getElementById('route-time');
    const rMapDiv     = document.getElementById('route-map');
    let routeMap=null, routeLayer=null, routeMarkers=[];

    const connectLists = document.getElementById('connect-lists');
    const selectedRefsWrap = document.getElementById('selected-refs');
    let selectedRefs = []; // [{type:'logistics'|'attraction', id, label, page}]

    // Title small modal
    const titleModal = document.getElementById('title-modal');
    const titleInput = document.getElementById('title-edit-input');
    const titleSave  = document.getElementById('title-save');
    const titleCancel= document.getElementById('title-cancel');

    // View item modal
    const viewModal   = document.getElementById('view-modal');
    const viewClose   = document.getElementById('view-close');
    const viewTitle   = document.getElementById('view-title');
    const viewTime    = document.getElementById('view-time');
    const viewSummary = document.getElementById('view-summary');
    const viewDesc    = document.getElementById('view-desc');
    const viewAddress = document.getElementById('view-address');
    const viewLinks   = document.getElementById('view-links');
    const viewMapDiv  = document.getElementById('view-map');
    const navWaze     = document.getElementById('nav-waze');
    const navGmaps    = document.getElementById('nav-gmaps');
    const viewEditBtn = document.getElementById('view-edit');
    const viewDelBtn  = document.getElementById('view-delete');
    let viewMap=null, viewMarker=null, viewingItem=null;

    // Global typeahead (×¦××•×“ ×œ-body)
    const globalTA = document.getElementById('global-typeahead');
    let taActiveInput = null; // input ×©××œ×™×• ××•×¦××“×ª ×ª×™×‘×ª ×”×”×¦×¢×•×ª
    let taOutsideHandler = null;
    let taScrollHandler = null;

    // State
    let user=null, tripData=null;
    let selectedDate = urlDate || null; // DD/MM/YYYY
    let selectedDest = null;
    let dayDocId=null, dayDocRef=null;
    let dayTitle=null;

    let items=[]; // ×¤×¨×™×˜×™× ×§×™×™××™×
    let currentStepIndex=0;
    const stepsOrder = ['A','B','C','D','E','F','G'];
    let editingItemId = null; // ×›×©×¢×•×¨×›×™×

    // utils
    const pad2 = n => (''+n).padStart(2,'0');
    const toISOFromDDMMYYYY = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${y}-${pad2(m)}-${pad2(d)}`; };
    const toDisplayDotted = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${d}.${m}.${y}`; };
    const weekdayHe = (s)=>{ const [d,m,y]=s.split('/').map(Number); const dt=new Date(y,m-1,d); const w=dt.toLocaleDateString('he-IL',{weekday:'long'}); return w.startsWith('×™×•×')?w:`×™×•× ${w}`; };
    const minutesFromHHMM = (hhmm)=>{ const [h,m]=(hhmm||'00:00').split(':').map(Number); return h*60+m; };
    const haversineMeters = (a,b) => { const R=6371000, t=x=>x*Math.PI/180; const dLa=t(b.lat-a.lat), dLo=t(b.lng-a.lng); const s1=Math.sin(dLa/2)**2 + Math.cos(t(a.lat))*Math.cos(t(b.lat))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(s1)); };

    onAuthStateChanged(auth, async (u)=>{
      if (!u){ location.href='login.html'; return; }
      user=u;
      const tSnap = await getDoc(doc(db,'trips',tripId));
      if (!tSnap.exists()){ alert('×˜×™×•×œ ×œ× × ××¦×'); location.href='index.html'; return; }
      tripData=tSnap.data();
      if (tripData.ownerId!==user.uid){ alert('××™×Ÿ ×”×¨×©××”'); location.href='index.html'; return; }

      buildDateSelector();
      if (!selectedDate){
        const first = tripData.destinations?.[0]?.dates?.split(' - ')?.[0];
        selectedDate = first || null;
      }
      await setWorkingDate(selectedDate);
      backToDay.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(selectedDate)}`;

      const qItems = query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc'));
      onSnapshot(qItems, (snap)=>{
        items = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderItems();
      });
    });

    // Date selector
    function buildDateSelector(){
      dateList.innerHTML='';
      dateCurrent.textContent='×‘×—×¨ ×ª××¨×™×š...';
      tripData.destinations?.forEach(dest=>{
        const dates = expandRange(dest.dates);
        const wrap = document.createElement('div');
        wrap.className='p-3';
        wrap.innerHTML=`<div class="font-bold text-slate-800 mb-2">${dest.nameHe}</div>`;
        dates.forEach(d=>{
          const wd=weekdayHe(d);
          const btn=document.createElement('button');
          btn.className='w-full text-right p-2 rounded hover:bg-slate-100';
          btn.textContent=`${wd} â€“ (${dest.nameHe}) â€¢ ${toDisplayDotted(d)}`;
          btn.addEventListener('click', async ()=>{
            await setWorkingDate(d);
            datePanel.classList.remove('open');
          });
          wrap.appendChild(btn);
        });
        dateList.appendChild(wrap);
      });
      dateToggle.addEventListener('click', ()=> datePanel.classList.toggle('open'));
    }
    function expandRange(r){
      if (!r?.includes(' - ')) return [];
      const [s,e]=r.split(' - ');
      const [sd,sm,sy]=s.split('/').map(Number);
      const [ed,em,ey]=e.split('/').map(Number);
      const start=new Date(sy,sm-1,sd), end=new Date(ey,em-1,ed);
      const out=[]; let cur=new Date(start);
      while(cur<=end){ out.push(`${pad2(cur.getDate())}/${pad2(cur.getMonth()+1)}/${cur.getFullYear()}`); cur.setDate(cur.getDate()+1); }
      return out;
    }
    async function setWorkingDate(ddmmyyyy){
      selectedDate=ddmmyyyy;
      const iso=toISOFromDDMMYYYY(ddmmyyyy);
      dayDocId=iso; dayDocRef=doc(db,'trips',tripId,'schedules',dayDocId);

      selectedDest = tripData.destinations?.find(d=> expandRange(d.dates).includes(ddmmyyyy)) || null;

      dateCurrent.textContent = `${weekdayHe(ddmmyyyy)} â€“ (${selectedDest?.nameHe || '×œ×œ× ×™×¢×“'}) â€¢ ${toDisplayDotted(ddmmyyyy)}`;
      badgeDate.textContent   = `${weekdayHe(ddmmyyyy)} â€¢ ${toDisplayDotted(ddmmyyyy)}`;

      const snap=await getDoc(dayDocRef);
      if (snap.exists()) dayTitle = snap.data().title || null;
      else { dayTitle=null; await setDoc(dayDocRef,{title:null,date:ddmmyyyy,destination:selectedDest?.nameHe||null},{merge:true}); }
      reflectDayTitleUI();

      backToDay.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(selectedDate)}`;
    }
    function reflectDayTitleUI(){
      dayTitleInline.textContent = dayTitle || '×œ× × ×§×‘×¢×”';
      editDayTitleInline.classList.toggle('hidden', !dayTitle);
    }

    // ×¢×¨×™×›×ª ×›×•×ª×¨×ª ×™×•× ×§×˜×Ÿ
    editDayTitleInline.addEventListener('click', ()=>{
      titleInput.value = dayTitle || '';
      titleModal.classList.add('show');
    });
    titleCancel.addEventListener('click', ()=> titleModal.classList.remove('show'));
    titleSave.addEventListener('click', async ()=>{
      const t=(titleInput.value||'').trim();
      await setDoc(dayDocRef,{title: t || null, updatedAt: serverTimestamp()},{merge:true});
      dayTitle = t || null;
      reflectDayTitleUI();
      titleModal.classList.remove('show');
    });

    // Items rendering + open view
    function renderItems(){
      if (!items.length){
        itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>`;
        return;
      }
      itemsList.innerHTML = items.map(it=>{
        const time = `${it.startTime || ''}${it.endTime ? ' â€“ ' + it.endTime : ''}`;
        const dist = (it.distanceFromPreviousMeters!=null)
          ? `<span class="text-xs text-slate-500"> â€¢ ××¨×—×§ ×§×•×“×: ${(it.distanceFromPreviousMeters/1000).toFixed(2)} ×§×´×</span>` : '';
        const addr = it.address?.label ? `<div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-location-dot"></i> ${it.address.label}</div>` : '';
        return `<button class="card w-full text-right bg-white rounded-xl border shadow p-4" data-id="${it.id}">
          <div class="flex items-center justify-between">
            <div class="font-bold text-blue-700">${it.title || '(×œ×œ× ×›×•×ª×¨×ª)'}</div>
            <div class="text-sm text-slate-600">${time}${dist}</div>
          </div>
          ${it.summary ? `<div class="text-slate-700 mt-1">${it.summary}</div>`:''}
          ${addr}
        </button>`;
      }).join('');

      // click -> view modal
      itemsList.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click',()=> openViewModal(b.dataset.id));
      });
    }

    // ----- Item modal flow -----
    function openItemModal(item=null){
      editingItemId = item?.id || null;
      modalTitle.textContent = editingItemId ? '×¢×¨×™×›×ª ×¤×¨×™×˜' : '×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×™×•×';

      // reset/assign
      inputDayTitle.value = dayTitle || '';
      inputItemTitle.value = item?.title || '';
      inputStart.value = item?.startTime || '';
      inputEnd.value   = item?.endTime || '';
      inputDesc.value  = item?.description || '';
      inputSummary.value = item?.summary || '';
      inputNotes.value   = item?.notes || '';
      linkGeneral.value  = item?.links?.site || '';
      linkBook.value     = item?.links?.booking || '';
      endWrap.classList.toggle('hidden', !item?.endTime);

      // refs ×§×™×™××™×
      selectedRefs = Array.isArray(item?.refs) ? [...item.refs] : [];
      renderSelectedRefs();

      // ×›×ª×•×‘×ª
      if (!addrMap){ addrMap = L.map(addrMapDiv).setView([31.77,35.21], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap); }
      if (addrMarker){ addrMap.removeLayer(addrMarker); addrMarker=null; }
      addrInput.value = item?.address?.label || '';
      if (item?.address?.lat && item?.address?.lng){
        addrMarker = L.marker([item.address.lat,item.address.lng]).addTo(addrMap);
        addrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
        addrMap.setView([item.address.lat,item.address.lng], 14);
      }

      // route
      if (!routeMap){ routeMap = L.map(rMapDiv).setView([31.77,35.21], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap); }
      if (routeLayer){ routeMap.removeLayer(routeLayer); routeLayer=null; }
      routeMarkers.forEach(m=> m && routeMap.removeLayer(m));
      routeMarkers=[null,null];
      rFrom.value = item?.travel?.from?.label || '';
      rTo.value   = item?.travel?.to?.label   || '';
      rMode.value = item?.travel?.mode || 'driving';
      rTime.textContent = item?.travel?.timeText || '';

      if (item?.travel?.from?.lat){
        routeMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(routeMap);
        routeMarkers[0]._data = item.travel.from;
      }
      if (item?.travel?.to?.lat){
        routeMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(routeMap);
        routeMarkers[1]._data = item.travel.to;
      }
      if (routeMarkers[0] && routeMarkers[1]) routeMap.fitBounds(L.featureGroup(routeMarkers).getBounds(),{padding:[20,20]});

      // steps â€“ ×× ×›×‘×¨ ×™×© ×›×•×ª×¨×ª ×œ×™×•× × ×“×œ×’ ×¢×œ A
      showStep(dayTitle ? 'B' : 'A');
      itemModal.classList.add('show');
      setTimeout(()=>{ addrMap.invalidateSize(); routeMap.invalidateSize(); }, 160);
    }
    addItemBtn.addEventListener('click', ()=> openItemModal());
    closeModal.addEventListener('click', ()=> { itemModal.classList.remove('show'); hideTypeahead(); });

    function showStep(code){
      [stepA,stepB,stepC,stepD,stepE,stepF,stepG].forEach(s=>s.classList.remove('active'));
      const idx = stepsOrder.indexOf(code);
      currentStepIndex = Math.max(0, idx);
      document.getElementById('step-'+code).classList.add('active');
      stepIndicator.textContent = `×©×œ×‘ ${currentStepIndex+1} ××ª×•×š ${stepsOrder.length}`;
      saveBtn.classList.toggle('hidden', code!=='G');
      nextStepBtn.classList.toggle('hidden', code==='G');
      prevStepBtn.disabled = (code=== (dayTitle ? 'B' : 'A'));
    }
    nextStepBtn.addEventListener('click', async ()=>{
      const cur = stepsOrder[currentStepIndex];
      if (cur==='A'){
        const t=(inputDayTitle.value||'').trim();
        await setDoc(dayDocRef,{ title: t || null, updatedAt: serverTimestamp() },{merge:true});
        dayTitle = t || null;
        reflectDayTitleUI();
      }
      showStep(stepsOrder[currentStepIndex+1]);
    });
    prevStepBtn.addEventListener('click', ()=> showStep(stepsOrder[currentStepIndex-1]));
    toggleEnd.addEventListener('click', ()=> endWrap.classList.toggle('hidden'));

    // ---- Typeahead ×¦×£ (××•×¦××“ ×œ-body) ----
    function placeTypeaheadBelow(inputEl){
      const r = inputEl.getBoundingClientRect();
      Object.assign(globalTA.style, {
        left: r.left+'px',
        top: (r.bottom+6)+'px',
        width: r.width+'px',
      });
    }
    function showTypeaheadFor(inputEl, items){
      taActiveInput = inputEl;
      // ×‘×•× ×™× ×›×¤×ª×•×¨×™×
      globalTA.innerHTML = items.map(r=>`<button data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`).join('');
      [...globalTA.querySelectorAll('button')].forEach(b=>{
        b.addEventListener('click', ()=>{
          const picked = {
            lat: parseFloat(b.dataset.lat),
            lng: parseFloat(b.dataset.lon),
            label: b.textContent
          };
          taActiveInput.dispatchEvent(new CustomEvent('typeahead:pick',{detail:picked}));
          hideTypeahead();
        }, {once:true});
      });
      placeTypeaheadBelow(inputEl);
      globalTA.classList.add('open');

      // ×¡×’×™×¨×” ×‘×œ×—×™×¦×” ×‘×—×•×¥/ESC/×’×œ×™×œ×”/resize
      if (!taOutsideHandler){
        taOutsideHandler = (e)=>{ if (e.target!==globalTA && e.target!==taActiveInput && !globalTA.contains(e.target)) hideTypeahead(); };
        document.addEventListener('mousedown', taOutsideHandler);
        document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') hideTypeahead(); }, {once:true});
      }
      if (!taScrollHandler){
        taScrollHandler = ()=>{ if (taActiveInput) placeTypeaheadBelow(taActiveInput); };
        window.addEventListener('scroll', taScrollHandler, true);
        window.addEventListener('resize', taScrollHandler);
      }
    }
    function hideTypeahead(){
      globalTA.classList.remove('open');
      globalTA.innerHTML='';
      taActiveInput = null;
      if (taOutsideHandler){ document.removeEventListener('mousedown', taOutsideHandler); taOutsideHandler=null; }
      if (taScrollHandler){ window.removeEventListener('scroll', taScrollHandler, true); window.removeEventListener('resize', taScrollHandler); taScrollHandler=null; }
    }
    function bindTypeahead(inputEl, onPick){
      let timer=null;
      inputEl.addEventListener('input', ()=>{
        const q = inputEl.value.trim();
        clearTimeout(timer);
        if (!q){ hideTypeahead(); return; }
        timer = setTimeout(async ()=>{
          try{
            const url=`https://nominatim.openstreetmap.org/search?format=json&limit=8&q=${encodeURIComponent(q)}`;
            const res=await fetch(url); const arr=await res.json();
            if (Array.isArray(arr) && arr.length) showTypeaheadFor(inputEl, arr);
            else hideTypeahead();
          }catch{ hideTypeahead(); }
        }, 220);
      });
      inputEl.addEventListener('blur', ()=>{ /* × ×©××¨ ×¤×ª×•×— ×¢×“ ×§×œ×™×§/ESC */ });
      inputEl.addEventListener('typeahead:pick', (ev)=> onPick(ev.detail));
    }

    // ×—×™×‘×•×¨×™ ××•×˜×•×§×•××¤×œ×™×˜
    bindTypeahead(addrInput, (p)=>{
      addrInput.value=p.label;
      if(!addrMap){ addrMap = L.map(addrMapDiv).setView([p.lat,p.lng], 13); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap); }
      if(!addrMarker) addrMarker = L.marker([p.lat,p.lng]).addTo(addrMap); else addrMarker.setLatLng([p.lat,p.lng]);
      addrMarker._data = p; addrMap.setView([p.lat,p.lng], 15);
    });
    function setRoutePoint(idx,p){
      if(!routeMap){ routeMap = L.map(rMapDiv).setView([p.lat,p.lng], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap); }
      if(!routeMarkers[idx]) routeMarkers[idx]=L.marker([p.lat,p.lng]).addTo(routeMap);
      else routeMarkers[idx].setLatLng([p.lat,p.lng]);
      routeMarkers[idx]._data=p;
      routeMap.setView([p.lat,p.lng], 13);
    }
    bindTypeahead(rFrom, (p)=>{ rFrom.value=p.label; setRoutePoint(0,p); });
    bindTypeahead(rTo,   (p)=>{ rTo.value=p.label;   setRoutePoint(1,p); });

    rCalc.addEventListener('click', async ()=>{
      if (!routeMarkers[0]?._data || !routeMarkers[1]?._data) return alert('×‘×—×¨ ×’× ××•×¦× ×•×’× ×™×¢×“.');
      const a=routeMarkers[0]._data, b=routeMarkers[1]._data;
      const profile = (rMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        rTime.textContent=`×–××Ÿ ××©×•×¢×¨: ${mins} ×“×§×³`;
        if (routeLayer) routeMap.removeLayer(routeLayer);
        routeLayer=L.geoJSON(r.geometry).addTo(routeMap);
        routeMap.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
      } else rTime.textContent='×œ× × ××¦× ××¡×œ×•×œ.';
    });

    // ×›×ª×•×‘×ª ××œ×•×Ÿ
    useHotelBtn.addEventListener('click', async ()=>{
      const h = await findHotelForDate(selectedDate, selectedDest?.nameHe);
      if (!h) return alert('××™×Ÿ ××œ×•×Ÿ ××•×’×“×¨ ×œ×ª××¨×™×š ×–×”.');
      addrInput.value = h.address || h.name || '';
      const c = h.coords || h.location || null;
      if (c?.lat && c?.lng){
        if(!addrMarker) addrMarker=L.marker([c.lat,c.lng]).addTo(addrMap);
        else addrMarker.setLatLng([c.lat,c.lng]);
        addrMarker._data = {label:addrInput.value, lat:c.lat, lng:c.lng};
        addrMap.setView([c.lat,c.lng], 15);
      }
    });
    async function findHotelForDate(ddmmyyyy, destName){
      const qSnap = await getDocs(collection(db,'trips',tripId,'logistics'));
      const hotels = qSnap.docs.map(d=>({id:d.id,...d.data()})).filter(x=>x.type==='hotel');
      const inRange = (range)=> expandRange(range).includes(ddmmyyyy);
      const byDest = hotels.find(h=> (h.destination===destName || !destName) && inRange(h.dates||''));
      return byDest || hotels.find(h=> inRange(h.dates||''));
    }

    // ---- ×—×™×‘×•×¨×™× (link to logistics/attractions) ----
    function renderSelectedRefs(){
      selectedRefsWrap.innerHTML = selectedRefs.length ? selectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm">×œ× × ×‘×—×¨×• ×§×™×©×•×¨×™×.</span>`;
      selectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          selectedRefs.splice(idx,1);
          renderSelectedRefs();
        });
      });
    }
    function iconForRef(r){
      if (r.type==='logistics'){
        if (r.subType==='hotel') return 'ğŸ¨';
        if (r.subType==='flight') return 'âœˆï¸';
        if (r.subType==='train') return 'ğŸš†';
        if (r.subType==='car_rental') return 'ğŸš—';
        if (r.subType==='ferry') return 'â›´ï¸';
        return 'â¬…ï¸';
      }
      return 'ğŸ“';
    }
    async function buildConnectLists(){
      connectLists.innerHTML='×˜×•×¢×Ÿ...';
      const [logSnap, attSnap] = await Promise.all([
        getDocs(collection(db,'trips',tripId,'logistics')),
        getDocs(collection(db,'trips',tripId,'attractions'))
      ]);
      const logistics = logSnap.docs.map(d=>({id:d.id, ...d.data()}));
      const attractions = attSnap.docs.map(d=>({id:d.id, ...d.data()}));

      const card = (title, sub, openHref, pickHandlerText='×‘×—×¨', picked=false)=>`
        <div class="p-3 rounded-lg border bg-white flex items-center justify-between">
          <div>
            <div class="font-bold">${title}</div>
            ${sub?`<div class="text-xs text-slate-500">${sub}</div>`:''}
          </div>
          <div class="flex gap-2">
            <a href="${openHref}" class="text-blue-600 hover:underline text-sm" target="_blank">×¤×ª×—</a>
            <button class="px-2 py-1 rounded border text-sm ${picked?'bg-green-600 text-white border-green-600':'hover:bg-slate-50'} pick-btn">${picked?'× ×‘×—×¨':'×‘×—×¨'}</button>
          </div>
        </div>`;

      let html='';
      // ××¢×‘×¨×™× ×•××œ×•× ×•×ª
      if (logistics.length){
        html+=`<div><div class="font-bold mb-2">××¢×‘×¨×™× ×•××œ×•× ×•×ª</div><div class="grid gap-2">`;
        html+= logistics.map(l=>{
          const label = (l.type==='hotel'?'××œ×•×Ÿ: ':'') + (l.name||l.destination||l.type);
          const sub   = l.dates || l.date || '';
          const href  = `summary.html?tripId=${tripId}&open=logistics&id=${l.id}`;
          const picked= selectedRefs.some(r=>r.type==='logistics' && r.id===l.id);
          return `<div data-ref-type="logistics" data-ref-id="${l.id}" data-ref-subtype="${l.type}" data-ref-label="${label}">${card(iconForRef({type:'logistics',subType:l.type})+' '+label, sub, href, '×‘×—×¨', picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      // ××˜×¨×§×¦×™×•×ª/××¡×¢×“×•×ª
      if (attractions.length){
        html+=`<div class="mt-4"><div class="font-bold mb-2">××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</div><div class="grid gap-2">`;
        html+= attractions.map(a=>{
          const label = a.name || a.title || '×¤×¨×™×˜';
          const sub   = a.destination || '';
          const href  = `attractions.html?tripId=${tripId}&open=attraction&id=${a.id}`;
          const picked= selectedRefs.some(r=>r.type==='attraction' && r.id===a.id);
          return `<div data-ref-type="attraction" data-ref-id="${a.id}" data-ref-label="${label}">${card('ğŸ“ '+label, sub, href, '×‘×—×¨', picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }

      connectLists.innerHTML = html || '<div class="text-slate-500">××™×Ÿ × ×ª×•× ×™× ×œ×”×¦×’×”.</div>';

      // ×—×™×‘×•×¨ ×‘×—×™×¨×”
      connectLists.querySelectorAll('.pick-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const wrap=btn.closest('[data-ref-type]');
          const type=wrap.dataset.refType;
          const id  =wrap.dataset.refId;
          const subType = wrap.dataset.refSubtype || null;
          const label=wrap.dataset.refLabel;
          const idx = selectedRefs.findIndex(r=>r.type===type && r.id===id);
          if (idx>-1){ selectedRefs.splice(idx,1); btn.textContent='×‘×—×¨'; btn.classList.remove('bg-green-600','text-white','border-green-600'); }
          else { selectedRefs.push({type, id, label, page:(type==='logistics'?'summary':'attractions'), subType}); btn.textContent='× ×‘×—×¨'; btn.classList.add('bg-green-600','text-white','border-green-600'); }
          renderSelectedRefs();
        });
      });
    }
    // ×¤×ª×™×—×ª ×‘×œ×•×§ ×—×™×‘×•×¨×™× â€” ×˜×•×¢×Ÿ ×¤×¢× ×¨××©×•× ×”
    document.querySelector('[data-open="#block-connect"]').addEventListener('click', async (e)=>{
      const el=document.querySelector('#block-connect');
      setTimeout(async ()=>{
        if (!el.classList.contains('hidden')) await buildConnectLists();
      }, 0);
    });

    // ×©××™×¨×” + ×—×™×©×•×‘ ××¨×—×§×™×
    saveBtn.addEventListener('click', async ()=>{
      const payload = collectItemFromModal();
      await saveItemCore(payload, editingItemId);
      itemModal.classList.remove('show');
      hideTypeahead();
      editingItemId = null;
    });

    function collectItemFromModal(){
      return {
        title: (inputItemTitle.value||'').trim() || '(×œ×œ× ×›×•×ª×¨×ª)',
        startTime: inputStart.value || null,
        endTime:   inputEnd.value   || null,
        description: (inputDesc.value||'').trim() || null,
        summary:     (inputSummary.value||'').trim() || null,
        notes:       (inputNotes.value||'').trim() || null,
        links: { site:(linkGeneral.value||'').trim() || null, booking:(linkBook.value||'').trim() || null },
        address: addrMarker?._data ? { label: addrMarker._data.label, lat: addrMarker._data.lat, lng: addrMarker._data.lng } : null,
        travel: (routeMarkers[0]?._data && routeMarkers[1]?._data) ? {
          from: routeMarkers[0]._data, to: routeMarkers[1]._data, mode: rMode.value, timeText: rTime.textContent || null
        } : null,
        refs: selectedRefs
      };
    }

    async function saveItemCore(payload, editId=null){
      await setDoc(dayDocRef,{ title: dayTitle || null, updatedAt: serverTimestamp() },{merge:true});
      const thisSort = minutesFromHHMM(payload.startTime||'00:00');
      if (editId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',editId), { ...payload, sort:thisSort, updatedAt: serverTimestamp() });
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'items'), { ...payload, sort:thisSort, date:selectedDate, destination:selectedDest?.nameHe||null, createdAt: serverTimestamp() });
      }
      await recomputeDistances();
    }

    async function recomputeDistances(){
      const snap = await getDocs(query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc')));
      const arr = snap.docs.map(d=>({id:d.id,...d.data()}));
      for (let i=0;i<arr.length;i++){
        let dist=null;
        const a = arr[i-1], b=arr[i];
        if (a?.address?.lat!=null && b?.address?.lat!=null){
          dist = Math.round(haversineMeters({lat:a.address.lat,lng:a.address.lng},{lat:b.address.lat,lng:b.address.lng}));
        }
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',b.id), { distanceFromPreviousMeters: dist });
      }
    }

    // ×—×–×¨×” ×œ××œ×•×Ÿ ××™×™×“×™×ª
    addBackHotel.addEventListener('click', async ()=>{
      if (!inputStart.value) return alert('×‘×—×¨ ×©×¢×ª ×”×ª×—×œ×” ×œ×—×–×¨×” ×œ××œ×•×Ÿ.');
      const h = await findHotelForDate(selectedDate, selectedDest?.nameHe);
      if (!h) return alert('×œ× × ××¦× ××œ×•×Ÿ ×œ×ª××¨×™×š ×–×”.');
      await saveItemCore({
        title:'×—×–×¨×” ×œ××œ×•×Ÿ',
        startTime: inputStart.value, endTime:null,
        summary:'×¡×™×•× ×”×™×•× ×•×—×–×¨×” ×œ××œ×•×Ÿ',
        address: h.address ? { label:h.address, lat:h.coords?.lat, lng:h.coords?.lng } : null,
        isBackToHotel:true,
        refs: []
      }, null);
      itemModal.classList.remove('show');
      hideTypeahead();
    });

    // ×‘×œ×•×§×™× ×œ×¤×ª×™×—×”/×¡×’×™×¨×”
    openBlockBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const el=document.querySelector(b.dataset.open);
        el.classList.toggle('hidden');
        if (el.id==='block-address') setTimeout(()=>addrMap.invalidateSize(),100);
        if (el.id==='block-route') setTimeout(()=>routeMap.invalidateSize(),100);
      });
    });

    // AI button (placeholder)
    aiBuildBtn.addEventListener('click', ()=>{
      alert('×‘×§×¨×•×‘ × ×•×¡×™×£ ×‘× ×™×™×” ××•×˜×•××˜×™×ª ×¢× AI ×œ×¤×™ ×™×¢×“/×©×¢×•×ª ×¤×ª×™×—×”/×”×¢×“×¤×•×ª âœ¨');
    });

    // ----- View item modal -----
    async function openViewModal(id){
      const it = items.find(x=>x.id===id);
      if (!it) return;
      viewingItem = it;

      viewTitle.textContent = it.title || '(×œ×œ× ×›×•×ª×¨×ª)';
      viewTime.textContent  = [it.startTime, it.endTime?('â€” '+it.endTime):''].filter(Boolean).join(' ');
      viewSummary.textContent = it.summary || '';
      viewSummary.classList.toggle('hidden', !it.summary);
      viewDesc.textContent = it.description || '';
      viewDesc.classList.toggle('hidden', !it.description);

      // ×§×™×©×•×¨×™ refs (××¦×™×’ ×›×¤×ª×•×¨×™× ×œ×¢××•×“×™×)
      let refsHtml='';
      if (Array.isArray(it.refs) && it.refs.length){
        refsHtml = it.refs.map(r=>{
          const href = `${r.page==='summary'?'summary':'attractions'}.html?tripId=${tripId}&open=${r.type==='logistics'?'logistics':'attraction'}&id=${r.id}`;
          return `<a class="px-3 py-2 rounded-lg bg-indigo-600 text-white" target="_blank" href="${href}">${iconForRef(r)} ${r.label}</a>`;
        }).join(' ');
      }

      // ×§×™×©×•×¨×™× ×›×œ×œ×™×™×
      viewLinks.innerHTML = [
        it.links?.site ? `<a class="px-3 py-2 rounded-lg bg-slate-800 text-white" target="_blank" href="${it.links.site}"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
        it.links?.booking ? `<a class="px-3 py-2 rounded-lg bg-emerald-600 text-white" target="_blank" href="${it.links.booking}"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
        refsHtml
      ].filter(Boolean).join(' ');

      if (it.address?.label){
        viewAddress.innerHTML = `<i class="fa-solid fa-location-dot"></i> ${it.address.label}`;
        navWaze.href  = `https://waze.com/ul?q=${encodeURIComponent(it.address.label)}`;
        navGmaps.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}`;
        navWaze.classList.remove('hidden'); navGmaps.classList.remove('hidden');
      } else {
        viewAddress.innerHTML = '';
        navWaze.classList.add('hidden'); navGmaps.classList.add('hidden');
      }

      // ××¤×”
      setTimeout(()=>{
        if (!viewMap){ viewMap = L.map(viewMapDiv).setView([31.77,35.21], 12); L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(viewMap); }
        if (viewMarker){ viewMap.removeLayer(viewMarker); viewMarker=null; }
        if (it.address?.lat){
          viewMarker = L.marker([it.address.lat,it.address.lng]).addTo(viewMap);
          viewMap.setView([it.address.lat,it.address.lng], 15);
        }
        viewMap.invalidateSize();
      },120);

      viewEditBtn.onclick = ()=>{ viewModal.classList.remove('show'); openItemModal(it); };
      viewDelBtn.onclick  = async ()=>{
        if (!confirm('×œ××—×•×§ ××ª ×”×¤×¨×™×˜?')) return;
        await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',it.id));
        await recomputeDistances();
        viewModal.classList.remove('show');
      };

      viewModal.classList.add('show');
    }
    viewClose.addEventListener('click', ()=> viewModal.classList.remove('show'));

  </script>
</body>
</html>