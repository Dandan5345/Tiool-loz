<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>יצירת/עריכת לו״ז</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; }
    html { scrollbar-gutter: stable both-edges; }
    body {
      font-family: 'Assistant', sans-serif;
      min-height: 100dvh;
      overscroll-behavior-y: none;
      -webkit-overflow-scrolling: touch;
      background-color: #f8fafc;
      /* מניעת גלילה אופקית */
      max-width: 100vw;
      overflow-x: hidden;
    }
    .bg-fixed {
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(59,130,246,.2), transparent 70%),
        radial-gradient(900px 700px at 10% 110%, rgba(16,185,129,.2), transparent 70%),
        #f8fafc;
    }
    .sheet { background: rgba(255,255,255,.95); backdrop-filter: blur(8px); border: 1px solid rgba(0,0,0,0.05); }
    .submenu { max-height: 0; overflow: hidden; transition: max-height .4s ease; }
    .submenu.open { max-height: 1000px; }
    
    .modal { display: none; opacity: 0; transition: opacity .2s ease-out; }
    .modal.show { display: flex; opacity: 1; }
    .modal-content {
        transform: scale(.95);
        opacity: 0;
        transition: transform .2s ease-out, opacity .2s ease-out;
    }
    .modal.show .modal-content { transform: scale(1); opacity: 1; }

    .step { display: none; }
    .step.active { display: block; }

    .typeahead {
      position: fixed; z-index: 99999; background: #fff; border: 1px solid #e5e7eb;
      border-radius: .75rem; max-height: 260px; overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.1); display: none;
    }
    .typeahead.open { display: block; }
    .typeahead button { width: 100%; text-align: right; padding: .6rem .8rem; line-height: 1.35; white-space: normal; }
    .typeahead button:hover { background:#f8fafc; }

    .card { 
        transition: transform .15s ease, box-shadow .15s ease; 
        border-right: 4px solid #3b82f6;
        /* מניעת בחירת טקסט בלחיצה ארוכה לגרירה חלקה */
        -webkit-user-select: none;
        user-select: none;
    }
    .card:hover { 
        transform: translateY(-3px); 
        box-shadow: 0 8px 25px rgba(2,6,23,.07); 
    }
    .card.needs-verify { 
        border-right-color: #ef4444;
        background: #fef2f2;
    }
    
    .chip {
      display: inline-flex; align-items: center; gap:.4rem;
      padding:.25rem .55rem; border-radius: 999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
      font-size:.85rem; font-weight: 600;
    }
    .chip .x { cursor: pointer; color:#6366f1; }

    .badge-verify {
      display:inline-flex; align-items:center; gap:.35rem;
      background:#fee2e2; color:#b91c1c; border:1px solid #fecaca;
      font-size:.75rem; padding:.15rem .5rem; border-radius:999px; font-weight: 600;
    }
    .banner-warn {
      background:#fffbeb; color:#b45309; border:1px solid #fde68a;
      padding:.75rem 1rem; border-radius:.6rem; font-size:.9rem;
    }

    .input-with-btn { display:flex; gap:.5rem; }
    .input-with-btn input { flex:1 1 auto; }
    
    .loader {
        width: 1.2rem; height: 1.2rem;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Help Modal Content Styling */
    .help-content h5 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-top: 1rem; margin-bottom: 0.5rem; }
    .help-content p { color: #475569; line-height: 1.6; }
    .help-content .icon { color: #64748b; }

    ._safelist { color: #0000; background: linear-gradient(#fff,#fff); }
    
    /* Better modal scrolling */
    .scroll-smooth { -webkit-overflow-scrolling: touch; }
  </style>
</head>
<body>

  <!-- Safelist בלתי נראה -->
  <div class="hidden">
    <div class="bg-red-50 border-red-300 text-red-800"></div>
    <div class="bg-green-50 border-green-300 text-green-800"></div>
    <div class="bg-blue-50 border-blue-300 text-blue-800"></div>
    <div class="bg-yellow-50 border-yellow-300 text-yellow-800"></div>
    <div class="bg-orange-50 border-orange-300 text-orange-800"></div>
  </div>

  <!-- רקע -->
  <div class="fixed inset-0 -z-10 bg-fixed"></div>

  <!-- Header -->
  <header class="bg-white/80 backdrop-blur-md sticky top-0 z-30 shadow-sm">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a id="back-to-day" href="#" class="p-2 text-slate-700 hover:text-blue-600 transition-colors" title="חזרה ללוז היומי">
            <i class="fa-solid fa-arrow-right"></i>
          </a>
          <h1 class="text-xl font-bold text-slate-800">יצירת/עריכת לו״ז</h1>
        </div>
        <div class="flex items-center gap-2">
          <!-- Help Button -->
          <button id="help-btn" class="p-2 h-10 w-10 flex items-center justify-center text-slate-600 hover:text-blue-600 hover:bg-slate-100 rounded-full transition-colors" title="עזרה">
            <i class="fa-solid fa-question"></i>
          </button>
          <div id="auth-slot" class="text-slate-700 text-xs sm:text-sm"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">
    <!-- בחירת תאריך/יעד + כותרת יום -->
    <section class="sheet rounded-2xl p-5 shadow-lg space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-2xl font-extrabold text-slate-900">בחר תאריך ליום העבודה</h2>
          <p class="text-slate-600">ברירת המחדל — התאריך שממנו הגעת.</p>
        </div>
        <div class="w-full md:w-[460px]">
          <button id="date-toggle" class="w-full flex items-center justify-between bg-white p-3 rounded-xl border shadow-sm hover:bg-slate-50 transition-colors">
            <span id="date-current" class="font-bold text-slate-700">טוען...</span>
            <i class="fa-solid fa-chevron-down text-slate-500 transition-transform"></i>
          </button>
          <div id="date-panel" class="submenu bg-white rounded-xl border shadow-lg mt-2 overflow-hidden">
            <div id="date-list" class="max-h-80 overflow-y-auto divide-y"></div>
          </div>
        </div>
      </div>
      <div class="flex items-center flex-wrap gap-2 text-slate-800">
        <div id="badge-date" class="px-3 py-1 rounded-full bg-sky-100 text-sky-800 border border-sky-200 text-sm font-semibold">—</div>
        <div class="flex items-center gap-2">
          <span class="text-sm text-slate-500">כותרת היום:</span>
          <strong id="day-title-inline" class="text-blue-700 font-semibold break-words">לא נקבעה</strong>
          <button id="edit-day-title-inline" class="hidden text-slate-600 hover:text-blue-600" title="עריכת כותרת"><i class="fa-solid fa-pen"></i></button>
        </div>
      </div>
    </section>

    <!-- פריטים + כפתורים -->
    <section class="sheet rounded-2xl p-5 shadow-lg">
      <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
        <h3 class="text-xl font-bold text-slate-900">פריטי לו״ז ליום זה</h3>
        <div class="flex gap-2 flex-wrap">
          <button id="add-item-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-semibold rounded-lg transition-colors shadow-sm">
            <i class="fa-solid fa-plus"></i> הוסף לוז
          </button>
          <button id="ai-build-btn" class="inline-flex items-center gap-2 px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white font-semibold rounded-lg transition-colors shadow-sm">
            <i class="fa-solid fa-wand-magic-sparkles"></i> יצירת לוז עם AI
          </button>
          <button id="delete-all-btn" class="hidden inline-flex items-center gap-2 px-4 py-2 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors shadow-sm">
            <i class="fa-solid fa-trash-can"></i> מחק הכל
          </button>
        </div>
      </div>

      <div id="items-list" class="mt-4 space-y-3">
        <div class="text-slate-500 p-6 text-center">אין פריטים עדיין.</div>
      </div>

      <!-- הדגשים/טיפים -->
      <div class="mt-8 border-t pt-4">
        <div class="flex items-center justify-between mb-2">
          <h4 class="text-lg font-bold text-slate-800">דגשים וטיפים ליום זה</h4>
          <button id="add-note-btn" class="inline-flex items-center gap-2 px-3 py-2 rounded-lg bg-amber-600 hover:bg-amber-700 text-white font-semibold transition-colors shadow-sm">
            <i class="fa-solid fa-lightbulb"></i> הוספת דגש/טיפ
          </button>
        </div>
        <div id="notes-list" class="grid gap-3">
          <div class="text-slate-500">אין עדיין דגשים/טיפים.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Help Modal -->
  <div id="help-modal" class="modal fixed inset-0 z-[90] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-600"></i> מרכז העזרה</h4>
        <button id="help-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto flex-1 help-content scroll-smooth">
        <p class="mb-4">ברוך הבא לעמוד יצירת ועריכת הלו"ז. כאן תוכל לבנות את סדר היום שלך בצורה ידנית או בעזרת AI.</p>
        <!-- Content trimmed for brevity -->
        <h5><i class="fa-solid fa-calendar-day icon"></i> בחירת תאריך וכותרת</h5>
        <p>בחלק העליון של הדף תוכל לבחור את התאריך שעבורו תרצה לערוך את הלו"ז. לאחר בחירת תאריך, תוכל להגדיר לו "כותרת יום".</p>
      </main>
    </div>
  </div>

  <!-- Generic Confirmation Modal -->
  <div id="confirm-modal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-black/70">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl">
      <div class="p-5 text-center">
        <div id="confirm-icon" class="w-12 h-12 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
        </div>
        <h4 id="confirm-title" class="text-lg font-bold text-slate-800">אישור פעולה</h4>
        <p id="confirm-message" class="text-slate-600 mt-2">האם אתה בטוח?</p>
      </div>
      <div class="p-4 bg-slate-50 flex justify-center gap-3 rounded-b-2xl">
        <button id="confirm-cancel" class="px-6 py-2 rounded-lg hover:bg-slate-200 font-semibold">ביטול</button>
        <button id="confirm-ok" class="px-6 py-2 bg-red-600 text-white rounded-lg font-semibold">אישור</button>
      </div>
    </div>
  </div>

  <!-- Hotel Select Modal -->
  <div id="hotel-select-modal" class="modal fixed inset-0 z-[85] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl">
      <div class="p-4 border-b font-bold">בחירת מלון</div>
      <div class="p-4 space-y-2">
          <p class="text-sm text-slate-600">נמצאו מספר מלונות בתאריך זה. בחר את המלון הרצוי:</p>
          <select id="hotel-select-dropdown" class="w-full p-2 border rounded-lg"></select>
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="hotel-select-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-100">ביטול</button>
        <button id="hotel-select-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg">בחירה</button>
      </div>
    </div>
  </div>

  <!-- MODAL: יצירת/עריכת פריט -->
  <div id="item-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-2xl max-h-[95vh] flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 id="modal-title" class="text-lg font-bold">הוספת פריט ליום</h4>
        <button id="close-modal" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto flex-1 space-y-5 scroll-smooth">
        <div id="verify-banner" class="banner-warn hidden">
          לכרטיסיה זו דרוש אימות: ודא כתובת/מסלול במפה ו/או קישור לאטרקציות/מעברים ואז שמור.
        </div>
        <div id="step-A" class="step">
          <label class="block font-bold mb-1">כותרת כללית ליום</label>
          <input id="input-day-title" type="text" class="w-full p-2 border rounded-lg" placeholder="למשל: 'יום מוזיאונים ואוכל רחוב'">
          <p class="text-xs text-slate-500 mt-2">שאלה זו תידלג אוטומטית לאחר שתשמר כותרת ליום.</p>
        </div>
        <div id="step-B" class="step">
          <label class="block font-bold mb-1">כותרת לפריט</label>
          <input id="input-item-title" type="text" class="w-full p-2 border rounded-lg" placeholder="למשל: 'סיור במוזיאון ישראל'">
        </div>
        <div id="step-C" class="step">
          <div class="flex items-center justify-between">
            <label class="block font-bold mb-2">שעות פעילות</label>
            <button id="add-back-to-hotel" class="text-sm text-blue-700 hover:underline" title="יצור פריט 'חזרה למלון' בשעה שבחרת">+ חזרה למלון</button>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 items-end">
            <div>
              <label class="text-sm text-slate-600">שעת התחלה</label>
              <input id="input-start" type="time" class="w-full p-2 border rounded-lg" />
            </div>
            <div id="end-wrap" class="hidden">
              <label class="text-sm text-slate-600">שעת סיום</label>
              <input id="input-end" type="time" class="w-full p-2 border rounded-lg" />
            </div>
            <button id="toggle-end" type="button" class="p-2 border rounded-lg hover:bg-slate-50">הוסף שעת סוף</button>
          </div>
        </div>
        <div id="step-D" class="step">
          <label class="block font-bold mb-1">פירוט חופשי</label>
          <textarea id="input-desc" rows="4" class="w-full p-2 border rounded-lg" placeholder="מה הולך להיות כאן?"></textarea>
        </div>
        <div id="step-E" class="step space-y-4">
          <h5 class="font-bold">פרטים נוספים (לבחירה)</h5>
          <div class="flex flex-wrap gap-2">
            <button data-open="#block-address" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">כתובת</button>
            <button data-open="#block-links"   class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">קישור לאתר</button>
            <button data-open="#block-book"    class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">קישור להזמנה</button>
            <button data-open="#block-route"   class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">הליכה/נסיעה</button>
            <button data-open="#block-connect" class="open-block px-3 py-1.5 rounded-lg border hover:bg-slate-50">קישור לאטרקציות/מלון/טיסות</button>
          </div>
          <div id="block-address" class="hidden border rounded-xl p-3 space-y-2">
            <div class="flex items-center gap-2">
              <label class="font-semibold">כתובת</label>
              <button id="use-hotel-address" class="text-sm text-blue-700 hover:underline">השתמש בכתובת המלון</button>
            </div>
            <div class="relative input-with-btn">
              <input id="addr-input" type="text" class="w-full p-2 border rounded-lg" placeholder="הקלד כתובת">
              <button id="addr-search-btn" type="button" class="px-3 py-2 border rounded-lg hover:bg-slate-50">
                <i class="fa-solid fa-magnifying-glass"></i> חפש
              </button>
            </div>
            <div id="addr-map" class="w-full h-52 rounded-lg"></div>
          </div>
          <div id="block-links" class="hidden border rounded-xl p-3">
            <label class="block mb-1 font-semibold">קישור לאתר</label>
            <input id="link-general" type="url" class="w-full p-2 border rounded-lg" placeholder="https://...">
          </div>
          <div id="block-book" class="hidden border rounded-xl p-3">
            <label class="block mb-1 font-semibold">קישור להזמנת כרטיס</label>
            <input id="link-book" type="url" class="w-full p-2 border rounded-lg" placeholder="https://...">
          </div>
          <div id="block-route" class="hidden border rounded-xl p-3 space-y-2">
            <div class="grid sm:grid-cols-2 gap-2">
              <div class="relative">
                <label class="text-sm">מאיפה</label>
                <div class="input-with-btn">
                  <input id="route-from" class="w-full p-2 border rounded-lg" placeholder="כתובת יציאה">
                  <button id="route-from-search" type="button" class="px-3 py-2 border rounded-lg hover:bg-slate-50"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
              </div>
              <div class="relative">
                <label class="text-sm">לאן</label>
                <div class="input-with-btn">
                  <input id="route-to" class="w-full p-2 border rounded-lg" placeholder="כתובת יעד">
                  <button id="route-to-search" type="button" class="px-3 py-2 border rounded-lg hover:bg-slate-50"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 flex-wrap">
              <label class="text-sm">אופן נסיעה:</label>
              <select id="route-mode" class="p-2 border rounded-lg">
                <option value="foot">הליכה</option>
                <option value="driving" selected>נהיגה</option>
              </select>
              <button id="route-calc" class="px-3 py-2 border rounded-lg hover:bg-slate-50">חשב מסלול</button>
              <div id="route-time" class="text-sm text-slate-700"></div>
            </div>
            <div id="route-map" class="w-full h-56 rounded-lg"></div>
          </div>
          <div id="block-connect" class="hidden border rounded-xl p-3">
            <div class="mb-2">
              <div id="selected-refs" class="flex flex-wrap gap-2"></div>
            </div>
            <p class="text-sm text-slate-600 mb-3">בחר מקורות לקשר לכרטיס: אטרקציות/מסעדות, מלונות ומעברים (טיסות/רכבות/רכב).</p>
            <div id="connect-lists" class="grid gap-3"></div>
          </div>
        </div>
        <div id="step-F" class="step">
          <label class="block font-bold mb-1">תקציר קצר לכרטיסייה</label>
          <input id="input-summary" type="text" class="w-full p-2 border rounded-lg" placeholder="מה יופיע בכותרת הכרטיס?">
        </div>
        <div id="step-G" class="step">
          <label class="block font-bold mb-1">הערות חשובות</label>
          <textarea id="input-notes" rows="3" class="w-full p-2 border rounded-lg" placeholder="אלרגיות, דגשים, תזכורות..."></textarea>
        </div>
      </main>
      <footer class="p-4 border-t flex items-center justify-between">
        <button id="prev-step" class="px-4 py-2 rounded-lg hover:bg-slate-100">אחורה</button>
        <div class="text-sm text-slate-500" id="step-indicator"></div>
        <div>
          <button id="next-step" class="px-4 py-2 bg-blue-600 text-white rounded-lg">הבא</button>
          <button id="save-item" class="hidden px-4 py-2 bg-emerald-600 text-white rounded-lg">שמור פריט</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- MODAL: עריכת כותרת יום -->
  <div id="title-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl">
      <div class="p-4 border-b font-bold">עריכת כותרת ליום</div>
      <div class="p-4">
        <input id="title-edit-input" class="w-full p-2 border rounded-lg" placeholder="כותרת היום">
      </div>
      <div class="p-4 border-t flex justify-end gap-2">
        <button id="title-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-100">ביטול</button>
        <button id="title-save" class="px-4 py-2 bg-blue-600 text-white rounded-lg">שמירה</button>
      </div>
    </div>
  </div>

  <!-- MODAL: צפייה מלאה בפריט -->
  <div id="view-modal" class="modal fixed inset-0 z-[60] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-2xl max-h-[92vh] flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 id="view-title" class="text-lg font-bold break-words">—</h4>
        <button id="view-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto space-y-4 scroll-smooth">
        <div id="view-time" class="text-slate-600"></div>
        <div id="view-summary" class="text-slate-800 break-words"></div>
        <div id="view-desc" class="text-slate-700 whitespace-pre-line break-words"></div>
        <div id="view-address" class="text-slate-700"></div>
        <div id="view-links" class="flex flex-wrap gap-2"></div>
        <div id="view-map" class="w-full h-60 rounded-xl"></div>
      </main>
      <footer class="p-4 border-t flex flex-col sm:flex-row items-center justify-between gap-3">
        <div class="flex gap-2 w-full sm:w-auto justify-center">
          <a id="nav-waze"   target="_blank" class="flex-1 sm:flex-none justify-center items-center gap-2 px-3 py-2 rounded-lg bg-[#33ccff] text-white hidden"><i class="fa-brands fa-waze"></i> נווט</a>
          <a id="nav-gmaps"  target="_blank" class="flex-1 sm:flex-none justify-center items-center gap-2 px-3 py-2 rounded-lg bg-[#4285F4] text-white hidden"><i class="fa-solid fa-location-dot"></i> מפות</a>
        </div>
        <div class="flex gap-2 w-full sm:w-auto justify-center">
          <button id="view-verify" class="flex-1 sm:flex-none justify-center items-center gap-2 px-3 py-2 rounded-lg bg-red-600 text-white hidden"><i class="fa-solid fa-triangle-exclamation"></i> אמת עכשיו</button>
          <button id="view-edit"   class="flex-1 sm:flex-none justify-center items-center gap-2 px-3 py-2 rounded-lg bg-amber-500 text-white"><i class="fa-solid fa-pen"></i> ערוך</button>
          <button id="view-delete" class="flex-1 sm:flex-none justify-center items-center gap-2 px-3 py-2 rounded-lg bg-red-600 text-white"><i class="fa-solid fa-trash"></i> מחק</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- MODAL: AI הדבקה/פריסה/יצירה -->
  <div id="ai-modal" class="modal fixed inset-0 z-[70] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-3xl max-h-[92vh] flex flex-col shadow-xl relative">
      <div id="ai-loader-overlay" class="hidden absolute inset-0 bg-white/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center gap-4 rounded-2xl">
          <div class="loader text-purple-600"></div>
          <p class="font-bold text-slate-700">יוצר לו"ז, נא להמתין...</p>
      </div>
      <header class="p-4 border-b flex items-center justify-between">
        <h4 class="text-lg font-bold"><i class="fa-solid fa-wand-magic-sparkles text-purple-600"></i> יצירת לוז עם AI</h4>
        <button id="ai-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto space-y-4 scroll-smooth">
        <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 text-sm text-slate-700 space-y-2">
            <h5 class="font-bold text-slate-800">איך זה עובד?</h5>
            <ol class="list-decimal list-inside space-y-1">
                <li>לחץ על <strong>"דבר עם AI"</strong> כדי לפתוח את העוזר בטאב חדש.</li>
                <li>תאר לעוזר את הלו"ז הרצוי ליום מסוים.</li>
                <li>העתק את כל הטקסט שקיבלת ממנו (עם הסימונים המיוחדים) והדבק כאן.</li>
                <li>לחץ על <strong>"פרוס (Preview)"</strong> כדי לראות שזה מובן.</li>
                <li>לחץ על <strong>"צור לוז"</strong> כדי לשמור את הכל ככרטיסיות ליום.</li>
            </ol>
        </div>
        <div class="flex flex-wrap gap-2 items-center">
          <a href="https://chatgpt.com/g/g-6899d3d888d08191b96ce2ccbb43372b-h-vzr-hkhkm-lv-z-tyvl-bqlvt"
             target="_blank"
             class="inline-flex items-center gap-2 px-3 py-2 rounded-lg border bg-white hover:bg-slate-50 font-semibold transition-colors">
            <i class="fa-solid fa-robot"></i> דבר עם AI
          </a>
        </div>
        <div class="space-y-2">
          <label class="font-bold">הדבק כאן את הפורמט המסומן מה-AI</label>
          <textarea id="ai-input" rows="8" class="w-full p-3 border rounded-lg" placeholder="הדבק כאן את הטקסט עם הסימונים ( ! ״ / \ ₪ : ׳ ׳₪ ? $ > < * • ~ )"></textarea>
        </div>
        <div class="flex gap-2">
          <button id="ai-parse" class="px-4 py-2 rounded-lg border hover:bg-slate-100 font-semibold transition-colors">פרוס (Preview)</button>
          <button id="ai-create" class="px-4 py-2 rounded-lg bg-purple-600 text-white font-semibold disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 transition-colors" disabled>
            <span class="loader hidden"></span>
            <span class="btn-text">צור לוז</span>
          </button>
        </div>
        <div id="ai-preview" class="hidden">
          <div class="font-bold mb-2">תצוגה מקדימה:</div>
          <div id="ai-preview-content" class="space-y-2 text-sm"></div>
        </div>
      </main>
    </div>
  </div>

  <!-- MODAL: אימות כתובת/מסלול/קישורים -->
  <div id="verify-modal" class="modal fixed inset-0 z-[75] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-3xl max-h-[92vh] flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 class="text-lg font-bold break-words"><i class="fa-solid fa-triangle-exclamation text-red-600"></i> אימות פריט: <span id="v-title">—</span></h4>
        <button id="v-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto space-y-5 scroll-smooth">
        <div class="banner-warn">השלים/י את האימות לפי הסעיפים שסומנו אדום בכרטיסיה. לאחר שמירה, הסימון יוסר.</div>
        <section id="v-block-address" class="hidden border rounded-xl p-3 space-y-2">
          <div class="flex items-center gap-2">
            <label class="font-semibold">כתובת</label>
            <button id="v-use-hotel" class="text-sm text-blue-700 hover:underline">השתמש בכתובת המלון</button>
          </div>
          <div class="input-with-btn">
            <input id="v-addr-input" type="text" class="w-full p-2 border rounded-lg" placeholder="הקלד כתובת (או בחר למטה)">
            <button id="v-addr-search" type="button" class="px-3 py-2 border rounded-lg hover:bg-slate-50"><i class="fa-solid fa-magnifying-glass"></i> חפש</button>
          </div>
          <div id="v-addr-map" class="w-full h-52 rounded-lg"></div>
        </section>
        <section id="v-block-route" class="hidden border rounded-xl p-3 space-y-2">
          <div class="grid sm:grid-cols-2 gap-2">
            <div>
              <label class="text-sm">מאיפה</label>
              <div class="input-with-btn">
                <input id="v-route-from" class="w-full p-2 border rounded-lg" placeholder="כתובת יציאה">
                <button id="v-route-from-search" type="button" class="px-3 py-2 border rounded-lg hover:bg-slate-50"><i class="fa-solid fa-magnifying-glass"></i></button>
              </div>
            </div>
            <div>
              <label class="text-sm">לאן</label>
              <div class="input-with-btn">
                <input id="v-route-to" class="w-full p-2 border rounded-lg" placeholder="כתובת יעד">
                <button id="v-route-to-search" type="button" class="px-3 py-2 border rounded-lg hover:bg-slate-50"><i class="fa-solid fa-magnifying-glass"></i></button>
              </div>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <label class="text-sm">אופן נסיעה:</label>
            <select id="v-route-mode" class="p-2 border rounded-lg">
              <option value="foot">הליכה</option>
              <option value="driving" selected>נהיגה</option>
            </select>
            <button id="v-route-calc" class="px-3 py-2 border rounded-lg hover:bg-slate-50">חשב מסלול</button>
            <div id="v-route-time" class="text-sm text-slate-700"></div>
          </div>
          <div id="v-route-map" class="w-full h-56 rounded-lg"></div>
        </section>
        <section id="v-block-refs" class="hidden border rounded-xl p-3 space-y-2">
          <div class="mb-2">
            <div id="v-selected-refs" class="flex flex-wrap gap-2"></div>
          </div>
          <p class="text-sm text-slate-600 mb-3">בחר מקורות לקשר לכרטיס: אטרקציות/מסעדות, מלונות ומעברים (טיסות/רכבות/רכב).</p>
          <div id="v-connect-lists" class="grid gap-3"></div>
        </section>
      </main>
      <footer class="p-4 border-t flex items-center justify-between">
        <div class="text-sm text-slate-500">לאחר אימות, לחץ/י "שמור אימות" להסרת האזהרה מהכרטיסיה.</div>
        <div class="flex gap-2">
          <button id="v-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-100">ביטול</button>
          <button id="v-save" class="px-4 py-2 bg-emerald-600 text-white rounded-lg">שמור אימות</button>
        </div>
      </footer>
    </div>
  </div>

  <!-- MODAL: דגש/טיפ -->
  <div id="note-modal" class="modal fixed inset-0 z-[80] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-xl max-h-[92vh] flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between">
        <h4 id="note-modal-title" class="text-lg font-bold">הוספת דגש/טיפ</h4>
        <button id="note-close" class="text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark"></i></button>
      </header>
      <main class="p-4 sm:p-6 overflow-y-auto space-y-4 scroll-smooth">
        <div>
          <label class="block font-semibold mb-1">כותרת</label>
          <input id="note-title" type="text" class="w-full p-2 border rounded-lg" placeholder="כותרת קצרה">
        </div>
        <div>
          <label class="block font-semibold mb-1">סוג</label>
          <select id="note-kind" class="w-full p-2 border rounded-lg">
            <option value="דגש">דגש</option>
            <option value="טיפ">טיפ</option>
          </select>
        </div>
        <div>
          <label class="block font-semibold mb-1">פירוט</label>
          <textarea id="note-details" rows="4" class="w-full p-2 border rounded-lg" placeholder="פירוט מפורט..."></textarea>
        </div>
        <div>
          <label class="block font-semibold mb-1">צבע</label>
          <div class="grid grid-cols-2 sm:grid-cols-5 gap-2">
            <button data-color="red"    class="note-color w-full p-2 rounded-lg border bg-red-50">אדום</button>
            <button data-color="green"  class="note-color w-full p-2 rounded-lg border bg-green-50">ירוק</button>
            <button data-color="blue"   class="note-color w-full p-2 rounded-lg border bg-blue-50">כחול</button>
            <button data-color="yellow" class="note-color w-full p-2 rounded-lg border bg-yellow-50">צהוב</button>
            <button data-color="orange" class="note-color w-full p-2 rounded-lg border bg-orange-50">כתום</button>
          </div>
          <input id="note-color" type="hidden" value="yellow">
        </div>
      </main>
      <footer class="p-4 border-t flex items-center justify-end gap-2">
        <button id="note-cancel" class="px-4 py-2 rounded-lg hover:bg-slate-100">ביטול</button>
        <button id="note-save" class="px-4 py-2 rounded-lg bg-amber-600 text-white">שמירה</button>
      </footer>
    </div>
  </div>

  <!-- תיבת הצעות כללית -->
  <div id="global-typeahead" class="typeahead"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc,
      collection, getDocs, onSnapshot, serverTimestamp, orderBy, query, deleteDoc,
      writeBatch,
      enableIndexedDbPersistence,
      enableMultiTabIndexedDbPersistence,
      where
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.warn('IndexedDB persistence failed-precondition. Falling back to multi-tab…', err);
        enableMultiTabIndexedDbPersistence(db).catch(e => console.warn('Multi-tab persistence error:', e));
      } else if (err.code === 'unimplemented') {
        console.warn('Browser does not support IndexedDB persistence.');
      } else {
        console.warn('Persistence error:', err);
      }
    });

    const p = new URLSearchParams(location.search);
    const tripId = p.get('tripId') || p.get('id'); // Allow 'id' as well
    const urlDate = p.get('date');
    if (!tripId) { alert('חסר tripId'); location.href='index.html'; }

    // DOM Refs
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpClose = document.getElementById('help-close');

    const deleteAllBtn = document.getElementById('delete-all-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');

    const hotelSelectModal = document.getElementById('hotel-select-modal');
    const hotelSelectDropdown = document.getElementById('hotel-select-dropdown');
    const hotelSelectSave = document.getElementById('hotel-select-save');
    const hotelSelectCancel = document.getElementById('hotel-select-cancel');
    let hotelSelectCallback = null;
    
    const authSlot = document.getElementById('auth-slot');

    const dateToggle = document.getElementById('date-toggle');
    const datePanel  = document.getElementById('date-panel');
    const dateCurrent= document.getElementById('date-current');
    const dateList   = document.getElementById('date-list');
    const badgeDate  = document.getElementById('badge-date');
    const backToDay  = document.getElementById('back-to-day');

    const dayTitleInline = document.getElementById('day-title-inline');
    const editDayTitleInline = document.getElementById('edit-day-title-inline');

    const itemsList     = document.getElementById('items-list');
    const addItemBtn    = document.getElementById('add-item-btn');
    const aiBuildBtn    = document.getElementById('ai-build-btn');

    const notesList     = document.getElementById('notes-list');
    const addNoteBtn    = document.getElementById('add-note-btn');

    const itemModal    = document.getElementById('item-modal');
    const modalTitle   = document.getElementById('modal-title');
    const closeModal   = document.getElementById('close-modal');
    const prevStepBtn  = document.getElementById('prev-step');
    const nextStepBtn  = document.getElementById('next-step');
    const saveBtn       = document.getElementById('save-item');
    const stepIndicator= document.getElementById('step-indicator');
    const verifyBanner = document.getElementById('verify-banner');

    const stepA = document.getElementById('step-A');
    const stepB = document.getElementById('step-B');
    const stepC = document.getElementById('step-C');
    const stepD = document.getElementById('step-D');
    const stepE = document.getElementById('step-E');
    const stepF = document.getElementById('step-F');
    const stepG = document.getElementById('step-G');

    const inputDayTitle = document.getElementById('input-day-title');
    const inputItemTitle= document.getElementById('input-item-title');
    const inputStart    = document.getElementById('input-start');
    const inputEnd      = document.getElementById('input-end');
    const toggleEnd     = document.getElementById('toggle-end');
    const endWrap       = document.getElementById('end-wrap');
    const addBackHotel  = document.getElementById('add-back-to-hotel');
    const inputDesc     = document.getElementById('input-desc');
    const inputSummary  = document.getElementById('input-summary');
    const inputNotes    = document.getElementById('input-notes');

    const openBlockBtns = document.querySelectorAll('.open-block');
    const addrInput   = document.getElementById('addr-input');
    const addrMapDiv  = document.getElementById('addr-map');
    const addrSearchBtn = document.getElementById('addr-search-btn');
    const useHotelBtn = document.getElementById('use-hotel-address');
    let addrMap=null, addrMarker=null;

    const linkGeneral = document.getElementById('link-general');
    const linkBook    = document.getElementById('link-book');

    const rFrom       = document.getElementById('route-from');
    const rTo         = document.getElementById('route-to');
    const rMode       = document.getElementById('route-mode');
    const rCalc       = document.getElementById('route-calc');
    const rFromSearch = document.getElementById('route-from-search');
    const rToSearch   = document.getElementById('route-to-search');
    const rTime       = document.getElementById('route-time');
    const rMapDiv     = document.getElementById('route-map');
    let routeMap=null, routeLayer=null, routeMarkers=[];

    const connectLists = document.getElementById('connect-lists');
    const selectedRefsWrap = document.getElementById('selected-refs');
    let selectedRefs = [];

    const titleModal = document.getElementById('title-modal');
    const titleInput = document.getElementById('title-edit-input');
    const titleSave  = document.getElementById('title-save');
    const titleCancel= document.getElementById('title-cancel');

    const viewModal   = document.getElementById('view-modal');
    const viewClose   = document.getElementById('view-close');
    const viewTitle   = document.getElementById('view-title');
    const viewTime    = document.getElementById('view-time');
    const viewSummary = document.getElementById('view-summary');
    const viewDesc    = document.getElementById('view-desc');
    const viewAddress = document.getElementById('view-address');
    const viewLinks   = document.getElementById('view-links');
    const viewMapDiv  = document.getElementById('view-map');
    const navWaze     = document.getElementById('nav-waze');
    const navGmaps    = document.getElementById('nav-gmaps');
    const viewEditBtn = document.getElementById('view-edit');
    const viewDelBtn  = document.getElementById('view-delete');
    const viewVerifyBtn = document.getElementById('view-verify');
    let viewMap=null, viewMarker=null, viewingItem=null;

    const vModal = document.getElementById('verify-modal');
    const vTitle = document.getElementById('v-title');
    const vClose = document.getElementById('v-close');
    const vCancel= document.getElementById('v-cancel');
    const vSave  = document.getElementById('v-save');

    const vBlockAddr = document.getElementById('v-block-address');
    const vUseHotel  = document.getElementById('v-use-hotel');
    const vAddrInput = document.getElementById('v-addr-input');
    const vAddrSearch= document.getElementById('v-addr-search');
    const vAddrMapDiv= document.getElementById('v-addr-map');
    let vAddrMap=null, vAddrMarker=null;

    const vBlockRoute = document.getElementById('v-block-route');
    const vRouteFrom  = document.getElementById('v-route-from');
    const vRouteTo    = document.getElementById('v-route-to');
    const vRouteFromSearch = document.getElementById('v-route-from-search');
    const vRouteToSearch   = document.getElementById('v-route-to-search');
    const vRouteMode  = document.getElementById('v-route-mode');
    const vRouteCalc  = document.getElementById('v-route-calc');
    const vRouteTime  = document.getElementById('v-route-time');
    const vRouteMapDiv= document.getElementById('v-route-map');
    let vRouteMap=null, vRouteLayer=null, vRouteMarkers=[];

    const vBlockRefs  = document.getElementById('v-block-refs');
    const vSelectedRefsWrap = document.getElementById('v-selected-refs');
    const vConnectLists = document.getElementById('v-connect-lists');
    let vSelectedRefs = [];
    let vCurrentItem = null;

    const globalTA = document.getElementById('global-typeahead');
    let taActiveInput = null;
    let taOutsideHandler = null;
    let taScrollHandler = null;

    const aiModal   = document.getElementById('ai-modal');
    const aiInput   = document.getElementById('ai-input');
    const aiParse   = document.getElementById('ai-parse');
    const aiCreate  = document.getElementById('ai-create');
    const aiPreview = document.getElementById('ai-preview');
    const aiPreviewContent = document.getElementById('ai-preview-content');
    const aiClose   = document.getElementById('ai-close');
    const aiLoaderOverlay = document.getElementById('ai-loader-overlay');

    const noteModal = document.getElementById('note-modal');
    const noteClose = document.getElementById('note-close');
    const noteCancel= document.getElementById('note-cancel');
    const noteSave  = document.getElementById('note-save');
    const noteTitle = document.getElementById('note-title');
    const noteKind  = document.getElementById('note-kind');
    const noteDetails = document.getElementById('note-details');
    const noteColorHidden = document.getElementById('note-color');
    const noteModalTitle = document.getElementById('note-modal-title');
    const noteColorBtns = document.querySelectorAll('.note-color');
    let pickedNoteColor = 'yellow';
    let editingNoteId = null;

    let user=null, tripData=null;
    let selectedDate = null; 
    let selectedDestName = null; 
    let dayDocId=null, dayDocRef=null;
    let dayTitle=null;

    let items=[], notes=[];
    let itemsUnsub = null, notesUnsub = null;
    let currentStepIndex=0;
    const stepsOrder = ['A','B','C','D','E','F','G'];
    let editingItemId = null;
    let requiresRefsFlag = false;

    const pad2 = n => (''+n).padStart(2,'0');
    const toISOFromDDMMYYYY = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${y}-${pad2(m)}-${pad2(d)}`; };
    const toDisplayDotted = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${d}.${m}.${y}`; };
    const weekdayHe = (s)=>{ const [d,m,y]=s.split('/').map(Number); const dt=new Date(y,m-1,d); const w=dt.toLocaleDateString('he-IL',{weekday:'long'}); return w.startsWith('יום')?w:`יום ${w}`; };
    const minutesFromHHMM = (hhmm)=>{ const [h,m]=(hhmm||'00:00').split(':').map(Number); return h*60+m; };
    const haversineMeters = (a,b) => { const R=6371000, t=x=>x*Math.PI/180; const dLa=t(b.lat-a.lat), dLo=t(b.lng-a.lng); const s1=Math.sin(dLa/2)**2 + Math.cos(t(a.lat))*Math.cos(t(b.lat))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(s1)); };

    const colorMap = {
      red:     {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:   {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:    {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow:  {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange:  {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    
    // Confirmation Modal Logic
    let confirmResolve = null;
    function showConfirm({ title, message, confirmText = 'אישור' }) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmOk.textContent = confirmText;
        confirmModal.classList.add('show');
        return new Promise(resolve => {
            confirmResolve = resolve;
        });
    }
    confirmOk.addEventListener('click', () => {
        if (confirmResolve) confirmResolve(true);
        confirmModal.classList.remove('show');
    });
    confirmCancel.addEventListener('click', () => {
        if (confirmResolve) confirmResolve(false);
        confirmModal.classList.remove('show');
    });

    // התחברות + טעינת טיול
    onAuthStateChanged(auth, async (u)=>{
      if (!u){ location.href='login.html'; return; }
      user=u;

      if (authSlot) {
        authSlot.textContent = u.email || '';
      }

      const tSnap = await getDoc(doc(db,'trips',tripId));
      if (!tSnap.exists()){ alert('טיול לא נמצא'); location.href='index.html'; return; }
      tripData=tSnap.data();
      
      const editors = tripData.editors || [];
      if (!Array.isArray(editors) || !editors.includes(user.uid)) {
          alert('אין לך הרשאה לערוך את הטיול הזה.');
          location.href = 'index.html';
          return;
      }

      buildDateSelector();

      let initialDate = urlDate;
      let initialDestName = null;

      if (initialDate) {
        const destForDate = tripData.destinations?.find(d => expandRange(d.dates).includes(initialDate));
        if (destForDate) {
          initialDestName = destForDate.nameHe;
        }
      }

      if (!initialDate || !initialDestName) {
        const firstDest = tripData.destinations?.[0];
        initialDate = firstDest?.dates?.split(' - ')?.[0];
        initialDestName = firstDest?.nameHe;
      }

      if (initialDate && initialDestName) {
        await setWorkingDate(initialDate, initialDestName);
      } else {
        dateCurrent.textContent = 'לא נמצאו תאריכים בטיול.';
        console.error("Could not determine an initial date and destination for the trip.");
      }
    });

    function renderItems(){
      if (!items.length){
        itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">אין פריטים עדיין.</div>`;
        deleteAllBtn.classList.add('hidden');
        return;
      }
      deleteAllBtn.classList.remove('hidden');
      itemsList.innerHTML = items.map(it=>{
        const time = `${it.startTime || ''}${it.endTime ? ' – ' + it.endTime : ''}`;
        const dist = (it.distanceFromPreviousMeters!=null)
          ? `<span class="text-xs text-slate-500"> • מרחק קודם: ${(it.distanceFromPreviousMeters/1000).toFixed(2)} ק״מ</span>` : '';
        const addr = it.address?.label ? `<div class="text-xs text-slate-500 mt-1"><i class="fa-solid fa-location-dot"></i> ${it.address.label}</div>` : '';
        const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
        const needsTxt = [
          it.needsVerifyAddress?'כתובת':null,
          it.needsVerifyRoute?'מסלול':null,
          it.needsVerifyRefs?'קישור':null
        ].filter(Boolean).join(' / ');
        return `<button class="card w-full text-right bg-white rounded-xl border shadow-sm p-4 ${needs?'needs-verify':''}" data-id="${it.id}">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
              <div class="font-bold whitespace-normal break-words ${needs?'text-red-800':'text-slate-800'}">${it.title || '(ללא כותרת)'}</div>
            </div>
            <div class="flex-shrink-0 ml-2 text-sm text-right font-semibold ${needs?'text-red-700':'text-slate-600'}">${time}${dist}</div>
          </div>
          ${needs?`<div class="mt-1"><span class="badge-verify"><i class="fa-solid fa-circle-exclamation"></i> דרוש אימות${needsTxt?': '+needsTxt:''}</span></div>`:''}
          ${it.summary ? `<div class="text-slate-700 mt-1 whitespace-normal break-words">${it.summary}</div>`:''}
          ${addr}
        </button>`;
      }).join('');

      itemsList.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click',()=>{
          const it = items.find(x=>x.id===b.dataset.id);
          if (!it) return;
          if (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs) openVerifyModal(it);
          else openViewModal(it.id);
        });
      });
    }

    async function openViewModal(id){
      const it = items.find(x=>x.id===id);
      if (!it) return;
      viewingItem = it;
      viewTitle.textContent = it.title || '(ללא כותרת)';
      viewTime.textContent  = [it.startTime, it.endTime?('— '+it.endTime):''].filter(Boolean).join(' ');
      viewSummary.textContent = it.summary || '';
      viewSummary.classList.toggle('hidden', !it.summary);
      viewDesc.textContent = it.description || '';
      viewDesc.classList.toggle('hidden', !it.description);

      let refsHtml='';
      if (Array.isArray(it.refs) && it.refs.length){
        refsHtml = it.refs.map(r=>{
          const page = r.page === 'places' ? 'attractions' : (r.page === 'summary' ? 'summary' : 'attractions');
          const openType = r.type === 'logistics' ? 'logistics' : 'place';
          const href = `${page}.html?id=${tripId}&open=${openType}&id=${r.id}`;
          return `<a class="px-3 py-2 rounded-lg bg-indigo-600 text-white" target="_blank" href="${href}">${iconForRef(r)} ${r.label}</a>`;
        }).join(' ');
      }
      viewLinks.innerHTML = [
        it.links?.site ? `<a class="px-3 py-2 rounded-lg bg-slate-800 text-white" target="_blank" href="${it.links.site}"><i class="fa-solid fa-link"></i> אתר</a>` : '',
        it.links?.booking ? `<a class="px-3 py-2 rounded-lg bg-emerald-600 text-white" target="_blank" href="${it.links.booking}"><i class="fa-solid fa-ticket"></i> הזמנה</a>` : '',
        refsHtml
      ].filter(Boolean).join(' ');

      if (it.address?.label){
        viewAddress.innerHTML = `<i class="fa-solid fa-location-dot"></i> ${it.address.label}`;
        navWaze.href  = `https://waze.com/ul?q=${encodeURIComponent(it.address.label)}`;
        navGmaps.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}`;
        navWaze.classList.remove('hidden'); navGmaps.classList.remove('hidden');
      } else {
        viewAddress.innerHTML = '';
        navWaze.classList.add('hidden'); navGmaps.classList.add('hidden');
      }

      setTimeout(()=>{
        if (!viewMap){
          viewMap = L.map(viewMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(viewMap);
        }
        if (viewMarker){ viewMap.removeLayer(viewMarker); viewMarker=null; }
        if (it.address?.lat){
          viewMarker = L.marker([it.address.lat,it.address.lng]).addTo(viewMap);
          viewMap.setView([it.address.lat,it.address.lng], 15);
        }
        viewMap.invalidateSize();
      },120);

      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      viewVerifyBtn.classList.toggle('hidden', !needs);
      viewVerifyBtn.onclick = ()=>{ viewModal.classList.remove('show'); openVerifyModal(it); };
      viewEditBtn.onclick = ()=>{ viewModal.classList.remove('show'); openItemModal(it); };
      
      // מחיקת פריט בודד
      viewDelBtn.onclick  = async ()=>{
        const confirmed = await showConfirm({
            title: 'מחיקת פריט',
            message: `האם למחוק את הפריט "${it.title}"? לא ניתן לשחזר את הפעולה.`
        });
        if (confirmed) {
            viewModal.classList.remove('show');
            await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',it.id));
            await recomputeDistances();
        }
      };

      viewModal.classList.add('show');
    }

    // Help modal
    helpBtn.addEventListener('click', () => helpModal.classList.add('show'));
    helpClose.addEventListener('click', () => helpModal.classList.remove('show'));

    // מחיקת כל הפריטים של היום
    deleteAllBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm({
            title: 'מחיקת כל הפריטים',
            message: `האם למחוק את כל ${items.length} הפריטים מיום זה? לא ניתן לשחזר את הפעולה.`
        });
        if (confirmed) {
            const batch = writeBatch(db);
            const itemsCollectionRef = collection(db, 'trips', tripId, 'schedules', dayDocId, 'items');
            const querySnapshot = await getDocs(itemsCollectionRef);
            querySnapshot.forEach(dref => {
                batch.delete(dref.ref);
            });
            await batch.commit();
            // אין צורך בחישוב מרחקים מחדש - אין פריטים
        }
    });
    
    // בונה רשימת תאריכים/יעדים לבחירה
    function buildDateSelector(){
      dateList.innerHTML='';
      dateCurrent.textContent='בחר תאריך...';
      tripData.destinations?.forEach(dest=>{
        const dates = expandRange(dest.dates);
        const wrap = document.createElement('div');
        wrap.className='p-3';
        wrap.innerHTML=`<div class="font-bold text-slate-800 mb-2">${dest.nameHe}</div>`;
        dates.forEach(d=>{
          const wd=weekdayHe(d);
          const btn=document.createElement('button');
          btn.className='w-full text-right p-2 rounded hover:bg-slate-100';
          btn.textContent=`${wd} – (${dest.nameHe}) • ${toDisplayDotted(d)}`;
          btn.addEventListener('click', async ()=>{
            await setWorkingDate(d, dest.nameHe);
            datePanel.classList.remove('open');
          });
          wrap.appendChild(btn);
        });
        dateList.appendChild(wrap);
      });
      dateToggle.addEventListener('click', ()=> datePanel.classList.toggle('open'));
    }

    function expandRange(r){
      if (!r?.includes(' - ')) return r ? [r] : [];
      const [s,e]=r.split(' - ');
      const [sd,sm,sy]=s.split('/').map(Number);
      const [ed,em,ey]=e.split('/').map(Number);
      const start=new Date(sy,sm-1,sd), end=new Date(ey,em-1,ed);
      const out=[]; let cur=new Date(start);
      while(cur<=end){
        out.push(`${pad2(cur.getDate())}/${pad2(cur.getMonth()+1)}/${cur.getFullYear()}`);
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }

    // בחירת יום עבודה (תאריך+יעד) ושיוך מסמך Firestore
    async function setWorkingDate(ddmmyyyy, destName){
      if (!ddmmyyyy || !destName) {
        console.error("setWorkingDate called with invalid arguments", {ddmmyyyy, destName});
        return;
      }
      
      selectedDate = ddmmyyyy;
      selectedDestName = destName;

      const iso = toISOFromDDMMYYYY(ddmmyyyy);
      dayDocId = `${iso}_${destName}`; 
      dayDocRef = doc(db, 'trips', tripId, 'schedules', dayDocId);

      dateCurrent.textContent = `${weekdayHe(ddmmyyyy)} – (${destName}) • ${toDisplayDotted(ddmmyyyy)}`;
      badgeDate.textContent   = `${weekdayHe(ddmmyyyy)} • ${toDisplayDotted(ddmmyyyy)}`;

      const snap = await getDoc(dayDocRef);
      if (snap.exists()) {
        dayTitle = snap.data().title || null;
      } else {
        dayTitle = null;
        await setDoc(dayDocRef, { title: null, date: ddmmyyyy, destination: destName }, { merge: true });
      }

      reflectDayTitleUI();
      backToDay.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(selectedDate)}`;
      resubscribeDayStreams();
    }
    
    function reflectDayTitleUI(){
      dayTitleInline.textContent = dayTitle || 'לא נקבעה';
      editDayTitleInline.classList.toggle('hidden', !dayTitle);
    }
    
    function resubscribeDayStreams(){
      if (itemsUnsub) { itemsUnsub(); itemsUnsub=null; }
      if (notesUnsub) { notesUnsub(); notesUnsub=null; }

      if (!dayDocId) {
          console.warn("No dayDocId set, cannot subscribe to streams.");
          itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">נא לבחור תאריך ויעד.</div>`;
          notesList.innerHTML = `<div class="text-slate-500">נא לבחור תאריך ויעד.</div>`;
          return;
      }

      const qItems = query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc'));
      itemsUnsub = onSnapshot(qItems, (snap)=>{
        items = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderItems();
      });
      const qNotes = query(collection(db,'trips',tripId,'schedules',dayDocId,'notes'), orderBy('createdAt','asc'));
      notesUnsub = onSnapshot(qNotes, (snap)=>{
        notes = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderNotes();
      });
    }

    editDayTitleInline.addEventListener('click', ()=>{
      titleInput.value = dayTitle || '';
      noteModalTitle.textContent = 'עריכת כותרת ליום'; // לא חובה אבל שיהיה עקבי
      titleModal.classList.add('show');
    });
    titleCancel.addEventListener('click', ()=> titleModal.classList.remove('show'));
    titleSave.addEventListener('click', async ()=>{
      const t=(titleInput.value||'').trim();
      await setDoc(dayDocRef,{title: t || null, updatedAt: serverTimestamp()},{merge:true});
      dayTitle = t || null;
      reflectDayTitleUI();
      titleModal.classList.remove('show');
    });

    function classesForColor(c){
      const m = colorMap[c] || colorMap.yellow;
      return `${m.bg} ${m.border} ${m.text}`;
    }

    function renderNotes(){
      if (!notes.length){
        notesList.innerHTML = `<div class="text-slate-500">אין עדיין דגשים/טיפים.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const cls = classesForColor(n.color);
        const titleSafe = (n.title || '—').replace(/"/g, '&quot;');
        return `<div class="border rounded-xl p-3 ${cls}">
          <div class="flex items-start justify-between gap-2">
            <div class="flex-1 min-w-0">
                <div class="font-bold break-words whitespace-normal">${n.kind}: ${n.title || '—'}</div>
            </div>
            <div class="flex gap-2 flex-shrink-0 ml-2">
              <button class="px-2 py-1 rounded bg-white/60 border text-sm note-edit" data-id="${n.id}"><i class="fa-solid fa-pen"></i> ערוך</button>
              <button class="px-2 py-1 rounded bg-white/60 border text-sm note-del" data-id="${n.id}" data-title="${titleSafe}"><i class="fa-solid fa-trash"></i> מחק</button>
            </div>
          </div>
          <div class="mt-2 text-sm whitespace-normal break-words">${(n.details||'').replace(/\n/g,'<br>')}</div>
        </div>`;
      }).join('');

      notesList.querySelectorAll('.note-edit').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const n = notes.find(x=>x.id===btn.dataset.id);
          if (!n) return;
          openNoteModal(n);
        });
      });
      notesList.querySelectorAll('.note-del').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
            const noteTitle = btn.dataset.title;
            const confirmed = await showConfirm({
                title: 'מחיקת דגש/טיפ',
                message: `האם למחוק את הדגש/טיפ "${noteTitle}"?`
            });
            if (confirmed) {
                await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'notes',btn.dataset.id));
            }
        });
      });
    }

    function openNoteModal(n=null){
      editingNoteId = n?.id || null;
      noteModalTitle.textContent = editingNoteId ? 'עריכת דגש/טיפ' : 'הוספת דגש/טיפ';
      noteTitle.value = n?.title || '';
      noteKind.value = n?.kind || 'דגש';
      noteDetails.value = n?.details || '';
      pickedNoteColor = n?.color || 'yellow';
      noteColorHidden.value = pickedNoteColor;

      // סימון הצבע שנבחר (טבעות highlight)
      noteColorBtns.forEach(btn=>{
        btn.classList.remove('ring-2','ring-offset-2','ring-amber-500');
        if (btn.dataset.color === pickedNoteColor){
          btn.classList.add('ring-2','ring-offset-2','ring-amber-500');
        }
      });

      noteModal.classList.add('show');
    }

    // שינוי צבע בדגש
    noteColorBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        pickedNoteColor = btn.dataset.color;
        noteColorHidden.value = pickedNoteColor;
        noteColorBtns.forEach(b=>b.classList.remove('ring-2','ring-offset-2','ring-amber-500'));
        btn.classList.add('ring-2','ring-offset-2','ring-amber-500');
      });
    });

    // פתיחת מודל הוספת דגש
    addNoteBtn.addEventListener('click', ()=> {
      openNoteModal(null);
    });

    // סגירת מודל דגש
    noteClose.addEventListener('click', ()=> noteModal.classList.remove('show'));
    noteCancel.addEventListener('click', ()=> noteModal.classList.remove('show'));

    // שמירת דגש
    noteSave.addEventListener('click', async ()=>{
      const payload = {
        title: (noteTitle.value||'').trim(),
        kind: noteKind.value || 'דגש',
        details: (noteDetails.value||'').trim(),
        color: pickedNoteColor || 'yellow',
        updatedAt: serverTimestamp()
      };
      if (editingNoteId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'notes',editingNoteId), payload);
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'notes'), {
          ...payload,
          createdAt: serverTimestamp()
        });
      }
      editingNoteId = null;
      noteModal.classList.remove('show');
    });

    function showStep(code){
      [stepA,stepB,stepC,stepD,stepE,stepF,stepG].forEach(s=>s.classList.remove('active'));
      const idx = stepsOrder.indexOf(code);
      currentStepIndex = Math.max(0, idx);
      document.getElementById('step-'+code).classList.add('active');
      stepIndicator.textContent = `שלב ${currentStepIndex+1} מתוך ${stepsOrder.length}`;
      saveBtn.classList.toggle('hidden', code!=='G');
      nextStepBtn.classList.toggle('hidden', code==='G');
      prevStepBtn.disabled = (code=== (dayTitle ? 'B' : 'A'));
    }

    nextStepBtn.addEventListener('click', async ()=>{
      const cur = stepsOrder[currentStepIndex];
      if (cur==='A'){
        const t=(inputDayTitle.value||'').trim();
        await setDoc(dayDocRef,{ title: t || null, updatedAt: serverTimestamp() },{merge:true});
        dayTitle = t || null;
        reflectDayTitleUI();
      }
      showStep(stepsOrder[currentStepIndex+1]);
    });
    prevStepBtn.addEventListener('click', ()=> showStep(stepsOrder[currentStepIndex-1]));
    toggleEnd.addEventListener('click', ()=> endWrap.classList.toggle('hidden'));

    // ===== Typeahead helpers =====
    function placeTypeaheadBelow(inputEl){
      const r = inputEl.getBoundingClientRect();
      Object.assign(globalTA.style, { left: r.left+'px', top: (r.bottom+6)+'px', width: r.width+'px' });
    }
    function showTypeaheadFor(inputEl, items){
      taActiveInput = inputEl;
      globalTA.innerHTML = items.map(r=>`<button data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`).join('');
      [...globalTA.querySelectorAll('button')].forEach(b=>{
        b.addEventListener('click', ()=>{
          const picked = { lat: parseFloat(b.dataset.lat), lng: parseFloat(b.dataset.lon), label: b.textContent };
          taActiveInput.dispatchEvent(new CustomEvent('typeahead:pick',{detail:picked}));
          hideTypeahead();
        }, {once:true});
      });
      placeTypeaheadBelow(inputEl);
      globalTA.classList.add('open');
      if (!taOutsideHandler){
        taOutsideHandler = (e)=>{ if (e.target!==globalTA && e.target!==taActiveInput && !globalTA.contains(e.target)) hideTypeahead(); };
        document.addEventListener('mousedown', taOutsideHandler);
        document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') hideTypeahead(); }, {once:true});
      }
      if (!taScrollHandler){
        taScrollHandler = ()=>{ if (taActiveInput) placeTypeaheadBelow(taActiveInput); };
        window.addEventListener('scroll', taScrollHandler, true);
        window.addEventListener('resize', taScrollHandler);
      }
    }
    function hideTypeahead(){
      globalTA.classList.remove('open');
      globalTA.innerHTML='';
      taActiveInput = null;
      if (taOutsideHandler){ document.removeEventListener('mousedown', taOutsideHandler); taOutsideHandler=null; }
      if (taScrollHandler){ window.removeEventListener('scroll', taScrollHandler, true); window.removeEventListener('resize', taScrollHandler); taScrollHandler=null; }
    }
    async function doSearchForInput(inputEl){
      const q = (inputEl.value||'').trim();
      if (!q) return;
      try{
        const url=`https://nominatim.openstreetmap.org/search?format=json&limit=8&q=${encodeURIComponent(q)}`;
        const res=await fetch(url);
        const arr=await res.json();
        if (Array.isArray(arr) && arr.length) showTypeaheadFor(inputEl, arr);
        else hideTypeahead();
      }catch{ hideTypeahead(); }
    }
    function bindTypeahead(inputEl, onPick){
      let timer=null;
      inputEl.addEventListener('input', ()=>{
        const q = inputEl.value.trim();
        clearTimeout(timer);
        if (!q){ hideTypeahead(); return; }
        timer = setTimeout(()=> doSearchForInput(inputEl), 220);
      });
      inputEl.addEventListener('typeahead:pick', (ev)=> onPick(ev.detail));
    }

    bindTypeahead(addrInput, (p)=>{
      addrInput.value=p.label;
      if(!addrMap){
        addrMap = L.map(addrMapDiv).setView([p.lat,p.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap);
      }
      if(!addrMarker) addrMarker = L.marker([p.lat,p.lng]).addTo(addrMap);
      else addrMarker.setLatLng([p.lat,p.lng]);
      addrMarker._data = p;
      addrMap.setView([p.lat,p.lng], 15);
      addrMap.invalidateSize();
    });
    addrSearchBtn.addEventListener('click', ()=> doSearchForInput(addrInput));

    function setRoutePoint(idx,p){
      if(!routeMap){
        routeMap = L.map(rMapDiv).setView([p.lat,p.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
      }
      if(!routeMarkers[idx]) routeMarkers[idx]=L.marker([p.lat,p.lng]).addTo(routeMap);
      else routeMarkers[idx].setLatLng([p.lat,p.lng]);
      routeMarkers[idx]._data=p;
      routeMap.setView([p.lat,p.lng], 13);
      routeMap.invalidateSize();
    }
    bindTypeahead(rFrom, (p)=>{ rFrom.value=p.label; setRoutePoint(0,p); });
    bindTypeahead(rTo,   (p)=>{ rTo.value=p.label;   setRoutePoint(1,p); });
    rFromSearch.addEventListener('click', ()=> doSearchForInput(rFrom));
    rToSearch  .addEventListener('click', ()=> doSearchForInput(rTo));

    rCalc.addEventListener('click', async ()=>{
      if (!routeMarkers[0]?._data || !routeMarkers[1]?._data) return alert('בחר גם מוצא וגם יעד.');
      const a=routeMarkers[0]._data, b=routeMarkers[1]._data;
      const profile = (rMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        rTime.textContent=`זמן משוער: ${mins} דק׳`;
        if (routeLayer) routeMap.removeLayer(routeLayer);
        routeLayer=L.geoJSON(r.geometry).addTo(routeMap);
        routeMap.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
        routeMap.invalidateSize();
      } else rTime.textContent='לא נמצא מסלול.';
    });

    // Hotel helpers
    async function findAllHotelsForDate(ddmmyyyy) {
        const qSnap = await getDocs(collection(db, 'trips', tripId, 'logistics'));
        const allHotels = qSnap.docs.map(d => ({ id: d.id, ...d.data() })).filter(x => x.type === 'hotel');
        const inRange = (range) => expandRange(range || '').includes(ddmmyyyy);
        const hotelsForDate = allHotels.filter(h => inRange(h.dates));
        return hotelsForDate;
    }

    function openHotelSelectModal(hotels, callback) {
        hotelSelectCallback = callback;
        hotelSelectDropdown._hotels = hotels;
        hotelSelectDropdown.innerHTML = hotels.map(h => 
            `<option value="${h.id}">${h.name || 'מלון ללא שם'} (${h.destination || 'יעד לא צוין'})</option>`
        ).join('');
        hotelSelectModal.classList.add('show');
    }

    function applyHotelAddress(hotel, inputEl, map, currentMarker) {
        if (!hotel) return currentMarker;
        inputEl.value = hotel.address || hotel.name || '';
        const c = hotel.coords || hotel.location || null;
        let newMarker = currentMarker;
        if (c?.lat && c?.lng){
            if(!newMarker) {
                if(!map){
                  // fallback - should not really happen because we init maps before
                }
                newMarker = L.marker([c.lat,c.lng]).addTo(map);
            } else {
                newMarker.setLatLng([c.lat,c.lng]);
            }
            newMarker._data = {label:inputEl.value, lat:c.lat, lng:c.lng};
            map.setView([c.lat,c.lng], 15);
            map.invalidateSize();
        }
        return newMarker;
    }

    async function handleUseHotelAddress(addrInputEl, mapInstance, markerInstance, markerUpdateCallback) {
        const hotels = await findAllHotelsForDate(selectedDate);
        if (hotels.length === 0) {
            alert('אין מלון מוגדר לתאריך זה.');
            return;
        }
        if (hotels.length === 1) {
            const newMarker = applyHotelAddress(hotels[0], addrInputEl, mapInstance, markerInstance);
            markerUpdateCallback(newMarker);
        } else {
            openHotelSelectModal(hotels, (selectedHotel) => {
                const newMarker = applyHotelAddress(selectedHotel, addrInputEl, mapInstance, markerInstance);
                markerUpdateCallback(newMarker);
            });
        }
    }

    hotelSelectSave.addEventListener('click', () => {
        if (hotelSelectCallback && hotelSelectDropdown._hotels) {
            const selectedId = hotelSelectDropdown.value;
            const selectedHotel = hotelSelectDropdown._hotels.find(h => h.id === selectedId);
            if (selectedHotel) {
                hotelSelectCallback(selectedHotel);
            }
        }
        hotelSelectModal.classList.remove('show');
        hotelSelectCallback = null;
        hotelSelectDropdown._hotels = null;
    });

    hotelSelectCancel.addEventListener('click', () => {
        hotelSelectModal.classList.remove('show');
        hotelSelectCallback = null;
        hotelSelectDropdown._hotels = null;
    });

    useHotelBtn.addEventListener('click', () => {
        handleUseHotelAddress(addrInput, addrMap, addrMarker, (newMarker) => { addrMarker = newMarker; });
    });
    
    function renderSelectedRefs(){
      selectedRefsWrap.innerHTML = selectedRefs.length ? selectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm">לא נבחרו קישורים.</span>`;
      selectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          selectedRefs.splice(idx,1);
          renderSelectedRefs();
        });
      });
    }

    function iconForRef(r){
      if (r.type==='logistics'){
        if (r.subType==='hotel') return '🏨';
        if (r.subType==='flight') return '✈️';
        if (r.subType==='train') return '🚆';
        if (r.subType==='car_rental') return '🚗';
        if (r.subType==='ferry') return '⛴️';
        return '⬅️';
      }
      if (r.type==='place'){
        return '📍';
      }
      return '📍';
    }
    
    async function buildConnectLists(targetListsEl, selectedRefsArr){
      targetListsEl.innerHTML='טוען...';
      
      // לוגיסטיקה
      const logSnap = await getDocs(collection(db,'trips',tripId,'logistics'));
      const logistics = logSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // אטרקציות/אוכל ביעד הפעיל
      if (!selectedDestName) {
        targetListsEl.innerHTML = '<div class="text-red-600">שגיאה: לא נבחר יעד. לא ניתן לטעון אטרקציות.</div>';
        return;
      }
      
      const placesQuery = query(
        collection(db, 'trips', tripId, 'places'),
        where("destination", "==", selectedDestName)
      );
      const placesSnap = await getDocs(placesQuery);
      const places = placesSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // Mobile-friendly card design with better wrapping and larger touch target
      const card = (title, sub, openHref, picked=false)=>`
        <div class="relative p-3 rounded-xl border bg-white shadow-sm hover:shadow-md transition-shadow">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
             <div class="flex-1 min-w-0">
                <div class="font-bold text-slate-800 break-words whitespace-normal text-base">${title}</div>
                ${sub ? `<div class="text-xs text-slate-500 mt-1 break-words">${sub}</div>` : ''}
             </div>
             <div class="flex items-center gap-3 shrink-0 self-end sm:self-auto w-full sm:w-auto justify-end">
                <a href="${openHref}" class="text-blue-600 hover:text-blue-800 text-sm font-medium px-2 py-1" target="_blank">פתח</a>
                <button class="px-4 py-2 rounded-lg text-sm font-bold transition-all pick-btn ${picked ? 'bg-green-600 text-white shadow-md' : 'bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200'}">
                   ${picked ? '<i class="fa-solid fa-check"></i> נבחר' : 'בחר'}
                </button>
             </div>
          </div>
        </div>`;

      let html='';

      if (logistics.length){
        html+=`<div><div class="font-bold mb-2 text-lg text-slate-800">מעברים ומלונות</div><div class="grid gap-3">`;
        html+= logistics.map(l=>{
          const label = (l.type==='hotel'?'מלון: ':'') + (l.name||l.destination||l.type);
          const sub   = l.dates || l.date || '';
          const href  = `summary.html?id=${tripId}&open=logistics&id=${l.id}`;
          const picked= selectedRefsArr.some(r=>r.type==='logistics' && r.id===l.id);
          return `<div data-ref-type="logistics" data-ref-id="${l.id}" data-ref-subtype="${l.type}" data-ref-label="${label}">${card(iconForRef({type:'logistics',subType:l.type})+' '+label, sub, href, picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      
      if (places.length){
        html+=`<div class="mt-6"><div class="font-bold mb-2 text-lg text-slate-800">אטרקציות ומסעדות (רק מ: ${selectedDestName})</div><div class="grid gap-3">`;
        html+= places.map(p=>{
          const label = p.name || 'פריט';
          const sub   = p.type || p.destination || '';
          const href  = `attractions.html?id=${tripId}&open=place&id=${p.id}`;
          const picked= selectedRefsArr.some(r=>r.type==='place' && r.id===p.id);
          return `<div data-ref-type="place" data-ref-id="${p.id}" data-ref-subtype="${p.type}" data-ref-label="${label}">${card('📍 '+label, sub, href, picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      
      targetListsEl.innerHTML = html || '<div class="text-slate-500 py-4 text-center bg-slate-50 rounded-lg">אין נתונים להצגה.</div>';

      targetListsEl.querySelectorAll('.pick-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const wrap=btn.closest('[data-ref-type]');
          const type=wrap.dataset.refType;
          const id  =wrap.dataset.refId;
          const subType = wrap.dataset.refSubtype || null;
          const label=wrap.dataset.refLabel;
          const page = type === 'logistics' ? 'summary' : 'places'; 
          
          const existed = selectedRefsArr.findIndex(r=>r.type===type && r.id===id);
          if (existed>-1){
            selectedRefsArr.splice(existed,1);
            btn.innerHTML='בחר';
            btn.className = 'px-4 py-2 rounded-lg text-sm font-bold transition-all pick-btn bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200';
          } else {
            selectedRefsArr.push({type, id, label, page, subType});
            btn.innerHTML='<i class="fa-solid fa-check"></i> נבחר';
            btn.className = 'px-4 py-2 rounded-lg text-sm font-bold transition-all pick-btn bg-green-600 text-white shadow-md';
          }
          if (targetListsEl===connectLists) renderSelectedRefs();
          else renderVSelectedRefs();
        });
      });
    }

    document.querySelector('[data-open="#block-connect"]').addEventListener('click', async ()=>{
      const el=document.querySelector('#block-connect');
      setTimeout(async ()=>{
        if (!el.classList.contains('hidden')) await buildConnectLists(connectLists, selectedRefs);
      }, 0);
    });

    saveBtn.addEventListener('click', async ()=>{
      const payload = collectItemFromModal();
      await saveItemCore(payload, editingItemId);
      itemModal.classList.remove('show');
      hideTypeahead();
      editingItemId = null;
    });

    function collectItemFromModal(){
      const addrData = addrMarker?._data
        ? { label: addrMarker._data.label, lat: addrMarker._data.lat, lng: addrMarker._data.lng }
        : (addrInput.value.trim()? { label: addrInput.value.trim(), lat:null, lng:null } : null);

      const travelFrom = routeMarkers[0]?._data
        ? routeMarkers[0]._data
        : (rFrom.value.trim()? {label:rFrom.value.trim(), lat:null, lng:null}: null);

      const travelTo   = routeMarkers[1]?._data
        ? routeMarkers[1]._data
        : (rTo.value.trim()? {label:rTo.value.trim(), lat:null, lng:null}: null);

      const refsCopy = selectedRefs.slice();

      return {
        title: (inputItemTitle.value||'').trim() || '(ללא כותרת)',
        startTime: inputStart.value || null,
        endTime:   inputEnd.value   || null,
        description: (inputDesc.value||'').trim() || null,
        summary:     (inputSummary.value||'').trim() || null,
        notes:       (inputNotes.value||'').trim() || null,
        links: { site:(linkGeneral.value||'').trim() || null, booking:(linkBook.value||'').trim() || null },
        address: addrData,
        travel: (travelFrom || travelTo) ? { from: travelFrom, to: travelTo, mode: rMode.value, timeText: rTime.textContent || null } : null,
        refs: refsCopy,
        requiresRefs: !!requiresRefsFlag
      };
    }

    async function saveItemCore(payload, editId=null, extraFlags={}){
      await setDoc(dayDocRef,{ title: dayTitle || null, updatedAt: serverTimestamp() },{merge:true});
      const thisSort = minutesFromHHMM(payload.startTime||'00:00');
      const needsVerifyAddress = !!(payload.address && !(payload.address.lat!=null && payload.address.lng!=null));
      const needsVerifyRoute   = !!(payload.travel && !((payload.travel.from?.lat!=null) && (payload.travel.to?.lat!=null)));
      const needsVerifyRefs    = !!(payload.requiresRefs && (!Array.isArray(payload.refs) || payload.refs.length===0));
      const base = {
        ...payload,
        sort:thisSort,
        date:selectedDate,
        destination:selectedDestName,
        updatedAt: serverTimestamp(),
        needsVerifyAddress,
        needsVerifyRoute,
        needsVerifyRefs,
        ...extraFlags
      };
      if (editId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',editId), base);
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'items'), {
          ...base,
          createdAt: serverTimestamp()
        });
      }
      await recomputeDistances();
    }

    async function recomputeDistances(){
      const snap = await getDocs(query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc')));
      const arr = snap.docs.map(d=>({id:d.id,...d.data()}));
      for (let i=0;i<arr.length;i++){
        let dist=null;
        const a = arr[i-1], b=arr[i];
        if (a?.address?.lat!=null && b?.address?.lat!=null){
          dist = Math.round(haversineMeters({lat:a.address.lat,lng:a.address.lng},{lat:b.address.lat,lng:b.address.lng}));
        }
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',b.id), { distanceFromPreviousMeters: dist });
      }
    }

    // יצירת כרטיס "חזרה למלון"
    addBackHotel.addEventListener('click', async () => {
        if (!inputStart.value) return alert('בחר שעת התחלה לחזרה למלון.');
        const hotels = await findAllHotelsForDate(selectedDate);
        if (hotels.length === 0) {
            return alert('לא נמצא מלון לתאריך זה.');
        }

        const processHotelSelection = async (h) => {
            await saveItemCore({
                title: 'חזרה למלון',
                startTime: inputStart.value, endTime: null,
                summary: 'סיום היום וחזרה למלון',
                address: h.address ? { label: h.address, lat: h.coords?.lat ?? null, lng: h.coords?.lng ?? null } : null,
                isBackToHotel: true,
                refs: [],
                requiresRefs: false
            }, null);
            itemModal.classList.remove('show');
            hideTypeahead();
        };

        if (hotels.length === 1) {
            await processHotelSelection(hotels[0]);
        } else {
            openHotelSelectModal(hotels, (selectedHotel) => {
                processHotelSelection(selectedHotel);
            });
        }
    });

    // פתיחת/סגירת בלוקים בתוך פריט
    openBlockBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const el=document.querySelector(b.dataset.open);
        el.classList.toggle('hidden');
        if (el.id==='block-address') setTimeout(()=>{ if(addrMap) addrMap.invalidateSize(); },100);
        if (el.id==='block-route') setTimeout(()=>{ if(routeMap) routeMap.invalidateSize(); },100);
      });
    });

    // סגירת מודל צפייה
    viewClose.addEventListener('click', ()=> viewModal.classList.remove('show'));

    // פתיחת מודל AI
    aiBuildBtn.addEventListener('click', ()=>{
      aiInput.value='';
      aiPreview.classList.add('hidden');
      aiCreate.disabled = true;
      aiModal.classList.add('show');
    });
    aiClose.addEventListener('click', ()=> aiModal.classList.remove('show'));

    function parseAiText(raw){
      const lines = (raw||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const result = { dayTitle:null, items:[] };
      let cur = null;
      const startItem = (title=null)=>{
        if (cur) result.items.push(finalize(cur));
        cur = {
          title: title, startTime: null, endTime: null, descParts: [], address: null,
          addressFromHotel:false, linkSite: null, linkBook: null,
          travel: { from:null, to:null, mode:'driving', timeText:null },
          wantsRefs:false, summary:null, notes:null, isBackToHotel:false
        };
      };
      const finalize = (o)=>{
        return {
          title: o.title || (o.isBackToHotel?'חזרה למלון':'(ללא כותרת)'),
          startTime: o.startTime || null, endTime: o.endTime || null,
          description: o.descParts.length ? o.descParts.join('\n') : null,
          address: o.addressFromHotel ? { isHotel:true } : (o.address? {label:o.address} : null),
          links: { site: o.linkSite || null, booking: o.linkBook || null },
          travel: (o.travel.from || o.travel.to) ? {
            from: o.travel.from==='HOTEL' ? {isHotel:true} : (o.travel.from? {label:o.travel.from}: null),
            to:   o.travel.to==='HOTEL'   ? {isHotel:true} : (o.travel.to? {label:o.travel.to}: null),
            mode: o.travel.mode || 'driving', timeText: null
          } : null,
          wantsRefs: !!o.wantsRefs, summary: o.summary || null, notes: o.notes || null, isBackToHotel: !!o.isBackToHotel
        };
      };
      const m = {
        dayTitle: /^!(.+)!$/, itemTitle: /^״(.+?)״$/, start: /^\/\s*([^\/]+?)\s*\/$/, end: /^\\\s*([^\\]+?)\s*\\$/,
        backHotel: /^₪$/, desc: /^:\s*(.+?)\s*:$/, addressHotel: /^׳₪(?:\b|$)/, address: /^׳(.+?)׳$/,
        linkSite: /^\?\s*(.+?)\s*\?$/, linkBook: /^\$\s*(.+?)\s*\$$/, routeFrom: /^>\s*(.+)$/, routeTo: /^<\s*(.+)$/,
        refs: /^\*$/, summary: /^•\s*(.+?)\s*•$/, notes: /^~\s*(.+?)\s*~$/
      };
      const parseRouteSide = (txt)=>{
        const t = txt.trim();
        if (/^׳₪/.test(t)) return 'HOTEL';
        const adr = t.match(m.address);
        if (adr) return adr[1].trim();
        return t;
      };
      for (const line of lines){
        if (m.dayTitle.test(line)){ result.dayTitle = line.match(m.dayTitle)[1].trim(); continue; }
        if (m.itemTitle.test(line)){ startItem(line.match(m.itemTitle)[1].trim()); continue; }
        if (!cur) startItem();
        if (m.start.test(line)){ cur.startTime = line.match(m.start)[1].trim(); continue; }
        if (m.end.test(line)){ cur.endTime = line.match(m.end)[1].trim(); continue; }
        if (m.backHotel.test(line)){ cur.isBackToHotel = true; if(!cur.title) cur.title='חזרה למלון'; continue; }
        if (m.desc.test(line)){ cur.descParts.push(line.match(m.desc)[1]); continue; }
        if (m.addressHotel.test(line)){ cur.addressFromHotel = true; continue; }
        if (m.address.test(line)){ cur.address = line.match(m.address)[1].trim(); continue; }
        if (m.linkSite.test(line)){ cur.linkSite = line.match(m.linkSite)[1].trim(); continue; }
        if (m.linkBook.test(line)){ cur.linkBook = line.match(m.linkBook)[1].trim(); continue; }
        if (m.routeFrom.test(line)){ cur.travel.from = parseRouteSide(line.match(m.routeFrom)[1]); continue; }
        if (m.routeTo.test(line)){ cur.travel.to   = parseRouteSide(line.match(m.routeTo)[1]); continue; }
        if (m.refs.test(line)){ cur.wantsRefs = true; continue; }
        if (m.summary.test(line)){ cur.summary = line.match(m.summary)[1].trim(); continue; }
        if (m.notes.test(line)){ cur.notes = line.match(m.notes)[1].trim(); continue; }
        cur.descParts.push(line);
      }
      if (cur) result.items.push(finalize(cur));
      return result;
    }

    aiParse.addEventListener('click', ()=>{
      const parsed = parseAiText(aiInput.value);
      const rows = [];
      if (parsed.dayTitle) rows.push(`<div class="text-slate-800"><b>כותרת יום:</b> ${parsed.dayTitle}</div>`);
      rows.push(`<div class="text-slate-800"><b>כמות פריטים:</b> ${parsed.items.length}</div>`);
      parsed.items.forEach((it, i)=>{
        const needsAddr = !!(it.address);
        const needsRoute = !!(it.travel);
        const needsRefs = !!(it.wantsRefs);
        rows.push(`
          <div class="border rounded-lg p-2">
            <div><b>${i+1}.</b> ${it.title}</div>
            <div class="text-xs text-slate-600">${[it.startTime, it.endTime?('– '+it.endTime):''].filter(Boolean).join(' ') || 'ללא שעות'}</div>
            ${it.summary?`<div class="text-xs">${it.summary}</div>`:''}
            ${needsAddr?`<div class="text-xs text-red-700">• יצוין אימות כתובת</div>`:''}
            ${needsRoute?`<div class="text-xs text-red-700">• יצוין אימות מסלול</div>`:''}
            ${needsRefs?`<div class="text-xs text-red-700">• יצוין קישור לאטרקציות/מעברים</div>`:''}
          </div>
        `);
      });
      aiPreviewContent.innerHTML = rows.join('');
      aiPreview.classList.remove('hidden');
      aiCreate.disabled = parsed.items.length===0;
      aiCreate._parsed = parsed;
    });

    aiCreate.addEventListener('click', async () => {
        const parsed = aiCreate._parsed;
        if (!parsed) return;
        aiCreate.disabled = true;
        aiLoaderOverlay.classList.remove('hidden');
        const btnText = aiCreate.querySelector('.btn-text');
        const btnLoader = aiCreate.querySelector('.loader');
        btnText.textContent = 'יוצר לו"ז...';
        btnLoader.classList.remove('hidden');
        try {
            if (parsed.dayTitle) {
                await setDoc(dayDocRef, { title: parsed.dayTitle, updatedAt: serverTimestamp() }, { merge: true });
                dayTitle = parsed.dayTitle;
                reflectDayTitleUI();
            }
            const allHotelsForDate = await findAllHotelsForDate(selectedDate);
            const hotel = allHotelsForDate.length === 1 ? allHotelsForDate[0] : null;

            for (const it of parsed.items) {
                const payload = {
                    title: it.title || '(ללא כותרת)',
                    startTime: it.startTime || null,
                    endTime: it.endTime || null,
                    description: it.description || null,
                    summary: it.summary || null,
                    notes: it.notes || null,
                    links: { site: it.links?.site || null, booking: it.links?.booking || null },
                    address: null,
                    travel: null,
                    refs: [],
                    requiresRefs: !!it.wantsRefs
                };
                if (it.address) {
                    if (it.address.isHotel && hotel) {
                        payload.address = { label: hotel.address || hotel.name || 'מלון', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null };
                    } else if (it.address.isHotel && !hotel) {
                        payload.address = { label: 'כתובת המלון', lat: null, lng: null };
                    } else {
                        payload.address = { label: it.address.label || it.address, lat: null, lng: null };
                    }
                }
                if (it.travel) {
                    const from = it.travel.from;
                    const to = it.travel.to;
                    const mode = it.travel.mode || 'driving';
                    const fromPt = (from && from.isHotel && hotel) ? { label: hotel.address || hotel.name || 'מלון', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null }
                        : (from && from.isHotel && !hotel) ? { label: 'כתובת המלון', lat: null, lng: null }
                        : (from ? { label: from.label || from, lat: null, lng: null } : null);
                    const toPt = (to && to.isHotel && hotel) ? { label: hotel.address || hotel.name || 'מלון', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null }
                        : (to && to.isHotel && !hotel) ? { label: 'כתובת המלון', lat: null, lng: null }
                        : (to ? { label: to.label || to, lat: null, lng: null } : null);
                    payload.travel = (fromPt || toPt) ? { from: fromPt, to: toPt, mode, timeText: null } : null;
                }
                await new Promise(resolve => setTimeout(resolve, 50)); 
                await saveItemCore(payload, null, { source: 'ai' });
            }
            aiModal.classList.remove('show');
        } catch (error) {
            console.error("Error creating schedule from AI:", error);
            alert("אירעה שגיאה ביצירת הלו\"ז. נסה שוב.");
        } finally {
            aiLoaderOverlay.classList.add('hidden');
            btnText.textContent = 'צור לוז';
            btnLoader.classList.add('hidden');
            aiCreate.disabled = !aiCreate._parsed || aiCreate._parsed.items.length === 0;
        }
    });

    function renderVSelectedRefs(){
      vSelectedRefsWrap.innerHTML = vSelectedRefs.length ? vSelectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm">לא נבחרו קישורים.</span>`;
      vSelectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          vSelectedRefs.splice(idx,1);
          renderVSelectedRefs();
        });
      });
    }

    async function openVerifyModal(item){
      vCurrentItem = item;
      vTitle.textContent = item.title || '(ללא כותרת)';

      const needAddr = !!item.needsVerifyAddress;
      const needRoute= !!item.needsVerifyRoute;
      const needRefs = !!item.needsVerifyRefs;

      vBlockAddr.classList.toggle('hidden', !needAddr);
      vBlockRoute.classList.toggle('hidden', !needRoute);
      vBlockRefs.classList.toggle('hidden', !needRefs);

      if (needAddr){
        if (!vAddrMap){
          vAddrMap = L.map(vAddrMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vAddrMap);
        }
        if (vAddrMarker){ vAddrMap.removeLayer(vAddrMarker); vAddrMarker=null; }
        vAddrInput.value = item.address?.label || '';
        if (item.address?.lat && item.address?.lng){
          vAddrMarker = L.marker([item.address.lat,item.address.lng]).addTo(vAddrMap);
          vAddrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
          vAddrMap.setView([item.address.lat,item.address.lng], 14);
        }
      }

      if (needRoute){
        if (!vRouteMap){
          vRouteMap = L.map(vRouteMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vRouteMap);
        }
        if (vRouteLayer){ vRouteMap.removeLayer(vRouteLayer); vRouteLayer=null; }
        vRouteMarkers.forEach(m=> m && vRouteMap.removeLayer(m));
        vRouteMarkers=[null,null];

        vRouteFrom.value = item.travel?.from?.label || '';
        vRouteTo.value   = item.travel?.to?.label   || '';
        vRouteMode.value = item.travel?.mode || 'driving';
        vRouteTime.textContent = item.travel?.timeText || '';

        if (item.travel?.from?.lat){
          vRouteMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(vRouteMap);
          vRouteMarkers[0]._data = item.travel.from;
        }
        if (item.travel?.to?.lat){
          vRouteMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(vRouteMap);
          vRouteMarkers[1]._data = item.travel.to;
        }
        if (vRouteMarkers[0] && vRouteMarkers[1]) {
          vRouteMap.fitBounds(L.featureGroup(vRouteMarkers).getBounds(),{padding:[20,20]});
        }
      }

      vSelectedRefs = Array.isArray(item.refs) ? [...item.refs] : [];
      if (needRefs){
        renderVSelectedRefs();
        await buildConnectLists(vConnectLists, vSelectedRefs);
      }

      vModal.classList.add('show');

      // invalidate maps for proper rendering (מניעת מפה אפורה)
      setTimeout(()=>{
        if(needAddr && vAddrMap) vAddrMap.invalidateSize();
        if(needRoute && vRouteMap) vRouteMap.invalidateSize();
      },160);
    }

    vClose.addEventListener('click', ()=> vModal.classList.remove('show'));
    vCancel.addEventListener('click', ()=> vModal.classList.remove('show'));

    bindTypeahead(vAddrInput, (p)=>{
      vAddrInput.value=p.label;
      if(!vAddrMap){
        vAddrMap = L.map(vAddrMapDiv).setView([p.lat,p.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vAddrMap);
      }
      if(!vAddrMarker) vAddrMarker = L.marker([p.lat,p.lng]).addTo(vAddrMap);
      else vAddrMarker.setLatLng([p.lat,p.lng]);
      vAddrMarker._data = p;
      vAddrMap.setView([p.lat,p.lng], 15);
      vAddrMap.invalidateSize();
    });
    vAddrSearch.addEventListener('click', ()=> doSearchForInput(vAddrInput));

    function vSetRoutePoint(idx,p){
      if(!vRouteMap){
        vRouteMap = L.map(vRouteMapDiv).setView([p.lat,p.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vRouteMap);
      }
      if(!vRouteMarkers[idx]) vRouteMarkers[idx]=L.marker([p.lat,p.lng]).addTo(vRouteMap);
      else vRouteMarkers[idx].setLatLng([p.lat,p.lng]);
      vRouteMarkers[idx]._data=p;
      vRouteMap.setView([p.lat,p.lng], 13);
      vRouteMap.invalidateSize();
    }
    bindTypeahead(vRouteFrom, (p)=>{ vRouteFrom.value=p.label; vSetRoutePoint(0,p); });
    bindTypeahead(vRouteTo,   (p)=>{ vRouteTo.value=p.label; vSetRoutePoint(1,p); });
    vRouteFromSearch.addEventListener('click', ()=> doSearchForInput(vRouteFrom));
    vRouteToSearch  .addEventListener('click', ()=> doSearchForInput(vRouteTo));

    vRouteCalc.addEventListener('click', async ()=>{
      if (!vRouteMarkers[0]?._data || !vRouteMarkers[1]?._data) return alert('בחר גם מוצא וגם יעד.');
      const a=vRouteMarkers[0]._data, b=vRouteMarkers[1]._data;
      const profile = (vRouteMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        vRouteTime.textContent=`זמן משוער: ${mins} דק׳`;
        if (vRouteLayer) vRouteMap.removeLayer(vRouteLayer);
        vRouteLayer=L.geoJSON(r.geometry).addTo(vRouteMap);
        vRouteMap.fitBounds(vRouteLayer.getBounds(),{padding:[20,20]});
        vRouteMap.invalidateSize();
      } else vRouteTime.textContent='לא נמצא מסלול.';
    });

    vUseHotel.addEventListener('click', () => {
        handleUseHotelAddress(vAddrInput, vAddrMap, vAddrMarker, (newMarker) => { vAddrMarker = newMarker; });
    });

    vSave.addEventListener('click', async ()=>{
      if (!vCurrentItem) return;

      let newAddress = vCurrentItem.address || null;
      let newTravel  = vCurrentItem.travel  || null;
      let newRefs    = Array.isArray(vSelectedRefs)? vSelectedRefs : [];

      if (!vBlockAddr.classList.contains('hidden')){
        if (vAddrMarker?._data){
          newAddress = { label: vAddrMarker._data.label, lat: vAddrMarker._data.lat, lng: vAddrMarker._data.lng };
        } else if (vAddrInput.value.trim()){
          newAddress = { label: vAddrInput.value.trim(), lat: null, lng: null };
        } else {
          newAddress = null;
        }
      }

      if (!vBlockRoute.classList.contains('hidden')){
        const from = vRouteMarkers[0]?._data
          ? {label:vRouteMarkers[0]._data.label, lat:vRouteMarkers[0]._data.lat, lng:vRouteMarkers[0]._data.lng}
          : (vRouteFrom.value.trim()? {label:vRouteFrom.value.trim(), lat:null, lng:null}: null);
        const to   = vRouteMarkers[1]?._data
          ? {label:vRouteMarkers[1]._data.label, lat:vRouteMarkers[1]._data.lat, lng:vRouteMarkers[1]._data.lng}
          : (vRouteTo.value.trim()? {label:vRouteTo.value.trim(), lat:null, lng:null}: null);

        newTravel = (from || to) ? { from, to, mode: vRouteMode.value, timeText: vRouteTime.textContent || null } : null;
      }

      const needsVerifyAddress = !!(newAddress && !(newAddress.lat!=null && newAddress.lng!=null));
      const needsVerifyRoute   = !!(newTravel && !((newTravel.from?.lat!=null) && (newTravel.to?.lat!=null)));
      const needsVerifyRefs    = !!(vCurrentItem.requiresRefs && (!Array.isArray(newRefs) || newRefs.length===0));

      await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',vCurrentItem.id), {
        address: newAddress || null,
        travel:  newTravel  || null,
        refs:    newRefs,
        needsVerifyAddress,
        needsVerifyRoute,
        needsVerifyRefs,
        updatedAt: serverTimestamp()
      });

      await recomputeDistances();

      vModal.classList.remove('show');

      // נבטיח שהמפה במסך צפייה (אם יפתח מחדש מיד) לא תהיה אפורה
      setTimeout(()=>{
        if(viewMap) viewMap.invalidateSize();
      },150);
    });

    // פתיחת מודל פריט (הוספה/עריכה, וגם אימות ממסך צפייה)
    function openItemModal(item=null, opts={verify:false, focus:{address:false, route:false, refs:false}}){
      // === תיקון באג: איפוס מצב ===
      // סוגרים את כל הבלוקים הנפתחים כדי להבטיח שבפתיחה שלהם מחדש ייווצרו אירועים על המידע החדש
      // ומנקים את תוכן ה-HTML של רשימת האטרקציות כדי לא להציג מידע ישן
      document.querySelectorAll('#block-address, #block-links, #block-book, #block-route, #block-connect')
        .forEach(el => el.classList.add('hidden'));
      connectLists.innerHTML = ''; // ניקוי הרשימה הישנה כדי שלא יהיו כפתורים "תקועים"
      // ==========================

      editingItemId = item?.id || null;
      modalTitle.textContent = editingItemId ? 'עריכת פריט' : 'הוספת פריט ליום';

      inputDayTitle.value = dayTitle || '';
      inputItemTitle.value = item?.title || '';
      inputStart.value = item?.startTime || '';
      inputEnd.value   = item?.endTime || '';
      inputDesc.value  = item?.description || '';
      inputSummary.value = item?.summary || '';
      inputNotes.value   = item?.notes || '';
      linkGeneral.value  = item?.links?.site || '';
      linkBook.value     = item?.links?.booking || '';

      endWrap.classList.toggle('hidden', !item?.endTime);

      requiresRefsFlag = !!item?.requiresRefs;
      selectedRefs = Array.isArray(item?.refs) ? [...item.refs] : [];
      renderSelectedRefs();

      if (!addrMap){
        addrMap = L.map(addrMapDiv).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap);
      }
      if (addrMarker){ addrMap.removeLayer(addrMarker); addrMarker=null; }
      addrInput.value = item?.address?.label || '';
      if (item?.address?.lat && item?.address?.lng){
        addrMarker = L.marker([item.address.lat,item.address.lng]).addTo(addrMap);
        addrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
        addrMap.setView([item.address.lat,item.address.lng], 14);
      }

      if (!routeMap){
        routeMap = L.map(rMapDiv).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
      }
      if (routeLayer){ routeMap.removeLayer(routeLayer); routeLayer=null; }
      routeMarkers.forEach(m=> m && routeMap.removeLayer(m));
      routeMarkers=[null,null];
      rFrom.value = item?.travel?.from?.label || '';
      rTo.value   = item?.travel?.to?.label   || '';
      rMode.value = item?.travel?.mode || 'driving';
      rTime.textContent = item?.travel?.timeText || '';
      if (item?.travel?.from?.lat){
        routeMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(routeMap);
        routeMarkers[0]._data = item.travel.from;
      }
      if (item?.travel?.to?.lat){
        routeMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(routeMap);
        routeMarkers[1]._data = item.travel.to;
      }
      if (routeMarkers[0] && routeMarkers[1]) {
        routeMap.fitBounds(L.featureGroup(routeMarkers).getBounds(),{padding:[20,20]});
      }

      const wantVerify = !!opts.verify;
      verifyBanner.classList.toggle('hidden', !wantVerify);

      showStep(wantVerify ? 'E' : (dayTitle ? 'B' : 'A'));

      itemModal.classList.add('show');

      // invalidate maps למניעת מפה אפורה
      setTimeout(()=>{
        if(addrMap) addrMap.invalidateSize();
        if(routeMap) routeMap.invalidateSize();
      },160);
    }

    addItemBtn.addEventListener('click', ()=> openItemModal());
    closeModal.addEventListener('click', ()=> {
      itemModal.classList.remove('show');
      hideTypeahead();
    });
  </script>
</body>
</html>