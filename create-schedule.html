<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>יצירת לוז יומי</title>

  <!-- Tailwind / Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root { --panel: rgba(255,255,255,.9); }
    html, body { height: 100%; }
    body { font-family: 'Assistant', sans-serif; overscroll-behavior-y: none; }
    /* Bg */
    .bg-fixed-wrap { position: fixed; inset: 0; z-index: 0; }
    .bg-fixed-wrap .bg { background-image: url('https://i.imgur.com/MjekTyd.jpeg'); background-size: cover; background-position: center; width: 100%; height: 100%; }
    .bg-fixed-wrap .overlay { position:absolute; inset:0; background: rgba(0,0,0,.45); }

    /* Containers */
    .content { position: relative; z-index: 1; min-height: 100%; }
    .card { background: var(--panel); backdrop-filter: blur(6px); }

    /* Dropdown for date/destination */
    .chooser { position: relative; }
    .chooser-menu { position: absolute; inset-inline-start:0; inset-block-start: 100%; min-width: 100%; z-index: 60; max-height: 340px; overflow:auto; }

    /* Leaflet z-index fix vs autocomplete */
    .leaflet-container { z-index: 10; border-radius: 0.75rem; }
    .map-sm { height: 220px; }
    .map-md { height: 300px; }

    /* OSM autocomplete dropdown */
    .auto-wrap { position: relative; }
    .osm-suggestions {
      position: absolute; inset-inline-start:0; inset-block-start: calc(100% + 4px);
      background: #fff; border: 1px solid #e2e8f0; border-radius: 0.5rem; box-shadow: 0 10px 25px rgba(0,0,0,.12);
      z-index: 9999; max-height: 260px; overflow:auto; width: 100%;
    }
    .osm-suggestions button { width: 100%; text-align: right; padding: .5rem .75rem; }
    .osm-suggestions button:hover { background: #f1f5f9; }

    /* Modal base */
    .modal { position: fixed; inset: 0; background: rgba(0,0,0,.6); display: none; align-items: center; justify-content: center; z-index: 80; }
    .modal.show { display: flex; }
    .modal-card { width: 100%; max-width: 900px; max-height: 92vh; overflow: hidden; display: flex; flex-direction: column; }
    .modal-body { overflow:auto; }

    /* Items list */
    .schedule-item.needs-validation { border: 2px dashed #ef4444; background: #fff1f1; }
    .schedule-item .badge { font-size: 12px; padding: 2px 8px; border-radius: 999px; }
    .muted { color:#64748b; }

    /* Smoothness / anti-jump */
    [data-dynamic] { overflow-anchor: none; }
  </style>
</head>
<body>

  <!-- Background -->
  <div class="bg-fixed-wrap">
    <div class="bg"></div>
    <div class="overlay"></div>
  </div>

  <!-- Header -->
  <div class="content">
    <header class="sticky top-0 z-40 bg-white/70 backdrop-blur-sm shadow-sm">
      <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
        <button id="back-btn" class="p-2 text-slate-700 hover:text-blue-600">
          <i class="fa-solid fa-arrow-right-long"></i> חזרה
        </button>
        <div class="text-center">
          <h1 id="page-title" class="text-xl font-bold text-slate-800">יצירת לוז יומי</h1>
          <div id="trip-caption" class="text-sm text-slate-600"></div>
        </div>
        <div class="flex items-center gap-2">
          <button id="ai-btn" class="px-3 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700">
            <i class="fa-solid fa-wand-magic-sparkles mr-1"></i> יצירת לוז עם AI
          </button>
        </div>
      </div>
    </header>

    <!-- Main -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
      <!-- Date/Destination chooser -->
      <section class="card p-4 rounded-xl shadow">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div class="chooser">
            <button id="choose-day-btn" class="px-4 py-3 rounded-lg bg-white border shadow hover:bg-slate-50 w-full md:w-auto flex items-center justify-between gap-3">
              <span id="choose-day-label" class="font-bold text-slate-800">טוען תאריכים...</span>
              <i class="fa-solid fa-chevron-down text-slate-500"></i>
            </button>
            <div id="chooser-menu" class="chooser-menu hidden card rounded-xl shadow">
              <div id="chooser-list" class="p-2"></div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button id="add-item-btn" class="px-4 py-3 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-bold">
              <i class="fa-solid fa-plus mr-2"></i> הוספת לוז
            </button>
          </div>
        </div>
      </section>

      <!-- Day header row -->
      <section class="card p-4 rounded-xl shadow">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-slate-500 text-sm">ליום:</div>
            <div id="day-header" class="text-lg font-bold text-slate-800">—</div>
          </div>
          <div class="flex items-center gap-2">
            <span id="day-title-display" class="hidden text-slate-700 font-semibold"></span>
            <button id="edit-day-title-btn" class="hidden p-2 rounded-md hover:bg-slate-100" title="עריכת כותרת יום">
              <i class="fa-solid fa-pen"></i>
            </button>
          </div>
        </div>
      </section>

      <!-- Items list -->
      <section class="space-y-3" id="items-list" data-dynamic>
        <div class="text-center py-10 text-white/90">טוען פריטים...</div>
      </section>
    </main>
  </div>

  <!-- Modals -->

  <!-- Add/Edit Item Modal -->
  <div id="item-modal" class="modal">
    <div class="modal-card card rounded-2xl shadow-2xl">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 id="item-modal-title" class="text-xl font-bold text-slate-800">הוספת פריט ללוז</h3>
        <button class="p-2 text-slate-500 hover:text-red-500" id="item-modal-close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body p-4 space-y-5">
        <!-- Step 1 (maybe skipped): Day title -->
        <div id="step-day-title" class="space-y-2 hidden">
          <label class="font-bold text-slate-700">כותרת ראשית ליום</label>
          <input id="day-title-input" type="text" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: יום מוזיאונים ואוכל רחוב">
          <div class="text-xs text-slate-500">נשמר פעם אחת ליום. לאחר שמירה ניתן לערוך בעיפרון ליד הכותרת.</div>
        </div>

        <hr class="opacity-30">

        <!-- Item fields -->
        <div class="grid md:grid-cols-2 gap-4">
          <div class="space-y-2">
            <label class="font-bold text-slate-700">כותרת הפריט</label>
            <input id="item-title" type="text" class="w-full p-3 border rounded-lg" placeholder="לדוגמה: מוזיאון ישראל">
          </div>

          <div class="space-y-2">
            <label class="font-bold text-slate-700">שעת התחלה</label>
            <div class="flex items-center gap-2">
              <input id="item-start" type="time" class="w-full p-3 border rounded-lg">
              <button id="toggle-end" class="px-3 py-2 rounded-lg bg-slate-200 hover:bg-slate-300 text-sm">הוסף שעת סוף</button>
            </div>
            <input id="item-end" type="time" class="w-full p-3 border rounded-lg hidden mt-2">
            <div class="text-xs text-slate-500 flex items-center gap-2">
              <button id="quick-back-to-hotel" class="px-2 py-1 bg-amber-500/20 text-amber-700 rounded-md hover:bg-amber-500/30">
                <i class="fa-solid fa-bed"></i> יצירת "חזרה למלון" בשעה זו
              </button>
            </div>
          </div>
        </div>

        <div class="space-y-2">
          <label class="font-bold text-slate-700">תיאור/פירוט</label>
          <textarea id="item-notes" rows="3" class="w-full p-3 border rounded-lg" placeholder="מה הולך להיות בפריט הזה..."></textarea>
        </div>

        <!-- Expandable extras as buttons -->
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-3">
          <button class="extra-btn px-3 py-3 rounded-xl bg-white border hover:bg-slate-50 text-right" data-extra="address">
            <i class="fa-solid fa-location-dot text-sky-600"></i> כתובת
          </button>
          <button class="extra-btn px-3 py-3 rounded-xl bg-white border hover:bg-slate-50" data-extra="links">
            <i class="fa-solid fa-link text-green-600"></i> קישורים (אתר/הזמנה)
          </button>
          <button class="extra-btn px-3 py-3 rounded-xl bg-white border hover:bg-slate-50" data-extra="route">
            <i class="fa-solid fa-person-walking text-purple-600"></i> הליכה/נסיעה
          </button>
          <button class="extra-btn px-3 py-3 rounded-xl bg-white border hover:bg-slate-50" data-extra="attach">
            <i class="fa-solid fa-paperclip text-indigo-600"></i> קישור לאטרקציות/מלונות/מעברים
          </button>
          <button class="extra-btn px-3 py-3 rounded-xl bg-white border hover:bg-slate-50" data-extra="summary">
            <i class="fa-solid fa-circle-info text-amber-600"></i> תקציר כרטיסייה
          </button>
          <button class="extra-btn px-3 py-3 rounded-xl bg-white border hover:bg-slate-50" data-extra="remarks">
            <i class="fa-solid fa-note-sticky text-rose-600"></i> הערות חשובות
          </button>
        </div>

        <!-- Extras Panels -->
        <div id="extra-panels" class="space-y-4">

          <!-- Address -->
          <div id="panel-address" class="hidden p-3 rounded-xl bg-slate-50 border">
            <div class="flex items-center justify-between mb-2">
              <label class="font-bold text-slate-700"><i class="fa-solid fa-location-dot"></i> כתובת</label>
              <button id="use-hotel-address" class="px-2 py-1 rounded-md bg-emerald-500/20 text-emerald-700 hover:bg-emerald-500/30 text-sm">
                <i class="fa-solid fa-bed"></i> כתובת המלון
              </button>
            </div>
            <div class="grid md:grid-cols-2 gap-3">
              <div class="auto-wrap">
                <input id="item-address" type="text" class="w-full p-3 border rounded-lg" placeholder="כתובת/שם מקום">
                <div class="osm-suggestions hidden" data-for="item-address"></div>
              </div>
              <div id="address-map" class="map-sm rounded-lg bg-slate-200"></div>
            </div>
          </div>

          <!-- Links -->
          <div id="panel-links" class="hidden p-3 rounded-xl bg-slate-50 border">
            <label class="font-bold text-slate-700"><i class="fa-solid fa-link"></i> קישורים</label>
            <div class="grid md:grid-cols-2 gap-3">
              <input id="item-website" type="url" class="w-full p-3 border rounded-lg" placeholder="קישור לאתר">
              <input id="item-booking" type="url" class="w-full p-3 border rounded-lg" placeholder="קישור להזמנה/כרטיס">
            </div>
          </div>

          <!-- Route -->
          <div id="panel-route" class="hidden p-3 rounded-xl bg-slate-50 border">
            <div class="grid md:grid-cols-2 gap-3">
              <div>
                <label class="font-bold text-slate-700"><i class="fa-solid fa-arrow-up-right-from-square"></i> מאיפה</label>
                <div class="auto-wrap">
                  <input id="route-from" type="text" class="w-full p-3 border rounded-lg" placeholder="נקודת התחלה">
                  <div class="osm-suggestions hidden" data-for="route-from"></div>
                </div>
                <button id="route-from-hotel" class="mt-2 text-sm px-2 py-1 rounded-md bg-emerald-500/20 text-emerald-700 hover:bg-emerald-500/30">
                  כתובת המלון
                </button>
              </div>
              <div>
                <label class="font-bold text-slate-700"><i class="fa-solid fa-location-arrow"></i> לאן</label>
                <div class="auto-wrap">
                  <input id="route-to" type="text" class="w-full p-3 border rounded-lg" placeholder="נקודת יעד">
                  <div class="osm-suggestions hidden" data-for="route-to"></div>
                </div>
              </div>
              <div class="md:col-span-2">
                <div id="route-map" class="map-md rounded-lg bg-slate-200"></div>
                <div class="flex items-center justify-between mt-2">
                  <button id="calc-route" class="px-3 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700">
                    חשב מסלול
                  </button>
                  <div id="route-info" class="text-sm text-slate-600"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Attach -->
          <div id="panel-attach" class="hidden p-3 rounded-xl bg-slate-50 border">
            <label class="font-bold text-slate-700"><i class="fa-solid fa-paperclip"></i> קישור ידני</label>
            <div class="text-sm text-slate-600 mb-2">בחר פריט מתוך האטרקציות/מלונות/מעברים המשויכים לטיול.</div>
            <div class="flex gap-2 mb-3">
              <button class="tab-btn px-3 py-1 rounded-md bg-white border hover:bg-slate-50" data-tab="att">אטרקציות/מסעדות</button>
              <button class="tab-btn px-3 py-1 rounded-md bg-white border hover:bg-slate-50" data-tab="hotels">מלונות</button>
              <button class="tab-btn px-3 py-1 rounded-md bg-white border hover:bg-slate-50" data-tab="moves">מעברים</button>
            </div>
            <div id="attach-list" class="max-h-56 overflow-auto border rounded-lg bg-white p-2 text-sm"></div>
            <div id="attach-picked" class="mt-2 text-slate-700"></div>
          </div>

          <!-- Summary -->
          <div id="panel-summary" class="hidden p-3 rounded-xl bg-slate-50 border">
            <label class="font-bold text-slate-700"><i class="fa-solid fa-circle-info"></i> תקציר שיופיע בכרטיסייה</label>
            <input id="item-summary" type="text" class="w-full p-3 border rounded-lg" maxlength="140" placeholder="משפט קצר לתצוגה">
          </div>

          <!-- Remarks -->
          <div id="panel-remarks" class="hidden p-3 rounded-xl bg-slate-50 border">
            <label class="font-bold text-slate-700"><i class="fa-solid fa-note-sticky"></i> הערות חשובות</label>
            <textarea id="item-remarks" rows="2" class="w-full p-3 border rounded-lg" placeholder="דברים שחשוב לזכור..."></textarea>
          </div>
        </div>
      </div>
      <div class="p-4 border-t flex items-center justify-between">
        <div id="item-modal-msg" class="text-sm text-rose-600 font-bold"></div>
        <div class="flex items-center gap-2">
          <button id="save-item" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-bold">שמור</button>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Modal -->
  <div id="ai-modal" class="modal">
    <div class="modal-card card rounded-2xl shadow-2xl">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-800"><i class="fa-solid fa-wand-magic-sparkles"></i> יצירת לוז עם AI</h3>
        <button class="p-2 text-slate-500 hover:text-red-500" id="ai-modal-close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body p-4 space-y-4">
        <div class="text-sm text-slate-700">
          הדבק כאן את הפלט מה-AI לפי הסימונים שסיכמנו ( ! ״ / \ : ׳ ׳₪ ? $ > < * • ~ ).
        </div>
        <textarea id="ai-input" class="w-full p-3 border rounded-lg min-h-[260px]" placeholder="הדבק כאן את הטקסט מה-AI..."></textarea>
        <div class="text-xs text-slate-500">
          הערה: פריטים עם כתובת/מסלול/שיוך ידני יסומנו לאחר היצירה לאימות (כרטיס אדום). לחץ עליהם כדי לאמת כתובת/לבחור קישור.
        </div>
      </div>
      <div class="p-4 border-t flex items-center justify-between">
        <div id="ai-msg" class="text-sm text-rose-600 font-bold"></div>
        <button id="ai-create" class="px-4 py-2 rounded-lg bg-indigo-600 text-white hover:bg-indigo-700 font-bold">צור לוז</button>
      </div>
    </div>
  </div>

  <!-- Validation Modal (address/route/attach) -->
  <div id="validate-modal" class="modal">
    <div class="modal-card card rounded-2xl shadow-2xl">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-800">אימות פריט</h3>
        <button class="p-2 text-slate-500 hover:text-red-500" id="validate-close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body p-4 space-y-4">
        <div id="validate-need" class="text-slate-700"></div>

        <!-- Address verify -->
        <div id="val-address-wrap" class="hidden">
          <div class="auto-wrap">
            <label class="font-bold text-slate-700">כתובת</label>
            <input id="val-address" type="text" class="w-full p-3 border rounded-lg" placeholder="כתובת/שם מקום">
            <div class="osm-suggestions hidden" data-for="val-address"></div>
          </div>
          <div id="val-address-map" class="map-sm rounded-lg bg-slate-200 mt-2"></div>
        </div>

        <!-- Route verify -->
        <div id="val-route-wrap" class="hidden">
          <div class="grid md:grid-cols-2 gap-3">
            <div class="auto-wrap">
              <label class="font-bold text-slate-700">מאיפה</label>
              <input id="val-from" type="text" class="w-full p-3 border rounded-lg">
              <div class="osm-suggestions hidden" data-for="val-from"></div>
            </div>
            <div class="auto-wrap">
              <label class="font-bold text-slate-700">לאן</label>
              <input id="val-to" type="text" class="w-full p-3 border rounded-lg">
              <div class="osm-suggestions hidden" data-for="val-to"></div>
            </div>
            <div class="md:col-span-2">
              <div id="val-route-map" class="map-md rounded-lg bg-slate-200 mt-2"></div>
              <div id="val-route-info" class="text-sm text-slate-600 mt-2"></div>
            </div>
          </div>
        </div>

        <!-- Attach verify -->
        <div id="val-attach-wrap" class="hidden">
          <div class="text-sm text-slate-600 mb-2">בחר אטרקציה/מלון/מעבר לקישור.</div>
          <div class="flex gap-2 mb-3">
            <button class="tab-btn px-3 py-1 rounded-md bg-white border hover:bg-slate-50" data-tab="att">אטרקציות/מסעדות</button>
            <button class="tab-btn px-3 py-1 rounded-md bg-white border hover:bg-slate-50" data-tab="hotels">מלונות</button>
            <button class="tab-btn px-3 py-1 rounded-md bg-white border hover:bg-slate-50" data-tab="moves">מעברים</button>
          </div>
          <div id="val-attach-list" class="max-h-56 overflow-auto border rounded-lg bg-white p-2 text-sm"></div>
          <div id="val-attach-picked" class="mt-2 text-slate-700"></div>
        </div>
      </div>
      <div class="p-4 border-t flex items-center justify-between">
        <div id="val-msg" class="text-sm text-rose-600 font-bold"></div>
        <button id="val-save" class="px-4 py-2 rounded-lg bg-green-600 text-white hover:bg-green-700 font-bold">שמור אימות</button>
      </div>
    </div>
  </div>

  <!-- Edit day title small modal -->
  <div id="edit-title-modal" class="modal">
    <div class="modal-card card rounded-2xl shadow-2xl max-w-xl">
      <div class="p-4 border-b flex items-center justify-between">
        <h3 class="text-xl font-bold text-slate-800">עריכת כותרת יום</h3>
        <button class="p-2 text-slate-500 hover:text-red-500" id="edit-title-close"><i class="fa-solid fa-xmark"></i></button>
      </div>
      <div class="modal-body p-4">
        <input id="edit-title-input" type="text" class="w-full p-3 border rounded-lg">
      </div>
      <div class="p-4 border-t flex items-center justify-end">
        <button id="edit-title-save" class="px-4 py-2 rounded-lg bg-blue-600 text-white hover:bg-blue-700 font-bold">שמור</button>
      </div>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, where, getDocs, serverTimestamp, deleteDoc
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // --- Firebase Init ---
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // --- State ---
    let currentUser = null;
    const urlParams = new URLSearchParams(location.search);
    const tripId = urlParams.get('tripId');
    const incomingDate = urlParams.get('date'); // dd/mm/yyyy
    let tripData = null;

    let selectedDateStr = null; // dd/mm/yyyy
    let selectedISO = null;     // yyyy-mm-dd
    let selectedDest = null;    // dest object (nameHe, dates, coords, backgroundUrl?)
    let dayDocRef = null;

    // Modals
    const itemModal = qs('#item-modal');
    const aiModal = qs('#ai-modal');
    const validateModal = qs('#validate-modal');
    const editTitleModal = qs('#edit-title-modal');

    // Maps
    let addressMap, addressMarker;
    let routeMap, routeLayer, routeFromMarker, routeToMarker;
    let valAddressMap, valAddressMarker;
    let valRouteMap, valRouteLayer, valFromMarker, valToMarker;

    // Attach caches
    let attachData = { att: [], hotels: [], moves: [] };
    let pickedAttach = null;
    let pickedAttachValidate = null;

    // Editing item
    let editingItemId = null;

    // --- Helpers ---
    function qs(s, el=document){ return el.querySelector(s); }
    function qsa(s, el=document){ return Array.from(el.querySelectorAll(s)); }

    const hebWeekdays = ['ראשון','שני','שלישי','רביעי','חמישי','שישי','שבת'];

    function toISO(dstr){ // dd/mm/yyyy -> yyyy-mm-dd
      const [d,m,y] = dstr.split('/').map(x=>parseInt(x,10));
      return `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
    }
    function toHebLong(dstr){
      const [d,m,y] = dstr.split('/').map(x=>parseInt(x,10));
      const dt = new Date(y, m-1, d);
      const wd = hebWeekdays[dt.getDay()];
      return `יום ${wd} • ${d}.${m}.${y}`;
    }
    function dateInRange(dateStr, rangeStr){ // dd/mm/yyyy inside "dd/mm/yyyy - dd/mm/yyyy"
      if (!rangeStr?.includes(' - ')) return false;
      const [s,e] = rangeStr.split(' - ');
      const d = toDate(dateStr), ds = toDate(s), de = toDate(e);
      return d >= ds && d <= de;
    }
    function toDate(ddmmyyyy){
      const [d,m,y] = ddmmyyyy.split('/').map(Number);
      return new Date(y, m-1, d);
    }

    function haversineKm(a, b){
      const R = 6371;
      const toRad = deg => deg*Math.PI/180;
      const dLat = toRad(b.lat-a.lat), dLng = toRad(b.lng-a.lng);
      const v = Math.sin(dLat/2)**2 + Math.cos(toRad(a.lat))*Math.cos(toRad(b.lat))*Math.sin(dLng/2)**2;
      return 2*R*Math.asin(Math.sqrt(v));
    }

    function show(el){ el.classList.add('show'); }
    function hide(el){ el.classList.remove('show'); }

    function showPanel(id){ qs('#'+id).classList.remove('hidden'); }
    function hidePanel(id){ qs('#'+id).classList.add('hidden'); }

    function msg(el, text){ el.textContent = text || ''; }

    // OSM Autocomplete
    function setupAutocomplete(input){
      const wrap = input.closest('.auto-wrap');
      const menu = wrap.querySelector('.osm-suggestions');
      let aborter = null;

      input.addEventListener('input', async ()=>{
        const q = input.value.trim();
        if (!q){ menu.classList.add('hidden'); menu.innerHTML = ''; return; }
        try{
          if (aborter) aborter.abort();
          aborter = new AbortController();
          const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=8&addressdetails=1&accept-language=he&q=${encodeURIComponent(q)}`,{
            signal: aborter.signal,
            headers: { 'Accept':'application/json' }
          });
          const data = await res.json();
          if (!Array.isArray(data)) return;
          menu.innerHTML = data.map(p=>(
            `<button type="button" class="text-right" data-lat="${p.lat}" data-lon="${p.lon}" data-disp="${escapeHtml(p.display_name)}">
              <div class="font-semibold">${escapeHtml(p.display_name.split(',')[0]||'')}</div>
              <div class="text-xs text-slate-500">${escapeHtml(p.display_name)}</div>
            </button>`
          )).join('');
          menu.classList.remove('hidden');
        }catch(e){}
      });

      input.addEventListener('focus', ()=>{
        if (menu.innerHTML.trim()) menu.classList.remove('hidden');
      });
      document.addEventListener('click', (e)=>{
        if (!wrap.contains(e.target)) menu.classList.add('hidden');
      });

      menu.addEventListener('click', (e)=>{
        const btn = e.target.closest('button');
        if (!btn) return;
        input.value = btn.dataset.disp;
        input.dataset.lat = btn.dataset.lat;
        input.dataset.lng = btn.dataset.lon;
        menu.classList.add('hidden');
        // Fire custom event so the caller can update map/markers
        input.dispatchEvent(new CustomEvent('osm-picked', { detail: { lat: parseFloat(btn.dataset.lat), lng: parseFloat(btn.dataset.lon), text: btn.dataset.disp } }));
      });
    }

    function escapeHtml(str=''){
      return str.replace(/[&<>"']/g, s=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));
    }

    // OSRM simple route
    async function osrmRoute(from, to){
      try{
        const url = `https://router.project-osrm.org/route/v1/driving/${from.lng},${from.lat};${to.lng},${to.lat}?overview=full&geometries=geojson`;
        const res = await fetch(url);
        const data = await res.json();
        if (data?.routes?.[0]){
          const r = data.routes[0];
          return {
            distanceKm: r.distance/1000,
            durationMin: Math.round(r.duration/60),
            geometry: r.geometry
          };
        }
      }catch(e){}
      return null;
    }

    // Firestore paths
    const tripsCol = collection(db, 'trips');

    function schedulesCol(){
      return collection(db, 'trips', tripId, 'schedules');
    }
    function itemsCol(iso){
      return collection(db, 'trips', tripId, 'schedules', iso, 'items');
    }

    // Load
    onAuthStateChanged(auth, async (user)=>{
      if (!user){ location.href = 'login.html'; return; }
      currentUser = user;

      if (!tripId){ alert('לא נמצא tripId'); location.href='index.html'; return; }

      const tripSnap = await getDoc(doc(db, 'trips', tripId));
      if (!tripSnap.exists()){ alert('טיול לא נמצא'); location.href='index.html'; return; }
      tripData = tripSnap.data();

      qs('#trip-caption').textContent = tripData?.name ? `טיול: ${tripData.name}` : '';

      // Build chooser
      buildChooser();

      // Default selection
      if (incomingDate){
        setSelectedByDate(incomingDate);
      }else{
        // fallback first destination first date
        const firstDest = tripData?.destinations?.[0];
        if (firstDest){
          const dates = generateDatesFromRange(firstDest.dates);
          if (dates.length) setSelected(firstDest, dates[0]);
        }
      }

      // Load attach data (best effort from subcollections; fallback to globals with tripId)
      await loadAttachData();

      // Bind UI
      bindUI();
    });

    function bindUI(){
      // back
      qs('#back-btn').addEventListener('click', ()=> history.back());

      // chooser open/close
      const chooserBtn = qs('#choose-day-btn');
      const chooserMenu = qs('#chooser-menu');
      chooserBtn.addEventListener('click', ()=>{
        chooserMenu.classList.toggle('hidden');
      });
      document.addEventListener('click', (e)=>{
        if (!qs('.chooser').contains(e.target)){
          chooserMenu.classList.add('hidden');
        }
      });

      // add item
      qs('#add-item-btn').addEventListener('click', ()=> openItemModal());

      // AI
      qs('#ai-btn').addEventListener('click', ()=> { msg(qs('#ai-msg'), ''); qs('#ai-input').value=''; show(aiModal); });
      qs('#ai-modal-close').addEventListener('click', ()=> hide(aiModal));
      qs('#ai-create').addEventListener('click', createFromAI);

      // Edit day title small
      qs('#edit-day-title-btn').addEventListener('click', ()=>{
        qs('#edit-title-input').value = qs('#day-title-display').textContent || '';
        show(editTitleModal);
      });
      qs('#edit-title-close').addEventListener('click', ()=> hide(editTitleModal));
      qs('#edit-title-save').addEventListener('click', saveEditedDayTitle);

      // Item modal controls
      qs('#item-modal-close').addEventListener('click', ()=> hide(itemModal));
      qs('#toggle-end').addEventListener('click', ()=>{
        const end = qs('#item-end');
        end.classList.toggle('hidden');
      });
      qs('#quick-back-to-hotel').addEventListener('click', quickBackToHotel);
      qs('#save-item').addEventListener('click', saveItemFromModal);

      // Extra buttons
      qsa('.extra-btn').forEach(b=>{
        b.addEventListener('click', ()=>{
          const ex = b.dataset.extra;
          ['address','links','route','attach','summary','remarks'].forEach(id=>hidePanel('panel-'+id));
          showPanel('panel-'+ex);
          if (ex==='address'){ ensureAddressMap(); }
          if (ex==='route'){ ensureRouteMap(); }
          if (ex==='attach'){ renderAttachList('att', qs('#attach-list')); pickedAttach=null; qs('#attach-picked').textContent=''; }
        });
      });

      // Use hotel address
      qs('#use-hotel-address').addEventListener('click', async ()=>{
        const hotel = await findHotelForSelectedDate();
        if (!hotel?.address){ alert('לא נמצאה כתובת מלון ליום זה'); return; }
        const inp = qs('#item-address');
        inp.value = hotel.address;
        delete inp.dataset.lat; delete inp.dataset.lng;
        // try geocode
        geocodeIntoInput(inp, (pt)=>{
          ensureAddressMap();
          addressMap.setView(pt, 16);
          addressMarker.setLatLng(pt);
        });
      });

      // Route hotel shortcuts
      qs('#route-from-hotel').addEventListener('click', async ()=>{
        const hotel = await findHotelForSelectedDate();
        if (!hotel?.address){ alert('לא נמצאה כתובת מלון'); return; }
        const inp = qs('#route-from');
        inp.value = hotel.address;
        delete inp.dataset.lat; delete inp.dataset.lng;
        geocodeIntoInput(inp);
      });

      // Calc route
      qs('#calc-route').addEventListener('click', async ()=>{
        ensureRouteMap();
        const a = inputPoint(qs('#route-from'));
        const b = inputPoint(qs('#route-to'));
        if (!a || !b){ alert('יש לבחור כתובת התחלה ויעד'); return; }
        routeMap.setView([a.lat, a.lng], 13);
        routeFromMarker.setLatLng(a);
        routeToMarker.setLatLng(b);
        if (routeLayer){ routeMap.removeLayer(routeLayer); routeLayer=null; }
        const osrm = await osrmRoute(a,b);
        if (osrm?.geometry){
          routeLayer = L.geoJSON(osrm.geometry, { style:{ color:'#7c3aed', weight:4, opacity:.85 } }).addTo(routeMap);
          qs('#route-info').textContent = `מסלול ~ ${osrm.distanceKm.toFixed(1)} ק״מ • ~${osrm.durationMin} דק׳`;
        }else{
          qs('#route-info').textContent = `מרחק אווירי: ${haversineKm(a,b).toFixed(1)} ק״מ`;
        }
      });

      // Autocomplete hookups (ensure suggestions on top)
      ['#item-address','#route-from','#route-to','#val-address','#val-from','#val-to'].forEach(sel=>{
        const el = qs(sel);
        if (el) {
          setupAutocomplete(el);
          el.addEventListener('osm-picked', (ev)=>{
            const pt = ev.detail;
            if (sel==='#item-address'){ ensureAddressMap(); addressMap.setView(pt,16); addressMarker.setLatLng(pt); }
            if (sel==='#route-from' || sel==='#route-to'){ ensureRouteMap(); }
            if (sel==='#val-address'){ ensureValAddressMap(); valAddressMap.setView(pt,16); valAddressMarker.setLatLng(pt); }
            if (sel==='#val-from' || sel==='#val-to'){ ensureValRouteMap(); }
          });
        }
      });

      // Validation modal
      qs('#validate-close').addEventListener('click', ()=> hide(validateModal));
      qs('#val-save').addEventListener('click', saveValidation);
    }

    function ensureAddressMap(){
      if (!addressMap){
        addressMap = L.map('address-map', { zoomControl:false }).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addressMap);
        addressMarker = L.marker([31.77,35.21]).addTo(addressMap);
      }
    }
    function ensureRouteMap(){
      if (!routeMap){
        routeMap = L.map('route-map', { zoomControl:false }).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
        routeFromMarker = L.marker([31.77,35.21]).addTo(routeMap);
        routeToMarker = L.marker([31.77,35.21]).addTo(routeMap);
      }
    }
    function ensureValAddressMap(){
      if (!valAddressMap){
        valAddressMap = L.map('val-address-map', { zoomControl:false }).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(valAddressMap);
        valAddressMarker = L.marker([31.77,35.21]).addTo(valAddressMap);
      }
    }
    function ensureValRouteMap(){
      if (!valRouteMap){
        valRouteMap = L.map('val-route-map', { zoomControl:false }).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(valRouteMap);
        valFromMarker = L.marker([31.77,35.21]).addTo(valRouteMap);
        valToMarker = L.marker([31.77,35.21]).addTo(valRouteMap);
      }
    }

    function inputPoint(inp){
      const lat = parseFloat(inp.dataset.lat), lng = parseFloat(inp.dataset.lng);
      if (isFinite(lat) && isFinite(lng)) return { lat, lng };
      return null;
    }
    async function geocodeIntoInput(inp, cb){
      const q = inp.value.trim();
      if (!q) return;
      const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&limit=1&addressdetails=1&accept-language=he&q=${encodeURIComponent(q)}`);
      const data = await res.json();
      if (Array.isArray(data) && data[0]){
        inp.dataset.lat = data[0].lat; inp.dataset.lng = data[0].lon;
        if (cb) cb({ lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) });
      }else{
        alert('לא נמצאה הכתובת, נסה לבחור מהרשימה האוטומטית.');
      }
    }

    // Build chooser list
    function buildChooser(){
      const cont = qs('#chooser-list');
      cont.innerHTML = '';
      const label = qs('#choose-day-label');

      if (!tripData?.destinations?.length){
        label.textContent = 'לא נמצאו יעדים';
        return;
      }

      tripData.destinations.forEach(dest=>{
        const dates = generateDatesFromRange(dest.dates);
        if (!dates.length) return;
        const sec = document.createElement('div');
        sec.className = 'mb-2 border rounded-lg overflow-hidden';
        sec.innerHTML = `<div class="px-3 py-2 bg-slate-100 font-bold">${escapeHtml(dest.nameHe)}</div>`;
        dates.forEach(d=>{
          const btn = document.createElement('button');
          btn.className = 'w-full text-right px-3 py-2 hover:bg-slate-50';
          btn.innerHTML = `<div class="font-semibold">${toHebLong(d)}</div><div class="text-xs text-slate-500">${escapeHtml(dest.nameHe)}</div>`;
          btn.addEventListener('click', ()=>{
            setSelected(dest, d);
            qs('#chooser-menu').classList.add('hidden');
          });
          sec.appendChild(btn);
        });
        cont.appendChild(sec);
      });
    }

    function setSelected(dest, dstr){
      selectedDest = dest;
      selectedDateStr = dstr;
      selectedISO = toISO(dstr);
      qs('#choose-day-label').textContent = `${toHebLong(dstr)} — ${dest.nameHe}`;
      qs('#day-header').textContent = `${dest.nameHe} • ${toHebLong(dstr)}`;
      dayDocRef = doc(db, 'trips', tripId, 'schedules', selectedISO);
      loadDay();
    }
    function setSelectedByDate(dstr){
      const dest = tripData.destinations?.find(x=>dateInRange(dstr, x.dates)) || tripData.destinations?.[0];
      if (dest) setSelected(dest, dstr);
    }

    async function loadDay(){
      // ensure day doc exists
      const snap = await getDoc(dayDocRef);
      if (!snap.exists()){
        await setDoc(dayDocRef, {
          date: selectedDateStr,
          iso: selectedISO,
          destNameHe: selectedDest?.nameHe || '',
          dayTitle: ''
        });
      }
      const day = (await getDoc(dayDocRef)).data();
      updateDayHeader(day);

      // Listen items
      const qItems = query(itemsCol(selectedISO), orderBy('start','asc'));
      onSnapshot(qItems, (sp)=>{
        const arr = sp.docs.map(d=> ({id:d.id, ...d.data()} ));
        renderItems(arr, day);
      });
    }

    function updateDayHeader(day){
      const hasTitle = !!(day?.dayTitle);
      const titleSpan = qs('#day-title-display');
      const editBtn = qs('#edit-day-title-btn');
      if (hasTitle){
        titleSpan.textContent = day.dayTitle;
        titleSpan.classList.remove('hidden');
        editBtn.classList.remove('hidden');
      }else{
        titleSpan.classList.add('hidden');
        editBtn.classList.add('hidden');
      }
    }

    async function saveEditedDayTitle(){
      const v = qs('#edit-title-input').value.trim();
      await updateDoc(dayDocRef, { dayTitle: v });
      hide(editTitleModal);
      const day = (await getDoc(dayDocRef)).data();
      updateDayHeader(day);
    }

    // Generate dates from range
    function generateDatesFromRange(rangeStr){
      if (!rangeStr || !rangeStr.includes(' - ')) return [];
      const [startStr, endStr] = rangeStr.split(' - ');
      const [sd, sm, sy] = startStr.split('/').map(Number);
      const [ed, em, ey] = endStr.split('/').map(Number);
      const start = new Date(sy, sm-1, sd);
      const end = new Date(ey, em-1, ed);
      const out = [];
      let cur = new Date(start);
      while (cur <= end){
        out.push(cur.toLocaleDateString('he-IL',{day:'2-digit',month:'2-digit',year:'numeric'}));
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }

    // Add/Edit item modal
    async function openItemModal(item=null){
      editingItemId = item?.id || null;
      msg(qs('#item-modal-msg'),'');
      // Step day title (only if empty)
      const day = (await getDoc(dayDocRef)).data();
      const needTitle = !day?.dayTitle;
      qs('#step-day-title').classList.toggle('hidden', !needTitle);
      if (needTitle) qs('#day-title-input').value='';

      // Clear fields
      qs('#item-title').value = item?.title || '';
      qs('#item-start').value = item?.start || '';
      qs('#item-end').value = item?.end || '';
      qs('#item-end').classList.toggle('hidden', !item?.end);
      qs('#item-notes').value = item?.notes || '';
      qs('#item-website').value = item?.website || '';
      qs('#item-booking').value = item?.booking || '';
      qs('#item-summary').value = item?.summary || '';
      qs('#item-remarks').value = item?.remarks || '';
      // address
      const addr = qs('#item-address');
      addr.value = item?.address?.text || '';
      addr.dataset.lat = item?.address?.lat ?? '';
      addr.dataset.lng = item?.address?.lng ?? '';
      if (addr.value){
        ensureAddressMap();
        const pt = item?.address?.lat ? {lat:item.address.lat, lng:item.address.lng} : null;
        if (pt){ addressMap.setView(pt, 16); addressMarker.setLatLng(pt); }
      }
      // route
      ['#route-from','#route-to'].forEach(sel=>{
        const el = qs(sel);
        const key = sel==='#route-from'?'from':'to';
        el.value = item?.route?.[key]?.text || '';
        el.dataset.lat = item?.route?.[key]?.lat ?? '';
        el.dataset.lng = item?.route?.[key]?.lng ?? '';
      });
      if (item?.route?.from?.lat && item?.route?.to?.lat){
        ensureRouteMap();
        const a = item.route.from, b = item.route.to;
        routeMap.setView([a.lat,a.lng], 13);
        routeFromMarker.setLatLng(a);
        routeToMarker.setLatLng(b);
      }
      // attach
      pickedAttach = item?.attach || null;
      renderAttachList('att', qs('#attach-list'));
      qs('#attach-picked').textContent = pickedAttach ? `נבחר: ${pickedAttach.type} • ${pickedAttach.name}` : '';

      show(itemModal);
      qs('#item-modal-title').textContent = editingItemId ? 'עריכת פריט' : 'הוספת פריט ללוז';
    }

    async function quickBackToHotel(){
      const start = qs('#item-start').value;
      if (!start){ msg(qs('#item-modal-msg'),'צריך לבחור שעת התחלה'); return; }
      const hotel = await findHotelForSelectedDate();
      if (!hotel?.address){ alert('לא נמצאה כתובת מלון ליום זה'); return; }
      // Find previous item to compute distance
      const itemsSnap = await getDocs(query(itemsCol(selectedISO), orderBy('start','asc')));
      const all = itemsSnap.docs.map(d=>({id:d.id,...d.data()}));
      const prev = [...all].filter(x=>x.start && x.start<=start).pop();

      const data = {
        title: 'חזרה למלון',
        start,
        end: '',
        isReturnHotel: true,
        address: hotel.address ? { text: hotel.address, lat: hotel.lat||null, lng: hotel.lng||null } : null,
        createdAt: serverTimestamp(),
        needsValidation: false
      };

      if (prev?.address?.lat && hotel?.lat){
        data.airKmFromPrev = haversineKm({lat:prev.address.lat,lng:prev.address.lng},{lat:hotel.lat,lng:hotel.lng});
      }

      await addDoc(itemsCol(selectedISO), data);
      hide(itemModal);
    }

    async function saveItemFromModal(){
      const err = qs('#item-modal-msg');
      const day = (await getDoc(dayDocRef)).data();
      if (!day?.dayTitle){
        const titleDay = qs('#day-title-input').value.trim();
        if (!titleDay){ msg(err, 'יש למלא כותרת יום'); return; }
        await updateDoc(dayDocRef, { dayTitle: titleDay });
        updateDayHeader((await getDoc(dayDocRef)).data());
      }
      const title = qs('#item-title').value.trim();
      const start = qs('#item-start').value;
      if (!title || !start){ msg(err, 'יש למלא כותרת ושעת התחלה'); return; }

      const end = !qs('#item-end').classList.contains('hidden') ? qs('#item-end').value : '';
      const notes = qs('#item-notes').value.trim();
      const website = qs('#item-website').value.trim();
      const booking = qs('#item-booking').value.trim();
      const summary = qs('#item-summary').value.trim();
      const remarks = qs('#item-remarks').value.trim();

      // address obj
      const addrEl = qs('#item-address');
      const address = addrEl.value ? {
        text: addrEl.value,
        lat: addrEl.dataset.lat ? parseFloat(addrEl.dataset.lat) : null,
        lng: addrEl.dataset.lng ? parseFloat(addrEl.dataset.lng) : null
      } : null;

      // route obj
      const fromEl = qs('#route-from'), toEl = qs('#route-to');
      const route = (fromEl.value || toEl.value) ? {
        from: fromEl.value ? { text: fromEl.value, lat: fromEl.dataset.lat?parseFloat(fromEl.dataset.lat):null, lng: fromEl.dataset.lng?parseFloat(fromEl.dataset.lng):null } : null,
        to: toEl.value ? { text: toEl.value, lat: toEl.dataset.lat?parseFloat(toEl.dataset.lat):null, lng: toEl.dataset.lng?parseFloat(toEl.dataset.lng):null } : null
      } : null;

      // validation need?
      const needsValidation = (!!address && (!address.lat || !address.lng))
        || (!!route && (!route.from?.lat || !route.to?.lat))
        || (!!pickedAttach && !pickedAttach.path); // attach selected must have path

      // compute air distance from prev if possible
      let airKmFromPrev = null;
      try{
        const itemsSnap = await getDocs(query(itemsCol(selectedISO), orderBy('start','asc')));
        const all = itemsSnap.docs.map(d=>({id:d.id,...d.data()}));
        const prev = [...all].filter(x=>x.start && x.start <= start).pop();
        const herePt = address?.lat ? { lat:address.lat, lng:address.lng } : (route?.to?.lat ? {lat:route.to.lat, lng:route.to.lng} : null);
        const prevPt = prev?.address?.lat ? {lat:prev.address.lat, lng:prev.address.lng} : (prev?.route?.to?.lat ? {lat:prev.route.to.lat, lng:prev.route.to.lng} : null);
        if (herePt && prevPt) airKmFromPrev = haversineKm(prevPt, herePt);
      }catch(e){}

      const data = {
        title, start, end, notes, website, booking, summary, remarks,
        address, route,
        attach: pickedAttach || null,
        isReturnHotel: false,
        needsValidation,
        airKmFromPrev,
        createdAt: serverTimestamp()
      };

      if (editingItemId){
        await updateDoc(doc(db, 'trips', tripId, 'schedules', selectedISO, 'items', editingItemId), data);
      }else{
        await addDoc(itemsCol(selectedISO), data);
      }
      hide(itemModal);
    }

    // Render items
    function renderItems(items, day){
      const box = qs('#items-list');
      if (!items.length){
        box.innerHTML = `<div class="card rounded-xl p-6 text-center text-slate-700">
          עדיין אין פריטים ליום זה. לחץ "הוספת לוז" או "יצירת לוז עם AI".
        </div>`;
        return;
      }
      box.innerHTML = items.map(it=>{
        const need = it.needsValidation;
        const badges = [];
        if (it.address?.text) badges.push(`<span class="badge bg-sky-100 text-sky-700"><i class="fa-solid fa-location-dot"></i> כתובת</span>`);
        if (it.route?.from || it.route?.to) badges.push(`<span class="badge bg-purple-100 text-purple-700"><i class="fa-solid fa-route"></i> מסלול</span>`);
        if (it.attach?.name) badges.push(`<span class="badge bg-indigo-100 text-indigo-700"><i class="fa-solid fa-paperclip"></i> צמוד</span>`);
        if (it.isReturnHotel) badges.push(`<span class="badge bg-amber-100 text-amber-700"><i class="fa-solid fa-bed"></i> חזרה למלון</span>`);
        const air = (typeof it.airKmFromPrev==='number') ? `<div class="text-xs text-slate-600 mt-1"><i class="fa-solid fa-plane-up"></i> מרחק אווירי מהפריט הקודם: <b>${it.airKmFromPrev.toFixed(1)} ק״מ</b></div>` : '';
        return `
        <div class="schedule-item card rounded-xl p-4 shadow ${need?'needs-validation':''}" data-id="${it.id}">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1">
              <div class="font-bold text-slate-800 text-lg">${escapeHtml(it.title || 'ללא כותרת')}</div>
              <div class="text-sm muted">${it.start || ''}${it.end?` – ${it.end}`:''}</div>
              ${it.summary?`<div class="text-sm mt-1">${escapeHtml(it.summary)}</div>`:''}
              ${air}
            </div>
            <div class="flex items-center gap-2">
              <button class="open-item px-3 py-1 rounded-md bg-white border hover:bg-slate-50 text-sm">פרטים</button>
              <button class="edit-item p-2 rounded-md hover:bg-slate-100" title="עריכה"><i class="fa-solid fa-pen"></i></button>
              <button class="del-item p-2 rounded-md hover:bg-rose-100 text-rose-600" title="מחיקה"><i class="fa-solid fa-trash"></i></button>
            </div>
          </div>
          <div class="mt-2 flex flex-wrap gap-2">${badges.join(' ')}</div>
        </div>`;
      }).join('');

      // Handlers
      box.querySelectorAll('.edit-item').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.closest('.schedule-item').dataset.id;
          const snap = await getDoc(doc(db, 'trips', tripId, 'schedules', selectedISO, 'items', id));
          if (snap.exists()) openItemModal({ id, ...snap.data() });
        });
      });
      box.querySelectorAll('.del-item').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.closest('.schedule-item').dataset.id;
          if (confirm('למחוק פריט זה?')) await deleteDoc(doc(db, 'trips', tripId, 'schedules', selectedISO, 'items', id));
        });
      });
      box.querySelectorAll('.open-item').forEach(btn=>{
        btn.addEventListener('click', async (e)=>{
          const id = e.currentTarget.closest('.schedule-item').dataset.id;
          openValidateForItem(id, /*viewOnly*/false);
        });
      });
      // Clicking the red card itself opens validate
      box.querySelectorAll('.schedule-item.needs-validation').forEach(card=>{
        card.addEventListener('click', async (e)=>{
          if (e.target.closest('button')) return; // already has handlers
          const id = card.dataset.id;
          openValidateForItem(id, false);
        });
      });
    }

    async function openValidateForItem(id, viewOnly=false){
      // Load item
      const snap = await getDoc(doc(db, 'trips', tripId, 'schedules', selectedISO, 'items', id));
      if (!snap.exists()) return;
      const it = { id, ...snap.data() };
      validateModal.dataset.itemId = id;

      // Reset
      ['val-address-wrap','val-route-wrap','val-attach-wrap'].forEach(id=>hidePanel(id));
      msg(qs('#val-msg'),'');
      pickedAttachValidate = it.attach || null;
      qs('#val-attach-picked').textContent = pickedAttachValidate ? `נבחר: ${pickedAttachValidate.type} • ${pickedAttachValidate.name}` : '';

      const needs = [];
      if ( (it.address?.text && (!it.address.lat || !it.address.lng)) || viewOnly ) {
        showPanel('val-address-wrap');
        const el = qs('#val-address');
        el.value = it.address?.text || '';
        el.dataset.lat = it.address?.lat ?? '';
        el.dataset.lng = it.address?.lng ?? '';
        ensureValAddressMap();
        if (it.address?.lat){ valAddressMap.setView([it.address.lat,it.address.lng],16); valAddressMarker.setLatLng([it.address.lat,it.address.lng]); }
        needs.push('אימות כתובת');
      }
      if ( (it.route && (!it.route.from?.lat || !it.route.to?.lat)) || viewOnly ) {
        showPanel('val-route-wrap');
        const fr = qs('#val-from'), to = qs('#val-to');
        fr.value = it.route?.from?.text || ''; fr.dataset.lat = it.route?.from?.lat ?? ''; fr.dataset.lng = it.route?.from?.lng ?? '';
        to.value = it.route?.to?.text || '';   to.dataset.lat = it.route?.to?.lat ?? '';   to.dataset.lng = it.route?.to?.lng ?? '';
        ensureValRouteMap();
        if (it.route?.from?.lat){ valFromMarker.setLatLng([it.route.from.lat, it.route.from.lng]); valRouteMap.setView([it.route.from.lat,it.route.from.lng],13); }
        if (it.route?.to?.lat){ valToMarker.setLatLng([it.route.to.lat, it.route.to.lng]); }
        needs.push('אימות מסלול');
      }
      if ( (!it.attach || !it.attach.path) || viewOnly ) {
        showPanel('val-attach-wrap');
        renderAttachList('att', qs('#val-attach-list'), true);
        needs.push('שיוך לפריט קיים');
      }

      qs('#validate-need').textContent = viewOnly ? 'פרטי הפריט' : ('נדרש: ' + needs.join(' • '));
      show(validateModal);
    }

    async function saveValidation(){
      const id = validateModal.dataset.itemId;
      const ref = doc(db, 'trips', tripId, 'schedules', selectedISO, 'items', id);
      const snap = await getDoc(ref);
      if (!snap.exists()) return;
      const it = snap.data();

      // collect address/route if shown
      if (!qs('#val-address-wrap').classList.contains('hidden')){
        const el = qs('#val-address');
        if (el.value && (!el.dataset.lat || !el.dataset.lng)) await geocodeIntoInput(el);
        const a = el.value ? { text: el.value, lat: el.dataset.lat?parseFloat(el.dataset.lat):null, lng: el.dataset.lng?parseFloat(el.dataset.lng):null } : null;
        it.address = a;
      }
      if (!qs('#val-route-wrap').classList.contains('hidden')){
        const fr = qs('#val-from'), to = qs('#val-to');
        if (fr.value && (!fr.dataset.lat || !fr.dataset.lng)) await geocodeIntoInput(fr);
        if (to.value && (!to.dataset.lat || !to.dataset.lng)) await geocodeIntoInput(to);
        it.route = {
          from: fr.value?{ text:fr.value, lat: fr.dataset.lat?parseFloat(fr.dataset.lat):null, lng: fr.dataset.lng?parseFloat(fr.dataset.lng):null}:null,
          to:   to.value?{ text:to.value,   lat: to.dataset.lat?parseFloat(to.dataset.lat):null, lng: to.dataset.lng?parseFloat(to.dataset.lng):null}:null
        };
      }
      if (!qs('#val-attach-wrap').classList.contains('hidden')){
        it.attach = pickedAttachValidate || null;
      }

      // recompute needsValidation
      const needsValidation = (!!it.address && (!it.address.lat || !it.address.lng))
        || (!!it.route && (!it.route.from?.lat || !it.route.to?.lat))
        || (!!it.attach && !it.attach.path);

      // recompute air distance from prev if possible
      let airKmFromPrev = it.airKmFromPrev ?? null;
      try{
        const itemsSnap = await getDocs(query(itemsCol(selectedISO), orderBy('start','asc')));
        const all = itemsSnap.docs.map(d=>({id:d.id,...d.data()}));
        const idx = all.findIndex(x=>x.id===id);
        if (idx>-1){
          const prev = all[idx-1];
          const herePt = it.address?.lat ? { lat:it.address.lat, lng:it.address.lng } : (it.route?.to?.lat ? {lat:it.route.to.lat, lng:it.route.to.lng} : null);
          const prevPt = prev?.address?.lat ? {lat:prev.address.lat, lng:prev.address.lng} : (prev?.route?.to?.lat ? {lat:prev.route.to.lat, lng:prev.route.to.lng} : null);
          if (herePt && prevPt) airKmFromPrev = haversineKm(prevPt, herePt);
        }
      }catch(e){}

      await updateDoc(ref, { ...it, needsValidation, airKmFromPrev });
      hide(validateModal);
    }

    // Attach list render (shared)
    function renderAttachList(tab, container, forValidate=false){
      container.innerHTML = '';
      const data = attachData[tab] || [];
      if (!data.length){
        container.innerHTML = `<div class="p-4 text-slate-500">אין נתונים להצגה.</div>`;
        return;
      }
      data.forEach((x)=>{
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-right px-3 py-2 hover:bg-slate-50 border-b last:border-0';
        btn.innerHTML = `<div class="font-semibold">${escapeHtml(x.name)}</div>
          <div class="text-xs text-slate-500">${escapeHtml(x.subtitle||'')}</div>`;
        btn.addEventListener('click', ()=>{
          const picked = { type: x.typeLabel, name: x.name, path: x.path, refId: x.id };
          if (forValidate){
            pickedAttachValidate = picked;
            qs('#val-attach-picked').textContent = `נבחר: ${picked.type} • ${picked.name}`;
          }else{
            pickedAttach = picked;
            qs('#attach-picked').textContent = `נבחר: ${picked.type} • ${picked.name}`;
          }
        });
        container.appendChild(btn);
      });

      // tabs switchers in both attach panels
      container.parentElement.querySelectorAll('.tab-btn').forEach(tb=>{
        tb.onclick = ()=>{
          const t = tb.dataset.tab;
          renderAttachList(t, container, forValidate);
        };
      });
    }

    async function findHotelForSelectedDate(){
      // find logistics hotel covering this date
      const list = await getDocs(collection(db, 'trips', tripId, 'logistics'));
      const all = list.docs.map(d=>({id:d.id, ...d.data()}));
      const hotel = all.find(x=>x.type==='hotel' && dateInRange(selectedDateStr, x.dates));
      if (!hotel) return null;
      // try coords if stored
      return {
        name: hotel.name,
        address: hotel.address || hotel.location || '',
        lat: hotel.coords?.lat || null,
        lng: hotel.coords?.lng || null
      };
    }

    async function loadAttachData(){
      // subcollections under trip preferred
      // attractions:
      const attArr = [];
      try{
        const sub = await getDocs(collection(db, 'trips', tripId, 'attractions'));
        sub.forEach(d=> attArr.push({ id:d.id, typeLabel:'אטרקציה/מסעדה', name:d.data().name, subtitle:d.data().destination||'', path:`trips/${tripId}/attractions/${d.id}` }));
      }catch(e){}
      // fallback global with tripId
      if (!attArr.length){
        try{
          const q1 = query(collection(db,'attractions'), where('tripId','==',tripId));
          const sp = await getDocs(q1);
          sp.forEach(d=> attArr.push({ id:d.id, typeLabel:'אטרקציה/מסעדה', name:d.data().name, subtitle:d.data().destination||'', path:`attractions/${d.id}` }));
        }catch(e){}
      }
      attachData.att = attArr;

      // hotels/moves from logistics
      const hotels=[], moves=[];
      try{
        const lg = await getDocs(collection(db, 'trips', tripId, 'logistics'));
        lg.forEach(d=>{
          const v = d.data();
          if (v.type==='hotel'){
            hotels.push({ id:d.id, typeLabel:'מלון', name: v.name||'מלון', subtitle: v.destination||v.dates||'', path:`trips/${tripId}/logistics/${d.id}` });
          }else if (['flight','car_rental','train','ferry'].includes(v.type)){
            moves.push({ id:d.id, typeLabel:'מעבר', name: v.title || v.type, subtitle: v.dates||v.date||'', path:`trips/${tripId}/logistics/${d.id}` });
          }
        });
      }catch(e){}
      attachData.hotels = hotels;
      attachData.moves = moves;
    }

    // AI parsing
    async function createFromAI(){
      const txt = qs('#ai-input').value || '';
      if (!txt.trim()){ msg(qs('#ai-msg'),'יש להדביק טקסט'); return; }
      msg(qs('#ai-msg'),'יוצר פריטים...');

      // If includes day title (!...!) and day has none, save it
      const daySnap = await getDoc(dayDocRef);
      const day = daySnap.data();
      const mDay = txt.match(/^!([\s\S]*?)!$/m);
      if (!day?.dayTitle && mDay){
        await updateDoc(dayDocRef, { dayTitle: mDay[1].trim() });
        updateDayHeader((await getDoc(dayDocRef)).data());
      }

      // Split into blocks by presence of a title of item: ^״...״
      const blocks = txt.split(/(?=^״[\s\S]+?״$)/m).map(s=>s.trim()).filter(Boolean);

      for (const block of blocks){
        const titleM = block.match(/^״([\s\S]+?)״$/m);
        if (!titleM) continue;
        const title = titleM[1].trim();

        const startM = block.match(/^\/\s*([0-2]\d:[0-5]\d)\s*\/$/m);
        const endM   = block.match(/^\\\s*([0-2]\d:[0-5]\d)\s*\\$/m);
        const notesM = block.match(/^:([\s\S]*?):$/m);
        const addrHotel = /^׳₪$/m.test(block);
        const addrM = block.match(/^׳([\s\S]+?)׳$/m);
        const webM = block.match(/^\?([\s\S]+?)\?$/m);
        const bookM= block.match(/^\$([\s\S]+?)\$$/m);
        const startRouteHotel = /^>\s*׳₪\s*$/m.test(block);
        const endRouteHotel   = /^<\s*׳₪\s*$/m.test(block);
        const startRouteM = block.match(/^>\s*׳([\s\S]+?)׳\s*$/m);
        const endRouteM   = block.match/^<\s*׳([\s\S]+?)׳\s*$/m);
        const attachNeeded = /^\*$/m.test(block);
        const summaryM = block.match(/^•([\s\S]+?)•$/m);
        const remarksM = block.match(/^~([\s\S]+?)~$/m);

        let address = null;
        if (addrHotel){
          const hotel = await findHotelForSelectedDate();
          address = hotel?.address ? { text: hotel.address, lat: hotel.lat||null, lng: hotel.lng||null } : { text:'(כתובת מלון)', lat:null, lng:null };
        }else if (addrM){
          address = { text: addrM[1].trim(), lat:null, lng:null };
        }

        let route = null;
        if (startRouteHotel || startRouteM || endRouteHotel || endRouteM){
          route = {
            from: startRouteHotel ? { text:'(מלון)', lat:null, lng:null } : (startRouteM ? { text: startRouteM[1].trim(), lat:null, lng:null } : null),
            to: endRouteHotel ? { text:'(מלון)', lat:null, lng:null } : (endRouteM ? { text: endRouteM[1].trim(), lat:null, lng:null } : null)
          };
        }

        const attach = attachNeeded ? { type:'(נדרש שיוך)', name:'*', path:null } : null;

        // compute needsValidation
        const needsValidation = (!!address && (!address.lat || !address.lng))
          || (!!route && (!route.from?.text || !route.to?.text))
          || (!!attach && !attach.path);

        // compute air distance from prev (using address/route.to if possible)
        let airKmFromPrev = null;
        try{
          const itemsSnap = await getDocs(query(itemsCol(selectedISO), orderBy('start','asc')));
          const all = itemsSnap.docs.map(d=>({id:d.id,...d.data()}));
          const prev = [...all].filter(x=>x.start && x.start <= (startM?.[1]||'00:00')).pop();
          const herePt = address?.lat ? { lat:address.lat, lng:address.lng } : null; // unknown yet mostly
          if (prev?.address?.lat && herePt){
            airKmFromPrev = haversineKm({lat:prev.address.lat,lng:prev.address.lng}, herePt);
          }
        }catch(e){}

        const data = {
          title,
          start: startM?.[1] || '',
          end: endM?.[1] || '',
          notes: notesM?.[1]?.trim() || '',
          website: webM?.[1]?.trim() || '',
          booking: bookM?.[1]?.trim() || '',
          summary: summaryM?.[1]?.trim() || '',
          remarks: remarksM?.[1]?.trim() || '',
          address, route, attach,
          isReturnHotel: /^₪$/m.test(block),
          needsValidation, airKmFromPrev,
          createdAt: serverTimestamp()
        };
        await addDoc(itemsCol(selectedISO), data);
      }

      hide(aiModal);
    }

    // ---------------------------

    // Attach data loaders are done above

    // ---------------------------

  </script>
</body>
</html>