<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>×™×¦×™×¨×ª/×¢×¨×™×›×ª ×œ×•×´×–</title>

  <!-- UI -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    html, body { height: 100%; }
    html { scrollbar-gutter: stable both-edges; }
    body {
      font-family: 'Assistant', sans-serif;
      min-height: 100dvh;
      overscroll-behavior-y: none;
      -webkit-overflow-scrolling: touch;
      background-color: #f8fafc;
      /* ×× ×™×¢×ª ×’×œ×™×œ×” ××•×¤×§×™×ª */
      max-width: 100vw;
      overflow-x: hidden;
    }
    .bg-fixed {
      background:
        radial-gradient(1200px 800px at 85% -10%, rgba(59,130,246,.2), transparent 70%),
        radial-gradient(900px 700px at 10% 110%, rgba(16,185,129,.2), transparent 70%),
        #f8fafc;
    }
    .sheet { background: rgba(255,255,255,.95); backdrop-filter: blur(8px); border: 1px solid rgba(0,0,0,0.05); }
    .submenu { max-height: 0; overflow: hidden; transition: max-height .4s ease; }
    .submenu.open { max-height: 1000px; }
    
    .modal { display: none; opacity: 0; transition: opacity .2s ease-out; }
    .modal.show { display: flex; opacity: 1; }
    
    .modal-content {
        transform: scale(.95);
        opacity: 0;
        transition: transform .2s ease-out, opacity .2s ease-out;
        max-height: 95vh;
    }
    .modal.show .modal-content { transform: scale(1); opacity: 1; }

    /* Mobile specific modal adjustments */
    @media (max-width: 640px) {
        .modal { padding: 0 !important; align-items: flex-end; }
        .modal-content {
            width: 100%;
            height: 100%;
            max-height: 100dvh;
            border-radius: 0;
            display: flex;
            flex-direction: column;
        }
        /* Make footer sticky at bottom on mobile */
        .modal-content footer {
            margin-top: auto;
            background: white;
            border-top: 1px solid #e2e8f0;
            padding-bottom: max(1rem, env(safe-area-inset-bottom));
        }
    }

    .step { display: none; }
    .step.active { display: block; }

    .typeahead {
      position: fixed; z-index: 99999; background: #fff; border: 1px solid #e5e7eb;
      border-radius: .75rem; max-height: 260px; overflow: auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.1); display: none;
    }
    .typeahead.open { display: block; }
    .typeahead button { width: 100%; text-align: right; padding: .8rem 1rem; line-height: 1.35; white-space: normal; border-bottom: 1px solid #f1f5f9; }
    .typeahead button:hover { background:#f8fafc; }

    .card { 
        transition: transform .15s ease, box-shadow .15s ease; 
        border-right: 4px solid #3b82f6;
        -webkit-user-select: none;
        user-select: none;
    }
    .card:active { transform: scale(0.98); }
    .card:hover { 
        box-shadow: 0 8px 25px rgba(2,6,23,.07); 
    }
    @media (min-width: 640px) {
        .card:hover { transform: translateY(-3px); }
    }
    .card.needs-verify { 
        border-right-color: #ef4444;
        background: #fef2f2;
    }
    
    .chip {
      display: inline-flex; align-items: center; gap:.4rem;
      padding:.35rem .65rem; border-radius: 999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe;
      font-size:.85rem; font-weight: 600;
    }
    .chip .x { cursor: pointer; color:#6366f1; padding: 2px; }

    .badge-verify {
      display:inline-flex; align-items:center; gap:.35rem;
      background:#fee2e2; color:#b91c1c; border:1px solid #fecaca;
      font-size:.75rem; padding:.15rem .5rem; border-radius:999px; font-weight: 600;
    }
    .banner-warn {
      background:#fffbeb; color:#b45309; border:1px solid #fde68a;
      padding:.75rem 1rem; border-radius:.6rem; font-size:.9rem;
    }

    .input-with-btn { display:flex; gap:.5rem; }
    .input-with-btn input { flex:1 1 auto; }
    
    /* Bigger inputs for mobile */
    input, select, textarea {
        font-size: 16px !important; /* Prevents iOS zoom */
    }
    
    .loader {
        width: 1.2rem; height: 1.2rem;
        border: 2px solid currentColor;
        border-right-color: transparent;
        border-radius: 50%;
        display: inline-block;
        animation: spin .7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Help Modal Content Styling */
    .help-content h5 { font-size: 1.1rem; font-weight: 700; color: #1e293b; margin-top: 1rem; margin-bottom: 0.5rem; }
    .help-content p { color: #475569; line-height: 1.6; }
    .help-content .icon { color: #64748b; }

    ._safelist { color: #0000; background: linear-gradient(#fff,#fff); }
    
    .scroll-smooth { -webkit-overflow-scrolling: touch; }
    
    /* Touch target improvements */
    button { touch-action: manipulation; }
  </style>
</head>
<body>

  <!-- Safelist ×‘×œ×ª×™ × ×¨××” -->
  <div class="hidden">
    <div class="bg-red-50 border-red-300 text-red-800"></div>
    <div class="bg-green-50 border-green-300 text-green-800"></div>
    <div class="bg-blue-50 border-blue-300 text-blue-800"></div>
    <div class="bg-yellow-50 border-yellow-300 text-yellow-800"></div>
    <div class="bg-orange-50 border-orange-300 text-orange-800"></div>
  </div>

  <!-- ×¨×§×¢ -->
  <div class="fixed inset-0 -z-10 bg-fixed"></div>

  <!-- Header -->
  <header class="bg-white/90 backdrop-blur-md sticky top-0 z-30 shadow-sm border-b border-slate-100">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <a id="back-to-day" href="#" class="p-3 -ml-2 text-slate-700 hover:text-blue-600 transition-colors" title="×—×–×¨×” ×œ×œ×•×– ×”×™×•××™">
            <i class="fa-solid fa-arrow-right text-lg"></i>
          </a>
          <h1 class="text-xl font-bold text-slate-800">×™×¦×™×¨×ª ×œ×•×´×–</h1>
        </div>
        <div class="flex items-center gap-3">
          <!-- Help Button -->
          <button id="help-btn" class="w-10 h-10 flex items-center justify-center text-slate-600 hover:text-blue-600 bg-slate-50 hover:bg-slate-100 rounded-full transition-colors border border-slate-200" title="×¢×–×¨×”">
            <i class="fa-solid fa-question"></i>
          </button>
          <div id="auth-slot" class="hidden sm:block text-slate-700 text-xs sm:text-sm bg-slate-100 px-3 py-1 rounded-full"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6 pb-24">
    <!-- ×‘×—×™×¨×ª ×ª××¨×™×š/×™×¢×“ + ×›×•×ª×¨×ª ×™×•× -->
    <section class="sheet rounded-2xl p-5 shadow-sm border border-slate-100 space-y-4">
      <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
        <div>
          <h2 class="text-xl sm:text-2xl font-extrabold text-slate-900">×™×•× ×”×¢×‘×•×“×”</h2>
          <p class="text-slate-500 text-sm">×‘×—×¨ ×ª××¨×™×š ×œ×¢×¨×™×›×”</p>
        </div>
        <div class="w-full md:w-[400px]">
          <button id="date-toggle" class="w-full flex items-center justify-between bg-white p-3.5 rounded-xl border border-slate-200 shadow-sm active:bg-slate-50 transition-colors">
            <span id="date-current" class="font-bold text-slate-700">×˜×•×¢×Ÿ...</span>
            <i class="fa-solid fa-chevron-down text-slate-400"></i>
          </button>
          <div id="date-panel" class="submenu bg-white rounded-xl border shadow-xl mt-2 overflow-hidden z-20 relative">
            <div id="date-list" class="max-h-80 overflow-y-auto divide-y"></div>
          </div>
        </div>
      </div>
      <div class="flex items-center flex-wrap gap-2 text-slate-800 bg-slate-50 p-3 rounded-xl border border-slate-100">
        <div id="badge-date" class="px-3 py-1 rounded-full bg-white text-sky-700 border border-sky-100 text-sm font-bold shadow-sm">â€”</div>
        <div class="flex items-center gap-2 flex-1 min-w-0">
          <span class="text-sm text-slate-500 shrink-0">×›×•×ª×¨×ª:</span>
          <strong id="day-title-inline" class="text-slate-800 font-bold truncate">...</strong>
          <button id="edit-day-title-inline" class="hidden w-8 h-8 flex items-center justify-center text-slate-400 hover:text-blue-600 rounded-full hover:bg-white transition-colors" title="×¢×¨×™×›×ª ×›×•×ª×¨×ª"><i class="fa-solid fa-pen"></i></button>
        </div>
      </div>
    </section>

    <!-- ×¤×¨×™×˜×™× + ×›×¤×ª×•×¨×™× -->
    <section class="sheet rounded-2xl p-5 shadow-sm border border-slate-100">
      <div class="flex flex-col gap-4">
        <div class="flex items-center justify-between">
            <h3 class="text-lg font-bold text-slate-900">×œ×•×´×– ×™×•××™</h3>
            <button id="delete-all-btn" class="hidden text-red-500 hover:text-red-700 text-sm font-semibold px-2">
                <i class="fa-solid fa-trash-can"></i> ××—×§ ×”×›×œ
            </button>
        </div>
        
        <div class="grid grid-cols-2 gap-3">
          <button id="add-item-btn" class="flex flex-col items-center justify-center gap-2 p-4 bg-emerald-50 text-emerald-800 border border-emerald-100 hover:bg-emerald-100 rounded-xl transition-colors">
            <div class="w-10 h-10 rounded-full bg-emerald-200 flex items-center justify-center text-emerald-700"><i class="fa-solid fa-plus text-lg"></i></div>
            <span class="font-bold text-sm">×”×•×¡×£ ×™×“× ×™</span>
          </button>
          <button id="ai-build-btn" class="flex flex-col items-center justify-center gap-2 p-4 bg-purple-50 text-purple-800 border border-purple-100 hover:bg-purple-100 rounded-xl transition-colors">
            <div class="w-10 h-10 rounded-full bg-purple-200 flex items-center justify-center text-purple-700"><i class="fa-solid fa-wand-magic-sparkles text-lg"></i></div>
            <span class="font-bold text-sm">×”×•×¡×£ ×¢× AI</span>
          </button>
        </div>
      </div>

      <div id="items-list" class="mt-6 space-y-3">
        <div class="text-slate-400 py-8 text-center bg-slate-50 rounded-xl border border-dashed border-slate-200">
            <i class="fa-regular fa-calendar text-2xl mb-2 opacity-50"></i>
            <div>××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>
        </div>
      </div>

      <!-- ×”×“×’×©×™×/×˜×™×¤×™× -->
      <div class="mt-8 border-t border-slate-100 pt-6">
        <div class="flex items-center justify-between mb-3">
          <h4 class="text-lg font-bold text-slate-800">×“×’×©×™× ×•×˜×™×¤×™×</h4>
          <button id="add-note-btn" class="text-sm font-semibold text-amber-600 bg-amber-50 px-3 py-1.5 rounded-full hover:bg-amber-100 transition-colors">
            <i class="fa-solid fa-plus"></i> ×”×•×¡×£
          </button>
        </div>
        <div id="notes-list" class="grid gap-3">
          <div class="text-slate-400 text-sm">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>
        </div>
      </div>
    </section>
  </main>

  <!-- Help Modal -->
  <div id="help-modal" class="modal fixed inset-0 z-[90] items-center justify-center sm:p-4 bg-black/60">
    <div class="modal-content bg-white sm:rounded-2xl w-full max-w-2xl flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between shrink-0">
        <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-circle-info text-blue-600"></i> ××¨×›×– ×”×¢×–×¨×”</h4>
        <button id="help-close" class="p-2 -mr-2 text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </header>
      <main class="p-5 overflow-y-auto flex-1 help-content scroll-smooth">
        <p class="mb-4 text-lg">×‘×¨×•×š ×”×‘× ×œ×¢××•×“ ×™×¦×™×¨×ª ×•×¢×¨×™×›×ª ×”×œ×•"×–.</p>
        <div class="space-y-6">
            <div>
                <h5><i class="fa-solid fa-calendar-day icon text-blue-500"></i> ×‘×—×™×¨×ª ×ª××¨×™×š</h5>
                <p>×‘×—×œ×§ ×”×¢×œ×™×•×Ÿ, ×‘×—×¨ ××ª ×”×ª××¨×™×š ×•×”×™×¢×“. ×ª×Ÿ ×›×•×ª×¨×ª ×™×•××™×ª ×›×“×™ ×œ×–×›×•×¨ ××ª × ×•×©× ×”×™×•×.</p>
            </div>
            <div>
                <h5><i class="fa-solid fa-plus icon text-emerald-500"></i> ×”×•×¡×¤×ª ×¤×¨×™×˜</h5>
                <p>×”×©×ª××© ×‘×›×¤×ª×•×¨ <strong>"×”×•×¡×£ ×™×“× ×™"</strong> ×›×“×™ ×œ×¤×ª×•×— ××©×£ ×¤×©×•×˜ ×œ×”×•×¡×¤×ª ××˜×¨×§×¦×™×”, ××¡×¢×“×” ××• ×¤×¢×™×œ×•×ª.</p>
            </div>
            <div>
                <h5><i class="fa-solid fa-wand-magic-sparkles icon text-purple-500"></i> ×¢×–×¨×” ×-AI</h5>
                <p>×”×©×ª××© ×‘×›×¤×ª×•×¨ <strong>"×”×•×¡×£ ×¢× AI"</strong> ×›×“×™ ×œ×”×“×‘×™×§ ×œ×•"×– ×©×œ× ×©×™×¦×¨×ª ××•×œ ×”×¦'××˜ ×‘×•×˜ ×©×œ× ×•.</p>
            </div>
            <div>
                <h5><i class="fa-solid fa-triangle-exclamation icon text-red-500"></i> ××™××•×ª</h5>
                <p>×›×¨×˜×™×¡×™×•×ª ×¢× ×¤×¡ ××“×•× ×“×•×¨×©×•×ª ×‘×“×™×§×” (×›×ª×•×‘×ª, ×©×¢×•×ª ××• ×§×™×©×•×¨×™×). ×œ×—×¥ ×¢×œ×™×”×Ÿ ×œ××™××•×ª.</p>
            </div>
        </div>
      </main>
      <footer class="p-4 border-t bg-slate-50 sm:rounded-b-2xl">
          <button class="w-full py-3 bg-slate-800 text-white rounded-xl font-bold" onclick="document.getElementById('help-modal').classList.remove('show')">×”×‘× ×ª×™</button>
      </footer>
    </div>
  </div>

  <!-- Generic Confirmation Modal -->
  <div id="confirm-modal" class="modal fixed inset-0 z-[100] items-center justify-center p-4 bg-black/70">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl overflow-hidden !h-auto !max-h-auto">
      <div class="p-6 text-center">
        <div id="confirm-icon" class="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center mx-auto mb-4">
          <i class="fa-solid fa-triangle-exclamation text-red-600 text-2xl"></i>
        </div>
        <h4 id="confirm-title" class="text-xl font-bold text-slate-800">××™×©×•×¨ ×¤×¢×•×œ×”</h4>
        <p id="confirm-message" class="text-slate-600 mt-2 text-base">×”×× ××ª×” ×‘×˜×•×—?</p>
      </div>
      <div class="p-4 bg-slate-50 flex gap-3">
        <button id="confirm-cancel" class="flex-1 py-3 rounded-xl bg-white border border-slate-200 font-bold text-slate-700 hover:bg-slate-50">×‘×™×˜×•×œ</button>
        <button id="confirm-ok" class="flex-1 py-3 bg-red-600 text-white rounded-xl font-bold shadow-md hover:bg-red-700">××™×©×•×¨</button>
      </div>
    </div>
  </div>

  <!-- Hotel Select Modal -->
  <div id="hotel-select-modal" class="modal fixed inset-0 z-[85] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl !h-auto">
      <div class="p-4 border-b font-bold text-lg">×‘×—×™×¨×ª ××œ×•×Ÿ</div>
      <div class="p-5 space-y-3">
          <p class="text-slate-600">× ××¦××• ××¡×¤×¨ ××œ×•× ×•×ª ×‘×ª××¨×™×š ×–×”. ×‘×—×¨ ××ª ×”××œ×•×Ÿ ×”×¨×¦×•×™:</p>
          <select id="hotel-select-dropdown" class="w-full p-3 border border-slate-300 rounded-xl bg-slate-50 text-base"></select>
      </div>
      <div class="p-4 border-t flex gap-3">
        <button id="hotel-select-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-700">×‘×™×˜×•×œ</button>
        <button id="hotel-select-save" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md">×‘×—×™×¨×”</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ×™×¦×™×¨×ª/×¢×¨×™×›×ª ×¤×¨×™×˜ -->
  <div id="item-modal" class="modal fixed inset-0 z-50 items-center justify-center sm:p-4 bg-black/60">
    <div class="modal-content bg-white sm:rounded-2xl w-full max-w-2xl flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between shrink-0 bg-white z-10">
        <h4 id="modal-title" class="text-lg font-bold">×”×•×¡×¤×ª ×¤×¨×™×˜</h4>
        <button id="close-modal" class="p-2 -mr-2 text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </header>
      
      <main class="p-5 overflow-y-auto flex-1 space-y-6 scroll-smooth bg-white">
        <div id="verify-banner" class="banner-warn hidden flex gap-3 items-start">
          <i class="fa-solid fa-circle-exclamation mt-1"></i>
          <div>×œ×›×¨×˜×™×¡×™×” ×–×• ×“×¨×•×© ××™××•×ª: ×•×“× ×›×ª×•×‘×ª, ××¡×œ×•×œ ××• ×§×™×©×•×¨×™×.</div>
        </div>
        
        <div id="step-A" class="step">
          <label class="block font-bold mb-2 text-slate-700">×›×•×ª×¨×ª ×™×•××™×ª (× ×•×©×)</label>
          <input id="input-day-title" type="text" class="w-full p-3.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none transition-shadow" placeholder="×œ××©×œ: ×™×•× ×¢×™×¨ ×¢×ª×™×§×” ×•×©×•×§">
          <p class="text-sm text-slate-500 mt-2 bg-slate-50 p-2 rounded-lg">× ×•×¢×“ ×œ×ª×ª ××¡×’×¨×ª ×œ×™×•× ×›×•×œ×•. ×× ×›×‘×¨ ×™×© ×›×•×ª×¨×ª, × ×“×œ×’ ×¢×œ ×–×”.</p>
        </div>
        
        <div id="step-B" class="step">
          <label class="block font-bold mb-2 text-slate-700">×©× ×”×¤×¢×™×œ×•×ª / ×”××§×•×</label>
          <input id="input-item-title" type="text" class="w-full p-3.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="×œ××©×œ: ××•×–×™××•×Ÿ ×”×œ×•×‘×¨">
        </div>
        
        <div id="step-C" class="step">
          <div class="flex items-center justify-between mb-2">
            <label class="block font-bold text-slate-700">×–×× ×™×</label>
            <button id="add-back-to-hotel" class="text-sm font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-lg hover:bg-blue-100">+ ×—×–×¨×” ×œ××œ×•×Ÿ</button>
          </div>
          <div class="space-y-4">
            <div>
              <label class="text-sm text-slate-500 block mb-1">×©×¢×ª ×”×ª×—×œ×”</label>
              <input id="input-start" type="time" class="w-full p-3.5 border border-slate-300 rounded-xl bg-slate-50" />
            </div>
            
            <div id="end-wrap" class="hidden">
              <label class="text-sm text-slate-500 block mb-1">×©×¢×ª ×¡×™×•× (××•×¤×¦×™×•× ×œ×™)</label>
              <input id="input-end" type="time" class="w-full p-3.5 border border-slate-300 rounded-xl bg-slate-50" />
            </div>
            
            <button id="toggle-end" type="button" class="w-full p-3 border border-slate-200 rounded-xl text-slate-600 hover:bg-slate-50 font-medium">
                <i class="fa-regular fa-clock"></i> ×”×•×¡×£/×”×¡×¨ ×©×¢×ª ×¡×™×•×
            </button>
          </div>
        </div>
        
        <div id="step-D" class="step">
          <label class="block font-bold mb-2 text-slate-700">×ª×™××•×¨ ×—×•×¤×©×™</label>
          <textarea id="input-desc" rows="5" class="w-full p-3.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="×¤×™×¨×•×˜ ×¢×œ ×”×¤×¢×™×œ×•×ª, ××” ×¢×•×©×™× ×©×?"></textarea>
        </div>
        
        <div id="step-E" class="step space-y-4">
          <h5 class="font-bold text-lg text-slate-800">××™×“×¢ × ×•×¡×£</h5>
          <div class="flex flex-wrap gap-2">
            <button data-open="#block-address" class="open-block px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-medium shadow-sm active:bg-slate-100">ğŸ“ ×›×ª×•×‘×ª</button>
            <button data-open="#block-links"   class="open-block px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-medium shadow-sm active:bg-slate-100">ğŸ”— ×§×™×©×•×¨×™×</button>
            <button data-open="#block-route"   class="open-block px-4 py-2 rounded-xl border border-slate-200 bg-white text-slate-700 font-medium shadow-sm active:bg-slate-100">ğŸš— ×“×¨×›×™ ×”×’×¢×”</button>
            <button data-open="#block-connect" class="open-block px-4 py-2 rounded-xl border border-purple-200 bg-purple-50 text-purple-700 font-medium shadow-sm active:bg-purple-100">âœ¨ ××˜×¨×§×¦×™×•×ª ×•××œ×•× ×•×ª</button>
          </div>
          
          <div id="block-address" class="hidden border border-slate-200 rounded-2xl p-4 bg-slate-50 space-y-3">
            <div class="flex items-center justify-between">
              <label class="font-bold text-slate-700">×›×ª×•×‘×ª</label>
              <button id="use-hotel-address" class="text-xs font-bold text-blue-600 bg-blue-100 px-2 py-1 rounded-lg">×”×©×ª××© ×‘×›×ª×•×‘×ª ×”××œ×•×Ÿ</button>
            </div>
            <div class="relative input-with-btn">
              <input id="addr-input" type="text" class="w-full p-3 border rounded-xl" placeholder="×—×¤×© ×›×ª×•×‘×ª...">
              <button id="addr-search-btn" type="button" class="px-4 bg-white border rounded-xl shadow-sm text-slate-600">
                <i class="fa-solid fa-magnifying-glass"></i>
              </button>
            </div>
            <div id="addr-map" class="w-full h-56 rounded-xl border border-slate-200 bg-white z-0"></div>
          </div>
          
          <div id="block-links" class="hidden border border-slate-200 rounded-2xl p-4 bg-slate-50 space-y-3">
            <div>
                <label class="block mb-1 font-bold text-sm text-slate-700">××ª×¨ ××™× ×˜×¨× ×˜</label>
                <input id="link-general" type="url" class="w-full p-3 border rounded-xl bg-white" placeholder="https://...">
            </div>
            <div>
                <label class="block mb-1 font-bold text-sm text-slate-700">×”×–×× ×ª ×›×¨×˜×™×¡×™×</label>
                <input id="link-book" type="url" class="w-full p-3 border rounded-xl bg-white" placeholder="https://...">
            </div>
          </div>
          
          <div id="block-route" class="hidden border border-slate-200 rounded-2xl p-4 bg-slate-50 space-y-3">
            <div class="grid gap-3">
              <div class="relative">
                <label class="text-xs font-bold text-slate-500 mb-1 block">×××™×¤×” ×™×•×¦××™×?</label>
                <div class="input-with-btn">
                  <input id="route-from" class="w-full p-3 border rounded-xl bg-white" placeholder="××•×¦×">
                  <button id="route-from-search" type="button" class="px-3 bg-white border rounded-xl"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
              </div>
              <div class="relative">
                <label class="text-xs font-bold text-slate-500 mb-1 block">×œ××Ÿ ××’×™×¢×™×?</label>
                <div class="input-with-btn">
                  <input id="route-to" class="w-full p-3 border rounded-xl bg-white" placeholder="×™×¢×“">
                  <button id="route-to-search" type="button" class="px-3 bg-white border rounded-xl"><i class="fa-solid fa-magnifying-glass"></i></button>
                </div>
              </div>
            </div>
            <div class="flex items-center gap-2 mt-2 bg-white p-2 rounded-xl border">
              <select id="route-mode" class="p-2 bg-transparent font-bold text-slate-700 outline-none">
                <option value="foot">ğŸš¶ ×”×œ×™×›×”</option>
                <option value="driving" selected>ğŸš— × ×”×™×’×”</option>
              </select>
              <div class="h-4 w-px bg-slate-300 mx-1"></div>
              <button id="route-calc" class="text-blue-600 font-bold text-sm px-2">×—×™×©×•×‘</button>
              <div id="route-time" class="text-sm text-slate-700 mr-auto font-mono"></div>
            </div>
            <div id="route-map" class="w-full h-56 rounded-xl border border-slate-200 bg-white z-0"></div>
          </div>
          
          <div id="block-connect" class="hidden border border-slate-200 rounded-2xl p-4 bg-slate-50">
            <div class="mb-3 p-3 bg-white rounded-xl border min-h-[50px]">
              <div class="text-xs text-slate-400 mb-1">× ×‘×—×¨×•:</div>
              <div id="selected-refs" class="flex flex-wrap gap-2"></div>
            </div>
            <p class="text-sm text-slate-600 mb-3 px-1">×¡××Ÿ ×œ××˜×” ××§×•××•×ª ×©×§×©×•×¨×™× ×œ×¤×¨×™×˜ ×–×”:</p>
            <div id="connect-lists" class="grid gap-3"></div>
          </div>
        </div>
        
        <div id="step-F" class="step">
          <label class="block font-bold mb-2 text-slate-700">×ª×§×¦×™×¨ (××•×¤×™×¢ ×‘×›×¨×˜×™×¡)</label>
          <input id="input-summary" type="text" class="w-full p-3.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none" placeholder="×œ××©×œ: ×¡×™×•×¨ ×§×¦×¨ ×©×œ ×©×¢×”">
        </div>
        
        <div id="step-G" class="step">
          <label class="block font-bold mb-2 text-slate-700">×”×¢×¨×•×ª ×•×“×’×©×™×</label>
          <textarea id="input-notes" rows="4" class="w-full p-3.5 border border-slate-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:outline-none bg-amber-50 border-amber-200 placeholder-amber-700/50 text-amber-900" placeholder="×“×‘×¨×™× ×©××¡×•×¨ ×œ×©×›×•×—..."></textarea>
        </div>
      </main>
      
      <footer class="p-4 border-t shrink-0 flex items-center gap-3 bg-white z-10">
        <button id="prev-step" class="px-5 py-3 rounded-xl border border-slate-200 font-bold text-slate-600 hover:bg-slate-50 disabled:opacity-50">××—×•×¨×”</button>
        <div class="text-xs text-slate-400 flex-1 text-center font-mono" id="step-indicator">1/7</div>
        <button id="next-step" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md hover:bg-blue-700 active:scale-95 transition-transform">×”××©×š</button>
        <button id="save-item" class="hidden flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-md hover:bg-emerald-700 active:scale-95 transition-transform">×©××•×¨ ×¡×™×•×</button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ×¢×¨×™×›×ª ×›×•×ª×¨×ª ×™×•× -->
  <div id="title-modal" class="modal fixed inset-0 z-50 items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-sm shadow-xl !h-auto">
      <div class="p-4 border-b font-bold text-lg">×¢×¨×™×›×ª ×›×•×ª×¨×ª</div>
      <div class="p-5">
        <input id="title-edit-input" class="w-full p-3.5 border border-slate-300 rounded-xl" placeholder="×ª×Ÿ ×›×•×ª×¨×ª ×œ×™×•× ×–×”">
      </div>
      <div class="p-4 border-t flex gap-3">
        <button id="title-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-700">×‘×™×˜×•×œ</button>
        <button id="title-save" class="flex-1 py-3 bg-blue-600 text-white rounded-xl font-bold shadow-md">×©××•×¨</button>
      </div>
    </div>
  </div>

  <!-- MODAL: ×¦×¤×™×™×” ××œ××” ×‘×¤×¨×™×˜ -->
  <div id="view-modal" class="modal fixed inset-0 z-[60] items-center justify-center sm:p-4 bg-black/60">
    <div class="modal-content bg-white sm:rounded-2xl w-full max-w-2xl flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between shrink-0 bg-white z-10">
        <h4 id="view-title" class="text-lg font-bold break-words text-slate-800 pr-2 leading-tight">...</h4>
        <button id="view-close" class="p-2 -mr-2 text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </header>
      <main class="p-5 overflow-y-auto space-y-5 scroll-smooth bg-white flex-1">
        <div id="view-time" class="text-slate-500 font-bold text-lg flex items-center gap-2"></div>
        
        <div id="view-summary" class="text-slate-800 font-medium break-words bg-slate-50 p-3 rounded-xl border border-slate-100"></div>
        
        <div id="view-desc" class="text-slate-600 whitespace-pre-line break-words leading-relaxed text-base"></div>
        
        <div id="view-address" class="text-blue-600 font-semibold flex items-start gap-2"></div>
        
        <div id="view-links" class="flex flex-wrap gap-2 py-2"></div>
        
        <div id="view-map" class="w-full h-64 rounded-2xl border border-slate-200 bg-slate-50 z-0"></div>
      </main>
      <footer class="p-4 border-t shrink-0 flex flex-col gap-3 bg-white z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.03)]">
        <div class="flex gap-3 w-full">
          <a id="nav-waze"   target="_blank" class="flex-1 justify-center items-center gap-2 px-3 py-3 rounded-xl bg-[#33ccff] text-white font-bold shadow-sm hidden flex"><i class="fa-brands fa-waze text-xl"></i> Waze</a>
          <a id="nav-gmaps"  target="_blank" class="flex-1 justify-center items-center gap-2 px-3 py-3 rounded-xl bg-[#4285F4] text-white font-bold shadow-sm hidden flex"><i class="fa-solid fa-location-dot"></i> Maps</a>
        </div>
        <div class="flex gap-3 w-full border-t border-slate-100 pt-3">
          <button id="view-verify" class="flex-1 justify-center items-center gap-2 px-3 py-3 rounded-xl bg-red-50 text-red-600 font-bold border border-red-100 hidden flex"><i class="fa-solid fa-check-double"></i> ×××ª</button>
          <button id="view-edit"   class="flex-1 justify-center items-center gap-2 px-3 py-3 rounded-xl bg-amber-50 text-amber-700 font-bold border border-amber-100 flex"><i class="fa-solid fa-pen"></i> ×¢×¨×•×š</button>
          <button id="view-delete" class="px-4 py-3 rounded-xl bg-slate-50 text-slate-400 hover:text-red-500 hover:bg-red-50 border border-slate-100 flex"><i class="fa-solid fa-trash"></i></button>
        </div>
      </footer>
    </div>
  </div>

  <!-- MODAL: AI ×”×“×‘×§×”/×¤×¨×™×¡×”/×™×¦×™×¨×” -->
  <div id="ai-modal" class="modal fixed inset-0 z-[70] items-center justify-center sm:p-4 bg-black/60">
    <div class="modal-content bg-white sm:rounded-2xl w-full max-w-3xl flex flex-col shadow-xl relative">
      <div id="ai-loader-overlay" class="hidden absolute inset-0 bg-white/90 backdrop-blur-sm z-50 flex flex-col items-center justify-center gap-4 rounded-2xl">
          <div class="loader text-purple-600 w-10 h-10 border-4"></div>
          <p class="font-bold text-slate-700 text-lg">AI ×‘×•× ×” ×œ×š ×œ×•"×–...</p>
      </div>
      <header class="p-4 border-b flex items-center justify-between shrink-0">
        <h4 class="text-lg font-bold"><i class="fa-solid fa-wand-magic-sparkles text-purple-600"></i> ×™×¦×™×¨×ª ×œ×•×– ×¢× AI</h4>
        <button id="ai-close" class="p-2 -mr-2 text-slate-500 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </header>
      <main class="p-5 overflow-y-auto space-y-6 scroll-smooth flex-1">
        <div class="bg-gradient-to-br from-purple-50 to-white border border-purple-100 rounded-xl p-4 text-sm text-slate-700 space-y-3 shadow-sm">
            <h5 class="font-bold text-purple-900 text-base">××™×š ×–×” ×¢×•×‘×“?</h5>
            <ol class="list-decimal list-inside space-y-2 marker:text-purple-500">
                <li>×œ×—×¥ <strong>"×“×‘×¨ ×¢× AI"</strong> ×›×“×™ ×œ×§×‘×œ ×ª×•×›× ×™×ª.</li>
                <li>×”×¢×ª×§ ××ª ×”×˜×§×¡×˜ ×©×§×™×‘×œ×ª ×•×”×“×‘×§ ×›××Ÿ.</li>
                <li>×œ×—×¥ <strong>"×¤×¨×•×¡"</strong> ×œ×‘×“×™×§×” ×•××– <strong>"×¦×•×¨ ×œ×•×–"</strong>.</li>
            </ol>
            <a href="https://chatgpt.com/g/g-6899d3d888d08191b96ce2ccbb43372b-h-vzr-hkhkm-lv-z-tyvl-bqlvt"
               target="_blank"
               class="inline-flex items-center gap-2 px-4 py-2 mt-2 rounded-xl bg-purple-600 text-white font-bold shadow-md hover:bg-purple-700 transition-colors w-full sm:w-auto justify-center">
              <i class="fa-solid fa-robot"></i> ×“×‘×¨ ×¢× AI
            </a>
        </div>
        
        <div class="space-y-2">
          <label class="font-bold text-slate-700">×”×“×‘×§ ×›××Ÿ ××ª ×”×˜×§×¡×˜:</label>
          <textarea id="ai-input" rows="8" class="w-full p-4 border border-slate-300 rounded-xl text-sm font-mono leading-relaxed focus:ring-2 focus:ring-purple-500 focus:outline-none" placeholder="×”×“×‘×§ ×›××Ÿ ××ª ×”×˜×§×¡×˜ ×¢× ×”×¡×™××•× ×™× ( ! ×´ / \ â‚ª : ×³ ×³â‚ª ? $ > < * â€¢ ~ )"></textarea>
        </div>
        
        <div id="ai-preview" class="hidden bg-slate-50 p-4 rounded-xl border border-slate-200">
          <div class="font-bold mb-3 text-slate-800 border-b pb-2">×ª×¦×•×’×” ××§×“×™××”:</div>
          <div id="ai-preview-content" class="space-y-2 text-sm max-h-60 overflow-y-auto"></div>
        </div>
      </main>
      <footer class="p-4 border-t flex gap-3 bg-white shrink-0">
          <button id="ai-parse" class="flex-1 py-3 rounded-xl border border-slate-300 font-bold text-slate-700 hover:bg-slate-50">×¤×¨×•×¡ (Preview)</button>
          <button id="ai-create" class="flex-1 py-3 rounded-xl bg-purple-600 text-white font-bold shadow-md hover:bg-purple-700 disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2" disabled>
            <span class="loader hidden w-4 h-4 border-2"></span>
            <span class="btn-text">×¦×•×¨ ×œ×•×–</span>
          </button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ××™××•×ª ×›×ª×•×‘×ª/××¡×œ×•×œ/×§×™×©×•×¨×™× -->
  <div id="verify-modal" class="modal fixed inset-0 z-[75] items-center justify-center sm:p-4 bg-black/60">
    <div class="modal-content bg-white sm:rounded-2xl w-full max-w-3xl flex flex-col shadow-xl">
      <header class="p-4 border-b flex items-center justify-between shrink-0 bg-white">
        <div class="min-w-0 pr-2">
            <h4 class="text-lg font-bold text-slate-800 flex items-center gap-2"><i class="fa-solid fa-triangle-exclamation text-red-600"></i> ××™××•×ª</h4>
            <div id="v-title" class="text-sm text-slate-500 truncate">...</div>
        </div>
        <button id="v-close" class="p-2 -mr-2 text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </header>
      <main class="p-5 overflow-y-auto space-y-6 scroll-smooth bg-white flex-1">
        <div class="bg-orange-50 text-orange-800 p-3 rounded-xl text-sm border border-orange-100 font-medium">
            ×”×©×œ× ××ª ×”×¤×¨×˜×™× ×”×—×¡×¨×™× ×”××¡×•×× ×™× ×‘××“×•×.
        </div>
        
        <section id="v-block-address" class="hidden border border-red-200 rounded-2xl p-4 bg-red-50/30 space-y-3">
          <div class="flex items-center justify-between">
            <label class="font-bold text-red-800">××™××•×ª ×›×ª×•×‘×ª</label>
            <button id="v-use-hotel" class="text-xs font-bold text-blue-600 bg-white border px-2 py-1 rounded-lg">×”×©×ª××© ×‘×›×ª×•×‘×ª ×”××œ×•×Ÿ</button>
          </div>
          <div class="input-with-btn">
            <input id="v-addr-input" type="text" class="w-full p-3 border rounded-xl" placeholder="×”×§×œ×“ ×›×ª×•×‘×ª">
            <button id="v-addr-search" type="button" class="px-3 bg-white border rounded-xl"><i class="fa-solid fa-magnifying-glass"></i></button>
          </div>
          <div id="v-addr-map" class="w-full h-52 rounded-xl bg-white border z-0"></div>
        </section>
        
        <section id="v-block-route" class="hidden border border-red-200 rounded-2xl p-4 bg-red-50/30 space-y-3">
          <label class="font-bold text-red-800 block mb-2">××™××•×ª ××¡×œ×•×œ</label>
          <div class="grid gap-3">
            <input id="v-route-from" class="w-full p-3 border rounded-xl" placeholder="××•×¦×">
            <input id="v-route-to" class="w-full p-3 border rounded-xl" placeholder="×™×¢×“">
          </div>
          <div class="flex items-center gap-3 mt-2">
            <select id="v-route-mode" class="p-2 border rounded-xl bg-white text-base">
              <option value="foot">×”×œ×™×›×”</option>
              <option value="driving" selected>× ×”×™×’×”</option>
            </select>
            <button id="v-route-calc" class="px-4 py-2 bg-slate-800 text-white rounded-xl text-sm font-bold">×—×©×‘</button>
            <div id="v-route-time" class="text-sm font-bold"></div>
          </div>
          <div id="v-route-map" class="w-full h-52 rounded-xl bg-white border z-0"></div>
        </section>
        
        <section id="v-block-refs" class="hidden border border-red-200 rounded-2xl p-4 bg-red-50/30 space-y-3">
          <label class="font-bold text-red-800 block">××™××•×ª ×§×™×©×•×¨×™×</label>
          <div class="bg-white p-3 rounded-xl border">
            <div id="v-selected-refs" class="flex flex-wrap gap-2 min-h-[30px]"></div>
          </div>
          <div id="v-connect-lists" class="grid gap-3"></div>
        </section>
      </main>
      <footer class="p-4 border-t shrink-0 flex gap-3 bg-white z-10 shadow-[0_-5px_15px_rgba(0,0,0,0.03)]">
        <button id="v-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-700">×‘×™×˜×•×œ</button>
        <button id="v-save" class="flex-1 py-3 bg-emerald-600 text-white rounded-xl font-bold shadow-md hover:bg-emerald-700">×©××•×¨ ××™××•×ª</button>
      </footer>
    </div>
  </div>

  <!-- MODAL: ×“×’×©/×˜×™×¤ -->
  <div id="note-modal" class="modal fixed inset-0 z-[80] items-center justify-center p-4 bg-black/60">
    <div class="modal-content bg-white rounded-2xl w-full max-w-xl flex flex-col shadow-xl !h-auto">
      <header class="p-4 border-b flex items-center justify-between shrink-0">
        <h4 id="note-modal-title" class="text-lg font-bold">×”×•×¡×¤×ª ×“×’×©/×˜×™×¤</h4>
        <button id="note-close" class="p-2 -mr-2 text-slate-400 hover:text-red-500"><i class="fa-solid fa-xmark text-xl"></i></button>
      </header>
      <main class="p-5 overflow-y-auto space-y-4">
        <div>
          <label class="block font-bold mb-1 text-slate-700">×›×•×ª×¨×ª</label>
          <input id="note-title" type="text" class="w-full p-3.5 border border-slate-300 rounded-xl" placeholder="×›×•×ª×¨×ª ×§×¦×¨×”">
        </div>
        <div>
          <label class="block font-bold mb-1 text-slate-700">×¡×•×’</label>
          <select id="note-kind" class="w-full p-3.5 border border-slate-300 rounded-xl bg-white">
            <option value="×“×’×©">×“×’×©</option>
            <option value="×˜×™×¤">×˜×™×¤</option>
          </select>
        </div>
        <div>
          <label class="block font-bold mb-1 text-slate-700">×¤×™×¨×•×˜</label>
          <textarea id="note-details" rows="4" class="w-full p-3.5 border border-slate-300 rounded-xl" placeholder="×¤×™×¨×•×˜ ××¤×•×¨×˜..."></textarea>
        </div>
        <div>
          <label class="block font-bold mb-2 text-slate-700">×¦×‘×¢ ×¨×§×¢</label>
          <div class="grid grid-cols-5 gap-2">
            <button data-color="red"    class="note-color aspect-square rounded-xl border border-red-200 bg-red-50 hover:bg-red-100"></button>
            <button data-color="green"  class="note-color aspect-square rounded-xl border border-green-200 bg-green-50 hover:bg-green-100"></button>
            <button data-color="blue"   class="note-color aspect-square rounded-xl border border-blue-200 bg-blue-50 hover:bg-blue-100"></button>
            <button data-color="yellow" class="note-color aspect-square rounded-xl border border-yellow-200 bg-yellow-50 hover:bg-yellow-100"></button>
            <button data-color="orange" class="note-color aspect-square rounded-xl border border-orange-200 bg-orange-50 hover:bg-orange-100"></button>
          </div>
          <input id="note-color" type="hidden" value="yellow">
        </div>
      </main>
      <footer class="p-4 border-t flex gap-3">
        <button id="note-cancel" class="flex-1 py-3 rounded-xl border border-slate-200 font-bold text-slate-700">×‘×™×˜×•×œ</button>
        <button id="note-save" class="flex-1 py-3 bg-amber-600 text-white rounded-xl font-bold shadow-md">×©××™×¨×”</button>
      </footer>
    </div>
  </div>

  <!-- ×ª×™×‘×ª ×”×¦×¢×•×ª ×›×œ×œ×™×ª -->
  <div id="global-typeahead" class="typeahead"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import {
      getFirestore, doc, getDoc, setDoc, addDoc, updateDoc,
      collection, getDocs, onSnapshot, serverTimestamp, orderBy, query, deleteDoc,
      writeBatch,
      enableIndexedDbPersistence,
      enableMultiTabIndexedDbPersistence,
      where
    } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    enableIndexedDbPersistence(db).catch((err) => {
      if (err.code === 'failed-precondition') {
        console.warn('IndexedDB persistence failed-precondition. Falling back to multi-tabâ€¦', err);
        enableMultiTabIndexedDbPersistence(db).catch(e => console.warn('Multi-tab persistence error:', e));
      } else if (err.code === 'unimplemented') {
        console.warn('Browser does not support IndexedDB persistence.');
      } else {
        console.warn('Persistence error:', err);
      }
    });

    const p = new URLSearchParams(location.search);
    const tripId = p.get('tripId') || p.get('id'); // Allow 'id' as well
    const urlDate = p.get('date');
    if (!tripId) { alert('×—×¡×¨ tripId'); location.href='index.html'; }

    // DOM Refs
    const helpBtn = document.getElementById('help-btn');
    const helpModal = document.getElementById('help-modal');
    const helpClose = document.getElementById('help-close');

    const deleteAllBtn = document.getElementById('delete-all-btn');
    const confirmModal = document.getElementById('confirm-modal');
    const confirmTitle = document.getElementById('confirm-title');
    const confirmMessage = document.getElementById('confirm-message');
    const confirmOk = document.getElementById('confirm-ok');
    const confirmCancel = document.getElementById('confirm-cancel');

    const hotelSelectModal = document.getElementById('hotel-select-modal');
    const hotelSelectDropdown = document.getElementById('hotel-select-dropdown');
    const hotelSelectSave = document.getElementById('hotel-select-save');
    const hotelSelectCancel = document.getElementById('hotel-select-cancel');
    let hotelSelectCallback = null;
    
    const authSlot = document.getElementById('auth-slot');

    const dateToggle = document.getElementById('date-toggle');
    const datePanel  = document.getElementById('date-panel');
    const dateCurrent= document.getElementById('date-current');
    const dateList   = document.getElementById('date-list');
    const badgeDate  = document.getElementById('badge-date');
    const backToDay  = document.getElementById('back-to-day');

    const dayTitleInline = document.getElementById('day-title-inline');
    const editDayTitleInline = document.getElementById('edit-day-title-inline');

    const itemsList     = document.getElementById('items-list');
    const addItemBtn    = document.getElementById('add-item-btn');
    const aiBuildBtn    = document.getElementById('ai-build-btn');

    const notesList     = document.getElementById('notes-list');
    const addNoteBtn    = document.getElementById('add-note-btn');

    const itemModal    = document.getElementById('item-modal');
    const modalTitle   = document.getElementById('modal-title');
    const closeModal   = document.getElementById('close-modal');
    const prevStepBtn  = document.getElementById('prev-step');
    const nextStepBtn  = document.getElementById('next-step');
    const saveBtn       = document.getElementById('save-item');
    const stepIndicator= document.getElementById('step-indicator');
    const verifyBanner = document.getElementById('verify-banner');

    const stepA = document.getElementById('step-A');
    const stepB = document.getElementById('step-B');
    const stepC = document.getElementById('step-C');
    const stepD = document.getElementById('step-D');
    const stepE = document.getElementById('step-E');
    const stepF = document.getElementById('step-F');
    const stepG = document.getElementById('step-G');

    const inputDayTitle = document.getElementById('input-day-title');
    const inputItemTitle= document.getElementById('input-item-title');
    const inputStart    = document.getElementById('input-start');
    const inputEnd      = document.getElementById('input-end');
    const toggleEnd     = document.getElementById('toggle-end');
    const endWrap       = document.getElementById('end-wrap');
    const addBackHotel  = document.getElementById('add-back-to-hotel');
    const inputDesc     = document.getElementById('input-desc');
    const inputSummary  = document.getElementById('input-summary');
    const inputNotes    = document.getElementById('input-notes');

    const openBlockBtns = document.querySelectorAll('.open-block');
    const addrInput   = document.getElementById('addr-input');
    const addrMapDiv  = document.getElementById('addr-map');
    const addrSearchBtn = document.getElementById('addr-search-btn');
    const useHotelBtn = document.getElementById('use-hotel-address');
    let addrMap=null, addrMarker=null;

    const linkGeneral = document.getElementById('link-general');
    const linkBook    = document.getElementById('link-book');

    const rFrom       = document.getElementById('route-from');
    const rTo         = document.getElementById('route-to');
    const rMode       = document.getElementById('route-mode');
    const rCalc       = document.getElementById('route-calc');
    const rFromSearch = document.getElementById('route-from-search');
    const rToSearch   = document.getElementById('route-to-search');
    const rTime       = document.getElementById('route-time');
    const rMapDiv     = document.getElementById('route-map');
    let routeMap=null, routeLayer=null, routeMarkers=[];

    const connectLists = document.getElementById('connect-lists');
    const selectedRefsWrap = document.getElementById('selected-refs');
    let selectedRefs = [];

    const titleModal = document.getElementById('title-modal');
    const titleInput = document.getElementById('title-edit-input');
    const titleSave  = document.getElementById('title-save');
    const titleCancel= document.getElementById('title-cancel');

    const viewModal   = document.getElementById('view-modal');
    const viewClose   = document.getElementById('view-close');
    const viewTitle   = document.getElementById('view-title');
    const viewTime    = document.getElementById('view-time');
    const viewSummary = document.getElementById('view-summary');
    const viewDesc    = document.getElementById('view-desc');
    const viewAddress = document.getElementById('view-address');
    const viewLinks   = document.getElementById('view-links');
    const viewMapDiv  = document.getElementById('view-map');
    const navWaze     = document.getElementById('nav-waze');
    const navGmaps    = document.getElementById('nav-gmaps');
    const viewEditBtn = document.getElementById('view-edit');
    const viewDelBtn  = document.getElementById('view-delete');
    const viewVerifyBtn = document.getElementById('view-verify');
    let viewMap=null, viewMarker=null, viewingItem=null;

    const vModal = document.getElementById('verify-modal');
    const vTitle = document.getElementById('v-title');
    const vClose = document.getElementById('v-close');
    const vCancel= document.getElementById('v-cancel');
    const vSave  = document.getElementById('v-save');

    const vBlockAddr = document.getElementById('v-block-address');
    const vUseHotel  = document.getElementById('v-use-hotel');
    const vAddrInput = document.getElementById('v-addr-input');
    const vAddrSearch= document.getElementById('v-addr-search');
    const vAddrMapDiv= document.getElementById('v-addr-map');
    let vAddrMap=null, vAddrMarker=null;

    const vBlockRoute = document.getElementById('v-block-route');
    const vRouteFrom  = document.getElementById('v-route-from');
    const vRouteTo    = document.getElementById('v-route-to');
    const vRouteFromSearch = document.getElementById('v-route-from-search');
    const vRouteToSearch   = document.getElementById('v-route-to-search');
    const vRouteMode  = document.getElementById('v-route-mode');
    const vRouteCalc  = document.getElementById('v-route-calc');
    const vRouteTime  = document.getElementById('v-route-time');
    const vRouteMapDiv= document.getElementById('v-route-map');
    let vRouteMap=null, vRouteLayer=null, vRouteMarkers=[];

    const vBlockRefs  = document.getElementById('v-block-refs');
    const vSelectedRefsWrap = document.getElementById('v-selected-refs');
    const vConnectLists = document.getElementById('v-connect-lists');
    let vSelectedRefs = [];
    let vCurrentItem = null;

    const globalTA = document.getElementById('global-typeahead');
    let taActiveInput = null;
    let taOutsideHandler = null;
    let taScrollHandler = null;

    const aiModal   = document.getElementById('ai-modal');
    const aiInput   = document.getElementById('ai-input');
    const aiParse   = document.getElementById('ai-parse');
    const aiCreate  = document.getElementById('ai-create');
    const aiPreview = document.getElementById('ai-preview');
    const aiPreviewContent = document.getElementById('ai-preview-content');
    const aiClose   = document.getElementById('ai-close');
    const aiLoaderOverlay = document.getElementById('ai-loader-overlay');

    const noteModal = document.getElementById('note-modal');
    const noteClose = document.getElementById('note-close');
    const noteCancel= document.getElementById('note-cancel');
    const noteSave  = document.getElementById('note-save');
    const noteTitle = document.getElementById('note-title');
    const noteKind  = document.getElementById('note-kind');
    const noteDetails = document.getElementById('note-details');
    const noteColorHidden = document.getElementById('note-color');
    const noteModalTitle = document.getElementById('note-modal-title');
    const noteColorBtns = document.querySelectorAll('.note-color');
    let pickedNoteColor = 'yellow';
    let editingNoteId = null;

    let user=null, tripData=null;
    let selectedDate = null; 
    let selectedDestName = null; 
    let dayDocId=null, dayDocRef=null;
    let dayTitle=null;

    let items=[], notes=[];
    let itemsUnsub = null, notesUnsub = null;
    let currentStepIndex=0;
    const stepsOrder = ['A','B','C','D','E','F','G'];
    let editingItemId = null;
    let requiresRefsFlag = false;

    const pad2 = n => (''+n).padStart(2,'0');
    const toISOFromDDMMYYYY = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${y}-${pad2(m)}-${pad2(d)}`; };
    const toDisplayDotted = (s)=>{ const [d,m,y]=s.split('/').map(Number); return `${d}.${m}.${y}`; };
    const weekdayHe = (s)=>{ const [d,m,y]=s.split('/').map(Number); const dt=new Date(y,m-1,d); const w=dt.toLocaleDateString('he-IL',{weekday:'long'}); return w.startsWith('×™×•×')?w:`×™×•× ${w}`; };
    const minutesFromHHMM = (hhmm)=>{ const [h,m]=(hhmm||'00:00').split(':').map(Number); return h*60+m; };
    const haversineMeters = (a,b) => { const R=6371000, t=x=>x*Math.PI/180; const dLa=t(b.lat-a.lat), dLo=t(b.lng-a.lng); const s1=Math.sin(dLa/2)**2 + Math.cos(t(a.lat))*Math.cos(t(b.lat))*Math.sin(dLo/2)**2; return 2*R*Math.asin(Math.sqrt(s1)); };

    const colorMap = {
      red:     {bg:'bg-red-50',    border:'border-red-300',    text:'text-red-800'},
      green:   {bg:'bg-green-50',  border:'border-green-300',  text:'text-green-800'},
      blue:    {bg:'bg-blue-50',   border:'border-blue-300',   text:'text-blue-800'},
      yellow:  {bg:'bg-yellow-50', border:'border-yellow-300', text:'text-yellow-800'},
      orange:  {bg:'bg-orange-50', border:'border-orange-300', text:'text-orange-800'},
    };
    
    // Confirmation Modal Logic
    let confirmResolve = null;
    function showConfirm({ title, message, confirmText = '××™×©×•×¨' }) {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmOk.textContent = confirmText;
        confirmModal.classList.add('show');
        return new Promise(resolve => {
            confirmResolve = resolve;
        });
    }
    confirmOk.addEventListener('click', () => {
        if (confirmResolve) confirmResolve(true);
        confirmModal.classList.remove('show');
    });
    confirmCancel.addEventListener('click', () => {
        if (confirmResolve) confirmResolve(false);
        confirmModal.classList.remove('show');
    });

    // ×”×ª×—×‘×¨×•×ª + ×˜×¢×™× ×ª ×˜×™×•×œ
    onAuthStateChanged(auth, async (u)=>{
      if (!u){ location.href='login.html'; return; }
      user=u;

      if (authSlot) {
        authSlot.textContent = u.email || '';
      }

      const tSnap = await getDoc(doc(db,'trips',tripId));
      if (!tSnap.exists()){ alert('×˜×™×•×œ ×œ× × ××¦×'); location.href='index.html'; return; }
      tripData=tSnap.data();
      
      const editors = tripData.editors || [];
      if (!Array.isArray(editors) || !editors.includes(user.uid)) {
          alert('××™×Ÿ ×œ×š ×”×¨×©××” ×œ×¢×¨×•×š ××ª ×”×˜×™×•×œ ×”×–×”.');
          location.href = 'index.html';
          return;
      }

      buildDateSelector();

      let initialDate = urlDate;
      let initialDestName = null;

      if (initialDate) {
        const destForDate = tripData.destinations?.find(d => expandRange(d.dates).includes(initialDate));
        if (destForDate) {
          initialDestName = destForDate.nameHe;
        }
      }

      if (!initialDate || !initialDestName) {
        const firstDest = tripData.destinations?.[0];
        initialDate = firstDest?.dates?.split(' - ')?.[0];
        initialDestName = firstDest?.nameHe;
      }

      if (initialDate && initialDestName) {
        await setWorkingDate(initialDate, initialDestName);
      } else {
        dateCurrent.textContent = '×œ× × ××¦××• ×ª××¨×™×›×™× ×‘×˜×™×•×œ.';
        console.error("Could not determine an initial date and destination for the trip.");
      }
    });

    function renderItems(){
      if (!items.length){
        itemsList.innerHTML = `<div class="text-slate-400 py-8 text-center bg-slate-50 rounded-xl border border-dashed border-slate-200">
            <i class="fa-regular fa-calendar text-2xl mb-2 opacity-50"></i>
            <div>××™×Ÿ ×¤×¨×™×˜×™× ×¢×“×™×™×Ÿ.</div>
        </div>`;
        deleteAllBtn.classList.add('hidden');
        return;
      }
      deleteAllBtn.classList.remove('hidden');
      itemsList.innerHTML = items.map(it=>{
        const time = `${it.startTime || ''}${it.endTime ? ' â€“ ' + it.endTime : ''}`;
        const dist = (it.distanceFromPreviousMeters!=null)
          ? `<span class="text-xs text-slate-500 bg-slate-50 px-2 py-0.5 rounded-md border border-slate-100">ğŸ“ ${(it.distanceFromPreviousMeters/1000).toFixed(2)} ×§×´×</span>` : '';
        const addr = it.address?.label ? `<div class="text-sm text-slate-500 mt-2 flex items-start gap-1.5"><i class="fa-solid fa-location-dot mt-1 text-slate-400"></i> <span class="break-words">${it.address.label}</span></div>` : '';
        const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
        const needsTxt = [
          it.needsVerifyAddress?'×›×ª×•×‘×ª':null,
          it.needsVerifyRoute?'××¡×œ×•×œ':null,
          it.needsVerifyRefs?'×§×™×©×•×¨':null
        ].filter(Boolean).join(' / ');
        
        return `<button class="card w-full text-right bg-white rounded-2xl border shadow-sm p-4 relative overflow-hidden ${needs?'needs-verify':''}" data-id="${it.id}">
          <div class="flex flex-col gap-1">
             <div class="flex justify-between items-start pl-1">
                <span class="font-bold text-sm text-blue-600 bg-blue-50 px-2 py-0.5 rounded-lg border border-blue-100">${time || '×œ×œ× ×©×¢×”'}</span>
                ${dist}
             </div>
             
             <div class="font-extrabold text-lg text-slate-800 leading-snug break-words whitespace-normal mt-1 ${needs?'text-red-800':''}">${it.title || '(×œ×œ× ×›×•×ª×¨×ª)'}</div>
             
             ${it.summary ? `<div class="text-slate-600 text-sm leading-relaxed whitespace-normal break-words mt-1">${it.summary}</div>`:''}
             ${addr}
          </div>
          
          ${needs?`<div class="mt-3 pt-3 border-t border-red-100">
            <span class="badge-verify"><i class="fa-solid fa-circle-exclamation"></i> ×“×¨×•×© ××™××•×ª${needsTxt?': '+needsTxt:''}</span>
          </div>`:''}
        </button>`;
      }).join('');

      itemsList.querySelectorAll('button[data-id]').forEach(b=>{
        b.addEventListener('click',()=>{
          const it = items.find(x=>x.id===b.dataset.id);
          if (!it) return;
          if (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs) openVerifyModal(it);
          else openViewModal(it.id);
        });
      });
    }

    async function openViewModal(id){
      const it = items.find(x=>x.id===id);
      if (!it) return;
      viewingItem = it;
      viewTitle.textContent = it.title || '(×œ×œ× ×›×•×ª×¨×ª)';
      viewTime.innerHTML  = `<i class="fa-regular fa-clock"></i> ` + ([it.startTime, it.endTime?('â€” '+it.endTime):''].filter(Boolean).join(' ') || '×œ× ×¦×•×™× ×” ×©×¢×”');
      viewSummary.textContent = it.summary || '××™×Ÿ ×ª×§×¦×™×¨';
      viewSummary.classList.toggle('hidden', !it.summary);
      viewDesc.textContent = it.description || '';
      viewDesc.classList.toggle('hidden', !it.description);

      let refsHtml='';
      if (Array.isArray(it.refs) && it.refs.length){
        refsHtml = it.refs.map(r=>{
          const page = r.page === 'places' ? 'attractions' : (r.page === 'summary' ? 'summary' : 'attractions');
          const openType = r.type === 'logistics' ? 'logistics' : 'place';
          const href = `${page}.html?id=${tripId}&open=${openType}&id=${r.id}`;
          return `<a class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-indigo-50 text-indigo-700 font-bold border border-indigo-100 hover:bg-indigo-100 transition-colors" target="_blank" href="${href}">${iconForRef(r)} ${r.label}</a>`;
        }).join(' ');
      }
      viewLinks.innerHTML = [
        it.links?.site ? `<a class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-slate-100 text-slate-700 font-bold border border-slate-200 hover:bg-slate-200 transition-colors" target="_blank" href="${it.links.site}"><i class="fa-solid fa-link"></i> ××ª×¨</a>` : '',
        it.links?.booking ? `<a class="inline-flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-50 text-emerald-700 font-bold border border-emerald-100 hover:bg-emerald-100 transition-colors" target="_blank" href="${it.links.booking}"><i class="fa-solid fa-ticket"></i> ×”×–×× ×”</a>` : '',
        refsHtml
      ].filter(Boolean).join(' ');

      if (it.address?.label){
        viewAddress.innerHTML = `<i class="fa-solid fa-location-dot mt-1 text-blue-500"></i> <span class="break-words text-slate-800 font-normal">${it.address.label}</span>`;
        navWaze.href  = `https://waze.com/ul?q=${encodeURIComponent(it.address.label)}`;
        navGmaps.href = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(it.address.label)}`;
        navWaze.classList.remove('hidden'); navWaze.classList.add('flex');
        navGmaps.classList.remove('hidden'); navGmaps.classList.add('flex');
      } else {
        viewAddress.innerHTML = '<span class="text-slate-400 font-normal">×œ× ×¦×•×™× ×” ×›×ª×•×‘×ª</span>';
        navWaze.classList.add('hidden'); navWaze.classList.remove('flex');
        navGmaps.classList.add('hidden'); navGmaps.classList.remove('flex');
      }

      setTimeout(()=>{
        if (!viewMap){
          viewMap = L.map(viewMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(viewMap);
        }
        if (viewMarker){ viewMap.removeLayer(viewMarker); viewMarker=null; }
        if (it.address?.lat){
          viewMarker = L.marker([it.address.lat,it.address.lng]).addTo(viewMap);
          viewMap.setView([it.address.lat,it.address.lng], 15);
        }
        viewMap.invalidateSize();
      },120);

      const needs = (it.needsVerifyAddress || it.needsVerifyRoute || it.needsVerifyRefs);
      viewVerifyBtn.classList.toggle('hidden', !needs);
      viewVerifyBtn.classList.toggle('flex', !!needs);
      
      viewVerifyBtn.onclick = ()=>{ viewModal.classList.remove('show'); openVerifyModal(it); };
      viewEditBtn.onclick = ()=>{ viewModal.classList.remove('show'); openItemModal(it); };
      
      // ××—×™×§×ª ×¤×¨×™×˜ ×‘×•×“×“
      viewDelBtn.onclick  = async ()=>{
        const confirmed = await showConfirm({
            title: '××—×™×§×ª ×¤×¨×™×˜',
            message: `×”×× ×œ××—×•×§ ××ª ×”×¤×¨×™×˜ "${it.title}"? ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ×”×¤×¢×•×œ×”.`
        });
        if (confirmed) {
            viewModal.classList.remove('show');
            await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',it.id));
            await recomputeDistances();
        }
      };

      viewModal.classList.add('show');
    }

    // Help modal
    helpBtn.addEventListener('click', () => helpModal.classList.add('show'));
    helpClose.addEventListener('click', () => helpModal.classList.remove('show'));

    // ××—×™×§×ª ×›×œ ×”×¤×¨×™×˜×™× ×©×œ ×”×™×•×
    deleteAllBtn.addEventListener('click', async () => {
        const confirmed = await showConfirm({
            title: '××—×™×§×ª ×›×œ ×”×¤×¨×™×˜×™×',
            message: `×”×× ×œ××—×•×§ ××ª ×›×œ ${items.length} ×”×¤×¨×™×˜×™× ××™×•× ×–×”? ×œ× × ×™×ª×Ÿ ×œ×©×—×–×¨ ××ª ×”×¤×¢×•×œ×”.`
        });
        if (confirmed) {
            const batch = writeBatch(db);
            const itemsCollectionRef = collection(db, 'trips', tripId, 'schedules', dayDocId, 'items');
            const querySnapshot = await getDocs(itemsCollectionRef);
            querySnapshot.forEach(dref => {
                batch.delete(dref.ref);
            });
            await batch.commit();
            // ××™×Ÿ ×¦×•×¨×š ×‘×—×™×©×•×‘ ××¨×—×§×™× ××—×“×© - ××™×Ÿ ×¤×¨×™×˜×™×
        }
    });
    
    // ×‘×•× ×” ×¨×©×™××ª ×ª××¨×™×›×™×/×™×¢×“×™× ×œ×‘×—×™×¨×”
    function buildDateSelector(){
      dateList.innerHTML='';
      dateCurrent.textContent='×‘×—×¨ ×ª××¨×™×š...';
      tripData.destinations?.forEach(dest=>{
        const dates = expandRange(dest.dates);
        const wrap = document.createElement('div');
        wrap.className='p-3 bg-slate-50';
        wrap.innerHTML=`<div class="font-bold text-slate-800 mb-2 px-2 text-sm uppercase tracking-wide opacity-70">${dest.nameHe}</div>`;
        dates.forEach(d=>{
          const wd=weekdayHe(d);
          const btn=document.createElement('button');
          btn.className='w-full text-right p-3 rounded-xl hover:bg-white border border-transparent hover:border-slate-200 transition-all mb-1 font-medium text-slate-700 flex justify-between items-center group';
          btn.innerHTML=`<span>${wd} â€¢ ${toDisplayDotted(d)}</span> <i class="fa-solid fa-chevron-left text-slate-300 group-hover:text-blue-500 opacity-0 group-hover:opacity-100 transition-all"></i>`;
          btn.addEventListener('click', async ()=>{
            await setWorkingDate(d, dest.nameHe);
            datePanel.classList.remove('open');
          });
          wrap.appendChild(btn);
        });
        dateList.appendChild(wrap);
      });
      dateToggle.addEventListener('click', ()=> datePanel.classList.toggle('open'));
    }

    function expandRange(r){
      if (!r?.includes(' - ')) return r ? [r] : [];
      const [s,e]=r.split(' - ');
      const [sd,sm,sy]=s.split('/').map(Number);
      const [ed,em,ey]=e.split('/').map(Number);
      const start=new Date(sy,sm-1,sd), end=new Date(ey,em-1,ed);
      const out=[]; let cur=new Date(start);
      while(cur<=end){
        out.push(`${pad2(cur.getDate())}/${pad2(cur.getMonth()+1)}/${cur.getFullYear()}`);
        cur.setDate(cur.getDate()+1);
      }
      return out;
    }

    // ×‘×—×™×¨×ª ×™×•× ×¢×‘×•×“×” (×ª××¨×™×š+×™×¢×“) ×•×©×™×•×š ××¡××š Firestore
    async function setWorkingDate(ddmmyyyy, destName){
      if (!ddmmyyyy || !destName) {
        console.error("setWorkingDate called with invalid arguments", {ddmmyyyy, destName});
        return;
      }
      
      selectedDate = ddmmyyyy;
      selectedDestName = destName;

      const iso = toISOFromDDMMYYYY(ddmmyyyy);
      dayDocId = `${iso}_${destName}`; 
      dayDocRef = doc(db, 'trips', tripId, 'schedules', dayDocId);

      dateCurrent.innerHTML = `<div class="flex flex-col leading-tight"><span class="text-xs text-slate-400 font-normal">×ª××¨×™×š × ×‘×—×¨</span><span class="text-slate-800 text-lg">${toDisplayDotted(ddmmyyyy)}</span></div>`;
      badgeDate.textContent   = `${weekdayHe(ddmmyyyy)} â€¢ ${toDisplayDotted(ddmmyyyy)}`;

      const snap = await getDoc(dayDocRef);
      if (snap.exists()) {
        dayTitle = snap.data().title || null;
      } else {
        dayTitle = null;
        await setDoc(dayDocRef, { title: null, date: ddmmyyyy, destination: destName }, { merge: true });
      }

      reflectDayTitleUI();
      backToDay.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(selectedDate)}`;
      resubscribeDayStreams();
    }
    
    function reflectDayTitleUI(){
      dayTitleInline.textContent = dayTitle || '...';
      dayTitleInline.className = dayTitle ? 'text-blue-700 font-bold break-words whitespace-normal' : 'text-slate-300 font-normal italic';
      if (!dayTitle) dayTitleInline.textContent = '×œ× ×”×•×’×“×¨×” ×›×•×ª×¨×ª';
      
      editDayTitleInline.classList.remove('hidden');
    }
    
    function resubscribeDayStreams(){
      if (itemsUnsub) { itemsUnsub(); itemsUnsub=null; }
      if (notesUnsub) { notesUnsub(); notesUnsub=null; }

      if (!dayDocId) {
          console.warn("No dayDocId set, cannot subscribe to streams.");
          itemsList.innerHTML = `<div class="text-slate-500 p-6 text-center">× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“.</div>`;
          notesList.innerHTML = `<div class="text-slate-500">× × ×œ×‘×—×•×¨ ×ª××¨×™×š ×•×™×¢×“.</div>`;
          return;
      }

      const qItems = query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc'));
      itemsUnsub = onSnapshot(qItems, (snap)=>{
        items = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderItems();
      });
      const qNotes = query(collection(db,'trips',tripId,'schedules',dayDocId,'notes'), orderBy('createdAt','asc'));
      notesUnsub = onSnapshot(qNotes, (snap)=>{
        notes = snap.docs.map(d=>({id:d.id,...d.data()}));
        renderNotes();
      });
    }

    editDayTitleInline.addEventListener('click', ()=>{
      titleInput.value = dayTitle || '';
      noteModalTitle.textContent = '×¢×¨×™×›×ª ×›×•×ª×¨×ª ×œ×™×•×'; // ×œ× ×—×•×‘×” ××‘×œ ×©×™×”×™×” ×¢×§×‘×™
      titleModal.classList.add('show');
    });
    titleCancel.addEventListener('click', ()=> titleModal.classList.remove('show'));
    titleSave.addEventListener('click', async ()=>{
      const t=(titleInput.value||'').trim();
      await setDoc(dayDocRef,{title: t || null, updatedAt: serverTimestamp()},{merge:true});
      dayTitle = t || null;
      reflectDayTitleUI();
      titleModal.classList.remove('show');
    });

    function classesForColor(c){
      const m = colorMap[c] || colorMap.yellow;
      return `${m.bg} ${m.border} ${m.text}`;
    }

    function renderNotes(){
      if (!notes.length){
        notesList.innerHTML = `<div class="text-slate-400 text-sm italic p-2">××™×Ÿ ×¢×“×™×™×Ÿ ×“×’×©×™×/×˜×™×¤×™×.</div>`;
        return;
      }
      notesList.innerHTML = notes.map(n=>{
        const cls = classesForColor(n.color);
        const titleSafe = (n.title || 'â€”').replace(/"/g, '&quot;');
        return `<div class="border rounded-2xl p-4 ${cls} relative group">
          <div class="flex items-start justify-between gap-3">
            <div class="flex-1 min-w-0">
                <div class="font-bold break-words whitespace-normal text-base mb-1">${n.kind}: ${n.title || 'â€”'}</div>
                <div class="text-sm whitespace-normal break-words leading-relaxed opacity-90">${(n.details||'').replace(/\n/g,'<br>')}</div>
            </div>
            <div class="flex flex-col gap-2 shrink-0">
               <button class="w-8 h-8 rounded-full bg-white/60 hover:bg-white flex items-center justify-center note-edit shadow-sm border border-transparent hover:border-black/10 transition-all" data-id="${n.id}"><i class="fa-solid fa-pen text-xs"></i></button>
               <button class="w-8 h-8 rounded-full bg-white/60 hover:bg-white flex items-center justify-center note-del shadow-sm border border-transparent hover:border-red-200 text-red-500 hover:text-red-700 transition-all" data-id="${n.id}" data-title="${titleSafe}"><i class="fa-solid fa-trash text-xs"></i></button>
            </div>
          </div>
        </div>`;
      }).join('');

      notesList.querySelectorAll('.note-edit').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const n = notes.find(x=>x.id===btn.dataset.id);
          if (!n) return;
          openNoteModal(n);
        });
      });
      notesList.querySelectorAll('.note-del').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
            const noteTitle = btn.dataset.title;
            const confirmed = await showConfirm({
                title: '××—×™×§×ª ×“×’×©/×˜×™×¤',
                message: `×”×× ×œ××—×•×§ ××ª ×”×“×’×©/×˜×™×¤ "${noteTitle}"?`
            });
            if (confirmed) {
                await deleteDoc(doc(db,'trips',tripId,'schedules',dayDocId,'notes',btn.dataset.id));
            }
        });
      });
    }

    function openNoteModal(n=null){
      editingNoteId = n?.id || null;
      noteModalTitle.textContent = editingNoteId ? '×¢×¨×™×›×ª ×“×’×©/×˜×™×¤' : '×”×•×¡×¤×ª ×“×’×©/×˜×™×¤';
      noteTitle.value = n?.title || '';
      noteKind.value = n?.kind || '×“×’×©';
      noteDetails.value = n?.details || '';
      pickedNoteColor = n?.color || 'yellow';
      noteColorHidden.value = pickedNoteColor;

      // ×¡×™××•×Ÿ ×”×¦×‘×¢ ×©× ×‘×—×¨ (×˜×‘×¢×•×ª highlight)
      noteColorBtns.forEach(btn=>{
        btn.classList.remove('ring-4','ring-offset-2','ring-slate-300');
        if (btn.dataset.color === pickedNoteColor){
          btn.classList.add('ring-4','ring-offset-2','ring-slate-300');
        }
      });

      noteModal.classList.add('show');
    }

    // ×©×™× ×•×™ ×¦×‘×¢ ×‘×“×’×©
    noteColorBtns.forEach(btn=>{
      btn.addEventListener('click', ()=>{
        pickedNoteColor = btn.dataset.color;
        noteColorHidden.value = pickedNoteColor;
        noteColorBtns.forEach(b=>b.classList.remove('ring-4','ring-offset-2','ring-slate-300'));
        btn.classList.add('ring-4','ring-offset-2','ring-slate-300');
      });
    });

    // ×¤×ª×™×—×ª ××•×“×œ ×”×•×¡×¤×ª ×“×’×©
    addNoteBtn.addEventListener('click', ()=> {
      openNoteModal(null);
    });

    // ×¡×’×™×¨×ª ××•×“×œ ×“×’×©
    noteClose.addEventListener('click', ()=> noteModal.classList.remove('show'));
    noteCancel.addEventListener('click', ()=> noteModal.classList.remove('show'));

    // ×©××™×¨×ª ×“×’×©
    noteSave.addEventListener('click', async ()=>{
      const payload = {
        title: (noteTitle.value||'').trim(),
        kind: noteKind.value || '×“×’×©',
        details: (noteDetails.value||'').trim(),
        color: pickedNoteColor || 'yellow',
        updatedAt: serverTimestamp()
      };
      if (editingNoteId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'notes',editingNoteId), payload);
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'notes'), {
          ...payload,
          createdAt: serverTimestamp()
        });
      }
      editingNoteId = null;
      noteModal.classList.remove('show');
    });

    function showStep(code){
      [stepA,stepB,stepC,stepD,stepE,stepF,stepG].forEach(s=>s.classList.remove('active'));
      const idx = stepsOrder.indexOf(code);
      currentStepIndex = Math.max(0, idx);
      document.getElementById('step-'+code).classList.add('active');
      stepIndicator.textContent = `${currentStepIndex+1} / ${stepsOrder.length}`;
      saveBtn.classList.toggle('hidden', code!=='G');
      nextStepBtn.classList.toggle('hidden', code==='G');
      prevStepBtn.disabled = (code=== (dayTitle ? 'B' : 'A'));
      if(prevStepBtn.disabled) prevStepBtn.classList.add('opacity-50'); else prevStepBtn.classList.remove('opacity-50');
    }

    nextStepBtn.addEventListener('click', async ()=>{
      const cur = stepsOrder[currentStepIndex];
      if (cur==='A'){
        const t=(inputDayTitle.value||'').trim();
        await setDoc(dayDocRef,{ title: t || null, updatedAt: serverTimestamp() },{merge:true});
        dayTitle = t || null;
        reflectDayTitleUI();
      }
      showStep(stepsOrder[currentStepIndex+1]);
    });
    prevStepBtn.addEventListener('click', ()=> showStep(stepsOrder[currentStepIndex-1]));
    toggleEnd.addEventListener('click', ()=> endWrap.classList.toggle('hidden'));

    // ===== Typeahead helpers =====
    function placeTypeaheadBelow(inputEl){
      const r = inputEl.getBoundingClientRect();
      Object.assign(globalTA.style, { left: r.left+'px', top: (r.bottom+6)+'px', width: r.width+'px' });
    }
    function showTypeaheadFor(inputEl, items){
      taActiveInput = inputEl;
      globalTA.innerHTML = items.map(r=>`<button data-lat="${r.lat}" data-lon="${r.lon}">${r.display_name}</button>`).join('');
      [...globalTA.querySelectorAll('button')].forEach(b=>{
        b.addEventListener('click', ()=>{
          const picked = { lat: parseFloat(b.dataset.lat), lng: parseFloat(b.dataset.lon), label: b.textContent };
          taActiveInput.dispatchEvent(new CustomEvent('typeahead:pick',{detail:picked}));
          hideTypeahead();
        }, {once:true});
      });
      placeTypeaheadBelow(inputEl);
      globalTA.classList.add('open');
      if (!taOutsideHandler){
        taOutsideHandler = (e)=>{ if (e.target!==globalTA && e.target!==taActiveInput && !globalTA.contains(e.target)) hideTypeahead(); };
        document.addEventListener('mousedown', taOutsideHandler);
        document.addEventListener('keydown', (ev)=>{ if(ev.key==='Escape') hideTypeahead(); }, {once:true});
      }
      if (!taScrollHandler){
        taScrollHandler = ()=>{ if (taActiveInput) placeTypeaheadBelow(taActiveInput); };
        window.addEventListener('scroll', taScrollHandler, true);
        window.addEventListener('resize', taScrollHandler);
      }
    }
    function hideTypeahead(){
      globalTA.classList.remove('open');
      globalTA.innerHTML='';
      taActiveInput = null;
      if (taOutsideHandler){ document.removeEventListener('mousedown', taOutsideHandler); taOutsideHandler=null; }
      if (taScrollHandler){ window.removeEventListener('scroll', taScrollHandler, true); window.removeEventListener('resize', taScrollHandler); taScrollHandler=null; }
    }
    async function doSearchForInput(inputEl){
      const q = (inputEl.value||'').trim();
      if (!q) return;
      try{
        const url=`https://nominatim.openstreetmap.org/search?format=json&limit=8&q=${encodeURIComponent(q)}`;
        const res=await fetch(url);
        const arr=await res.json();
        if (Array.isArray(arr) && arr.length) showTypeaheadFor(inputEl, arr);
        else hideTypeahead();
      }catch{ hideTypeahead(); }
    }
    function bindTypeahead(inputEl, onPick){
      let timer=null;
      inputEl.addEventListener('input', ()=>{
        const q = inputEl.value.trim();
        clearTimeout(timer);
        if (!q){ hideTypeahead(); return; }
        timer = setTimeout(()=> doSearchForInput(inputEl), 220);
      });
      inputEl.addEventListener('typeahead:pick', (ev)=> onPick(ev.detail));
    }

    bindTypeahead(addrInput, (p)=>{
      addrInput.value=p.label;
      if(!addrMap){
        addrMap = L.map(addrMapDiv).setView([p.lat,p.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap);
      }
      if(!addrMarker) addrMarker = L.marker([p.lat,p.lng]).addTo(addrMap);
      else addrMarker.setLatLng([p.lat,p.lng]);
      addrMarker._data = p;
      addrMap.setView([p.lat,p.lng], 15);
      addrMap.invalidateSize();
    });
    addrSearchBtn.addEventListener('click', ()=> doSearchForInput(addrInput));

    function setRoutePoint(idx,p){
      if(!routeMap){
        routeMap = L.map(rMapDiv).setView([p.lat,p.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
      }
      if(!routeMarkers[idx]) routeMarkers[idx]=L.marker([p.lat,p.lng]).addTo(routeMap);
      else routeMarkers[idx].setLatLng([p.lat,p.lng]);
      routeMarkers[idx]._data=p;
      routeMap.setView([p.lat,p.lng], 13);
      routeMap.invalidateSize();
    }
    bindTypeahead(rFrom, (p)=>{ rFrom.value=p.label; setRoutePoint(0,p); });
    bindTypeahead(rTo,   (p)=>{ rTo.value=p.label;   setRoutePoint(1,p); });
    rFromSearch.addEventListener('click', ()=> doSearchForInput(rFrom));
    rToSearch  .addEventListener('click', ()=> doSearchForInput(rTo));

    rCalc.addEventListener('click', async ()=>{
      if (!routeMarkers[0]?._data || !routeMarkers[1]?._data) return alert('×‘×—×¨ ×’× ××•×¦× ×•×’× ×™×¢×“.');
      const a=routeMarkers[0]._data, b=routeMarkers[1]._data;
      const profile = (rMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        rTime.textContent=`×–××Ÿ ××©×•×¢×¨: ${mins} ×“×§×³`;
        if (routeLayer) routeMap.removeLayer(routeLayer);
        routeLayer=L.geoJSON(r.geometry).addTo(routeMap);
        routeMap.fitBounds(routeLayer.getBounds(),{padding:[20,20]});
        routeMap.invalidateSize();
      } else rTime.textContent='×œ× × ××¦× ××¡×œ×•×œ.';
    });

    // Hotel helpers
    async function findAllHotelsForDate(ddmmyyyy) {
        const qSnap = await getDocs(collection(db, 'trips', tripId, 'logistics'));
        const allHotels = qSnap.docs.map(d => ({ id: d.id, ...d.data() })).filter(x => x.type === 'hotel');
        const inRange = (range) => expandRange(range || '').includes(ddmmyyyy);
        const hotelsForDate = allHotels.filter(h => inRange(h.dates));
        return hotelsForDate;
    }

    function openHotelSelectModal(hotels, callback) {
        hotelSelectCallback = callback;
        hotelSelectDropdown._hotels = hotels;
        hotelSelectDropdown.innerHTML = hotels.map(h => 
            `<option value="${h.id}">${h.name || '××œ×•×Ÿ ×œ×œ× ×©×'} (${h.destination || '×™×¢×“ ×œ× ×¦×•×™×Ÿ'})</option>`
        ).join('');
        hotelSelectModal.classList.add('show');
    }

    function applyHotelAddress(hotel, inputEl, map, currentMarker) {
        if (!hotel) return currentMarker;
        inputEl.value = hotel.address || hotel.name || '';
        const c = hotel.coords || hotel.location || null;
        let newMarker = currentMarker;
        if (c?.lat && c?.lng){
            if(!newMarker) {
                if(!map){
                  // fallback - should not really happen because we init maps before
                }
                newMarker = L.marker([c.lat,c.lng]).addTo(map);
            } else {
                newMarker.setLatLng([c.lat,c.lng]);
            }
            newMarker._data = {label:inputEl.value, lat:c.lat, lng:c.lng};
            map.setView([c.lat,c.lng], 15);
            map.invalidateSize();
        }
        return newMarker;
    }

    async function handleUseHotelAddress(addrInputEl, mapInstance, markerInstance, markerUpdateCallback) {
        const hotels = await findAllHotelsForDate(selectedDate);
        if (hotels.length === 0) {
            alert('××™×Ÿ ××œ×•×Ÿ ××•×’×“×¨ ×œ×ª××¨×™×š ×–×”.');
            return;
        }
        if (hotels.length === 1) {
            const newMarker = applyHotelAddress(hotels[0], addrInputEl, mapInstance, markerInstance);
            markerUpdateCallback(newMarker);
        } else {
            openHotelSelectModal(hotels, (selectedHotel) => {
                const newMarker = applyHotelAddress(selectedHotel, addrInputEl, mapInstance, markerInstance);
                markerUpdateCallback(newMarker);
            });
        }
    }

    hotelSelectSave.addEventListener('click', () => {
        if (hotelSelectCallback && hotelSelectDropdown._hotels) {
            const selectedId = hotelSelectDropdown.value;
            const selectedHotel = hotelSelectDropdown._hotels.find(h => h.id === selectedId);
            if (selectedHotel) {
                hotelSelectCallback(selectedHotel);
            }
        }
        hotelSelectModal.classList.remove('show');
        hotelSelectCallback = null;
        hotelSelectDropdown._hotels = null;
    });

    hotelSelectCancel.addEventListener('click', () => {
        hotelSelectModal.classList.remove('show');
        hotelSelectCallback = null;
        hotelSelectDropdown._hotels = null;
    });

    useHotelBtn.addEventListener('click', () => {
        handleUseHotelAddress(addrInput, addrMap, addrMarker, (newMarker) => { addrMarker = newMarker; });
    });
    
    function renderSelectedRefs(){
      selectedRefsWrap.innerHTML = selectedRefs.length ? selectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm italic">×¢×“×™×™×Ÿ ×œ× × ×‘×—×¨×• ×§×™×©×•×¨×™×.</span>`;
      selectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          selectedRefs.splice(idx,1);
          renderSelectedRefs();
        });
      });
    }

    function iconForRef(r){
      if (r.type==='logistics'){
        if (r.subType==='hotel') return 'ğŸ¨';
        if (r.subType==='flight') return 'âœˆï¸';
        if (r.subType==='train') return 'ğŸš†';
        if (r.subType==='car_rental') return 'ğŸš—';
        if (r.subType==='ferry') return 'â›´ï¸';
        return 'â¬…ï¸';
      }
      if (r.type==='place'){
        return 'ğŸ“';
      }
      return 'ğŸ“';
    }
    
    async function buildConnectLists(targetListsEl, selectedRefsArr){
      targetListsEl.innerHTML='<div class="p-4 text-center text-slate-500"><span class="loader"></span> ×˜×•×¢×Ÿ...</div>';
      
      // ×œ×•×’×™×¡×˜×™×§×”
      const logSnap = await getDocs(collection(db,'trips',tripId,'logistics'));
      const logistics = logSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // ××˜×¨×§×¦×™×•×ª/××•×›×œ ×‘×™×¢×“ ×”×¤×¢×™×œ
      if (!selectedDestName) {
        targetListsEl.innerHTML = '<div class="text-red-500 bg-red-50 p-3 rounded-xl border border-red-100">×©×’×™××”: ×œ× × ×‘×—×¨ ×™×¢×“. ×œ× × ×™×ª×Ÿ ×œ×˜×¢×•×Ÿ ××˜×¨×§×¦×™×•×ª.</div>';
        return;
      }
      
      const placesQuery = query(
        collection(db, 'trips', tripId, 'places'),
        where("destination", "==", selectedDestName)
      );
      const placesSnap = await getDocs(placesQuery);
      const places = placesSnap.docs.map(d=>({id:d.id, ...d.data()}));

      // Mobile-friendly card design with better wrapping and larger touch target
      const card = (title, sub, openHref, picked=false)=>`
        <div class="relative p-3.5 rounded-2xl border bg-white shadow-sm hover:shadow-md transition-all">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
             <div class="flex-1 min-w-0">
                <div class="font-bold text-slate-800 break-words whitespace-normal text-base leading-snug">${title}</div>
                ${sub ? `<div class="text-sm text-slate-500 mt-1 break-words">${sub}</div>` : ''}
             </div>
             <div class="flex items-center gap-2 shrink-0 self-end sm:self-auto w-full sm:w-auto justify-between sm:justify-end border-t sm:border-t-0 pt-3 sm:pt-0 mt-1 sm:mt-0">
                <a href="${openHref}" class="text-blue-600 hover:text-blue-800 text-sm font-bold px-3 py-2 bg-blue-50 rounded-lg" target="_blank">×¤×ª×—</a>
                <button class="flex-1 sm:flex-none px-5 py-2.5 rounded-xl text-sm font-bold transition-all pick-btn ${picked ? 'bg-green-600 text-white shadow-md ring-2 ring-green-200' : 'bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200'}">
                   ${picked ? '<i class="fa-solid fa-check"></i> × ×‘×—×¨' : '×‘×—×¨'}
                </button>
             </div>
          </div>
        </div>`;

      let html='';

      if (logistics.length){
        html+=`<div><div class="font-bold mb-3 text-lg text-slate-800 flex items-center gap-2"><span class="w-1 h-6 bg-blue-500 rounded-full"></span> ××¢×‘×¨×™× ×•××œ×•× ×•×ª</div><div class="grid gap-3">`;
        html+= logistics.map(l=>{
          const label = (l.type==='hotel'?'××œ×•×Ÿ: ':'') + (l.name||l.destination||l.type);
          const sub   = l.dates || l.date || '';
          const href  = `summary.html?id=${tripId}&open=logistics&id=${l.id}`;
          const picked= selectedRefsArr.some(r=>r.type==='logistics' && r.id===l.id);
          return `<div data-ref-type="logistics" data-ref-id="${l.id}" data-ref-subtype="${l.type}" data-ref-label="${label}">${card(iconForRef({type:'logistics',subType:l.type})+' '+label, sub, href, picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      
      if (places.length){
        html+=`<div class="mt-8"><div class="font-bold mb-3 text-lg text-slate-800 flex items-center gap-2"><span class="w-1 h-6 bg-purple-500 rounded-full"></span> ××˜×¨×§×¦×™×•×ª ×•××¡×¢×“×•×ª</div><div class="grid gap-3">`;
        html+= places.map(p=>{
          const label = p.name || '×¤×¨×™×˜';
          const sub   = p.type || p.destination || '';
          const href  = `attractions.html?id=${tripId}&open=place&id=${p.id}`;
          const picked= selectedRefsArr.some(r=>r.type==='place' && r.id===p.id);
          return `<div data-ref-type="place" data-ref-id="${p.id}" data-ref-subtype="${p.type}" data-ref-label="${label}">${card('ğŸ“ '+label, sub, href, picked)}</div>`;
        }).join('');
        html+=`</div></div>`;
      }
      
      targetListsEl.innerHTML = html || '<div class="text-slate-500 py-6 text-center bg-slate-50 rounded-xl border border-dashed">×œ× × ××¦××• ×¤×¨×™×˜×™× ×¨×œ×•×•× ×˜×™×™×.</div>';

      targetListsEl.querySelectorAll('.pick-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const wrap=btn.closest('[data-ref-type]');
          const type=wrap.dataset.refType;
          const id  =wrap.dataset.refId;
          const subType = wrap.dataset.refSubtype || null;
          const label=wrap.dataset.refLabel;
          const page = type === 'logistics' ? 'summary' : 'places'; 
          
          const existed = selectedRefsArr.findIndex(r=>r.type===type && r.id===id);
          if (existed>-1){
            selectedRefsArr.splice(existed,1);
            btn.innerHTML='×‘×—×¨';
            btn.className = 'flex-1 sm:flex-none px-5 py-2.5 rounded-xl text-sm font-bold transition-all pick-btn bg-slate-100 text-slate-700 hover:bg-slate-200 border border-slate-200';
          } else {
            selectedRefsArr.push({type, id, label, page, subType});
            btn.innerHTML='<i class="fa-solid fa-check"></i> × ×‘×—×¨';
            btn.className = 'flex-1 sm:flex-none px-5 py-2.5 rounded-xl text-sm font-bold transition-all pick-btn bg-green-600 text-white shadow-md ring-2 ring-green-200';
          }
          if (targetListsEl===connectLists) renderSelectedRefs();
          else renderVSelectedRefs();
        });
      });
    }

    document.querySelector('[data-open="#block-connect"]').addEventListener('click', async ()=>{
      const el=document.querySelector('#block-connect');
      setTimeout(async ()=>{
        if (!el.classList.contains('hidden')) await buildConnectLists(connectLists, selectedRefs);
      }, 0);
    });

    saveBtn.addEventListener('click', async ()=>{
      const payload = collectItemFromModal();
      await saveItemCore(payload, editingItemId);
      itemModal.classList.remove('show');
      hideTypeahead();
      editingItemId = null;
    });

    function collectItemFromModal(){
      const addrData = addrMarker?._data
        ? { label: addrMarker._data.label, lat: addrMarker._data.lat, lng: addrMarker._data.lng }
        : (addrInput.value.trim()? { label: addrInput.value.trim(), lat:null, lng:null } : null);

      const travelFrom = routeMarkers[0]?._data
        ? routeMarkers[0]._data
        : (rFrom.value.trim()? {label:rFrom.value.trim(), lat:null, lng:null}: null);

      const travelTo   = routeMarkers[1]?._data
        ? routeMarkers[1]._data
        : (rTo.value.trim()? {label:rTo.value.trim(), lat:null, lng:null}: null);

      const refsCopy = selectedRefs.slice();

      return {
        title: (inputItemTitle.value||'').trim() || '(×œ×œ× ×›×•×ª×¨×ª)',
        startTime: inputStart.value || null,
        endTime:   inputEnd.value   || null,
        description: (inputDesc.value||'').trim() || null,
        summary:     (inputSummary.value||'').trim() || null,
        notes:       (inputNotes.value||'').trim() || null,
        links: { site:(linkGeneral.value||'').trim() || null, booking:(linkBook.value||'').trim() || null },
        address: addrData,
        travel: (travelFrom || travelTo) ? { from: travelFrom, to: travelTo, mode: rMode.value, timeText: rTime.textContent || null } : null,
        refs: refsCopy,
        requiresRefs: !!requiresRefsFlag
      };
    }

    async function saveItemCore(payload, editId=null, extraFlags={}){
      await setDoc(dayDocRef,{ title: dayTitle || null, updatedAt: serverTimestamp() },{merge:true});
      const thisSort = minutesFromHHMM(payload.startTime||'00:00');
      const needsVerifyAddress = !!(payload.address && !(payload.address.lat!=null && payload.address.lng!=null));
      const needsVerifyRoute   = !!(payload.travel && !((payload.travel.from?.lat!=null) && (payload.travel.to?.lat!=null)));
      const needsVerifyRefs    = !!(payload.requiresRefs && (!Array.isArray(payload.refs) || payload.refs.length===0));
      const base = {
        ...payload,
        sort:thisSort,
        date:selectedDate,
        destination:selectedDestName,
        updatedAt: serverTimestamp(),
        needsVerifyAddress,
        needsVerifyRoute,
        needsVerifyRefs,
        ...extraFlags
      };
      if (editId){
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',editId), base);
      } else {
        await addDoc(collection(db,'trips',tripId,'schedules',dayDocId,'items'), {
          ...base,
          createdAt: serverTimestamp()
        });
      }
      await recomputeDistances();
    }

    async function recomputeDistances(){
      const snap = await getDocs(query(collection(db,'trips',tripId,'schedules',dayDocId,'items'), orderBy('sort','asc')));
      const arr = snap.docs.map(d=>({id:d.id,...d.data()}));
      for (let i=0;i<arr.length;i++){
        let dist=null;
        const a = arr[i-1], b=arr[i];
        if (a?.address?.lat!=null && b?.address?.lat!=null){
          dist = Math.round(haversineMeters({lat:a.address.lat,lng:a.address.lng},{lat:b.address.lat,lng:b.address.lng}));
        }
        await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',b.id), { distanceFromPreviousMeters: dist });
      }
    }

    // ×™×¦×™×¨×ª ×›×¨×˜×™×¡ "×—×–×¨×” ×œ××œ×•×Ÿ"
    addBackHotel.addEventListener('click', async () => {
        if (!inputStart.value) return alert('×‘×—×¨ ×©×¢×ª ×”×ª×—×œ×” ×œ×—×–×¨×” ×œ××œ×•×Ÿ.');
        const hotels = await findAllHotelsForDate(selectedDate);
        if (hotels.length === 0) {
            return alert('×œ× × ××¦× ××œ×•×Ÿ ×œ×ª××¨×™×š ×–×”.');
        }

        const processHotelSelection = async (h) => {
            await saveItemCore({
                title: '×—×–×¨×” ×œ××œ×•×Ÿ',
                startTime: inputStart.value, endTime: null,
                summary: '×¡×™×•× ×”×™×•× ×•×—×–×¨×” ×œ××œ×•×Ÿ',
                address: h.address ? { label: h.address, lat: h.coords?.lat ?? null, lng: h.coords?.lng ?? null } : null,
                isBackToHotel: true,
                refs: [],
                requiresRefs: false
            }, null);
            itemModal.classList.remove('show');
            hideTypeahead();
        };

        if (hotels.length === 1) {
            await processHotelSelection(hotels[0]);
        } else {
            openHotelSelectModal(hotels, (selectedHotel) => {
                processHotelSelection(selectedHotel);
            });
        }
    });

    // ×¤×ª×™×—×ª/×¡×’×™×¨×ª ×‘×œ×•×§×™× ×‘×ª×•×š ×¤×¨×™×˜
    openBlockBtns.forEach(b=>{
      b.addEventListener('click', ()=>{
        const el=document.querySelector(b.dataset.open);
        el.classList.toggle('hidden');
        if (el.id==='block-address') setTimeout(()=>{ if(addrMap) addrMap.invalidateSize(); },100);
        if (el.id==='block-route') setTimeout(()=>{ if(routeMap) routeMap.invalidateSize(); },100);
      });
    });

    // ×¡×’×™×¨×ª ××•×“×œ ×¦×¤×™×™×”
    viewClose.addEventListener('click', ()=> viewModal.classList.remove('show'));

    // ×¤×ª×™×—×ª ××•×“×œ AI
    aiBuildBtn.addEventListener('click', ()=>{
      aiInput.value='';
      aiPreview.classList.add('hidden');
      aiCreate.disabled = true;
      aiModal.classList.add('show');
    });
    aiClose.addEventListener('click', ()=> aiModal.classList.remove('show'));

    function parseAiText(raw){
      const lines = (raw||'').split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
      const result = { dayTitle:null, items:[] };
      let cur = null;
      const startItem = (title=null)=>{
        if (cur) result.items.push(finalize(cur));
        cur = {
          title: title, startTime: null, endTime: null, descParts: [], address: null,
          addressFromHotel:false, linkSite: null, linkBook: null,
          travel: { from:null, to:null, mode:'driving', timeText:null },
          wantsRefs:false, summary:null, notes:null, isBackToHotel:false
        };
      };
      const finalize = (o)=>{
        return {
          title: o.title || (o.isBackToHotel?'×—×–×¨×” ×œ××œ×•×Ÿ':'(×œ×œ× ×›×•×ª×¨×ª)'),
          startTime: o.startTime || null, endTime: o.endTime || null,
          description: o.descParts.length ? o.descParts.join('\n') : null,
          address: o.addressFromHotel ? { isHotel:true } : (o.address? {label:o.address} : null),
          links: { site: o.linkSite || null, booking: o.linkBook || null },
          travel: (o.travel.from || o.travel.to) ? {
            from: o.travel.from==='HOTEL' ? {isHotel:true} : (o.travel.from? {label:o.travel.from}: null),
            to:   o.travel.to==='HOTEL'   ? {isHotel:true} : (o.travel.to? {label:o.travel.to}: null),
            mode: o.travel.mode || 'driving', timeText: null
          } : null,
          wantsRefs: !!o.wantsRefs, summary: o.summary || null, notes: o.notes || null, isBackToHotel: !!o.isBackToHotel
        };
      };
      const m = {
        dayTitle: /^!(.+)!$/, itemTitle: /^×´(.+?)×´$/, start: /^\/\s*([^\/]+?)\s*\/$/, end: /^\\\s*([^\\]+?)\s*\\$/,
        backHotel: /^â‚ª$/, desc: /^:\s*(.+?)\s*:$/, addressHotel: /^×³â‚ª(?:\b|$)/, address: /^×³(.+?)×³$/,
        linkSite: /^\?\s*(.+?)\s*\?$/, linkBook: /^\$\s*(.+?)\s*\$$/, routeFrom: /^>\s*(.+)$/, routeTo: /^<\s*(.+)$/,
        refs: /^\*$/, summary: /^â€¢\s*(.+?)\s*â€¢$/, notes: /^~\s*(.+?)\s*~$/
      };
      const parseRouteSide = (txt)=>{
        const t = txt.trim();
        if (/^×³â‚ª/.test(t)) return 'HOTEL';
        const adr = t.match(m.address);
        if (adr) return adr[1].trim();
        return t;
      };
      for (const line of lines){
        if (m.dayTitle.test(line)){ result.dayTitle = line.match(m.dayTitle)[1].trim(); continue; }
        if (m.itemTitle.test(line)){ startItem(line.match(m.itemTitle)[1].trim()); continue; }
        if (!cur) startItem();
        if (m.start.test(line)){ cur.startTime = line.match(m.start)[1].trim(); continue; }
        if (m.end.test(line)){ cur.endTime = line.match(m.end)[1].trim(); continue; }
        if (m.backHotel.test(line)){ cur.isBackToHotel = true; if(!cur.title) cur.title='×—×–×¨×” ×œ××œ×•×Ÿ'; continue; }
        if (m.desc.test(line)){ cur.descParts.push(line.match(m.desc)[1]); continue; }
        if (m.addressHotel.test(line)){ cur.addressFromHotel = true; continue; }
        if (m.address.test(line)){ cur.address = line.match(m.address)[1].trim(); continue; }
        if (m.linkSite.test(line)){ cur.linkSite = line.match(m.linkSite)[1].trim(); continue; }
        if (m.linkBook.test(line)){ cur.linkBook = line.match(m.linkBook)[1].trim(); continue; }
        if (m.routeFrom.test(line)){ cur.travel.from = parseRouteSide(line.match(m.routeFrom)[1]); continue; }
        if (m.routeTo.test(line)){ cur.travel.to   = parseRouteSide(line.match(m.routeTo)[1]); continue; }
        if (m.refs.test(line)){ cur.wantsRefs = true; continue; }
        if (m.summary.test(line)){ cur.summary = line.match(m.summary)[1].trim(); continue; }
        if (m.notes.test(line)){ cur.notes = line.match(m.notes)[1].trim(); continue; }
        cur.descParts.push(line);
      }
      if (cur) result.items.push(finalize(cur));
      return result;
    }

    aiParse.addEventListener('click', ()=>{
      const parsed = parseAiText(aiInput.value);
      const rows = [];
      if (parsed.dayTitle) rows.push(`<div class="text-slate-800"><b>×›×•×ª×¨×ª ×™×•×:</b> ${parsed.dayTitle}</div>`);
      rows.push(`<div class="text-slate-800"><b>×›××•×ª ×¤×¨×™×˜×™×:</b> ${parsed.items.length}</div>`);
      parsed.items.forEach((it, i)=>{
        const needsAddr = !!(it.address);
        const needsRoute = !!(it.travel);
        const needsRefs = !!(it.wantsRefs);
        rows.push(`
          <div class="border rounded-lg p-2">
            <div><b>${i+1}.</b> ${it.title}</div>
            <div class="text-xs text-slate-600">${[it.startTime, it.endTime?('â€“ '+it.endTime):''].filter(Boolean).join(' ') || '×œ×œ× ×©×¢×•×ª'}</div>
            ${it.summary?`<div class="text-xs">${it.summary}</div>`:''}
            ${needsAddr?`<div class="text-xs text-red-700">â€¢ ×™×¦×•×™×Ÿ ××™××•×ª ×›×ª×•×‘×ª</div>`:''}
            ${needsRoute?`<div class="text-xs text-red-700">â€¢ ×™×¦×•×™×Ÿ ××™××•×ª ××¡×œ×•×œ</div>`:''}
            ${needsRefs?`<div class="text-xs text-red-700">â€¢ ×™×¦×•×™×Ÿ ×§×™×©×•×¨ ×œ××˜×¨×§×¦×™×•×ª/××¢×‘×¨×™×</div>`:''}
          </div>
        `);
      });
      aiPreviewContent.innerHTML = rows.join('');
      aiPreview.classList.remove('hidden');
      aiCreate.disabled = parsed.items.length===0;
      aiCreate._parsed = parsed;
    });

    aiCreate.addEventListener('click', async () => {
        const parsed = aiCreate._parsed;
        if (!parsed) return;
        aiCreate.disabled = true;
        aiLoaderOverlay.classList.remove('hidden');
        const btnText = aiCreate.querySelector('.btn-text');
        const btnLoader = aiCreate.querySelector('.loader');
        btnText.textContent = '×™×•×¦×¨ ×œ×•"×–...';
        btnLoader.classList.remove('hidden');
        try {
            if (parsed.dayTitle) {
                await setDoc(dayDocRef, { title: parsed.dayTitle, updatedAt: serverTimestamp() }, { merge: true });
                dayTitle = parsed.dayTitle;
                reflectDayTitleUI();
            }
            const allHotelsForDate = await findAllHotelsForDate(selectedDate);
            const hotel = allHotelsForDate.length === 1 ? allHotelsForDate[0] : null;

            for (const it of parsed.items) {
                const payload = {
                    title: it.title || '(×œ×œ× ×›×•×ª×¨×ª)',
                    startTime: it.startTime || null,
                    endTime: it.endTime || null,
                    description: it.description || null,
                    summary: it.summary || null,
                    notes: it.notes || null,
                    links: { site: it.links?.site || null, booking: it.links?.booking || null },
                    address: null,
                    travel: null,
                    refs: [],
                    requiresRefs: !!it.wantsRefs
                };
                if (it.address) {
                    if (it.address.isHotel && hotel) {
                        payload.address = { label: hotel.address || hotel.name || '××œ×•×Ÿ', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null };
                    } else if (it.address.isHotel && !hotel) {
                        payload.address = { label: '×›×ª×•×‘×ª ×”××œ×•×Ÿ', lat: null, lng: null };
                    } else {
                        payload.address = { label: it.address.label || it.address, lat: null, lng: null };
                    }
                }
                if (it.travel) {
                    const from = it.travel.from;
                    const to = it.travel.to;
                    const mode = it.travel.mode || 'driving';
                    const fromPt = (from && from.isHotel && hotel) ? { label: hotel.address || hotel.name || '××œ×•×Ÿ', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null }
                        : (from && from.isHotel && !hotel) ? { label: '×›×ª×•×‘×ª ×”××œ×•×Ÿ', lat: null, lng: null }
                        : (from ? { label: from.label || from, lat: null, lng: null } : null);
                    const toPt = (to && to.isHotel && hotel) ? { label: hotel.address || hotel.name || '××œ×•×Ÿ', lat: hotel.coords?.lat ?? null, lng: hotel.coords?.lng ?? null }
                        : (to && to.isHotel && !hotel) ? { label: '×›×ª×•×‘×ª ×”××œ×•×Ÿ', lat: null, lng: null }
                        : (to ? { label: to.label || to, lat: null, lng: null } : null);
                    payload.travel = (fromPt || toPt) ? { from: fromPt, to: toPt, mode, timeText: null } : null;
                }
                await new Promise(resolve => setTimeout(resolve, 50)); 
                await saveItemCore(payload, null, { source: 'ai' });
            }
            aiModal.classList.remove('show');
        } catch (error) {
            console.error("Error creating schedule from AI:", error);
            alert("××™×¨×¢×” ×©×’×™××” ×‘×™×¦×™×¨×ª ×”×œ×•\"×–. × ×¡×” ×©×•×‘.");
        } finally {
            aiLoaderOverlay.classList.add('hidden');
            btnText.textContent = '×¦×•×¨ ×œ×•×–';
            btnLoader.classList.add('hidden');
            aiCreate.disabled = !aiCreate._parsed || aiCreate._parsed.items.length === 0;
        }
    });

    function renderVSelectedRefs(){
      vSelectedRefsWrap.innerHTML = vSelectedRefs.length ? vSelectedRefs.map((r,i)=>(
        `<span class="chip">${iconForRef(r)} ${r.label}<span class="x" data-i="${i}">&times;</span></span>`
      )).join(' ') : `<span class="text-slate-400 text-sm">×œ× × ×‘×—×¨×• ×§×™×©×•×¨×™×.</span>`;
      vSelectedRefsWrap.querySelectorAll('.x').forEach(x=>{
        x.addEventListener('click', ()=>{
          const idx=parseInt(x.dataset.i,10);
          vSelectedRefs.splice(idx,1);
          renderVSelectedRefs();
        });
      });
    }

    async function openVerifyModal(item){
      vCurrentItem = item;
      vTitle.textContent = item.title || '(×œ×œ× ×›×•×ª×¨×ª)';

      const needAddr = !!item.needsVerifyAddress;
      const needRoute= !!item.needsVerifyRoute;
      const needRefs = !!item.needsVerifyRefs;

      vBlockAddr.classList.toggle('hidden', !needAddr);
      vBlockRoute.classList.toggle('hidden', !needRoute);
      vBlockRefs.classList.toggle('hidden', !needRefs);

      if (needAddr){
        if (!vAddrMap){
          vAddrMap = L.map(vAddrMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vAddrMap);
        }
        if (vAddrMarker){ vAddrMap.removeLayer(vAddrMarker); vAddrMarker=null; }
        vAddrInput.value = item.address?.label || '';
        if (item.address?.lat && item.address?.lng){
          vAddrMarker = L.marker([item.address.lat,item.address.lng]).addTo(vAddrMap);
          vAddrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
          vAddrMap.setView([item.address.lat,item.address.lng], 14);
        }
      }

      if (needRoute){
        if (!vRouteMap){
          vRouteMap = L.map(vRouteMapDiv).setView([31.77,35.21], 12);
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vRouteMap);
        }
        if (vRouteLayer){ vRouteMap.removeLayer(vRouteLayer); vRouteLayer=null; }
        vRouteMarkers.forEach(m=> m && vRouteMap.removeLayer(m));
        vRouteMarkers=[null,null];

        vRouteFrom.value = item.travel?.from?.label || '';
        vRouteTo.value   = item.travel?.to?.label   || '';
        vRouteMode.value = item.travel?.mode || 'driving';
        vRouteTime.textContent = item.travel?.timeText || '';

        if (item.travel?.from?.lat){
          vRouteMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(vRouteMap);
          vRouteMarkers[0]._data = item.travel.from;
        }
        if (item.travel?.to?.lat){
          vRouteMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(vRouteMap);
          vRouteMarkers[1]._data = item.travel.to;
        }
        if (vRouteMarkers[0] && vRouteMarkers[1]) {
          vRouteMap.fitBounds(L.featureGroup(vRouteMarkers).getBounds(),{padding:[20,20]});
        }
      }

      vSelectedRefs = Array.isArray(item.refs) ? [...item.refs] : [];
      if (needRefs){
        renderVSelectedRefs();
        await buildConnectLists(vConnectLists, vSelectedRefs);
      }

      vModal.classList.add('show');

      // invalidate maps for proper rendering (×× ×™×¢×ª ××¤×” ××¤×•×¨×”)
      setTimeout(()=>{
        if(needAddr && vAddrMap) vAddrMap.invalidateSize();
        if(needRoute && vRouteMap) vRouteMap.invalidateSize();
      },160);
    }

    vClose.addEventListener('click', ()=> vModal.classList.remove('show'));
    vCancel.addEventListener('click', ()=> vModal.classList.remove('show'));

    bindTypeahead(vAddrInput, (p)=>{
      vAddrInput.value=p.label;
      if(!vAddrMap){
        vAddrMap = L.map(vAddrMapDiv).setView([p.lat,p.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vAddrMap);
      }
      if(!vAddrMarker) vAddrMarker = L.marker([p.lat,p.lng]).addTo(vAddrMap);
      else vAddrMarker.setLatLng([p.lat,p.lng]);
      vAddrMarker._data = p;
      vAddrMap.setView([p.lat,p.lng], 15);
      vAddrMap.invalidateSize();
    });
    vAddrSearch.addEventListener('click', ()=> doSearchForInput(vAddrInput));

    function vSetRoutePoint(idx,p){
      if(!vRouteMap){
        vRouteMap = L.map(vRouteMapDiv).setView([p.lat,p.lng], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(vRouteMap);
      }
      if(!vRouteMarkers[idx]) vRouteMarkers[idx]=L.marker([p.lat,p.lng]).addTo(vRouteMap);
      else vRouteMarkers[idx].setLatLng([p.lat,p.lng]);
      vRouteMarkers[idx]._data=p;
      vRouteMap.setView([p.lat,p.lng], 13);
      vRouteMap.invalidateSize();
    }
    bindTypeahead(vRouteFrom, (p)=>{ vRouteFrom.value=p.label; vSetRoutePoint(0,p); });
    bindTypeahead(vRouteTo,   (p)=>{ vRouteTo.value=p.label; vSetRoutePoint(1,p); });
    vRouteFromSearch.addEventListener('click', ()=> doSearchForInput(vRouteFrom));
    vRouteToSearch  .addEventListener('click', ()=> doSearchForInput(vRouteTo));

    vRouteCalc.addEventListener('click', async ()=>{
      if (!vRouteMarkers[0]?._data || !vRouteMarkers[1]?._data) return alert('×‘×—×¨ ×’× ××•×¦× ×•×’× ×™×¢×“.');
      const a=vRouteMarkers[0]._data, b=vRouteMarkers[1]._data;
      const profile = (vRouteMode.value==='foot') ? 'foot' : 'driving';
      const url=`https://router.project-osrm.org/route/v1/${profile==='foot'?'foot':'driving'}/${a.lng},${a.lat};${b.lng},${b.lat}?overview=full&geometries=geojson`;
      const res=await fetch(url); const data=await res.json();
      if (data?.routes?.[0]){
        const r=data.routes[0], mins=Math.round(r.duration/60);
        vRouteTime.textContent=`×–××Ÿ ××©×•×¢×¨: ${mins} ×“×§×³`;
        if (vRouteLayer) vRouteMap.removeLayer(vRouteLayer);
        vRouteLayer=L.geoJSON(r.geometry).addTo(vRouteMap);
        vRouteMap.fitBounds(vRouteLayer.getBounds(),{padding:[20,20]});
        vRouteMap.invalidateSize();
      } else vRouteTime.textContent='×œ× × ××¦× ××¡×œ×•×œ.';
    });

    vUseHotel.addEventListener('click', () => {
        handleUseHotelAddress(vAddrInput, vAddrMap, vAddrMarker, (newMarker) => { vAddrMarker = newMarker; });
    });

    vSave.addEventListener('click', async ()=>{
      if (!vCurrentItem) return;

      let newAddress = vCurrentItem.address || null;
      let newTravel  = vCurrentItem.travel  || null;
      let newRefs    = Array.isArray(vSelectedRefs)? vSelectedRefs : [];

      if (!vBlockAddr.classList.contains('hidden')){
        if (vAddrMarker?._data){
          newAddress = { label: vAddrMarker._data.label, lat: vAddrMarker._data.lat, lng: vAddrMarker._data.lng };
        } else if (vAddrInput.value.trim()){
          newAddress = { label: vAddrInput.value.trim(), lat: null, lng: null };
        } else {
          newAddress = null;
        }
      }

      if (!vBlockRoute.classList.contains('hidden')){
        const from = vRouteMarkers[0]?._data
          ? {label:vRouteMarkers[0]._data.label, lat:vRouteMarkers[0]._data.lat, lng:vRouteMarkers[0]._data.lng}
          : (vRouteFrom.value.trim()? {label:vRouteFrom.value.trim(), lat:null, lng:null}: null);
        const to   = vRouteMarkers[1]?._data
          ? {label:vRouteMarkers[1]._data.label, lat:vRouteMarkers[1]._data.lat, lng:vRouteMarkers[1]._data.lng}
          : (vRouteTo.value.trim()? {label:vRouteTo.value.trim(), lat:null, lng:null}: null);

        newTravel = (from || to) ? { from, to, mode: vRouteMode.value, timeText: vRouteTime.textContent || null } : null;
      }

      const needsVerifyAddress = !!(newAddress && !(newAddress.lat!=null && newAddress.lng!=null));
      const needsVerifyRoute   = !!(newTravel && !((newTravel.from?.lat!=null) && (newTravel.to?.lat!=null)));
      const needsVerifyRefs    = !!(vCurrentItem.requiresRefs && (!Array.isArray(newRefs) || newRefs.length===0));

      await updateDoc(doc(db,'trips',tripId,'schedules',dayDocId,'items',vCurrentItem.id), {
        address: newAddress || null,
        travel:  newTravel  || null,
        refs:    newRefs,
        needsVerifyAddress,
        needsVerifyRoute,
        needsVerifyRefs,
        updatedAt: serverTimestamp()
      });

      await recomputeDistances();

      vModal.classList.remove('show');

      // × ×‘×˜×™×— ×©×”××¤×” ×‘××¡×š ×¦×¤×™×™×” (×× ×™×¤×ª×— ××—×“×© ××™×“) ×œ× ×ª×”×™×” ××¤×•×¨×”
      setTimeout(()=>{
        if(viewMap) viewMap.invalidateSize();
      },150);
    });

    // ×¤×ª×™×—×ª ××•×“×œ ×¤×¨×™×˜ (×”×•×¡×¤×”/×¢×¨×™×›×”, ×•×’× ××™××•×ª ×××¡×š ×¦×¤×™×™×”)
    function openItemModal(item=null, opts={verify:false, focus:{address:false, route:false, refs:false}}){
      // === ×ª×™×§×•×Ÿ ×‘××’: ××™×¤×•×¡ ××¦×‘ ===
      // ×¡×•×’×¨×™× ××ª ×›×œ ×”×‘×œ×•×§×™× ×”× ×¤×ª×—×™× ×›×“×™ ×œ×”×‘×˜×™×— ×©×‘×¤×ª×™×—×” ×©×œ×”× ××—×“×© ×™×™×•×•×¦×¨×• ××™×¨×•×¢×™× ×¢×œ ×”××™×“×¢ ×”×—×“×©
      // ×•×× ×§×™× ××ª ×ª×•×›×Ÿ ×”-HTML ×©×œ ×¨×©×™××ª ×”××˜×¨×§×¦×™×•×ª ×›×“×™ ×œ× ×œ×”×¦×™×’ ××™×“×¢ ×™×©×Ÿ
      document.querySelectorAll('#block-address, #block-links, #block-book, #block-route, #block-connect')
        .forEach(el => el.classList.add('hidden'));
      connectLists.innerHTML = ''; // × ×™×§×•×™ ×”×¨×©×™××” ×”×™×©× ×” ×›×“×™ ×©×œ× ×™×”×™×• ×›×¤×ª×•×¨×™× "×ª×§×•×¢×™×"
      // ==========================

      editingItemId = item?.id || null;
      modalTitle.textContent = editingItemId ? '×¢×¨×™×›×ª ×¤×¨×™×˜' : '×”×•×¡×¤×ª ×¤×¨×™×˜ ×œ×™×•×';

      inputDayTitle.value = dayTitle || '';
      inputItemTitle.value = item?.title || '';
      inputStart.value = item?.startTime || '';
      inputEnd.value   = item?.endTime || '';
      inputDesc.value  = item?.description || '';
      inputSummary.value = item?.summary || '';
      inputNotes.value   = item?.notes || '';
      linkGeneral.value  = item?.links?.site || '';
      linkBook.value     = item?.links?.booking || '';

      endWrap.classList.toggle('hidden', !item?.endTime);

      requiresRefsFlag = !!item?.requiresRefs;
      selectedRefs = Array.isArray(item?.refs) ? [...item.refs] : [];
      renderSelectedRefs();

      if (!addrMap){
        addrMap = L.map(addrMapDiv).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(addrMap);
      }
      if (addrMarker){ addrMap.removeLayer(addrMarker); addrMarker=null; }
      addrInput.value = item?.address?.label || '';
      if (item?.address?.lat && item?.address?.lng){
        addrMarker = L.marker([item.address.lat,item.address.lng]).addTo(addrMap);
        addrMarker._data = {label:item.address.label, lat:item.address.lat, lng:item.address.lng};
        addrMap.setView([item.address.lat,item.address.lng], 14);
      }

      if (!routeMap){
        routeMap = L.map(rMapDiv).setView([31.77,35.21], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(routeMap);
      }
      if (routeLayer){ routeMap.removeLayer(routeLayer); routeLayer=null; }
      routeMarkers.forEach(m=> m && routeMap.removeLayer(m));
      routeMarkers=[null,null];
      rFrom.value = item?.travel?.from?.label || '';
      rTo.value   = item?.travel?.to?.label   || '';
      rMode.value = item?.travel?.mode || 'driving';
      rTime.textContent = item?.travel?.timeText || '';
      if (item?.travel?.from?.lat){
        routeMarkers[0] = L.marker([item.travel.from.lat,item.travel.from.lng]).addTo(routeMap);
        routeMarkers[0]._data = item.travel.from;
      }
      if (item?.travel?.to?.lat){
        routeMarkers[1] = L.marker([item.travel.to.lat,item.travel.to.lng]).addTo(routeMap);
        routeMarkers[1]._data = item.travel.to;
      }
      if (routeMarkers[0] && routeMarkers[1]) {
        routeMap.fitBounds(L.featureGroup(routeMarkers).getBounds(),{padding:[20,20]});
      }

      const wantVerify = !!opts.verify;
      verifyBanner.classList.toggle('hidden', !wantVerify);

      showStep(wantVerify ? 'E' : (dayTitle ? 'B' : 'A'));

      itemModal.classList.add('show');

      // invalidate maps ×œ×× ×™×¢×ª ××¤×” ××¤×•×¨×”
      setTimeout(()=>{
        if(addrMap) addrMap.invalidateSize();
        if(routeMap) routeMap.invalidateSize();
      },160);
    }

    addItemBtn.addEventListener('click', ()=> openItemModal());
    closeModal.addEventListener('click', ()=> {
      itemModal.classList.remove('show');
      hideTypeahead();
    });
  </script>
</body>
</html>