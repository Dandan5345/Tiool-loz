<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>הוספת הוצאה</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family:'Assistant',sans-serif; background:#0b1020; color:#e5e7eb; }
    .card { max-width:420px; margin:10vh auto; background:rgba(255,255,255,0.06);
            border:1px solid rgba(255,255,255,0.15); border-radius:16px; padding:28px;
            backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); text-align:center; }
  </style>
</head>
<body>
  <main class="p-4">
    <div class="card">
      <div id="icon" class="text-5xl mb-4">⏳</div>
      <h1 id="title" class="text-xl font-bold mb-1">מוסיף הוצאה…</h1>
      <p id="msg" class="opacity-90">מעבד את הנתונים ונרשם לגיליון…</p>
      <a id="btn" href="#" class="hidden inline-block mt-5 px-4 py-2 rounded-lg bg-blue-600 hover:bg-blue-700 text-white font-semibold">סגור</a>
    </div>
  </main>

  <script>
    // כתובת ה-Apps Script שלך (Web App - /exec)
    const scriptUrl = "https://script.google.com/macros/s/AKfycbzlRRA1rtwAVEcpZHCXmheeUvwXcMvnRCWwLhYg8XRj-6cQDmWEjTI8F0LJqjsTTrrVPw/exec";

    const $ = (id) => document.getElementById(id);
    function setState(icon, title, msg, btnText = "", href = "#") {
      $("icon").textContent = icon;
      $("title").textContent = title;
      $("msg").textContent = msg;
      if (btnText) {
        const b = $("btn");
        b.textContent = btnText;
        b.href = href;
        b.classList.remove("hidden");
      }
    }

    (async function init() {
      const q = new URLSearchParams(location.search);
      const trip = q.get("trip");
      const amount = q.get("amount");
      const description = q.get("description");

      if (!trip || !amount || !description) {
        setState("⚠️", "פרטים חסרים", "נדרשים פרמטרים trip, amount, description.", "לדף הבית", "index.html");
        return;
      }

      try {
        const url = `${scriptUrl}?trip=${encodeURIComponent(trip)}&amount=${encodeURIComponent(amount)}&description=${encodeURIComponent(description)}`;
        const res = await fetch(url, { method: "GET" });
        const text = await res.text();

        if (res.ok && /OK/i.test(text)) {
          setState("✅", "ההוצאה נוספה!", "הנתון נרשם בהצלחה לגיליון. החלון ייסגר אוטומטית…", "סגור");
          setTimeout(() => { window.close(); }, 1800);
        } else {
          setState("❌", "שגיאה בהוספה", text || "בקשה נכשלה.", "נסה שוב", "#");
        }
      } catch (e) {
        setState("❌", "שגיאה בחיבור", e.message, "נסה שוב", "#");
      }
    })();
  </script>
</body>
</html>