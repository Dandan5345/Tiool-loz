<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>专 转驻专 爪</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
  <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@400;500;700&display=swap" rel="stylesheet" />

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Assistant', 'sans-serif'],
            rubik: ['Rubik', 'sans-serif'],
          }
        }
      }
    }
  </script>

  <style>
    /* 住住 */
    html, body { height: 100%; -webkit-tap-highlight-color: transparent; }
    
    /* 爪转 转驻专 */
    .submenu { 
        max-height: 0; 
        overflow: hidden; 
        transition: max-height 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
    }
    .submenu.open { 
        max-height: 1000px; /* 住驻拽    转 转 */
    }
    
    .chevron-icon { transition: transform 0.3s ease; }
    .rotate-180 { transform: rotate(180deg); }

    /* 注爪 驻住  转驻专 */
    #sidebar::-webkit-scrollbar { width: 4px; }
    #sidebar::-webkit-scrollbar-track { background: transparent; }
    #sidebar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
    
    body.modal-locked { overflow: hidden; }
  </style>
</head>
<body class="bg-slate-100">

  <!-- 驻转专 驻转转 转驻专 (爪专 ) -->
  <div class="p-10 flex flex-col items-center justify-center min-h-screen">
      <button id="hamburger-btn" class="w-16 h-16 rounded-full bg-slate-900 text-white shadow-xl hover:scale-110 transition flex items-center justify-center text-2xl">
        <i class="fas fa-bars"></i>
      </button>
      <p class="mt-4 text-slate-500 font-bold">抓 驻转转 转驻专</p>
      <div id="auth-status" class="mt-2 text-xs text-slate-400">拽 专...</div>
  </div>

  <!-- --- 转转 拽 转驻专 (Sidebar) --- -->
  
  <!-- Overlay (专拽注  专) -->
  <div id="overlay" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[140] hidden transition-opacity duration-300 opacity-0"></div>

  <!-- Sidebar Container -->
  <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white/95 backdrop-blur-xl shadow-2xl z-[150] transform translate-x-full transition-transform duration-300 ease-out border-l border-white/20 flex flex-col">
    
    <!-- Sidebar Header -->
    <div class="p-5 flex justify-between items-center border-b border-slate-100 bg-gradient-to-l from-cyan-50 to-transparent shrink-0">
      <h2 class="text-2xl font-bold text-slate-800 font-rubik">转驻专 住注 Л</h2>
      <button id="close-sidebar-btn" class="w-10 h-10 rounded-full bg-slate-100 text-slate-500 hover:text-red-500 hover:bg-red-50 transition flex items-center justify-center shadow-sm">
        <i class="fas fa-times fa-lg"></i>
      </button>
    </div>

    <!-- Sidebar Content (Navigation) -->
    <nav id="main-menu" class="p-4 space-y-3 overflow-y-auto flex-grow pb-20 scroll-smooth">
      <!-- 转 注  转 注" -JS -->
      <div class="text-center py-10 text-slate-400">
          <i class="fas fa-circle-notch fa-spin mb-2"></i>
          <p class="text-sm">注 转驻专...</p>
      </div>
    </nav>
    
    <!-- Footer 拽 转转转 转驻专 -->
    <div class="p-4 border-t border-slate-100 bg-slate-50 shrink-0 text-center">
        <p class="text-xs text-slate-400">转  </p>
    </div>
  </aside>
  <!-- --- 住祝 拽 转驻专 --- -->


  <!-- Firebase & Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
    import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

    // 专转 Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
      authDomain: "tiool-loz.firebaseapp.com",
      projectId: "tiool-loz",
      storageBucket: "tiool-loz.appspot.com",
      messagingSenderId: "226069823505",
      appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // 
    const sidebar = document.getElementById('sidebar');
    const overlay = document.getElementById('overlay');
    const hamburgerBtn = document.getElementById('hamburger-btn');
    const closeSidebarBtn = document.getElementById('close-sidebar-btn');
    const mainMenu = document.getElementById('main-menu');
    const authStatus = document.getElementById('auth-status');

    let tripId = null;
    let tripData = null;

    // --- 拽转 驻转/住专 ---
    function toggleSidebar() {
      const isClosed = sidebar.classList.contains('translate-x-full');
      if (isClosed) {
        // 驻转
        sidebar.classList.remove('translate-x-full');
        overlay.classList.remove('hidden');
        // 驻砖专 驻驻 爪专 驻 住驻转 -opacity
        requestAnimationFrame(() => {
            overlay.classList.remove('opacity-0');
        });
        document.body.classList.add('modal-locked'); // 注转  祝 专砖
      } else {
        // 住专
        sidebar.classList.add('translate-x-full');
        overlay.classList.add('opacity-0');
        setTimeout(() => {
            overlay.classList.add('hidden');
            document.body.classList.remove('modal-locked');
        }, 300); // 转 -duration -CSS
      }
    }

    hamburgerBtn.addEventListener('click', toggleSidebar);
    closeSidebarBtn.addEventListener('click', toggleSidebar);
    overlay.addEventListener('click', toggleSidebar);

    // --- 注专 转专 ---
    function parseDDMMYYYY(s) {
        if (!s || typeof s !== 'string') return null;
        const [d, m, y] = s.split('/').map(Number);
        if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
        return new Date(y, m - 1, d);
    }

    function hebWeekday(d) {
        const n = d.toLocaleDateString('he-IL', { weekday: 'long' });
        return n.startsWith('') ? n : ` ${n}`;
    }

    function dotted(d) {
        return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
    }

    function generateDatesFromRange(rangeStr) {
        if (!rangeStr || !rangeStr.includes(' - ')) return [];
        const [startStr, endStr] = rangeStr.split(' - ');
        const startDate = parseDDMMYYYY(startStr);
        const endDate = parseDDMMYYYY(endStr);
        if (!startDate || !endDate) return [];
        
        const dates = [];
        let currentDate = new Date(startDate);

        while (currentDate <= endDate) {
            const dd = String(currentDate.getDate()).padStart(2,'0');
            const mm = String(currentDate.getMonth()+1).padStart(2,'0');
            const yyyy = currentDate.getFullYear();
            dates.push(`${dd}/${mm}/${yyyy}`);
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return dates;
    }

    // --- 驻拽爪转 转 转驻专 专砖转 ---
    function buildMenuFromTrip() {
      mainMenu.innerHTML = ''; // 拽

      // 1. 驻转专  专 (驻 拽砖)
      //   砖拽砖专  转 -tripId 
      const tParam = `?tripId=${tripId}`;
      
      const navLinks = [
        { name: '专 拽专', icon: 'fa-home', href: `trip.html${tParam}`, color: 'text-blue-600', bg: 'bg-blue-50' },
        { name: ' 住拽', icon: 'fa-suitcase', href: `summary.html${tParam}`, color: 'text-orange-600', bg: 'bg-orange-50' },
        { name: '专拽爪转 住注转', icon: 'fa-utensils', href: `attractions.html${tParam}`, color: 'text-cyan-600', bg: 'bg-cyan-50' },
        { name: '专砖转 爪\'拽 住', icon: 'fa-list-check', href: `checklists.html${tParam}`, color: 'text-emerald-600', bg: 'bg-emerald-50' },
        { name: '注拽 爪转', icon: 'fa-coins', href: `expenses.html${tParam}`, color: 'text-rose-600', bg: 'bg-rose-50' },
        { name: '转 住 ', icon: 'fa-magic-wand-sparkles', href: `edit-trip.html${tParam}`, color: 'text-purple-600', bg: 'bg-purple-50' }
      ];

      const navContainer = document.createElement('div');
      navContainer.className = 'space-y-2 mb-6';

      //  祝  砖 (祝   砖注转,  拽  注)
      const currentPath = window.location.pathname;

      navLinks.forEach(link => {
          const a = document.createElement('a');
          a.href = link.href;
          // 拽 驻砖 拽转 "  祝 " -    驻注   祝 专
          const isActive = currentPath.includes(link.href.split('?')[0]); 

          a.className = `flex items-center gap-3 w-full p-3 rounded-xl transition-all hover:translate-x-1 ${isActive ? 'bg-slate-100 font-bold border-r-4 border-cyan-500' : 'hover:bg-slate-50'}`;
          
          a.innerHTML = `
            <div class="w-10 h-10 rounded-full ${link.bg} ${link.color} flex items-center justify-center shadow-sm">
                <i class="fas ${link.icon}"></i>
            </div>
            <span class="text-slate-700 ${isActive ? 'font-bold' : 'font-medium'}">${link.name}</span>
          `;
          navContainer.appendChild(a);
      });
      mainMenu.appendChild(navContainer);

      // 2. 驻专 转专转
      const separator = document.createElement('div');
      separator.className = 'h-px bg-slate-200 my-4';
      mainMenu.appendChild(separator);

      const scheduleHeader = document.createElement('h3');
      scheduleHeader.className = 'text-xs font-bold text-slate-400 uppercase tracking-wider mb-4 px-2';
      scheduleHeader.innerText = "状  驻 注";
      mainMenu.appendChild(scheduleHeader);

      // 3. 转 注 转 -Firebase
      if (!tripData?.destinations || !Array.isArray(tripData.destinations)) {
          mainMenu.insertAdjacentHTML('beforeend', '<p class="text-center text-slate-400 text-sm"> 专 注  .</p>');
          return;
      }

      //  注 驻 转专
      const sortedDestinations = [...tripData.destinations].sort((a, b) => {
        const dateA = parseDDMMYYYY(a.dates?.split(' - ')[0]);
        const dateB = parseDDMMYYYY(b.dates?.split(' - ')[0]);
        if (!dateA) return 1;
        if (!dateB) return -1;
        return dateA - dateB;
      });

      sortedDestinations.forEach(dest => {
          const destinationDiv = document.createElement('div');
          destinationDiv.className = 'mb-2';

          // 转专转 注 (拽专)
          const button = document.createElement('button');
          button.className = 'w-full text-right p-3 hover:bg-cyan-50 rounded-xl font-bold text-slate-700 flex justify-between items-center transition-all group';
          button.innerHTML = `
            <span class="flex items-center gap-3">
                <i class="fas fa-map-marked-alt text-slate-400 group-hover:text-cyan-500 transition-colors"></i> 
                ${dest.nameHe || dest.name}
            </span> 
            <i class="fas fa-chevron-down chevron-icon text-slate-300 text-sm"></i>`;

          // 转转-转驻专 
          const submenu = document.createElement('div');
          submenu.className = 'submenu mt-1 mr-4 border-r-2 border-slate-100 pr-2 space-y-1';

          if (dest.dates) {
              const dates = generateDatesFromRange(dest.dates);
              dates.forEach(dateStr => {
                  const d = parseDDMMYYYY(dateStr);
                  if (!d) return;
                  
                  const a = document.createElement('a');
                  const destNameParam = encodeURIComponent(dest.nameHe || dest.name);
                  a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;
                  
                  a.className = 'block w-full text-right py-2 px-3 text-slate-600 hover:bg-slate-50 hover:text-cyan-700 rounded-lg transition text-sm';
                  a.innerHTML = `
                      <div class="flex items-center gap-2">
                          <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                          <span class="font-medium">${hebWeekday(d)}</span>
                          <span class="text-xs text-slate-400">(${dotted(d)})</span>
                      </div>
                  `;
                  submenu.appendChild(a);
              });
          } else {
             const noDates = document.createElement('div');
             noDates.className = 'text-xs text-slate-400 pr-3 py-1';
             noDates.innerText = ' 转专';
             submenu.appendChild(noDates);
          }

          // 专注 驻转/住专
          button.addEventListener('click', () => {
              submenu.classList.toggle('open');
              button.querySelector('.chevron-icon').classList.toggle('rotate-180');
          });

          destinationDiv.appendChild(button);
          destinationDiv.appendChild(submenu);
          mainMenu.appendChild(destinationDiv);
      });
    }


    // --- 转 注专转 ---
    async function init() {
        // 拽转 ID -URL
        const urlParams = new URLSearchParams(window.location.search);
        tripId = urlParams.get('id') || urlParams.get('tripId');
        
        if (!tripId) {
            authStatus.innerHTML = '<span class="text-red-500">砖: 住专   -URL</span>';
            mainMenu.innerHTML = '<div class="p-4 text-center text-red-500"> 住祝 ?tripId=... 转转</div>';
            return;
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                authStatus.innerHTML = '<span class="text-green-500">专 住专</span>';
                try {
                    const docRef = doc(db, 'trips', tripId);
                    const docSnap = await getDoc(docRef);
                    
                    if (docSnap.exists()) {
                        tripData = docSnap.data();
                        buildMenuFromTrip();
                        
                        // 驻转 转   专爪:
                        // toggleSidebar(); 
                    } else {
                        mainMenu.innerHTML = '<div class="p-4 text-center">  爪 住 转</div>';
                    }
                } catch (error) {
                    console.error("Error fetching trip:", error);
                    mainMenu.innerHTML = '<div class="p-4 text-center text-red-500">砖 注转 转</div>';
                }
            } else {
                authStatus.innerHTML = '<span class="text-orange-500"> 专 -  转专  专转 转</span>';
                mainMenu.innerHTML = `
                    <div class="p-6 text-center">
                        <p class="mb-4 text-slate-600">砖 转专  注 转 转 .</p>
                        <a href="login.html" class="inline-block bg-cyan-600 text-white px-6 py-2 rounded-full font-bold">转专转</a>
                    </div>`;
            }
        });
    }

    init();
  </script>
</body>
</html>

