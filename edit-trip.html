<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>בניית מסלול חכם</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5; /* indigo-600 */
            --secondary-color: #10b981; /* emerald-500 */
        }
        html, body {
             height: 100%;
             overflow: hidden;
        }
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; }
        .leaflet-container { font-family: 'Assistant', sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }

        /* --- Custom Components --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            white-space: nowrap;
        }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-secondary:hover { background-color: #059669; }
        .btn-ghost { background-color: transparent; color: #475569; }
        .btn-ghost:hover { background-color: #f1f5f9; color: #1e293b; }

        /* Route Building Step Timeline */
        .route-step {
            position: relative;
            padding-right: 3.5rem;
            padding-bottom: 1.5rem;
            min-height: 60px;
        }
        .route-step:not(:last-child)::before {
            content: '';
            position: absolute;
            top: 40px;
            right: 19px;
            width: 2px;
            height: calc(100% - 20px);
            background-color: #e2e8f0;
        }
        .step-icon-wrapper {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: white;
            border: 2px solid #e2e8f0;
        }
        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Map Marker Styling */
        .custom-marker-icon-wrapper { z-index: 500; }
        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        .custom-marker-icon.highlight {
            transform: scale(1.5);
            z-index: 1000 !important;
        }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #summary-panel, #summary-panel * { visibility: visible; }
            #summary-panel {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                display: block;
            }
            #summary-map-container {
                height: 400px !important;
                width: 100%;
                page-break-after: always;
            }
            #summary-details { margin: 0; padding: 0; overflow-y: visible; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="h-full w-full">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-route text-5xl text-indigo-600 animate-pulse"></i>
        <p class="text-xl font-bold text-slate-700">טוען נתונים...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="h-full flex-col hidden">
        <header class="bg-white shadow-sm z-20 border-b border-slate-200 shrink-0">
            <div class="container mx-auto px-2 sm:px-6 lg:px-8 h-auto md:h-16 flex flex-wrap items-center justify-between gap-y-2 py-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <i class="fas fa-route text-2xl text-indigo-600"></i>
                    <h1 class="text-lg sm:text-xl font-bold text-slate-800">בניית מסלול חכם</h1>
                </div>
                 <div class="flex items-center gap-1 sm:gap-2">
                     <a id="all-routes-btn" href="#" class="btn btn-ghost text-sm p-2 sm:p-2 sm:px-3" title="כל המסלולים השמורים">
                         <i class="fas fa-list-ul"></i>
                         <span class="hidden sm:inline ml-2">כל המסלולים</span>
                     </a>
                      <a id="back-to-trip-btn" href="#" class="btn btn-ghost text-sm p-2 sm:p-2 sm:px-3" title="חזרה למרכז הטיול">
                         <i class="fas fa-arrow-right"></i>
                         <span class="hidden sm:inline ml-2">חזרה לטיול</span>
                     </a>
                     <div id="auth-container" class="text-xs sm:text-sm font-semibold text-slate-600 bg-slate-100 px-2 sm:px-3 py-2 rounded-lg"></div>
                 </div>
            </div>
        </header>

        <!-- Main container for layout split -->
        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            
            <!-- Right Panel (Controls) -->
            <aside id="controls-panel" class="w-full bg-white p-3 sm:p-4 flex flex-col overflow-y-auto no-scrollbar border-l-0 md:border-l md:border-slate-200 h-full">
                <!-- Initial State -->
                <div id="initial-state" class="text-center p-4 sm:p-8 flex-grow flex flex-col items-center justify-center">
                    <i class="fas fa-magic-wand-sparkles text-4xl sm:text-5xl text-indigo-400 mb-6"></i>
                    <h2 class="text-xl sm:text-2xl font-bold text-slate-800">מוכן לבנות מסלול?</h2>
                    <p class="text-slate-500 mt-2 text-sm sm:text-base">התחל ביצירת מסלול חדש כדי לתכנן את היום המושלם.</p>
                    <button id="create-route-btn" class="mt-8 btn btn-primary w-full max-w-sm">
                        <i class="fas fa-plus mr-2"></i> צור מסלול חדש
                    </button>
                </div>

                <!-- Building State -->
                <div id="building-state" class="hidden flex-grow flex flex-col min-h-0">
                    <div class="flex justify-between items-start mb-4 shrink-0">
                        <div>
                            <h2 id="route-title" class="text-xl sm:text-2xl font-bold text-slate-800"></h2>
                            <p id="route-destination" class="text-slate-500 font-semibold flex items-center gap-2"><i class="fas fa-map-pin"></i> <span></span></p>
                        </div>
                        <button id="toggle-map-view-btn" class="btn btn-ghost text-sm shrink-0">
                            <i class="fas fa-map-location-dot"></i>
                            <span id="toggle-map-btn-text" class="mr-2 hidden sm:inline">הצג מפה</span>
                        </button>
                    </div>
                    
                    <div class="flex-grow flex flex-col min-h-0">
                        <div class="border bg-slate-50 rounded-lg p-3 sm:p-4 flex-grow flex flex-col min-h-0">
                             <h3 class="font-bold text-slate-700 mb-3 text-base sm:text-lg shrink-0">תחנות במסלול:</h3>
                             <div id="route-steps-container" class="flex-grow overflow-y-auto no-scrollbar pr-2 -mr-2">
                                 <p id="start-prompt" class="text-center text-slate-500 p-4">בחר נקודת התחלה מהרשימה או מהמפה...</p>
                             </div>
                             <button id="finish-route-btn" class="w-full btn btn-secondary mt-4 hidden shrink-0"><i class="fas fa-flag-checkered mr-2"></i>סיים והצג סיכום מסלול</button>
                        </div>
                    </div>

                    <div class="flex flex-col mt-4 pt-4 min-h-0">
                         <h3 id="suggestions-title" class="font-bold text-slate-700 mb-3 text-base sm:text-lg shrink-0">הוספת מקומות:</h3>
                         <div class="mb-4 space-y-2 sticky top-0 bg-white py-2 z-10 shrink-0">
                             <input type="search" id="search-places-input" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="🔍 חפש מקום ספציפי...">
                             <select id="category-filter-select" class="w-full p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                                 <option value="all">כל הקטגוריות</option>
                             </select>
                         </div>
                         <div id="places-list-container" class="overflow-y-auto no-scrollbar space-y-3 flex-grow">
                            <!-- Place cards will be injected here -->
                         </div>
                    </div>
                </div>
            </aside>

            <!-- Main Panel (Map / Summary) -->
            <main id="main-panel" class="flex-grow bg-slate-100 p-2 md:p-4 h-full hidden">
                <div id="map-view" class="h-full w-full relative">
                    <div id="map" class="h-full w-full rounded-2xl shadow-lg border-2 border-white"></div>
                    <button id="back-to-list-btn" class="absolute top-3 right-3 z-[1000] btn btn-primary md:hidden hidden">
                         <i class="fas fa-list-ul mr-2"></i> חזור לרשימה
                     </button>
                </div>
                
                <div id="summary-view" class="hidden h-full w-full bg-white rounded-2xl shadow-lg overflow-hidden">
                   <!-- Summary will be rendered here -->
                </div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="create-route-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">יצירת מסלול חדש</h3>
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label for="new-route-name" class="block text-sm font-semibold text-slate-600 mb-1">שם המסלול</label>
                    <input type="text" id="new-route-name" required class="w-full p-2 border rounded-md" placeholder="לדוגמה: יום כיף במנהטן">
                </div>
                <div>
                    <label for="destination-select" class="block text-sm font-semibold text-slate-600 mb-1">לאיזה יעד?</label>
                    <select id="destination-select" required class="w-full p-2 border rounded-md bg-white">
                        <option value="" disabled selected>טוען יעדים...</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-create-route" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">ביטול</button>
                    <button type="submit" class="btn btn-primary">התחל לבנות</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-2 right-2 left-2 text-center md:bottom-5 md:right-5 md:left-auto md:text-left bg-slate-800 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform translate-y-20 opacity-0 z-[100]">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    
        // --- Firebase Config (Placeholder) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & UI Elements ---
        let currentUser, tripId, tripData;
        let allPlaces = [], allHotels = [], availablePoints = [];
        let currentRoute = { name: '', destination: '', steps: [] };
        let map, summaryMap, routePolyline, routeDecorator, summaryRoutePolyline, summaryRouteDecorator, mapMarkers = new Map();
        let isMapViewVisible = false;

        const categoryIcons = {
            "מסעדה/אוכל": { icon: "fa-utensils", color: "#fb923c" },
            "מלון": { icon: "fa-hotel", color: "#8b5cf6" },
            "מוזיאון": { icon: "fa-landmark", color: "#78716c" },
            "קניון/מרכז קניות": { icon: "fa-shopping-bag", color: "#ec4899" },
            "אטרקציה": { icon: "fa-star", color: "#f59e0b" },
            "חוף": { icon: "fa-umbrella-beach", color: "#06b6d4" },
            "סיור": { icon: "fa-person-walking", color: "#10b981" },
            "סופר": { icon: "fa-shopping-cart", color: "#6366f1" },
            "default": { icon: "fa-map-marker-alt", color: "#64748b" }
        };

        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            mainContent: document.getElementById('main-content'),
            authContainer: document.getElementById('auth-container'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            allRoutesBtn: document.getElementById('all-routes-btn'),
            initialState: document.getElementById('initial-state'),
            buildingState: document.getElementById('building-state'),
            createRouteModal: document.getElementById('create-route-modal'),
            createRouteForm: document.getElementById('create-route-form'),
            createRouteBtn: document.getElementById('create-route-btn'),
            cancelCreateRouteBtn: document.getElementById('cancel-create-route'),
            destinationSelect: document.getElementById('destination-select'),
            routeTitle: document.getElementById('route-title'),
            routeDestination: document.querySelector('#route-destination span'),
            routeStepsContainer: document.getElementById('route-steps-container'),
            startPrompt: document.getElementById('start-prompt'),
            finishRouteBtn: document.getElementById('finish-route-btn'),
            suggestionsTitle: document.getElementById('suggestions-title'),
            searchPlacesInput: document.getElementById('search-places-input'),
            categoryFilterSelect: document.getElementById('category-filter-select'),
            placesListContainer: document.getElementById('places-list-container'),
            mapView: document.getElementById('map-view'),
            summaryView: document.getElementById('summary-view'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            controlsPanel: document.getElementById('controls-panel'),
            mainPanel: document.getElementById('main-panel'),
            toggleMapViewBtn: document.getElementById('toggle-map-view-btn'),
            toggleMapBtnText: document.getElementById('toggle-map-btn-text'),
            backToListBtn: document.getElementById('back-to-list-btn'),
        };
        
        // --- Initialization ---
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            if (!tripId) {
                showToast("שגיאה: לא נמצא מזהה טיול.", true);
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;
            DOM.allRoutesBtn.href = `all_routes.html?id=${tripId}`;
            
            onAuthStateChanged(auth, async (user) => {
                if (!user) { window.location.href = 'login.html'; return; }
                currentUser = user;
                DOM.authContainer.textContent = `שלום, ${user.displayName || user.email.split('@')[0]}`;
                
                try {
                    await Promise.all([ loadTripData(), loadAllPlaces(), loadAllHotels() ]);
                    populateDestinationSelect();
                    setupEventListeners();
                } catch(error) {
                    console.error("Initialization failed:", error);
                    showToast("שגיאה בטעינת נתוני הטיול.", true);
                } finally {
                    DOM.loadingOverlay.classList.add('fade-out');
                    setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
                    DOM.mainContent.classList.remove('hidden');
                    DOM.mainContent.classList.add('flex');
                }
            });
        }

        // --- Data Loading ---
        async function loadTripData() {
            const docRef = doc(db, 'trips', tripId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) tripData = docSnap.data();
            else throw new Error("Trip not found");
        }

        async function loadAllPlaces() {
            const q = query(collection(db, 'trips', tripId, 'places'));
            const snapshot = await getDocs(q);
            allPlaces = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'place' }));
        }

        async function loadAllHotels() {
            const q = query(collection(db, 'trips', tripId, 'logistics'), where("type", "==", "hotel"));
            const snapshot = await getDocs(q);
            allHotels = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'hotel', type: 'מלון' }));
        }

        function populateDestinationSelect() {
            DOM.destinationSelect.innerHTML = '<option value="" disabled selected>בחר יעד...</option>';
            if (tripData?.destinations) {
                tripData.destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest.nameHe;
                    option.textContent = dest.nameHe;
                    DOM.destinationSelect.appendChild(option);
                });
            }
        }

        // --- UI Logic & State Transitions ---
        function startRouteBuilding(routeName, destination) {
            currentRoute = { name: routeName, destination: destination, steps: [] };
            DOM.initialState.classList.add('hidden');
            DOM.buildingState.classList.remove('hidden');
            DOM.buildingState.classList.add('flex');
            DOM.summaryView.classList.add('hidden');
            
            // Ensure map is hidden on start
            if (isMapViewVisible) {
                toggleMapView();
            }
            DOM.mainPanel.classList.remove('md:w-full');


            DOM.routeTitle.textContent = routeName;
            DOM.routeDestination.textContent = destination;
            
            availablePoints = [
                ...allPlaces.filter(p => p.destination === destination),
                ...allHotels.filter(h => h.destination === destination)
            ].filter(p => p.coords);

            populateCategoryFilter();
            updateSuggestions();
            initMap('map');
            
            DOM.createRouteModal.classList.add('hidden');
            DOM.createRouteModal.classList.remove('flex');
        }

        function showSummaryView() {
            DOM.controlsPanel.classList.add('hidden');
            DOM.mainPanel.classList.remove('hidden');
            DOM.mainPanel.classList.add('md:w-full');
            DOM.mapView.classList.add('hidden');
            DOM.summaryView.classList.remove('hidden');
            renderSummary();
            // Delay map initialization to ensure container is visible and has dimensions
            setTimeout(() => {
                initMap('summary-map');
                updateMapPolyline(summaryMap, summaryRoutePolyline, summaryRouteDecorator, true);
            }, 100);
        }

        function editRoute() {
             DOM.controlsPanel.classList.remove('hidden');
             DOM.mainPanel.classList.remove('md:w-full');
             if(!isMapViewVisible) {
                DOM.mainPanel.classList.add('hidden');
             } else {
                DOM.mapView.classList.remove('hidden');
             }
             DOM.summaryView.classList.add('hidden');
             if(summaryMap) {
                 summaryMap.remove();
                 summaryMap = null;
             }
             // We might need to resize the main map
             setTimeout(() => map?.invalidateSize(), 100);
        }
        
        function populateCategoryFilter() {
            const categories = [...new Set(availablePoints.map(p => p.type || 'ללא קטגוריה'))];
            DOM.categoryFilterSelect.innerHTML = '<option value="all">כל הקטגוריות</option>';
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                DOM.categoryFilterSelect.appendChild(option);
            });
        }
        
        function toggleMapView() {
            isMapViewVisible = !isMapViewVisible;

            // Main visibility toggles
            DOM.mainPanel.classList.toggle('hidden', !isMapViewVisible);
            DOM.mapView.classList.toggle('hidden', !isMapViewVisible);
            
            // Controls panel visibility (mobile vs desktop)
            DOM.controlsPanel.classList.toggle('hidden', isMapViewVisible);
            DOM.controlsPanel.classList.toggle('md:flex', isMapViewVisible);
            
            // Controls panel width
            DOM.controlsPanel.classList.toggle('w-full', !isMapViewVisible);
            DOM.controlsPanel.classList.toggle('md:w-2/5', isMapViewVisible);
            DOM.controlsPanel.classList.toggle('lg:w-1/3', isMapViewVisible);
            
            // Back button on map for mobile
            DOM.backToListBtn.classList.toggle('hidden', !isMapViewVisible);
            DOM.backToListBtn.classList.toggle('md:hidden', !isMapViewVisible);
            
            // Update button text and icon
            const icon = DOM.toggleMapViewBtn.querySelector('i');
            if (isMapViewVisible) {
                DOM.toggleMapBtnText.textContent = 'הסתר מפה';
                icon.className = 'fas fa-list-ul mr-2 sm:mr-0';
                setTimeout(() => map?.invalidateSize(), 150); // Resize map AFTER it's visible
            } else {
                DOM.toggleMapBtnText.textContent = 'הצג מפה';
                icon.className = 'fas fa-map-location-dot';
            }
        }

        // --- Rendering ---
        function renderAvailablePoints() {
            const searchTerm = DOM.searchPlacesInput.value.toLowerCase();
            const category = DOM.categoryFilterSelect.value;
            
            const filteredPoints = availablePoints.filter(p => 
                (p.name.toLowerCase().includes(searchTerm)) && 
                (category === 'all' || p.type === category)
            );
            
            if (filteredPoints.length === 0) {
                 DOM.placesListContainer.innerHTML = `<p class="text-center text-slate-500 p-4">לא נמצאו מקומות תואמים.</p>`;
                 return;
            }

            DOM.placesListContainer.innerHTML = filteredPoints.map(createPlaceCardHTML).join('');
        }

        function createPlaceCardHTML(point) {
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const distanceText = point.distance != null ? `<span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-full">${point.distance.toFixed(1)} ק"מ</span>` : '';
            return `
                <div class="place-card bg-white border border-slate-200 rounded-lg p-3 flex items-center gap-3 cursor-pointer hover:shadow-md hover:border-indigo-400 transition-all" data-id="${point.id}">
                    <div class="flex-shrink-0 text-lg w-10 h-10 flex items-center justify-center rounded-lg" style="color: ${iconInfo.color}; background-color: ${iconInfo.color}20;"><i class="fas ${iconInfo.icon} fa-fw"></i></div>
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-slate-800 truncate">${point.name}</p>
                        <p class="text-sm text-slate-500">${point.type}</p>
                    </div>
                    ${distanceText}
                    <button class="add-point-btn bg-green-500 text-white w-8 h-8 rounded-full flex-shrink-0 hover:bg-green-600 transition transform hover:scale-110 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                </div>
            `;
        }

        function renderCurrentRoute() {
            if (currentRoute.steps.length === 0) {
                DOM.routeStepsContainer.innerHTML = '';
                DOM.startPrompt.classList.remove('hidden');
                DOM.finishRouteBtn.classList.add('hidden');
            } else {
                DOM.startPrompt.classList.add('hidden');
                DOM.finishRouteBtn.classList.remove('hidden');
                DOM.routeStepsContainer.innerHTML = currentRoute.steps.map((step, index) => {
                    const iconInfo = categoryIcons[step.type] || categoryIcons.default;
                    return `
                        <div class="route-step fade-in">
                            <div class="step-icon-wrapper">
                                <div class="step-icon text-white" style="background-color: ${iconInfo.color};"><i class="fas ${iconInfo.icon}"></i></div>
                            </div>
                            <div class="flex justify-between items-center bg-white p-3 rounded-lg shadow-sm">
                                <div>
                                    <p class="font-bold text-slate-800">${step.name}</p>
                                    <p class="text-sm text-slate-500">${index === 0 ? 'נקודת התחלה' : `תחנה ${index + 1}`}</p>
                                </div>
                                <button class="remove-step-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50" data-id="${step.id}"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            updateMapPolyline(map, routePolyline, routeDecorator, false);
        }

        function renderSummary() {
            DOM.summaryView.innerHTML = `
                <div id="summary-panel" class="flex flex-col h-full">
                    <div id="summary-details" class="bg-white p-4 md:p-6 overflow-y-auto no-scrollbar">
                        <div class="flex flex-col md:flex-row md:items-start justify-between gap-3 mb-4">
                            <div>
                                <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800">${currentRoute.name}</h2>
                                <p class="text-slate-500 font-semibold text-md md:text-lg">${currentRoute.destination}</p>
                            </div>
                            <div class="flex items-center flex-wrap justify-start gap-2 no-print">
                                <button id="edit-route-btn" class="btn btn-ghost text-sm"><i class="fas fa-pencil-alt mr-2"></i>עריכה</button>
                                <button id="print-route-btn" class="btn btn-ghost text-sm"><i class="fas fa-print mr-2"></i>הדפסה</button>
                                <button id="copy-route-btn" class="btn btn-primary text-sm"><i class="fas fa-copy mr-2"></i>העתק לוז</button>
                            </div>
                        </div>
                        <div id="summary-legend" class="border-t border-slate-200 pt-4">
                            <!-- Steps rendered here -->
                        </div>
                    </div>
                    <div id="summary-map-container" class="flex-grow w-full relative min-h-[250px]">
                        <div id="summary-map" class="h-full w-full"></div>
                    </div>
                </div>
            `;
            const legendContainer = DOM.summaryView.querySelector('#summary-legend');
            legendContainer.innerHTML = currentRoute.steps.map((step, index) => {
                const iconInfo = categoryIcons[step.type] || categoryIcons.default;
                return `
                <div class="flex items-center gap-4 py-3 border-b border-slate-100 last:border-b-0">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center">${index + 1}</div>
                    <div class="flex-shrink-0 text-lg w-10 h-10 flex items-center justify-center rounded-lg" style="color: ${iconInfo.color}; background-color: ${iconInfo.color}20;">
                        <i class="fas ${iconInfo.icon} fa-fw"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-slate-800">${step.name}</p>
                        <p class="text-sm text-slate-500">${step.type}</p>
                    </div>
                </div>`;
            }).join('');
            
            // Add listeners for new buttons
            document.getElementById('copy-route-btn').addEventListener('click', copyRouteToClipboard);
            document.getElementById('print-route-btn').addEventListener('click', () => window.print());
            document.getElementById('edit-route-btn').addEventListener('click', editRoute);
        }

        // --- Map Logic (Leaflet) ---
        function initMap(mapContainerId) {
            let targetMap = mapContainerId === 'map' ? map : summaryMap;
            if (targetMap) {
                targetMap.remove();
                targetMap = null;
            }
            
            targetMap = L.map(mapContainerId, { zoomControl: false }); // Disable default zoom, add it in a better position
            L.control.zoom({ position: 'bottomleft' }).addTo(targetMap);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(targetMap);

            if (mapContainerId === 'map') {
                map = targetMap;
                mapMarkers.forEach(marker => marker.remove());
                mapMarkers.clear();

                availablePoints.forEach(p => createMarker(p, map));
                currentRoute.steps.forEach(p => createMarker(p, map));
                
                routePolyline = L.polyline([], {color: '#ef4444', weight: 4, opacity: 0.8}).addTo(map);
                routeDecorator = L.polylineDecorator(routePolyline, {
                    patterns: [ {offset: '5%', repeat: 100, symbol: L.Symbol.arrowHead({pixelSize: 12, pathOptions: {fillOpacity: 1, weight: 0, color: '#ef4444'}})}]
                }).addTo(map);

            } else {
                summaryMap = targetMap;
                currentRoute.steps.forEach((p, index) => createMarker(p, summaryMap, index + 1));
                summaryRoutePolyline = L.polyline([], {color: '#ef4444', weight: 4, opacity: 0.8}).addTo(summaryMap);
                summaryRouteDecorator = L.polylineDecorator(summaryRoutePolyline, {
                    patterns: [ {offset: '5%', repeat: 100, symbol: L.Symbol.arrowHead({pixelSize: 12, pathOptions: {fillOpacity: 1, weight: 0, color: '#ef4444'}})}]
                }).addTo(summaryMap);
            }
            
            updateMapBounds(targetMap);
        }
        
        function createMarker(point, targetMap, label = null) {
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const markerHtml = label 
                ? `<div class="custom-marker-icon font-bold" style="background-color:${iconInfo.color}; color: white; width: 32px; height: 32px; font-size: 16px;">${label}</div>`
                : `<div class="custom-marker-icon" style="background-color:${iconInfo.color}; color: white; width: 30px; height: 30px; font-size: 14px;"><i class="fas ${iconInfo.icon}"></i></div>`;
            
            const customIcon = L.divIcon({ html: markerHtml, className: 'custom-marker-icon-wrapper', iconSize: [30, 30], iconAnchor: [15, 15] });
            const marker = L.marker([point.coords.lat, point.coords.lng], { icon: customIcon }).addTo(targetMap);
            
            if (!label) { // Only add popups to the building map
                 marker.bindPopup(`<b>${point.name}</b><br>${point.type}<br><button class="w-full text-center mt-2 p-1 bg-blue-500 text-white rounded text-sm add-point-from-popup" data-id="${point.id}">הוסף למסלול</button>`);
                 mapMarkers.set(point.id, marker);
            }
        }

        function updateMapBounds(targetMap) {
            if (!targetMap) return;
            const pointsForBounds = targetMap === map ? [...availablePoints, ...currentRoute.steps] : currentRoute.steps;
            if (pointsForBounds.length === 0) {
                 const destData = tripData.destinations.find(d => d.nameHe === currentRoute.destination);
                 if(destData?.coords) targetMap.setView([destData.coords.lat, destData.coords.lng], 12);
                 else targetMap.setView([31.7683, 35.2137], 8);
                 return;
            }
            const bounds = L.latLngBounds(pointsForBounds.map(p => [p.coords.lat, p.coords.lng]));
            if (bounds.isValid()) targetMap.fitBounds(bounds, { padding: [25, 25] });
        }

        function updateMapPolyline(targetMap, polyline, decorator) {
            if (!targetMap || !polyline) return;
            const latlngs = currentRoute.steps.map(p => [p.coords.lat, p.coords.lng]);
            polyline.setLatLngs(latlngs);
            decorator.setPaths(polyline);
            if(latlngs.length > 1) {
                targetMap.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            } else if (latlngs.length === 1) {
                targetMap.setView(latlngs[0], 14);
            }
        }
        
        // --- Core Route-Building Logic ---
        function addPointToRoute(pointId) {
            const cardElement = DOM.placesListContainer.querySelector(`.place-card[data-id="${pointId}"]`);
            if (!cardElement) return;

            const pointToAdd = availablePoints.find(p => p.id === pointId);
            if (!pointToAdd) return;
            
            currentRoute.steps.push(pointToAdd);
            availablePoints = availablePoints.filter(p => p.id !== pointId);

            renderCurrentRoute();
            updateSuggestions();
            
            const marker = mapMarkers.get(pointId);
            if(marker) {
                marker.closePopup();
                marker.unbindPopup();
                marker.bindPopup(`<b>${pointToAdd.name}</b><br><span class="font-bold text-green-600">הוסף למסלול!</span>`);
            }
        }
        
        function removePointFromRoute(pointId) {
            const pointToRemove = currentRoute.steps.find(p => p.id === pointId);
            if(!pointToRemove) return;
            
            currentRoute.steps = currentRoute.steps.filter(p => p.id !== pointId);
            availablePoints.push(pointToRemove);
            
            renderCurrentRoute();
            updateSuggestions();
            
            const marker = mapMarkers.get(pointId);
            if(marker) {
                 marker.bindPopup(`<b>${pointToRemove.name}</b><br>${pointToRemove.type}<br><button class="w-full text-center mt-2 p-1 bg-blue-500 text-white rounded text-sm add-point-from-popup" data-id="${pointToRemove.id}">הוסף למסלול</button>`);
            }
        }

        function updateSuggestions() {
            if (currentRoute.steps.length === 0) {
                DOM.suggestionsTitle.textContent = "הוספת מקומות:";
                availablePoints.forEach(p => delete p.distance);
                availablePoints.sort((a,b) => a.name.localeCompare(b.name, 'he'));
            } else {
                DOM.suggestionsTitle.textContent = "הצעות למקום הבא (הקרובים ביותר):";
                const lastPoint = currentRoute.steps[currentRoute.steps.length - 1];
                availablePoints.forEach(p => { p.distance = calculateDistance(lastPoint.coords, p.coords); });
                availablePoints.sort((a, b) => a.distance - b.distance);
            }
            renderAvailablePoints();
        }

        function calculateDistance(coords1, coords2) {
            if(!coords1 || !coords2) return Infinity;
            const R = 6371; // km
            const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;
            const dLon = (coords2.lng - coords1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function copyRouteToClipboard() {
            let message = ` маршрут *${currentRoute.name}* маршрут \n\n`;
            message += `המסלול שלנו ל*${currentRoute.destination}*:\n\n`;
            currentRoute.steps.forEach((step, index) => {
                message += `${index + 1}. 📍 *${step.name}*\n`;
                if(index < currentRoute.steps.length - 1) {
                    message += `⬇️\n`;
                }
            });
            message += `\nתהנו! ✨`;
            
            navigator.clipboard.writeText(message).then(() => {
                showToast("הלו\"ז הועתק בהצלחה!");
            }).catch(err => {
                showToast("שגיאה בהעתקה", true);
            });
        }
        
        function showToast(message, isError = false) {
            DOM.toastMessage.textContent = message;
            DOM.toast.className = `fixed bottom-2 right-2 left-2 text-center md:bottom-5 md:right-5 md:left-auto md:text-left text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform z-[100]`; // Reset
            DOM.toast.classList.add(isError ? 'bg-red-600' : 'bg-slate-800', 'translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                DOM.toast.classList.remove('translate-y-0', 'opacity-100');
                DOM.toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            DOM.createRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.remove('hidden');
                DOM.createRouteModal.classList.add('flex');
            });

            DOM.cancelCreateRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.add('hidden');
                DOM.createRouteModal.classList.remove('flex');
            });
            
            DOM.createRouteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const routeName = document.getElementById('new-route-name').value;
                const destination = DOM.destinationSelect.value;
                if(routeName && destination) startRouteBuilding(routeName, destination);
            });

            DOM.searchPlacesInput.addEventListener('input', () => renderAvailablePoints());
            DOM.categoryFilterSelect.addEventListener('change', () => renderAvailablePoints());
            
            DOM.placesListContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.place-card');
                if (!card) return;
                const id = card.dataset.id;
                if (e.target.closest('.add-point-btn')) {
                     addPointToRoute(id);
                }
            });
            
            DOM.placesListContainer.addEventListener('mouseover', e => {
                const card = e.target.closest('.place-card');
                if (card) {
                    const marker = mapMarkers.get(card.dataset.id);
                    marker?.getElement()?.classList.add('highlight');
                }
            });
             DOM.placesListContainer.addEventListener('mouseout', e => {
                const card = e.target.closest('.place-card');
                if (card) {
                    const marker = mapMarkers.get(card.dataset.id);
                    marker?.getElement()?.classList.remove('highlight');
                }
            });
            
            DOM.routeStepsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-step-btn');
                if (removeBtn) removePointFromRoute(removeBtn.dataset.id);
            });
            
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.add-point-from-popup')) {
                    addPointToRoute(e.target.dataset.id);
                    map?.closePopup();
                }
            });

            DOM.finishRouteBtn.addEventListener('click', showSummaryView);
            
            // New Listeners for Map Toggling
            DOM.toggleMapViewBtn.addEventListener('click', toggleMapView);
            DOM.backToListBtn.addEventListener('click', toggleMapView);
        }
        
        initPage();
    </script>
</body>
</html>
