<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转 住 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary-color: #4f46e5; /* indigo-600 */
            --secondary-color: #10b981; /* emerald-500 */
        }
        html, body {
            height: 100%;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }
        body { font-family: 'Assistant', sans-serif; background-color: #f8fafc; }
        .leaflet-container { font-family: 'Assistant', sans-serif; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* --- Animations --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }
        @keyframes slideInUp { from { opacity: 0; transform: translateY(100%); } to { opacity: 1; transform: translateY(0); } }
        .slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards; }
        @keyframes slideInFromRight { from { transform: translateX(100%); } to { transform: translateX(0); } }
        .slide-in-from-right { animation: slideInFromRight 0.3s ease-out forwards; }

        /* --- Custom Components --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem; /* Larger padding */
            border-radius: 0.75rem; /* More rounded */
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
        }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1); }
        .btn-primary { background-color: var(--primary-color); color: white; border: 1px solid var(--primary-color); }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background: linear-gradient(to right, #10b981, #059669); color: white; border: 1px solid var(--secondary-color); }
        .btn-secondary:hover { background: linear-gradient(to right, #059669, #10b981); }
        .btn-ghost { background-color: white; color: #475569; border: 1px solid #cbd5e1; }
        .btn-ghost:hover { background-color: #f8fafc; color: #1e293b; border-color: #94a3b8;}

        /* Route Building Step Timeline */
        .route-step {
            position: relative;
            padding-right: 3.5rem;
            padding-bottom: 1rem;
            min-height: 60px;
        }
        .route-step:not(:last-child)::before {
            content: '';
            position: absolute;
            top: 40px;
            right: 19px;
            width: 2px;
            height: calc(100%);
            background-color: #e2e8f0;
        }
        .step-icon-wrapper {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            z-index: 10;
        }
        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .step-content {
            background-color: white;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
            border: 1px solid #e2e8f0;
            transition: all 0.2s ease;
        }
        .step-content:hover {
             border-color: var(--primary-color);
             transform: translateX(-5px);
        }

        /* Map Marker Styling */
        .custom-marker-icon-wrapper { z-index: 500; }
        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
        }
        .custom-marker-icon.highlight {
            transform: scale(1.5);
            z-index: 1000 !important;
        }
        
        /* Print Styles */
        @media print {
            body * { visibility: hidden; }
            #summary-panel, #summary-panel * { visibility: visible; }
            #summary-panel { position: absolute; left: 0; top: 0; width: 100%; height: auto; display: block; }
            #summary-map-container { height: 400px !important; width: 100%; page-break-after: always; }
            #summary-details { margin: 0; padding: 0; overflow-y: visible; }
            .no-print { display: none !important; }
        }
    </style>
</head>
<body class="h-full w-full">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-route text-5xl text-indigo-600 animate-pulse"></i>
        <p class="text-xl font-bold text-slate-700">注 转...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="h-full flex flex-col hidden">
        <header class="bg-white shadow-sm z-30 border-b border-slate-200 shrink-0">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-auto md:h-16 flex flex-wrap items-center justify-between gap-y-2 py-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <i class="fas fa-route text-2xl text-indigo-600"></i>
                    <h1 class="text-lg sm:text-xl font-bold text-slate-800">转 住 </h1>
                </div>
                 <div class="flex items-center gap-1 sm:gap-2">
                     <a id="all-routes-btn" href="#" class="btn btn-ghost text-sm p-2 sm:p-2 sm:px-3" title=" 住 砖专">
                         <i class="fas fa-list-ul"></i>
                         <span class="hidden sm:inline mr-2"> 住</span>
                     </a>
                      <a id="back-to-trip-btn" href="#" class="btn btn-ghost text-sm p-2 sm:p-2 sm:px-3" title="专 专 ">
                         <i class="fas fa-arrow-left"></i>
                         <span class="hidden sm:inline mr-2">专 </span>
                     </a>
                     <div id="auth-container" class="text-xs sm:text-sm font-semibold text-slate-600 bg-slate-100 px-2 sm:px-3 py-2 rounded-lg"></div>
                 </div>
            </div>
        </header>

        <!-- Main container for layout -->
        <div class="flex-grow overflow-y-auto no-scrollbar">
            <!-- Initial State -->
            <div id="initial-state" class="text-center p-4 sm:p-8 flex-grow flex flex-col items-center justify-center h-full">
                <i class="fas fa-magic-wand-sparkles text-4xl sm:text-5xl text-indigo-400 mb-6"></i>
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800"> 转 住?</h2>
                <p class="text-slate-500 mt-2 text-sm sm:text-base">转 爪专转 住 砖  转 转  砖.</p>
                <button id="create-route-btn" class="mt-8 btn btn-primary w-full max-w-sm text-lg">
                    <i class="fas fa-plus ml-2"></i> 爪专 住 砖
                </button>
            </div>

            <!-- Building State -->
            <div id="building-state" class="hidden p-3 sm:p-4 md:p-6 lg:max-w-4xl lg:mx-auto">
                <div class="space-y-1 mb-6 bg-white p-4 rounded-xl shadow-md border border-slate-200">
                    <h2 id="route-title" class="text-2xl sm:text-3xl font-bold text-slate-800"></h2>
                    <p id="route-destination" class="text-slate-500 font-semibold flex items-center gap-2 text-lg"><i class="fas fa-map-pin"></i> <span></span></p>
                </div>
                
                <div class="bg-slate-50/50 rounded-xl p-3 sm:p-4 min-h-[200px] border">
                     <h3 class="font-bold text-slate-700 mb-4 text-lg sm:text-xl">转转 住:</h3>
                     <div id="route-steps-container">
                         <div id="start-prompt" class="text-center text-slate-500 p-8">
                             <i class="fas fa-box-open text-4xl text-slate-400 mb-4"></i>
                             <p class="font-semibold text-lg">住 砖 专拽</p>
                             <p class="text-sm">住祝 转 转 专砖  转!</p>
                         </div>
                     </div>
                </div>

                <div class="my-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="open-add-place-modal-btn" class="w-full btn btn-secondary text-base"><i class="fas fa-plus ml-2"></i>住祝 拽 住</button>
                    <button id="open-map-modal-btn" class="w-full btn btn-ghost text-base"><i class="fas fa-map-marked-alt ml-2"></i>专 拽 驻</button>
                </div>
                                
                <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                    <button id="finish-route-btn" class="w-full max-w-md btn btn-primary text-lg hidden">
                        <i class="fas fa-flag-checkered ml-2"></i>砖专 爪 住 住
                    </button>
                </div>
            </div>
            
            <!-- Summary View -->
            <div id="summary-view" class="hidden h-full w-full bg-white">
                <!-- Summary will be rendered here -->
            </div>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="create-route-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">爪专转 住 砖</h3>
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label for="new-route-name" class="block text-sm font-semibold text-slate-600 mb-1">砖 住</label>
                    <input type="text" id="new-route-name" required class="w-full p-2 border rounded-md" placeholder=":  祝 ">
                </div>
                <div>
                    <label for="destination-select" class="block text-sm font-semibold text-slate-600 mb-1"> 注?</label>
                    <select id="destination-select" required class="w-full p-2 border rounded-md bg-white">
                        <option value="" disabled selected>注 注...</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-create-route" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300"></button>
                    <button type="submit" class="btn btn-primary">转 转</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="add-place-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-2 sm:p-4">
        <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col slide-in-up">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between shrink-0">
                <h3 class="text-xl font-bold text-slate-800">住驻转 拽 住</h3>
                <button id="close-add-place-modal-btn" class="w-8 h-8 rounded-full hover:bg-slate-200 text-slate-600"><i class="fas fa-times"></i></button>
            </div>
            <div class="p-4 space-y-3 shrink-0">
                 <input type="search" id="modal-search-input" class="w-full p-2 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder=" 驻砖 拽 住驻爪驻...">
                 <select id="modal-category-filter" class="w-full p-2 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                     <option value="all"> 拽专转</option>
                 </select>
            </div>
            <div id="modal-places-list-container" class="overflow-y-auto no-scrollbar p-4 pt-0 space-y-2 flex-grow">
                 <!-- Place cards will be injected here -->
            </div>
        </div>
    </div>
    
    <!-- Map Selection Modal -->
    <div id="map-selection-modal" class="fixed inset-0 bg-slate-800 z-[70] hidden flex-col slide-in-from-right">
        <div class="bg-white p-3 flex items-center justify-between shrink-0 shadow-md">
            <h3 class="text-lg font-bold text-slate-800">专 拽 驻</h3>
            <button id="close-map-modal-btn" class="w-9 h-9 rounded-lg hover:bg-slate-200 text-slate-600 flex items-center justify-center"><i class="fas fa-times text-lg"></i></button>
        </div>
        <div id="map-modal-container" class="flex-grow"></div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 right-4 left-4 sm:left-auto text-center sm:text-left bg-slate-800 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform translate-y-20 opacity-0 z-[100]">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    
        // --- Firebase Config (Placeholder) ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & UI Elements ---
        let currentUser, tripId, tripData;
        let allPlaces = [], allHotels = [], availablePoints = [];
        let currentRoute = { name: '', destination: '', steps: [] };
        let isFirstAdd = true;
        let map, summaryMap, routePolyline, routeDecorator, mapMarkers = new Map();

        const categoryIcons = {
            "住注/": { icon: "fa-utensils", color: "#fb923c" },
            "": { icon: "fa-hotel", color: "#8b5cf6" },
            "": { icon: "fa-landmark", color: "#78716c" },
            "拽/专 拽转": { icon: "fa-shopping-bag", color: "#ec4899" },
            "专拽爪": { icon: "fa-star", color: "#f59e0b" },
            "祝": { icon: "fa-umbrella-beach", color: "#06b6d4" },
            "住专": { icon: "fa-person-walking", color: "#10b981" },
            "住驻专": { icon: "fa-shopping-cart", color: "#6366f1" },
            "default": { icon: "fa-map-marker-alt", color: "#64748b" }
        };

        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            mainContent: document.getElementById('main-content'),
            authContainer: document.getElementById('auth-container'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            allRoutesBtn: document.getElementById('all-routes-btn'),
            initialState: document.getElementById('initial-state'),
            buildingState: document.getElementById('building-state'),
            createRouteModal: document.getElementById('create-route-modal'),
            createRouteForm: document.getElementById('create-route-form'),
            createRouteBtn: document.getElementById('create-route-btn'),
            cancelCreateRouteBtn: document.getElementById('cancel-create-route'),
            destinationSelect: document.getElementById('destination-select'),
            routeTitle: document.getElementById('route-title'),
            routeDestination: document.querySelector('#route-destination span'),
            routeStepsContainer: document.getElementById('route-steps-container'),
            startPrompt: document.getElementById('start-prompt'),
            finishRouteBtn: document.getElementById('finish-route-btn'),
            summaryView: document.getElementById('summary-view'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            addPlaceModal: document.getElementById('add-place-modal'),
            openAddPlaceModalBtn: document.getElementById('open-add-place-modal-btn'),
            closeAddPlaceModalBtn: document.getElementById('close-add-place-modal-btn'),
            modalSearchInput: document.getElementById('modal-search-input'),
            modalCategoryFilter: document.getElementById('modal-category-filter'),
            modalPlacesListContainer: document.getElementById('modal-places-list-container'),
            // Map Modal elements
            mapSelectionModal: document.getElementById('map-selection-modal'),
            openMapModalBtn: document.getElementById('open-map-modal-btn'),
            closeMapModalBtn: document.getElementById('close-map-modal-btn'),
            mapModalContainer: document.getElementById('map-modal-container'),
        };
        
        // --- Initialization ---
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            if (!tripId) {
                showToast("砖:  爪  .", true);
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;
            DOM.allRoutesBtn.href = `all_routes.html?id=${tripId}`;
            
            onAuthStateChanged(auth, async (user) => {
                if (!user) { window.location.href = 'login.html'; return; }
                currentUser = user;
                DOM.authContainer.textContent = `砖, ${user.displayName || user.email.split('@')[0]}`;
                
                try {
                    await Promise.all([ loadTripData(), loadAllPlaces(), loadAllHotels() ]);
                    populateDestinationSelect();
                    setupEventListeners();
                } catch(error) {
                    console.error("Initialization failed:", error);
                    showToast("砖 注转 转 .", true);
                } finally {
                    DOM.loadingOverlay.classList.add('fade-out');
                    setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
                    DOM.mainContent.classList.remove('hidden');
                    DOM.mainContent.classList.add('flex');
                }
            });
        }

        // --- Data Loading ---
        async function loadTripData() {
            const docRef = doc(db, 'trips', tripId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) tripData = docSnap.data();
            else throw new Error("Trip not found");
        }

        async function loadAllPlaces() {
            const q = query(collection(db, 'trips', tripId, 'places'));
            const snapshot = await getDocs(q);
            allPlaces = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'place' }));
        }

        async function loadAllHotels() {
            const q = query(collection(db, 'trips', tripId, 'logistics'), where("type", "==", "hotel"));
            const snapshot = await getDocs(q);
            allHotels = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'hotel', type: '' }));
        }

        function populateDestinationSelect() {
            DOM.destinationSelect.innerHTML = '<option value="" disabled selected>专 注...</option>';
            if (tripData?.destinations) {
                tripData.destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest.nameHe;
                    option.textContent = dest.nameHe;
                    DOM.destinationSelect.appendChild(option);
                });
            }
        }

        // --- UI Logic & State Transitions ---
        function startRouteBuilding(routeName, destination) {
            currentRoute = { name: routeName, destination: destination, steps: [] };
            isFirstAdd = true;
            DOM.initialState.classList.add('hidden');
            DOM.buildingState.classList.remove('hidden');
            DOM.summaryView.classList.add('hidden');

            DOM.routeTitle.textContent = routeName;
            DOM.routeDestination.textContent = destination;
            
            availablePoints = [
                ...allPlaces.filter(p => p.destination === destination),
                ...allHotels.filter(h => h.destination === destination)
            ].filter(p => p.coords);

            populateCategoryFilter(DOM.modalCategoryFilter);
            
            DOM.createRouteModal.classList.add('hidden');
            DOM.createRouteModal.classList.remove('flex');
            renderCurrentRoute();
        }

        function showSummaryView() {
            DOM.buildingState.classList.add('hidden');
            DOM.summaryView.classList.remove('hidden');
            renderSummary();
            // Delay map initialization to ensure container is visible and has dimensions
            setTimeout(() => {
                initMap('summary-map');
            }, 100);
        }

        function editRoute() {
             DOM.buildingState.classList.remove('hidden');
             DOM.summaryView.classList.add('hidden');
             if(summaryMap) {
                 summaryMap.remove();
                 summaryMap = null;
             }
        }
        
        function populateCategoryFilter(selectElement) {
            const categories = [...new Set(availablePoints.map(p => p.type || ' 拽专'))];
            selectElement.innerHTML = '<option value="all"> 拽专转</option>';
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }
        
        function openAddPlaceModal() {
            renderModalPlacesList();
            DOM.addPlaceModal.classList.remove('hidden');
            DOM.addPlaceModal.classList.add('flex');
        }
        
        function openMapModal() {
            DOM.mapSelectionModal.classList.remove('hidden');
            DOM.mapSelectionModal.classList.add('flex');
            // Init map after the modal is visible
            setTimeout(() => {
                initMap('map-modal-container');
            }, 50);
        }

        function closeMapModal() {
            DOM.mapSelectionModal.classList.add('hidden');
            DOM.mapSelectionModal.classList.remove('flex');
            if (map) {
                map.remove();
                map = null;
            }
        }

        // --- Rendering ---
        function renderModalPlacesList() {
            const searchTerm = DOM.modalSearchInput.value.toLowerCase();
            const category = DOM.modalCategoryFilter.value;
            
            const filteredPoints = availablePoints.filter(p => 
                (p.name.toLowerCase().includes(searchTerm)) && 
                (category === 'all' || p.type === category)
            );

            if (filteredPoints.length === 0) {
                DOM.modalPlacesListContainer.innerHTML = `<p class="text-center text-slate-500 p-4"> 爪 拽转 转.</p>`;
                return;
            }

            let html = '';
            if (isFirstAdd && category === 'all' && !searchTerm) {
                const categories = [...new Set(filteredPoints.map(p => p.type || ' 拽专'))].sort();
                categories.forEach(cat => {
                    html += `<h4 class="font-bold text-slate-600 bg-slate-200 p-2 rounded sticky top-0 z-10">${cat}</h4>`;
                    html += filteredPoints.filter(p => (p.type || ' 拽专') === cat)
                                        .sort((a,b) => a.name.localeCompare(b.name, 'he'))
                                        .map(createPlaceCardHTML)
                                        .join('');
                });
            } else {
                if (!isFirstAdd) {
                    const lastPoint = currentRoute.steps[currentRoute.steps.length - 1];
                    filteredPoints.forEach(p => { p.distance = calculateDistance(lastPoint.coords, p.coords); });
                    filteredPoints.sort((a, b) => a.distance - b.distance);
                } else {
                    filteredPoints.sort((a,b) => a.name.localeCompare(b.name, 'he'));
                }
                html = filteredPoints.map(createPlaceCardHTML).join('');
            }
            DOM.modalPlacesListContainer.innerHTML = html;
        }


        function createPlaceCardHTML(point) {
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const distanceText = point.distance != null ? `<span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-full">${point.distance.toFixed(1)} 拽"</span>` : '';
            return `
                <div class="place-card bg-white border border-slate-200 rounded-lg p-3 flex items-center gap-3 cursor-pointer hover:shadow-md hover:border-indigo-400 transition-all" data-id="${point.id}">
                    <div class="flex-shrink-0 text-lg w-10 h-10 flex items-center justify-center rounded-lg" style="color: ${iconInfo.color}; background-color: ${iconInfo.color}20;"><i class="fas ${iconInfo.icon} fa-fw"></i></div>
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-slate-800 truncate">${point.name}</p>
                        <p class="text-sm text-slate-500">${point.type}</p>
                    </div>
                    ${distanceText}
                    <button class="add-point-btn bg-green-500 text-white w-8 h-8 rounded-full flex-shrink-0 hover:bg-green-600 transition transform hover:scale-110 flex items-center justify-center"><i class="fas fa-plus"></i></button>
                </div>
            `;
        }

        function renderCurrentRoute() {
            if (currentRoute.steps.length === 0) {
                DOM.routeStepsContainer.innerHTML = '';
                DOM.startPrompt.classList.remove('hidden');
                DOM.finishRouteBtn.classList.add('hidden');
            } else {
                DOM.startPrompt.classList.add('hidden');
                DOM.finishRouteBtn.classList.remove('hidden');
                DOM.routeStepsContainer.innerHTML = currentRoute.steps.map((step, index) => {
                    const iconInfo = categoryIcons[step.type] || categoryIcons.default;
                    return `
                        <div class="route-step fade-in">
                            <div class="step-icon-wrapper">
                                <div class="step-icon text-white" style="background-color: ${iconInfo.color};"><i class="fas ${iconInfo.icon}"></i></div>
                            </div>
                            <div class="step-content flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-slate-800">${step.name}</p>
                                    <p class="text-sm text-slate-500">${index === 0 ? '拽转 转' : `转 ${index + 1}`}</p>
                                </div>
                                <button class="remove-step-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50" data-id="${step.id}"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderSummary() {
            DOM.summaryView.innerHTML = `
                <div id="summary-panel" class="flex flex-col h-full">
                    <div id="summary-details" class="bg-white p-4 md:p-6 overflow-y-auto no-scrollbar">
                        <div class="flex flex-col md:flex-row md:items-start justify-between gap-3 mb-4">
                            <div>
                                <h2 class="text-2xl md:text-3xl font-extrabold text-slate-800">${currentRoute.name}</h2>
                                <p class="text-slate-500 font-semibold text-md md:text-lg">${currentRoute.destination}</p>
                            </div>
                            <div class="flex items-center flex-wrap justify-start gap-2 no-print">
                                <button id="edit-route-btn" class="btn btn-ghost text-sm"><i class="fas fa-pencil-alt ml-2"></i>注专</button>
                                <button id="print-route-btn" class="btn btn-ghost text-sm"><i class="fas fa-print ml-2"></i>驻住</button>
                                <button id="copy-route-btn" class="btn btn-primary text-sm"><i class="fas fa-copy ml-2"></i>注转拽 </button>
                            </div>
                        </div>
                        <div id="summary-legend" class="border-t border-slate-200 pt-4">
                            <!-- Steps rendered here -->
                        </div>
                    </div>
                    <div id="summary-map-container" class="flex-grow w-full relative min-h-[300px]">
                        <div id="summary-map" class="h-full w-full"></div>
                    </div>
                </div>
            `;
            const legendContainer = DOM.summaryView.querySelector('#summary-legend');
            legendContainer.innerHTML = currentRoute.steps.map((step, index) => {
                const iconInfo = categoryIcons[step.type] || categoryIcons.default;
                return `
                <div class="flex items-center gap-4 py-3 border-b border-slate-100 last:border-b-0">
                    <div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center">${index + 1}</div>
                    <div class="flex-shrink-0 text-lg w-10 h-10 flex items-center justify-center rounded-lg" style="color: ${iconInfo.color}; background-color: ${iconInfo.color}20;">
                        <i class="fas ${iconInfo.icon} fa-fw"></i>
                    </div>
                    <div class="flex-grow">
                        <p class="font-bold text-slate-800">${step.name}</p>
                        <p class="text-sm text-slate-500">${step.type}</p>
                    </div>
                </div>`;
            }).join('');
            
            document.getElementById('copy-route-btn').addEventListener('click', copyRouteToClipboard);
            document.getElementById('print-route-btn').addEventListener('click', () => window.print());
            document.getElementById('edit-route-btn').addEventListener('click', editRoute);
        }

        // --- Map Logic (Leaflet) ---
        function initMap(mapContainerId) {
            const isSummary = mapContainerId === 'summary-map';
            let targetMap = isSummary ? summaryMap : map;

            if (targetMap) {
                targetMap.remove();
                targetMap = null;
            }
            
            targetMap = L.map(mapContainerId, { zoomControl: false });
            L.control.zoom({ position: 'bottomleft' }).addTo(targetMap);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(targetMap);

            if (isSummary) {
                summaryMap = targetMap;
                currentRoute.steps.forEach((p, index) => createMarker(p, summaryMap, index + 1));
            } else {
                map = targetMap;
                mapMarkers.forEach(marker => marker.remove());
                mapMarkers.clear();
                availablePoints.forEach(p => createMarker(p, map));
            }
            
            updateMapPolyline(targetMap);
            updateMapBounds(targetMap);
        }
        
        function createMarker(point, targetMap, label = null) {
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const markerHtml = label 
                ? `<div class="custom-marker-icon font-bold" style="background-color:${iconInfo.color}; color: white; width: 32px; height: 32px; font-size: 16px;">${label}</div>`
                : `<div class="custom-marker-icon" style="background-color:${iconInfo.color}; color: white; width: 30px; height: 30px; font-size: 14px;"><i class="fas ${iconInfo.icon}"></i></div>`;
            
            const customIcon = L.divIcon({ html: markerHtml, className: 'custom-marker-icon-wrapper', iconSize: [30, 30], iconAnchor: [15, 15] });
            const marker = L.marker([point.coords.lat, point.coords.lng], { icon: customIcon }).addTo(targetMap);
            
            if (!label) { 
                 marker.bindPopup(`<b>${point.name}</b><br>${point.type}<br><button class="w-full text-center mt-2 p-1 bg-blue-500 text-white rounded text-sm add-point-from-popup" data-id="${point.id}">住祝 住</button>`);
                 mapMarkers.set(point.id, marker);
            }
        }

        function updateMapBounds(targetMap) {
            if (!targetMap) return;
            const isSummary = targetMap === summaryMap;
            const pointsForBounds = isSummary ? currentRoute.steps : availablePoints;
            if (pointsForBounds.length === 0) {
                 const destData = tripData.destinations.find(d => d.nameHe === currentRoute.destination);
                 if(destData?.coords) targetMap.setView([destData.coords.lat, destData.coords.lng], 12);
                 else targetMap.setView([31.7683, 35.2137], 8);
                 return;
            }
            const bounds = L.latLngBounds(pointsForBounds.map(p => [p.coords.lat, p.coords.lng]));
            if (bounds.isValid()) targetMap.fitBounds(bounds, { padding: [40, 40] });
        }

        function updateMapPolyline(targetMap) {
            if (!targetMap) return;
            
            const polyline = L.polyline([], {color: '#ef4444', weight: 4, opacity: 0.8}).addTo(targetMap);
            const decorator = L.polylineDecorator(polyline, {
                patterns: [ {offset: '5%', repeat: 100, symbol: L.Symbol.arrowHead({pixelSize: 12, pathOptions: {fillOpacity: 1, weight: 0, color: '#ef4444'}})}]
            }).addTo(targetMap);
            
            const latlngs = currentRoute.steps.map(p => [p.coords.lat, p.coords.lng]);
            polyline.setLatLngs(latlngs);
            decorator.setPaths(polyline);

            if(latlngs.length > 1) {
                targetMap.fitBounds(polyline.getBounds(), {padding: [50, 50]});
            } else if (latlngs.length === 1) {
                targetMap.setView(latlngs[0], 14);
            }
        }
        
        // --- Core Route-Building Logic ---
        function addPointToRoute(pointId) {
            const pointToAdd = availablePoints.find(p => p.id === pointId);
            if (!pointToAdd) return;
            
            currentRoute.steps.push(pointToAdd);
            availablePoints = availablePoints.filter(p => p.id !== pointId);
            isFirstAdd = false;

            renderCurrentRoute();
            
            DOM.addPlaceModal.classList.add('hidden');
            DOM.addPlaceModal.classList.remove('flex');
            closeMapModal();
            showToast(`"${pointToAdd.name}" 住祝 住!`);
        }
        
        function removePointFromRoute(pointId) {
            const pointToRemove = currentRoute.steps.find(p => p.id === pointId);
            if(!pointToRemove) return;
            
            currentRoute.steps = currentRoute.steps.filter(p => p.id !== pointId);
            availablePoints.push(pointToRemove);
            
            if (currentRoute.steps.length === 0) {
                isFirstAdd = true;
            }
            
            renderCurrentRoute();
            showToast(`"${pointToRemove.name}" 住专 住.`);
        }

        function calculateDistance(coords1, coords2) {
            if(!coords1 || !coords2) return Infinity;
            const R = 6371; // km
            const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;
            const dLon = (coords2.lng - coords1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function copyRouteToClipboard() {
            let message = `*" : ${currentRoute.name}*\n\n`;
            message += `住 砖 *${currentRoute.destination}*:\n\n`;
            currentRoute.steps.forEach((step, index) => {
                message += `${index + 1}.  *${step.name}*\n`;
                if(index < currentRoute.steps.length - 1) {
                    message += `猬锔\n`;
                }
            });
            message += `\n转! `;
            
            navigator.clipboard.writeText(message).then(() => {
                showToast("\" 注转拽 爪!");
            }).catch(err => {
                showToast("砖 注转拽", true);
            });
        }
        
        function showToast(message, isError = false) {
            DOM.toastMessage.textContent = message;
            DOM.toast.className = `fixed bottom-4 right-4 left-4 sm:left-auto text-center sm:text-left text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform z-[100]`; // Reset
            DOM.toast.classList.add(isError ? 'bg-red-600' : 'bg-slate-800', 'translate-y-0', 'opacity-100');
            
            setTimeout(() => {
                DOM.toast.classList.remove('translate-y-0', 'opacity-100');
                DOM.toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            DOM.createRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.remove('hidden');
                DOM.createRouteModal.classList.add('flex');
            });

            DOM.cancelCreateRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.add('hidden');
                DOM.createRouteModal.classList.remove('flex');
            });
            
            DOM.createRouteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const routeName = document.getElementById('new-route-name').value;
                const destination = DOM.destinationSelect.value;
                if(routeName && destination) startRouteBuilding(routeName, destination);
            });
            
            DOM.openAddPlaceModalBtn.addEventListener('click', openAddPlaceModal);
            DOM.closeAddPlaceModalBtn.addEventListener('click', () => {
                DOM.addPlaceModal.classList.add('hidden');
                DOM.addPlaceModal.classList.remove('flex');
            });
            
            // Map Modal Listeners
            DOM.openMapModalBtn.addEventListener('click', openMapModal);
            DOM.closeMapModalBtn.addEventListener('click', closeMapModal);

            DOM.modalSearchInput.addEventListener('input', () => renderModalPlacesList());
            DOM.modalCategoryFilter.addEventListener('change', () => renderModalPlacesList());

            DOM.modalPlacesListContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.place-card');
                if (!card) return;
                if (e.target.closest('.add-point-btn')) {
                     addPointToRoute(card.dataset.id);
                }
            });
            
             DOM.modalPlacesListContainer.addEventListener('mouseover', e => {
                 const card = e.target.closest('.place-card');
                 if (card && map) { // Check if map exists
                     const marker = mapMarkers.get(card.dataset.id);
                     marker?.getElement()?.classList.add('highlight');
                 }
             });
              DOM.modalPlacesListContainer.addEventListener('mouseout', e => {
                 const card = e.target.closest('.place-card');
                 if (card && map) { // Check if map exists
                     const marker = mapMarkers.get(card.dataset.id);
                     marker?.getElement()?.classList.remove('highlight');
                 }
             });
            
            DOM.routeStepsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-step-btn');
                if (removeBtn) removePointFromRoute(removeBtn.dataset.id);
            });
            
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.add-point-from-popup')) {
                    addPointToRoute(e.target.dataset.id);
                }
            });

            DOM.finishRouteBtn.addEventListener('click', showSummaryView);
        }
        
        initPage();
    </script>
</body>
</html>

