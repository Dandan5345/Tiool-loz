<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>בניית מסלול חכם</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#4f46e5', hover: '#4338ca', light: '#eef2ff' },
                        secondary: { DEFAULT: '#10b981', hover: '#059669' },
                    },
                    fontFamily: {
                        sans: ['Assistant', 'sans-serif'],
                    },
                    boxShadow: {
                        'soft': '0 4px 20px -2px rgba(0, 0, 0, 0.05)',
                        'up': '0 -4px 20px -2px rgba(0, 0, 0, 0.05)',
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        html, body {
            height: 100dvh; /* שיפור למובייל */
            width: 100%;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            -webkit-user-select: none;
            user-select: none;
        }

        /* אפשור טקסט בשדות קלט */
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
            font-size: 16px; /* מניעת זום באייפון */
        }

        /* הסתרת פס גלילה אבל השארת יכולת גלילה */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* אנימציות */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* כפתורים */
        .btn {
            @apply inline-flex items-center justify-center rounded-xl font-bold transition-all active:scale-95 disabled:opacity-50 disabled:pointer-events-none;
        }
        
        /* ציר זמן משופר */
        .timeline-line {
            position: absolute;
            top: 3.5rem;
            bottom: -1rem;
            right: 1.5rem;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }
        .route-step:last-child .timeline-line { display: none; }

        /* עיצוב כרטיס תחנה */
        .route-step {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .route-step.dragging {
            opacity: 0.8;
            transform: scale(1.02);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 8px 10px -6px rgba(0, 0, 0, 0.1);
            z-index: 50;
            background: #fff;
            border-color: #4f46e5;
        }
        .drag-over-item {
            border-top: 2px solid #4f46e5;
            margin-top: 5px;
        }

        /* מפות */
        .leaflet-container { font-family: 'Assistant', sans-serif; z-index: 0; }
        
        /* סמן מפה מותאם */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .custom-marker:hover { transform: scale(1.1); z-index: 1000 !important; }

        /* Modal Bottom Sheet Style for Mobile */
        @media (max-width: 640px) {
            .modal-content {
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                max-height: 90dvh;
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                width: 100%;
            }
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- מסך טעינה -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-md z-[100] flex flex-col items-center justify-center gap-4 transition-opacity duration-300">
        <div class="relative">
            <div class="w-16 h-16 border-4 border-indigo-200 border-t-indigo-600 rounded-full animate-spin"></div>
            <i class="fas fa-route absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-indigo-600 text-xl"></i>
        </div>
        <p class="text-lg font-bold text-slate-700 animate-pulse">מכין את המסלול...</p>
    </div>

    <!-- Header ראשי -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm border-b border-slate-100 z-40 shrink-0 pt-[env(safe-area-inset-top)]">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="bg-indigo-100 p-2 rounded-lg text-indigo-600">
                    <i class="fas fa-map-location-dot text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-bold text-slate-800 leading-tight">בניית מסלול</h1>
                    <div id="auth-container" class="text-xs text-slate-500 font-medium">אורח</div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                 <a id="back-to-trip-btn" href="#" class="btn w-9 h-9 bg-slate-100 text-slate-600 hover:bg-slate-200 rounded-full">
                    <i class="fas fa-arrow-left"></i>
                </a>
            </div>
        </div>
    </header>

    <!-- תוכן ראשי -->
    <main id="main-content" class="flex-grow overflow-hidden relative flex flex-col hidden">
        
        <!-- מצב התחלתי -->
        <div id="initial-state" class="flex-grow flex flex-col items-center justify-center p-6 text-center animate-fade-in">
            <div class="bg-indigo-50 w-24 h-24 rounded-full flex items-center justify-center mb-6 shadow-inner">
                <i class="fas fa-wand-magic-sparkles text-4xl text-indigo-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">מתכננים את הטיול המושלם</h2>
            <p class="text-slate-500 max-w-xs mx-auto mb-8">צור מסלול חדש, הוסף אטרקציות וסדר אותן בקלות.</p>
            <button id="create-route-btn" class="btn bg-indigo-600 text-white px-8 py-4 text-lg shadow-lg shadow-indigo-200 hover:bg-indigo-700 w-full max-w-xs">
                <i class="fas fa-plus ml-2"></i>
                יצירת מסלול חדש
            </button>
        </div>

        <!-- מצב עריכת מסלול -->
        <div id="building-state" class="hidden flex flex-col h-full">
            
            <!-- פרטי מסלול (סטטי למעלה) -->
            <div class="bg-white px-4 py-3 border-b border-slate-100 shrink-0 flex items-center justify-between shadow-sm z-10">
                <div>
                    <h2 id="route-title" class="text-xl font-bold text-slate-800 truncate max-w-[200px]"></h2>
                    <div class="flex items-center text-xs text-slate-500 mt-0.5">
                        <i class="fas fa-location-dot ml-1 text-indigo-500"></i>
                        <span id="route-destination"></span>
                    </div>
                </div>
                <div class="flex gap-2">
                    <button id="organize-route-btn" class="btn bg-amber-50 text-amber-600 p-2 rounded-lg text-sm border border-amber-100" title="סדר לפי מרחק">
                        <i class="fas fa-sort-amount-down"></i>
                    </button>
                     <button id="toggle-map-view" class="btn bg-indigo-50 text-indigo-600 p-2 rounded-lg text-sm border border-indigo-100 md:hidden">
                        <i class="fas fa-map"></i>
                    </button>
                </div>
            </div>

            <!-- אזור גלילה לתחנות -->
            <div class="flex-grow overflow-y-auto overflow-x-hidden p-4 bg-slate-50 relative no-scrollbar" id="steps-scroll-area">
                <div id="route-steps-container" class="space-y-0 pb-24">
                    <!-- התחנות יוכנסו כאן דינמית -->
                </div>
                
                <!-- הודעה כשהמסלול ריק -->
                <div id="start-prompt" class="absolute inset-0 flex flex-col items-center justify-center text-slate-400 pointer-events-none">
                    <i class="fas fa-route text-6xl mb-4 opacity-20"></i>
                    <p>המסלול ריק, בואו נתחיל להוסיף!</p>
                </div>
            </div>

            <!-- סרגל כלים תחתון (Sticky Footer) -->
            <div class="bg-white border-t border-slate-200 p-3 pb-[calc(env(safe-area-inset-bottom)+0.75rem)] shadow-up shrink-0 z-20">
                <div class="grid grid-cols-2 gap-3 mb-3">
                    <button id="open-add-place-modal-btn" class="btn bg-indigo-600 text-white py-3 shadow-lg shadow-indigo-100 active:scale-95">
                        <i class="fas fa-plus ml-2"></i> הוסף מקום
                    </button>
                    <button id="save-route-btn" class="btn bg-slate-800 text-white py-3 shadow-lg shadow-slate-200 active:scale-95">
                        <i class="fas fa-save ml-2"></i> שמירה
                    </button>
                </div>
                <div class="flex justify-between items-center px-2">
                     <div class="flex items-center gap-2">
                        <label class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="is-public-toggle" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                            <span class="mr-2 text-xs font-medium text-slate-600">פומבי</span>
                        </label>
                    </div>
                    <button id="open-add-other-btn" class="text-xs text-slate-500 underline decoration-dotted">הוסף הערה חופשית</button>
                </div>
            </div>
        </div>

        <!-- תצוגת סיכום -->
        <div id="summary-view" class="hidden flex flex-col h-full bg-white">
             <!-- יוזרק ב-JS -->
        </div>

    </main>

    <!-- מודלים (Modals) -->

    <!-- מודל יצירת מסלול -->
    <div id="create-route-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-50 hidden items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-md p-6 modal-content rounded-t-3xl sm:rounded-2xl shadow-2xl slide-up">
            <div class="w-12 h-1 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="text-2xl font-bold text-slate-800 mb-1">יצירת מסלול חדש</h3>
            <p class="text-slate-500 mb-6 text-sm">תן שם למסלול ובחר יעד כדי להתחיל.</p>
            
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1.5">שם המסלול</label>
                    <input type="text" id="new-route-name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="לדוגמה: יום כיף בתל אביב" />
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1.5">יעד</label>
                    <div class="relative">
                        <select id="destination-select" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl appearance-none focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="" disabled selected>בחר יעד...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" id="cancel-create-route" class="btn flex-1 bg-slate-100 text-slate-700 py-3">ביטול</button>
                    <button type="submit" class="btn flex-1 bg-indigo-600 text-white py-3 shadow-lg shadow-indigo-200">התחל</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודל הוספת מקום -->
    <div id="add-place-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[60] hidden items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-2xl h-[85dvh] sm:h-[600px] modal-content rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col slide-up">
            <!-- Modal Header -->
            <div class="p-4 border-b border-slate-100 flex items-center justify-between shrink-0">
                <div>
                    <h3 class="text-lg font-bold text-slate-800">הוספת מקום</h3>
                    <p class="text-xs text-slate-500">בחר אטרקציה או נקודת עניין</p>
                </div>
                <button id="close-add-place-modal-btn" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>

            <!-- Search & Filter -->
            <div class="p-3 bg-slate-50 border-b border-slate-100 flex gap-2 shrink-0 overflow-x-auto no-scrollbar">
                <div class="relative flex-grow min-w-[150px]">
                    <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="search" id="modal-search-input" class="w-full pl-3 pr-9 py-2.5 bg-white border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="חפש מקום..." />
                </div>
                <select id="modal-category-filter" class="bg-white border border-slate-200 rounded-xl px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none">
                    <option value="all">הכל</option>
                </select>
                <button id="open-map-selection-btn" class="bg-white border border-indigo-200 text-indigo-600 px-3 py-2 rounded-xl text-sm font-bold whitespace-nowrap">
                    <i class="fas fa-map ml-1"></i> מפה
                </button>
            </div>

            <!-- List -->
            <div id="modal-places-list-container" class="flex-grow overflow-y-auto p-3 space-y-2 bg-slate-50/50">
                <!-- Places injected here -->
            </div>
        </div>
    </div>
    
    <!-- מודל בחירה ממפה (Full Screen) -->
    <div id="map-selection-modal" class="fixed inset-0 bg-white z-[70] hidden flex-col slide-up">
         <div class="p-3 bg-white border-b border-slate-100 flex items-center justify-between shadow-sm shrink-0 z-10 pt-[env(safe-area-inset-top)]">
            <h3 class="text-lg font-bold text-slate-800 pr-2">בחירה מהמפה</h3>
            <button id="close-map-modal-btn" class="bg-slate-100 px-4 py-2 rounded-full text-sm font-bold text-slate-700">סגור</button>
        </div>
        <div id="map-modal-container" class="flex-grow w-full h-full bg-slate-100"></div>
    </div>

    <!-- מודל הוספת הערה -->
    <div id="add-other-modal" class="fixed inset-0 bg-black/40 backdrop-blur-sm z-[65] hidden items-end sm:items-center justify-center p-0 sm:p-4">
        <div class="bg-white w-full sm:max-w-md p-6 modal-content rounded-t-3xl sm:rounded-2xl shadow-2xl slide-up">
            <h3 class="text-xl font-bold text-slate-800 mb-4">הוספת הערה / משימה</h3>
            <form id="add-other-form" class="space-y-4">
                <input type="text" id="other-name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-indigo-500 outline-none" placeholder="כותרת (למשל: הפסקת צהריים)" />
                <textarea id="other-description" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-indigo-500 outline-none" rows="3" placeholder="פירוט נוסף..."></textarea>
                <div class="flex gap-3 pt-2">
                     <button type="button" id="cancel-add-other" class="btn flex-1 bg-slate-100 text-slate-700 py-3">ביטול</button>
                    <button type="submit" class="btn flex-1 bg-indigo-600 text-white py-3">הוסף</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-1/2 translate-x-1/2 bg-slate-800/90 backdrop-blur text-white py-3 px-6 rounded-full shadow-2xl transition-all duration-300 -translate-y-24 opacity-0 z-[100] flex items-center gap-3 min-w-max">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toast-message" class="font-medium text-sm"></span>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        // שימוש בגרסאות יציבות ותואמות (v10)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUser, tripId, tripData;
        let allPlaces = [], allHotels = [], availablePoints = [];
        let currentRoute = { id: null, name: '', destination: '', steps: [], isPublic: true, createdBy: null, tripId: null };
        let map, summaryMap, routePolyline, routeDecorator;
        let mapMarkers = new Map();
        
        // Drag State
        let draggedItemIndex = null;
        let longPressTimer = null;
        let isTouchDragging = false;
        let touchStartY = 0;

        // Categories Configuration
        const categoryConfig = {
            "מסעדה/אוכל": { icon: "fa-utensils", color: "#f97316", bg: "#ffedd5" }, // Orange
            "מלון": { icon: "fa-bed", color: "#8b5cf6", bg: "#f3e8ff" }, // Purple
            "מוזיאון": { icon: "fa-landmark", color: "#64748b", bg: "#f1f5f9" }, // Slate
            "קניון/מרכז קניות": { icon: "fa-bag-shopping", color: "#ec4899", bg: "#fce7f3" }, // Pink
            "אטרקציה": { icon: "fa-star", color: "#eab308", bg: "#fef9c3" }, // Yellow
            "חוף": { icon: "fa-umbrella-beach", color: "#06b6d4", bg: "#cffafe" }, // Cyan
            "סיור": { icon: "fa-person-hiking", color: "#10b981", bg: "#d1fae5" }, // Emerald
            "סופר": { icon: "fa-cart-shopping", color: "#6366f1", bg: "#e0e7ff" }, // Indigo
            "other": { icon: "fa-note-sticky", color: "#94a3b8", bg: "#f8fafc" },
            "default": { icon: "fa-location-dot", color: "#ef4444", bg: "#fee2e2" }
        };

        // --- DOM Elements ---
        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            mainContent: document.getElementById('main-content'),
            authContainer: document.getElementById('auth-container'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            initialState: document.getElementById('initial-state'),
            buildingState: document.getElementById('building-state'),
            summaryView: document.getElementById('summary-view'),
            
            // Modals
            createRouteModal: document.getElementById('create-route-modal'),
            addPlaceModal: document.getElementById('add-place-modal'),
            mapSelectionModal: document.getElementById('map-selection-modal'),
            addOtherModal: document.getElementById('add-other-modal'),
            
            // Buttons
            createRouteBtn: document.getElementById('create-route-btn'),
            saveRouteBtn: document.getElementById('save-route-btn'),
            organizeRouteBtn: document.getElementById('organize-route-btn'),
            toggleMapViewBtn: document.getElementById('toggle-map-view'),
            
            // Containers
            routeStepsContainer: document.getElementById('route-steps-container'),
            startPrompt: document.getElementById('start-prompt'),
            modalPlacesList: document.getElementById('modal-places-list-container'),
            
            // Inputs
            routeTitle: document.getElementById('route-title'),
            routeDestination: document.getElementById('route-destination'),
            modalSearch: document.getElementById('modal-search-input'),
            modalFilter: document.getElementById('modal-category-filter'),
            isPublic: document.getElementById('is-public-toggle')
        };

        // --- Init ---
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            const routeId = urlParams.get('routeId');

            if (!tripId) {
                showToast("שגיאה: מזהה טיול חסר", true);
                DOM.loadingOverlay.classList.add('hidden');
                return;
            }

            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = user;
                DOM.authContainer.textContent = user.displayName?.split(' ')[0] || "משתמש";

                try {
                    await Promise.all([loadTripData(), loadAllPlaces(), loadAllHotels()]);
                    
                    if (routeId) {
                        await loadRouteForEdit(routeId);
                    } else {
                        populateDestinationSelect();
                        DOM.loadingOverlay.style.opacity = '0';
                        setTimeout(() => DOM.loadingOverlay.style.display = 'none', 300);
                        DOM.mainContent.classList.remove('hidden');
                    }
                    
                    setupEventListeners();
                    setupTouchDrag();
                } catch (error) {
                    console.error(error);
                    showToast("שגיאה בטעינת הנתונים", true);
                    DOM.loadingOverlay.style.display = 'none';
                }
            });
        }

        // --- Data Loading ---
        async function loadTripData() {
            const docSnap = await getDoc(doc(db, 'trips', tripId));
            if (docSnap.exists()) tripData = docSnap.data();
            else throw new Error("Trip not found");
        }

        async function loadAllPlaces() {
            const q = query(collection(db, 'trips', tripId, 'places'));
            const snapshot = await getDocs(q);
            allPlaces = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'place' }));
        }

        async function loadAllHotels() {
            const q = query(collection(db, 'trips', tripId, 'logistics'), where("type", "==", "hotel"));
            const snapshot = await getDocs(q);
            allHotels = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'hotel', type: 'מלון' }));
        }

        async function loadRouteForEdit(routeId) {
            try {
                const docSnap = await getDoc(doc(db, 'trips', tripId, 'routes', routeId));
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    currentRoute = {
                        id: docSnap.id,
                        name: data.name,
                        destination: data.destination,
                        steps: data.steps || [],
                        isPublic: data.isPublic !== false,
                        createdBy: data.createdBy,
                        tripId: data.tripId
                    };
                    startRouteBuilding(currentRoute.name, currentRoute.destination);
                    DOM.isPublic.checked = currentRoute.isPublic;
                }
            } finally {
                DOM.loadingOverlay.style.display = 'none';
                DOM.mainContent.classList.remove('hidden');
            }
        }

        function populateDestinationSelect() {
            const select = document.getElementById('destination-select');
            select.innerHTML = '<option value="" disabled selected>בחר יעד...</option>';
            tripData?.destinations?.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.nameHe;
                opt.textContent = d.nameHe;
                select.appendChild(opt);
            });
        }

        // --- UI Logic ---
        function startRouteBuilding(name, destination) {
            currentRoute.name = name;
            currentRoute.destination = destination;
            currentRoute.createdBy = currentRoute.createdBy || currentUser.uid;
            currentRoute.tripId = tripId;

            DOM.initialState.classList.add('hidden');
            DOM.buildingState.classList.remove('hidden');
            DOM.summaryView.classList.add('hidden');
            DOM.summaryView.innerHTML = ''; // Reset summary

            DOM.routeTitle.textContent = name;
            DOM.routeDestination.textContent = destination;
            
            // Filter points for this destination
            availablePoints = [...allPlaces, ...allHotels].filter(p => 
                !p.destination || p.destination === destination
            );

            // Populate categories
            const cats = [...new Set(availablePoints.map(p => p.type || 'Other'))];
            DOM.modalFilter.innerHTML = '<option value="all">הכל</option>' + 
                cats.map(c => `<option value="${c}">${c}</option>`).join('');

            DOM.createRouteModal.classList.add('hidden');
            renderRouteSteps();
        }

        function renderRouteSteps() {
            const container = DOM.routeStepsContainer;
            container.innerHTML = '';

            if (currentRoute.steps.length === 0) {
                DOM.startPrompt.classList.remove('hidden');
                return;
            }
            DOM.startPrompt.classList.add('hidden');

            currentRoute.steps.forEach((step, index) => {
                const config = categoryConfig[step.type] || categoryConfig.default;
                const prevStep = currentRoute.steps[index - 1];
                let distHTML = '';

                if (prevStep && prevStep.coords && step.coords) {
                    const dist = calculateDistance(prevStep.coords, step.coords);
                    distHTML = `
                        <div class="flex justify-end pr-14 py-1">
                            <span class="text-[10px] font-bold text-slate-400 bg-white px-2 rounded-full border border-slate-100 flex items-center gap-1">
                                <i class="fas fa-person-walking"></i> ${dist.toFixed(1)} ק"מ
                            </span>
                        </div>
                    `;
                }

                const el = document.createElement('div');
                el.className = 'route-step relative animate-fade-in';
                el.dataset.index = index;
                el.draggable = true;
                
                el.innerHTML = `
                    <div class="timeline-line"></div>
                    ${distHTML}
                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-100 shadow-sm z-10 relative select-none">
                        <div class="shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm text-slate-500 bg-slate-100 border border-slate-200">
                            ${index + 1}
                        </div>
                        <div class="shrink-0 w-10 h-10 rounded-xl flex items-center justify-center text-lg" style="background:${config.bg}; color:${config.color}">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <h4 class="font-bold text-slate-800 text-sm truncate">${step.name}</h4>
                            <p class="text-xs text-slate-500 truncate">${step.description || step.type}</p>
                        </div>
                        <div class="flex items-center gap-1">
                            <button class="w-8 h-8 flex items-center justify-center text-slate-300 hover:text-indigo-500 drag-handle cursor-grab active:cursor-grabbing">
                                <i class="fas fa-grip-vertical"></i>
                            </button>
                            <button class="w-8 h-8 flex items-center justify-center text-red-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors remove-btn">
                                <i class="fas fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                `;

                // Add Drag Events explicitly to handle
                el.querySelector('.drag-handle').addEventListener('mousedown', () => { el.draggable = true });
                el.querySelector('.drag-handle').addEventListener('touchstart', (e) => { 
                   // Logic handled by container listeners
                });
                
                el.querySelector('.remove-btn').onclick = () => removeStep(index);

                container.appendChild(el);
            });
            
            // Scroll to bottom on add
            // container.parentElement.scrollTop = container.parentElement.scrollHeight;
        }

        function renderModalPlaces() {
            const search = DOM.modalSearch.value.toLowerCase();
            const cat = DOM.modalFilter.value;
            const container = DOM.modalPlacesList;
            
            // Smart sort: if we have a last step with coords, sort by distance
            let sortPoint = null;
            const lastCoordStep = [...currentRoute.steps].reverse().find(s => s.coords);
            if (lastCoordStep) sortPoint = lastCoordStep.coords;

            const filtered = availablePoints.filter(p => 
                (cat === 'all' || p.type === cat) &&
                (p.name.toLowerCase().includes(search))
            ).map(p => {
                if (sortPoint && p.coords) {
                    p._dist = calculateDistance(sortPoint, p.coords);
                } else {
                    p._dist = Infinity;
                }
                return p;
            }).sort((a, b) => {
                if (sortPoint) return a._dist - b._dist;
                return a.name.localeCompare(b.name, 'he');
            });

            if (filtered.length === 0) {
                container.innerHTML = `<div class="text-center p-8 text-slate-400">לא נמצאו תוצאות</div>`;
                return;
            }

            container.innerHTML = filtered.map(p => {
                const config = categoryConfig[p.type] || categoryConfig.default;
                const distBadge = p._dist !== Infinity ? `<span class="text-[10px] bg-indigo-50 text-indigo-600 px-1.5 py-0.5 rounded ml-2">${p._dist.toFixed(1)} ק"מ</span>` : '';
                
                return `
                <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-100 shadow-sm hover:border-indigo-500 cursor-pointer transition-all place-item" data-id="${p.id}">
                    <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg shrink-0" style="background:${config.bg}; color:${config.color}">
                        <i class="fas ${config.icon}"></i>
                    </div>
                    <div class="flex-grow min-w-0">
                        <div class="flex items-center">
                            <h4 class="font-bold text-slate-800 text-sm truncate">${p.name}</h4>
                            ${distBadge}
                        </div>
                        <p class="text-xs text-slate-500">${p.type}</p>
                    </div>
                    <button class="w-8 h-8 bg-indigo-100 text-indigo-600 rounded-full flex items-center justify-center hover:bg-indigo-600 hover:text-white transition-colors add-btn">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>`;
            }).join('');
            
            // Add click listeners
            container.querySelectorAll('.place-item').forEach(el => {
                el.addEventListener('click', () => addStep(el.dataset.id));
            });
        }

        // --- Logic Operations ---
        function addStep(id) {
            const point = availablePoints.find(p => p.id === id);
            if (!point) return;
            
            currentRoute.steps.push({ ...point }); // Copy object
            renderRouteSteps();
            showToast(`נוסף: ${point.name}`);
            
            // Close modal if on mobile mostly
            if (window.innerWidth < 640) {
                toggleModal('add-place-modal', false);
            }
        }

        function removeStep(index) {
            currentRoute.steps.splice(index, 1);
            renderRouteSteps();
            if (navigator.vibrate) navigator.vibrate(50);
        }

        function organizeRoute() {
            const withCoords = currentRoute.steps.filter(s => s.coords);
            const noCoords = currentRoute.steps.filter(s => !s.coords);
            
            if (withCoords.length < 2) {
                showToast("אין מספיק נקודות עם מיקום לסידור", true);
                return;
            }

            // Greedy Nearest Neighbor
            let sorted = [withCoords.shift()];
            while (withCoords.length > 0) {
                const current = sorted[sorted.length - 1];
                let nearestIdx = 0;
                let minDst = Infinity;
                
                withCoords.forEach((p, i) => {
                    const dst = calculateDistance(current.coords, p.coords);
                    if (dst < minDst) {
                        minDst = dst;
                        nearestIdx = i;
                    }
                });
                sorted.push(withCoords.splice(nearestIdx, 1)[0]);
            }

            currentRoute.steps = [...sorted, ...noCoords];
            renderRouteSteps();
            showToast("המסלול סודר לפי המרחק הקצר ביותר");
        }

        // --- Save & Summary ---
        async function saveRoute() {
            const btn = DOM.saveRouteBtn;
            const originalContent = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            btn.disabled = true;

            try {
                currentRoute.isPublic = DOM.isPublic.checked;
                const routeData = { ...currentRoute, updatedAt: new Date() };
                
                let ref;
                if (currentRoute.id) {
                    ref = doc(db, 'trips', tripId, 'routes', currentRoute.id);
                    await setDoc(ref, routeData);
                } else {
                    ref = await addDoc(collection(db, 'trips', tripId, 'routes'), routeData);
                    currentRoute.id = ref.id;
                }

                // Public Routes Logic (Simplify for this version)
                 if (currentRoute.isPublic) {
                    await setDoc(doc(db, 'publicRoutes', currentRoute.id), routeData);
                } else {
                     // Try delete if permissions allow, or ignore
                     try { await deleteDoc(doc(db, 'publicRoutes', currentRoute.id)); } catch(e){}
                }

                renderSummaryView();
            } catch (e) {
                console.error(e);
                showToast("שגיאה בשמירה", true);
            } finally {
                btn.innerHTML = originalContent;
                btn.disabled = false;
            }
        }

        function renderSummaryView() {
            DOM.buildingState.classList.add('hidden');
            DOM.summaryView.classList.remove('hidden');

            DOM.summaryView.innerHTML = `
                <div class="flex flex-col h-full">
                    <div class="bg-indigo-600 text-white p-6 shrink-0 pt-8 pb-12 rounded-b-[2.5rem] shadow-lg relative z-10">
                        <div class="flex justify-between items-start mb-4">
                            <h2 class="text-2xl font-bold">${currentRoute.name}</h2>
                            <button onclick="editRoute()" class="bg-white/20 p-2 rounded-lg hover:bg-white/30 backdrop-blur-sm"><i class="fas fa-pencil"></i></button>
                        </div>
                        <div class="flex gap-4 text-indigo-100 text-sm">
                            <span><i class="fas fa-map-pin ml-1"></i> ${currentRoute.destination}</span>
                            <span><i class="fas fa-stopwatch ml-1"></i> ${currentRoute.steps.length} תחנות</span>
                        </div>
                        <div class="absolute -bottom-6 left-6 right-6 flex gap-2">
                             <button onclick="copyLink()" class="flex-1 bg-white text-indigo-600 py-3 rounded-xl shadow-lg font-bold hover:bg-slate-50 active:scale-95 transition-transform flex items-center justify-center gap-2">
                                <i class="fas fa-share-nodes"></i> שתף
                             </button>
                             <button onclick="window.print()" class="flex-1 bg-indigo-800 text-white py-3 rounded-xl shadow-lg font-bold active:scale-95 transition-transform flex items-center justify-center gap-2">
                                <i class="fas fa-print"></i> הדפס
                             </button>
                        </div>
                    </div>
                    
                    <div class="flex-grow flex flex-col pt-10 overflow-hidden bg-slate-50">
                        <!-- Tabs -->
                        <div class="flex justify-center mb-4 gap-2 px-4 shrink-0">
                            <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-2 rounded-lg bg-indigo-600 text-white shadow font-bold text-sm transition-colors">רשימה</button>
                            <button onclick="switchTab('map')" id="tab-map" class="flex-1 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 font-bold text-sm hover:bg-slate-50 transition-colors">מפה</button>
                        </div>

                        <!-- Content -->
                        <div id="summary-content-list" class="flex-grow overflow-y-auto p-4 space-y-3 pb-8">
                            ${currentRoute.steps.map((s, i) => `
                                <div class="flex items-start gap-4 p-4 bg-white rounded-xl border border-slate-100 shadow-sm">
                                    <div class="font-bold text-lg text-indigo-600 min-w-[1.5rem]">${i+1}.</div>
                                    <div>
                                        <h3 class="font-bold text-slate-800">${s.name}</h3>
                                        <p class="text-sm text-slate-500">${s.description || s.type}</p>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                        
                        <div id="summary-content-map" class="hidden flex-grow relative w-full h-full bg-slate-100">
                             <div id="final-map" class="absolute inset-0 w-full h-full"></div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Expose to window for inline onclicks
        window.editRoute = () => {
            DOM.summaryView.classList.add('hidden');
            DOM.buildingState.classList.remove('hidden');
        };
        
        window.switchTab = (tab) => {
            const listDiv = document.getElementById('summary-content-list');
            const mapDiv = document.getElementById('summary-content-map');
            const tabList = document.getElementById('tab-list');
            const tabMap = document.getElementById('tab-map');

            if (tab === 'list') {
                listDiv.classList.remove('hidden');
                mapDiv.classList.add('hidden');
                tabList.className = "flex-1 py-2 rounded-lg bg-indigo-600 text-white shadow font-bold text-sm transition-colors";
                tabMap.className = "flex-1 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 font-bold text-sm transition-colors";
            } else {
                listDiv.classList.add('hidden');
                mapDiv.classList.remove('hidden');
                tabMap.className = "flex-1 py-2 rounded-lg bg-indigo-600 text-white shadow font-bold text-sm transition-colors";
                tabList.className = "flex-1 py-2 rounded-lg bg-white text-slate-600 border border-slate-200 font-bold text-sm transition-colors";
                
                // Initialize map if not ready
                setTimeout(() => {
                    initMap('final-map', currentRoute.steps);
                }, 100);
            }
        };

        window.copyLink = () => {
             // Create text representation
             const txt = currentRoute.steps.map((s, i) => `${i+1}. ${s.name}`).join('\n');
             navigator.clipboard.writeText(`המסלול שלי ל${currentRoute.destination}:\n${txt}`);
             showToast("הועתק ללוח!");
        }

        // --- Map Functions ---
        function initMap(divId, points = [], isSelectionMode = false) {
            const container = document.getElementById(divId);
            if (!container) return;

            if (map) { map.remove(); map = null; }
            
            map = L.map(divId, { zoomControl: false }).setView([31.768, 35.213], 8);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: ''
            }).addTo(map);

            if (points.length > 0) {
                const group = L.featureGroup();
                const latlngs = [];

                points.forEach((p, i) => {
                    if (!p.coords) return;
                    const config = categoryConfig[p.type] || categoryConfig.default;
                    latlngs.push([p.coords.lat, p.coords.lng]);

                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="custom-marker" style="background:${config.color}; width:32px; height:32px; color:white;">
                                <i class="fas ${config.icon} text-xs"></i>
                               </div>`,
                        iconSize: [32, 32],
                        iconAnchor: [16, 16]
                    });

                    const marker = L.marker([p.coords.lat, p.coords.lng], { icon }).addTo(map);
                    
                    if (isSelectionMode) {
                        marker.on('click', () => {
                            if(confirm(`להוסיף את ${p.name}?`)) {
                                addStep(p.id);
                                toggleModal('map-selection-modal', false);
                            }
                        });
                    } else {
                        marker.bindPopup(`<b>${i+1}. ${p.name}</b>`).addTo(group);
                    }
                    group.addLayer(marker);
                });

                if (latlngs.length > 0 && !isSelectionMode) {
                    L.polyline(latlngs, { color: '#6366f1', weight: 4, opacity: 0.7, dashArray: '10, 10' }).addTo(map);
                    map.fitBounds(group.getBounds(), { padding: [50, 50] });
                } else if (isSelectionMode && group.getLayers().length > 0) {
                     map.fitBounds(group.getBounds(), { padding: [50, 50] });
                }
            } else if (isSelectionMode) {
                // Show all available points
                const group = L.featureGroup();
                 availablePoints.forEach(p => {
                    if (!p.coords) return;
                    const config = categoryConfig[p.type] || categoryConfig.default;
                    const icon = L.divIcon({
                        className: 'custom-div-icon',
                        html: `<div class="custom-marker" style="background:${config.color}; width:28px; height:28px; color:white;">
                                <i class="fas ${config.icon} text-[10px]"></i>
                               </div>`,
                         iconSize: [28, 28],
                         iconAnchor: [14, 14]
                    });
                    const m = L.marker([p.coords.lat, p.coords.lng], {icon}).addTo(map);
                    m.on('click', () => {
                        if(confirm(`להוסיף את ${p.name}?`)) {
                             addStep(p.id);
                             toggleModal('map-selection-modal', false);
                        }
                    });
                    group.addLayer(m);
                });
                if(group.getLayers().length > 0) map.fitBounds(group.getBounds(), { padding: [50,50] });
            }
        }

        // --- Drag & Drop (Touch & Mouse) ---
        function setupTouchDrag() {
            const container = DOM.routeStepsContainer;
            
            // Mouse
            container.addEventListener('dragstart', (e) => {
                const item = e.target.closest('.route-step');
                if(!item) return;
                draggedItemIndex = parseInt(item.dataset.index);
                item.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });

            container.addEventListener('dragover', (e) => {
                e.preventDefault();
                const item = e.target.closest('.route-step');
                if (item && item !== document.querySelector('.dragging')) {
                    document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
                    item.classList.add('drag-over-item');
                }
            });
            
             container.addEventListener('dragleave', (e) => {
                 const item = e.target.closest('.route-step');
                 if(item) item.classList.remove('drag-over-item');
             });

            container.addEventListener('drop', (e) => {
                e.preventDefault();
                const target = e.target.closest('.route-step');
                if (target) {
                    const toIndex = parseInt(target.dataset.index);
                    if (draggedItemIndex !== null && draggedItemIndex !== toIndex) {
                        const item = currentRoute.steps.splice(draggedItemIndex, 1)[0];
                        currentRoute.steps.splice(toIndex, 0, item);
                        renderRouteSteps();
                    }
                }
                draggedItemIndex = null;
            });
            
            container.addEventListener('dragend', () => {
                 document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                 document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
            });

            // Touch
            container.addEventListener('touchstart', (e) => {
                const handle = e.target.closest('.drag-handle');
                if (!handle) return;
                
                const item = handle.closest('.route-step');
                if (!item) return;
                
                touchStartY = e.touches[0].clientY;
                longPressTimer = setTimeout(() => {
                    isTouchDragging = true;
                    draggedItemIndex = parseInt(item.dataset.index);
                    item.classList.add('dragging');
                    if(navigator.vibrate) navigator.vibrate(50);
                }, 200);
            }, {passive: false});

            container.addEventListener('touchmove', (e) => {
                if (!isTouchDragging) {
                    if (longPressTimer) clearTimeout(longPressTimer);
                    return;
                }
                e.preventDefault(); // Prevent scrolling
                
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.route-step');
                
                document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
                if (target && target.dataset.index != draggedItemIndex) {
                     target.classList.add('drag-over-item');
                }
            }, {passive: false});

            container.addEventListener('touchend', (e) => {
                if (longPressTimer) clearTimeout(longPressTimer);
                
                if (isTouchDragging) {
                    const touch = e.changedTouches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.route-step');
                    
                    if (target) {
                        const toIndex = parseInt(target.dataset.index);
                        if (draggedItemIndex !== null && draggedItemIndex !== toIndex) {
                            const item = currentRoute.steps.splice(draggedItemIndex, 1)[0];
                            currentRoute.steps.splice(toIndex, 0, item);
                            renderRouteSteps();
                        }
                    }
                }
                isTouchDragging = false;
                draggedItemIndex = null;
                document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
                document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
            });
        }

        // --- Helpers ---
        function toggleModal(id, show) {
            const el = document.getElementById(id);
            if (show) {
                el.classList.remove('hidden');
                el.classList.add('flex');
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        }

        function calculateDistance(c1, c2) {
            if (!c1 || !c2) return 0;
            const R = 6371; 
            const dLat = (c2.lat - c1.lat) * Math.PI / 180;
            const dLon = (c2.lng - c1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function showToast(msg, isError = false) {
            const el = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            el.querySelector('i').className = isError ? "fas fa-circle-exclamation text-red-400" : "fas fa-check-circle text-green-400";
            el.classList.remove('-translate-y-24', 'opacity-0');
            setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000);
        }

        // --- Listeners Setup ---
        function setupEventListeners() {
            // New Route
            DOM.createRouteBtn.onclick = () => toggleModal('create-route-modal', true);
            document.getElementById('cancel-create-route').onclick = () => toggleModal('create-route-modal', false);
            document.getElementById('create-route-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('new-route-name').value;
                const dest = document.getElementById('destination-select').value;
                if(name && dest) startRouteBuilding(name, dest);
            };

            // Add Place
            document.getElementById('open-add-place-modal-btn').onclick = () => {
                DOM.modalSearch.value = '';
                DOM.modalFilter.value = 'all';
                renderModalPlaces();
                toggleModal('add-place-modal', true);
            };
            document.getElementById('close-add-place-modal-btn').onclick = () => toggleModal('add-place-modal', false);
            DOM.modalSearch.oninput = renderModalPlaces;
            DOM.modalFilter.onchange = renderModalPlaces;

            // Map Selection
            document.getElementById('open-map-selection-btn').onclick = () => {
                toggleModal('add-place-modal', false);
                toggleModal('map-selection-modal', true);
                setTimeout(() => initMap('map-modal-container', [], true), 200);
            };
            document.getElementById('close-map-modal-btn').onclick = () => {
                 toggleModal('map-selection-modal', false);
                 toggleModal('add-place-modal', true);
            };
             // Toggle Map in edit view (Mobile)
             DOM.toggleMapViewBtn.onclick = () => {
                 toggleModal('map-selection-modal', true);
                 setTimeout(() => initMap('map-modal-container', currentRoute.steps, false), 200); // Show current route
             }

            // Other/Note
            document.getElementById('open-add-other-btn').onclick = () => {
                document.getElementById('add-other-form').reset();
                toggleModal('add-other-modal', true);
            };
            document.getElementById('cancel-add-other').onclick = () => toggleModal('add-other-modal', false);
            document.getElementById('add-other-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('other-name').value;
                const desc = document.getElementById('other-description').value;
                currentRoute.steps.push({ 
                    id: crypto.randomUUID(), 
                    name, 
                    description: desc, 
                    type: 'other', 
                    coords: null 
                });
                renderRouteSteps();
                toggleModal('add-other-modal', false);
            };

            // Actions
            DOM.saveRouteBtn.onclick = saveRoute;
            DOM.organizeRouteBtn.onclick = organizeRoute;
        }

        // Start
        initPage();
    </script>
</body>
</html>

