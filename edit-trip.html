<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>转 住 </title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Assistant', sans-serif; background-color: #f1f5f9; }
        .leaflet-container { font-family: 'Assistant', sans-serif; }
        #map { height: 100%; width: 100%; border-radius: 1rem; z-index: 0; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .place-card { transition: all 0.2s ease-in-out; border-right: 4px solid transparent; }
        .place-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1); }
        .place-card.highlight { border-right-color: #3b82f6; background-color: #eff6ff; }

        .route-step {
            position: relative;
            padding-right: 3rem;
            padding-bottom: 1.5rem;
        }
        .route-step:not(:last-child)::before {
            content: '';
            position: absolute;
            top: 1.5rem;
            right: 1.25rem;
            width: 2px;
            height: calc(100% - 1.25rem);
            background-color: #e2e8f0;
        }
        .step-icon {
            position: absolute;
            top: 0;
            right: 0;
            width: 2.5rem;
            height: 2.5rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            border: 3px solid #f1f5f9;
        }

        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            transition: all 0.2s ease;
        }
        .custom-marker-icon.highlight {
            transform: scale(1.5);
            z-index: 1000;
        }
        .fade-out { animation: fadeOut 0.4s ease-out forwards; }
        @keyframes fadeOut { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }
        
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="overflow-hidden h-screen">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-route text-5xl text-blue-600 animate-pulse"></i>
        <p class="text-xl font-bold text-slate-700">注 转...</p>
    </div>

    <!-- Main Content -->
    <div id="main-content" class="h-screen flex flex-col hidden">
        <header class="bg-white shadow-md z-20">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
                <div class="flex items-center gap-2">
                     <a id="back-to-trip-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title="专 专 ">
                        <i class="fas fa-arrow-right fa-lg"></i>
                    </a>
                    <a id="all-routes-btn" href="#" class="p-2 text-slate-600 hover:text-blue-600" title=" 住 砖专">
                        <i class="fas fa-list-ul fa-lg"></i>
                    </a>
                    <h1 class="text-xl font-bold text-slate-800">转 住 </h1>
                </div>
                 <div id="auth-container" class="text-sm font-semibold text-slate-700"></div>
            </div>
        </header>

        <div class="flex-grow flex flex-col md:flex-row overflow-hidden">
            <!-- Right Panel (Controls) -->
            <aside id="controls-panel" class="w-full md:w-1/3 lg:w-1/4 bg-white p-4 flex flex-col overflow-y-auto no-scrollbar border-l">
                <!-- Initial State -->
                <div id="initial-state" class="text-center p-8 flex-grow flex flex-col items-center justify-center">
                    <i class="fas fa-magic-wand-sparkles fa-4x text-purple-400 mb-6"></i>
                    <h2 class="text-2xl font-bold text-slate-800"> 转 住?</h2>
                    <p class="text-slate-500 mt-2">转 爪专转 住 砖  转 转  砖.</p>
                    <button id="create-route-btn" class="mt-6 w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:shadow-xl transition-all transform hover:scale-105">
                        <i class="fas fa-plus mr-2"></i> 爪专 住 砖
                    </button>
                </div>

                <!-- Building State -->
                <div id="building-state" class="hidden flex-grow flex flex-col">
                   <div id="current-route-info" class="mb-4 p-3 bg-slate-50 rounded-lg">
                       <h2 id="route-title" class="text-2xl font-bold text-slate-800"></h2>
                       <p id="route-destination" class="text-slate-500 font-semibold"></p>
                   </div>
                   
                   <!-- Current Route Steps -->
                   <div class="mb-4">
                       <h3 class="font-bold text-slate-700 mb-2">住 砖:</h3>
                       <div id="route-steps-container" class="space-y-0">
                           <p id="start-prompt" class="text-center text-slate-500 bg-slate-50 p-4 rounded-lg">专 拽转 转 专砖  驻...</p>
                       </div>
                   </div>
                   <button id="finish-route-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg hidden"><i class="fas fa-flag-checkered mr-2"></i>住 砖专 住</button>

                   <!-- Suggestions & Search -->
                   <div id="suggestions-area" class="flex-grow flex flex-col mt-4 border-t pt-4">
                        <h3 id="suggestions-title" class="font-bold text-slate-700 mb-3 text-lg">拽转 拽专:</h3>
                        <!-- Search & Filter -->
                        <div class="mb-4 space-y-2 sticky top-0 bg-white py-2">
                            <input type="search" id="search-places-input" class="w-full p-2 border rounded-md" placeholder=" 驻砖 拽 住驻爪驻...">
                            <select id="category-filter-select" class="w-full p-2 border rounded-md bg-white">
                                <option value="all"> 拽专转</option>
                            </select>
                        </div>
                        <div id="places-list-container" class="overflow-y-auto no-scrollbar space-y-3">
                           <!-- Place cards will be injected here -->
                        </div>
                   </div>
                </div>
            </aside>

            <!-- Left Panel (Map) -->
            <main class="flex-grow bg-slate-200 p-2">
                <div id="map"></div>
            </main>
        </div>
    </div>
    
    <!-- Modals -->
    <div id="create-route-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">爪专转 住 砖</h3>
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label for="new-route-name" class="block text-sm font-semibold text-slate-600 mb-1">砖 住</label>
                    <input type="text" id="new-route-name" required class="w-full p-2 border rounded-md" placeholder=":  祝 ">
                </div>
                <div>
                    <label for="destination-select" class="block text-sm font-semibold text-slate-600 mb-1"> 注?</label>
                    <select id="destination-select" required class="w-full p-2 border rounded-md bg-white">
                        <option value="" disabled selected>注 注...</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-create-route" class="py-2 px-5 bg-slate-200 font-semibold rounded-lg hover:bg-slate-300"></button>
                    <button type="submit" class="py-2 px-5 bg-blue-600 text-white font-semibold rounded-lg hover:bg-blue-700">转 转</button>
                </div>
            </form>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";
    
        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State & UI Elements ---
        let currentUser, tripId, tripData;
        let allPlaces = [], allHotels = [], availablePoints = [];
        let currentRoute = [];
        let map, routePolyline, routeDecorator, mapMarkers = new Map();

        const categoryIcons = {
            "住注/": { icon: "fa-utensils", color: "#fb923c" }, // orange-400
            "": { icon: "fa-hotel", color: "#8b5cf6" }, // violet-500
            "": { icon: "fa-landmark", color: "#78716c" }, // stone-500
            "拽/专 拽转": { icon: "fa-shopping-bag", color: "#ec4899" }, // pink-500
            "专拽爪": { icon: "fa-star", color: "#f59e0b" }, // amber-500
            "祝": { icon: "fa-umbrella-beach", color: "#06b6d4" }, // cyan-500
            "住专": { icon: "fa-person-walking", color: "#10b981" }, // emerald-500
            "住驻专": { icon: "fa-shopping-cart", color: "#6366f1" }, // indigo-500
            "default": { icon: "fa-map-marker-alt", color: "#64748b" } // slate-500
        };

        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            mainContent: document.getElementById('main-content'),
            authContainer: document.getElementById('auth-container'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            allRoutesBtn: document.getElementById('all-routes-btn'),
            
            initialState: document.getElementById('initial-state'),
            buildingState: document.getElementById('building-state'),
            
            createRouteModal: document.getElementById('create-route-modal'),
            createRouteForm: document.getElementById('create-route-form'),
            createRouteBtn: document.getElementById('create-route-btn'),
            cancelCreateRouteBtn: document.getElementById('cancel-create-route'),
            destinationSelect: document.getElementById('destination-select'),

            routeTitle: document.getElementById('route-title'),
            routeDestination: document.getElementById('route-destination'),
            routeStepsContainer: document.getElementById('route-steps-container'),
            startPrompt: document.getElementById('start-prompt'),
            finishRouteBtn: document.getElementById('finish-route-btn'),
            suggestionsTitle: document.getElementById('suggestions-title'),
            searchPlacesInput: document.getElementById('search-places-input'),
            categoryFilterSelect: document.getElementById('category-filter-select'),
            placesListContainer: document.getElementById('places-list-container')
        };
        
        // --- Initialization ---
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            if (!tripId) {
                alert("砖:  爪  .");
                window.location.href = 'index.html';
                return;
            }
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;
            DOM.allRoutesBtn.href = `all_routes.html?id=${tripId}`;
            
            onAuthStateChanged(auth, async (user) => {
                if (!user) { window.location.href = 'login.html'; return; }
                currentUser = user;
                DOM.authContainer.textContent = `砖, ${user.displayName || user.email.split('@')[0]}`;
                
                await Promise.all([ loadTripData(), loadAllPlaces(), loadAllHotels() ]);
                
                populateDestinationSelect();
                setupEventListeners();
                
                DOM.loadingOverlay.style.display = 'none';
                DOM.mainContent.classList.remove('hidden');
                DOM.mainContent.classList.add('flex', 'flex-col');
            });
        }

        // --- Data Loading ---
        async function loadTripData() {
            const docRef = doc(db, 'trips', tripId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) tripData = docSnap.data();
            else throw new Error("Trip not found");
        }

        async function loadAllPlaces() {
            const q = query(collection(db, 'trips', tripId, 'places'));
            const snapshot = await getDocs(q);
            allPlaces = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'place' }));
        }

        async function loadAllHotels() {
            const q = query(collection(db, 'trips', tripId, 'logistics'), where("type", "==", "hotel"));
            const snapshot = await getDocs(q);
            allHotels = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'hotel', type: '' }));
        }

        function populateDestinationSelect() {
            DOM.destinationSelect.innerHTML = '<option value="" disabled selected>专 注...</option>';
            if (tripData && tripData.destinations) {
                tripData.destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest.nameHe;
                    option.textContent = dest.nameHe;
                    DOM.destinationSelect.appendChild(option);
                });
            }
        }

        // --- UI Logic & State Transitions ---
        function startRouteBuilding(routeName, destination) {
            DOM.initialState.classList.add('hidden');
            DOM.buildingState.classList.remove('hidden');
            DOM.buildingState.classList.add('flex', 'flex-col');

            DOM.routeTitle.textContent = routeName;
            DOM.routeDestination.textContent = `注: ${destination}`;
            
            availablePoints = [
                ...allPlaces.filter(p => p.destination === destination),
                ...allHotels.filter(h => h.destination === destination)
            ].filter(p => p.coords);

            populateCategoryFilter();
            renderAvailablePoints();
            initMap(destination);
            
            DOM.createRouteModal.classList.add('hidden');
            DOM.createRouteModal.classList.remove('flex');
        }

        function populateCategoryFilter() {
            const categories = [...new Set(availablePoints.map(p => p.type || ' 拽专'))];
            DOM.categoryFilterSelect.innerHTML = '<option value="all"> 拽专转</option>';
            categories.sort().forEach(cat => {
                const iconInfo = categoryIcons[cat] || categoryIcons.default;
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = `${cat}`;
                DOM.categoryFilterSelect.appendChild(option);
            });
        }

        // --- Rendering ---
        function renderAvailablePoints(pointsToRender = availablePoints) {
            const searchTerm = DOM.searchPlacesInput.value.toLowerCase();
            const category = DOM.categoryFilterSelect.value;
            
            const filteredPoints = pointsToRender.filter(p => {
                const nameMatch = p.name.toLowerCase().includes(searchTerm);
                const categoryMatch = category === 'all' || p.type === category;
                return nameMatch && categoryMatch;
            });
            
            if (filteredPoints.length === 0) {
                 DOM.placesListContainer.innerHTML = `<p class="text-center text-slate-500 p-4"> 爪 拽转 转.</p>`;
                 return;
            }

            DOM.placesListContainer.innerHTML = filteredPoints.map(createPlaceCardHTML).join('');
        }

        function createPlaceCardHTML(point) {
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const distanceText = point.distance != null ? `<span class="text-sm font-bold text-slate-600">${point.distance.toFixed(1)} 拽"</span>` : '';
            return `
                <div class="place-card bg-white border rounded-lg p-3 flex items-center gap-4 cursor-pointer" data-id="${point.id}" style="border-right-color: ${iconInfo.color};">
                    <div class="flex-shrink-0 text-lg" style="color: ${iconInfo.color};"><i class="fas ${iconInfo.icon} fa-fw"></i></div>
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-slate-800 truncate">${point.name}</p>
                        <p class="text-sm text-slate-500">${point.type}</p>
                    </div>
                    ${distanceText}
                    <button class="add-point-btn bg-green-500 text-white w-8 h-8 rounded-full flex-shrink-0 hover:bg-green-600 transition transform hover:scale-110"><i class="fas fa-plus"></i></button>
                </div>
            `;
        }

        function renderCurrentRoute() {
            if (currentRoute.length === 0) {
                DOM.routeStepsContainer.innerHTML = '';
                DOM.startPrompt.classList.remove('hidden');
                DOM.finishRouteBtn.classList.add('hidden');
            } else {
                DOM.startPrompt.classList.add('hidden');
                DOM.finishRouteBtn.classList.remove('hidden');
                DOM.routeStepsContainer.innerHTML = currentRoute.map((step, index) => {
                    const iconInfo = categoryIcons[step.type] || categoryIcons.default;
                    return `
                        <div class="route-step">
                            <div class="step-icon text-white" style="background-color: ${iconInfo.color};"><i class="fas ${iconInfo.icon}"></i></div>
                            <div class="flex justify-between items-center">
                                <div>
                                    <p class="font-bold text-slate-800">${step.name}</p>
                                    <p class="text-sm text-slate-500">${index === 0 ? '拽转 转' : `转 ${index + 1}`}</p>
                                </div>
                                <button class="remove-step-btn text-red-500 hover:text-red-700 p-2" data-id="${step.id}"><i class="fas fa-times"></i></button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            updateMapPolyline();
        }

        // --- Map Logic (Leaflet) ---
        function initMap(destination) {
            if (map) map.remove();
            
            map = L.map('map');
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>'
            }).addTo(map);

            mapMarkers.forEach(marker => marker.remove());
            mapMarkers.clear();

            const bounds = L.latLngBounds();
            
            availablePoints.forEach(p => {
                const iconInfo = categoryIcons[p.type] || categoryIcons.default;
                const customIcon = L.divIcon({
                    html: `<i class="fas ${iconInfo.icon}"></i>`,
                    className: 'custom-marker-icon',
                    iconSize: [30, 30],
                    iconAnchor: [15, 15],
                    popupAnchor: [0, -15],
                    html: `<div class="custom-marker-icon" style="background-color:${iconInfo.color}; color: white; width: 30px; height: 30px; font-size: 14px;"><i class="fas ${iconInfo.icon}"></i></div>`
                });

                const marker = L.marker([p.coords.lat, p.coords.lng], { icon: customIcon }).addTo(map);
                marker.bindPopup(`<b>${p.name}</b><br>${p.type}<br><button class="w-full text-center mt-2 p-1 bg-blue-500 text-white rounded text-sm add-point-from-popup" data-id="${p.id}">住祝 住</button>`);
                mapMarkers.set(p.id, marker);
                bounds.extend([p.coords.lat, p.coords.lng]);
            });

            if (bounds.isValid()) map.fitBounds(bounds, { padding: [20, 20] });
            else {
                 const destData = tripData.destinations.find(d => d.nameHe === destination);
                 if(destData && destData.coords) map.setView([destData.coords.lat, destData.coords.lng], 12);
                 else map.setView([31.7683, 35.2137], 8);
            }
            
            routePolyline = L.polyline([], {color: '#ef4444', weight: 4}).addTo(map);
            routeDecorator = L.polylineDecorator(routePolyline, {
                patterns: [ {offset: '5%', repeat: 100, symbol: L.Symbol.arrowHead({pixelSize: 12, pathOptions: {fillOpacity: 1, weight: 0, color: '#ef4444'}})}]
            }).addTo(map);
        }

        function updateMapPolyline() {
            const latlngs = currentRoute.map(p => [p.coords.lat, p.coords.lng]);
            routePolyline.setLatLngs(latlngs);
            routeDecorator.setPaths(routePolyline);
            if(latlngs.length > 0) map.fitBounds(routePolyline.getBounds(), {padding: [50, 50]});
        }
        
        // --- Core Route-Building Logic ---
        function addPointToRoute(pointId) {
            const cardElement = DOM.placesListContainer.querySelector(`.place-card[data-id="${pointId}"]`);
            if (!cardElement) return;

            cardElement.classList.add('fade-out');

            setTimeout(() => {
                const pointToAdd = availablePoints.find(p => p.id === pointId);
                if (!pointToAdd) return;
                
                currentRoute.push(pointToAdd);
                availablePoints = availablePoints.filter(p => p.id !== pointId);

                renderCurrentRoute();
                updateSuggestions();
                
                const marker = mapMarkers.get(pointId);
                if(marker) {
                    marker.closePopup();
                    marker.unbindPopup();
                    marker.bindPopup(`<b>${pointToAdd.name}</b><br><span class="font-bold text-green-600">住祝 住!</span>`);
                }
            }, 400);
        }
        
        function removePointFromRoute(pointId) {
            const pointToRemove = currentRoute.find(p => p.id === pointId);
            if(!pointToRemove) return;
            
            currentRoute = currentRoute.filter(p => p.id !== pointId);
            availablePoints.push(pointToRemove);
            
            renderCurrentRoute();
            updateSuggestions();
            
            const marker = mapMarkers.get(pointId);
            if(marker) {
                 marker.bindPopup(`<b>${pointToRemove.name}</b><br>${pointToRemove.type}<br><button class="w-full text-center mt-2 p-1 bg-blue-500 text-white rounded text-sm add-point-from-popup" data-id="${pointToRemove.id}">住祝 住</button>`);
            }
        }

        function updateSuggestions() {
            if (currentRoute.length === 0) {
                DOM.suggestionsTitle.textContent = " 拽转  注:";
                availablePoints.forEach(p => delete p.distance);
                availablePoints.sort((a,b) => a.name.localeCompare(b.name, 'he'));
            } else {
                DOM.suggestionsTitle.textContent = "爪注转 拽  (拽专 转专):";
                const lastPoint = currentRoute[currentRoute.length - 1];
                availablePoints.forEach(p => { p.distance = calculateDistance(lastPoint.coords, p.coords); });
                availablePoints.sort((a, b) => a.distance - b.distance);
            }
            renderAvailablePoints();
        }

        function calculateDistance(coords1, coords2) {
            if(!coords1 || !coords2) return Infinity;
            const R = 6371; // km
            const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;
            const dLon = (coords2.lng - coords1.lng) * Math.PI / 180;
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) + Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) * Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            DOM.createRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.remove('hidden');
                DOM.createRouteModal.classList.add('flex');
            });

            DOM.cancelCreateRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.add('hidden');
                DOM.createRouteModal.classList.remove('flex');
            });
            
            DOM.createRouteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const routeName = document.getElementById('new-route-name').value;
                const destination = DOM.destinationSelect.value;
                if(routeName && destination) startRouteBuilding(routeName, destination);
            });

            DOM.searchPlacesInput.addEventListener('input', () => updateSuggestions());
            DOM.categoryFilterSelect.addEventListener('change', () => updateSuggestions());
            
            DOM.placesListContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.place-card');
                if (!card) return;
                const id = card.dataset.id;
                if (e.target.closest('.add-point-btn')) addPointToRoute(id);
            });
            
            DOM.placesListContainer.addEventListener('mouseover', e => {
                const card = e.target.closest('.place-card');
                if (card) {
                    const marker = mapMarkers.get(card.dataset.id);
                    marker?.getElement()?.classList.add('highlight');
                }
            });
             DOM.placesListContainer.addEventListener('mouseout', e => {
                const card = e.target.closest('.place-card');
                if (card) {
                    const marker = mapMarkers.get(card.dataset.id);
                    marker?.getElement()?.classList.remove('highlight');
                }
            });
            
            DOM.routeStepsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-step-btn');
                if (removeBtn) removePointFromRoute(removeBtn.dataset.id);
            });
            
            map?.on('popupopen', (e) => {
                const addBtn = e.popup._container.querySelector('.add-point-from-popup');
                if (addBtn) addBtn.onclick = () => addPointToRoute(addBtn.dataset.id);
            });
             map?.on('mouseover', e => {
                if(e.originalEvent.target.closest('.leaflet-marker-icon')){
                   // This is complex to link back to the card, so we'll skip this side of the interaction for now.
                }
            });

            DOM.finishRouteBtn.addEventListener('click', () => {
                console.log("Finished Route:", currentRoute);
                alert(`住 "${DOM.routeTitle.textContent}" 砖专 注 ${currentRoute.length} 转转!`);
            });
        }
        
        initPage();
    </script>
</body>
</html>

