<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <title>בניית מסלול חכם</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #6366f1; /* Indigo 500 */
            --primary-dark: #4f46e5;
            --bg-app: #f1f5f9;
            --surface: #ffffff;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            box-sizing: border-box;
        }

        html, body {
            height: 100dvh; /* שימוש ב-dvh למובייל */
            width: 100%;
            overflow: hidden;
            font-family: 'Assistant', sans-serif;
            background-color: var(--bg-app);
            color: #1e293b;
            user-select: none;
        }

        input, textarea, select {
            user-select: text;
        }

        /* הסתרת סרגל גלילה אך השארת פונקציונליות */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* אנימציות */
        .fade-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .slide-up { animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* עיצוב כפתורים מותאם */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 12px;
            font-weight: 600;
            transition: transform 0.1s, background-color 0.2s;
            cursor: pointer;
        }
        .btn:active { transform: scale(0.96); }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--primary-dark));
            color: white;
            box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
        }
        
        .btn-secondary {
            background-color: white;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        /* עיצוב רשימת המסלול */
        .timeline-line {
            position: absolute;
            top: 40px;
            right: 24px; /* מרכז האייקון */
            bottom: -20px;
            width: 2px;
            background: #e2e8f0;
            z-index: 0;
        }
        .route-step:last-child .timeline-line { display: none; }

        .route-step {
            position: relative;
            z-index: 1;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        /* גרירה */
        .dragging {
            opacity: 0.9;
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 50;
            background-color: #fff;
            border: 1px solid var(--primary-color);
        }
        .drag-over {
            border-top: 3px solid var(--primary-color);
            margin-top: 10px;
        }

        /* כרטיס מקום */
        .place-card {
            transition: transform 0.1s;
        }
        .place-card:active {
            transform: scale(0.98);
            background-color: #f8fafc;
        }

        /* טאבים בסיכום */
        .tab-btn {
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }
        .tab-active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
            background-color: rgba(99, 102, 241, 0.05);
        }

        /* מסך טעינה */
        .loader {
            width: 48px;
            height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--primary-color);
            border-radius: 50%;
            display: inline-block;
            box-sizing: border-box;
            animation: rotation 1s linear infinite;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* סגנון מרקרים */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            font-weight: bold;
        }

        /* התאמות ל-Leaflet */
        .leaflet-pane { z-index: 0 !important; }
        .leaflet-bottom { z-index: 10 !important; }

        /* Chips לקטגוריות */
        .category-chip {
            white-space: nowrap;
            padding: 6px 16px;
            border-radius: 999px;
            background: #f1f5f9;
            color: #64748b;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            border: 1px solid transparent;
        }
        .category-chip.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }
    </style>
</head>
<body class="flex flex-col">

    <!-- מסך טעינה -->
    <div id="loading-overlay" class="fixed inset-0 bg-white z-[100] flex flex-col items-center justify-center">
        <span class="loader mb-4 border-slate-200 border-b-indigo-600"></span>
        <p class="text-slate-500 font-bold animate-pulse">טוען את הטיול שלך...</p>
    </div>

    <!-- כותרת עליונה -->
    <header class="bg-white/90 backdrop-blur-md shadow-sm border-b border-slate-100 shrink-0 sticky top-0 z-40">
        <div class="px-4 h-14 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button id="back-to-trip-btn" class="w-8 h-8 flex items-center justify-center rounded-full active:bg-slate-100 text-slate-600">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div>
                    <h1 class="font-bold text-slate-800 leading-tight">בניית מסלול</h1>
                    <div id="header-subtitle" class="text-xs text-slate-500">תכנון יום טיול</div>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <div id="auth-display" class="hidden sm:block text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-md"></div>
                <button id="all-routes-btn" class="w-9 h-9 flex items-center justify-center rounded-full bg-slate-50 text-slate-600 hover:bg-slate-100">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- תוכן ראשי -->
    <main id="main-content" class="flex-grow overflow-hidden relative w-full max-w-3xl mx-auto flex flex-col">
        
        <!-- View: Empty State (לפני יצירה) -->
        <div id="initial-view" class="flex-grow flex flex-col items-center justify-center p-6 text-center animate-fade-in">
            <div class="w-24 h-24 bg-indigo-50 rounded-full flex items-center justify-center mb-6">
                <i class="fas fa-map-location-dot text-4xl text-indigo-500"></i>
            </div>
            <h2 class="text-2xl font-bold text-slate-800 mb-2">לאן מטיילים היום?</h2>
            <p class="text-slate-500 mb-8 max-w-xs mx-auto">צור מסלול חדש, הוסף אטרקציות וסדר אותן בקלות.</p>
            <button id="create-route-btn" class="btn btn-primary w-full max-w-xs py-3 text-lg shadow-lg shadow-indigo-200">
                <i class="fas fa-plus ml-2"></i> צור מסלול חדש
            </button>
        </div>

        <!-- View: Building State (עריכה) -->
        <div id="building-view" class="hidden flex flex-col h-full">
            <!-- פרטי מסלול (Header של המסלול) -->
            <div class="p-4 bg-white border-b border-slate-100 shrink-0">
                <div class="flex justify-between items-start mb-2">
                    <div>
                        <h2 id="route-title" class="text-xl font-bold text-slate-800 leading-none mb-1"></h2>
                        <div class="flex items-center text-sm text-slate-500 gap-1">
                            <i class="fas fa-location-dot text-xs"></i>
                            <span id="route-destination"></span>
                        </div>
                    </div>
                    <button id="save-route-btn" class="btn bg-indigo-600 text-white text-sm px-4 py-1.5 rounded-full shadow-md shadow-indigo-200">
                        שמור
                    </button>
                </div>
                
                <!-- Toggle ציבורי/פרטי -->
                <div class="flex items-center gap-2 mt-3 bg-slate-50 p-2 rounded-lg w-fit">
                    <span class="text-xs font-bold text-slate-500">פרטי</span>
                    <button id="is-public-toggle" class="relative w-10 h-5 bg-indigo-500 rounded-full transition-colors duration-200" role="switch" aria-checked="true">
                        <span class="absolute top-0.5 left-0.5 w-4 h-4 bg-white rounded-full transition-transform duration-200 translate-x-5 shadow-sm"></span>
                    </button>
                    <span class="text-xs font-bold text-indigo-600">ציבורי</span>
                </div>
            </div>

            <!-- רשימת התחנות (גלילה) -->
            <div class="flex-grow overflow-y-auto no-scrollbar p-4 pb-24 relative bg-slate-50/50" id="route-scroll-area">
                <div id="route-steps-container" class="space-y-0">
                    <!-- Steps Injected Here -->
                </div>
                
                <!-- מצב ריק בתוך העריכה -->
                <div id="empty-route-msg" class="hidden flex flex-col items-center justify-center py-10 opacity-60">
                    <i class="fas fa-route text-4xl text-slate-300 mb-2"></i>
                    <p class="text-slate-400">המסלול ריק, הוסף מקום כדי להתחיל</p>
                </div>
            </div>

            <!-- כפתורים צפים למטה -->
            <div class="absolute bottom-6 left-0 right-0 flex justify-center gap-3 px-4 z-20 pointer-events-none">
                <button id="open-add-place-modal-btn" class="btn btn-primary pointer-events-auto shadow-xl shadow-indigo-200 px-6 py-3 rounded-full text-base">
                    <i class="fas fa-plus ml-2"></i> הוסף מקום
                </button>
                <button id="organize-route-btn" class="btn bg-white text-indigo-600 pointer-events-auto shadow-lg px-4 py-3 rounded-full border border-indigo-100 hidden">
                    <i class="fas fa-magic"></i>
                </button>
                 <button id="open-add-other-modal-btn" class="btn bg-white text-slate-600 pointer-events-auto shadow-lg px-4 py-3 rounded-full border border-slate-200">
                    <i class="fas fa-comment-dots"></i>
                </button>
            </div>
        </div>

        <!-- View: Summary (סיכום) -->
        <div id="summary-view" class="hidden flex flex-col h-full bg-white">
            <div class="grid grid-cols-2 border-b border-slate-100">
                <button id="tab-details" class="py-3 text-sm font-bold tab-active tab-btn">
                    <i class="fas fa-list-ul ml-1"></i> לו"ז ופרטים
                </button>
                <button id="tab-map" class="py-3 text-sm font-bold text-slate-500 tab-btn">
                    <i class="fas fa-map ml-1"></i> מפה
                </button>
            </div>
            
            <div class="flex-grow overflow-hidden relative">
                <!-- תוכן פרטים -->
                <div id="summary-content-details" class="absolute inset-0 overflow-y-auto p-4 space-y-3 pb-20">
                    <!-- דינאמי -->
                </div>
                
                <!-- תוכן מפה -->
                <div id="summary-content-map" class="absolute inset-0 hidden">
                    <div id="summary-map" class="w-full h-full z-0"></div>
                </div>
            </div>

            <!-- פעולות סיכום -->
            <div class="p-3 border-t border-slate-100 flex gap-3 justify-center shrink-0 bg-white">
                 <button id="edit-route-again-btn" class="btn btn-secondary flex-1 py-3 rounded-xl text-sm">
                    <i class="fas fa-pencil ml-2"></i> עריכה
                </button>
                <button id="copy-route-btn" class="btn btn-primary flex-1 py-3 rounded-xl shadow-lg shadow-indigo-100 text-sm">
                    <i class="fas fa-copy ml-2"></i> העתק לו"ז
                </button>
            </div>
        </div>

    </main>

    <!-- Modals (Bottom Sheets style on mobile) -->
    
    <!-- Modal: יצירת מסלול -->
    <div id="create-modal" class="fixed inset-0 bg-black/40 z-50 hidden items-center justify-center sm:items-center items-end backdrop-blur-sm">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl p-6 slide-up shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-4">יצירת מסלול חדש</h3>
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-600 block mb-1">שם המסלול</label>
                    <input type="text" id="new-route-name" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="לדוגמה: יום כיף בירושלים">
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-600 block mb-1">יעד</label>
                    <div class="relative">
                        <select id="destination-select" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 appearance-none focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="" disabled selected>בחר יעד...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('create-modal')" class="flex-1 btn btn-secondary py-3">ביטול</button>
                    <button type="submit" class="flex-1 btn btn-primary py-3">צור מסלול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: הוספת מקום (Full Height Sheet) -->
    <div id="add-place-modal" class="fixed inset-0 bg-black/40 z-[60] hidden items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-lg h-[90dvh] sm:h-[80vh] sm:rounded-2xl rounded-t-2xl flex flex-col slide-up shadow-2xl overflow-hidden">
            <!-- Header -->
            <div class="p-4 border-b border-slate-100 flex items-center justify-between shrink-0">
                <h3 class="font-bold text-lg">הוספת מקום</h3>
                <button onclick="closeModal('add-place-modal')" class="w-8 h-8 bg-slate-50 rounded-full flex items-center justify-center text-slate-500">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <!-- Search & Filter -->
            <div class="p-4 pb-2 space-y-3 bg-white shrink-0">
                <div class="relative">
                    <i class="fas fa-search absolute right-3 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="search" id="modal-search" class="w-full bg-slate-50 border border-slate-200 rounded-xl py-2.5 pr-10 pl-3 outline-none focus:border-indigo-500 transition" placeholder="חפש מקום...">
                </div>
                
                <!-- Category Chips (Horizontal Scroll) -->
                <div class="flex gap-2 overflow-x-auto no-scrollbar py-1" id="category-chips-container">
                    <button class="category-chip active" data-cat="all">הכל</button>
                    <!-- דינאמי -->
                </div>
            </div>

            <!-- List -->
            <div id="places-list" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50/50">
                <!-- תוכן דינאמי -->
            </div>
        </div>
    </div>

    <!-- Modal: הוספת הערה/אחר -->
    <div id="other-modal" class="fixed inset-0 bg-black/40 z-[60] hidden items-end sm:items-center justify-center backdrop-blur-sm">
        <div class="bg-white w-full max-w-md sm:rounded-2xl rounded-t-2xl p-6 slide-up shadow-2xl">
            <h3 class="text-xl font-bold text-slate-800 mb-4">הוספת הערה אישית</h3>
            <form id="add-other-form" class="space-y-4">
                <div>
                    <label class="text-sm font-bold text-slate-600 block mb-1">כותרת</label>
                    <input type="text" id="other-name" required class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="לדוגמה: הפסקת קפה">
                </div>
                <div>
                    <label class="text-sm font-bold text-slate-600 block mb-1">פירוט (אופציונלי)</label>
                    <textarea id="other-desc" class="w-full bg-slate-50 border border-slate-200 rounded-xl p-3 focus:ring-2 focus:ring-indigo-500 outline-none" rows="3"></textarea>
                </div>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('other-modal')" class="flex-1 btn btn-secondary py-3">ביטול</button>
                    <button type="submit" class="flex-1 btn btn-primary py-3">הוסף</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-4 left-1/2 -translate-x-1/2 bg-slate-800/90 text-white px-6 py-3 rounded-full shadow-xl z-[100] transition-all duration-300 -translate-y-20 opacity-0 flex items-center gap-2 backdrop-blur-sm whitespace-nowrap">
        <i class="fas fa-check-circle text-green-400"></i>
        <span id="toast-msg" class="text-sm font-medium"></span>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        // --- Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Icons & Colors Config ---
        const categoryConfig = {
            "מסעדה/אוכל": { icon: "fa-utensils", color: "#fb923c", bg: "#ffedd5" },
            "מלון": { icon: "fa-bed", color: "#8b5cf6", bg: "#ede9fe" },
            "מוזיאון": { icon: "fa-landmark", color: "#78716c", bg: "#f5f5f4" },
            "קניות": { icon: "fa-bag-shopping", color: "#ec4899", bg: "#fce7f3" },
            "אטרקציה": { icon: "fa-star", color: "#f59e0b", bg: "#fef3c7" },
            "טבע/פארק": { icon: "fa-tree", color: "#10b981", bg: "#d1fae5" },
            "חוף": { icon: "fa-umbrella-beach", color: "#06b6d4", bg: "#cffafe" },
            "other": { icon: "fa-note-sticky", color: "#64748b", bg: "#f1f5f9" },
            "default": { icon: "fa-location-dot", color: "#6366f1", bg: "#e0e7ff" }
        };

        // --- State ---
        let state = {
            user: null,
            tripId: null,
            tripData: null,
            allPlaces: [],
            availablePoints: [], // Places + Hotels
            currentRoute: {
                id: null,
                name: '',
                destination: '',
                steps: [],
                isPublic: true,
                createdBy: null
            },
            map: null,
            markers: []
        };

        // --- DOM Elements ---
        const els = {
            loading: document.getElementById('loading-overlay'),
            views: {
                initial: document.getElementById('initial-view'),
                building: document.getElementById('building-view'),
                summary: document.getElementById('summary-view')
            },
            modals: {
                create: document.getElementById('create-modal'),
                place: document.getElementById('add-place-modal'),
                other: document.getElementById('other-modal')
            },
            routeList: document.getElementById('route-steps-container'),
            placeList: document.getElementById('places-list'),
            headerTitle: document.getElementById('route-title'),
            headerDest: document.getElementById('route-destination'),
            publicToggle: document.getElementById('is-public-toggle')
        };

        // --- Init ---
        async function init() {
            const params = new URLSearchParams(window.location.search);
            state.tripId = params.get('id') || params.get('tripId');
            const routeId = params.get('routeId');

            // Setup Links
            document.getElementById('back-to-trip-btn').onclick = () => window.location.href = state.tripId ? `trip.html?id=${state.tripId}` : '#';
            document.getElementById('all-routes-btn').onclick = () => window.location.href = state.tripId ? `all_routes.html?id=${state.tripId}` : '#';

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                state.user = user;
                document.getElementById('auth-display').textContent = user.displayName?.split(' ')[0] || 'אורח';

                try {
                    await loadData(); // Load trip data & places
                    
                    if (routeId) {
                        await loadRoute(routeId);
                    } else {
                        populateDestinations();
                        els.loading.classList.add('hidden');
                    }
                } catch (e) {
                    console.error(e);
                    showToast('שגיאה בטעינת הנתונים', true);
                    els.loading.classList.add('hidden');
                }
            });
        }

        async function loadData() {
            if (!state.tripId) return;

            // 1. Get Trip Meta
            const tripSnap = await getDoc(doc(db, 'trips', state.tripId));
            if (tripSnap.exists()) state.tripData = tripSnap.data();

            // 2. Get Places
            const placesSnap = await getDocs(collection(db, 'trips', state.tripId, 'places'));
            const places = placesSnap.docs.map(d => ({id: d.id, ...d.data(), pointType: 'place'}));

            // 3. Get Hotels
            const hotelsSnap = await getDocs(query(collection(db, 'trips', state.tripId, 'logistics'), where("type", "==", "hotel")));
            const hotels = hotelsSnap.docs.map(d => ({id: d.id, ...d.data(), pointType: 'hotel', type: 'מלון'}));

            state.allPlaces = [...places, ...hotels];
        }

        function populateDestinations() {
            const select = document.getElementById('destination-select');
            select.innerHTML = '<option value="" disabled selected>בחר יעד...</option>';
            state.tripData?.destinations?.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.nameHe;
                opt.textContent = d.nameHe;
                select.appendChild(opt);
            });
        }

        // --- Route Logic ---

        async function loadRoute(routeId) {
            const snap = await getDoc(doc(db, 'trips', state.tripId, 'routes', routeId));
            if (snap.exists()) {
                const data = snap.data();
                state.currentRoute = { id: snap.id, ...data };
                startBuilding(false); // false = not new
            } else {
                showToast('המסלול לא נמצא', true);
                els.loading.classList.add('hidden');
            }
        }

        function startBuilding(isNew = true, name = '', dest = '') {
            if (isNew) {
                state.currentRoute = {
                    id: null,
                    name: name,
                    destination: dest,
                    steps: [],
                    isPublic: true,
                    createdBy: state.user.uid,
                    tripId: state.tripId
                };
            }

            // Filter available points by destination
            state.availablePoints = state.allPlaces.filter(p => p.destination === state.currentRoute.destination);

            // UI Updates
            els.headerTitle.textContent = state.currentRoute.name;
            els.headerDest.textContent = state.currentRoute.destination;
            updatePublicToggle(state.currentRoute.isPublic);

            els.views.initial.classList.add('hidden');
            els.views.summary.classList.add('hidden');
            els.views.building.classList.remove('hidden');
            els.loading.classList.add('hidden');

            renderRouteSteps();
            
            // Show organize button if enough points
            document.getElementById('organize-route-btn').classList.toggle('hidden', state.currentRoute.steps.length < 3);
        }

        function renderRouteSteps() {
            const container = els.routeList;
            container.innerHTML = '';

            if (state.currentRoute.steps.length === 0) {
                document.getElementById('empty-route-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('empty-route-msg').classList.add('hidden');

            state.currentRoute.steps.forEach((step, index) => {
                const isLast = index === state.currentRoute.steps.length - 1;
                const config = categoryConfig[step.type] || categoryConfig.default;
                
                // Calculate distance if possible
                let distText = '';
                if (index > 0) {
                    const prev = state.currentRoute.steps[index-1];
                    if (prev.coords && step.coords) {
                        const d = calculateDistance(prev.coords, step.coords);
                        distText = `<div class="absolute -top-4 right-[22px] z-0 bg-slate-100 text-[10px] text-slate-500 px-1.5 py-0.5 rounded-full border border-slate-200 shadow-sm">${d.toFixed(1)} ק"מ</div>`;
                    }
                }

                const div = document.createElement('div');
                div.className = 'route-step relative flex gap-3 pb-6 select-none';
                div.dataset.index = index;
                
                div.innerHTML = `
                    <div class="timeline-line"></div>
                    ${distText}
                    
                    <!-- Icon & Handle -->
                    <div class="flex flex-col items-center gap-1 z-10 shrink-0">
                        <div class="w-12 h-12 rounded-full flex items-center justify-center text-lg shadow-sm border-2 border-white relative" style="background-color: ${config.bg}; color: ${config.color}">
                            <i class="fas ${config.icon}"></i>
                            <div class="absolute -bottom-1 -right-1 bg-slate-800 text-white text-[10px] w-5 h-5 flex items-center justify-center rounded-full border-2 border-white font-bold">${index + 1}</div>
                        </div>
                        <!-- Drag Handle: only touch here triggers drag -->
                        <div class="drag-handle w-8 h-8 flex items-center justify-center text-slate-300 active:text-indigo-500 cursor-grab touch-none mt-1">
                            <i class="fas fa-grip-vertical"></i>
                        </div>
                    </div>

                    <!-- Content -->
                    <div class="flex-grow min-w-0 pt-1">
                        <div class="bg-white p-3.5 rounded-2xl shadow-sm border border-slate-100 relative group">
                             <div class="flex justify-between items-start">
                                <div>
                                    <h4 class="font-bold text-slate-800 leading-tight">${step.name}</h4>
                                    <p class="text-xs text-slate-500 mt-0.5 truncate max-w-[200px]">${step.description || step.type}</p>
                                </div>
                                <button class="remove-btn text-slate-300 hover:text-red-500 px-2 -mr-2" onclick="removeStep(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                             </div>
                        </div>
                    </div>
                `;
                
                // Attach Drag Events to the Handle Only
                const handle = div.querySelector('.drag-handle');
                setupDragEvents(handle, div);

                container.appendChild(div);
            });
        }

        // --- Drag & Drop Logic (Mobile Optimized) ---
        let draggedItem = null;
        let placeholder = null;
        let dragStartY = 0;

        function setupDragEvents(handle, item) {
            // Touch
            handle.addEventListener('touchstart', (e) => {
                // e.preventDefault(); // Stop scroll only on handle
                dragStartY = e.touches[0].clientY;
                draggedItem = item;
                
                // Haptic feedback
                if (navigator.vibrate) navigator.vibrate(50);
                
                item.classList.add('dragging');
                
                // Create Placeholder
                placeholder = document.createElement('div');
                placeholder.className = 'h-24 bg-slate-100 rounded-2xl border-2 border-dashed border-slate-300 my-2 opacity-50 transition-all';
                item.parentNode.insertBefore(placeholder, item.nextSibling);
                item.style.position = 'fixed';
                item.style.width = (item.offsetWidth) + 'px';
                item.style.left = item.getBoundingClientRect().left + 'px';
                item.style.top = (e.touches[0].clientY - 40) + 'px';
            }, {passive: false});

            handle.addEventListener('touchmove', (e) => {
                if (!draggedItem) return;
                e.preventDefault(); // Prevent scroll while dragging
                
                const touchY = e.touches[0].clientY;
                draggedItem.style.top = (touchY - 40) + 'px';

                // Detect element below
                const elemBelow = document.elementFromPoint(e.touches[0].clientX, touchY);
                const stepBelow = elemBelow?.closest('.route-step');
                
                if (stepBelow && stepBelow !== draggedItem && stepBelow !== placeholder) {
                    const box = stepBelow.getBoundingClientRect();
                    const offset = touchY - box.top - box.height / 2;
                    if (offset < 0) {
                        stepBelow.parentNode.insertBefore(placeholder, stepBelow);
                    } else {
                        stepBelow.parentNode.insertBefore(placeholder, stepBelow.nextSibling);
                    }
                }
            }, {passive: false});

            handle.addEventListener('touchend', endDrag);
            handle.addEventListener('touchcancel', endDrag);

            // Desktop Mouse (Basic fallback)
            handle.addEventListener('mousedown', (e) => {
               // Similar logic can be added here if needed for desktop mouse drag
            });
        }

        function endDrag() {
            if (!draggedItem) return;
            
            // Find new index
            const allSteps = Array.from(els.routeList.querySelectorAll('.route-step:not(.dragging)'));
            // Insert dragged item back to DOM at placeholder position
            placeholder.parentNode.insertBefore(draggedItem, placeholder);
            placeholder.remove();
            
            draggedItem.style.position = '';
            draggedItem.style.width = '';
            draggedItem.style.left = '';
            draggedItem.style.top = '';
            draggedItem.classList.remove('dragging');

            // Reorder Data
            const newOrder = Array.from(els.routeList.children).map(child => {
                return state.currentRoute.steps[parseInt(child.dataset.index)];
            }).filter(Boolean); // Filter nulls just in case

            state.currentRoute.steps = newOrder;
            draggedItem = null;
            placeholder = null;
            
            renderRouteSteps(); // Re-render to fix indices
        }

        // --- Modals Logic ---
        
        window.openCreateModal = () => {
            els.modals.create.classList.remove('hidden');
            els.modals.create.classList.add('flex');
        };
        
        window.openAddPlaceModal = () => {
            renderPlacesList();
            els.modals.place.classList.remove('hidden');
            els.modals.place.classList.add('flex');
            document.getElementById('modal-search').focus();
        };

        window.closeModal = (id) => {
            const m = document.getElementById(id);
            m.classList.add('hidden');
            m.classList.remove('flex');
        };

        // --- Places Logic ---

        function renderPlacesList(filterText = '', category = 'all') {
            const container = els.placeList;
            container.innerHTML = '';
            
            let filtered = state.availablePoints.filter(p => p.name.includes(filterText));
            if (category !== 'all') {
                filtered = filtered.filter(p => p.type === category || (category === 'other' && !p.type));
            }

            // Categories for chips
            const categories = ['all', ...new Set(state.availablePoints.map(p => p.type || 'other'))];
            renderChips(categories, category);

            filtered.forEach(p => {
                const config = categoryConfig[p.type] || categoryConfig.default;
                const el = document.createElement('div');
                el.className = 'place-card bg-white p-3 rounded-xl border border-slate-100 shadow-sm flex items-center justify-between';
                el.innerHTML = `
                    <div class="flex items-center gap-3 overflow-hidden">
                        <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg shrink-0" style="background: ${config.bg}; color: ${config.color}">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        <div class="truncate">
                            <h4 class="font-bold text-slate-800 truncate">${p.name}</h4>
                            <p class="text-xs text-slate-500">${p.type}</p>
                        </div>
                    </div>
                    <button class="w-8 h-8 bg-indigo-50 text-indigo-600 rounded-full flex items-center justify-center hover:bg-indigo-600 hover:text-white transition" onclick="addToRoute('${p.id}')">
                        <i class="fas fa-plus"></i>
                    </button>
                `;
                container.appendChild(el);
            });
        }

        function renderChips(cats, activeCat) {
            const container = document.getElementById('category-chips-container');
            container.innerHTML = '';
            cats.forEach(c => {
                const btn = document.createElement('button');
                btn.className = `category-chip ${c === activeCat ? 'active' : ''}`;
                btn.textContent = c === 'all' ? 'הכל' : c;
                btn.onclick = () => renderPlacesList(document.getElementById('modal-search').value, c);
                container.appendChild(btn);
            });
        }

        window.addToRoute = (id) => {
            const p = state.availablePoints.find(x => x.id === id);
            if (p) {
                state.currentRoute.steps.push(p);
                renderRouteSteps();
                showToast(`הוספת את ${p.name}`);
                window.closeModal('add-place-modal');
            }
        };

        // --- Save & Summary ---

        document.getElementById('save-route-btn').onclick = async function() {
            if (state.currentRoute.steps.length === 0) return showToast('המסלול ריק!', true);
            
            const btn = this;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            try {
                // Save Logic
                const routeRef = state.currentRoute.id 
                    ? doc(db, 'trips', state.tripId, 'routes', state.currentRoute.id)
                    : await addDoc(collection(db, 'trips', state.tripId, 'routes'), state.currentRoute);
                
                state.currentRoute.id = routeRef.id;
                
                // Public/Private logic
                if (state.currentRoute.isPublic) {
                    await setDoc(doc(db, 'publicRoutes', routeRef.id), state.currentRoute);
                } else {
                    await deleteDoc(doc(db, 'publicRoutes', routeRef.id)).catch(()=>{});
                }

                await setDoc(routeRef, state.currentRoute); // Update local with ID if needed

                showToast('המסלול נשמר!');
                showSummary();
            } catch (e) {
                console.error(e);
                showToast('שגיאה בשמירה', true);
            } finally {
                btn.textContent = 'שמור';
            }
        };

        function showSummary() {
            els.views.building.classList.add('hidden');
            els.views.summary.classList.remove('hidden');
            
            // Populate List
            const list = document.getElementById('summary-content-details');
            list.innerHTML = state.currentRoute.steps.map((s, i) => {
                const config = categoryConfig[s.type] || categoryConfig.default;
                return `
                    <div class="flex gap-4 p-4 bg-slate-50 rounded-xl items-center">
                        <span class="font-bold text-slate-400 w-4">${i+1}</span>
                        <i class="fas ${config.icon} w-6 text-center" style="color:${config.color}"></i>
                        <div>
                            <div class="font-bold text-slate-800">${s.name}</div>
                            <div class="text-xs text-slate-500">${s.description || s.type}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // --- Map & Tabs in Summary ---
        
        document.getElementById('tab-details').onclick = () => switchTab('details');
        document.getElementById('tab-map').onclick = () => switchTab('map');

        function switchTab(tab) {
            const detailsBtn = document.getElementById('tab-details');
            const mapBtn = document.getElementById('tab-map');
            const detailsContent = document.getElementById('summary-content-details');
            const mapContent = document.getElementById('summary-content-map');

            if (tab === 'details') {
                detailsBtn.className = 'py-3 text-sm font-bold tab-active tab-btn';
                mapBtn.className = 'py-3 text-sm font-bold text-slate-500 tab-btn';
                detailsContent.classList.remove('hidden');
                mapContent.classList.add('hidden');
            } else {
                mapBtn.className = 'py-3 text-sm font-bold tab-active tab-btn';
                detailsBtn.className = 'py-3 text-sm font-bold text-slate-500 tab-btn';
                mapContent.classList.remove('hidden');
                detailsContent.classList.add('hidden');
                initMap();
            }
        }

        function initMap() {
            if (state.map) {
                state.map.invalidateSize(); // Fix gray tiles issue
                return;
            }
            
            const mapEl = document.getElementById('summary-map');
            if (!mapEl) return;

            state.map = L.map('summary-map', { zoomControl: false }).setView([31.768, 35.213], 13);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap'
            }).addTo(state.map);
            
            // Draw Route
            const points = state.currentRoute.steps.filter(s => s.coords);
            if (points.length === 0) return;

            const latlngs = points.map(p => [p.coords.lat, p.coords.lng]);
            const polyline = L.polyline(latlngs, { color: '#6366f1', weight: 4 }).addTo(state.map);
            state.map.fitBounds(polyline.getBounds(), { padding: [50, 50] });

            // Add Markers
            points.forEach((p, i) => {
                const config = categoryConfig[p.type] || categoryConfig.default;
                const icon = L.divIcon({
                    className: '',
                    html: `<div class="custom-marker" style="background:${config.color}; width:28px; height:28px;">${i+1}</div>`
                });
                L.marker([p.coords.lat, p.coords.lng], { icon }).addTo(state.map).bindPopup(p.name);
            });
        }

        // --- Utils & Event Binding ---

        document.getElementById('create-route-btn').onclick = window.openCreateModal;
        document.getElementById('open-add-place-modal-btn').onclick = window.openAddPlaceModal;
        document.getElementById('open-add-other-modal-btn').onclick = () => {
             els.modals.other.classList.remove('hidden');
             els.modals.other.classList.add('flex');
        };

        // Create Route Form
        document.getElementById('create-route-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('new-route-name').value;
            const dest = document.getElementById('destination-select').value;
            if (name && dest) {
                startBuilding(true, name, dest);
                window.closeModal('create-modal');
            }
        };

        // Add Other Form
        document.getElementById('add-other-form').onsubmit = (e) => {
            e.preventDefault();
            const name = document.getElementById('other-name').value;
            const desc = document.getElementById('other-desc').value;
            state.currentRoute.steps.push({
                id: crypto.randomUUID(),
                name: name,
                description: desc,
                type: 'other',
                pointType: 'other'
            });
            renderRouteSteps();
            window.closeModal('other-modal');
            document.getElementById('add-other-form').reset();
        };

        // Search Listener
        document.getElementById('modal-search').oninput = (e) => {
            renderPlacesList(e.target.value);
        };

        // Edit Again
        document.getElementById('edit-route-again-btn').onclick = () => {
            els.views.summary.classList.add('hidden');
            els.views.building.classList.remove('hidden');
        };
        
        // Remove Step Global
        window.removeStep = (index) => {
            state.currentRoute.steps.splice(index, 1);
            renderRouteSteps();
        };

        // Copy Text
        document.getElementById('copy-route-btn').onclick = () => {
             let msg = `*${state.currentRoute.name}*\n`;
             state.currentRoute.steps.forEach((s, i) => {
                 msg += `${i+1}. ${s.name}\n`;
             });
             navigator.clipboard.writeText(msg);
             showToast('הועתק ללוח!');
        };

        // Toggle Public
        els.publicToggle.onclick = () => {
            const current = els.publicToggle.getAttribute('aria-checked') === 'true';
            updatePublicToggle(!current);
        };

        function updatePublicToggle(isPublic) {
            state.currentRoute.isPublic = isPublic;
            els.publicToggle.setAttribute('aria-checked', isPublic);
            const knob = els.publicToggle.querySelector('span');
            if (isPublic) {
                els.publicToggle.classList.replace('bg-slate-300', 'bg-indigo-500');
                knob.classList.add('translate-x-5');
            } else {
                els.publicToggle.classList.replace('bg-indigo-500', 'bg-slate-300');
                els.publicToggle.classList.add('bg-slate-300'); // Ensure fallback
                knob.classList.remove('translate-x-5');
            }
        }

        // Distance Calc
        function calculateDistance(coords1, coords2) {
            const R = 6371; 
            const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;
            const dLon = (coords2.lng - coords1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        function showToast(msg, isError = false) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').textContent = msg;
            t.querySelector('i').className = isError ? 'fas fa-exclamation-circle text-red-400' : 'fas fa-check-circle text-green-400';
            t.classList.remove('opacity-0', '-translate-y-20');
            setTimeout(() => t.classList.add('opacity-0', '-translate-y-20'), 2500);
        }

        // Start
        init();
    </script>
</body>
</html>