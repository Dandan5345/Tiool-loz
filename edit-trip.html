<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
    <meta name="theme-color" content="#4f46e5">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>בניית מסלול חכם</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&family=Rubik:wght@300;400;500;700&display=swap" rel="stylesheet" />

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca' },
                        surface: '#f8fafc',
                    },
                    fontFamily: {
                        sans: ['Rubik', 'Assistant', 'sans-serif'],
                    },
                    boxShadow: {
                        'glass': '0 8px 32px 0 rgba(31, 38, 135, 0.07)',
                        'up': '0 -4px 20px -2px rgba(0, 0, 0, 0.05)',
                    },
                    animation: {
                        'slide-up': 'slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards',
                        'fade-in': 'fadeIn 0.2s ease-out forwards',
                        'bounce-soft': 'bounceSoft 2s infinite',
                    },
                    keyframes: {
                        slideUp: {
                            '0%': { transform: 'translateY(100%)' },
                            '100%': { transform: 'translateY(0)' },
                        },
                        fadeIn: {
                            '0%': { opacity: '0', transform: 'scale(0.95)' },
                            '100%': { opacity: '1', transform: 'scale(1)' },
                        },
                        bounceSoft: {
                            '0%, 100%': { transform: 'translateY(-5%)' },
                            '50%': { transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --sat: env(safe-area-inset-top);
            --sab: env(safe-area-inset-bottom);
        }

        html, body {
            height: 100dvh;
            width: 100%;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent;
            background-color: #f8fafc;
        }

        body {
            font-family: 'Rubik', sans-serif;
            color: #1e293b;
            -webkit-user-select: none;
            user-select: none;
        }

        /* Inputs */
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
            font-size: 16px !important; /* Prevent iOS zoom */
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Timeline */
        .timeline-line {
            position: absolute;
            top: 3.5rem;
            bottom: -1rem;
            right: 1.65rem; /* Center with icon */
            width: 2px;
            background: linear-gradient(to bottom, #cbd5e1 50%, transparent 50%);
            background-size: 2px 10px;
            z-index: 0;
        }
        .route-step:last-child .timeline-line { display: none; }

        /* Drag & Drop Styling */
        .route-step {
            transition: transform 0.2s cubic-bezier(0.2, 0, 0.2, 1), box-shadow 0.2s;
            touch-action: pan-y; /* Allow vertical scroll unless dragging */
        }
        .route-step.dragging {
            opacity: 0.9;
            transform: scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            z-index: 50;
            background: #fff;
            border: 2px solid #6366f1;
        }
        .drag-over-item {
            transform: translateY(10px);
            border-top: 2px solid #6366f1;
        }

        /* Map Markers */
        .custom-marker {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 3px solid white;
            box-shadow: 0 4px 6px -1px rgba(0,0,0,0.3);
            transition: transform 0.2s;
        }
        .custom-marker:active { transform: scale(0.9); }

        /* Modal Styles */
        .modal-overlay {
            transition: opacity 0.3s ease;
        }
        .modal-content {
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        
        /* Mobile specific modal adjustments */
        @media (max-width: 640px) {
            .modal-content-bottom {
                position: absolute;
                bottom: 0;
                left: 0;
                right: 0;
                border-bottom-left-radius: 0;
                border-bottom-right-radius: 0;
                max-height: 95dvh;
            }
        }

        /* Checkbox Custom Style */
        .custom-checkbox:checked + div {
            border-color: #4f46e5;
            background-color: #eef2ff;
        }
        .custom-checkbox:checked + div .check-icon {
            display: block;
        }
    </style>
</head>
<body class="flex flex-col h-full bg-surface text-slate-800">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/95 backdrop-blur-md z-[100] flex flex-col items-center justify-center gap-6 transition-opacity duration-500">
        <div class="relative w-20 h-20">
            <div class="absolute inset-0 border-4 border-indigo-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-indigo-600 rounded-full border-t-transparent animate-spin"></div>
            <i class="fas fa-map-location-dot absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-indigo-600 text-2xl animate-pulse"></i>
        </div>
        <p class="text-lg font-medium text-slate-600 animate-bounce-soft">טוען את המסלול...</p>
    </div>

    <!-- Header -->
    <header class="glass sticky top-0 z-40 pt-[var(--sat)] shadow-sm">
        <div class="container mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button id="back-to-trip-btn" class="w-10 h-10 flex items-center justify-center rounded-full bg-slate-50 text-slate-600 hover:bg-slate-100 active:scale-95 transition-all">
                    <i class="fas fa-chevron-right text-lg"></i>
                </button>
                <div>
                    <h1 class="text-base font-bold leading-tight">בניית מסלול</h1>
                    <div id="auth-container" class="text-xs text-slate-500">אורח</div>
                </div>
            </div>
            
            <div class="flex gap-2">
                 <!-- AI Button -->
                 <button id="btn-open-ai" class="btn-secondary w-auto px-3 h-10 rounded-full bg-gradient-to-r from-violet-500 to-indigo-600 text-white flex items-center justify-center active:scale-95 transition-all shadow-md gap-2">
                    <i class="fas fa-wand-magic-sparkles"></i>
                    <span class="text-xs font-bold hidden sm:inline">פורמט AI</span>
                </button>

                <button id="btn-show-summary" class="hidden btn-secondary w-10 h-10 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center active:scale-95 transition-all">
                    <i class="fas fa-list-check"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area -->
    <main id="main-content" class="flex-grow flex flex-col relative overflow-hidden hidden">
        
        <!-- Welcome / Empty State -->
        <div id="initial-state" class="absolute inset-0 flex flex-col items-center justify-center p-8 text-center animate-fade-in z-10 bg-surface">
            <div class="w-32 h-32 bg-gradient-to-tr from-indigo-100 to-white rounded-full flex items-center justify-center mb-6 shadow-lg shadow-indigo-100">
                <i class="fas fa-wand-magic-sparkles text-5xl text-indigo-500"></i>
            </div>
            <h2 class="text-2xl font-bold mb-2 text-slate-800">מתכננים את הטיול</h2>
            <p class="text-slate-500 mb-8 max-w-[280px] leading-relaxed">בואו ניצור את סדר היום המושלם. בחרו מקומות, סדרו אותם וצאו לדרך.</p>
            <button id="create-route-btn" class="w-full max-w-xs bg-indigo-600 text-white py-4 rounded-2xl font-bold shadow-xl shadow-indigo-200 hover:bg-indigo-700 active:scale-95 transition-all flex items-center justify-center gap-2">
                <i class="fas fa-plus"></i>
                יצירת מסלול חדש
            </button>
        </div>

        <!-- Builder Interface -->
        <div id="building-state" class="hidden flex flex-col h-full w-full absolute inset-0 bg-surface">
            
            <!-- Route Info Bar -->
            <div class="bg-white px-4 py-3 border-b border-slate-100 flex items-center justify-between shrink-0 shadow-sm z-20">
                <div class="min-w-0 flex-1 pr-2">
                    <h2 id="route-title" class="text-lg font-bold text-slate-800 truncate"></h2>
                    <div class="flex items-center text-xs text-slate-500 gap-1">
                        <i class="fas fa-location-dot text-indigo-500"></i>
                        <span id="route-destination" class="truncate"></span>
                    </div>
                </div>
                <div class="flex gap-2 shrink-0">
                    <button id="organize-route-btn" class="w-9 h-9 rounded-xl bg-orange-50 text-orange-600 border border-orange-100 flex items-center justify-center active:scale-90 transition-transform" title="סדר אוטומטי">
                        <i class="fas fa-sort-amount-down"></i>
                    </button>
                    <!-- Mobile Map Toggle -->
                    <button id="toggle-map-view" class="w-9 h-9 rounded-xl bg-indigo-50 text-indigo-600 border border-indigo-100 flex items-center justify-center active:scale-90 transition-transform md:hidden">
                        <i class="fas fa-map"></i>
                    </button>
                </div>
            </div>

            <!-- Steps List -->
            <div id="steps-scroll-area" class="flex-grow overflow-y-auto overflow-x-hidden p-4 pb-32 relative">
                <div id="route-steps-container" class="space-y-0 relative min-h-[50vh]">
                    <!-- Steps Injected Here -->
                </div>
                
                <!-- Empty Route Helper -->
                <div id="start-prompt" class="absolute inset-0 flex flex-col items-center justify-center text-slate-300 pointer-events-none mt-10">
                    <i class="fas fa-route text-5xl mb-3 opacity-30"></i>
                    <p class="font-medium">המסלול ריק עדיין</p>
                    <p class="text-xs mt-1">לחצו על "הוסף מקום" למטה</p>
                </div>
            </div>

            <!-- Sticky Footer Actions -->
            <div class="absolute bottom-0 left-0 right-0 bg-white border-t border-slate-100 p-3 pb-[calc(var(--sab)+0.75rem)] shadow-up z-30">
                <div class="flex gap-3 mb-3">
                    <button id="open-add-place-modal-btn" class="flex-1 bg-indigo-600 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i> הוסף מקום
                    </button>
                    <button id="save-route-btn" class="flex-1 bg-slate-800 text-white py-3.5 rounded-2xl font-bold shadow-lg shadow-slate-200 active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-save"></i> שמירה
                    </button>
                </div>
                <div class="flex justify-between items-center px-2">
                     <div class="flex items-center gap-2" onclick="document.getElementById('is-public-toggle').click()">
                        <div class="relative inline-flex items-center cursor-pointer">
                            <input type="checkbox" id="is-public-toggle" class="sr-only peer" checked>
                            <div class="w-9 h-5 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-indigo-600"></div>
                        </div>
                        <span class="text-xs font-medium text-slate-600">שתף בקהילה</span>
                    </div>
                    <button id="open-add-other-btn" class="text-xs font-medium text-slate-500 hover:text-indigo-600 transition-colors py-1 px-2">
                        <i class="fas fa-pen ml-1"></i>הערה חופשית
                    </button>
                </div>
            </div>
        </div>

        <!-- Summary / Print View -->
        <div id="summary-view" class="hidden absolute inset-0 z-50 bg-white flex flex-col h-full">
            <div class="bg-indigo-600 text-white p-6 pt-[calc(var(--sat)+1.5rem)] pb-12 rounded-b-[2.5rem] shadow-xl shrink-0">
                <div class="flex justify-between items-start mb-4">
                    <h2 class="text-2xl font-bold" id="summary-title">סיכום מסלול</h2>
                    <button onclick="closeSummary()" class="bg-white/20 hover:bg-white/30 p-2 rounded-xl backdrop-blur-md transition-colors">
                        <i class="fas fa-pencil"></i> עריכה
                    </button>
                </div>
                <div class="flex gap-4 text-indigo-100 text-sm">
                    <span id="summary-details">...</span>
                </div>
                
                <div class="flex gap-3 mt-6">
                    <button onclick="copyLink()" class="flex-1 bg-white text-indigo-700 py-3 rounded-xl shadow-lg font-bold active:scale-95 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-share-nodes"></i> שתף
                    </button>
                    <button onclick="window.print()" class="flex-1 bg-indigo-800 text-white py-3 rounded-xl shadow-lg font-bold active:scale-95 transition-all flex items-center justify-center gap-2 border border-indigo-700">
                        <i class="fas fa-print"></i> הדפס
                    </button>
                </div>
            </div>

            <div class="flex-grow flex flex-col pt-6 overflow-hidden bg-slate-50 relative">
                <!-- Tab Switcher -->
                <div class="bg-white/50 backdrop-blur mx-6 p-1 rounded-xl flex shadow-sm mb-4 shrink-0">
                    <button onclick="switchTab('list')" id="tab-list" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600">רשימה</button>
                    <button onclick="switchTab('map')" id="tab-map" class="flex-1 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:bg-white/50">מפה</button>
                </div>

                <div id="summary-content-list" class="flex-grow overflow-y-auto px-6 pb-10 space-y-4">
                    <!-- List Content -->
                </div>
                
                <!-- Summary Map Container -->
                <div id="summary-content-map" class="hidden absolute inset-x-0 bottom-0 top-[80px] bg-slate-100">
                     <div id="final-map" class="w-full h-full"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- === Modals === -->

    <!-- Create Route Modal -->
    <div id="create-route-modal" class="fixed inset-0 z-[60] hidden" role="dialog" aria-modal="true">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm modal-overlay" onclick="closeModal('create-route-modal')"></div>
        <div class="absolute bottom-0 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:max-w-md bg-white rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-content modal-content-bottom animate-slide-up">
            <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-6 sm:hidden"></div>
            <h3 class="text-xl font-bold text-slate-800 mb-1">מסלול חדש</h3>
            <p class="text-slate-500 mb-6 text-sm">בחרו שם ויעד כדי להתחיל לארגן.</p>
            
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1.5">שם המסלול</label>
                    <input type="text" id="new-route-name" required class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-all" placeholder="למשל: יום כיף בתל אביב" />
                </div>
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-1.5">יעד</label>
                    <div class="relative">
                        <select id="destination-select" required class="w-full p-3.5 bg-slate-50 border border-slate-200 rounded-xl appearance-none focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="" disabled selected>בחירת יעד...</option>
                        </select>
                        <i class="fas fa-chevron-down absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 pointer-events-none"></i>
                    </div>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="closeModal('create-route-modal')" class="flex-1 bg-slate-100 text-slate-700 py-3.5 rounded-xl font-bold">ביטול</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3.5 rounded-xl font-bold shadow-lg shadow-indigo-200">התחל</button>
                </div>
            </form>
        </div>
    </div>

    <!-- AI Wizard Modal -->
    <div id="ai-wizard-modal" class="fixed inset-0 z-[150] hidden items-end sm:items-center justify-center">
        <div class="absolute inset-0 bg-slate-900/60 backdrop-blur-sm transition-opacity" onclick="closeAiWizard()"></div>
        <div class="relative w-full sm:max-w-lg bg-surface h-[95dvh] sm:h-auto sm:max-h-[90vh] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col animate-slide-up overflow-hidden">
            
            <!-- Header -->
            <div class="bg-indigo-600 p-6 pb-8 text-white relative shrink-0">
                <button onclick="closeAiWizard()" class="absolute top-6 left-6 w-8 h-8 flex items-center justify-center bg-white/20 rounded-full hover:bg-white/30 transition">
                    <i class="fas fa-times"></i>
                </button>
                <div class="w-12 h-12 bg-white/20 rounded-2xl flex items-center justify-center text-2xl mb-3 backdrop-blur-md">
                    <i class="fas fa-robot"></i>
                </div>
                <h2 class="text-2xl font-bold">בונה הלו"ז החכם</h2>
                <p class="text-indigo-200 text-sm">ענו על כמה שאלות וה-AI יבנה לכם תוכנית</p>
                
                <!-- Progress -->
                <div class="absolute bottom-0 left-0 right-0 h-1.5 bg-indigo-800/50">
                    <div id="ai-progress-bar" class="h-full bg-white transition-all duration-300 w-[10%]"></div>
                </div>
            </div>

            <!-- Body (Dynamic) -->
            <div id="ai-wizard-body" class="flex-grow overflow-y-auto p-6 bg-slate-50">
                <!-- Content Injected via JS -->
            </div>

            <!-- Footer Controls -->
            <div class="p-4 bg-white border-t border-slate-100 flex justify-between items-center shrink-0 safe-area-bottom">
                <button id="ai-btn-back" class="text-slate-500 font-bold px-4 py-2 hover:text-slate-800 disabled:opacity-0 transition-opacity" disabled>
                    חזרה
                </button>
                <button id="ai-btn-next" class="bg-indigo-600 text-white px-8 py-3 rounded-xl font-bold shadow-lg shadow-indigo-200 active:scale-95 transition-transform flex items-center gap-2">
                    הבא <i class="fas fa-chevron-left text-xs"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Add Place Modal (Drawer Style) -->
    <div id="add-place-modal" class="fixed inset-0 z-[70] hidden flex-col justify-end sm:justify-center items-center">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm modal-overlay" onclick="closeModal('add-place-modal')"></div>
        <div class="relative w-full sm:max-w-2xl bg-white h-[90dvh] sm:h-[650px] rounded-t-3xl sm:rounded-2xl shadow-2xl flex flex-col animate-slide-up modal-content">
            
            <!-- Handle & Header -->
            <div class="p-4 pb-2 border-b border-slate-100 shrink-0">
                <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-4 sm:hidden"></div>
                <div class="flex items-center justify-between">
                    <div>
                        <h3 class="text-lg font-bold text-slate-800">הוספת מקום</h3>
                        <p class="text-xs text-slate-500">בחרו מהרשימה או חפשו</p>
                    </div>
                    <button onclick="closeModal('add-place-modal')" class="w-8 h-8 bg-slate-100 rounded-full flex items-center justify-center text-slate-500 hover:bg-slate-200 transition-colors">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>

            <!-- Search Bar -->
            <div class="p-3 bg-white flex gap-2 shrink-0">
                <div class="relative flex-grow">
                    <i class="fas fa-search absolute right-3.5 top-1/2 -translate-y-1/2 text-slate-400"></i>
                    <input type="search" id="modal-search-input" class="w-full pl-3 pr-10 py-3 bg-slate-50 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="חיפוש מקום..." />
                </div>
                <button id="open-map-selection-btn" class="bg-indigo-50 text-indigo-600 px-4 rounded-xl text-sm font-bold border border-indigo-100 whitespace-nowrap active:scale-95 transition-transform">
                    <i class="fas fa-map-location-dot ml-1"></i> מפה
                </button>
            </div>
            
            <!-- Filter Chips -->
            <div class="px-3 pb-2 flex gap-2 overflow-x-auto no-scrollbar shrink-0" id="filter-chips-container">
                <!-- Chips injected via JS -->
            </div>

            <!-- Results List -->
            <div id="modal-places-list-container" class="flex-grow overflow-y-auto p-3 space-y-2 bg-slate-50">
                <!-- Items injected via JS -->
            </div>
        </div>
    </div>

    <!-- Map Modal (Full Screen - Shared Container for Picker and Preview) -->
    <div id="map-selection-modal" class="fixed inset-0 z-[80] hidden flex-col bg-white animate-slide-up">
        <div class="p-3 bg-white border-b border-slate-100 flex items-center justify-between shadow-sm shrink-0 z-10 pt-[var(--sat)]">
            <h3 id="map-modal-title" class="text-lg font-bold text-slate-800 pr-2">מפה</h3>
            <button id="close-map-btn" class="bg-slate-100 px-4 py-2 rounded-full text-sm font-bold text-slate-700 hover:bg-slate-200">
                <i class="fas fa-times ml-1"></i> סגור
            </button>
        </div>
        <div class="flex-grow relative bg-slate-100">
             <div id="map-modal-container" class="absolute inset-0 w-full h-full"></div>
        </div>
        <!-- Helper pill on map -->
        <div id="map-helper-pill" class="hidden absolute bottom-8 left-1/2 -translate-x-1/2 z-[400] bg-slate-800/90 backdrop-blur text-white px-4 py-2 rounded-full text-sm font-medium shadow-lg pointer-events-none">
            לחצו על סיכה להוספה
        </div>
    </div>

    <!-- Add Note Modal -->
    <div id="add-other-modal" class="fixed inset-0 z-[65] hidden" role="dialog">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm modal-overlay" onclick="closeModal('add-other-modal')"></div>
        <div class="absolute bottom-0 sm:top-1/2 sm:left-1/2 sm:-translate-x-1/2 sm:-translate-y-1/2 w-full sm:max-w-sm bg-white rounded-t-3xl sm:rounded-3xl p-6 shadow-2xl modal-content animate-slide-up">
            <h3 class="text-lg font-bold text-slate-800 mb-4">הוספת הערה / משימה</h3>
            <form id="add-other-form" class="space-y-3">
                <input type="text" id="other-name" required class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-indigo-500 outline-none" placeholder="כותרת (למשל: הפסקת צהריים)" />
                <textarea id="other-description" class="w-full p-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-indigo-500 outline-none" rows="3" placeholder="פרטים נוספים..."></textarea>
                <div class="flex gap-3 pt-2">
                    <button type="button" onclick="closeModal('add-other-modal')" class="flex-1 bg-slate-100 text-slate-700 py-3 rounded-xl font-bold">ביטול</button>
                    <button type="submit" class="flex-1 bg-indigo-600 text-white py-3 rounded-xl font-bold">הוסף</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Custom Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/50 backdrop-blur-sm transition-opacity"></div>
        <div class="relative w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl animate-slide-up sm:animate-fade-in text-center">
            <div class="w-14 h-14 bg-red-100 text-red-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-question text-2xl"></i>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-slate-800 mb-2"></h3>
            <p id="confirm-message" class="text-slate-500 mb-6 text-sm"></p>
            <div class="flex gap-3">
                <button id="confirm-cancel-btn" class="flex-1 py-3 rounded-xl border border-slate-200 text-slate-700 font-bold hover:bg-slate-50">ביטול</button>
                <button id="confirm-ok-btn" class="flex-1 py-3 rounded-xl bg-red-500 text-white font-bold shadow-lg shadow-red-200 hover:bg-red-600">אישור</button>
            </div>
        </div>
    </div>

    <!-- Alert Modal (Custom) -->
    <div id="alert-modal" class="fixed inset-0 z-[100] hidden items-center justify-center p-4">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="closeModal('alert-modal')"></div>
        <div class="relative w-full max-w-sm bg-white rounded-2xl p-6 shadow-2xl animate-slide-up text-center">
             <div class="w-14 h-14 bg-indigo-100 text-indigo-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-info text-2xl"></i>
            </div>
            <h3 id="alert-title" class="text-xl font-bold text-slate-800 mb-2">שים לב</h3>
            <p id="alert-message" class="text-slate-500 mb-6 text-sm"></p>
            <button onclick="closeModal('alert-modal')" class="w-full py-3 rounded-xl bg-indigo-600 text-white font-bold">הבנתי</button>
        </div>
    </div>

    <!-- Toast Notification -->
    <div id="toast" class="fixed top-6 right-1/2 translate-x-1/2 bg-slate-800/95 backdrop-blur text-white py-3 px-6 rounded-full shadow-2xl transition-all duration-300 -translate-y-24 opacity-0 z-[200] flex items-center gap-3 min-w-max border border-slate-700/50">
        <i class="fas fa-check-circle text-green-400 text-lg"></i>
        <span id="toast-message" class="font-medium text-sm"></span>
    </div>

    <!-- Scripts -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // === Config ===
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // === State ===
        let state = {
            user: null,
            tripId: null,
            tripData: null,
            route: { id: null, name: '', destination: '', steps: [], isPublic: true, createdBy: null },
            places: [],
            hotels: [],
            availablePoints: [],
            draggedIndex: null,
            maps: { 
                modal: null, // Shared map for Selection AND Route Preview in Modal
                summary: null // Final summary map
            },
            currentMapMode: null
        };

        const categoryConfig = {
            "מסעדה/אוכל": { icon: "fa-utensils", color: "#f97316", bg: "#ffedd5", label: "אוכל" },
            "מלון": { icon: "fa-bed", color: "#8b5cf6", bg: "#f3e8ff", label: "לינה" },
            "מוזיאון": { icon: "fa-landmark", color: "#64748b", bg: "#f1f5f9", label: "תרבות" },
            "קניון/מרכז קניות": { icon: "fa-bag-shopping", color: "#ec4899", bg: "#fce7f3", label: "קניות" },
            "אטרקציה": { icon: "fa-star", color: "#eab308", bg: "#fef9c3", label: "אטרקציה" },
            "חוף": { icon: "fa-umbrella-beach", color: "#06b6d4", bg: "#cffafe", label: "חוף" },
            "סיור": { icon: "fa-person-hiking", color: "#10b981", bg: "#d1fae5", label: "טבע" },
            "סופר": { icon: "fa-cart-shopping", color: "#6366f1", bg: "#e0e7ff", label: "סופר" },
            "other": { icon: "fa-note-sticky", color: "#94a3b8", bg: "#f8fafc", label: "הערה" },
            "default": { icon: "fa-location-dot", color: "#ef4444", bg: "#fee2e2", label: "כללי" }
        };

        // === UI Helpers ===
        window.toggleModal = (id, show) => {
            const el = document.getElementById(id);
            if (show) {
                el.classList.remove('hidden');
                el.classList.add('flex');
                // Animation reset
                const content = el.querySelector('.modal-content');
                if(content) {
                    content.classList.remove('animate-slide-up');
                    void content.offsetWidth; // trigger reflow
                    content.classList.add('animate-slide-up');
                }
            } else {
                el.classList.add('hidden');
                el.classList.remove('flex');
            }
        };

        window.closeModal = (id) => window.toggleModal(id, false);

        window.showToast = (msg, isError = false) => {
            const el = document.getElementById('toast');
            document.getElementById('toast-message').textContent = msg;
            const icon = el.querySelector('i');
            icon.className = isError ? "fas fa-circle-exclamation text-red-400 text-lg" : "fas fa-check-circle text-green-400 text-lg";
            
            el.classList.remove('-translate-y-24', 'opacity-0');
            if(window.toastTimeout) clearTimeout(window.toastTimeout);
            window.toastTimeout = setTimeout(() => el.classList.add('-translate-y-24', 'opacity-0'), 3000);
        };

        window.customAlert = (title, message) => {
            document.getElementById('alert-title').textContent = title;
            document.getElementById('alert-message').textContent = message;
            window.toggleModal('alert-modal', true);
        };

        window.customConfirm = (title, message, onConfirm) => {
            document.getElementById('confirm-title').textContent = title;
            document.getElementById('confirm-message').textContent = message;
            
            const btn = document.getElementById('confirm-ok-btn');
            // Clone to remove old listeners
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = () => {
                onConfirm();
                window.toggleModal('confirm-modal', false);
            };
            
            document.getElementById('confirm-cancel-btn').onclick = () => window.toggleModal('confirm-modal', false);
            window.toggleModal('confirm-modal', true);
        };

        // === AI Wizard Logic ===
        let aiState = {
            step: 0,
            data: {}
        };

        const aiSteps = [
            // Step 0: Destination
            {
                title: 'יעד הנסיעה',
                render: () => {
                    const destinations = state.tripData?.destinations || [];
                    if(destinations.length === 0) return `<p class="text-center text-slate-500">אין יעדים שמורים בטיול זה</p>`;
                    
                    return `
                        <div class="space-y-3">
                            <p class="font-bold text-slate-700">לאיזה יעד תרצה לבנות את הלו"ז?</p>
                            <div class="grid grid-cols-1 gap-2">
                                ${destinations.map(d => `
                                    <label class="relative cursor-pointer group">
                                        <input type="radio" name="ai_dest" value="${d.nameHe}" class="peer sr-only" onchange="window.handleAiInput('dest', '${d.nameHe}')">
                                        <div class="p-4 rounded-xl border border-slate-200 bg-white peer-checked:border-indigo-600 peer-checked:bg-indigo-50 peer-checked:text-indigo-700 transition-all flex items-center justify-between">
                                            <span class="font-bold">${d.nameHe}</span>
                                            <i class="fas fa-check-circle hidden peer-checked:block text-indigo-600"></i>
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                },
                validate: () => aiState.data.dest ? true : 'יש לבחור יעד'
            },
            // Step 1: Dates
            {
                title: 'זמנים',
                render: () => `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">כמה ימים?</label>
                            <select id="ai_days_count" class="w-full p-3 bg-white border border-slate-200 rounded-xl" onchange="window.handleAiInput('days', this.value)">
                                <option value="" disabled selected>בחרו מספר ימים (1-30)</option>
                                ${Array.from({length: 30}, (_, i) => `<option value="${i+1}">${i+1} ימים</option>`).join('')}
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">תאריך התחלה</label>
                            <input type="date" id="ai_start_date" class="w-full p-3 bg-white border border-slate-200 rounded-xl" onchange="window.handleAiInput('startDate', this.value)">
                        </div>
                    </div>
                `,
                validate: () => (aiState.data.days && aiState.data.startDate) ? true : 'יש לבחור מספר ימים ותאריך התחלה'
            },
            // Step 2: Hotel Source
            {
                title: 'לינה',
                render: () => `
                    <div class="space-y-3">
                        <p class="font-bold text-slate-700">היכן אתם ישנים?</p>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="ai_hotel_source" value="saved" class="peer sr-only" onchange="window.handleAiInput('hotelSource', 'saved')">
                            <div class="p-4 rounded-xl border border-slate-200 bg-white peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition-all">
                                <div class="font-bold text-slate-800">אחד המלונות ששמרתי באתר</div>
                                <div class="text-xs text-slate-500 mt-1">מלון שקיים ברשימת הלוגיסטיקה</div>
                            </div>
                        </label>
                        <label class="relative cursor-pointer">
                            <input type="radio" name="ai_hotel_source" value="new" class="peer sr-only" onchange="window.handleAiInput('hotelSource', 'new')">
                            <div class="p-4 rounded-xl border border-slate-200 bg-white peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition-all">
                                <div class="font-bold text-slate-800">מלון שאינו שמור באתר</div>
                            </div>
                        </label>
                    </div>
                `,
                validate: () => {
                    if(!aiState.data.hotelSource) return 'יש לבחור אפשרות';
                    if(aiState.data.hotelSource === 'new') {
                        window.customAlert('עצרו רגע', 'כדי שה-AI יכיר את המלון, עליכם להוסיף אותו תחילה בדף "לוגיסטיקה" באתר.');
                        return false;
                    }
                    return true;
                }
            },
            // Step 3: Select Hotel (Only if 'saved' chosen)
            {
                title: 'בחירת מלון',
                render: () => {
                    const hotelsInDest = state.hotels.filter(h => h.destination === aiState.data.dest);
                    if(hotelsInDest.length === 0) return `<div class="text-center py-4"><p>לא נמצאו מלונות ביעד "${aiState.data.dest}".</p><p class="text-sm text-slate-500 mt-2">הוסיפו מלון בלוגיסטיקה ונסו שוב.</p></div>`;
                    
                    return `
                        <div class="space-y-3">
                            <p class="font-bold text-slate-700">באיזה מלון/ות תשהו?</p>
                            <div class="space-y-2">
                                ${hotelsInDest.map(h => `
                                    <label class="flex items-center p-3 bg-white border border-slate-200 rounded-xl cursor-pointer">
                                        <input type="checkbox" class="custom-checkbox w-5 h-5 text-indigo-600 rounded focus:ring-indigo-500 accent-indigo-600" value="${h.name}" onchange="window.handleAiHotelSelect(this, '${h.name}')">
                                        <span class="mr-3 font-medium text-slate-700">${h.name}</span>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                },
                validate: () => (aiState.data.selectedHotels && aiState.data.selectedHotels.length > 0) ? true : 'יש לבחור לפחות מלון אחד'
            },
            // Step 4: Hotel Dates (Only if >1 hotel selected) - SKIPPED IF 1 HOTEL
            {
                title: 'תאריכי שהייה',
                condition: () => aiState.data.selectedHotels && aiState.data.selectedHotels.length > 1,
                render: () => `
                    <div class="space-y-4">
                        <p class="text-sm text-slate-600">אנא ציינו תאריכים לכל מלון:</p>
                        ${aiState.data.selectedHotels.map((h, i) => `
                            <div class="bg-white p-3 rounded-xl border border-slate-200">
                                <div class="font-bold text-indigo-700 mb-2">${h}</div>
                                <input type="text" placeholder="למשל: 12/10 - 15/10" class="w-full p-2 bg-slate-50 border border-slate-200 rounded-lg text-sm" onchange="window.handleAiInput('hotelDates_${i}', this.value)">
                            </div>
                        `).join('')}
                    </div>
                `,
                validate: () => true // Optional validation
            },
            // Step 5: Times
            {
                title: 'שעות הגעה/עזיבה',
                render: () => `
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">שעת הגעה ליעד</label>
                            <input type="time" class="w-full p-3 bg-white border border-slate-200 rounded-xl" onchange="window.handleAiInput('arrivalTime', this.value)">
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-slate-700 mb-1">שעת עזיבה מהיעד</label>
                            <input type="time" class="w-full p-3 bg-white border border-slate-200 rounded-xl" onchange="window.handleAiInput('departureTime', this.value)">
                        </div>
                    </div>
                `,
                validate: () => true
            },
            // Step 6: Places
            {
                title: 'מקומות לביקור',
                render: () => `
                    <div class="space-y-4">
                        <p class="font-bold text-slate-700">איזה מקומות תרצו לבקר?</p>
                        
                        <label class="relative cursor-pointer block">
                            <input type="radio" name="ai_places_mode" value="all" class="peer sr-only" onchange="window.handleAiPlacesMode('all')" checked>
                            <div class="p-3 rounded-xl border border-slate-200 bg-white peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition-all flex items-center gap-3">
                                <i class="fas fa-layer-group text-slate-400 peer-checked:text-indigo-600"></i>
                                <span>כל המקומות השמורים ב${aiState.data.dest}</span>
                            </div>
                        </label>
                        
                        <label class="relative cursor-pointer block">
                            <input type="radio" name="ai_places_mode" value="select" class="peer sr-only" onchange="window.handleAiPlacesMode('select')">
                            <div class="p-3 rounded-xl border border-slate-200 bg-white peer-checked:border-indigo-600 peer-checked:bg-indigo-50 transition-all flex items-center gap-3">
                                <i class="fas fa-list-check text-slate-400 peer-checked:text-indigo-600"></i>
                                <span>בחירה ספציפית</span>
                            </div>
                        </label>

                        <div id="ai_places_selection" class="hidden space-y-2 mt-2 pl-2 border-r-2 border-slate-100 pr-2 max-h-48 overflow-y-auto">
                             ${state.places.filter(p => p.destination === aiState.data.dest).map(p => `
                                <label class="flex items-center p-2 hover:bg-slate-100 rounded cursor-pointer">
                                    <input type="checkbox" class="w-4 h-4 accent-indigo-600" onchange="window.handleAiPlaceSelect(this, '${p.name.replace(/'/g, "\\'")}', '${p.address || ''}')">
                                    <span class="mr-2 text-sm text-slate-700">${p.name}</span>
                                </label>
                            `).join('')}
                             ${state.places.filter(p => p.destination === aiState.data.dest).length === 0 ? '<p class="text-xs text-red-500">אין מקומות שמורים ביעד זה</p>' : ''}
                        </div>
                    </div>
                `,
                validate: () => {
                    if(aiState.data.placesMode === 'select' && (!aiState.data.selectedPlaces || aiState.data.selectedPlaces.length === 0)) return 'יש לבחור לפחות מקום אחד';
                    return true;
                }
            },
            // Step 7: Transport
            {
                title: 'התניידות',
                render: () => `
                    <div class="space-y-3">
                        <p class="font-bold text-slate-700">איך תתניידו?</p>
                        <select class="w-full p-3 bg-white border border-slate-200 rounded-xl" onchange="window.handleAiTransport(this.value)">
                            <option value="" disabled selected>בחרו אפשרות...</option>
                            <option value="תחבורה ציבורית וברגל">תחבורה ציבורית וברגל</option>
                            <option value="רק ברגל">רק ברגל</option>
                            <option value="רכב שכור">רכב שכור</option>
                            <option value="תחבורה ציבורית ומוניות/אובר">תחבורה ציבורית ומוניות</option>
                            <option value="רק מוניות/אובר">רק מוניות/אובר</option>
                            <option value="other">אחר...</option>
                        </select>
                        <textarea id="ai_transport_other" class="hidden w-full p-3 bg-white border border-slate-200 rounded-xl text-sm" rows="2" placeholder="פרט כאן (למשל: רכב בחלק מהימים...)" onchange="window.handleAiInput('transportDetails', this.value)"></textarea>
                    </div>
                `,
                validate: () => aiState.data.transport ? true : 'יש לבחור דרך התניידות'
            },
            // Step 8: Free Text
            {
                title: 'פרטים נוספים',
                render: () => `
                    <div class="space-y-3">
                        <p class="font-bold text-slate-700">משהו נוסף?</p>
                        <textarea class="w-full p-4 bg-white border border-slate-200 rounded-xl focus:ring-2 focus:ring-indigo-500 outline-none" rows="4" placeholder="למשל: נוחת במיאמי ב-6 בערב, רוצה לוז רגוע, אוכל כשר בלבד..." onchange="window.handleAiInput('notes', this.value)"></textarea>
                    </div>
                `,
                validate: () => true
            },
            // Step 9: Result
            {
                title: 'הפורמט מוכן',
                render: () => {
                    const prompt = generateAiPrompt();
                    return `
                        <div class="space-y-4">
                            <div class="bg-green-50 text-green-700 p-4 rounded-xl flex items-center gap-3">
                                <i class="fas fa-check-circle text-2xl"></i>
                                <div>
                                    <p class="font-bold">הטקסט נוצר בהצלחה!</p>
                                    <p class="text-xs">העתיקו את הטקסט והדביקו ב-ChatGPT או Gemini</p>
                                </div>
                            </div>
                            <div class="relative">
                                <textarea id="ai_final_prompt" class="w-full p-4 bg-slate-800 text-slate-200 rounded-xl text-xs sm:text-sm font-mono leading-relaxed h-64 focus:outline-none" readonly>${prompt}</textarea>
                                <button onclick="window.copyAiPrompt()" class="absolute top-2 left-2 bg-white/10 hover:bg-white/20 text-white px-3 py-1 rounded-lg text-xs backdrop-blur border border-white/10">
                                    <i class="fas fa-copy ml-1"></i> העתק
                                </button>
                            </div>
                            <button onclick="window.open('https://chat.openai.com', '_blank')" class="w-full bg-slate-100 text-slate-700 font-bold py-3 rounded-xl flex items-center justify-center gap-2 hover:bg-slate-200">
                                <i class="fas fa-external-link-alt"></i> פתח את ChatGPT
                            </button>
                        </div>
                    `;
                },
                isFinal: true
            }
        ];

        window.openAiWizard = () => {
            aiState = { step: 0, data: {} };
            renderAiStep();
            window.toggleModal('ai-wizard-modal', true);
        };

        window.closeAiWizard = () => window.toggleModal('ai-wizard-modal', false);

        window.handleAiInput = (key, value) => {
            aiState.data[key] = value;
        };
        
        window.handleAiHotelSelect = (el, name) => {
            if(!aiState.data.selectedHotels) aiState.data.selectedHotels = [];
            if(el.checked) aiState.data.selectedHotels.push(name);
            else aiState.data.selectedHotels = aiState.data.selectedHotels.filter(h => h !== name);
        };

        window.handleAiPlacesMode = (mode) => {
            aiState.data.placesMode = mode;
            const selectionDiv = document.getElementById('ai_places_selection');
            if(mode === 'select') selectionDiv.classList.remove('hidden');
            else selectionDiv.classList.add('hidden');
        };

        window.handleAiPlaceSelect = (el, name, address) => {
            if(!aiState.data.selectedPlaces) aiState.data.selectedPlaces = [];
            if(el.checked) aiState.data.selectedPlaces.push({name, address});
            else aiState.data.selectedPlaces = aiState.data.selectedPlaces.filter(p => p.name !== name);
        };

        window.handleAiTransport = (val) => {
            aiState.data.transport = val;
            const otherInput = document.getElementById('ai_transport_other');
            if(val === 'other') {
                otherInput.classList.remove('hidden');
                otherInput.focus();
            } else {
                otherInput.classList.add('hidden');
                aiState.data.transportDetails = '';
            }
        };

        window.renderAiStep = () => {
            // Skip logic check
            while(aiSteps[aiState.step].condition && !aiSteps[aiState.step].condition()) {
                aiState.step++;
            }

            const stepObj = aiSteps[aiState.step];
            const body = document.getElementById('ai-wizard-body');
            const progress = document.getElementById('ai-progress-bar');
            const backBtn = document.getElementById('ai-btn-back');
            const nextBtn = document.getElementById('ai-btn-next');

            // Render
            body.innerHTML = stepObj.render();
            
            // UI Updates
            const percent = ((aiState.step) / (aiSteps.length - 1)) * 100;
            progress.style.width = `${percent}%`;
            
            backBtn.disabled = aiState.step === 0;
            backBtn.style.opacity = aiState.step === 0 ? '0' : '1';
            
            if(stepObj.isFinal) {
                nextBtn.innerHTML = 'סיים <i class="fas fa-check"></i>';
                nextBtn.onclick = () => window.closeAiWizard();
            } else {
                nextBtn.innerHTML = 'הבא <i class="fas fa-chevron-left text-xs"></i>';
                nextBtn.onclick = () => {
                    const validation = stepObj.validate();
                    if(validation === true) {
                        aiState.step++;
                        window.renderAiStep();
                    } else if (typeof validation === 'string') {
                        showToast(validation, true);
                    }
                };
            }
            backBtn.onclick = () => {
                if(aiState.step > 0) {
                    aiState.step--;
                    // Check reverse skip logic
                    while(aiSteps[aiState.step].condition && !aiSteps[aiState.step].condition()) {
                        aiState.step--;
                    }
                    window.renderAiStep();
                }
            };
        };

        window.generateAiPrompt = () => {
            const d = aiState.data;
            
            // Calculate end date
            let dateStr = d.startDate;
            if(d.startDate && d.days) {
                const start = new Date(d.startDate);
                const end = new Date(start);
                end.setDate(start.getDate() + parseInt(d.days));
                dateStr = `${d.startDate} עד ${end.toISOString().split('T')[0]}`;
            }

            // Get Places List
            let placesList = [];
            if(d.placesMode === 'all') {
                placesList = state.places.filter(p => p.destination === d.dest).map(p => ({name: p.name, address: p.address || ''}));
            } else {
                placesList = d.selectedPlaces || [];
            }

            const placesText = placesList.map(p => `- ${p.name} ${p.address ? `(${p.address})` : ''}`).join('\n');

            // Hotel Text
            let hotelText = '';
            if(d.selectedHotels && d.selectedHotels.length === 1) {
                hotelText = `אני שוהה במלון: ${d.selectedHotels[0]}`;
            } else if (d.selectedHotels && d.selectedHotels.length > 1) {
                hotelText = `אני שוהה במלונות הבאים:\n`;
                d.selectedHotels.forEach((h, i) => {
                    const dates = d[`hotelDates_${i}`] || 'בתאריכים שהוגדרו';
                    hotelText += `- ${h}: ${dates}\n`;
                });
            }

            // Transport Text
            let transText = d.transport;
            if(d.transport === 'other') transText = d.transportDetails || 'אחר';

            return `
אני נוסע ל${d.dest}
בתאריכים: ${dateStr} (${d.days} ימים)
מגיע בשעה: ${d.arrivalTime || '--'}
עוזב בשעה: ${d.departureTime || '--'}

${hotelText}

אני מתנייד ב: ${transText}

ובנוסף שתדע: ${d.notes || 'אין הערות מיוחדות'}

עכשיו אני ארצה לבקר בכל המקומות הבאים:
${placesText}

תעשה לי לוז חכם והגיוני שבהם נבקר בכל המקומות הנ"ל שיוצאים מהמלון וחוזרים בערב למלון.
לוז חכם כלומר לוז שלא חוזר על עצמו, שאני לא אעבור באותם מקומות פעמיים, שהמרחקים בין יעד ליעד יהיו הגיוניים ולא קפיצות ממקום למקום.
ותבנה את הלוז ממש כמו שסוכן נסיעות מטורף היה עושה שכולל זמן משוער ממקום למקום ועלות משוערת וכמה זמן משוער בכל מקום.
בנוסף תעשה את הלוז יפה תשמש בסמיילים ודברים לקשט את הלוז.
תעשה הכל מושלם.
            `.trim();
        };

        window.copyAiPrompt = () => {
            const el = document.getElementById('ai_final_prompt');
            el.select();
            document.execCommand('copy'); // Fallback
            navigator.clipboard.writeText(el.value);
            showToast('הטקסט הועתק!');
        };

        // === Init ===
        async function init() {
            const urlParams = new URLSearchParams(window.location.search);
            state.tripId = urlParams.get('id') || urlParams.get('tripId');
            const routeId = urlParams.get('routeId');

            if (!state.tripId) {
                showToast("שגיאה: מזהה טיול חסר", true);
                document.getElementById('loading-overlay').classList.add('hidden');
                return;
            }

            document.getElementById('back-to-trip-btn').onclick = () => window.location.href = `trip.html?id=${state.tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                state.user = user;
                document.getElementById('auth-container').textContent = user.displayName?.split(' ')[0] || "משתמש";

                try {
                    await loadData();
                    
                    if (routeId) {
                        await loadRoute(routeId);
                    } else {
                        setupInitialView();
                    }
                    
                    document.getElementById('loading-overlay').style.opacity = '0';
                    setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 500);
                    document.getElementById('main-content').classList.remove('hidden');
                    
                    setupListeners();
                } catch (error) {
                    console.error(error);
                    showToast("שגיאה בטעינת הנתונים", true);
                    document.getElementById('loading-overlay').style.display = 'none';
                }
            });
        }

        async function loadData() {
            const [tripSnap, placesSnap, hotelsSnap] = await Promise.all([
                getDoc(doc(db, 'trips', state.tripId)),
                getDocs(query(collection(db, 'trips', state.tripId, 'places'))),
                getDocs(query(collection(db, 'trips', state.tripId, 'logistics'), where("type", "==", "hotel")))
            ]);

            if (tripSnap.exists()) state.tripData = tripSnap.data();
            state.places = placesSnap.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'place' }));
            state.hotels = hotelsSnap.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'hotel', type: 'מלון' }));
        }

        function setupInitialView() {
            const select = document.getElementById('destination-select');
            select.innerHTML = '<option value="" disabled selected>בחירת יעד...</option>';
            state.tripData?.destinations?.forEach(d => {
                const opt = document.createElement('option');
                opt.value = d.nameHe;
                opt.textContent = d.nameHe;
                select.appendChild(opt);
            });
        }

        async function loadRoute(routeId) {
            const docSnap = await getDoc(doc(db, 'trips', state.tripId, 'routes', routeId));
            if (docSnap.exists()) {
                const data = docSnap.data();
                state.route = { id: docSnap.id, ...data };
                startBuilderMode();
                document.getElementById('is-public-toggle').checked = state.route.isPublic !== false;
            }
        }

        // === Logic ===
        function startBuilderMode() {
            document.getElementById('initial-state').classList.add('hidden');
            document.getElementById('building-state').classList.remove('hidden');
            document.getElementById('summary-view').classList.add('hidden');

            document.getElementById('route-title').textContent = state.route.name;
            document.getElementById('route-destination').textContent = state.route.destination;

            // Filter points
            state.availablePoints = [...state.places, ...state.hotels].filter(p => 
                !p.destination || p.destination === state.route.destination
            );

            renderSteps();
            generateFilterChips();
        }

        function renderSteps() {
            const container = document.getElementById('route-steps-container');
            container.innerHTML = '';

            if (state.route.steps.length === 0) {
                document.getElementById('start-prompt').classList.remove('hidden');
                return;
            }
            document.getElementById('start-prompt').classList.add('hidden');

            state.route.steps.forEach((step, index) => {
                const config = categoryConfig[step.type] || categoryConfig.default;
                const prevStep = state.route.steps[index - 1];
                let distHTML = '';

                if (prevStep && prevStep.coords && step.coords) {
                    const dist = calculateDistance(prevStep.coords, step.coords);
                    distHTML = `
                        <div class="flex justify-end pr-[3.2rem] -mt-2 mb-1 relative z-10">
                            <span class="text-[10px] font-bold text-slate-400 bg-white/80 backdrop-blur px-2 py-0.5 rounded-full border border-slate-100 flex items-center gap-1 shadow-sm">
                                <i class="fas fa-person-walking"></i> ${dist.toFixed(1)} ק"מ
                            </span>
                        </div>
                    `;
                }

                const el = document.createElement('div');
                el.className = 'route-step relative animate-fade-in group';
                el.dataset.index = index;
                el.innerHTML = `
                    <div class="timeline-line"></div>
                    ${distHTML}
                    <div class="flex items-center gap-3 p-3 bg-white rounded-2xl border border-slate-100 shadow-sm relative select-none">
                        <!-- Number -->
                        <div class="shrink-0 w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm text-slate-500 bg-slate-50 border border-slate-100 z-10">
                            ${index + 1}
                        </div>
                        
                        <!-- Icon -->
                        <div class="shrink-0 w-11 h-11 rounded-xl flex items-center justify-center text-lg shadow-sm" style="background:${config.bg}; color:${config.color}">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        
                        <!-- Text -->
                        <div class="flex-grow min-w-0">
                            <h4 class="font-bold text-slate-800 text-sm truncate leading-snug">${step.name}</h4>
                            <p class="text-xs text-slate-500 truncate">${step.description || step.type}</p>
                        </div>
                        
                        <!-- Actions -->
                        <div class="flex items-center gap-1 pl-1">
                            <button class="drag-handle w-9 h-9 flex items-center justify-center text-slate-300 hover:text-indigo-500 active:text-indigo-600 rounded-lg touch-manipulation cursor-grab active:cursor-grabbing">
                                <i class="fas fa-grip-vertical"></i>
                            </button>
                            <button class="remove-btn w-9 h-9 flex items-center justify-center text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-lg transition-colors">
                                <i class="fas fa-trash-can"></i>
                            </button>
                        </div>
                    </div>
                    <div class="h-3"></div> <!-- Spacer -->
                `;

                // Events
                const removeBtn = el.querySelector('.remove-btn');
                removeBtn.onclick = () => {
                    // Slight vibration
                    if(navigator.vibrate) navigator.vibrate(10);
                    el.classList.add('opacity-0', '-translate-x-full');
                    setTimeout(() => {
                        state.route.steps.splice(index, 1);
                        renderSteps();
                    }, 200);
                };
                
                // Drag Logic Setup
                setupDragItem(el, index);
                
                container.appendChild(el);
            });
        }

        // === Drag & Drop System (Unified Touch/Mouse) ===
        function setupDragItem(el, index) {
            const handle = el.querySelector('.drag-handle');
            
            // Mouse API
            el.draggable = true;
            
            el.addEventListener('dragstart', (e) => {
                state.draggedIndex = index;
                el.classList.add('dragging');
                e.dataTransfer.effectAllowed = 'move';
            });
            
            el.addEventListener('dragover', (e) => {
                e.preventDefault();
                const target = e.target.closest('.route-step');
                if (target && target !== el) {
                    const rect = target.getBoundingClientRect();
                    const offset = e.clientY - rect.top - rect.height / 2;
                    // Simple swap visual
                    document.querySelectorAll('.drag-over-item').forEach(i => i.classList.remove('drag-over-item'));
                    target.classList.add('drag-over-item');
                }
            });
            
            el.addEventListener('drop', (e) => {
                e.preventDefault();
                const target = e.target.closest('.route-step');
                if (target) {
                    const toIndex = parseInt(target.dataset.index);
                    moveStep(state.draggedIndex, toIndex);
                }
                cleanupDrag();
            });
            
            el.addEventListener('dragend', cleanupDrag);

            // Touch API (Custom Implementation)
            handle.addEventListener('touchstart', (e) => {
                // Prevent scrolling when touching handle
                e.preventDefault();
                state.draggedIndex = index;
                el.classList.add('dragging');
                if(navigator.vibrate) navigator.vibrate(20);
            }, {passive: false});

            handle.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const target = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.route-step');
                
                document.querySelectorAll('.drag-over-item').forEach(i => i.classList.remove('drag-over-item'));
                if (target && target.dataset.index != state.draggedIndex) {
                    target.classList.add('drag-over-item');
                }
            }, {passive: false});

            handle.addEventListener('touchend', (e) => {
                 const touch = e.changedTouches[0];
                 const target = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.route-step');
                 if (target) {
                     const toIndex = parseInt(target.dataset.index);
                     if (toIndex !== state.draggedIndex) moveStep(state.draggedIndex, toIndex);
                 }
                 cleanupDrag();
            });
        }

        function cleanupDrag() {
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over-item').forEach(el => el.classList.remove('drag-over-item'));
            state.draggedIndex = null;
        }

        function moveStep(from, to) {
            const item = state.route.steps.splice(from, 1)[0];
            state.route.steps.splice(to, 0, item);
            renderSteps();
        }

        // === Place Selection ===
        function generateFilterChips() {
            const container = document.getElementById('filter-chips-container');
            const cats = ['all', ...new Set(state.availablePoints.map(p => p.type || 'default'))];
            
            container.innerHTML = cats.map(c => {
                const conf = categoryConfig[c] || categoryConfig.default;
                const label = c === 'all' ? 'הכל' : (conf.label || c);
                const isActive = c === 'all';
                return `
                    <button class="filter-chip px-3 py-1.5 rounded-full text-xs font-bold whitespace-nowrap transition-all border ${isActive ? 'bg-indigo-600 text-white border-indigo-600' : 'bg-white text-slate-600 border-slate-200'}" data-cat="${c}">
                        ${label}
                    </button>
                `;
            }).join('');

            container.querySelectorAll('.filter-chip').forEach(btn => {
                btn.onclick = () => {
                    container.querySelectorAll('.filter-chip').forEach(b => {
                        b.classList.remove('bg-indigo-600', 'text-white', 'border-indigo-600');
                        b.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
                    });
                    btn.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
                    btn.classList.add('bg-indigo-600', 'text-white', 'border-indigo-600');
                    renderModalPlaces(btn.dataset.cat);
                }
            });
            renderModalPlaces('all');
        }

        function renderModalPlaces(category = 'all', searchTerm = '') {
            searchTerm = document.getElementById('modal-search-input').value.toLowerCase();
            const list = document.getElementById('modal-places-list-container');
            
            // Sort by distance to last point if exists
            let lastPoint = null;
            const routePoints = state.route.steps.filter(s => s.coords);
            if (routePoints.length > 0) lastPoint = routePoints[routePoints.length - 1].coords;

            const filtered = state.availablePoints.filter(p => {
                 const matchesCat = category === 'all' || p.type === category;
                 const matchesSearch = p.name.toLowerCase().includes(searchTerm);
                 return matchesCat && matchesSearch;
            }).map(p => {
                p._dist = (lastPoint && p.coords) ? calculateDistance(lastPoint, p.coords) : Infinity;
                return p;
            }).sort((a, b) => {
                if (lastPoint) return a._dist - b._dist;
                return a.name.localeCompare(b.name, 'he');
            });

            if (filtered.length === 0) {
                list.innerHTML = `
                    <div class="flex flex-col items-center justify-center py-10 text-slate-400">
                        <i class="fas fa-search text-3xl mb-2 opacity-50"></i>
                        <p>לא נמצאו תוצאות</p>
                    </div>`;
                return;
            }

            list.innerHTML = filtered.map(p => {
                const config = categoryConfig[p.type] || categoryConfig.default;
                const distBadge = p._dist !== Infinity ? `<span class="text-[10px] bg-slate-100 text-slate-500 px-1.5 py-0.5 rounded ml-2 border border-slate-200">${p._dist.toFixed(1)} ק"מ</span>` : '';
                
                return `
                    <div class="flex items-center gap-3 p-3 bg-white rounded-xl border border-slate-100 hover:border-indigo-400 transition-all cursor-pointer group" onclick="window.addStep('${p.id}')">
                         <div class="w-10 h-10 rounded-lg flex items-center justify-center text-lg shrink-0" style="background:${config.bg}; color:${config.color}">
                            <i class="fas ${config.icon}"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                             <div class="flex items-center">
                                <h4 class="font-bold text-slate-800 text-sm truncate">${p.name}</h4>
                                ${distBadge}
                            </div>
                            <p class="text-xs text-slate-500">${p.type}</p>
                        </div>
                        <button class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center group-hover:bg-indigo-600 group-hover:text-white transition-colors">
                            <i class="fas fa-plus"></i>
                        </button>
                    </div>
                `;
            }).join('');
        }

        window.addStep = (id) => {
            const point = state.availablePoints.find(p => p.id === id);
            if (point) {
                state.route.steps.push({ ...point });
                renderSteps();
                showToast(`נוסף: ${point.name}`);
                if (window.innerWidth < 640) window.toggleModal('add-place-modal', false);
            }
        };

        // === Actions ===
        function organizeRoute() {
            if (state.route.steps.filter(s => s.coords).length < 2) {
                showToast("אין מספיק נקודות עם מיקום לסידור", true);
                return;
            }

            const withCoords = state.route.steps.filter(s => s.coords);
            const others = state.route.steps.filter(s => !s.coords);
            
            let sorted = [withCoords.shift()];
            while (withCoords.length > 0) {
                const current = sorted[sorted.length - 1];
                let nearestIdx = 0, minDst = Infinity;
                withCoords.forEach((p, i) => {
                    const dst = calculateDistance(current.coords, p.coords);
                    if (dst < minDst) { minDst = dst; nearestIdx = i; }
                });
                sorted.push(withCoords.splice(nearestIdx, 1)[0]);
            }
            
            state.route.steps = [...sorted, ...others];
            renderSteps();
            showToast("המסלול סודר מחדש");
        }

        async function saveRoute() {
            const btn = document.getElementById('save-route-btn');
            const originalHTML = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i> שומר...';
            btn.disabled = true;

            try {
                state.route.isPublic = document.getElementById('is-public-toggle').checked;
                state.route.createdBy = state.route.createdBy || state.user.uid;
                state.route.tripId = state.tripId;
                
                const dataToSave = { ...state.route, updatedAt: new Date() };

                if (state.route.id) {
                    await setDoc(doc(db, 'trips', state.tripId, 'routes', state.route.id), dataToSave);
                } else {
                    const ref = await addDoc(collection(db, 'trips', state.tripId, 'routes'), dataToSave);
                    state.route.id = ref.id;
                    dataToSave.id = ref.id;
                }

                if (state.route.isPublic) {
                    await setDoc(doc(db, 'publicRoutes', state.route.id), dataToSave);
                } else {
                    try { await deleteDoc(doc(db, 'publicRoutes', state.route.id)); } catch(e){}
                }

                showSummary();
            } catch (e) {
                console.error(e);
                showToast("שגיאה בשמירה", true);
            } finally {
                btn.innerHTML = originalHTML;
                btn.disabled = false;
            }
        }

        // === Summary & Map Logic ===
        function showSummary() {
            document.getElementById('building-state').classList.add('hidden');
            document.getElementById('summary-view').classList.remove('hidden');
            
            document.getElementById('summary-title').textContent = state.route.name;
            document.getElementById('summary-details').innerHTML = `
                <span><i class="fas fa-map-pin ml-1"></i> ${state.route.destination}</span>
                <span class="border-r border-indigo-400/30 pr-3 mr-3"><i class="fas fa-stopwatch ml-1"></i> ${state.route.steps.length} תחנות</span>
            `;

            const listContent = document.getElementById('summary-content-list');
            listContent.innerHTML = state.route.steps.map((s, i) => `
                <div class="flex items-start gap-4 p-4 bg-white rounded-xl border border-slate-100 shadow-sm">
                    <div class="font-bold text-lg text-indigo-600 w-6">${i+1}.</div>
                    <div>
                        <h3 class="font-bold text-slate-800">${s.name}</h3>
                        <p class="text-sm text-slate-500">${s.description || s.type}</p>
                    </div>
                </div>
            `).join('');

            window.switchTab('list');
        }

        window.closeSummary = () => {
            document.getElementById('summary-view').classList.add('hidden');
            document.getElementById('building-state').classList.remove('hidden');
        };

        window.switchTab = (tab) => {
            const listDiv = document.getElementById('summary-content-list');
            const mapDiv = document.getElementById('summary-content-map');
            const tabList = document.getElementById('tab-list');
            const tabMap = document.getElementById('tab-map');

            if (tab === 'list') {
                listDiv.classList.remove('hidden');
                mapDiv.classList.add('hidden');
                tabList.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600";
                tabMap.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:bg-white/50";
            } else {
                listDiv.classList.add('hidden');
                mapDiv.classList.remove('hidden');
                tabMap.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all shadow-sm bg-white text-indigo-600";
                tabList.className = "flex-1 py-2 rounded-lg text-sm font-bold transition-all text-slate-500 hover:bg-white/50";
                
                // Initialize Summary Map (Independent)
                setTimeout(() => initLeafletMap('final-map', state.route.steps, 'SUMMARY'), 200);
            }
        };

        window.copyLink = () => {
             const txt = state.route.steps.map((s, i) => `${i+1}. ${s.name}`).join('\n');
             navigator.clipboard.writeText(`המסלול שלי ל${state.route.destination}:\n${txt}`);
             showToast("הועתק ללוח!");
        };

        // === Unified Map Initialization ===
        function initLeafletMap(divId, points, mode) {
            // mode: 'PICKER' (All points), 'VIEW' (Route only), 'SUMMARY' (Final route static)
            const container = document.getElementById(divId);
            if (!container) return;

            // Strict cleanup based on container usage
            if (divId === 'map-modal-container') {
                if (state.maps.modal) {
                    state.maps.modal.off();
                    state.maps.modal.remove();
                    state.maps.modal = null;
                }
            } else if (divId === 'final-map') {
                if (state.maps.summary) {
                    state.maps.summary.off();
                    state.maps.summary.remove();
                    state.maps.summary = null;
                }
            }
            
            // Clean container HTML to be safe
            container.innerHTML = '';

            const map = L.map(divId, { zoomControl: false }).setView([31.768, 35.213], 8);
            
            // Store reference
            if (divId === 'map-modal-container') state.maps.modal = map;
            else if (divId === 'final-map') state.maps.summary = map;

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: ''
            }).addTo(map);

            const group = L.featureGroup();
            const latlngs = [];

            points.forEach((p, i) => {
                if (!p.coords) return;
                const config = categoryConfig[p.type] || categoryConfig.default;
                latlngs.push([p.coords.lat, p.coords.lng]);

                const icon = L.divIcon({
                    className: 'bg-transparent',
                    html: `<div class="custom-marker" style="background:${config.color}; width:36px; height:36px; color:white;">
                            <i class="fas ${config.icon} text-sm"></i>
                           </div>`,
                    iconSize: [36, 36],
                    iconAnchor: [18, 18],
                    popupAnchor: [0, -20]
                });

                const marker = L.marker([p.coords.lat, p.coords.lng], { icon }).addTo(map);
                
                if (mode === 'PICKER') {
                    marker.on('click', () => {
                        window.customConfirm(`הוספת ${p.name}`, `האם להוסיף את המקום למסלול?`, () => {
                            window.addStep(p.id);
                            window.closeModal('map-selection-modal');
                            window.toggleModal('add-place-modal', true);
                        });
                    });
                } else {
                     marker.bindPopup(`<div class="text-right font-sans font-bold">${i+1}. ${p.name}</div>`).addTo(group);
                }
                group.addLayer(marker);
            });

            // Draw lines for route views
            if ((mode === 'VIEW' || mode === 'SUMMARY') && latlngs.length > 1) {
                L.polyline(latlngs, { color: '#4f46e5', weight: 4, opacity: 0.8, dashArray: '10, 10', lineCap: 'round' }).addTo(map);
            }

            if (group.getLayers().length > 0) {
                map.fitBounds(group.getBounds(), { padding: [50, 50] });
            }
            
            // Fix tile loading
            setTimeout(() => map.invalidateSize(), 200);
        }

        // === Event Listeners ===
        function setupListeners() {
            // Create Route Form
            document.getElementById('create-route-btn').onclick = () => window.toggleModal('create-route-modal', true);
            
            document.getElementById('create-route-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('new-route-name').value;
                const dest = document.getElementById('destination-select').value;
                if(name && dest) {
                    state.route.name = name;
                    state.route.destination = dest;
                    window.closeModal('create-route-modal');
                    startBuilderMode();
                }
            };

            // AI Button Handler
            document.getElementById('btn-open-ai').onclick = window.openAiWizard;

            // Add Place
            document.getElementById('open-add-place-modal-btn').onclick = () => {
                document.getElementById('modal-search-input').value = '';
                generateFilterChips(); // Reset filters
                window.toggleModal('add-place-modal', true);
            };
            document.getElementById('modal-search-input').oninput = () => renderModalPlaces();

            // Map Selection (PICKER MODE)
            document.getElementById('open-map-selection-btn').onclick = () => {
                window.toggleModal('add-place-modal', false);
                window.toggleModal('map-selection-modal', true);
                
                document.getElementById('map-modal-title').textContent = "בחירת מקום";
                document.getElementById('map-helper-pill').classList.remove('hidden');
                document.getElementById('close-map-btn').onclick = () => {
                    window.closeModal('map-selection-modal');
                    window.toggleModal('add-place-modal', true); // Go back to drawer
                };

                // Pass ALL available points
                setTimeout(() => initLeafletMap('map-modal-container', state.availablePoints, 'PICKER'), 300);
            };
            
            // Route Preview Map (VIEW MODE)
            document.getElementById('toggle-map-view').onclick = () => {
                 window.toggleModal('map-selection-modal', true);
                 
                 document.getElementById('map-modal-title').textContent = "מפת המסלול";
                 document.getElementById('map-helper-pill').classList.add('hidden');
                 document.getElementById('close-map-btn').onclick = () => window.closeModal('map-selection-modal');

                 // Pass ONLY route steps
                 setTimeout(() => initLeafletMap('map-modal-container', state.route.steps, 'VIEW'), 300);
            };

            // Add Note
            document.getElementById('open-add-other-btn').onclick = () => {
                document.getElementById('add-other-form').reset();
                window.toggleModal('add-other-modal', true);
            };
            
            document.getElementById('add-other-form').onsubmit = (e) => {
                e.preventDefault();
                const name = document.getElementById('other-name').value;
                const desc = document.getElementById('other-description').value;
                state.route.steps.push({ 
                    id: crypto.randomUUID(), 
                    name, 
                    description: desc, 
                    type: 'other', 
                    coords: null 
                });
                renderSteps();
                window.closeModal('add-other-modal');
            };

            // Main Actions
            document.getElementById('save-route-btn').onclick = saveRoute;
            document.getElementById('organize-route-btn').onclick = organizeRoute;
        }

        // Utils
        function calculateDistance(c1, c2) {
            if (!c1 || !c2) return 0;
            const R = 6371; 
            const dLat = (c2.lat - c1.lat) * Math.PI / 180;
            const dLon = (c2.lng - c1.lng) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(c1.lat * Math.PI / 180) * Math.cos(c2.lat * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
        }

        // Start
        init();

    </script>
</body>
</html>

