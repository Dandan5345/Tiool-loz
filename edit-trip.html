<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no" />
    <title>בניית מסלול חכם</title>

    <!-- Tailwind CDN -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Leaflet (Map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-polylinedecorator@1.6.0/dist/leaflet.polylineDecorator.js"></script>

    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet" />

    <style>
        :root {
            --primary-color: #4f46e5; /* indigo-600 */
            --primary-color-hover: #4338ca; /* indigo-700 */
            --secondary-color: #10b981; /* emerald-500 */
        }

        html, body {
            height: 100%;
            overflow: hidden;
            -webkit-tap-highlight-color: transparent; /* מניעת הבהוב במובייל */
        }

        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f8fafc;
            color: #0f172a;

            /* ביטול סימון טקסט / תפריט העתקה בלחיצה ארוכה */
            -webkit-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
        }

        /* כן לאפשר סימון/מקלדת בתוך שדות קלט */
        input, textarea, select {
            -webkit-user-select: text;
            user-select: text;
            -webkit-touch-callout: default;
        }

        .leaflet-container {
            font-family: 'Assistant', sans-serif;
        }

        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* --- Animations --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.5s ease-out forwards; }

        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .fade-out { animation: fadeOut 0.3s ease-in forwards; }

        @keyframes slideInUp {
            from { opacity: 0; transform: translateY(100%); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in-up { animation: slideInUp 0.4s cubic-bezier(0.25,0.46,0.45,0.94) forwards; }

        @keyframes slideInFromRight {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
        .slide-in-from-right { animation: slideInFromRight 0.3s ease-out forwards; }

        /* --- Buttons / chips --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            white-space: nowrap;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            line-height: 1.2;
        }
        .btn:disabled {
            background-color: #94a3b8;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        .btn-primary {
            background-color: var(--primary-color);
            color: #fff;
            border: 1px solid var(--primary-color);
        }
        .btn-primary:hover:not(:disabled) {
            background-color: var(--primary-color-hover);
        }
        .btn-secondary {
            background: linear-gradient(to right,#10b981,#059669);
            color: #fff;
            border: 1px solid var(--secondary-color);
        }
        .btn-secondary:hover:not(:disabled) {
            background: linear-gradient(to right,#059669,#10b981);
        }
        .btn-ghost {
            background-color: #fff;
            color: #475569;
            border: 1px solid #cbd5e1;
        }
        .btn-ghost:hover:not(:disabled) {
            background-color: #f8fafc;
            color: #1e293b;
            border-color: #94a3b8;
        }

        /* --- Route Steps list --- */
        .route-step {
            position: relative;
            padding-right: 3.5rem;
            padding-bottom: 0.5rem;
            min-height: 64px; /* קצת יותר גבוה למובייל */
        }
        .route-step:not(:last-child)::before {
            content: '';
            position: absolute;
            top: 44px;
            right: 19px;
            width: 2px;
            height: calc(100% + 2.25rem);
            background-color: #e2e8f0;
        }
        .step-icon-wrapper {
            position: absolute;
            top: 0;
            right: 0;
            width: 40px;
            height: 40px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            z-index: 10;
        }
        .step-icon {
            width: 32px;
            height: 32px;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            line-height: 1;
            color: #fff;
        }
        .step-content {
            background-color: #fff;
            padding: 0.75rem 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.07), 0 1px 2px -1px rgb(0 0 0 / 0.07);
            border: 1px solid #e2e8f0;
            transition: all 0.15s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: .5rem;
        }
        .step-content:hover {
            border-color: var(--primary-color);
            box-shadow: 0 4px 8px rgba(0,0,0,.07);
        }
        .step-main {
            min-width: 0;
            flex: 1 1 auto;
        }
        .step-actions {
            display: flex;
            align-items: center;
            gap: .5rem;
            flex-shrink: 0;
        }
        .drag-handle {
            color: #94a3b8;
            font-size: 1rem;
        }
        .drag-handle:active {
            color: var(--primary-color);
        }

        /* מרחק בין תחנות במסלול */
        .distance-connector {
            position: relative;
            padding-right: 3.5rem;
            height: 2.25rem; /* 1rem bottom + 1.25rem text */
            display: flex;
            align-items: center;
        }
        .distance-connector::before {
            content: '';
            position: absolute;
            top: 0;
            right: 19px;
            width: 2px;
            height: 100%;
            background-color: #e2e8f0;
            z-index: 5;
        }
        .distance-text {
            position: relative;
            font-size: 0.75rem;
            font-weight: 600;
            color: #64748b;
            background-color: #f1f5f9;
            padding: 2px 8px;
            border-radius: 999px;
            z-index: 10;
        }

        /* --- Drag styles --- */
        [draggable="true"] {
            cursor: grab;
        }
        .dragging {
            opacity: .6;
            background: #eef2ff;
            cursor: grabbing;
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }
        .drag-over {
            border-top: 2px dashed var(--primary-color);
        }

        /* --- Map Marker Styling --- */
        .custom-marker-icon-wrapper {
            z-index: 500;
        }
        .custom-marker-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            transition: all 0.2s ease;
            font-weight: 700;
        }
        .custom-marker-icon.highlight {
            transform: scale(1.5);
            z-index: 1000 !important;
        }

        /* --- Summary / After Save --- */
        /* חוויית מובייל: טאבים "פרטים" / "מפה" */
        .summary-tab-active {
            background-color: var(--primary-color);
            color: #fff !important;
            border-color: var(--primary-color) !important;
        }
        .summary-tab-inactive {
            background-color: #fff;
            color: #475569;
            border-color: #cbd5e1;
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            #summary-panel, #summary-panel * {
                visibility: visible;
            }
            #summary-panel {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                height: auto;
                display: block;
                background: #fff;
            }
            #summary-map-wrapper {
                display: block !important;
                height: 400px !important;
                page-break-after: always;
            }
            #summary-map {
                height: 100% !important;
                width: 100% !important;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="h-full w-full">

    <!-- מסך טעינה -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 backdrop-blur-sm z-[100] flex flex-col items-center justify-center gap-4">
        <i class="fas fa-route text-5xl text-indigo-600 animate-pulse"></i>
        <p class="text-xl font-bold text-slate-700">טוען נתונים...</p>
    </div>

    <!-- כל התוכן -->
    <div id="main-content" class="h-full flex flex-col hidden">
        <!-- כותרת עליונה -->
        <header class="bg-white shadow-sm z-30 border-b border-slate-200 shrink-0">
            <div class="container mx-auto px-4 sm:px-6 lg:px-8 h-auto md:h-16 flex flex-wrap items-center justify-between gap-y-2 py-2">
                <div class="flex items-center gap-2 sm:gap-4">
                    <i class="fas fa-route text-2xl text-indigo-600"></i>
                    <h1 class="text-lg sm:text-xl font-bold text-slate-800">בניית מסלול חכם</h1>
                </div>
                <div class="flex items-center gap-1 sm:gap-2 text-xs sm:text-sm">
                    <a id="add-attraction-btn" href="#" class="btn btn-secondary text-[13px] p-2 sm:px-3" title="הוסף אטרקציה חדשה">
                        <i class="fas fa-plus"></i>
                        <span class="hidden sm:inline mr-2">הוסף אטרקציה</span>
                    </a>
                    <a id="all-routes-btn" href="#" class="btn btn-ghost text-[13px] p-2 sm:px-3" title="כל המסלולים השמורים">
                        <i class="fas fa-list-ul"></i>
                        <span class="hidden sm:inline mr-2">כל המסלולים</span>
                    </a>
                    <a id="back-to-trip-btn" href="#" class="btn btn-ghost text-[13px] p-2 sm:px-3" title="חזרה למרכז הטיול">
                        <i class="fas fa-arrow-left"></i>
                        <span class="hidden sm:inline mr-2">חזרה לטיול</span>
                    </a>
                    <div id="auth-container" class="text-[11px] sm:text-sm font-semibold text-slate-600 bg-slate-100 px-2 sm:px-3 py-2 rounded-lg"></div>
                </div>
            </div>
        </header>

        <!-- אזור התוכן הדינאמי -->
        <div class="flex-grow overflow-y-auto no-scrollbar bg-slate-50">
            <!-- מצב התחלתי (לפני יצירת מסלול) -->
            <div id="initial-state" class="text-center p-4 sm:p-8 flex-grow flex flex-col items-center justify-center h-full">
                <i class="fas fa-wand-magic-sparkles text-4xl sm:text-5xl text-indigo-400 mb-6"></i>
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">מוכן לבנות מסלול?</h2>
                <p class="text-slate-500 mt-2 text-sm sm:text-base">התחל ביצירת מסלול חדש כדי לתכנן את היום המושלם.</p>
                <button id="create-route-btn" class="mt-8 btn btn-primary w-full max-w-sm text-lg">
                    <i class="fas fa-plus ml-2"></i>
                    צור מסלול חדש
                </button>
            </div>

            <!-- מצב בנייה (עריכה חיה של המסלול) -->
            <div id="building-state" class="hidden p-3 sm:p-4 md:p-6 lg:max-w-4xl lg:mx-auto">
                <!-- כותרת שם המסלול + יעד -->
                <div class="space-y-1 mb-6 bg-white p-4 rounded-xl shadow-md border border-slate-200">
                    <h2 id="route-title" class="text-2xl sm:text-3xl font-bold text-slate-800"></h2>
                    <p id="route-destination" class="text-slate-500 font-semibold flex items-center gap-2 text-lg">
                        <i class="fas fa-map-pin"></i>
                        <span></span>
                    </p>
                </div>
                
                <!-- רשימת התחנות במסלול -->
                <div class="bg-white rounded-xl p-3 sm:p-4 min-h-[200px] border border-slate-200 shadow-sm">
                    <div class="flex flex-wrap items-center justify-between gap-2 mb-3">
                        <h3 class="font-bold text-slate-700 text-lg sm:text-xl">תחנות במסלול:</h3>
                        <button id="organize-route-btn" class="btn btn-ghost text-sm p-2 px-3 hidden">
                            <i class="fas fa-wand-magic-sparkles ml-2"></i>
                            ארגון חכם (לפי מרחק)
                        </button>
                    </div>
                    <p class="text-[12px] text-slate-500 mb-4 -mt-1 leading-tight">
                        טיפ: לחיצה ארוכה על תחנה ואז גרירה = לשנות סדר. גרירה באצבע עובדת במובייל ✋
                    </p>

                    <div id="route-steps-container">
                        <div id="start-prompt" class="text-center text-slate-500 p-8">
                            <i class="fas fa-box-open text-4xl text-slate-400 mb-4"></i>
                            <p class="font-semibold text-lg">המסלול שלך ריק</p>
                            <p class="text-sm">הוסף את התחנה הראשונה כדי להתחיל!</p>
                        </div>
                    </div>
                </div>

                <!-- כפתורים להוספת תחנות -->
                <div class="my-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <button id="open-add-place-modal-btn" class="w-full btn btn-secondary text-base">
                        <i class="fas fa-plus ml-2"></i>
                        הוסף מקום למסלול
                    </button>
                    <button id="open-add-other-modal-btn" class="w-full btn btn-ghost text-base">
                        <i class="fas fa-comment-dots ml-2"></i>
                        הוסף דגש / אחר
                    </button>
                </div>
                <button id="open-map-modal-btn" class="w-full btn btn-ghost text-base">
                    <i class="fas fa-map-location-dot ml-2"></i>
                    בחר מקום מהמפה
                </button>

                <!-- הגדרות ושמירה -->
                <div class="mt-12 pt-6 border-t border-slate-200 text-center">
                    <!-- Public/Private Toggle -->
                    <div class="flex items-center justify-center gap-3 mb-6 flex-wrap">
                        <label for="is-public-toggle" class="font-semibold text-slate-600 text-sm">הצג מסלול לכולם? (פומבי)</label>
                        <button id="is-public-toggle" role="switch" aria-checked="true" class="relative inline-flex h-6 w-11 flex-shrink-0 cursor-pointer rounded-full border-2 border-transparent bg-indigo-600 transition-colors duration-200 ease-in-out focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                            <span class="pointer-events-none inline-block h-5 w-5 transform rounded-full bg-white shadow ring-0 transition duration-200 ease-in-out translate-x-5"></span>
                        </button>
                    </div>

                    <button id="save-route-btn" class="w-full max-w-md btn btn-primary text-lg hidden">
                        <i class="fas fa-floppy-disk ml-2"></i>
                        שמור והצג סיכום
                    </button>
                </div>
            </div>

            <!-- מצב סיכום (אחרי שמירה) -->
            <div id="summary-view" class="hidden h-full w-full bg-white"></div>
        </div>
    </div>

    <!-- מודל יצירת מסלול חדש -->
    <div id="create-route-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">יצירת מסלול חדש</h3>
            <form id="create-route-form" class="space-y-4">
                <div>
                    <label for="new-route-name" class="block text-sm font-semibold text-slate-600 mb-1">שם המסלול</label>
                    <input type="text" id="new-route-name" required class="w-full p-2 border rounded-md border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="לדוגמה: יום כיף במנהטן" />
                </div>
                <div>
                    <label for="destination-select" class="block text-sm font-semibold text-slate-600 mb-1">לאיזה יעד?</label>
                    <select id="destination-select" required class="w-full p-2 border rounded-md bg-white border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="" disabled selected>טוען יעדים...</option>
                    </select>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-create-route" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">ביטול</button>
                    <button type="submit" class="btn btn-primary">התחל לבנות</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודל הוספת דגש/אחר -->
    <div id="add-other-modal" class="fixed inset-0 bg-black/60 z-50 hidden items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-6 fade-in">
            <h3 class="text-2xl font-bold text-slate-800 mb-4">הוספת דגש / אחר</h3>
            <form id="add-other-form" class="space-y-4">
                <div>
                    <label for="other-name" class="block text-sm font-semibold text-slate-600 mb-1">כותרת / שם</label>
                    <input type="text" id="other-name" required class="w-full p-2 border rounded-md border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" placeholder="לדוגמה: הפסקת צהריים" />
                </div>
                <div>
                    <label for="other-description" class="block text-sm font-semibold text-slate-600 mb-1">פירוט (אופציונלי)</label>
                    <textarea id="other-description" class="w-full p-2 border rounded-md border-slate-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500" rows="3" placeholder="לדוגמה: לזכור לקנות כרטיסים מראש..."></textarea>
                </div>
                <div class="flex justify-end gap-3 pt-4">
                    <button type="button" id="cancel-add-other" class="btn bg-slate-200 text-slate-700 hover:bg-slate-300">ביטול</button>
                    <button type="submit" class="btn btn-primary">הוסף למסלול</button>
                </div>
            </form>
        </div>
    </div>

    <!-- מודל בחירת מקום קיים -->
    <div id="add-place-modal" class="fixed inset-0 bg-black/60 z-[60] hidden items-center justify-center p-2 sm:p-4">
        <div class="bg-slate-50 rounded-2xl shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col slide-in-up">
            <div class="p-4 border-b border-slate-200 flex items-center justify-between shrink-0">
                <h3 class="text-xl font-bold text-slate-800">הוספת מקום למסלול</h3>
                <button id="close-add-place-modal-btn" class="w-8 h-8 rounded-full hover:bg-slate-200 text-slate-600 flex items-center justify-center">
                    <i class="fas fa-xmark"></i>
                </button>
            </div>

            <!-- חיפוש + פילטרים -->
            <div class="p-3 sm:p-4 space-y-3 shrink-0 bg-white shadow-sm border-b">
                <div class="relative">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                        <i class="fas fa-search"></i>
                    </span>
                    <input
                        type="search"
                        id="modal-search-input"
                        class="w-full p-2 pr-10 border border-slate-300 rounded-md focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500"
                        placeholder="חפש מקום ספציפי..." />
                </div>
                <div class="relative">
                    <span class="absolute right-3 top-1/2 -translate-y-1/2 text-slate-400">
                        <i class="fas fa-filter"></i>
                    </span>
                    <select
                        id="modal-category-filter"
                        class="w-full p-2 pr-10 border border-slate-300 rounded-md bg-white focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="all">כל הקטגוריות</option>
                    </select>
                </div>
            </div>

            <!-- רשימת מקומות -->
            <div id="modal-places-list-container" class="overflow-y-auto no-scrollbar p-4 pt-2 space-y-2 flex-grow">
                <!-- כרטיסי מקומות יוזרקו כאן -->
            </div>
        </div>
    </div>

    <!-- מודל בחירה מהמפה -->
    <div id="map-selection-modal" class="fixed inset-0 bg-slate-800 z-[70] hidden flex-col slide-in-from-right">
        <div class="bg-white p-3 flex items-center justify-between shrink-0 shadow-md">
            <h3 class="text-lg font-bold text-slate-800">בחר נקודה מהמפה</h3>
            <button id="close-map-modal-btn" class="w-9 h-9 rounded-lg hover:bg-slate-200 text-slate-600 flex items-center justify-center">
                <i class="fas fa-xmark text-lg"></i>
            </button>
        </div>
        <div id="map-modal-container" class="flex-grow"></div>
    </div>

    <!-- Toast התראה -->
    <div id="toast" class="fixed bottom-4 right-4 left-4 sm:left-auto text-center sm:text-left bg-slate-800 text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform translate-y-20 opacity-0 z-[100]">
        <p id="toast-message"></p>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, collection, query, where, getDocs, addDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js";

        // --- Firebase Config ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- Global State ---
        let currentUser, tripId, tripData;
        let allPlaces = [], allHotels = [], availablePoints = [];
        let currentRoute = {
            id: null,
            name: '',
            destination: '',
            steps: [],
            isPublic: true,
            createdBy: null,
            tripId: null
        };
        let isFirstAdd = true;
        let map, summaryMap, routePolyline, routeDecorator;
        let mapMarkers = new Map();
        let draggedItemIndex = null;
        let longPressTimer = null;
        let isTouchDragging = false;
        let touchStartY = 0;
        let touchStartX = 0;

        const categoryIcons = {
            "מסעדה/אוכל": { icon: "fa-utensils", color: "#fb923c" },
            "מלון": { icon: "fa-hotel", color: "#8b5cf6" },
            "מוזיאון": { icon: "fa-landmark", color: "#78716c" },
            "קניון/מרכז קניות": { icon: "fa-shopping-bag", color: "#ec4899" },
            "אטרקציה": { icon: "fa-star", color: "#f59e0b" },
            "חוף": { icon: "fa-umbrella-beach", color: "#06b6d4" },
            "סיור": { icon: "fa-person-walking", color: "#10b981" },
            "סופר": { icon: "fa-cart-shopping", color: "#6366f1" },
            "other": { icon: "fa-comment-dots", color: "#0ea5e9" },
            "default": { icon: "fa-location-dot", color: "#64748b" }
        };

        const DOM = {
            loadingOverlay: document.getElementById('loading-overlay'),
            mainContent: document.getElementById('main-content'),
            authContainer: document.getElementById('auth-container'),
            backToTripBtn: document.getElementById('back-to-trip-btn'),
            allRoutesBtn: document.getElementById('all-routes-btn'),
            addAttractionBtn: document.getElementById('add-attraction-btn'),
            initialState: document.getElementById('initial-state'),
            buildingState: document.getElementById('building-state'),
            createRouteModal: document.getElementById('create-route-modal'),
            createRouteForm: document.getElementById('create-route-form'),
            createRouteBtn: document.getElementById('create-route-btn'),
            cancelCreateRouteBtn: document.getElementById('cancel-create-route'),
            destinationSelect: document.getElementById('destination-select'),
            routeTitle: document.getElementById('route-title'),
            routeDestination: document.querySelector('#route-destination span'),
            routeStepsContainer: document.getElementById('route-steps-container'),
            startPrompt: document.getElementById('start-prompt'),
            saveRouteBtn: document.getElementById('save-route-btn'),
            isPublicToggle: document.getElementById('is-public-toggle'),
            summaryView: document.getElementById('summary-view'),
            toast: document.getElementById('toast'),
            toastMessage: document.getElementById('toast-message'),
            addPlaceModal: document.getElementById('add-place-modal'),
            openAddPlaceModalBtn: document.getElementById('open-add-place-modal-btn'),
            closeAddPlaceModalBtn: document.getElementById('close-add-place-modal-btn'),
            modalSearchInput: document.getElementById('modal-search-input'),
            modalCategoryFilter: document.getElementById('modal-category-filter'),
            modalPlacesListContainer: document.getElementById('modal-places-list-container'),
            addOtherModal: document.getElementById('add-other-modal'),
            openAddOtherModalBtn: document.getElementById('open-add-other-modal-btn'),
            addOtherForm: document.getElementById('add-other-form'),
            cancelAddOtherBtn: document.getElementById('cancel-add-other'),
            organizeRouteBtn: document.getElementById('organize-route-btn'),
            mapSelectionModal: document.getElementById('map-selection-modal'),
            openMapModalBtn: document.getElementById('open-map-modal-btn'),
            closeMapModalBtn: document.getElementById('close-map-modal-btn'),
            mapModalContainer: document.getElementById('map-modal-container'),
        };

        // --- Init ---
        async function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            const routeId = urlParams.get('routeId');

            if (!tripId) {
                showToast("שגיאה: לא נמצא מזהה טיול.", true);
                return;
            }

            // קישורים למקומות אחרים במערכת שלך
            DOM.backToTripBtn.href = `trip.html?id=${tripId}`;
            DOM.allRoutesBtn.href = `all_routes.html?id=${tripId}`;
            DOM.addAttractionBtn.href = `places.html?id=${tripId}`;

            onAuthStateChanged(auth, async (user) => {
                if (!user) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = user;
                DOM.authContainer.textContent = `שלום, ${user.displayName || user.email.split('@')[0]}`;

                try {
                    await Promise.all([
                        loadTripData(),
                        loadAllPlaces(),
                        loadAllHotels()
                    ]);

                    if (routeId) {
                        await loadRouteForEdit(routeId);
                    } else {
                        populateDestinationSelect();
                    }

                    setupEventListeners();
                    setupTouchDrag();
                } catch (error) {
                    console.error("Initialization failed:", error);
                    showToast("שגיאה בטעינת נתוני הטיול.", true);
                } finally {
                    DOM.loadingOverlay.classList.add('fade-out');
                    setTimeout(() => {
                        DOM.loadingOverlay.style.display = 'none';
                    }, 300);
                    DOM.mainContent.classList.remove('hidden');
                    DOM.mainContent.classList.add('flex');
                }
            });
        }

        // --- Data Loading ---
        async function loadTripData() {
            const docRef = doc(db, 'trips', tripId);
            const docSnap = await getDoc(docRef);
            if (docSnap.exists()) {
                tripData = docSnap.data();
            } else {
                throw new Error("Trip not found");
            }
        }

        async function loadAllPlaces() {
            const q = query(collection(db, 'trips', tripId, 'places'));
            const snapshot = await getDocs(q);
            allPlaces = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'place' }));
        }

        async function loadAllHotels() {
            const q = query(collection(db, 'trips', tripId, 'logistics'), where("type", "==", "hotel"));
            const snapshot = await getDocs(q);
            allHotels = snapshot.docs.map(d => ({ id: d.id, ...d.data(), pointType: 'hotel', type: 'מלון' }));
        }

        async function loadRouteForEdit(routeId) {
            try {
                const docRef = doc(db, 'trips', tripId, 'routes', routeId);
                const docSnap = await getDoc(docRef);

                if (!docSnap.exists()) {
                    showToast("המסלול המבוקש לא נמצא.", true);
                    populateDestinationSelect();
                    return;
                }

                const data = docSnap.data();
                currentRoute = {
                    id: docSnap.id,
                    name: data.name || 'מסלול ללא שם',
                    destination: data.destination || '',
                    steps: data.steps || [],
                    isPublic: (data.isPublic !== undefined) ? data.isPublic : true,
                    createdBy: data.createdBy || currentUser.uid,
                    tripId: data.tripId || tripId
                };

                startRouteBuilding(currentRoute.name, currentRoute.destination);
                updatePublicToggleUI(currentRoute.isPublic);
            } catch (error) {
                console.error("Error loading route for edit:", error);
                showToast("שגיאה בטעינת המסלול לעריכה.", true);
                populateDestinationSelect();
            }
        }

        function populateDestinationSelect() {
            DOM.destinationSelect.innerHTML = '<option value="" disabled selected>בחר יעד...</option>';
            if (tripData?.destinations) {
                tripData.destinations.forEach(dest => {
                    const option = document.createElement('option');
                    option.value = dest.nameHe;
                    option.textContent = dest.nameHe;
                    DOM.destinationSelect.appendChild(option);
                });
            }
        }

        // --- UI / State Transitions ---
        function startRouteBuilding(routeName, destination) {
            if (!currentRoute.id) {
                currentRoute = {
                    id: null,
                    name: routeName,
                    destination: destination,
                    steps: [],
                    isPublic: true,
                    createdBy: currentUser.uid,
                    tripId: tripId
                };
            }

            isFirstAdd = currentRoute.steps.length === 0;

            DOM.initialState.classList.add('hidden');
            DOM.buildingState.classList.remove('hidden');
            DOM.summaryView.classList.add('hidden');

            DOM.routeTitle.textContent = routeName;
            DOM.routeDestination.textContent = destination;

            availablePoints = [
                ...allPlaces.filter(p => p.destination === destination),
                ...allHotels.filter(h => h.destination === destination)
            ].filter(p => p.coords);

            populateCategoryFilter(DOM.modalCategoryFilter);

            DOM.createRouteModal.classList.add('hidden');
            DOM.createRouteModal.classList.remove('flex');

            renderCurrentRoute();
        }

        function showSummaryView() {
            DOM.buildingState.classList.add('hidden');
            DOM.summaryView.classList.remove('hidden');
            renderSummary();
            // לא טוענים מפה כאן יותר - נטען אותה רק כשעוברים לטאב "מפה"
        }

        function editRoute() {
            DOM.buildingState.classList.remove('hidden');
            DOM.summaryView.classList.add('hidden');
            if (summaryMap) {
                summaryMap.remove();
                summaryMap = null;
            }
        }

        function populateCategoryFilter(selectElement) {
            const categories = [...new Set(availablePoints.map(p => p.type || 'ללא קטגוריה'))];
            selectElement.innerHTML = '<option value="all">כל הקטגוריות</option>';
            categories.sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                selectElement.appendChild(option);
            });
        }

        function openAddPlaceModal() {
            renderModalPlacesList();
            DOM.addPlaceModal.classList.remove('hidden');
            DOM.addPlaceModal.classList.add('flex');
        }

        function openAddOtherModal() {
            DOM.addOtherForm.reset();
            DOM.addOtherModal.classList.remove('hidden');
            DOM.addOtherModal.classList.add('flex');
        }

        function openMapModal() {
            DOM.mapSelectionModal.classList.remove('hidden');
            DOM.mapSelectionModal.classList.add('flex');
            setTimeout(() => {
                initMap('map-modal-container');
            }, 50);
        }

        function closeMapModal() {
            DOM.mapSelectionModal.classList.add('hidden');
            DOM.mapSelectionModal.classList.remove('flex');
            if (map) {
                map.remove();
                map = null;
            }
        }

        function updatePublicToggleUI(isPublic) {
            DOM.isPublicToggle.setAttribute('aria-checked', isPublic);
            const knob = DOM.isPublicToggle.querySelector('span');
            knob.classList.toggle('translate-x-5', isPublic);
            knob.classList.toggle('translate-x-0', !isPublic);
            DOM.isPublicToggle.classList.toggle('bg-indigo-600', isPublic);
            DOM.isPublicToggle.classList.toggle('bg-gray-200', !isPublic);
            currentRoute.isPublic = isPublic;
        }

        // --- Rendering Lists / Modals ---
        function renderModalPlacesList() {
            const searchTerm = DOM.modalSearchInput.value.toLowerCase();
            const category = DOM.modalCategoryFilter.value;

            const filteredPoints = availablePoints.filter(p =>
                (p.name.toLowerCase().includes(searchTerm)) &&
                (category === 'all' || p.type === category)
            );

            if (filteredPoints.length === 0) {
                DOM.modalPlacesListContainer.innerHTML = `<p class="text-center text-slate-500 p-4">לא נמצאו מקומות תואמים.</p>`;
                return;
            }

            let html = '';
            if (isFirstAdd && category === 'all' && !searchTerm) {
                const categories = [...new Set(filteredPoints.map(p => p.type || 'ללא קטגוריה'))].sort();
                categories.forEach(cat => {
                    html += `<h4 class="font-bold text-slate-600 bg-slate-200 p-2 rounded sticky top-0 z-10">${cat}</h4>`;
                    html += filteredPoints
                        .filter(p => (p.type || 'ללא קטגוריה') === cat)
                        .sort((a,b) => a.name.localeCompare(b.name,'he'))
                        .map(createPlaceCardHTML)
                        .join('');
                });
            } else {
                // מיון חכם לפי מרחק מהנקודה האחרונה עם מיקום
                if (!isFirstAdd && currentRoute.steps.length > 0) {
                    let lastPointWithCoords = null;
                    for (let i = currentRoute.steps.length - 1; i >= 0; i--) {
                        if (currentRoute.steps[i].coords) {
                            lastPointWithCoords = currentRoute.steps[i];
                            break;
                        }
                    }

                    if (lastPointWithCoords) {
                        filteredPoints.forEach(p => {
                            p.distance = calculateDistance(lastPointWithCoords.coords, p.coords);
                        });
                        filteredPoints.sort((a,b) => a.distance - b.distance);
                    } else {
                        filteredPoints.sort((a,b) => a.name.localeCompare(b.name,'he'));
                    }
                } else {
                    filteredPoints.sort((a,b) => a.name.localeCompare(b.name,'he'));
                }

                html = filteredPoints.map(createPlaceCardHTML).join('');
            }

            DOM.modalPlacesListContainer.innerHTML = html;
        }

        function createPlaceCardHTML(point) {
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const distanceText = (point.distance != null)
                ? `<span class="text-xs font-bold text-slate-500 bg-slate-100 px-2 py-1 rounded-full">${point.distance.toFixed(1)} ק"מ</span>`
                : '';
            return `
                <div class="place-card bg-white border border-slate-200 rounded-lg p-3 flex items-center gap-3 cursor-pointer hover:shadow-md hover:border-indigo-400 transition-all" data-id="${point.id}">
                    <div class="flex-shrink-0 text-lg w-10 h-10 flex items-center justify-center rounded-lg" style="color:${iconInfo.color}; background-color:${iconInfo.color}20;">
                        <i class="fas ${iconInfo.icon} fa-fw"></i>
                    </div>
                    <div class="flex-grow min-w-0">
                        <p class="font-bold text-slate-800 truncate">${point.name}</p>
                        <p class="text-sm text-slate-500">${point.type}</p>
                    </div>
                    ${distanceText}
                    <button class="add-point-btn bg-green-500 text-white w-8 h-8 rounded-full flex-shrink-0 hover:bg-green-600 transition transform hover:scale-110 flex items-center justify-center">
                        <i class="fas fa-plus"></i>
                    </button>
                </div>
            `;
        }

        function renderCurrentRoute() {
            if (currentRoute.steps.length === 0) {
                DOM.routeStepsContainer.innerHTML = '';
                DOM.startPrompt.classList.remove('hidden');
                DOM.saveRouteBtn.classList.add('hidden');
                DOM.organizeRouteBtn.classList.add('hidden');
            } else {
                DOM.startPrompt.classList.add('hidden');
                DOM.saveRouteBtn.classList.remove('hidden');
                DOM.organizeRouteBtn.classList.remove('hidden');

                let html = '';
                currentRoute.steps.forEach((step, index) => {
                    const iconInfo = categoryIcons[step.type] || categoryIcons.default;

                    if (index > 0) {
                        const prevStep = currentRoute.steps[index - 1];
                        if (prevStep.coords && step.coords) {
                            const dist = calculateDistance(prevStep.coords, step.coords);
                            html += `
                                <div class="distance-connector">
                                    <span class="distance-text flex items-center gap-1"><i class="fas fa-route fa-xs ml-1"></i>${dist.toFixed(1)} ק"מ</span>
                                </div>
                            `;
                        } else {
                            html += `<div class="h-4"></div>`;
                        }
                    }

                    html += `
                        <div class="route-step fade-in" draggable="true" data-index="${index}">
                            <div class="step-icon-wrapper">
                                <div class="step-icon" style="background-color:${iconInfo.color};"><i class="fas ${iconInfo.icon}"></i></div>
                            </div>
                            <div class="step-content">
                                <div class="step-main">
                                    <p class="font-bold text-slate-800 truncate">${step.name}</p>
                                    <p class="text-sm text-slate-500 truncate">${step.description || (index === 0 ? 'נקודת התחלה' : `תחנה ${index + 1}`)}</p>
                                </div>
                                <div class="step-actions">
                                    <button class="drag-handle text-slate-400" title="גרור לשינוי סדר">
                                        <i class="fas fa-grip-lines"></i>
                                    </button>
                                    <button class="remove-step-btn text-red-500 hover:text-red-700 p-2 rounded-full hover:bg-red-50" data-id="${step.id}">
                                        <i class="fas fa-xmark"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
                DOM.routeStepsContainer.innerHTML = html;
            }
        }

        function renderSummary() {
            // מבנה חדש - ידידותי למובייל, טאבים פרטים/מפה
            DOM.summaryView.innerHTML = `
                <div id="summary-panel" class="flex flex-col h-full bg-white">
                    <!-- כותרת ודברים חשובים -->
                    <div class="sticky top-0 z-20 bg-white border-b border-slate-200 p-4 flex flex-col gap-3">
                        <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-3">
                            <div class="min-w-0 flex-1">
                                <h2 class="text-xl md:text-2xl font-extrabold text-slate-800 truncate">${currentRoute.name}</h2>
                                <p class="text-slate-500 font-semibold text-base md:text-lg truncate">${currentRoute.destination}</p>
                            </div>
                            <div class="flex items-center flex-wrap gap-2 no-print text-[13px]">
                                <button id="edit-route-btn" class="btn btn-ghost text-[13px] py-2 px-3"><i class="fas fa-pencil ml-2"></i>עריכה</button>
                                <button id="print-route-btn" class="btn btn-ghost text-[13px] py-2 px-3"><i class="fas fa-print ml-2"></i>הדפסה</button>
                                <button id="copy-route-btn" class="btn btn-primary text-[13px] py-2 px-3"><i class="fas fa-copy ml-2"></i>העתק לוז</button>
                            </div>
                        </div>

                        <!-- טאבים -->
                        <div class="grid grid-cols-2 gap-2 text-sm no-print">
                            <button id="summary-tab-details" class="tab-btn summary-tab-active font-bold py-2 rounded-lg border border-indigo-600 text-white flex items-center justify-center gap-2 text-sm">
                                <i class="fas fa-list-ul"></i>
                                פרטים
                            </button>
                            <button id="summary-tab-map" class="tab-btn summary-tab-inactive font-bold py-2 rounded-lg border text-slate-600 flex items-center justify-center gap-2 text-sm">
                                <i class="fas fa-map-location-dot"></i>
                                מפה
                            </button>
                        </div>
                    </div>

                    <!-- גוף – ניתן לגלילה במובייל -->
                    <div class="flex-1 overflow-y-auto no-scrollbar">
                        <!-- רשימת התחנות -->
                        <div id="summary-details-wrapper" class="p-4 space-y-3"></div>

                        <!-- מפה -->
                        <div id="summary-map-wrapper" class="hidden w-full h-[320px] sm:h-[400px]">
                            <div id="summary-map" class="w-full h-full"></div>
                        </div>
                    </div>
                </div>
            `;

            // מלא את פרטי המסלול (תחנות)
            const legendWrapper = DOM.summaryView.querySelector('#summary-details-wrapper');
            legendWrapper.innerHTML = currentRoute.steps.map((step, index) => {
                const iconInfo = categoryIcons[step.type] || categoryIcons.default;
                return `
                    <div class="flex items-start gap-4 py-3 px-3 border border-slate-200 bg-white rounded-xl shadow-sm">
                        <div class="flex-shrink-0 w-8 h-8 rounded-full bg-slate-100 text-slate-600 font-bold flex items-center justify-center text-sm">${index + 1}</div>
                        <div class="flex-shrink-0 text-lg w-10 h-10 flex items-center justify-center rounded-lg" style="color:${iconInfo.color}; background-color:${iconInfo.color}20;">
                            <i class="fas ${iconInfo.icon} fa-fw"></i>
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-slate-800">${step.name}</p>
                            <p class="text-sm text-slate-500">${step.description || step.type}</p>
                        </div>
                    </div>
                `;
            }).join('');

            // כפתורים בסיכום
            const copyBtn = document.getElementById('copy-route-btn');
            const printBtn = document.getElementById('print-route-btn');
            const editBtn = document.getElementById('edit-route-btn');
            const tabDetailsBtn = DOM.summaryView.querySelector('#summary-tab-details');
            const tabMapBtn = DOM.summaryView.querySelector('#summary-tab-map');
            const detailsWrapper = DOM.summaryView.querySelector('#summary-details-wrapper');
            const mapWrapper = DOM.summaryView.querySelector('#summary-map-wrapper');

            copyBtn.addEventListener('click', copyRouteToClipboard);
            printBtn.addEventListener('click', () => window.print());
            editBtn.addEventListener('click', editRoute);

            // פונקציה שמבטיחה שהמפה מוכנה וגודל נכון כשעוברים לטאב "מפה"
            function ensureSummaryMapReady() {
                if (!summaryMap) {
                    initMap('summary-map');
                    setTimeout(() => {
                        if (summaryMap) summaryMap.invalidateSize();
                    }, 50);
                } else {
                    setTimeout(() => {
                        summaryMap.invalidateSize();
                    }, 50);
                }
            }

            // טאבים מובייל
            tabDetailsBtn.addEventListener('click', () => {
                tabDetailsBtn.classList.remove('summary-tab-inactive');
                tabDetailsBtn.classList.add('summary-tab-active','text-white','border-indigo-600');
                tabMapBtn.classList.remove('summary-tab-active','text-white','border-indigo-600');
                tabMapBtn.classList.add('summary-tab-inactive');
                detailsWrapper.classList.remove('hidden');
                mapWrapper.classList.add('hidden');
            });

            tabMapBtn.addEventListener('click', () => {
                tabMapBtn.classList.remove('summary-tab-inactive');
                tabMapBtn.classList.add('summary-tab-active','text-white','border-indigo-600');
                tabDetailsBtn.classList.remove('summary-tab-active','text-white','border-indigo-600');
                tabDetailsBtn.classList.add('summary-tab-inactive');
                detailsWrapper.classList.add('hidden');
                mapWrapper.classList.remove('hidden');

                // לוודא שמפה נטענת ומקבלת invalidateSize ברגע שמראים אותה
                ensureSummaryMapReady();
            });
        }

        // --- Map Logic (Leaflet) ---
        function initMap(mapContainerId) {
            const isSummary = (mapContainerId === 'summary-map');
            let targetMap = isSummary ? summaryMap : map;

            if (targetMap) {
                targetMap.remove();
                targetMap = null;
            }

            targetMap = L.map(mapContainerId, { zoomControl: false });
            L.control.zoom({ position: 'bottomleft' }).addTo(targetMap);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO'
            }).addTo(targetMap);

            if (isSummary) {
                summaryMap = targetMap;
                currentRoute.steps.filter(s => s.coords).forEach((p, index) => createMarker(p, summaryMap, index + 1));
            } else {
                map = targetMap;
                mapMarkers.forEach(marker => marker.remove());
                mapMarkers.clear();
                availablePoints.forEach(p => createMarker(p, map));
            }

            updateMapPolyline(targetMap);
            updateMapBounds(targetMap);
        }

        function createMarker(point, targetMap, label = null) {
            if (!point.coords) return;
            const iconInfo = categoryIcons[point.type] || categoryIcons.default;
            const markerHtml = label
                ? `<div class="custom-marker-icon font-bold" style="background-color:${iconInfo.color}; color:#fff; width:32px; height:32px; font-size:16px;">${label}</div>`
                : `<div class="custom-marker-icon" style="background-color:${iconInfo.color}; color:#fff; width:30px; height:30px; font-size:14px;"><i class="fas ${iconInfo.icon}"></i></div>`;

            const customIcon = L.divIcon({
                html: markerHtml,
                className: 'custom-marker-icon-wrapper',
                iconSize: [30,30],
                iconAnchor: [15,15]
            });

            const marker = L.marker([point.coords.lat, point.coords.lng], { icon: customIcon }).addTo(targetMap);

            if (!label) {
                marker.bindPopup(
                    `<b>${point.name}</b><br>${point.type}<br>` +
                    `<button class=\"w-full text-center mt-2 p-1 bg-blue-500 text-white rounded text-sm add-point-from-popup\" data-id=\"${point.id}\">הוסף למסלול</button>`
                );
                mapMarkers.set(point.id, marker);
            }
        }

        function updateMapBounds(targetMap) {
            if (!targetMap) return;
            const isSummary = (targetMap === summaryMap);
            const pointsForBounds = (isSummary ? currentRoute.steps : availablePoints).filter(p => p.coords);

            if (pointsForBounds.length === 0) {
                const destData = tripData.destinations?.find(d => d.nameHe === currentRoute.destination);
                if (destData?.coords) {
                    targetMap.setView([destData.coords.lat, destData.coords.lng], 12);
                } else {
                    targetMap.setView([31.7683, 35.2137], 8); // fallback ירושלים
                }
                return;
            }

            const bounds = L.latLngBounds(pointsForBounds.map(p => [p.coords.lat, p.coords.lng]));
            if (bounds.isValid()) {
                targetMap.fitBounds(bounds, { padding: [40, 40] });
            }
        }

        function updateMapPolyline(targetMap) {
            if (!targetMap) return;

            if (routePolyline) routePolyline.remove();
            if (routeDecorator) routeDecorator.remove();

            const latlngs = currentRoute.steps
                .filter(p => p.coords)
                .map(p => [p.coords.lat, p.coords.lng]);

            routePolyline = L.polyline(latlngs, {
                color: '#ef4444',
                weight: 4,
                opacity: 0.8
            }).addTo(targetMap);

            routeDecorator = L.polylineDecorator(routePolyline, {
                patterns: [
                    {
                        offset: '5%',
                        repeat: 100,
                        symbol: L.Symbol.arrowHead({
                            pixelSize: 12,
                            pathOptions: { fillOpacity: 1, weight: 0, color: '#ef4444' }
                        })
                    }
                ]
            }).addTo(targetMap);

            if (latlngs.length > 1) {
                targetMap.fitBounds(routePolyline.getBounds(), { padding: [50, 50] });
            } else if (latlngs.length === 1) {
                targetMap.setView(latlngs[0], 14);
            }
        }

        // --- Core Route Logic ---
        function addPointToRoute(pointId) {
            const pointToAdd = availablePoints.find(p => p.id === pointId);
            if (!pointToAdd) return;

            currentRoute.steps.push(pointToAdd);
            isFirstAdd = false;

            renderCurrentRoute();

            DOM.addPlaceModal.classList.add('hidden');
            DOM.addPlaceModal.classList.remove('flex');
            closeMapModal();
            showToast(`"${pointToAdd.name}" הוסף למסלול!`);
        }

        function addOtherToRoute(name, description) {
            const otherStep = {
                id: crypto.randomUUID(),
                name: name,
                description: description,
                type: 'other',
                pointType: 'other',
                coords: null
            };

            currentRoute.steps.push(otherStep);
            isFirstAdd = false;

            renderCurrentRoute();

            DOM.addOtherModal.classList.add('hidden');
            DOM.addOtherModal.classList.remove('flex');
            showToast(`"${name}" הוסף למסלול!`);
        }

        function removePointFromRoute(pointId) {
            const pointName = currentRoute.steps.find(p => p.id === pointId)?.name || 'הפריט';
            currentRoute.steps = currentRoute.steps.filter(p => p.id !== pointId);

            if (currentRoute.steps.length === 0) {
                isFirstAdd = true;
            }

            renderCurrentRoute();
            showToast(`"${pointName}" הוסר מהמסלול.`);
        }

        function organizeRouteByDistance() {
            let stepsWithCoords = currentRoute.steps.filter(s => s.coords);
            let stepsWithoutCoords = currentRoute.steps.filter(s => !s.coords);

            if (stepsWithCoords.length < 2) {
                showToast("אין מספיק נקודות עם מיקום כדי לארגן.", true);
                return;
            }

            // אלגוריתם חמדני – תמיד קח את הנק' הקרובה ביותר הבאה
            let sortedSteps = [];
            let currentPoint = stepsWithCoords.shift();
            sortedSteps.push(currentPoint);

            while (stepsWithCoords.length > 0) {
                let nearestPointIndex = -1;
                let minDistance = Infinity;

                stepsWithCoords.forEach((point, index) => {
                    const dist = calculateDistance(currentPoint.coords, point.coords);
                    if (dist < minDistance) {
                        minDistance = dist;
                        nearestPointIndex = index;
                    }
                });

                currentPoint = stepsWithCoords.splice(nearestPointIndex, 1)[0];
                sortedSteps.push(currentPoint);
            }

            currentRoute.steps = [...sortedSteps, ...stepsWithoutCoords];
            renderCurrentRoute();
            showToast("המסלול אורגן מחדש לפי מרחק!");
        }

        // --- שמירה + פרסום ---
        async function saveRouteAndShowSummary() {
            DOM.saveRouteBtn.disabled = true;
            DOM.saveRouteBtn.innerHTML = `<i class="fas fa-spinner fa-spin ml-2"></i>שומר...`;

            try {
                let routeId = currentRoute.id;
                const routeData = {
                    name: currentRoute.name,
                    destination: currentRoute.destination,
                    steps: currentRoute.steps,
                    isPublic: currentRoute.isPublic,
                    createdBy: currentRoute.createdBy,
                    tripId: currentRoute.tripId
                };

                if (routeId) {
                    await setDoc(doc(db, 'trips', tripId, 'routes', routeId), routeData);
                } else {
                    const docRef = await addDoc(collection(db, 'trips', tripId, 'routes'), routeData);
                    currentRoute.id = docRef.id;
                    routeId = docRef.id;
                }

                if (routeData.isPublic) {
                    await setDoc(doc(db, 'publicRoutes', routeId), routeData);
                } else {
                    await deleteDoc(doc(db, 'publicRoutes', routeId)).catch(() => {});
                }

                showToast("המסלול נשמר בהצלחה!");
                showSummaryView();
            } catch (error) {
                console.error("Error saving route:", error);
                showToast("שגיאה בשמירת המסלול.", true);
            } finally {
                DOM.saveRouteBtn.disabled = false;
                DOM.saveRouteBtn.innerHTML = `<i class=\"fas fa-floppy-disk ml-2\"></i>שמור והצג סיכום`;
            }
        }

        // --- Utils ---
        function calculateDistance(coords1, coords2) {
            if (!coords1 || !coords2) return Infinity;
            const R = 6371; // km
            const dLat = (coords2.lat - coords1.lat) * Math.PI / 180;
            const dLon = (coords2.lng - coords1.lng) * Math.PI / 180;
            const a =
                Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(coords1.lat * Math.PI / 180) * Math.cos(coords2.lat * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
            return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
        }

        function copyRouteToClipboard() {
            let message = `*לו\"ז טיול: ${currentRoute.name}*\\n\\n`;
            message += `המסלול שלנו ל*${currentRoute.destination}*:\\n\\n`;
            currentRoute.steps.forEach((step, index) => {
                message += `${index + 1}. ${step.coords ? '📍' : '▫️'} *${step.name}*\\n`;
                if (step.description) {
                    message += `   - ${step.description}\\n`;
                }
                if (index < currentRoute.steps.length - 1) {
                    const nextStep = currentRoute.steps[index + 1];
                    if (step.coords && nextStep.coords) {
                        const dist = calculateDistance(step.coords, nextStep.coords);
                        message += `   (כ-${dist.toFixed(1)} ק\\"מ נסיעה)\\n`;
                    }
                    message += `⬇️\\n`;
                }
            });
            message += `\\nתהנו! ✨`;

            navigator.clipboard.writeText(message).then(() => {
                showToast('הלו\"ז הועתק בהצלחה!');
            }).catch(() => {
                showToast('שגיאה בהעתקה', true);
            });
        }

        function showToast(message, isError = false) {
            DOM.toastMessage.textContent = message;
            DOM.toast.className = `fixed bottom-4 right-4 left-4 sm:left-auto text-center sm:text-left text-white py-3 px-6 rounded-lg shadow-xl transition-all duration-300 transform z-[100]`;
            DOM.toast.classList.add(isError ? 'bg-red-600' : 'bg-slate-800', 'translate-y-0', 'opacity-100');

            setTimeout(() => {
                DOM.toast.classList.remove('translate-y-0', 'opacity-100');
                DOM.toast.classList.add('translate-y-20', 'opacity-0');
            }, 3000);
        }

        // --- Drag & Drop (Desktop) ---
        function handleDragStart(e) {
            const stepEl = e.target.closest('.route-step');
            if (!stepEl) return;
            draggedItemIndex = parseInt(stepEl.dataset.index);
            stepEl.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.target.closest('.route-step');
            if (!target || parseInt(target.dataset.index) === draggedItemIndex) return;
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            target.classList.add('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            const target = e.target.closest('.route-step');
            if (target) {
                const targetIndex = parseInt(target.dataset.index);
                if (draggedItemIndex !== null && targetIndex !== draggedItemIndex) {
                    const [draggedItem] = currentRoute.steps.splice(draggedItemIndex, 1);
                    currentRoute.steps.splice(targetIndex, 0, draggedItem);
                    renderCurrentRoute();
                }
            }
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        function handleDragEnd(e) {
            const stepEl = e.target.closest('.route-step');
            if (stepEl) {
                stepEl.classList.remove('dragging');
            }
            draggedItemIndex = null;
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
        }

        // --- Drag & Drop (Mobile long press) ---
        function setupTouchDrag() {
            DOM.routeStepsContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
            DOM.routeStepsContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
            DOM.routeStepsContainer.addEventListener('touchend', handleTouchEnd);
        }

        function handleTouchStart(e) {
            const stepEl = e.target.closest('.route-step');
            if (!stepEl) return;

            const touch = e.touches[0];
            touchStartY = touch.clientY;
            touchStartX = touch.clientX;

            longPressTimer = setTimeout(() => {
                isTouchDragging = true;
                draggedItemIndex = parseInt(stepEl.dataset.index);
                stepEl.classList.add('dragging');
                // לא נציג טוסט כל פעם כדי שלא יציק
            }, 400); // לחיצה ארוכה ~0.4ש'
        }

        function handleTouchMove(e) {
            const touch = e.touches[0];
            const dy = Math.abs(touch.clientY - touchStartY);
            const dx = Math.abs(touch.clientX - touchStartX);

            // אם הוא זז לפני שהחזיק מספיק - בטל longPressTimer
            if (!isTouchDragging && longPressTimer && (dy > 10 || dx > 10)) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
                return;
            }

            if (!isTouchDragging) return;
            e.preventDefault(); // לא לגלול את המסך באמצע גרירה

            const targetEl = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.route-step');
            if (!targetEl) return;
            const targetIndex = parseInt(targetEl.dataset.index);
            if (targetIndex === draggedItemIndex) return;
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));
            targetEl.classList.add('drag-over');
        }

        function handleTouchEnd(e) {
            clearTimeout(longPressTimer);
            longPressTimer = null;

            if (!isTouchDragging) return;
            isTouchDragging = false;

            const touch = e.changedTouches[0];
            const targetEl = document.elementFromPoint(touch.clientX, touch.clientY)?.closest('.route-step');
            if (targetEl) {
                const targetIndex = parseInt(targetEl.dataset.index);
                if (draggedItemIndex !== null && targetIndex !== draggedItemIndex) {
                    const [draggedItem] = currentRoute.steps.splice(draggedItemIndex, 1);
                    currentRoute.steps.splice(targetIndex, 0, draggedItem);
                }
            }

            draggedItemIndex = null;
            document.querySelectorAll('.dragging').forEach(el => el.classList.remove('dragging'));
            document.querySelectorAll('.drag-over').forEach(el => el.classList.remove('drag-over'));

            renderCurrentRoute();
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            // יצירת מסלול
            DOM.createRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.remove('hidden');
                DOM.createRouteModal.classList.add('flex');
            });

            DOM.cancelCreateRouteBtn.addEventListener('click', () => {
                DOM.createRouteModal.classList.add('hidden');
                DOM.createRouteModal.classList.remove('flex');
            });

            DOM.createRouteForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const routeName = document.getElementById('new-route-name').value;
                const destination = DOM.destinationSelect.value;
                if (routeName && destination) startRouteBuilding(routeName, destination);
            });

            // פתיחת מודלים
            DOM.openAddPlaceModalBtn.addEventListener('click', openAddPlaceModal);
            DOM.closeAddPlaceModalBtn.addEventListener('click', () => {
                DOM.addPlaceModal.classList.add('hidden');
                DOM.addPlaceModal.classList.remove('flex');
            });

            DOM.openAddOtherModalBtn.addEventListener('click', openAddOtherModal);
            DOM.cancelAddOtherBtn.addEventListener('click', () => {
                DOM.addOtherModal.classList.add('hidden');
                DOM.addOtherModal.classList.remove('flex');
            });

            DOM.addOtherForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const name = document.getElementById('other-name').value;
                const desc = document.getElementById('other-description').value;
                if (name) addOtherToRoute(name, desc);
            });

            DOM.openMapModalBtn.addEventListener('click', openMapModal);
            DOM.closeMapModalBtn.addEventListener('click', closeMapModal);

            // חיפוש וסינון במודל מקומות
            DOM.modalSearchInput.addEventListener('input', () => renderModalPlacesList());
            DOM.modalCategoryFilter.addEventListener('change', () => renderModalPlacesList());

            // הוספה מהמקומות המוצגים במודל
            DOM.modalPlacesListContainer.addEventListener('click', (e) => {
                const card = e.target.closest('.place-card');
                if (!card) return;
                if (e.target.closest('.add-point-btn')) {
                    addPointToRoute(card.dataset.id);
                }
            });

            // הדגשת מרקר במפה כשעוברים עם העכבר על כרטיס (דסקטופ)
            DOM.modalPlacesListContainer.addEventListener('mouseover', e => {
                const card = e.target.closest('.place-card');
                if (card && map) {
                    const marker = mapMarkers.get(card.dataset.id);
                    marker?.getElement()?.classList.add('highlight');
                }
            });
            DOM.modalPlacesListContainer.addEventListener('mouseout', e => {
                const card = e.target.closest('.place-card');
                if (card && map) {
                    const marker = mapMarkers.get(card.dataset.id);
                    marker?.getElement()?.classList.remove('highlight');
                }
            });

            // לחיצה על "הוסף למסלול" מתוך popup במפה
            document.body.addEventListener('click', (e) => {
                if (e.target.matches('.add-point-from-popup')) {
                    addPointToRoute(e.target.dataset.id);
                }
            });

            // הסרה של תחנה מהרשימה
            DOM.routeStepsContainer.addEventListener('click', (e) => {
                const removeBtn = e.target.closest('.remove-step-btn');
                if (removeBtn) removePointFromRoute(removeBtn.dataset.id);
            });

            // גרירה בדסקטופ
            DOM.routeStepsContainer.addEventListener('dragstart', handleDragStart);
            DOM.routeStepsContainer.addEventListener('dragover', handleDragOver);
            DOM.routeStepsContainer.addEventListener('drop', handleDrop);
            DOM.routeStepsContainer.addEventListener('dragend', handleDragEnd);

            // שמירה
            DOM.saveRouteBtn.addEventListener('click', saveRouteAndShowSummary);

            // ארגון חכם
            DOM.organizeRouteBtn.addEventListener('click', organizeRouteByDistance);

            // פומבי / לא פומבי
            DOM.isPublicToggle.addEventListener('click', () => {
                const isChecked = DOM.isPublicToggle.getAttribute('aria-checked') === 'true';
                updatePublicToggleUI(!isChecked);
            });
        }

        initPage();
    </script>
</body>
</html>