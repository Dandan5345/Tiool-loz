<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>תפריט המבורגר - רכיב עצמאי</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Assistant:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Assistant', sans-serif;
            background-color: #f1f5f9; /* רקע בהיר כללי לדף הדגמה */
            overflow-x: hidden;
        }

        /* --- Sidebar Specific Styles --- */
        #sidebar { 
            transition: transform 0.3s ease-in-out; 
            /* מוודא שהתפריט יהיה מעל הכל */
            z-index: 1000; 
        }

        /* סגנונות לתתי-תפריטים (הימים בתוך היעד) */
        .submenu { 
            max-height: 0; 
            overflow: hidden; 
            transition: max-height 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94); 
        }
        .submenu.open { 
            max-height: 1200px; /* מספיק גובה כדי להכיל את כל הימים */
        }

        /* סגנון לכפתור ההמבורגר כשהוא נלחץ (אופציונלי - כאן הוא פשוט כפתור) */
        #hamburger-btn {
            cursor: pointer;
        }

        /* הסתרת פס גלילה בסיידבר כדי שיהיה נקי */
        #sidebar::-webkit-scrollbar {
            width: 6px;
        }
        #sidebar::-webkit-scrollbar-track {
            background: #f1f1f1; 
        }
        #sidebar::-webkit-scrollbar-thumb {
            background: #cbd5e1; 
            border-radius: 10px;
        }
        #sidebar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8; 
        }
    </style>
</head>
<body>

    <!-- Loading Overlay (כדי לא להציג תפריט ריק לפני שטוענים נתונים) -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/90 backdrop-blur-sm z-[2000] flex flex-col items-center justify-center gap-4 transition-opacity duration-500">
        <i class="fas fa-circle-notch fa-spin text-4xl text-blue-600"></i>
        <p class="text-lg font-bold text-slate-700">טוען תפריט...</p>
    </div>

    <!-- Header / Navbar Area (רק בשביל שיהיה איפה לשים את הכפתור) -->
    <header class="bg-white shadow-sm p-4 sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center">
            <h1 class="text-xl font-bold text-slate-800">דף הדגמה לתפריט</h1>
            
            <!-- --- THE HAMBURGER BUTTON --- -->
            <button id="hamburger-btn" class="p-2 text-slate-600 hover:text-blue-600 transition-colors focus:outline-none border border-slate-200 rounded-lg hover:bg-slate-50">
                <i class="fas fa-bars fa-lg"></i>
            </button>
        </div>
    </header>

    <!-- Main Content Placeholder -->
    <main class="p-8 text-center text-slate-500">
        <p>התוכן של הדף נמצא כאן...</p>
        <p class="text-sm mt-2">(לחץ על ההמבורגר למעלה משמאל כדי לפתוח את התפריט)</p>
    </main>

    <!-- --- SIDEBAR COMPONENT START --- -->
    
    <!-- Dark Overlay (הרקע הכהה כשפותחים תפריט) -->
    <div id="overlay" class="fixed inset-0 bg-black/50 z-[999] hidden transition-opacity duration-300"></div>

    <!-- The Sidebar Itself -->
    <aside id="sidebar" class="fixed top-0 right-0 h-full w-80 bg-white shadow-2xl transform translate-x-full overflow-y-auto">
        <!-- Sidebar Header -->
        <div class="p-4 flex justify-between items-center border-b sticky top-0 bg-white z-10">
            <h2 class="text-2xl font-bold text-slate-800">תפריט המסע</h2>
            <button id="close-sidebar-btn" class="p-2 text-slate-500 hover:text-red-500 transition-colors">
                <i class="fas fa-times fa-lg"></i>
            </button>
        </div>
        
        <!-- Sidebar Navigation Content (Dynamic) -->
        <nav id="main-menu" class="p-4 space-y-2 pb-20">
            <!-- התוכן כאן יוזרק על ידי JavaScript -->
        </nav>
    </aside>

    <!-- --- SIDEBAR COMPONENT END --- -->

    <!-- Alert Modal (למקרה של שגיאות) -->
    <div id="alert-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[3000] p-4">
        <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-sm text-center">
            <h2 class="text-xl font-bold mb-2">הודעה</h2>
            <p id="alert-msg" class="text-slate-600 mb-4"></p>
            <button onclick="document.getElementById('alert-modal').classList.add('hidden')" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">אישור</button>
        </div>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyAhuk5EfqaT9eZr3CxMYWP7qzjoGLhLq3o",
            authDomain: "tiool-loz.firebaseapp.com",
            projectId: "tiool-loz",
            storageBucket: "tiool-loz.appspot.com",
            messagingSenderId: "226069823505",
            appId: "1:226069823505:web:ab7672692ccfa49173b1b0"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- DOM Elements ---
        const DOM = {
            sidebar: document.getElementById('sidebar'),
            hamburgerBtn: document.getElementById('hamburger-btn'),
            closeSidebarBtn: document.getElementById('close-sidebar-btn'),
            overlay: document.getElementById('overlay'),
            mainMenu: document.getElementById('main-menu'),
            loadingOverlay: document.getElementById('loading-overlay'),
            alertModal: document.getElementById('alert-modal'),
            alertMsg: document.getElementById('alert-msg')
        };

        let tripId = null;
        let tripData = null;

        // --- Helper Functions (Date Parsing) ---
        function parseDDMMYYYY(s) {
            if (!s || typeof s !== 'string') return null;
            const [d, m, y] = s.split('/').map(Number);
            if (isNaN(d) || isNaN(m) || isNaN(y)) return null;
            return new Date(y, m - 1, d);
        }

        function hebWeekday(d) {
            const n = d.toLocaleDateString('he-IL', { weekday: 'long' });
            return n.startsWith('יום') ? n : `יום ${n}`;
        }

        function dotted(d) {
            return `${d.getDate()}.${d.getMonth() + 1}.${d.getFullYear()}`;
        }

        function generateDatesFromRange(rangeStr) {
            if (!rangeStr || !rangeStr.includes(' - ')) return [];
            const [startStr, endStr] = rangeStr.split(' - ');
            const startDate = parseDDMMYYYY(startStr);
            const endDate = parseDDMMYYYY(endStr);
            if (!startDate || !endDate) return [];
           
            const dates = [];
            let currentDate = new Date(startDate);

            while (currentDate <= endDate) {
                const dd = String(currentDate.getDate()).padStart(2,'0');
                const mm = String(currentDate.getMonth()+1).padStart(2,'0');
                const yyyy = currentDate.getFullYear();
                dates.push(`${dd}/${mm}/${yyyy}`);
                currentDate.setDate(currentDate.getDate() + 1);
            }
            return dates;
        }

        function showAlert(msg) {
            DOM.alertMsg.textContent = msg;
            DOM.alertModal.classList.remove('hidden');
        }

        // --- Core Logic ---

        function initPage() {
            const urlParams = new URLSearchParams(window.location.search);
            tripId = urlParams.get('id') || urlParams.get('tripId');
            
            if (!tripId) {
                showAlert("שגיאה: לא נמצא מזהה טיול (tripId) בכתובת ה-URL.");
                DOM.loadingOverlay.style.display = 'none';
                return;
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    loadTripData(user);
                } else {
                    // במקרה של ניתוק, בדרך כלל מעבירים לדף התחברות.
                    // כאן נציג הודעה פשוטה
                    showAlert("עליך להתחבר כדי לראות את התפריט.");
                    window.location.href = 'login.html'; // הנחה שקיים דף כזה
                }
            });
        }

        async function loadTripData(user) {
            try {
                const tripRef = doc(db, "trips", tripId);
                const tripSnap = await getDoc(tripRef);

                if (tripSnap.exists()) {
                    const loadedTripData = tripSnap.data();
                    
                    // בדיקת הרשאות בסיסית
                    const canAccess = loadedTripData.owner === user.uid || (loadedTripData.editors && loadedTripData.editors.includes(user.uid));

                    if (canAccess) {
                        tripData = loadedTripData;
                        buildSidebarMenu(); // הבנייה של התפריט
                    } else {
                        showAlert("אין לך הרשאה לצפות בטיול זה.");
                    }
                } else {
                    showAlert("הטיול לא נמצא.");
                }
            } catch (error) {
                console.error("Error loading trip:", error);
                showAlert("שגיאה בטעינת הנתונים.");
            } finally {
                // הסתרת מסך הטעינה
                DOM.loadingOverlay.style.opacity = '0';
                setTimeout(() => DOM.loadingOverlay.style.display = 'none', 500);
            }
        }

        // --- Sidebar Functionality ---

        function toggleSidebar() {
            // החלפת ה-class שדואג להזזה
            DOM.sidebar.classList.toggle('translate-x-full');
            // הצגה/הסתרה של הרקע הכהה
            DOM.overlay.classList.toggle('hidden');
        }

        // --- Menu Building Logic (1:1 from original) ---

        function buildSidebarMenu() {
            DOM.mainMenu.innerHTML = '';
            
            // קישור חזרה למרכז הבקרה (ראשי)
            const homeLink = document.createElement('a');
            homeLink.href = `index.html?tripId=${tripId}`; 
            homeLink.className = 'block w-full text-right p-3 bg-blue-50 hover:bg-blue-100 rounded-lg font-bold text-blue-700 mb-2 transition-colors';
            homeLink.innerHTML = '<i class="fas fa-home ml-2"></i>מרכז הבקרה';
            DOM.mainMenu.appendChild(homeLink);

            if (!tripData || !tripData.destinations) return;

            // מיון היעדים לפי תאריך
            const sortedDestinations = [...tripData.destinations].sort((a, b) => {
                const dateA = parseDDMMYYYY(a.dates?.split(' - ')[0]);
                const dateB = parseDDMMYYYY(b.dates?.split(' - ')[0]);
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateA - dateB;
            });

            // בניית ה-HTML לכל יעד
            sortedDestinations.forEach(dest => {
                const destinationDiv = document.createElement('div');

                // כפתור ראשי ליעד (פותח אקורדיון)
                const button = document.createElement('button');
                button.className = 'w-full text-right p-3 bg-slate-100 hover:bg-slate-200 rounded-lg font-bold text-slate-700 flex justify-between items-center transition-colors';
                button.innerHTML = `<span>${dest.nameHe}</span> <i class="fas fa-chevron-down transition-transform duration-300"></i>`;

                // מיכל לתתי-התפריטים (ימים)
                const submenu = document.createElement('div');
                submenu.className = 'submenu mt-1 mr-2 border-r-2 border-slate-200';

                // יצירת קישור לכל יום בטווח התאריכים
                const dates = generateDatesFromRange(dest.dates);
                dates.forEach(dateStr => {
                    const d = parseDDMMYYYY(dateStr);
                    if (!d) return;
                    const a = document.createElement('a');

                    const destNameParam = encodeURIComponent(dest.nameHe);
                    // שימור הקישור לדף הלו"ז היומי
                    a.href = `daily-schedule.html?tripId=${tripId}&date=${encodeURIComponent(dateStr)}&dest=${destNameParam}`;

                    a.className = 'block w-full text-right p-3 pr-4 rounded-md transition-colors hover:bg-sky-50';
                    a.innerHTML = `
                        <div class="flex flex-col">
                            <span class="text-slate-700 text-sm font-bold">${hebWeekday(d)} – (${dest.nameHe})</span>
                            <span class="text-slate-500 text-xs">${dotted(d)}</span>
                        </div>
                    `;
                    submenu.appendChild(a);
                });

                // אירוע לחיצה לפתיחת האקורדיון
                button.addEventListener('click', () => {
                    submenu.classList.toggle('open');
                    button.querySelector('i').classList.toggle('rotate-180');
                });

                destinationDiv.appendChild(button);
                destinationDiv.appendChild(submenu);
                DOM.mainMenu.appendChild(destinationDiv);
            });
        }

        // --- Event Listeners ---
        DOM.hamburgerBtn.addEventListener('click', toggleSidebar);
        DOM.closeSidebarBtn.addEventListener('click', toggleSidebar);
        DOM.overlay.addEventListener('click', toggleSidebar); // סגירה בלחיצה על הרקע הכהה

        // הרצת האתחול
        initPage();

    </script>
</body>
</html>

